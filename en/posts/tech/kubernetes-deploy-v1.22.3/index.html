<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>kubernetes | kubeadm 搭建 K8s 集群 v1.22.3 | lvbibir's Blog</title>
<meta name=keywords content="linux,centos,kubernetes"><meta name=description content="介绍 kubernetes, 并在 centos 中使用 kubeadm 快速搭建 k8s 集群 v1.22.3、安装cni组件"><meta name=author content="作者:&nbsp;lvbibir"><link rel=canonical href=https://www.lvbibir.cn/en/posts/tech/kubernetes-deploy-v1.22.3/><link crossorigin=anonymous href=/assets/css/stylesheet.496206d0375c7e7a3b42446d2f3ea1b7983a46d6cd89bb72427af041495cbd41.css integrity="sha256-SWIG0Ddcfno7QkRtLz6ht5g6RtbNibtyQnrwQUlcvUE=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://www.lvbibir.cn/img/avatar.gif><link rel=icon type=image/png sizes=16x16 href=https://www.lvbibir.cn/img/avatar.gif><link rel=icon type=image/png sizes=32x32 href=https://www.lvbibir.cn/img/avatar.gif><link rel=apple-touch-icon href=https://www.lvbibir.cn/img/avatar.gif><link rel=mask-icon href=https://www.lvbibir.cn/img/avatar.gif><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://www.lvbibir.cn/en/posts/tech/kubernetes-deploy-v1.22.3/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta property="og:title" content="kubernetes | kubeadm 搭建 K8s 集群 v1.22.3"><meta property="og:description" content="介绍 kubernetes, 并在 centos 中使用 kubeadm 快速搭建 k8s 集群 v1.22.3、安装cni组件"><meta property="og:type" content="article"><meta property="og:url" content="https://www.lvbibir.cn/en/posts/tech/kubernetes-deploy-v1.22.3/"><meta property="og:image" content="https://image.lvbibir.cn/blog/kubernetes.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-01T00:00:00+00:00"><meta property="article:modified_time" content="2024-01-28T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://image.lvbibir.cn/blog/kubernetes.png"><meta name=twitter:title content="kubernetes | kubeadm 搭建 K8s 集群 v1.22.3"><meta name=twitter:description content="介绍 kubernetes, 并在 centos 中使用 kubeadm 快速搭建 k8s 集群 v1.22.3、安装cni组件"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"📚 文章","item":"https://www.lvbibir.cn/en/posts/"},{"@type":"ListItem","position":2,"name":"👨🏻‍💻 技术","item":"https://www.lvbibir.cn/en/posts/tech/"},{"@type":"ListItem","position":3,"name":"kubernetes | kubeadm 搭建 K8s 集群 v1.22.3","item":"https://www.lvbibir.cn/en/posts/tech/kubernetes-deploy-v1.22.3/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"kubernetes | kubeadm 搭建 K8s 集群 v1.22.3","name":"kubernetes | kubeadm 搭建 K8s 集群 v1.22.3","description":"介绍 kubernetes, 并在 centos 中使用 kubeadm 快速搭建 k8s 集群 v1.22.3、安装cni组件","keywords":["linux","centos","kubernetes"],"articleBody":"1 Kubernetes 概述 kubernetes 是什么\nkubernetes 是 Google 在 2014 年开源的一个容器集群管理平台，kubernetes 简称 k8s k8s 用于容器化应用程序的部署，扩展和管理。 k8s 提供了容器的编排，资源调度，弹性伸缩，部署管理，服务发现等一系列功能 kubernetes 目标是让部署容器化应用简单高效 Kubernetes 特性\n自我修复 在节点故障时重新启动失败的容器，替换和重新部署，保证预期的副本数量；杀死健康检查失败的容器，并且在未准备好之前不会处理客户端请求，确保线上服务不中断。 伸缩性 使用命令、UI 或者基于 CPU 使用情况自动快速扩容和缩容应用程序实例，保证应用业务高峰并发时的高可用性；业务低峰时回收资源，以最小成本运行服务。 自动部署和回滚 K8S 采用滚动更新策略更新应用，一次更新一个 Pod，而不是同时删除所有 Pod，如果更新过程中出现问题，将回滚更改，确保升级不受影响业务。 服务发现和负载均衡 K8S 为多个容器提供一个统一访问入口（内部 IP 地址和一个 DNS 名称），并且负载均衡关联的所有容器，使得用户无需考虑容器 IP 问题。 机密和配置管理 管理机密数据和应用程序配置，而不需要把敏感数据暴露在镜像里，提高敏感数据安全性。并可以将一些常用的配置存储在 K8S 中，方便应用程序使用。 存储编排 挂载外部存储系统，无论是来自本地存储，公有云（如 AWS），还是网络存储（如 NFS、GlusterFS、Ceph）都作为集群资源的一部分使用，极大提高存储使用灵活性。 批处理 提供一次性任务，定时任务；满足批量数据处理和分析的场景。 Kubeadm 概述\nkubeadm 是 Kubernetes 项目自带的及集群构建工具，负责执行构建一个最小化的可用集群以及将其启动等的必要基本步骤，kubeadm 是 Kubernetes 集群全生命周期的管理工具，可用于实现集群的部署、升级、降级及拆除。kubeadm 部署 Kubernetes 集群是将大部分资源以 pod 的方式运行，例如（kube-proxy、kube-controller-manager、kube-scheduler、kube-apiserver、flannel) 都是以 pod 方式运行。 Kubeadm 仅关心如何初始化并启动集群，余下的其他操作，例如安装 Kubernetes Dashboard、监控系统、日志系统等必要的附加组件则不在其考虑范围之内，需要管理员自行部署。 Kubeadm 集成了 Kubeadm init 和 kubeadm join 等工具程序，其中 kubeadm init 用于集群的快速初始化，其核心功能是部署 Master 节点的各个组件，而 kubeadm join 则用于将节点快速加入到指定集群中，它们是创建 Kubernetes 集群最佳实践的“快速路径”。另外，kubeadm token 可于集群构建后管理用于加入集群时使用的认证令牌（token)，而 kubeadm reset 命令的功能则是删除集群构建过程中生成的文件以重置回初始状态。 2 环境准备 基于 centos7.9，docker-ce-20.10.18，kubelet-1.22.3-0\n部署 Kubernetes 集群需要满足每个节点至少满足 2 核 CPU、2G 内存和 30GB 硬盘且都可以访问外网\n角色 IP k8s-node1 1.1.1.1 k8s-node2 1.1.1.2 k8s-node3 1.1.1.3 2.1 基础配置 # 关闭防火墙 systemctl stop firewalld systemctl disable firewalld # 关闭selinux sed -i 's/enforcing/disabled/' /etc/selinux/config # 永久 setenforce 0 # 临时 # 关闭swap swapoff -a # 临时 vim /etc/fstab # 永久, 注释掉swap分区相关行 # 设置主机名 hostnamectl set-hostname # 添加hosts cat \u003e\u003e /etc/hosts \u003c\u003c EOF 1.1.1.1 k8s-node1 1.1.1.2 k8s-node2 1.1.1.3 k8s-node3 EOF # 将桥接的IPv4流量传递到iptables的链 cat \u003e /etc/sysctl.d/k8s.conf \u003c\u003c EOF net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 EOF sysctl --system # 生效 # 时间同步 timedatectl set-timezone Asia/Shanghai yum install ntpdate -y ntpdate time.windows.com 2.2 安装 Docker Kubernetes 默认 CRI（容器运行时）为 Docker，因此先安装 Docker。\nwget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo yum list docker-ce --show-duplicates yum install docker-ce-20.10.23-3.el7.x86_64 配置镜像下载加速器，同时修改 docker 的 cgroupdriver 为 systemd\nmkdir /etc/docker cat \u003e /etc/docker/daemon.json \u003c\u003c EOF { \"registry-mirrors\": [ \"http://hub-mirror.c.163.com\", \"https://docker.mirrors.ustc.edu.cn\", \"https://jc0srqak.mirror.aliyuncs.com\" ], \"exec-opts\": [\"native.cgroupdriver=systemd\"] } EOF systemctl daemon-reload systemctl enable docker \u0026\u0026 systemctl start docker docker info 2.3 kubeadm/kubelet/kubectl 添加阿里云 YUM 软件源\ncat \u003e /etc/yum.repos.d/kubernetes.repo \u003c\u003c EOF [kubernetes] name=Kubernetes baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64 enabled=1 gpgcheck=0 repo_gpgcheck=0 gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg EOF 这里指定版本号部署\nyum install -y kubelet-1.22.3 kubeadm-1.22.3 kubectl-1.22.3 systemctl enable kubelet systemctl start kubelet 3 部署 Kubernetes Master 官方文档 1 官方文档 2\n在 1.1.1.1（Master）执行\nkubeadm init \\ --apiserver-advertise-address=1.1.1.1 \\ --kubernetes-version v1.22.3 \\ --service-cidr=10.96.0.0/12 \\ --pod-network-cidr=10.244.0.0/16 \\ --ignore-preflight-errors=all \\ --image-repository registry.aliyuncs.com/google_containers –apiserver-advertise-address 集群通告地址 –kubernetes-version K8s 版本，与上面安装的一致 –service-cidr 集群内部虚拟网络，Pod 统一访问入口 –pod-network-cidr Pod 网络，与下面部署的 CNI 网络组件 yaml 中保持一致 –ignore-preflight-errors=all，跳过一些错误 –image-repository 由于默认拉取镜像地址 k8s.gcr.io 国内无法访问，这里指定阿里云镜像仓库地址 或者使用配置文件引导：\ncat \u003e kubeadm.conf \u003c\u003c EOF apiVersion: kubeadm.k8s.io/v1beta2 kind: ClusterConfiguration kubernetesVersion: v1.22.3 imageRepository: registry.aliyuncs.com/google_containers networking: podSubnet: 10.244.0.0/16 serviceSubnet: 10.96.0.0/12 EOF kubeadm init --config kubeadm.conf --ignore-preflight-errors=all 拷贝 kubectl 使用的连接 k8s 认证文件到默认路径：\nmkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config 查看 k8s 集群状态\nkubectl get cs NAME STATUS MESSAGE ERROR scheduler Unhealthy Get \"http://127.0.0.1:10251/healthz\": dial tcp 127.0.0.1:10251: connect: connection refused controller-manager Healthy ok etcd-0 Healthy {\"health\":\"true\",\"reason\":\"\"} vim /etc/kubernetes/manifests/kube-scheduler.yaml # 注释掉 --port=0 ，scheduler会自动重启，稍等一小会状态变为正常 kubectl get cs NAME STATUS MESSAGE ERROR scheduler Healthy ok controller-manager Healthy ok etcd-0 Healthy {\"health\":\"true\",\"reason\":\"\"} 4 加入 Kubernetes Node 官方文档\n在 192.168.150.102/103（Node）执行。\n向集群添加新节点，执行在 kubeadm init 输出的 kubeadm join 命令：\nkubeadm join 1.1.1.1:6443 --token esce21.q6hetwm8si29qxwn \\ --discovery-token-ca-cert-hash sha256:00603a05805807501d7181c3d60b478788408cfe6cedefedb1f97569708be9c5 默认 token 有效期为 24 小时，当过期之后，该 token 就不可用了。这时就需要重新创建 token，操作如下：\nkubeadm token create kubeadm token list openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2\u003e/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //' 63bca849e0e01691ae14eab449570284f0c3ddeea590f8da988c07fe2729e924 kubeadm join 1.1.1.1:6443 --token nuja6n.o3jrhsffiqs9swnu --discovery-token-ca-cert-hash sha256:63bca849e0e01691ae14eab449570284f0c3ddeea590f8da988c07fe2729e924 或者直接命令快捷生成: kubeadm token create --print-join-command\n5 部署容器网络 (cni) Calico 是一个纯三层的数据中心网络方案，Calico 支持广泛的平台，包括 Kubernetes、OpenStack 等。\nCalico 在每一个计算节点利用 Linux Kernel 实现了一个高效的虚拟路由器（ vRouter） 来负责数据转发，而每个 vRouter 通过 BGP 协议负责把自己上运行的 workload 的路由信息向整个 Calico 网络内传播。\n此外，Calico 项目还实现了 Kubernetes 网络策略，提供 ACL 功能。\nquickstart\n版本对照表，在此页面可以看到 calico 每个版本支持的 kubernetes 的版本\n安装 calico\nwget --no-check-certificate https://docs.tigera.io/archive/v3.23/manifests/calico.yaml 修改 Pod 网络和网卡识别参数，Pod 网络与前面 kubeadm init 指定的一样\n[root@k8s-node1 ~]# vim calico.yaml # 修改位置：DaemonSet.spec.template.spec.containers.env # 新增如下四行 - name: CALICO_IPV4POOL_CIDR value: \"10.244.0.0/16\" - name: IP_AUTODETECTION_METHOD value: interface=bond*,ens* #网卡名根据实际情况修改 kubectl apply -f calico.yaml kubectl get pods -n kube-system # 所有Pod起来后，节点状态应该都是Ready状态了 [root@k8s-node1 ~]# kubectl get nodes NAME STATUS ROLES AGE VERSION k8s-node1 Ready control-plane,master 153m v1.22.3 k8s-node2 Ready 151m v1.22.3 k8s-node3 Ready 151m v1.22.3 6 metric-server cadvisor 负责提供数据，已集成到 k8s 中\nMetrics-server 负责数据汇总，需额外安装\n下载 yaml\nwget --no-check-certificate https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.6.0/components.yaml mv components.yaml metrics-server.yaml 修改 yaml\ncontainers: - args: - --cert-dir=/tmp - --secure-port=4443 - --kubelet-preferred-address-types=InternalIP # 第一处修改 - --kubelet-use-node-status-port - --metric-resolution=15s - --kubelet-insecure-tls # 第二处修改 image: registry.aliyuncs.com/google_containers/metrics-server:v0.6.0 # 第三处修改 imagePullPolicy: IfNotPresent --kubelet-insecure-tls 不验证 kubelet 自签的证书 `–kubelet-preferred-address-types=InternalIP Metrics-server 连接 cadvisor 默认通过主机名即 node 的名称进行连接，而 Metric-server 作为 pod 运行在集群中默认是无法解析的，所以这里修改成通过节点 ip 连接 部署 metrics-server\n[root@k8s-node1 ~]# kubectl apply -f metrics-server.yaml [root@k8s-node1 ~]# kubectl get pods -n kube-system -l k8s-app=metrics-server NAME READY STATUS RESTARTS AGE metrics-server-7f66b69ff6-bkfqg 1/1 Running 0 59s [root@k8s-node1 ~]# kubectl top nodes NAME CPU(cores) CPU% MEMORY(bytes) MEMORY% k8s-node1 226m 11% 2004Mi 54% k8s-node2 97m 4% 1047Mi 28% k8s-node3 98m 4% 1096Mi 29% 7 测试 kubernetes 集群 验证 Pod 工作 验证 Pod 网络通信 验证 DNS 解析 在 Kubernetes 集群中创建一个 pod，验证是否正常运行：\nkubectl create deployment nginx --image=nginx kubectl expose deployment nginx --type=NodePort --port=80 --target-port=80 [root@k8s-node1 ~]# kubectl get pod,deploy,svc NAME READY STATUS RESTARTS AGE pod/nginx-6799fc88d8-57bqd 1/1 Running 0 10m NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/nginx 1/1 1 1 10m NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/kubernetes ClusterIP 10.96.0.1 443/TCP 170m service/nginx NodePort 10.102.188.108 80:30954/TCP 2m31s 访问地址：http://1.1.1.1:30954，端口是固定的，ip 可以是集群内任一节点的 ip\n8 部署 Dashboard wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.4.0/aio/deploy/recommended.yaml 默认 Dashboard 只能集群内部访问，修改 Service 为 NodePort 类型，暴露到外部：\nvi recommended.yaml ... kind: Service apiVersion: v1 metadata: labels: k8s-app: kubernetes-dashboard name: kubernetes-dashboard namespace: kubernetes-dashboard spec: ports: - port: 443 targetPort: 8443 nodePort: 30001 selector: k8s-app: kubernetes-dashboard type: NodePort ... kubectl apply -f recommended.yaml kubectl get pods -n kubernetes-dashboard NAME READY STATUS RESTARTS AGE dashboard-metrics-scraper-6b4884c9d5-gl8nr 1/1 Running 0 13m kubernetes-dashboard-7f99b75bf4-89cds 1/1 Running 0 13m 访问地址：https://NodeIP:30001\n创建 service account 并绑定默认 cluster-admin 管理员集群角色：\n# 创建用户 kubectl create serviceaccount dashboard-admin -n kube-system # 用户授权 kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin # 获取用户Token kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk '/dashboard-admin/{print $1}') 使用输出的 token 登录 Dashboard。\n以上\n","wordCount":"2836","inLanguage":"en","image":"https://image.lvbibir.cn/blog/kubernetes.png","datePublished":"2021-10-01T00:00:00Z","dateModified":"2024-01-28T00:00:00Z","author":{"@type":"Person","name":"lvbibir"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.lvbibir.cn/en/posts/tech/kubernetes-deploy-v1.22.3/"},"publisher":{"@type":"Organization","name":"lvbibir's Blog","logo":{"@type":"ImageObject","url":"https://www.lvbibir.cn/img/avatar.gif"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.lvbibir.cn/en/ accesskey=h title="lvbibir's Blog (Alt + H)"><img src=https://www.lvbibir.cn/img/avatar.gif alt aria-label=logo height=35>lvbibir's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li class=menu-item><a href=https://www.lvbibir.cn/en/search title="🔍 搜索 (Alt + /)" accesskey=/><span>🔍 搜索</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/en/posts title="📚 文章"><span>📚 文章</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/en/archives title="📈 归档"><span>📈 归档</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/en/talk title="💬 说说"><span>💬 说说</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/en/links title="🤝 友链"><span>🤝 友链</span></a></li></ul></nav></header><main class="main page"><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://www.lvbibir.cn/en/>主页</a>&nbsp;»&nbsp;<a href=https://www.lvbibir.cn/en/posts/>📚 文章</a>&nbsp;»&nbsp;<a href=https://www.lvbibir.cn/en/posts/tech/>👨🏻‍💻 技术</a></div><h1 class=post-title>kubernetes | kubeadm 搭建 K8s 集群 v1.22.3</h1><div class=post-description>介绍 kubernetes, 并在 centos 中使用 kubeadm 快速搭建 k8s 集群 v1.22.3、安装cni组件</div><div class=post-meta>创建:&amp;nbsp;&lt;span title='2021-10-01 00:00:00 +0000 UTC'>2021-10-01&lt;/span>&amp;nbsp;|&amp;nbsp;更新:&amp;nbsp;2024-01-28&amp;nbsp;|&amp;nbsp;字数:&amp;nbsp;2836字&amp;nbsp;|&amp;nbsp;作者:&amp;nbsp;lvbibir
|&nbsp;标签:&nbsp;<ul class=post-tags-meta><a href=https://www.lvbibir.cn/en/tags/kubernetes/>Kubernetes</a></ul><span id=busuanzi_container_page_pv>&nbsp;|&nbsp;访问:&nbsp;<span id=busuanzi_value_page_pv></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>文章目录</span></summary><div class=inner><ul><li><a href=#1-kubernetes-%e6%a6%82%e8%bf%b0 aria-label="1 Kubernetes 概述">1 Kubernetes 概述</a></li><li><a href=#2-%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87 aria-label="2 环境准备">2 环境准备</a><ul><li><a href=#21-%e5%9f%ba%e7%a1%80%e9%85%8d%e7%bd%ae aria-label="2.1 基础配置">2.1 基础配置</a></li><li><a href=#22-%e5%ae%89%e8%a3%85-docker aria-label="2.2 安装 Docker">2.2 安装 Docker</a></li><li><a href=#23-kubeadmkubeletkubectl aria-label="2.3 kubeadm/kubelet/kubectl">2.3 kubeadm/kubelet/kubectl</a></li></ul></li><li><a href=#3-%e9%83%a8%e7%bd%b2-kubernetes-master aria-label="3 部署 Kubernetes Master">3 部署 Kubernetes Master</a></li><li><a href=#4-%e5%8a%a0%e5%85%a5-kubernetes-node aria-label="4 加入 Kubernetes Node">4 加入 Kubernetes Node</a></li><li><a href=#5-%e9%83%a8%e7%bd%b2%e5%ae%b9%e5%99%a8%e7%bd%91%e7%bb%9c-cni aria-label="5 部署容器网络 (cni)">5 部署容器网络 (cni)</a></li><li><a href=#6-metric-server aria-label="6 metric-server">6 metric-server</a></li><li><a href=#7-%e6%b5%8b%e8%af%95-kubernetes-%e9%9b%86%e7%be%a4 aria-label="7 测试 kubernetes 集群">7 测试 kubernetes 集群</a></li><li><a href=#8-%e9%83%a8%e7%bd%b2-dashboard aria-label="8 部署 Dashboard">8 部署 Dashboard</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=1-kubernetes-概述>1 Kubernetes 概述<a hidden class=anchor aria-hidden=true href=#1-kubernetes-概述>#</a></h1><p>kubernetes 是什么</p><ul><li>kubernetes 是 Google 在 2014 年开源的一个容器集群管理平台，kubernetes 简称 k8s</li><li>k8s 用于容器化应用程序的部署，扩展和管理。</li><li>k8s 提供了容器的编排，资源调度，弹性伸缩，部署管理，服务发现等一系列功能</li><li>kubernetes 目标是让部署容器化应用简单高效</li></ul><p>Kubernetes 特性</p><ul><li>自我修复<ul><li>在节点故障时重新启动失败的容器，替换和重新部署，保证预期的副本数量；杀死健康检查失败的容器，并且在未准备好之前不会处理客户端请求，确保线上服务不中断。</li></ul></li><li>伸缩性<ul><li>使用命令、UI 或者基于 CPU 使用情况自动快速扩容和缩容应用程序实例，保证应用业务高峰并发时的高可用性；业务低峰时回收资源，以最小成本运行服务。</li></ul></li><li>自动部署和回滚<ul><li>K8S 采用滚动更新策略更新应用，一次更新一个 Pod，而不是同时删除所有 Pod，如果更新过程中出现问题，将回滚更改，确保升级不受影响业务。</li></ul></li><li>服务发现和负载均衡<ul><li>K8S 为多个容器提供一个统一访问入口（内部 IP 地址和一个 DNS 名称），并且负载均衡关联的所有容器，使得用户无需考虑容器 IP 问题。</li></ul></li><li>机密和配置管理<ul><li>管理机密数据和应用程序配置，而不需要把敏感数据暴露在镜像里，提高敏感数据安全性。并可以将一些常用的配置存储在 K8S 中，方便应用程序使用。</li></ul></li><li>存储编排<ul><li>挂载外部存储系统，无论是来自本地存储，公有云（如 AWS），还是网络存储（如 NFS、GlusterFS、Ceph）都作为集群资源的一部分使用，极大提高存储使用灵活性。</li></ul></li><li>批处理<ul><li>提供一次性任务，定时任务；满足批量数据处理和分析的场景。</li></ul></li></ul><p>Kubeadm 概述</p><ul><li><code>kubeadm</code> 是 <code>Kubernetes</code> 项目自带的及集群构建工具，负责执行构建一个最小化的可用集群以及将其启动等的必要基本步骤，<code>kubeadm</code> 是 <code>Kubernetes</code> 集群全生命周期的管理工具，可用于实现集群的部署、升级、降级及拆除。<code>kubeadm</code> 部署 <code>Kubernetes</code> 集群是将大部分资源以 <code>pod</code> 的方式运行，例如（<code>kube-proxy</code>、<code>kube-controller-manager</code>、<code>kube-scheduler</code>、<code>kube-apiserver</code>、<code>flannel</code>) 都是以 <code>pod</code> 方式运行。</li><li><code>Kubeadm</code> 仅关心如何初始化并启动集群，余下的其他操作，例如安装 <code>Kubernetes Dashboard</code>、监控系统、日志系统等必要的附加组件则不在其考虑范围之内，需要管理员自行部署。</li><li><code>Kubeadm</code> 集成了 <code>Kubeadm init</code> 和 <code>kubeadm join</code> 等工具程序，其中 <code>kubeadm init</code> 用于集群的快速初始化，其核心功能是部署 Master 节点的各个组件，而 <code>kubeadm join</code> 则用于将节点快速加入到指定集群中，它们是创建 <code>Kubernetes</code> 集群最佳实践的“快速路径”。另外，<code>kubeadm token</code> 可于集群构建后管理用于加入集群时使用的认证令牌（<code>token</code>)，而 <code>kubeadm reset</code> 命令的功能则是删除集群构建过程中生成的文件以重置回初始状态。</li></ul><p><img loading=lazy src=https://image.lvbibir.cn/blog/828019-20201006171931291-1034333699.png alt=img></p><h1 id=2-环境准备>2 环境准备<a hidden class=anchor aria-hidden=true href=#2-环境准备>#</a></h1><p>基于 <code>centos7.9</code>，<code>docker-ce-20.10.18</code>，<code>kubelet-1.22.3-0</code></p><p>部署 Kubernetes 集群需要满足每个节点至少满足 2 核 CPU、2G 内存和 30GB 硬盘且都可以访问外网</p><table><thead><tr><th>角色</th><th>IP</th></tr></thead><tbody><tr><td>k8s-node1</td><td>1.1.1.1</td></tr><tr><td>k8s-node2</td><td>1.1.1.2</td></tr><tr><td>k8s-node3</td><td>1.1.1.3</td></tr></tbody></table><h2 id=21-基础配置>2.1 基础配置<a hidden class=anchor aria-hidden=true href=#21-基础配置>#</a></h2><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#776e71># 关闭防火墙</span>
</span></span><span style=display:flex><span>systemctl stop firewalld
</span></span><span style=display:flex><span>systemctl disable firewalld
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># 关闭selinux</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#48b685>&#39;s/enforcing/disabled/&#39;</span> /etc/selinux/config  <span style=color:#776e71># 永久</span>
</span></span><span style=display:flex><span>setenforce <span style=color:#f99b15>0</span>  <span style=color:#776e71># 临时</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># 关闭swap</span>
</span></span><span style=display:flex><span>swapoff -a  <span style=color:#776e71># 临时</span>
</span></span><span style=display:flex><span>vim /etc/fstab  <span style=color:#776e71># 永久, 注释掉swap分区相关行</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># 设置主机名</span>
</span></span><span style=display:flex><span>hostnamectl set-hostname &lt;hostname&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># 添加hosts</span>
</span></span><span style=display:flex><span>cat &gt;&gt; /etc/hosts <span style=color:#48b685>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#48b685>1.1.1.1 k8s-node1
</span></span></span><span style=display:flex><span><span style=color:#48b685>1.1.1.2 k8s-node2
</span></span></span><span style=display:flex><span><span style=color:#48b685>1.1.1.3 k8s-node3
</span></span></span><span style=display:flex><span><span style=color:#48b685>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># 将桥接的IPv4流量传递到iptables的链</span>
</span></span><span style=display:flex><span>cat &gt; /etc/sysctl.d/k8s.conf <span style=color:#48b685>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#48b685>net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style=display:flex><span><span style=color:#48b685>net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style=display:flex><span><span style=color:#48b685>EOF</span>
</span></span><span style=display:flex><span>sysctl --system  <span style=color:#776e71># 生效</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># 时间同步</span>
</span></span><span style=display:flex><span>timedatectl set-timezone Asia/Shanghai
</span></span><span style=display:flex><span>yum install ntpdate -y
</span></span><span style=display:flex><span>ntpdate time.windows.com
</span></span></code></pre></div><h2 id=22-安装-docker>2.2 安装 Docker<a hidden class=anchor aria-hidden=true href=#22-安装-docker>#</a></h2><p>Kubernetes 默认 CRI（容器运行时）为 Docker，因此先安装 Docker。</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo
</span></span><span style=display:flex><span>yum list docker-ce --show-duplicates
</span></span><span style=display:flex><span>yum install docker-ce-20.10.23-3.el7.x86_64
</span></span></code></pre></div><p>配置镜像下载加速器，同时修改 docker 的 cgroupdriver 为 systemd</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir /etc/docker
</span></span><span style=display:flex><span>cat &gt; /etc/docker/daemon.json <span style=color:#48b685>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#48b685>{
</span></span></span><span style=display:flex><span><span style=color:#48b685>  &#34;registry-mirrors&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#48b685>    &#34;http://hub-mirror.c.163.com&#34;,
</span></span></span><span style=display:flex><span><span style=color:#48b685>    &#34;https://docker.mirrors.ustc.edu.cn&#34;,
</span></span></span><span style=display:flex><span><span style=color:#48b685>    &#34;https://jc0srqak.mirror.aliyuncs.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#48b685>  ],
</span></span></span><span style=display:flex><span><span style=color:#48b685>  &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;]
</span></span></span><span style=display:flex><span><span style=color:#48b685>}
</span></span></span><span style=display:flex><span><span style=color:#48b685>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>systemctl daemon-reload
</span></span><span style=display:flex><span>systemctl enable docker <span style=color:#5bc4bf>&amp;&amp;</span> systemctl start docker
</span></span><span style=display:flex><span>docker info
</span></span></code></pre></div><h2 id=23-kubeadmkubeletkubectl>2.3 kubeadm/kubelet/kubectl<a hidden class=anchor aria-hidden=true href=#23-kubeadmkubeletkubectl>#</a></h2><p>添加阿里云 YUM 软件源</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /etc/yum.repos.d/kubernetes.repo <span style=color:#48b685>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#48b685>[kubernetes]
</span></span></span><span style=display:flex><span><span style=color:#48b685>name=Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#48b685>baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span></span></span><span style=display:flex><span><span style=color:#48b685>enabled=1
</span></span></span><span style=display:flex><span><span style=color:#48b685>gpgcheck=0
</span></span></span><span style=display:flex><span><span style=color:#48b685>repo_gpgcheck=0
</span></span></span><span style=display:flex><span><span style=color:#48b685>gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span style=display:flex><span><span style=color:#48b685>EOF</span>
</span></span></code></pre></div><p>这里指定版本号部署</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install -y kubelet-1.22.3 kubeadm-1.22.3 kubectl-1.22.3
</span></span><span style=display:flex><span>systemctl enable kubelet
</span></span><span style=display:flex><span>systemctl start kubelet
</span></span></code></pre></div><h1 id=3-部署-kubernetes-master>3 部署 Kubernetes Master<a hidden class=anchor aria-hidden=true href=#3-部署-kubernetes-master>#</a></h1><p><a href=https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm-init/#config-file target=_blank rel=noopener style=color:#42b983 ;>官方文档 1</a> <a href=https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#initializing-your-control-plane-node target=_blank rel=noopener style=color:#42b983 ;>官方文档 2</a></p><p>在 1.1.1.1（Master）执行</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubeadm init <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>--apiserver-advertise-address<span style=color:#5bc4bf>=</span>1.1.1.1 <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>--kubernetes-version v1.22.3 <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>--service-cidr<span style=color:#5bc4bf>=</span>10.96.0.0/12 <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>--pod-network-cidr<span style=color:#5bc4bf>=</span>10.244.0.0/16 <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>--ignore-preflight-errors<span style=color:#5bc4bf>=</span>all <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>--image-repository registry.aliyuncs.com/google_containers 
</span></span></code></pre></div><ul><li>&ndash;apiserver-advertise-address 集群通告地址</li><li>&ndash;kubernetes-version K8s 版本，与上面安装的一致</li><li>&ndash;service-cidr 集群内部虚拟网络，Pod 统一访问入口</li><li>&ndash;pod-network-cidr Pod 网络，与下面部署的 CNI 网络组件 yaml 中保持一致</li><li>&ndash;ignore-preflight-errors=all，跳过一些错误</li><li>&ndash;image-repository 由于默认拉取镜像地址 k8s.gcr.io 国内无法访问，这里指定阿里云镜像仓库地址</li></ul><p>或者使用配置文件引导：</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; kubeadm.conf <span style=color:#48b685>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#48b685>apiVersion: kubeadm.k8s.io/v1beta2
</span></span></span><span style=display:flex><span><span style=color:#48b685>kind: ClusterConfiguration
</span></span></span><span style=display:flex><span><span style=color:#48b685>kubernetesVersion: v1.22.3
</span></span></span><span style=display:flex><span><span style=color:#48b685>imageRepository: registry.aliyuncs.com/google_containers 
</span></span></span><span style=display:flex><span><span style=color:#48b685>networking:
</span></span></span><span style=display:flex><span><span style=color:#48b685>  podSubnet: 10.244.0.0/16 
</span></span></span><span style=display:flex><span><span style=color:#48b685>  serviceSubnet: 10.96.0.0/12 
</span></span></span><span style=display:flex><span><span style=color:#48b685>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubeadm init --config kubeadm.conf --ignore-preflight-errors<span style=color:#5bc4bf>=</span>all  
</span></span></code></pre></div><p>拷贝 kubectl 使用的连接 k8s 认证文件到默认路径：</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p <span style=color:#ef6155>$HOME</span>/.kube
</span></span><span style=display:flex><span>sudo cp -i /etc/kubernetes/admin.conf <span style=color:#ef6155>$HOME</span>/.kube/config
</span></span><span style=display:flex><span>sudo chown <span style=color:#815ba4>$(</span>id -u<span style=color:#815ba4>)</span>:<span style=color:#815ba4>$(</span>id -g<span style=color:#815ba4>)</span> <span style=color:#ef6155>$HOME</span>/.kube/config
</span></span></code></pre></div><p>查看 k8s 集群状态</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get cs
</span></span><span style=display:flex><span>NAME                 STATUS      MESSAGE                                                                                       ERROR
</span></span><span style=display:flex><span>scheduler            Unhealthy   Get <span style=color:#48b685>&#34;http://127.0.0.1:10251/healthz&#34;</span>: dial tcp 127.0.0.1:10251: connect: connection refused
</span></span><span style=display:flex><span>controller-manager   Healthy     ok                                                                      
</span></span><span style=display:flex><span>etcd-0               Healthy     <span style=color:#5bc4bf>{</span><span style=color:#48b685>&#34;health&#34;</span>:<span style=color:#48b685>&#34;true&#34;</span>,<span style=color:#48b685>&#34;reason&#34;</span>:<span style=color:#48b685>&#34;&#34;</span><span style=color:#5bc4bf>}</span>   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vim /etc/kubernetes/manifests/kube-scheduler.yaml
</span></span><span style=display:flex><span><span style=color:#776e71># 注释掉 --port=0 ，scheduler会自动重启，稍等一小会状态变为正常</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get cs
</span></span><span style=display:flex><span>NAME                 STATUS    MESSAGE                         ERROR
</span></span><span style=display:flex><span>scheduler            Healthy   ok
</span></span><span style=display:flex><span>controller-manager   Healthy   ok
</span></span><span style=display:flex><span>etcd-0               Healthy   <span style=color:#5bc4bf>{</span><span style=color:#48b685>&#34;health&#34;</span>:<span style=color:#48b685>&#34;true&#34;</span>,<span style=color:#48b685>&#34;reason&#34;</span>:<span style=color:#48b685>&#34;&#34;</span><span style=color:#5bc4bf>}</span>
</span></span></code></pre></div><h1 id=4-加入-kubernetes-node>4 加入 Kubernetes Node<a hidden class=anchor aria-hidden=true href=#4-加入-kubernetes-node>#</a></h1><p><a href=https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-join/ target=_blank rel=noopener style=color:#42b983 ;>官方文档</a></p><p>在 192.168.150.102/103（Node）执行。</p><p>向集群添加新节点，执行在 kubeadm init 输出的 kubeadm join 命令：</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubeadm join 1.1.1.1:6443 --token esce21.q6hetwm8si29qxwn <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>--discovery-token-ca-cert-hash sha256:00603a05805807501d7181c3d60b478788408cfe6cedefedb1f97569708be9c5
</span></span></code></pre></div><p>默认 token 有效期为 24 小时，当过期之后，该 token 就不可用了。这时就需要重新创建 token，操作如下：</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubeadm token create
</span></span><span style=display:flex><span>kubeadm token list
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed <span style=color:#48b685>&#39;s/^.* //&#39;</span>
</span></span><span style=display:flex><span>63bca849e0e01691ae14eab449570284f0c3ddeea590f8da988c07fe2729e924
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubeadm join 1.1.1.1:6443 --token nuja6n.o3jrhsffiqs9swnu --discovery-token-ca-cert-hash 
</span></span><span style=display:flex><span>sha256:63bca849e0e01691ae14eab449570284f0c3ddeea590f8da988c07fe2729e924
</span></span></code></pre></div><p>或者直接命令快捷生成: <code>kubeadm token create --print-join-command</code></p><h1 id=5-部署容器网络-cni>5 部署容器网络 (cni)<a hidden class=anchor aria-hidden=true href=#5-部署容器网络-cni>#</a></h1><p>Calico 是一个纯三层的数据中心网络方案，Calico 支持广泛的平台，包括 Kubernetes、OpenStack 等。</p><p>Calico 在每一个计算节点利用 Linux Kernel 实现了一个高效的虚拟路由器（ vRouter） 来负责数据转发，而每个 vRouter 通过 BGP 协议负责把自己上运行的 workload 的路由信息向整个 Calico 网络内传播。</p><p>此外，Calico 项目还实现了 Kubernetes 网络策略，提供 ACL 功能。</p><p><a href=https://docs.projectcalico.org/getting-started/kubernetes/quickstart target=_blank rel=noopener style=color:#42b983 ;>quickstart</a></p><p><a href=https://docs.tigera.io/archive/v3.23/getting-started/kubernetes/requirements target=_blank rel=noopener style=color:#42b983 ;>版本对照表</a>，在此页面可以看到 calico 每个版本支持的 kubernetes 的版本</p><p>安装 calico</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget --no-check-certificate https://docs.tigera.io/archive/v3.23/manifests/calico.yaml
</span></span></code></pre></div><p>修改 Pod 网络和网卡识别参数，Pod 网络与前面 kubeadm init 指定的一样</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># vim calico.yaml</span>
</span></span><span style=display:flex><span><span style=color:#776e71># 修改位置：DaemonSet.spec.template.spec.containers.env</span>
</span></span><span style=display:flex><span><span style=color:#776e71># 新增如下四行</span>
</span></span><span style=display:flex><span>- name: CALICO_IPV4POOL_CIDR
</span></span><span style=display:flex><span>  value: <span style=color:#48b685>&#34;10.244.0.0/16&#34;</span>
</span></span><span style=display:flex><span>- name: IP_AUTODETECTION_METHOD
</span></span><span style=display:flex><span>  value: <span style=color:#ef6155>interface</span><span style=color:#5bc4bf>=</span>bond*,ens* <span style=color:#776e71>#网卡名根据实际情况修改</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl apply -f calico.yaml
</span></span><span style=display:flex><span>kubectl get pods -n kube-system
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># 所有Pod起来后，节点状态应该都是Ready状态了</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># kubectl get nodes</span>
</span></span><span style=display:flex><span>NAME        STATUS   ROLES                  AGE    VERSION
</span></span><span style=display:flex><span>k8s-node1   Ready    control-plane,master   153m   v1.22.3
</span></span><span style=display:flex><span>k8s-node2   Ready    &lt;none&gt;                 151m   v1.22.3
</span></span><span style=display:flex><span>k8s-node3   Ready    &lt;none&gt;                 151m   v1.22.3
</span></span></code></pre></div><h1 id=6-metric-server>6 metric-server<a hidden class=anchor aria-hidden=true href=#6-metric-server>#</a></h1><p>cadvisor 负责提供数据，已集成到 k8s 中</p><p>Metrics-server 负责数据汇总，需额外安装</p><p><img loading=lazy src=https://image.lvbibir.cn/blog/Snipaste_2022-10-02_09-04-36.png alt=Snipaste_2022-10-02_09-04-36></p><p>下载 yaml</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget --no-check-certificate https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.6.0/components.yaml 
</span></span><span style=display:flex><span>mv components.yaml metrics-server.yaml
</span></span></code></pre></div><p>修改 yaml</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>      <span style=color:#5bc4bf>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#5bc4bf>args</span>:
</span></span><span style=display:flex><span>        - --<span style=color:#f99b15>cert-dir=/tmp</span>
</span></span><span style=display:flex><span>        - --<span style=color:#f99b15>secure-port=4443</span>
</span></span><span style=display:flex><span>        - --<span style=color:#f99b15>kubelet-preferred-address-types=InternalIP</span> <span style=color:#776e71># 第一处修改</span>
</span></span><span style=display:flex><span>        - --<span style=color:#f99b15>kubelet-use-node-status-port</span>
</span></span><span style=display:flex><span>        - --<span style=color:#f99b15>metric-resolution=15s</span>
</span></span><span style=display:flex><span>        - --<span style=color:#f99b15>kubelet-insecure-tls</span> <span style=color:#776e71># 第二处修改</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>image</span>: <span style=color:#f99b15>registry.aliyuncs.com/google_containers/metrics-server:v0.6.0</span> <span style=color:#776e71># 第三处修改</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>imagePullPolicy</span>: <span style=color:#f99b15>IfNotPresent</span>
</span></span></code></pre></div><ul><li><code>--kubelet-insecure-tls</code><ul><li>不验证 kubelet 自签的证书</li></ul></li><li>`&ndash;kubelet-preferred-address-types=InternalIP<ul><li>Metrics-server 连接 cadvisor 默认通过主机名即 node 的名称进行连接，而 Metric-server 作为 pod 运行在集群中默认是无法解析的，所以这里修改成通过节点 ip 连接</li></ul></li></ul><p>部署 metrics-server</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># kubectl apply -f metrics-server.yaml</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># kubectl get pods -n kube-system -l k8s-app=metrics-server</span>
</span></span><span style=display:flex><span>NAME                              READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>metrics-server-7f66b69ff6-bkfqg   1/1     Running   <span style=color:#f99b15>0</span>          59s
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># kubectl top nodes</span>
</span></span><span style=display:flex><span>NAME        CPU<span style=color:#5bc4bf>(</span>cores<span style=color:#5bc4bf>)</span>   CPU%   MEMORY<span style=color:#5bc4bf>(</span>bytes<span style=color:#5bc4bf>)</span>   MEMORY%
</span></span><span style=display:flex><span>k8s-node1   226m         11%    2004Mi          54%
</span></span><span style=display:flex><span>k8s-node2   97m          4%     1047Mi          28%
</span></span><span style=display:flex><span>k8s-node3   98m          4%     1096Mi          29%
</span></span></code></pre></div><h1 id=7-测试-kubernetes-集群>7 测试 kubernetes 集群<a hidden class=anchor aria-hidden=true href=#7-测试-kubernetes-集群>#</a></h1><ul><li>验证 Pod 工作</li><li>验证 Pod 网络通信</li><li>验证 DNS 解析</li></ul><p>在 Kubernetes 集群中创建一个 pod，验证是否正常运行：</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create deployment nginx --image<span style=color:#5bc4bf>=</span>nginx
</span></span><span style=display:flex><span>kubectl expose deployment nginx --type<span style=color:#5bc4bf>=</span>NodePort --port<span style=color:#5bc4bf>=</span><span style=color:#f99b15>80</span>  --target-port<span style=color:#5bc4bf>=</span><span style=color:#f99b15>80</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># kubectl get pod,deploy,svc</span>
</span></span><span style=display:flex><span>NAME                         READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>pod/nginx-6799fc88d8-57bqd   1/1     Running   <span style=color:#f99b15>0</span>          10m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style=display:flex><span>deployment.apps/nginx   1/1     <span style=color:#f99b15>1</span>            <span style=color:#f99b15>1</span>           10m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span style=color:#5bc4bf>(</span>S<span style=color:#5bc4bf>)</span>        AGE
</span></span><span style=display:flex><span>service/kubernetes   ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP        170m
</span></span><span style=display:flex><span>service/nginx        NodePort    10.102.188.108   &lt;none&gt;        80:30954/TCP   2m31s
</span></span></code></pre></div><p>访问地址：<a href=http://1.1.1.1:30954 target=_blank rel=noopener style=color:#42b983 ;>http://1.1.1.1:30954</a>，端口是固定的，ip 可以是集群内任一节点的 ip</p><h1 id=8-部署-dashboard>8 部署 Dashboard<a hidden class=anchor aria-hidden=true href=#8-部署-dashboard>#</a></h1><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.4.0/aio/deploy/recommended.yaml
</span></span></code></pre></div><p>默认 Dashboard 只能集群内部访问，修改 Service 为 NodePort 类型，暴露到外部：</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi recommended.yaml
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>kind: Service
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    k8s-app: kubernetes-dashboard
</span></span><span style=display:flex><span>  name: kubernetes-dashboard
</span></span><span style=display:flex><span>  namespace: kubernetes-dashboard
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  ports:
</span></span><span style=display:flex><span>    - port: <span style=color:#f99b15>443</span>
</span></span><span style=display:flex><span>      targetPort: <span style=color:#f99b15>8443</span>
</span></span><span style=display:flex><span>      nodePort: <span style=color:#f99b15>30001</span>
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    k8s-app: kubernetes-dashboard
</span></span><span style=display:flex><span>  type: NodePort
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl apply -f recommended.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get pods -n kubernetes-dashboard
</span></span><span style=display:flex><span>NAME                                         READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>dashboard-metrics-scraper-6b4884c9d5-gl8nr   1/1     Running   <span style=color:#f99b15>0</span>          13m
</span></span><span style=display:flex><span>kubernetes-dashboard-7f99b75bf4-89cds        1/1     Running   <span style=color:#f99b15>0</span>          13m
</span></span></code></pre></div><p>访问地址：https://NodeIP:30001</p><p>创建 service account 并绑定默认 cluster-admin 管理员集群角色：</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#776e71># 创建用户</span>
</span></span><span style=display:flex><span>kubectl create serviceaccount dashboard-admin -n kube-system
</span></span><span style=display:flex><span><span style=color:#776e71># 用户授权</span>
</span></span><span style=display:flex><span>kubectl create clusterrolebinding dashboard-admin --clusterrole<span style=color:#5bc4bf>=</span>cluster-admin --serviceaccount<span style=color:#5bc4bf>=</span>kube-system:dashboard-admin
</span></span><span style=display:flex><span><span style=color:#776e71># 获取用户Token</span>
</span></span><span style=display:flex><span>kubectl describe secrets -n kube-system <span style=color:#815ba4>$(</span>kubectl -n kube-system get secret | awk <span style=color:#48b685>&#39;/dashboard-admin/{print $1}&#39;</span><span style=color:#815ba4>)</span>
</span></span></code></pre></div><p>使用输出的 token 登录 Dashboard。</p><p>以上</p></div><div class=post-reward><div style=padding:0;margin:0;width:100%;font-size:16px;text-align:center><div id=QR style=opacity:0><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=https://www.lvbibir.cn/img/wechat_pay.png alt=wechat_pay></a><p>微信</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=https://www.lvbibir.cn/img/alipay.png alt=alipay></a><p>支付宝</p></div></div><button id=rewardButton onclick='var qr=document.getElementById("QR");qr.style.opacity==="0"?qr.style.opacity="1":qr.style.opacity="0"'>
<span>🧧 鼓励</span></button></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://www.lvbibir.cn/en/posts/tech/openstack-kolla-ansible-allinone-train/><span class=title>« 上一页</span><br><span>kolla-ansible 部署 openstack (Train) (all-in-one)</span>
</a><a class=next href=https://www.lvbibir.cn/en/posts/tech/rpm-build-openssh/><span class=title>下一页 »</span><br><span>openssh 源码打包编译成 rpm 包</span></a></nav></footer></div><div><div class=pagination__title><span class=pagination__title-h style=font-size:20px>💬评论</span><hr></div><div id=tcomment></div><script src=https://cdn.staticfile.org/twikoo/1.6.15/twikoo.all.min.js></script><script>twikoo.init({envId:"https://twikoo.lvbibir.cn/",el:"#tcomment",lang:"zh-CN",path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><a href=https://gohugo.io/ target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/frame-hugo-blue.svg>
</a><a href=https://github.com/adityatelange/hugo-PaperMod target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/theme-papermod-lightgrey.svg>
</a><a href=https://cn.aliyun.com/ target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/图床-阿里云-orange.svg></a><br><span id=runtime_span></span>
<script type=text/javascript>function show_runtime(){window.setTimeout("show_runtime()",1e3),X=new Date("7/13/2021 1:00:00"),Y=new Date,T=Y.getTime()-X.getTime(),M=24*60*60*1e3,a=T/M,A=Math.floor(a),b=(a-A)*24,B=Math.floor(b),c=(b-B)*60,C=Math.floor((b-B)*60),D=Math.floor((c-C)*60),runtime_span.innerHTML="网站已运行"+A+"天"+B+"小时"+C+"分"+D+"秒"}show_runtime()</script>|
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span id=busuanzi_container>总访客数: <span id=busuanzi_value_site_uv></span>
|
总访问量: <span id=busuanzi_value_site_pv></span></span><br><a href=https://beian.miit.gov.cn/ target=_blank style="border-bottom:1px solid">京ICP备2021023168号-1</a>&nbsp;
|
<span>Copyright
&copy;
2020-2024
<a href=https://www.lvbibir.cn/en/ style="border-bottom:1px solid">lvbibir's Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
<span id=read_progress></span>
</span></a><script>document.addEventListener("scroll",function(){const t=document.getElementById("read_progress"),n=document.documentElement.scrollHeight,s=document.documentElement.clientHeight,o=document.documentElement.scrollTop||document.body.scrollTop;t.innerText=((o/(n-s)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>400||document.documentElement.scrollTop>400?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="📄复制";function c(){t.innerText="👌🏻已复制!",setTimeout(()=>{t.innerText="📄复制"},2e3)}t.addEventListener("click",t=>{const n=document.createRange();n.selectNodeContents(e);const s=window.getSelection();s.removeAllRanges(),s.addRange(n);try{document.execCommand("copy"),c()}catch{}s.removeRange(n)});let l=e.className.replaceAll("language-",""),n=document.createElement("div"),i=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div"),o=document.createElement("div");o.innerText=l,n.setAttribute("class","mac-tool"),i.setAttribute("class","mac bb1"),a.setAttribute("class","mac bb2"),r.setAttribute("class","mac bb3"),o.setAttribute("class","language-type"),n.appendChild(i),n.appendChild(a),n.appendChild(r),n.appendChild(o),s.classList.contains("highlight")?(s.appendChild(t),s.appendChild(n)):s.parentNode.firstChild===s||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName==="TABLE"?(e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t),s.appendChild(n)):(e.parentNode.appendChild(t),s.appendChild(n)))})</script></body></html>