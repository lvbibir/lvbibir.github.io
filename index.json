[{"content":"0 å‰è¨€ æœ¬æ–‡å†…å®¹æ¯”è¾ƒæ‚ä¹±, æ— æ³•ä¿è¯å®æ—¶æ›´æ–°, å¦‚æœé‡åˆ°é—®é¢˜, å¯ä»¥åœ¨ github æŸ¥çœ‹æœ€æ–°çš„é…ç½®:\nhugo ç›¸å…³é…ç½® docker ç›¸å…³é…ç½® ç ”ç©¶ hugo å»ºç«™ä¹‹åˆæ˜¯æ‰“ç®—é‡‡ç”¨ Github Pages æ¥å‘å¸ƒé™æ€åšå®¢\nä¼˜ç‚¹ ä»…éœ€ä¸€ä¸ª github è´¦å·å’Œç®€å•é…ç½®å³å¯å°†é™æ€åšå®¢å‘å¸ƒåˆ° github pages æ²¡æœ‰ç»´æŠ¤çš„æ—¶é—´æˆæœ¬, å¯ä»¥å°†ç²¾åŠ›æ›´å¤šçš„æ”¾åˆ°åšå®¢å†…å®¹æœ¬èº«ä¸Šå» æ— éœ€å¤‡æ¡ˆ æ— éœ€ ssl è¯ä¹¦ ç¼ºç‚¹ è®¿é—®é€Ÿåº¦è¾ƒæ…¢ è®¿é—®é€Ÿåº¦è¾ƒæ…¢ è®¿é—®é€Ÿåº¦è¾ƒæ…¢ è™½è¯´è®¿é—®é€Ÿåº¦è¾ƒæ…¢å¯ä»¥é€šè¿‡å„å®¶çš„ cdn åŠ é€Ÿæ¥è§£å†³, ä½†ç”±äºåˆšå¼€å§‹å»ºç«‹ blog é€‰æ‹©çš„æ˜¯ wordpress, åŸŸå, æœåŠ¡å™¨, å¤‡æ¡ˆ, è¯ä¹¦ç­‰éƒ½å·²ç»ä¸€åº”ä¿±å…¨, ä¸”ä¹‹å‰çš„æ¶æ„é‡‡ç”¨ docker, æ·»åŠ ä¸€å° nginx æ¥è·‘ hugo çš„é™æ€ç½‘ç«™æ˜¯å¾ˆæ–¹ä¾¿çš„\n1 å°†åšå®¢éƒ¨ç½²åˆ°é˜¿é‡Œäº‘ æ•´ä¸ªæ­¥éª¤æœ€éš¾çš„åœ°æ–¹å¯èƒ½å°±æ˜¯ docker-compose å’Œ nginx çš„é…ç½®äº†, å¦‚æœä¹‹å‰æ²¡æœ‰æ¥è§¦è¿‡å¯èƒ½ä¼šæ¯”è¾ƒåƒåŠ›, å› æ­¤æˆ‘æ‰“åŒ…äº†ä¸€ä»½å¼€è¢‹å³é£Ÿçš„é…ç½®æ–‡ä»¶, åªéœ€è¦ä¿®æ”¹ä¸€äº›å¿…è¦é…ç½®, ç‚¹æ­¤é“¾æ¥ä¸‹è½½\nä¸‹è½½å®Œå°†å‹ç¼©åŒ…ä¸Šä¼ åˆ°è‡ªå·±çš„æœåŠ¡å™¨, è§£å‹åé‡å‘½åä¸º blog (å½“ç„¶ä½ å¯ä»¥ç”¨å…¶ä»–åå­—)\nä¸‹é¢æ­£å¼å¼€å§‹éƒ¨ç½²:\nç¡®ä¿æœåŠ¡å™¨å…¬ç½‘ ipã€å®‰å…¨ç»„æƒé™ (80/443), åŸŸåç»‘å®š, ssl è¯ä¹¦ç­‰åŸºç¡€é…ç½®å·²ç»ä¸€åº”ä¿±å…¨ ç¡®ä¿æœåŠ¡å™¨å®‰è£…äº† docker å’Œ docker-compose ä¿®æ”¹ blog/conf/nginx-hugo/nginx.conf å’Œ blog/conf/nginx-proxy/default.conf, éœ€è¦ä¿®æ”¹çš„åœ°æ–¹åœ¨æ–‡ä»¶ä¸­å·²ç»æ ‡æ³¨å‡ºæ¥äº† å°†ä½ çš„ ssl è¯ä¹¦æ”¾åˆ° blog/ssl/ ç›®å½•ä¸‹ åœ¨ blog ç›®å½•ä¸‹æ‰§è¡Œ docker-compose up -d å³å¯å¯åŠ¨å®¹å™¨ é…ç½® twikoo çš„å‰ç«¯ä»£ç , è§æœ¬æ–‡ç« èŠ‚ 3.2 å°† hugo ç”Ÿæˆçš„é™æ€æ–‡ä»¶ä¸Šä¼ åˆ° blog/data/hugo/ ç›®å½•, è§æœ¬æ–‡ç« èŠ‚ 2 è‡³æ­¤å·²ç»é…ç½®å®Œæˆ, åº”è¯¥å¯ä»¥é€šè¿‡åŸŸåè®¿é—® hugo ç«™ç‚¹äº†, åç»­æ›´æ–°å†…å®¹åªéœ€è¦é‡å¤æœ€åä¸€æ­¥, å°† hugo ç”Ÿæˆçš„é™æ€æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨å³å¯\næ‰€æœ‰çš„é…ç½®ã€åº”ç”¨æ•°æ®ã€æ—¥å¿—éƒ½ä¿å­˜åœ¨ blog ç›®å½•ä¸‹, ä½ å¯ä»¥åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šå¿«é€Ÿè¿ç§» hugo ç¯å¢ƒ, æ— éœ€æ‹…å¿ƒåç»­æƒ³è¦è¿ç§»æ–°æœåŠ¡å™¨æ—¶é‡åˆ°çš„å„ç§é—®é¢˜\n2 workflow åœ¨è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹æˆ‘ä»å†™åšå®¢ -\u0026gt; å‘å¸ƒåˆ°æœåŠ¡å™¨ -\u0026gt; å½’æ¡£å¤‡ä»½çš„æ•´ä¸ªæµç¨‹\næ€»ä½“æµç¨‹:\nobsidian ç¼–è¾‘æ–‡ç« , å›¾ç‰‡é€šè¿‡ Image Auto Upload Plugin æ’ä»¶é…åˆ piclist ä¸Šä¼ åˆ°é˜¿é‡Œäº‘ OSS, å…·ä½“é…ç½®å’Œæ“ä½œè§ docker éƒ¨ç½² piclist ç¼–è¾‘å®Œæˆåå°†é€šè¿‡ æ­¤è„šæœ¬ å°†ç¼–è¾‘åçš„æ–‡ç« æ›´æ–°åˆ° hugo site ç›®å½•, åŒæ—¶ä¹Ÿæ˜¯ git ä»“åº“ ä½¿ç”¨ hugo server -D é¢„è§ˆå˜æ›´, å¦‚æœ‰é—®é¢˜é‡å¤å‰ä¸¤ä¸ªæ­¥éª¤ ç¡®è®¤æ— è¯¯åé€šè¿‡ æ­¤è„šæœ¬ ç”Ÿæˆé™æ€æ–‡ä»¶, å¹¶å°†æ–‡ä»¶è¿œç¨‹åŒæ­¥åˆ°å…¬ç½‘æœåŠ¡å™¨, å®Œæˆåšå®¢å†…å®¹å˜æ›´ æœ€åå°† git ä»“åº“çš„å˜æ›´æäº¤ååŒæ­¥åˆ° github è¿œç¨‹ä»“åº“, å®Œæˆå½’æ¡£å¤‡ä»½ å…¶å®å¦‚æœä½¿ç”¨ vscode ç›´æ¥ç¼–è¾‘ git ä»“åº“ä¸­çš„åšå®¢æ–‡ç« å¯ä»¥è®©æ•´ä¸ªæµç¨‹æ›´åŠ ç®€åŒ–, ä½†æ˜¯ vscode çš„ markdown ç¼–è¾‘ä½“éªŒå®åœ¨æ˜¯æ¯”ä¸ä¸Š typora æˆ–è€… obsidian, å·¥æ¬²å–„å…¶äº‹å¿…å…ˆåˆ©å…¶å™¨, æœ‰äº†å¥½çš„ç¼–è¾‘ä½“éªŒæ‰æ›´æ„¿æ„è¾“å‡ºå†…å®¹\n3 twikoo 3.1 éƒ¨ç½² twikoo å®˜æ–¹æä¾›äº† ä¸°å¯Œçš„éƒ¨ç½²æ–¹å¼, è€ƒè™‘åˆ°è®¿é—®é€Ÿåº¦, æœ¬æ–‡ä½¿ç”¨çš„æ˜¯ docker æ–¹å¼éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨\nå¦‚æœæ˜¯ä½¿ç”¨æœ¬æ–‡ç« èŠ‚ 1 æ­¥éª¤ä¸­çš„é…ç½®æ–‡ä»¶éƒ¨ç½²äº† twikoo, è¿™æ­¥ç›´æ¥å¿½ç•¥, é…ç½®å‰ç«¯ä»£ç å³å¯\ndocker run --name twikoo -e TWIKOO_THROTTLE=1000 -p 8080:8080 -v ${PWD}/data:/app/data -d imaegoo/twikoo éƒ¨ç½²å®Œæˆåçœ‹åˆ°å¦‚ä¸‹ç»“æœå³æˆåŠŸ\n[root@lvbibir ~]# curl http://localhost:8080 {\u0026#34;code\u0026#34;:100, \u0026#34;message\u0026#34;:\u0026#34;Twikoo äº‘å‡½æ•°è¿è¡Œæ­£å¸¸, è¯·å‚è€ƒ https://twikoo.js.org/quick-start.html#%E5%89%8D%E7%AB%AF%E9%83%A8%E7%BD%B2 å®Œæˆå‰ç«¯çš„é…ç½®\u0026#34;, \u0026#34;version\u0026#34;:\u0026#34;1.6.7\u0026#34;} åç»­æœ€å¥½å¥—ä¸Šåå‘ä»£ç†, åŠ ä¸ŠåŸŸåå’Œè¯ä¹¦\n3.2 å‰ç«¯ä»£ç  åˆ›å»ºæˆ–è€…ä¿®æ”¹ layouts\\partials\\comments.html\n\u0026lt;!-- Twikoo --\u0026gt; \u0026lt;div\u0026gt; \u0026lt;div class=\u0026#34;pagination__title\u0026#34;\u0026gt; \u0026lt;span class=\u0026#34;pagination__title-h\u0026#34; style=\u0026#34;font-size: 20px;\u0026#34;\u0026gt;ğŸ’¬è¯„è®º\u0026lt;/span\u0026gt; \u0026lt;hr /\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div id=\u0026#34;tcomment\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;script src=\u0026#34;https://cdn.staticfile.org/twikoo/{{ .Site.Params.twikoo.version }}/twikoo.all.min.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script\u0026gt; twikoo.init({ envId: \u0026#34;\u0026#34;, //å¡«è‡ªå·±çš„, ä¾‹å¦‚ï¼šhttps://example.com el: \u0026#34;#tcomment\u0026#34;, lang: \u0026#39;zh-CN\u0026#39;, path: window.TWIKOO_MAGIC_PATH||window.location.pathname, }); \u0026lt;/script\u0026gt; \u0026lt;/div\u0026gt; è°ƒç”¨ä¸Šè¿° twikoo ä»£ç çš„ä½ç½®ï¼šlayouts/_default/single.html\n\u0026lt;article class=\u0026#34;post-single\u0026#34;\u0026gt; // å…¶ä»–ä»£ç ...... {{- if (.Param \u0026#34;comments\u0026#34;) }} {{- partial \u0026#34;comments.html\u0026#34; . }} {{- end }} \u0026lt;/article\u0026gt; åœ¨ç«™ç‚¹é…ç½®æ–‡ä»¶ config ä¸­åŠ ä¸Šç‰ˆæœ¬å·\nparams: twikoo: version: 1.6.7 3.3 æ›´æ–° ä¿®æ”¹ dockerfile.yml ä¸­çš„é•œåƒ tag éƒ¨ç½²æ–°ç‰ˆæœ¬å®¹å™¨ docker-compose up -d åœ¨ hugo é…ç½®æ–‡ä»¶ config.yml ä¸­ä¿®æ”¹ twikoo ç‰ˆæœ¬ 3.4 ä¿®æ”¹æ•°æ® ç›´æ¥ä¿®æ”¹ blog/data/twikoo/ ç›®å½•ä¸‹çš„æ–‡ä»¶åé‡å¯å®¹å™¨, â—æ…é‡ä¿®æ”¹\n3.5 ä¿®æ”¹ smms å›¾åºŠçš„ api åœ°å€ å·²äº 1.6.12 æ–°ç‰ˆæœ¬ä¿®å¤, https://github.com/imaegoo/twikoo/releases/tag/1.6.12\nç”±äº sm.ms åŸŸåå›½å†…æ— æ³•è®¿é—®, twikoo å®˜æ–¹è¿˜æ²¡æœ‰å‡ºå…·ä½“çš„ä¿®æ”¹æ–¹å¼, è‡ªå·±ä¿®æ”¹å®¹å™¨é…ç½®æ–‡ä»¶è¿›è¡Œä¿®æ”¹\n# å¤åˆ¶é…ç½®æ–‡ä»¶ [root@lvbibir blog]# docker cp twikoo:/app/node_modules/twikoo-func/utils/image.js /root/blog/conf/twikoo/ # ä¿®æ”¹é…ç½®æ–‡ä»¶, åŸæ¥çš„é…ç½®æ˜¯ https://sm.ms/api.v2/upload [root@lvbibir blog]# grep smms conf/twikoo/image.js } else if (config.IMAGE_CDN === \u0026#39;smms\u0026#39;) { const uploadResult = await axios.post(\u0026#39;https://smms.app/api/v2/upload\u0026#39;, formData, { # å°†é…ç½®æ–‡ä»¶æ˜ å°„è¿›å®¹å™¨å†…, é‡å¯å®¹å™¨å³å¯ [root@lvbibir blog]# grep twikoo docker-compose.yml twikoo: image: imaegoo/twikoo container_name: twikoo - $PWD/data/twikoo:/app/data - $PWD/conf/twikoo/image.js:/app/node_modules/twikoo-func/utils/image.js 4 Artitalk å®˜æ–¹æ–‡æ¡£\néœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœä½¿ç”¨çš„æ˜¯å›½é™…ç‰ˆçš„ LeadCloud, éœ€è¦ç»‘å®šè‡ªå®šä¹‰åŸŸååæ‰èƒ½æ­£å¸¸è®¿é—®\n4.1 leancloud é…ç½® å‰å¾€ LeanCloud å›½é™…ç‰ˆ, æ³¨å†Œè´¦å· æ³¨å†Œå®Œæˆä¹‹åæ ¹æ® LeanCloud çš„æç¤ºç»‘å®šæ‰‹æœºå·å’Œé‚®ç®± ç»‘å®šå®Œæˆä¹‹åç‚¹å‡» åˆ›å»ºåº”ç”¨, åº”ç”¨åç§°éšæ„, æ¥ç€åœ¨ ç»“æ„åŒ–æ•°æ® ä¸­åˆ›å»º class, å‘½åä¸º shuoshuo åœ¨ä½ æ–°å»ºçš„åº”ç”¨ä¸­æ‰¾åˆ° ç»“æ„åŒ–æ•°æ® ä¸‹çš„ ç”¨æˆ· ç‚¹å‡» æ·»åŠ ç”¨æˆ·, è¾“å…¥æƒ³ç”¨çš„ç”¨æˆ·ååŠå¯†ç  å›åˆ° ç»“æ„åŒ–æ•°æ® ä¸­, ç‚¹å‡» class ä¸‹çš„ shuoshuo æ‰¾åˆ°æƒé™, åœ¨ Class è®¿é—®æƒé™ ä¸­å°† add_fields ä»¥åŠ create æƒé™è®¾ç½®ä¸ºæŒ‡å®šç”¨æˆ·, è¾“å…¥ä½ åˆšæ‰è¾“å…¥çš„ç”¨æˆ·åä¼šè‡ªåŠ¨åŒ¹é…ä¸ºäº†å®‰å…¨èµ·è§, å°† delete å’Œ update ä¹Ÿè®¾ç½®ä¸ºè·Ÿå®ƒä»¬ä¸€æ ·çš„æƒé™ ç„¶åæ–°å»ºä¸€ä¸ªåä¸º atComment çš„ class, æƒé™ä»€ä¹ˆçš„ä½¿ç”¨é»˜è®¤çš„å³å¯ ç‚¹å‡» class ä¸‹çš„ _User æ·»åŠ åˆ—, åˆ—åç§°ä¸º img, é»˜è®¤å€¼å¡«ä¸Šä½ è¿™ä¸ªè´¦å·æƒ³è¦ç”¨çš„å‘å¸ƒè¯´è¯´çš„å¤´åƒ url, è¿™ä¸€é¡¹ä¸è¿›è¡Œé…ç½®, è¯´è¯´å¤´åƒä¼šæ˜¾ç¤ºä¸ºé»˜è®¤å¤´åƒ â€”â€” Artitalk çš„ logo åœ¨æœ€èœå•æ ä¸­æ‰¾åˆ°è®¾ç½® -\u0026gt; åº”ç”¨ keys, è®°ä¸‹æ¥ AppID å’Œ AppKey , ä¸€ä¼šä¼šç”¨ æœ€åå°† _User ä¸­çš„æƒé™å…¨éƒ¨è°ƒä¸ºæŒ‡å®šç”¨æˆ·, æˆ–è€…æ•°æ®åˆ›å»ºè€…, ä¸ºäº†ä¿è¯ä¸è¢«ç¯¡æ”¹ç”¨æˆ·æ•°æ®ä»¥è¾¾åˆ°å¼ºåˆ¶å‘å¸ƒè¯´è¯´ åœ¨è®¾ç½® -\u0026gt;åŸŸåç»‘å®šä¸­ç»‘å®šè‡ªå®šä¹‰åŸŸå â— å…³äºè®¾ç½®æƒé™çš„è¿™å‡ æ­¥ è¿™å‡ æ­¥ä¸€å®šè¦è®¾ç½®å¥½, æ‰å¯ä»¥ä¿è¯ä¸è¢« â€œé—²äººâ€ ç ´è§£å‘å¸ƒè¯´è¯´çš„éªŒè¯\n4.2 hugo é…ç½® æ–°å¢ content/talk.md é¡µé¢, å†…å®¹å¦‚ä¸‹, æ³¨æ„ä¿®æ”¹æ ‡æ³¨çš„å†…å®¹, front-matter çš„å†…å®¹è‡ªè¡Œä¿®æ”¹\n--- title: \u0026#34;ğŸ’¬ è¯´è¯´\u0026#34; date: 2021-08-31 hidemeta: true description: \u0026#34;èƒ¡è¨€ä¹±è¯­\u0026#34; comments: true reward: false showToc: false TocOpen: false showbreadcrumbs: false --- \u0026lt;body\u0026gt; \u0026lt;!-- å¼•ç”¨ artitalk --\u0026gt; \u0026lt;script type=\u0026#34;text/javascript\u0026#34; src=\u0026#34;https://unpkg.com/artitalk\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;!-- å­˜æ”¾è¯´è¯´çš„å®¹å™¨ --\u0026gt; \u0026lt;div id=\u0026#34;artitalk_main\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;script\u0026gt; new Artitalk({ appId: \u0026#39;**********\u0026#39;, // Your LeanCloud appId appKey: \u0026#39;************\u0026#39;, // Your LeanCloud appKey serverURL: \u0026#39;*********\u0026#39; // ç»‘å®šçš„è‡ªå®šä¹‰åŸŸå }) \u0026lt;/script\u0026gt; \u0026lt;/body\u0026gt; è¿™ä¸ªæ—¶å€™å·²ç»å¯ä»¥ç›´æ¥è®¿é—®äº†, https://your.domain.com/talk\nè¾“å…¥ leancloud é…ç½®æ­¥éª¤ä¸­çš„ç¬¬ 4 æ­¥é…ç½®çš„ç”¨æˆ·åå¯†ç ç™»å½•åå°±å¯ä»¥å‘å¸ƒè¯´è¯´äº†\n5 è‡ªå»ºä¸è’œå­ç»Ÿè®¡å¹³å° åŸç‰ˆä¸è’œå­ æ˜¯ä¸€ä¸ªç‹¬ç«‹å¼€å‘è€…å…è´¹æä¾›ç»™æ‰€æœ‰äººä½¿ç”¨çš„å¹³å°, éšç€ä½¿ç”¨äººæ•°è¶Šæ¥è¶Šå¤š, è®¿é—®é€Ÿåº¦ä¸å°½å¦‚äººæ„, é‚å†³å®šè‡ªå»ºä¸è’œå­å¹³å°\nè‡ªå»ºä¸è’œå­é¡¹ç›® ä¸è’œå­è¿ç§»é¡¹ç›®\n5.1 éƒ¨ç½² ä½¿ç”¨ docker compose éƒ¨ç½²\nservices: busuanzi-redis: image: \u0026#34;docker.1ms.run/library/redis:8.4.0-alpine3.22\u0026#34; container_name: busuanzi-redis restart: always ports: - \u0026#34;6379:6379\u0026#34; # æ•°æ®è¿ç§»å®Œä¹‹åå¯ä»¥å…³é—­ç«¯å£ volumes: - ./data/busuanzi-redis:/data busuanzi: image: \u0026#34;docker.1ms.run/xcsoft/busuanzi:v2.8.8\u0026#34; container_name: busuanzi restart: always ports: - \u0026#34;8080:8080\u0026#34; # æˆ‘é€šè¿‡ Nginx å‰ç«¯ä»£ç†çš„, æ‰€ä»¥æ•°æ®è¿ç§»å®Œä¹‹åç›´æ¥å…³é—­ç«¯å£äº† links: - busuanzi-redis depends_on: - busuanzi-redis environment: WEB_LOG: true # æ˜¯å¦å¼€å¯æ—¥å¿— WEB_DEBUG: false # æ˜¯å¦å¼€å¯debugæ¨¡å¼ WEB_CORS: \u0026#34;*\u0026#34; # è·¨åŸŸè®¿é—® BSZ_EXPIRE: 0 # ç»Ÿè®¡æ•°æ®è¿‡æœŸæ—¶é—´ å•ä½ç§’, è¯·è¾“å…¥æ•´æ•° (æ— ä»»ä½•è®¿é—®, è¶…è¿‡è¿™ä¸ªæ—¶é—´å, ç»Ÿè®¡æ•°æ®å°†è¢«æ¸…ç©º, 0ä¸ºä¸è¿‡æœŸ) BSZ_SECRET: \u0026#34;bsz\u0026#34; # ç­¾åå¯†é’¥ // è¯·è®¾ç½®ä¸ºä»»æ„é•¿åº¦çš„éšæœºå€¼ API_SERVER: https://lvbibir.cn/busuanzi # å¡«å†™ä½ çš„ API åœ°å€ REDIS_ADDRESS: busuanzi-redis:6379 # redis åœ°å€ BSZ_PATHSTYLE: true BSZ_ENCRYPT: MD516 5.2 åŒæ­¥æ•°æ® wget https://github.com/soxft/busuanzi-sync/releases/download/v0.0.5/busuanzi-sync-linux-amd64-v0.0.5 chmod a+x busuanzi-sync-linux-amd64-v0.0.5 cat \u0026gt; .env \u0026lt;\u0026lt;-\u0026#39;EOF\u0026#39; # åœ¨æ­¤å¤„æŒ‡å®šæ‚¨çš„åšå®¢ sitemap åœ°å€ SITEMAP_URL: https://lvbibir.cn/sitemap.xml # çº¿ç¨‹æ•° é¿å…è¿‡é«˜å¯¼è‡´ QPS é™åˆ¶ / ä¸è¦è¶…è¿‡5 THREADS: 2 # å• URL æœ€å¤§é‡è¯•æ¬¡æ•° MAX_RETRY: 10 REDIS_ADDR: 127.0.0.1:6379 REDIS_DB: 0 REDIS_PWD: \u0026#34;\u0026#34; REDIS_PREFIX: bsz REDIS_TLS: false # è·¯å¾„æ ·å¼ ä¸åŠ å¯†æ–¹æ¡ˆ BSZ_PATH_STYLE: true BSZ_ENCRYPT: MD516 EOF ./busuanzi-sync-linux-amd64-v0.0.5 5.3 å‡çº§æ•°æ® wget https://github.com/soxft/busuanzi-transfer/releases/download/v0.0.4/busuanzi-transfer-linux-amd64-v0.0.4 cat \u0026gt; config.yaml \u0026lt;\u0026lt;-\u0026#39;EOF\u0026#39; Redis: Address: 127.0.0.1:6379 Password: \u0026#34;\u0026#34; Database: 0 Prefix: \u0026#34;bsz\u0026#34; ToPrefix: \u0026#34;bsz_transfer\u0026#34; EOF ./busuanzi-transfer-linux-amd64-v0.0.4 5.4 æ‰‹åŠ¨æ›´æ–°ç«™ç‚¹æ•°æ® æŒ‰ç†è¯´è¿™ä¸€æ­¥æ˜¯ä¸éœ€è¦çš„, ä½†æ˜¯æˆ‘å‡çº§å®Œæ•°æ®ä¹‹åæ–‡ç« é¡µçš„è®¿é—®æ•°æ®æ˜¯æ­£å¸¸çš„, ç«™ç‚¹çš„ pv å’Œ uv è¿˜æ˜¯æ²¡æœ‰, æ‰€ä»¥è¿™é‡Œæ‰‹åŠ¨æ›´æ–°ä¸€ä¸‹æ•°æ®, pv å’Œ uv çš„æ•°æ®æ‰‹åŠ¨ä»åŸç‰ˆä¸è’œå­è·å–.\ndocker exec -it busuanzi-redis /bin/sh redis-cli -h 127.0.0.1 -p 6379 SET bsz:site_pv:f4a42bbb359a9e01 \u0026#34;91750\u0026#34; EVAL \u0026#34;redis.call(\u0026#39;DEL\u0026#39;, KEYS[1]); for i=1,tonumber(ARGV[1]) do redis.call(\u0026#39;PFADD\u0026#39;, KEYS[1], \u0026#39;u-\u0026#39;..i) end; return redis.call(\u0026#39;PFCOUNT\u0026#39;, KEYS[1])\u0026#34; 1 bsz:site_uv:f4a42bbb359a9e01 55649 5.5 ä½¿ç”¨ è§ 6.3\n6 è‡ªå®šä¹‰ footer è‡ªå®šä¹‰é¡µè„šå†…å®¹\næ·»åŠ å®Œä¸‹é¢çš„é¡µè„šå†…å®¹åè¦ä¿®æ”¹ assets\\css\\extended\\blank.css ä¸­çš„ --footer-height çš„å¤§å°, å…·ä½“æ•°å­—éœ€è¦è€ƒè™‘åˆ°è¡Œæ•°å’Œå­—ä½“å¤§å°\n6.1 è‡ªå®šä¹‰å¾½æ ‡ å¾½æ ‡åŠŸèƒ½æºè‡ªï¼šhttps://shields.io/ è€ƒè™‘åˆ°è®¿é—®é€Ÿåº¦, å¯ä»¥åœ¨ç”Ÿæˆå®Œå¾½æ ‡åæ”¾åˆ°è‡ªå·±çš„ cdn ä¸Š\nåœ¨ layouts\\partials\\footer.html ä¸­çš„ \u0026lt;footer\u0026gt; æ·»åŠ å¦‚ä¸‹\n\u0026lt;a href=\u0026#34;https://gohugo.io/\u0026#34; target=\u0026#34;_blank\u0026#34;\u0026gt; \u0026lt;img src=\u0026#34;https://img.shields.io/static/v1?\u0026amp;style=plastic\u0026amp;color=308fb5\u0026amp;label=Power by\u0026amp;message=hugo\u0026amp;logo=hugo\u0026#34; style=\u0026#34;display: unset;\u0026#34;\u0026gt; \u0026lt;/a\u0026gt; 6.2 ç½‘ç«™è¿è¡Œæ—¶é—´ åœ¨ layouts\\partials\\footer.html ä¸­çš„ \u0026lt;footer\u0026gt; æ·»åŠ å¦‚ä¸‹\nèµ·å§‹æ—¶é—´è‡ªè¡Œä¿®æ”¹\n\u0026lt;span id=\u0026#34;runtime_span\u0026#34;\u0026gt;\u0026lt;/span\u0026gt; \u0026lt;script type=\u0026#34;text/javascript\u0026#34;\u0026gt;function show_runtime(){window.setTimeout(\u0026#34;show_runtime()\u0026#34;, 1000);X=new Date(\u0026#34;7/13/2021 1:00:00\u0026#34;);Y=new Date();T=(Y.getTime()-X.getTime());M=24*60*60*1000;a=T/M;A=Math.floor(a);b=(a-A)*24;B=Math.floor(b);c=(b-B)*60;C=Math.floor((b-B)*60);D=Math.floor((c-C)*60);runtime_span.innerHTML=\u0026#34;ç½‘ç«™å·²è¿è¡Œ\u0026#34;+A+\u0026#34;å¤©\u0026#34;+B+\u0026#34;å°æ—¶\u0026#34;+C+\u0026#34;åˆ†\u0026#34;+D+\u0026#34;ç§’\u0026#34;}show_runtime();\u0026lt;/script\u0026gt; 6.3 è®¿é—®äººæ•°ç»Ÿè®¡ ç»Ÿè®¡æ•°æ®æºäºè‡ªå»ºçš„ä¸è’œå­å¹³å°, è§ ç« èŠ‚ 5\nå…¨ç«™æ•°æ®ç»Ÿè®¡, ä¿®æ”¹ layouts\\partials\\footer.html\n\u0026lt;footer\u0026gt; \u0026lt;!-- æ·»åŠ å¦‚ä¸‹è¡Œ --\u0026gt; \u0026lt;script defer src=\u0026#34;https://lvbibir.cn/busuanzi/js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;span id=\u0026#34;busuanzi_container\u0026#34;\u0026gt; æ€»è®¿å®¢æ•°: \u0026lt;span id=\u0026#34;busuanzi_site_uv\u0026#34;\u0026gt;\u0026lt;/span\u0026gt; | æ€»è®¿é—®é‡: \u0026lt;span id=\u0026#34;busuanzi_site_pv\u0026#34;\u0026gt;\u0026lt;/span\u0026gt; \u0026lt;/span\u0026gt; \u0026lt;/footer\u0026gt; æ–‡ç« é¡µæ•°æ®ç»Ÿè®¡\n\u0026lt;div class=\u0026#34;post-meta\u0026#34;\u0026gt; \u0026lt;!-- æ·»åŠ å¦‚ä¸‹ä¸‰è¡Œ --\u0026gt; \u0026lt;span id=\u0026#34;busuanzi_container_page_pv\u0026#34;\u0026gt; \u0026amp;nbsp;|\u0026amp;nbsp;è®¿é—®:\u0026amp;nbsp;\u0026lt;span id=\u0026#34;busuanzi_page_pv\u0026#34;\u0026gt;\u0026lt;/span\u0026gt; \u0026lt;/span\u0026gt; \u0026lt;div class=\u0026#34;post-meta\u0026#34;\u0026gt; 7 è‡ªå®šä¹‰å­—ä½“ å¯ä»¥ä½¿ç”¨ä¸€äº›åœ¨çº¿çš„å­—ä½“, å¯èƒ½ä¼šæ¯”è¾ƒæ…¢, æ¨èä¸‹è½½æƒ³è¦çš„å­—ä½“æ”¾åˆ°è‡ªå·±çš„æœåŠ¡å™¨æˆ–è€… cdn ä¸Š\nä¿®æ”¹ assets\\css\\extended\\fonts.css, æ·»åŠ  @font-face\n@font-face { font-family: \u0026#34;LXGWWenKaiLite-Bold\u0026#34;; src: url(\u0026#34;https://your.domain.com/fonts/test.woff2\u0026#34;) format(\u0026#34;woff2\u0026#34;); font-display: swap; } ä¿®æ”¹ assets\\css\\extended\\blank.css, æ¨èå°†è‹±æ–‡å­—ä½“æ”¾åœ¨å‰é¢, å¯ä»¥å®ç°è‹±æ–‡å’Œä¸­æ–‡ä½¿ç”¨ä¸åŒå­—ä½“\n.post-content { font-family: Consolas, \u0026#34;LXGWWenKaiLite-Bold\u0026#34;; //ä¿®æ”¹ } body { font-family: Consolas, \u0026#34;LXGWWenKaiLite-Bold\u0026#34;; //ä¿®æ”¹ } 8 ä¿®æ”¹é“¾æ¥é¢œè‰² åœ¨ hugo+papermod é»˜è®¤é…ç½®ä¸‹, é“¾æ¥é¢œè‰²æ˜¯é»‘è‰²å­—ä½“å¸¦ä¸‹åˆ’çº¿çš„ç»„åˆ, ä¸ªäººéå¸¸å–œæ¬¢ typora-vue çš„æ¸²æŸ“é£æ ¼ hugoå®˜æ–¹æ–‡æ¡£ ç»™å‡ºäº†é€šè¿‡ render hooks è¦†ç›–é»˜è®¤çš„ markdown æ¸²æŸ“ link çš„æ–¹å¼\næ–°å»º layouts/_default/_markup/render-link.html æ–‡ä»¶, å†…å®¹å¦‚ä¸‹åœ¨å®˜æ–¹ç»™å‡ºçš„ç¤ºä¾‹ä¸­æ·»åŠ äº† style=\u0026quot;color:#42b983, é¢œè‰²å¯ä»¥è‡ªè¡Œä¿®æ”¹\n\u0026lt;a href=\u0026#34;{{ .Destination | safeURL }}\u0026#34;{{ with .Title}} title=\u0026#34;{{ . }}\u0026#34;{{ end }}{{ if strings.HasPrefix .Destination \u0026#34;http\u0026#34; }} target=\u0026#34;_blank\u0026#34; rel=\u0026#34;noopener\u0026#34; style=\u0026#34;color:#42b983\u0026#34;;{{ end }}\u0026gt;{{ .Text | safeHTML }}\u0026lt;/a\u0026gt; 9 shortcode pptã€bilibiliã€youtubeã€è±†ç“£é˜…è¯»å’Œç”µå½±å¡ç‰‡\nmermaid\nå›¾ç‰‡ç”»å»Š\n10 å…¶ä»–ä¿®æ”¹ å…¶ä»– css æ ·å¼ä¿®æ”¹åŸºæœ¬éƒ½æ˜¯é€šè¿‡ f12 æ§åˆ¶å°ä¸€ç‚¹ç‚¹æ‘¸ç´¢æ”¹çš„, ä¸å¤ªè§„èŒƒä¸”æ¯”è¾ƒçç¢å°±ä¸å•ç‹¬è®°å½•äº†, å…¶å®æˆ‘æ ¹æœ¬å·²ç»å¿˜è®°è¿˜æ”¹äº†å“ªäº›ä¸œè¥¿\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/blog/hello-hugo/","summary":"0 å‰è¨€ æœ¬æ–‡å†…å®¹æ¯”è¾ƒæ‚ä¹±, æ— æ³•ä¿è¯å®æ—¶æ›´æ–°, å¦‚æœé‡åˆ°é—®é¢˜, å¯ä»¥åœ¨ github æŸ¥çœ‹æœ€æ–°çš„é…ç½®: hugo ç›¸å…³é…ç½® docker ç›¸å…³é…ç½® ç ”ç©¶ hugo å»ºç«™ä¹‹åˆæ˜¯æ‰“ç®—é‡‡ç”¨ Github Pages æ¥å‘å¸ƒé™æ€åšå®¢ ä¼˜ç‚¹ ä»…éœ€ä¸€ä¸ª github è´¦å·å’Œç®€å•é…ç½®å³å¯å°†é™æ€åšå®¢å‘å¸ƒåˆ° github pages æ²¡æœ‰ç»´æŠ¤çš„æ—¶é—´æˆæœ¬, å¯ä»¥å°†ç²¾åŠ›æ›´å¤šçš„æ”¾åˆ°åšå®¢å†…å®¹æœ¬èº«ä¸Šå» æ— éœ€å¤‡æ¡ˆ æ— éœ€ ssl è¯ä¹¦ ç¼ºç‚¹ è®¿é—®é€Ÿåº¦","title":"ã€ç½®é¡¶ã€‘Hello, hugo!"},{"content":"0 å‰è¨€ æœ¬æ–‡åŸºäº linux ç¯å¢ƒæ‰€å†™, é‡‡ç”¨ win10 ä¸­çš„ wsl2, ç³»ç»Ÿç‰ˆæœ¬æ˜¯ ubuntu-20.04, å·²ç»å¾ˆå°‘ä½¿ç”¨ windows åŸç”Ÿç¯å¢ƒå¼€å‘äº†, æ‰€ä»¥æ²¡æœ‰ windows ç‰ˆæœ¬çš„æ•™ç¨‹, ä½†æ®Šé€”åŒå½’, å¤§ä½“è¿‡ç¨‹æ˜¯ä¸€æ ·çš„\nuv æ˜¯ä¸€ä¸ªç”¨ Rust ç¼–å†™çš„æé€Ÿ Python åŒ…ç®¡ç†å™¨, å¯æ›¿ä»£ pip, pip-tools, pipx, poetry, pyenv, virtualenv ç­‰å·¥å…·\n1 å®‰è£… uv å®˜æ–¹è„šæœ¬å®‰è£…\ncurl -LsSf https://astral.sh/uv/install.sh | sh pip å®‰è£…\npip install uv é…ç½® PyPI é•œåƒæº (åŠ é€Ÿç¬¬ä¸‰æ–¹åŒ…ä¸‹è½½)\nmkdir -p ~/.config/uv cat \u0026gt; ~/.config/uv/uv.toml \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; [[index]] url = \u0026#34;https://mirrors.aliyun.com/pypi/simple\u0026#34; default = true EOF 2 Python ç‰ˆæœ¬ç®¡ç† åˆ—å‡ºå¯å®‰è£…çš„ç‰ˆæœ¬\nuv python list å®‰è£…æŒ‡å®šç‰ˆæœ¬\nuv python install 3.12 uv python install 3.11.4 å¸è½½æŒ‡å®šç‰ˆæœ¬\nuv python uninstall 3.11 æŸ¥çœ‹å·²å®‰è£…ç‰ˆæœ¬\nuv python list --only-installed å›ºå®šé¡¹ç›® Python ç‰ˆæœ¬, ä¼šåˆ›å»º .python-version æ–‡ä»¶\nuv python pin 3.12 3 ç¬¬ä¸‰æ–¹æ¨¡å—ç®¡ç† 3.1 è™šæ‹Ÿç¯å¢ƒ åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ\nuv venv # é»˜è®¤ .venv uv venv --python 3.14.2 .venv # æŒ‡å®š python ç‰ˆæœ¬ æ¿€æ´»/é€€å‡ºè™šæ‹Ÿç¯å¢ƒ\nsource .venv/bin/activate # æ¿€æ´» deactivate # é€€å‡º 3.2 å®‰è£…æ¨¡å— ä½¿ç”¨ uv add é¡¹ç›®ä¾èµ–ç®¡ç†, uv add ä¼šåŒæ—¶æ›´æ–° pyproject.toml å’Œ uv.lock\nuv add requests # å®‰è£…å¹¶æ·»åŠ åˆ°ä¾èµ– uv add requests==2.28.0 # æŒ‡å®šç‰ˆæœ¬ uv add --dev pytest # æ·»åŠ å¼€å‘ä¾èµ– uv remove requests # ç§»é™¤ä¾èµ– ä¹Ÿå¯ä»¥ä½¿ç”¨ uv pip çš„æ–¹å¼, ä½†æ˜¯ä¸æ¨èåœ¨é¡¹ç›®ä¸­ä½¿ç”¨, éå¸¸ä¸ç›Šäºç®¡ç†\nä½¿ç”¨ uv pip (ç±»ä¼¼ä¼ ç»Ÿ pip), uv pip ä¸ä¼šå®‰è£…åˆ°ç³»ç»Ÿ Python, æŸ¥æ‰¾é¡ºåº: å·²æ¿€æ´»çš„è™šæ‹Ÿç¯å¢ƒ -\u0026gt; å½“å‰ç›®å½• .venv -\u0026gt; çˆ¶ç›®å½• .venv -\u0026gt; æŠ¥é”™\nuv pip install requests # å®‰è£… uv pip install requests==2.28.0 # å®‰è£…æŒ‡å®šç‰ˆæœ¬ uv pip install --upgrade requests # å‡çº§ uv pip uninstall requests # å¸è½½ 4 é¡¹ç›®ä¾èµ–ç®¡ç† 4.1 åˆå§‹åŒ–é¡¹ç›® uv init myproject # åˆ›å»ºæ–°é¡¹ç›® cd myproject ç”Ÿæˆçš„é¡¹ç›®ç»“æ„\nmyproject/ â”œâ”€â”€ .python-version # Python ç‰ˆæœ¬ â”œâ”€â”€ pyproject.toml # é¡¹ç›®é…ç½®å’Œä¾èµ–å£°æ˜ â”œâ”€â”€ README.md â””â”€â”€ src/ â””â”€â”€ myproject/ â””â”€â”€ __init__.py 4.2 æ ¸å¿ƒå‘½ä»¤ å‘½ä»¤ ä½œç”¨ uv add \u0026lt;pkg\u0026gt; æ·»åŠ ä¾èµ–åˆ° pyproject.toml å¹¶å®‰è£… uv remove \u0026lt;pkg\u0026gt; ç§»é™¤ä¾èµ– uv lock æ ¹æ® pyproject.toml ç”Ÿæˆ/æ›´æ–° uv.lock uv sync æ ¹æ® uv.lock åŒæ­¥å®‰è£…ä¾èµ–åˆ°è™šæ‹Ÿç¯å¢ƒ 4.3 uv lock è¯¦è§£ uv lock è§£æ pyproject.toml ä¸­å£°æ˜çš„ä¾èµ–, ç”Ÿæˆç²¾ç¡®çš„ uv.lock é”æ–‡ä»¶\nuv lock # ç”Ÿæˆ/æ›´æ–°é”æ–‡ä»¶ uv lock --upgrade # å‡çº§æ‰€æœ‰ä¾èµ–åˆ°æœ€æ–°ç‰ˆæœ¬ uv lock --upgrade-package requests # ä»…å‡çº§æŒ‡å®šåŒ… pyproject.toml: å£°æ˜ä¾èµ–èŒƒå›´, å¦‚ requests\u0026gt;=2.28 uv.lock: è®°å½•ç²¾ç¡®ç‰ˆæœ¬å’Œå“ˆå¸Œ, ç¡®ä¿å¯å¤ç°å®‰è£… 4.4 uv sync è¯¦è§£ uv sync æ ¹æ® uv.lock å°†ä¾èµ–ç²¾ç¡®å®‰è£…åˆ°è™šæ‹Ÿç¯å¢ƒ\nuv sync # åŒæ­¥æ‰€æœ‰ä¾èµ– uv sync --frozen # ä¸¥æ ¼æŒ‰ uv.lock å®‰è£…, ä¸æ›´æ–°é”æ–‡ä»¶ uv sync --no-dev # ä¸å®‰è£…å¼€å‘ä¾èµ– 5 å¸¸ç”¨å·¥ä½œæµ 5.1 æ–°é¡¹ç›® uv init myproject \u0026amp;\u0026amp; cd myproject uv add requests pandas uv run python main.py # ç›´æ¥è¿è¡Œ, è‡ªåŠ¨å¤„ç†è™šæ‹Ÿç¯å¢ƒ 5.2 å…‹éš†å·²æœ‰é¡¹ç›® git clone \u0026lt;repo\u0026gt; cd \u0026lt;repo\u0026gt; uv sync # æ ¹æ® uv.lock å®‰è£…ä¾èµ– uv sync ä¼šè‡ªåŠ¨è¯»å– .python-version, ä¸‹è½½å¯¹åº” Python ç‰ˆæœ¬ (å¦‚æœªå®‰è£…), åˆ›å»º .venv, å¹¶å®‰è£…ä¾èµ–, æ— éœ€æ‰‹åŠ¨æ“ä½œ\n5.3 æ›´æ–°ä¾èµ– uv lock --upgrade # æ›´æ–°æ‰€æœ‰ä¾èµ–ç‰ˆæœ¬ uv sync # åŒæ­¥åˆ°ç¯å¢ƒ 5.4 å·²æœ‰é¡¹ç›®è¿ç§»åˆ° uv ä» requirements.txt è¿ç§»\ncd existing-project uv init # åˆå§‹åŒ–, ç”Ÿæˆ pyproject.toml uv add -r requirements.txt # ä» requirements.txt å¯¼å…¥ä¾èµ– rm requirements.txt # å¯é€‰, åˆ é™¤æ—§æ–‡ä»¶ ä» pip/virtualenv è¿ç§»\ncd existing-project uv init uv venv # åˆ›å»ºæ–°çš„è™šæ‹Ÿç¯å¢ƒ uv add package1 package2 # æ‰‹åŠ¨æ·»åŠ ä¾èµ– ä» poetry è¿ç§» (å·²æœ‰ pyproject.toml)\ncd existing-project rm poetry.lock # åˆ é™¤ poetry é”æ–‡ä»¶ uv lock # ç”Ÿæˆ uv.lock uv sync # å®‰è£…ä¾èµ– ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/python-uv-manager/","summary":"0 å‰è¨€ æœ¬æ–‡åŸºäº linux ç¯å¢ƒæ‰€å†™, é‡‡ç”¨ win10 ä¸­çš„ wsl2, ç³»ç»Ÿç‰ˆæœ¬æ˜¯ ubuntu-20.04, å·²ç»å¾ˆå°‘ä½¿ç”¨ windows åŸç”Ÿç¯å¢ƒå¼€å‘äº†, æ‰€ä»¥æ²¡æœ‰ windows ç‰ˆæœ¬çš„æ•™ç¨‹, ä½†æ®Šé€”åŒå½’, å¤§ä½“è¿‡ç¨‹æ˜¯ä¸€æ ·çš„ uv æ˜¯ä¸€ä¸ªç”¨ Rust ç¼–å†™çš„æé€Ÿ Python åŒ…ç®¡ç†å™¨, å¯æ›¿ä»£ pip, pip-tools, pipx, poetry, pyenv, virtualenv ç­‰å·¥å…· 1 å®‰è£… uv å®˜æ–¹è„šæœ¬å®‰è£… curl -LsSf https://astral.sh/uv/install.sh | sh pip å®‰è£… pip install uv é…ç½® PyPI é•œåƒæº (åŠ é€Ÿç¬¬ä¸‰æ–¹åŒ…ä¸‹è½½) mkdir -p ~/.config/uv cat \u0026gt; ~/.config/uv/uv.toml \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; [[index]]","title":"python | ä½¿ç”¨ uv ç®¡ç†ä½ çš„ python ç¯å¢ƒ"},{"content":"0 å‰è¨€ Claude Code æ˜¯ Anthropic å®˜æ–¹æ¨å‡ºçš„ CLI å·¥å…·, å¯ä»¥åœ¨ç»ˆç«¯ä¸­ä¸ Claude è¿›è¡Œäº¤äº’, å®Œæˆä»£ç ç¼–å†™ã€æ–‡ä»¶æ“ä½œã€é—®é¢˜è§£ç­”ç­‰ä»»åŠ¡\n1 mcp å’Œ skill å®‰è£… claude /plugin marketplace add iamzhihuix/happy-claude-skills /plugin marketplace add anthropics/skills /plugin # å®‰è£… context7 frontend-design browser # å®‰è£… exa å’Œ augment-context-engine mcp 2 CLAUDE.md 2.1 åŠ è½½é¡ºåº 2.1.1 æ–‡ä»¶ä½ç½® çº§åˆ« è·¯å¾„ ç”¨é€” å…¨å±€ç”¨æˆ·çº§ ~/.claude/CLAUDE.md é€‚ç”¨äºæ‰€æœ‰é¡¹ç›®çš„ä¸ªäººåå¥½ é¡¹ç›®çº§ ./CLAUDE.md æˆ– ./.claude/CLAUDE.md å›¢é˜Ÿå…±äº«çš„é¡¹ç›®æŒ‡ä»¤ é¡¹ç›®æœ¬åœ°çº§ ./CLAUDE.local.md ä¸ªäººçš„é¡¹ç›®åå¥½ï¼ˆåº”åŠ å…¥ .gitignoreï¼‰ 2.1.2 åŠ è½½ä¼˜å…ˆçº§ ä¼˜å…ˆçº§ä»ä½åˆ°é«˜ï¼ˆååŠ è½½çš„ä¼šè¦†ç›–æˆ–è¡¥å……å…ˆåŠ è½½çš„ï¼‰ï¼š\nå…¨å±€ç”¨æˆ·çº§ â†’ é¡¹ç›®çº§ â†’ é¡¹ç›®æœ¬åœ°çº§ æ‰€æœ‰ CLAUDE.md æ–‡ä»¶æ˜¯å åŠ çš„ï¼Œå†²çªæ—¶ååŠ è½½çš„ä¼˜å…ˆã€‚\n2.1.3 ç›®å½•å±‚çº§æ”¯æŒ å‘ä¸Šé€’å½’æŸ¥æ‰¾\nä»å½“å‰å·¥ä½œç›®å½•å¼€å§‹é€’å½’å‘ä¸ŠæŸ¥æ‰¾ï¼Œè¯»å–æ²¿é€”å‘ç°çš„æ‰€æœ‰ CLAUDE.md æˆ– CLAUDE.local.mdã€‚\nç¤ºä¾‹ï¼šåœ¨ foo/bar/ ä¸‹è¿è¡Œæ—¶ï¼Œä¼šåŒæ—¶åŠ è½½ï¼š\nfoo/CLAUDE.md foo/bar/CLAUDE.md å­ç›®å½•æŒ‰éœ€åŠ è½½\nå­ç›®å½•ä¸­çš„ CLAUDE.md ä¸ä¼šåœ¨å¯åŠ¨æ—¶ç«‹å³åŠ è½½ï¼Œè€Œæ˜¯åœ¨è¯»å–æˆ–æ“ä½œè¯¥å­ç›®å½•ä¸‹çš„æ–‡ä»¶æ—¶æ‰çº³å…¥ä¸Šä¸‹æ–‡ã€‚\n2.1.4 å¸¸ç”¨æ“ä½œ æ“ä½œ è¯´æ˜ /init è‡ªåŠ¨ç”Ÿæˆ CLAUDE.md æ–‡ä»¶ /memory æŸ¥çœ‹å½“å‰åŠ è½½çš„å†…å­˜æ–‡ä»¶ 2.1.5 ä½¿ç”¨å»ºè®® åœºæ™¯ å»ºè®®å­˜æ”¾ä½ç½® ä¸ªäººä»£ç é£æ ¼åå¥½ ~/.claude/CLAUDE.md é¡¹ç›®æ¶æ„è¯´æ˜ã€ç¼–ç æ ‡å‡† ./CLAUDE.md (æäº¤åˆ° git) ä¸ªäººç§æœ‰é…ç½®ï¼ˆå¦‚æµ‹è¯• URLï¼‰ ./CLAUDE.local.md (åŠ å…¥ .gitignore) 2.2 é…ç½®ç¤ºä¾‹ # CLAUDE.md ## Defaults - Reply in **Chinese** unless I explicitly ask for English. - Always use **English punctuation** (e.g., `,` `.` `:` `;` `()` `\u0026#34;\u0026#34;`), even when writing Chinese text or generating files with Chinese content. - No emojis. - Do not truncate important outputs (logs, diffs, stack traces, commands, or critical reasoning that affects safety/correctness). ## Refactor policy (legacy code) - When existing code is a \u0026#34;big ball of mud\u0026#34; (hard to maintain, clearly bad design, full of hacks), prefer a **clean, full refactor** over stacking more patches on top of it. - A refactor may completely replace internal structure (functions, modules, classes, data flow). - By default, try to preserve externally observable behaviour. If you intentionally change behaviour or protocols, you MUST: - Call out clearly that this is a **behaviour/protocol change**. - Explain why the change is necessary and which code paths/consumers are affected. - Update or add tests to cover the new behaviour. ## Before touching code (mandatory) 1) Find reuse opportunities - Use semantic code search first via the Augment MCP server `augment-context-engine`, using its `codebase-retrieval` tool for repository/code search. - Confirm understanding with LSP: `goToDefinition`, `findReferences`. - Use Grep/Glob only for exact matches or filename patterns. 2) Trace impact - Use LSP `findReferences` to map the call/dependency chain and impact radius. 3) Run the \u0026#34;three questions\u0026#34; checklist (before implementation) - After research and impact analysis, but before changing code, always check: - Is this a real issue or just an assumption / over-design? - What existing code can be reused? - What might break, and who depends on this? - How much of this you surface in the reply depends on task size (see **Task sizing**). ## Red lines - No copy-paste duplication. - Do not break existing externally observable behaviour **unless**: - It is part of a deliberate refactor as described in the refactor policy, and - You clearly document the behavioural change and its impact. - Do not proceed with a known-wrong approach. - Critical paths must have explicit error handling. - Never implement \u0026#34;blindly\u0026#34;: always confirm understanding via code reading + references. ## Web research (no guessing) If something is unfamiliar or likely version-sensitive, you MUST search the web instead of guessing: - Use Exa: `mcp__exa__web_search_exa`. Source priority: 1) Official docs / API reference. 2) Official changelog / release notes. 3) Upstream GitHub repository docs (README, `/docs`). 4) Community posts only if necessary to fill gaps. Version rule: - When behaviour may differ across versions, first identify the project\u0026#39;s version (lockfile/config), then search docs specifically for that version. ## Task sizing - **Simple** - Criteria â€” single file, clear requirement, \u0026lt; 20 lines changed, clearly local impact. - Handling â€” after doing the \u0026#34;Before touching code\u0026#34; steps (research + impact analysis + internal three-question checklist), you may execute directly with minimal explanation. A very short context line is enough; a full breakdown of the checklist is not required. - **Medium** - Criteria â€” 2â€“5 files, or requires some research, or impact is not obviously local. - Handling â€” write a short plan (bullet points) â†’ then implement. - Briefly surface the three-question checklist result in the reply (1â€“3 short lines describing real issue vs assumption, key reuse, and main impact). - **Complex** - Criteria â€” architecture changes, multiple modules, high uncertainty or risk. - Handling â€” follow this workflow: 1) **RESEARCH**: inspect code and facts only (no proposals yet). 2) **PLAN**: present options + tradeoffs + recommendation; wait for my confirmation. 3) **EXECUTE**: implement exactly the approved plan. 4) **REVIEW**: self-check (tests, edge cases, cleanup). - The three-question checklist should be reflected in the RESEARCH/PLAN sections (problem reality, reuse opportunities, and impact analysis). ## Tool selection - Semantic code search \u0026amp; understanding: MCP server `augment-context-engine`, tool `codebase-retrieval`. - Definitions/references/impact: LSP (`goToDefinition`, `findReferences`). - Exact string/regex search: Grep. - Filename patterns: Glob. - Docs \u0026amp; open-source lookup: `mcp__exa__web_search_exa`. ## Git - Do not commit unless I explicitly ask. - Do not push unless I explicitly ask. - Before writing a commit message, glance at a few recent commits and match the repo\u0026#39;s style: - `git log -n 5 --oneline` - If there is no obvious existing style, use this default format: - `\u0026lt;type\u0026gt;(\u0026lt;scope\u0026gt;): \u0026lt;description\u0026gt;` - Before any commit: run `git diff` and confirm the exact scope of changes. - Never force-push to `main` / `master`. - Do not add attribution lines in commit messages. ## Security - Never hardcode secrets (keys/passwords/tokens). - Never commit `.env` files or any credentials. - Validate user input at trust boundaries (APIs, CLIs, external data sources). ## Quality \u0026amp; cleanup - Prefer clarity and simplicity first (KISS); apply DRY to remove obvious copy-paste duplication when it does not hurt readability. - If you change a function signature, update **all** call sites. - After changes: - Remove temporary files. - Remove dead/commented-out code. - Remove unused imports. - Remove debug logging that is no longer needed. - Run the smallest meaningful verification (lint/test/build) for the parts you touched. ## Python environment Always use **uv** for Python environment and package management. Never use raw `pip`, `python -m venv`, or `virtualenv`. Virtual environment priority (highest to lowest): 1) **Project-level**: If inside a project directory, use `uv init` to create `.venv` in project root. All dependencies install here. 2) **User-level**: If outside any project but need persistent Python, use `~/.venv`: ```bash uv venv ~/.venv source ~/.venv/bin/activate ``` 3) **Temporary**: If a throwaway environment is acceptable, create in `/tmp`: ```bash uv venv /tmp/.venv-$(date +%s) ``` Common commands: - Create project: `uv init` - Add dependency: `uv add \u0026lt;package\u0026gt;` - Run script: `uv run python script.py` - Sync deps: `uv sync` ## Node.js environment Always use **pnpm** for package management. Avoid npm/yarn unless explicitly required by the project. Environment priority (highest to lowest): 1) **Project-level**: If inside a project with `package.json`, install locally: ```bash pnpm install ``` 2) **User-level global**: For CLI tools needed across projects: ```bash pnpm add -g \u0026lt;package\u0026gt; ``` 3) **Temporary execution**: For one-off scripts without polluting global: ```bash pnpm dlx \u0026lt;package\u0026gt; # like npx but uses pnpm cache ``` Version management: - Use **nvm** for Node.js version switching. - Respect `.nvmrc` or `.node-version` if present in project. ## Shell / Platform Auto-detect the runtime environment and adapt accordingly: **Detection order:** 1) Check if running inside WSL: `grep -qi microsoft /proc/version` 2) Check if native Linux: `uname -s` returns `Linux` without WSL markers 3) Check if macOS: `uname -s` returns `Darwin` 4) Check if Windows (PowerShell/cmd): `$env:OS` or `%OS%` equals `Windows_NT` **Default assumption:** If detection is unclear or fails, assume **WSL2 on Windows**. **Platform-specific rules:** | Platform | Shell syntax | Command chaining | Path format | |----------|--------------|------------------|-------------| | WSL2 / Linux / macOS | Bash/Zsh | `\u0026amp;\u0026amp;` or `;` | `/path/to/file` | | Windows PowerShell | PowerShell | `;` (no `\u0026amp;\u0026amp;`) | `C:\\path\\to\\file` | | Windows cmd | cmd | `\u0026amp;\u0026amp;` or `\u0026amp;` | `C:\\path\\to\\file` | **Cross-platform notes:** - In WSL2, access Windows paths via `/mnt/c/...` - Quote paths containing spaces or non-ASCII characters on all platforms. - When calling Windows executables from WSL2, use full path: `/mnt/c/Windows/System32/...` 3 ä¿®å¤ wsl2 è¿è¡Œå¡é¡¿çš„é—®é¢˜ å‚è€ƒåŸæ–‡é“¾æ¥\nåŸå› æ˜¯å› ä¸º WSL2 ä¼šå°† Windows çš„ Path è¿½åŠ åˆ° Linux çš„ $PATHï¼Œä½¿ Linux ç»ˆç«¯å¯ç›´æ¥è¿è¡Œ powershell.exe ç­‰ Windows ç¨‹åºã€‚è€Œ Claude Code ä¼šæ£€æµ‹ $PATHï¼Œå‘ç° powershell.exe åï¼Œä¼šåå¤è°ƒç”¨å®ƒè·å– Windows ç”¨æˆ·ç›®å½•ã€‚ä½† WSL2 ä¸­ä» Linux å¯åŠ¨ Windows ç¨‹åºå»¶è¿Ÿé«˜ï¼Œå¯¼è‡´æ¯æ¬¡æŒ‰é”®éƒ½éœ€ç­‰å¾…è¯¥è°ƒç”¨ï¼Œå¼•å‘å‘¨æœŸæ€§å¡é¡¿ã€‚\nè§£å†³åŠæ³•, ç›´æ¥å¤åˆ¶ä¸‹é¢çš„ä»£ç å—åˆ° wsl2 ä¸­æ‰§è¡Œå³å¯\n# è®¾ç½®å·¥ä½œç›®å½•ï¼ˆå¯é€‰ï¼Œé»˜è®¤ ~/binï¼‰ # export CLAUDE_FIX_DIR=~/bin ( TOOL_DIR=\u0026#34;${CLAUDE_FIX_DIR:-$HOME/bin}\u0026#34; TOOL_PATH=\u0026#34;$TOOL_DIR/powershell.exe\u0026#34; # åˆ›å»ºç›®å½• mkdir -p \u0026#34;$TOOL_DIR\u0026#34; # åˆ›å»ºåŒ…è£…è„šæœ¬ cat \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; \u0026gt; \u0026#34;$TOOL_PATH\u0026#34; #!/bin/bash if [[ \u0026#34;$1\u0026#34; == \u0026#34;-Command\u0026#34; \u0026amp;\u0026amp; \u0026#34;$2\u0026#34; == \u0026#34;\\$env:USERPROFILE\u0026#34; ]]; then echo \u0026#34;C:\\\\Users\\\\Administrator\u0026#34; else /mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe \u0026#34;$@\u0026#34; fi EOF chmod +x \u0026#34;$TOOL_PATH\u0026#34; # ç¡®å®š shell é…ç½®æ–‡ä»¶ if [[ \u0026#34;$SHELL\u0026#34; == */zsh ]]; then CONFIG_FILE=\u0026#34;$HOME/.zshrc\u0026#34; elif [[ \u0026#34;$SHELL\u0026#34; == */bash ]]; then CONFIG_FILE=\u0026#34;$HOME/.bashrc\u0026#34; else echo \u0026#34;æœªçŸ¥çš„ shell: $SHELLï¼Œè¯·æ‰‹åŠ¨æ·»åŠ  PATH\u0026#34; exit 1 fi # å¹‚ç­‰æ€§æ£€æŸ¥ï¼šä»…åœ¨æœªæ·»åŠ æ—¶æ’å…¥ EXPORT_LINE=\u0026#34;export PATH=\\\u0026#34;$TOOL_DIR:\\$PATH\\\u0026#34;\u0026#34; if ! grep -qF \u0026#34;$TOOL_DIR\u0026#34; \u0026#34;$CONFIG_FILE\u0026#34; 2\u0026gt;/dev/null; then echo \u0026#34;\u0026#34; \u0026gt;\u0026gt; \u0026#34;$CONFIG_FILE\u0026#34; echo \u0026#34;# Claude Code WSL2 fix\u0026#34; \u0026gt;\u0026gt; \u0026#34;$CONFIG_FILE\u0026#34; echo \u0026#34;$EXPORT_LINE\u0026#34; \u0026gt;\u0026gt; \u0026#34;$CONFIG_FILE\u0026#34; echo \u0026#34;å·²æ·»åŠ  PATH åˆ° $CONFIG_FILE\u0026#34; else echo \u0026#34;PATH å·²å­˜åœ¨äº $CONFIG_FILEï¼Œè·³è¿‡\u0026#34; fi echo \u0026#34;\u0026#34; echo \u0026#34;ä¿®å¤å®Œæˆï¼è¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä½¿é…ç½®ç”Ÿæ•ˆï¼š\u0026#34; echo \u0026#34; source $CONFIG_FILE\u0026#34; ) ","permalink":"https://www.lvbibir.cn/posts/tech/claude-code-cli/","summary":"0 å‰è¨€ Claude Code æ˜¯ Anthropic å®˜æ–¹æ¨å‡ºçš„ CLI å·¥å…·, å¯ä»¥åœ¨ç»ˆç«¯ä¸­ä¸ Claude è¿›è¡Œäº¤äº’, å®Œæˆä»£ç ç¼–å†™ã€æ–‡ä»¶æ“ä½œã€é—®é¢˜è§£ç­”ç­‰ä»»åŠ¡ 1 mcp å’Œ skill å®‰è£… claude /plugin marketplace add iamzhihuix/happy-claude-skills /plugin marketplace add anthropics/skills /plugin # å®‰è£… context7 frontend-design browser # å®‰è£… exa å’Œ augment-context-engine mcp 2 CLAUDE.md 2.1 åŠ è½½é¡ºåº 2.1.1 æ–‡ä»¶ä½ç½® çº§åˆ« è·¯å¾„ ç”¨é€” å…¨å±€ç”¨æˆ·çº§ ~/.claude/CLAUDE.md é€‚ç”¨äºæ‰€æœ‰é¡¹ç›®çš„ä¸ªäººåå¥½ é¡¹ç›®çº§ ./CLAUDE.md æˆ– ./.claude/CLAUDE.md å›¢é˜Ÿå…±äº«çš„é¡¹ç›®æŒ‡ä»¤ é¡¹ç›®æœ¬åœ°çº§ ./CLAUDE.local.md ä¸ªäººçš„é¡¹ç›®å","title":"Claude Code é£Ÿç”¨æŒ‡å—"},{"content":"0 å‰è¨€ mihomo (åŸ Clash.Meta) æ˜¯ä¸€ä¸ªåŸºäº Go è¯­è¨€å¼€å‘çš„é«˜æ€§èƒ½ä»£ç†å†…æ ¸, æ”¯æŒå¤šç§ä»£ç†åè®®. ç›¸æ¯”äºä½¿ç”¨ Clash Verge, Clash for Windows ç­‰ GUI å®¢æˆ·ç«¯, ç›´æ¥ä½¿ç”¨ mihomo å†…æ ¸æœ‰ä»¥ä¸‹ä¼˜åŠ¿:\nè½»é‡é«˜æ•ˆ: æ— éœ€è¿è¡Œ Electron ç­‰é‡é‡çº§æ¡†æ¶, å†…å­˜å ç”¨æ›´ä½ å¯åŠ¨æ›´å¿«: çº¯å†…æ ¸å¯åŠ¨é€Ÿåº¦è¿œå¿«äº GUI å®¢æˆ·ç«¯ çµæ´»å¯æ§: é€šè¿‡è„šæœ¬ç®¡ç†, å¯ä»¥æ›´çµæ´»åœ°æ§åˆ¶å¯åœå’Œé…ç½® ç¨³å®šæ€§å¥½: å‡å°‘äº† GUI å±‚é¢å¯èƒ½å¸¦æ¥çš„é—®é¢˜ æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•åœ¨ Windows ç³»ç»Ÿä¸Šç‹¬ç«‹éƒ¨ç½² mihomo å†…æ ¸, å¹¶é€šè¿‡ PowerShell è„šæœ¬è¿›è¡Œç®¡ç†.\n1 ä¸‹è½½ mihomo å†…æ ¸ å‰å¾€ mihomo releases é¡µé¢ä¸‹è½½æœ€æ–°ç‰ˆæœ¬.\næ ¹æ®ä½ çš„ç³»ç»Ÿæ¶æ„é€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬, windows ä¸€èˆ¬é€‰æ‹© mihomo-windows-amd64-\u0026lt;version\u0026gt;.zip å³å¯\nä¸‹è½½åè§£å‹åˆ°ä½ å–œæ¬¢çš„ç›®å½•, ä¾‹å¦‚: D:\\software\\1-portable\\mihomo\\\nè§£å‹åç›®å½•ç»“æ„å¦‚ä¸‹:\nmihomo/ â”œâ”€â”€ mihomo-windows-amd64.exe # mihomo å†…æ ¸ä¸»ç¨‹åº â”œâ”€â”€ mihomo.yaml # é…ç½®æ–‡ä»¶ (éœ€è‡ªè¡Œåˆ›å»º) â””â”€â”€ mihomo-manager.ps1 # ç®¡ç†è„šæœ¬ (éœ€è‡ªè¡Œåˆ›å»º) 2 é…ç½®æ–‡ä»¶ åœ¨ mihomo ç›®å½•ä¸‹æ–°å»º mihomo.yaml é…ç½®æ–‡ä»¶.\nå¯å‚è€ƒ æˆ‘çš„é…ç½®, æ ¹æ®ä½ çš„å®é™…éœ€æ±‚è¿›è¡Œä¿®æ”¹.\n3 ç®¡ç†è„šæœ¬ 3.1 åˆ›å»ºç®¡ç†è„šæœ¬ åœ¨ mihomo ç›®å½•ä¸‹æ–°å»º mihomo-manager.ps1 è„šæœ¬æ–‡ä»¶.\nå¯å‚è€ƒ æˆ‘çš„è„šæœ¬\n3.2 é…ç½® PowerShell æ‰§è¡Œç­–ç•¥ PowerShell è„šæœ¬é»˜è®¤æ— æ³•ç›´æ¥è¿è¡Œ, éœ€è¦ä¿®æ”¹æ‰§è¡Œç­–ç•¥.\nä»¥ç®¡ç†å‘˜èº«ä»½æ‰“å¼€ PowerShell, æ‰§è¡Œ:\nSet-ExecutionPolicy RemoteSigned æ‰§è¡Œç­–ç•¥è¯´æ˜:\nRestricted: é»˜è®¤ç­–ç•¥, ä¸å…è®¸è¿è¡Œä»»ä½•è„šæœ¬ RemoteSigned: æœ¬åœ°è„šæœ¬å¯ä»¥è¿è¡Œ, ä»ç½‘ç»œä¸‹è½½çš„è„šæœ¬éœ€è¦æ•°å­—ç­¾å Unrestricted: å…è®¸è¿è¡Œæ‰€æœ‰è„šæœ¬ (ä¸æ¨è) 3.3 è®¾ç½®è„šæœ¬æ‰“å¼€æ–¹å¼ ä¸ºäº†æ–¹ä¾¿åŒå‡»è¿è¡Œè„šæœ¬æˆ–é€šè¿‡ utools ç­‰å·¥å…·å¿«æ·è°ƒç”¨:\nå³é”®ç‚¹å‡» mihomo-manager.ps1 æ–‡ä»¶ é€‰æ‹© \u0026quot; æ‰“å¼€æ–¹å¼ \u0026quot; -\u0026gt; \u0026quot; é€‰æ‹©å…¶ä»–åº”ç”¨ \u0026quot; æ‰¾åˆ° PowerShell å¹¶é€‰æ‹© å‹¾é€‰ \u0026quot; å§‹ç»ˆä½¿ç”¨æ­¤åº”ç”¨æ‰“å¼€ .ps1 æ–‡ä»¶ \u0026quot; 3.4 ä½¿ç”¨ç®¡ç†è„šæœ¬ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿è¡Œè„šæœ¬:\næ–¹å¼ä¸€: åŒå‡»è¿è¡Œ\nç›´æ¥åŒå‡» mihomo-manager.ps1 æ–‡ä»¶, ä¼šå¼¹å‡ºäº¤äº’å¼èœå•.\næ–¹å¼äºŒ: å‘½ä»¤è¡Œè¿è¡Œ\nåœ¨ PowerShell ä¸­æ‰§è¡Œ:\n.\\mihomo-manager.ps1 start # å¯åŠ¨ mihomo .\\mihomo-manager.ps1 stop # åœæ­¢ mihomo .\\mihomo-manager.ps1 restart # é‡å¯ mihomo .\\mihomo-manager.ps1 status # æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ .\\mihomo-manager.ps1 reload # é‡è½½é…ç½®æ–‡ä»¶ .\\mihomo-manager.ps1 help # æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯ 4 Web UI ç®¡ç† å¯åŠ¨ mihomo å, å¦‚æœæŒ‰ç…§æˆ‘çš„é…ç½®åº”è¯¥å·²ç»è‡ªåŠ¨ä¸‹è½½å¥½äº† webui, ç›´æ¥è®¿é—®ä¸‹é¢çš„åœ°å€å°±å¯ä»¥è®¿é—®äº†, å¦‚æœæ²¡æœ‰æ­£å¸¸ä¸‹è½½è¯·æ‰‹åŠ¨ä¸‹è½½åè§£å‹åˆ° mihomo çš„ ui ç›®å½•.\nè®¿é—®åœ°å€: http://127.0.0.1:9090/ui/zashboard/#/setup\n5 å¼€æœºè‡ªå¯åŠ¨ 5.1 ä½¿ç”¨ EarlyStart (æ¨è) å¦‚æœä½ éœ€è¦ mihomo åœ¨ç³»ç»Ÿå¯åŠ¨æ—©æœŸå°±è¿è¡Œ (ä¾‹å¦‚ OneDrive ç­‰è½¯ä»¶ä¾èµ–ä»£ç†), æ¨èä½¿ç”¨ EarlyStart.\nè¯¦ç»†é…ç½®æ–¹æ³•å¯å‚è€ƒæˆ‘çš„è¿™ç¯‡åšå®¢: windows | è‡ªå®šä¹‰å¼€æœºå¿«é€Ÿå¯åŠ¨é¡¹\nåœ¨ %USERPROFILE%\\.earlystart æ–‡ä»¶ä¸­æ·»åŠ :\n\u0026#34;C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\u0026#34; -ExecutionPolicy Bypass -NoProfile -WindowStyle Hidden -File \u0026#34;D:\\software\\1-portable\\mihomo\\mihomo-manager.ps1\u0026#34; start 5.2 ä½¿ç”¨ä»»åŠ¡è®¡åˆ’ç¨‹åº æ‰“å¼€ \u0026quot; ä»»åŠ¡è®¡åˆ’ç¨‹åº \u0026quot; åˆ›å»ºåŸºæœ¬ä»»åŠ¡ è§¦å‘å™¨é€‰æ‹© \u0026quot; è®¡ç®—æœºå¯åŠ¨æ—¶ \u0026quot; æ“ä½œé€‰æ‹© \u0026quot; å¯åŠ¨ç¨‹åº \u0026quot; ç¨‹åºå¡«å†™: powershell.exe å‚æ•°å¡«å†™: -ExecutionPolicy Bypass -NoProfile -WindowStyle Hidden -File \u0026quot;D:\\software\\1-portable\\mihomo\\mihomo-manager.ps1\u0026quot; start 5.3 æ³¨å†Œä¸ºç³»ç»ŸæœåŠ¡ å¦‚æœéœ€è¦æ›´ç¨³å®šçš„åå°è¿è¡Œæ–¹å¼, å¯ä»¥ä½¿ç”¨ NSSM å°† mihomo æ³¨å†Œä¸º Windows æœåŠ¡.\n# ä¸‹è½½ nssm åæ‰§è¡Œ nssm install mihomo \u0026#34;D:\\software\\1-portable\\mihomo\\mihomo-windows-amd64.exe\u0026#34; nssm set mihomo AppDirectory \u0026#34;D:\\software\\1-portable\\mihomo\u0026#34; nssm set mihomo AppParameters \u0026#34;-d .\u0026#34; nssm start mihomo 6 æ€»ç»“ é€šè¿‡ä»¥ä¸Šæ­¥éª¤, ä½ å·²ç»æˆåŠŸåœ¨ Windows ä¸Šéƒ¨ç½²äº† mihomo å†…æ ¸. ç›¸æ¯” GUI å®¢æˆ·ç«¯, è¿™ç§æ–¹å¼æ›´åŠ è½»é‡å’Œçµæ´», é€‚åˆè¿½æ±‚ç®€æ´é«˜æ•ˆçš„ç”¨æˆ·.\nç›¸å…³é“¾æ¥:\nmihomo å®˜æ–¹ä»“åº“ mihomo å®˜æ–¹æ–‡æ¡£ æˆ‘çš„é…ç½®æ–‡ä»¶ ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/mihomo-core-only-setup/","summary":"0 å‰è¨€ mihomo (åŸ Clash.Meta) æ˜¯ä¸€ä¸ªåŸºäº Go è¯­è¨€å¼€å‘çš„é«˜æ€§èƒ½ä»£ç†å†…æ ¸, æ”¯æŒå¤šç§ä»£ç†åè®®. ç›¸æ¯”äºä½¿ç”¨ Clash Verge, Clash for Windows ç­‰ GUI å®¢æˆ·ç«¯, ç›´æ¥ä½¿ç”¨ mihomo å†…æ ¸æœ‰ä»¥ä¸‹ä¼˜åŠ¿: è½»é‡é«˜æ•ˆ: æ— éœ€è¿è¡Œ Electron ç­‰é‡é‡çº§æ¡†æ¶, å†…å­˜å ç”¨æ›´ä½ å¯åŠ¨æ›´å¿«: çº¯å†…æ ¸å¯åŠ¨é€Ÿåº¦è¿œå¿«äº GUI å®¢æˆ·ç«¯ çµæ´»å¯æ§: é€šè¿‡è„šæœ¬ç®¡ç†, å¯ä»¥æ›´çµæ´»åœ°æ§åˆ¶å¯åœå’Œé…ç½® ç¨³å®šæ€§å¥½: å‡å°‘äº† GUI","title":"windows | mihomo å†…æ ¸ç‹¬ç«‹éƒ¨ç½²æŒ‡å—"},{"content":"0 åŸç›˜æ‰©å®¹ é€‚ç”¨äºç£ç›˜æœªåˆ†åŒºæˆ–è€…æ ‡å‡†åˆ†åŒºåç›´æ¥æŒ‚è½½åˆ°ç³»ç»Ÿç›®å½•, åç»­é€šè¿‡äº‘å¹³å°ç­‰æ–¹å¼æ‰©å®¹ç£ç›˜åéœ€è¦åœ¨ç³»ç»Ÿå†…æ›´æ–°å®¹é‡çš„åœºæ™¯\nyum install -y cloud-utils-growpart # 1 ä»£è¡¨åˆ†åŒºå·, å¦‚æœæ˜¯æ•´ä¸ªç›˜æ ¼å¼åŒ–è¿›è¡ŒæŒ‚è½½åˆ™å¯ä»¥ç›´æ¥å°è¯• resize2fs æˆ–è€… xfs_growfs growpart /dev/vdb 1 resize2fs /dev/vdb xfs_growfs /dev/vdb 1 lvm åŸç›˜æ‰©å®¹ ä¸åŸç›˜æ‰©å®¹ç±»ä¼¼, éœ€è¦åœ¨ lvm ä¸­å¯¹ pv è¿›è¡Œå®¹é‡æ›´æ–°\nyum install -y cloud-utils-growpart # 1 ä»£è¡¨åˆ†åŒºå·, å¦‚æœæ•´ç›˜ä½œä¸º pv, ç›´æ¥è·³è¿‡æ­¤æ­¥éª¤å³å¯ growpart /dev/vdb 1 pvresize /dev/vdb1 vgdisplay lvextend -l +100%FREE /dev/mapper/vg_home-lv_home lvextend -L +100G /dev/mapper/vg_home-lv_home # ext4 resize2fs /dev/mapper/vg_home-lv_home # xfs xfs_growfs /dev/mapper/vg_home-lv_home 2 lvm æ–°åŠ ç›˜æ‰©å®¹ æœ€å¸¸è§ä¹Ÿæ˜¯æœ€åˆç†çš„æ‰©å®¹æ–¹å¼\npvcreate /dev/vdc1 vgextend vg_home /dev/vdc1 lvextend -l +100%FREE /dev/mapper/vg_home-lv_home lvextend -L +100G /dev/mapper/vg_home-lv_home # ext4 resize2fs /dev/mapper/vg_home-lv_home # xfs xfs_growfs /dev/mapper/vg_home-lv_home 3 å¸¸è§é—®é¢˜ partprobe å¦‚æœé‡åˆ°æŠ¥é”™ Error: The backup GPT table is not at the end of the disk å‚è€ƒ\numount æ— æ³•å¸è½½\numount /data lsof +D /data ps -elf | grep -v grep | grep \u0026#34; /data\u0026#34; # å¦‚æœæ— è¿›ç¨‹å ç”¨ä» busy çŠ¶æ€åˆ™æŸ¥çœ‹æ˜¯å¦æœ‰ nfs è¿›ç¨‹ umount /data lvm å‘½ä»¤å¡æ­», æœ‰å¦‚ä¸‹è¾“å‡º, åˆ é™¤ /run/lock/lvm/ ä¸‹çš„æ–‡ä»¶å³å¯, å‚è€ƒ\nGiving up waiting for lock. Can\u0026#39;t get lock for vg_home Cannot process volume group vg_home ä»¥ä¸Š.\n","permalink":"https://www.lvbibir.cn/posts/tech/linux-expand-disk/","summary":"0 åŸç›˜æ‰©å®¹ é€‚ç”¨äºç£ç›˜æœªåˆ†åŒºæˆ–è€…æ ‡å‡†åˆ†åŒºåç›´æ¥æŒ‚è½½åˆ°ç³»ç»Ÿç›®å½•, åç»­é€šè¿‡äº‘å¹³å°ç­‰æ–¹å¼æ‰©å®¹ç£ç›˜åéœ€è¦åœ¨ç³»ç»Ÿå†…æ›´æ–°å®¹é‡çš„åœºæ™¯ yum install -y cloud-utils-growpart # 1 ä»£è¡¨åˆ†åŒºå·, å¦‚æœæ˜¯æ•´ä¸ªç›˜æ ¼å¼åŒ–è¿›è¡ŒæŒ‚è½½åˆ™å¯ä»¥ç›´æ¥å°è¯• resize2fs æˆ–è€… xfs_growfs growpart /dev/vdb 1 resize2fs /dev/vdb xfs_growfs /dev/vdb 1 lvm åŸç›˜æ‰©å®¹ ä¸åŸç›˜æ‰©å®¹ç±»ä¼¼, éœ€è¦åœ¨ lvm ä¸­å¯¹ pv è¿›è¡Œå®¹é‡æ›´æ–° yum install -y cloud-utils-growpart # 1 ä»£è¡¨åˆ†åŒºå·,","title":"linux | ç£ç›˜æ‰©å®¹"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒ\nwsl è¿è¡Œä¸€æ®µæ—¶é—´å, windows ç³»ç»Ÿä¸­çš„è™šæ‹Ÿç£ç›˜æ–‡ä»¶å ç”¨ç©ºé—´è¶Šæ¥è¶Šå¤§, åœ¨ wsl ä¸­åˆ é™¤æ–‡ä»¶ä¹Ÿæ— æ³•é‡Šæ”¾è¿™éƒ¨åˆ†ç©ºé—´\n1 é‡Šæ”¾ç©ºé—´ é¦–å…ˆæœ€é‡è¦æ˜¯åœ¨ wsl å…ˆæ¸…ç†è‡ªå·±ä¸éœ€è¦çš„å¤§æ–‡ä»¶, å¯ä»¥åœ¨ wsl ä¸­æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶æˆ–è€…ç›®å½•çš„å ç”¨ç©ºé—´, ç„¶åä¸€å±‚å±‚æ’æŸ¥\nsudo su - cd / for i in $(ls | grep -v mnt); do du -sh $i; done åˆ é™¤å®Œ wsl ä¸­çš„å¤§æ–‡ä»¶å, åœ¨ powershell ä¸­æ‰§è¡Œ wsl --shutdown å…³é—­ wsl\nä¸‹ä¸€æ­¥æ˜¯æ‰¾åˆ° wsl è™šæ‹Ÿç£ç›˜æ–‡ä»¶çš„ä½ç½®, å¦‚æœæ˜¯æŒ‰ç…§åšä¸»ä¹‹å‰çš„ æ–‡ç«  æ“ä½œå®‰è£… wsl çš„æœ‹å‹, è™šæ‹Ÿç£ç›˜ä½ç½®åœ¨ D:\\ubuntu\\ext4.vhdx\nå¦‚æœæ˜¯é»˜è®¤å®‰è£…çš„è¯, ç£ç›˜æ–‡ä»¶ä½ç½®å¤§æ¦‚åœ¨ C:\\Windows\\User\\\u0026lt;username\u0026gt;\\AppData\\Local\\Packages\\***Ubuntu***\\LocalState\\ ç›®å½•ä¸‹\nä¹‹ååœ¨ powershell ä¸­æ‰§è¡Œå¦‚ä¸‹æ“ä½œå³å¯å‹ç¼©ç£ç›˜ç©ºé—´\ndiskpart select vdisk file=\u0026#39;D:\\ubuntu\\ext4.vhdx\u0026#39; attach vdisk readonly compact vdisk detach vdisk exit åº”è¿è¡ŒæˆåŠŸ, åšä¸»æˆåŠŸé‡Šæ”¾ 100G ç©ºé—´.\nä»¥ä¸Š.\n","permalink":"https://www.lvbibir.cn/posts/tech/windows-wsl-7-free-up-disk-space/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒ wsl è¿è¡Œä¸€æ®µæ—¶é—´å, windows ç³»ç»Ÿä¸­çš„è™šæ‹Ÿç£ç›˜æ–‡ä»¶å ç”¨ç©ºé—´è¶Šæ¥è¶Šå¤§, åœ¨ wsl ä¸­åˆ é™¤æ–‡ä»¶ä¹Ÿæ— æ³•é‡Šæ”¾è¿™éƒ¨åˆ†ç©ºé—´ 1 é‡Šæ”¾ç©ºé—´ é¦–å…ˆæœ€é‡è¦æ˜¯åœ¨ wsl å…ˆæ¸…ç†è‡ªå·±ä¸éœ€è¦çš„å¤§æ–‡ä»¶, å¯ä»¥åœ¨ wsl ä¸­æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶æˆ–è€…ç›®å½•çš„å ç”¨ç©ºé—´, ç„¶åä¸€å±‚å±‚æ’æŸ¥ sudo su - cd / for i in $(ls | grep -v mnt); do du -sh $i; done åˆ é™¤å®Œ wsl","title":"wsl | é‡Šæ”¾é•¿ä¹…è¿è¡Œå ç”¨çš„ç£ç›˜ç©ºé—´"},{"content":"0 å‰è¨€ å‰æ®µæ—¶é—´åº”ä¸šåŠ¡éœ€æ±‚, åœ¨ suse12sp5 ç³»ç»Ÿä¸Šéƒ¨ç½²äº†ä¸€å¥— Mysql 8 æ•°æ®åº“, åˆšå¼€å§‹è¿è¡Œè‰¯å¥½, éšç€ä¾èµ–æ­¤æ•°æ®åº“çš„åŠŸèƒ½è¶Šæ¥è¶Šå¤š, å¼€å‘åŒäº‹ååº”åœ¨åº”ç”¨è¿æ¥æ•°æ®åº“æ—¶é¢‘ç¹æŠ¥é”™:\n[HY000][1135] null, message from server: \u0026#34;Can\u0026#39;t create a new thread (errno 11); if you are not out of available memory, you can consult the manual for a possible OS-dependent bug\u0026#34; åœ¨æ•°æ®åº“æœåŠ¡å™¨ä½¿ç”¨ root è´¦æˆ·ç™»é™†æŠ¥ç›¸åŒé”™è¯¯, åŒæ—¶åœ¨ mysql é”™è¯¯æ—¥å¿—æœ‰å¤§é‡ innodb æ— æ³•åˆ›å»ºæ‰«æçº¿ç¨‹çš„æŠ¥é”™\n2025-04-21T22:10:29.220410+08:00 381 [Warning] [MY-013526] [InnoDB] Resource not available to create threads for parallel scan. Falling back to single thread mode. 1 æ’æŸ¥è¿‡ç¨‹ å¯ä»¥çœ‹åˆ°æŠ¥é”™ä¸­æ˜ç¡®æŒ‡å‡ºäº†å¯èƒ½æ˜¯ç”±äºå†…å­˜ä¸è¶³, é‚æ’æŸ¥æœåŠ¡å™¨å†…å­˜å ç”¨æƒ…å†µ, ä½†æ˜¯æœåŠ¡å™¨å†…å­˜å‹åŠ›å¾ˆå°, ä¸å­˜åœ¨ oom çš„é—®é¢˜\nmysql è¿™ç±»èµ„æºé—®é¢˜å¤§å¤šæ˜¯å› ä¸º max_connections çš„å‚æ•°é…ç½®è¿‡å°, è¯·å¼€å‘äººå‘˜å…³åœä¸€éƒ¨åˆ†æœåŠ¡é‡Šæ”¾çº¿ç¨‹æˆ‘ä»¬ç™»é™† Mysql è¿›è¡Œæ’æŸ¥\nSHOW VARIABLES LIKE \u0026#39;max_connections\u0026#39;; ---3000 åˆå§‹é…ç½®å·²ç»æ¯”è¾ƒåˆç†, è¯¥å‚æ•°é…ç½®ä¸º 3000\nç»§ç»­å‘ä¸‹æ’æŸ¥, åœ¨æŸ¥é˜…ç›¸å…³èµ„æ–™çš„æ—¶å€™å‘ç°äº† è¿™ç¯‡æ–‡ç« , Max_used_connections è¾¾åˆ° max_connections æ•°å€¼çš„ 10% - 85% æ¯”è¾ƒåˆç†\nSHOW STATUS LIKE \u0026#39;Threads_connected\u0026#39;; --- ç›®å‰å·²è¿æ¥çš„çº¿ç¨‹ SHOW STATUS LIKE \u0026#39;Max_used_connections\u0026#39;; --- å¯åŠ¨ä»¥æ¥ä½¿ç”¨çš„æœ€å¤§é“¾æ¥æ•° SHOW VARIABLES LIKE \u0026#39;max_connections\u0026#39;; --- é“¾æ¥æ•°ä¸Šé™ --- ä¸‰ä¸ªå€¼åˆ†åˆ«ä¸º 472 473 3000 mysql é“¾æ¥æ•°æ˜¯å®Œå…¨å¤Ÿç”¨çš„, é‚£å¯èƒ½æ˜¯ä¼˜åŒ–æ²¡æœ‰åšå¥½å¯¼è‡´ mysql æ— æ³•æ”¯æŒæ›´å¤šè¿æ¥, é‚è¿›è¡Œå¦‚ä¸‹æ€§èƒ½ä¼˜åŒ–\nulimit -a å‘ç°ç³»ç»Ÿé»˜è®¤é…ç½®ä¸º 1024, åœ¨ç³»ç»Ÿ /etc/security/limits.conf ä¸­é…ç½® ulimit ä¹‹åé‡å¯æœåŠ¡å™¨.\n* soft nofile 65535 * hard nofile 65535 * soft nproc 65535 * hard nproc 65535 ç³»ç»Ÿå†…æ ¸çº¿ç¨‹é™åˆ¶\n# Mysql å½“å‰çš„çº¿ç¨‹æ•° ps -T -p $(pgrep mysqld) | wc -l cat /proc/sys/kernel/threads-max cat /proc/sys/kernel/pid_max echo 65535 \u0026gt; /proc/sys/kernel/threads-max echo 4194304 \u0026gt; /proc/sys/kernel/pid_max mysql systemd é…ç½®\nsystemctl status mysql vim /usr/lib/systemd/system/mysql.service # [service] ä¸‹æ·»åŠ å¦‚ä¸‹é…ç½® LimitNOFILE = 65535 LimitNPROC = 8192 LimitSTACK = 512K systemctl daemon-reload systemctl restart mysql msyql service é…ç½®, æ·»åŠ æˆ–ä¿®æ”¹å¦‚ä¸‹å‚æ•°\n[mysqld] thread_stack = 192K sort_buffer_size = 256K read_buffer_size = 256K read_rnd_buffer_size = 256K æ­¤æ—¶åšä¸»å¿ƒæ€å·²ç»å¿«å´©æºƒäº†, æœåŠ¡å™¨é‡å¯äº†, Mysql æœåŠ¡ä¹Ÿé‡å¯äº†å¾ˆå¤šæ¬¡, æƒ³åˆ°çš„ç³»ç»Ÿé™åˆ¶æˆ–è€…æ€§èƒ½ä¼˜åŒ–çš„åœ°æ–¹éƒ½åšè¿‡äº†, æŠ¥é”™ä¾ç„¶æ˜¯é¢‘é¢‘å‡ºç°.\nåªå¥½æ•´ç†æ€è·¯ä»å¤´å¼€å§‹, åœ¨è§‚å¯Ÿ Mysql Status æ•°æ®çš„æ—¶å€™å‘ç°ä¸€ä¸ªå°ç»†èŠ‚, Max_used_connections å’Œ Threads_connected è¿™ä¸ªå€¼æ°¸è¿œä¿æŒåœ¨ 472-473 !!!!!!!\næ€è·¯ä¸€ä¸‹å°±æ˜ç¡®äº†, è”æƒ³åˆ°åˆšæ‰åœ¨ç³»ç»Ÿä¸ŠæŸ¥çœ‹ Mysql çš„çº¿ç¨‹æ•°, å‘ç°è¿™ä¸ªå€¼ä¸€ç›´æ˜¯ 512\nps -T -p $(pgrep mysqld) | wc -l æ‰€ä»¥å¹¶ä¸æ˜¯æ€§èƒ½ä¼˜åŒ–æˆ–è€… Mysql æœ¬èº«çš„é…ç½®æœ‰é—®é¢˜, ä¸€å®šæ˜¯æŸä¸€é¡¹ç³»ç»Ÿé…ç½®, é™åˆ¶æ­»äº† Mysql service èƒ½åˆ›å»ºçš„çº¿ç¨‹æ•°\næŒ‰ç…§è¿™ä¸ªæ€è·¯å»é—®å„å¤§ AI, é€šä¹‰/è±†åŒ…/DS ç»™å‡ºçš„ç»“æœéƒ½è·Ÿæˆ‘ä¹‹å‰çš„æ’æŸ¥è¿‡ç¨‹ç›¸å·®ä¸å¤š, æ²¡æœ‰æ‰¾åˆ°é—®é¢˜ç‚¹, æœ€åè¿˜æ˜¯ DS å‡ºä¸–åè¢«å¤§å®¶æ·¡å¿˜çš„ ChatGPT ç»™å‡ºäº†è§£å†³æ–¹æ¡ˆ\næ‰§è¡Œå, ç»“æœæ˜¯ 512, è·Ÿä¸Šæ–‡åœ¨ç³»ç»Ÿä¸ŠæŸ¥çœ‹åˆ°çš„ Mysql çº¿ç¨‹æ•°ä¸€è‡´, é‚£å°±æ˜¯è¿™é‡Œçš„é—®é¢˜äº†\ncat /sys/fs/cgroup/pids/system.slice/mysql.service/pids.max 2 è§£å†³æ–¹æ¡ˆ ä¿®æ”¹ Mysql service çš„ systemd é…ç½®æ–‡ä»¶\nvim /usr/lib/systemd/system/mysql.service # åœ¨ [Service] å—æ·»åŠ æˆ–ä¿®æ”¹ TasksMax = infinity systemctl daemon-reload systemctl restart mysql ä»¥ä¸Š.\n","permalink":"https://www.lvbibir.cn/posts/tech/mysql-error-too-many-threads/","summary":"0 å‰è¨€ å‰æ®µæ—¶é—´åº”ä¸šåŠ¡éœ€æ±‚, åœ¨ suse12sp5 ç³»ç»Ÿä¸Šéƒ¨ç½²äº†ä¸€å¥— Mysql 8 æ•°æ®åº“, åˆšå¼€å§‹è¿è¡Œè‰¯å¥½, éšç€ä¾èµ–æ­¤æ•°æ®åº“çš„åŠŸèƒ½è¶Šæ¥è¶Šå¤š, å¼€å‘åŒäº‹ååº”åœ¨åº”ç”¨è¿æ¥æ•°æ®åº“æ—¶é¢‘ç¹æŠ¥é”™: [HY000][1135] null, message from server: \u0026#34;Can\u0026#39;t create a new thread (errno 11); if you are not out of available memory, you can consult the manual for a possible OS-dependent bug\u0026#34; åœ¨æ•°æ®åº“æœåŠ¡å™¨ä½¿ç”¨ root è´¦æˆ·ç™»é™†æŠ¥ç›¸åŒé”™è¯¯, åŒæ—¶åœ¨ mysql é”™è¯¯æ—¥å¿—æœ‰å¤§é‡ innodb æ— æ³•åˆ›å»ºæ‰«","title":"mysql | çº¿ç¨‹ä¸Šé™é—®é¢˜å¤„ç†"},{"content":"0 å‰è¨€ åšç­‰ä¿ä¸‰çº§é¡¹ç›®å®‰å…¨é›†æˆå»ºè®¾ï¼Œæµ‹è¯„çš„æ—¶å€™æœ‰ä¸ªé«˜å±ä¸ç¬¦åˆé¡¹å«åšå¤šå› å­è®¤è¯ï¼ˆç­‰ä¿é‡Œé¢é«˜å±æ˜¯ä¸€ç¥¨å¦å†³é¡¹æ‰€ä»¥å¿…é¡»æ•´æ”¹ï¼‰ã€‚è¿™ä¸€é¡¹è¦æ±‚åœ¨ç™»å½•å ¡å’æœºçš„æ—¶å€™åšå¤šå› å­è®¤è¯ï¼ˆçŸ­ä¿¡ã€æ‰‹æœºä»¤ç‰Œã€Ukey ç­‰ï¼‰ï¼Œåœ¨ç™»å½•å ¡å’æœºåæ¯å°æœåŠ¡å™¨ç™»å½•æ—¶ä»è¦è¿›è¡Œä¸€æ¬¡å¤šå› å­è®¤è¯ã€‚ä½†æ˜¯å› ä¸ºä¸€äº›åŸå› æœ¬æ¥è¿™ä¸ªäº‹åº”è¯¥ç”±ä¸»æœºå®‰å…¨å®ç°ç™»å½•ï¼Œä¸»æœºå®‰å…¨ç‰ˆæœ¬ä¸å¤Ÿå‡çº§ï¼ˆåä¸ºäº‘ä¼ä¸šä¸»æœºå®‰å…¨ï¼‰å°±åªèƒ½æƒ³åŠæ³•è‡ªå·±æŠ˜è…¾ã€‚æœ€åè¿˜æ˜¯æŸ¥åˆ°äº†ä½¿ç”¨è°·æ­Œè®¤è¯æ¨¡å—ï¼Œå¯ä»¥å®ç° OTP è®¤è¯ï¼Œè¿™é‡Œå°±ä¸è§£é‡Šä»€ä¹ˆæ˜¯ HOTP å’Œ TOTP äº†æœ‰éœ€æ±‚çš„å¯ä»¥è‡ªå·±æŸ¥åŸç†ã€‚\né‡‡ç”¨ TOTP æ–¹å¼è¿›è¡Œè®¤è¯ä¹Ÿæ¯”è¾ƒè›‹ç–¼ï¼Œåœ¨å®é™…çš„è¿ç»´å¼€å‘ç¯å¢ƒä¸­ï¼Œå¹¶éåªæœ‰ä¸€äººéœ€è¦ç™»å½•æœåŠ¡å™¨è¿›è¡Œæ“ä½œï¼ˆä¸ç„¶æˆ‘è¦å ¡å’æœºå¹²å˜›ï¼‰ï¼Œä½†æ˜¯ä¸ºäº†ä½¿ç”¨ OTP è®¤è¯ï¼Œéœ€è¦æ¯ä¸ªäººéƒ½åœ¨æ‰‹æœºä¸Šä¿ç•™æ¯å°æœåŠ¡å™¨çš„å¯†é’¥ï¼Œè¿™ä¸æ–¹ä¾¿ç®¡ç†ä¹Ÿä¸èƒ½ä¿è¯å¯†é’¥çš„å®‰å…¨æ€§ï¼Œå¦‚æœæ˜¯ä¸‰æ–¹å‚å•†æä¾›çš„è¿ç»´æ”¯æŒå°±æ›´è¦å‘½äº†ã€‚\nå†æé†’ä¸€ä¸‹ï¼Œå¦‚æœéƒ¨ç½²äº†å ¡å’æœºï¼Œå ¡å’æœºå¯èƒ½ä¸æ”¯æŒåœ¨ç™»é™†çš„æ—¶å€™ä½¿ç”¨å¤šå› å­ï¼Œæ­¤æ—¶çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨å ¡å’æœºç™»å½•å†…ç½‘è¿ç»´ä¸»æœºï¼Œä»è¿ç»´ä¸»æœºä¸Šå†ä½¿ç”¨ Xshell ç­‰è¿œç¨‹è¿æ¥å·¥å…·ç™»å½•å…¶å®ƒ Linux æœåŠ¡å™¨ï¼Œæ­¤æ—¶å†ä½¿ç”¨ OTP è®¤è¯ã€‚\nå®‰è£…è¿‡ç¨‹å¾ˆç®€å•ï¼ˆyum ç­‰æ‘‡è½®æ¤…å¼éƒ¨ç½²å°±ä¸è¯´äº†ï¼Œä»¥æºç æ–¹å¼ä¸¾ä¾‹ï¼‰ï¼Œåªéœ€è¦ä» Github ä¸Šä¸‹è½½æºç ï¼Œä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œå®‰è£…ä¾èµ–è¿›è¡Œç¼–è¯‘ã€å®‰è£…ï¼Œé…ç½® PAM è®¤è¯æ¨¡å—ä»¥åŠ sshd é…ç½®æ–‡ä»¶ï¼Œç”Ÿæˆå¯†é’¥ï¼Œä¿å­˜å¤‡ä»½å¯†é’¥ï¼Œé‡å¯ sshd æœåŠ¡å³å¯ã€‚\n1 å®‰è£… ä¸‹é¢åˆ†æ­¥éª¤è®°å½•å®‰è£…æƒ…å†µ\nå®‰è£…ç¯å¢ƒï¼šä¸­æ ‡éº’éºŸ V7.6\n1.1 ä» Github ä¸Šä¸‹è½½æºç  https://github.com/google/google-authenticator-libpam\nå°†æºç ä¸‹è½½ä¸º.zip æˆ–è€…ä»¥ä½ å–œæ¬¢çš„æ–¹å¼ä¸‹è½½ï¼ŒREADME æ–‡æ¡£å†™çš„å¾ˆè¯¦ç»†ï¼Œé™¤äº†æ˜¯è‹±æ–‡ä»¥å¤–æ²¡å•¥æ¯›ç—…\n1.2 ä¾èµ–å®‰è£… ç¼–è¯‘ å› ä¸ºæˆ‘çš„ç¯å¢ƒæ˜¯å†…ç½‘ï¼Œè¿ä¸ä¸Šäº’è”ç½‘çš„ yum ä»“åº“ï¼Œå†…ç½‘ yum æºè¿˜å› ä¸ºä¸€äº›åŸå› è¦å…³åœä¸€æ®µæ—¶é—´æ‰€ä»¥æ˜¯å®Œå…¨ä¸èƒ½æŒ‡æœ›ï¼Œæ‰€æœ‰ç¼ºå°‘çš„ä¾èµ–éƒ½éœ€è¦è‡ªå·±ä¸‹è½½ï¼Œä¸ºäº†èŠ‚çœæ—¶é—´æˆ‘ä¹Ÿéƒ½ä¸‹è½½å¥½äº†æ‰“åŒ…åˆ°ä¸€èµ·ï¼Œå¦‚æœæœ‰éœ€è¦å¯ä»¥ä¸‹è½½ï¼ˆä¸ä¿è¯ä»¥åæ›´é«˜ç‰ˆæœ¬èƒ½ç”¨ï¼‰\né“¾æ¥ï¼šhttps://pan.quark.cn/s/09cc2553daa5\næå–ç ï¼šq4Qd\nå‹ç¼©åŒ…å¯†ç  Thewind-rises.github.io\ntar -zxf google-authenticator-rpms.tar.gz cd google-authenticator-rpms.tar.gz rpm -Uvh *.rpm --nodeps --force æˆ‘ä¸ªäººåœ¨å®‰è£…çš„è¿‡ç¨‹ä¸­é‡åˆ°ä»¥ä¸‹ä¸¤ä¸ªè½¯ä»¶åŒ…å®‰è£…è¿‡ç¨æ—©çš„ç‰ˆæœ¬ï¼Œä½¿ç”¨ \u0026ndash;replacefiles å‚æ•°å¯ä»¥æ›¿ä»£\nrpm -ivh perl-libs-5.16.3-297.el7.x86_64.rpm --replacefiles rpm -ivh perl-5.16.3-297.el7.x86_64.rpm --replacefiles è‡³æ­¤å¦‚æœæ²¡æœ‰æŠ¥é”™ï¼Œé‚£ä¹ˆä¾èµ–åº”è¯¥å°±å‡†å¤‡å¥½äº†\nunzip google-authenticator-libpam-master.zip cd google-authenticator-libpam-master ./bootstrap.sh make make install å¦‚æœç¼–è¯‘è¿‡ç¨‹å‡ºé”™éœ€è¦é‡æ–°ç¼–è¯‘é‚£ä¹ˆå°±åœ¨æºä»£ç æ ¹ç›®å½•æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç„¶åå»æºä»£ç å‹ç¼©åŒ…æŠŠé‡Œé¢çš„ Makefile.am é‡æ–°ä¸Šä¼ ï¼Œæ’å®Œé”™ä»¥åå†é‡æ–°ç¼–è¯‘\nrm -rf autom4te.cache rm -rf aclocal.m4 rm -rf config.* rm -rf configure rm -rf Makefile* å¦‚æœæ²¡æœ‰æŠ¥é”™é‚£ä¹ˆæ‰§è¡Œ google-authenticator åº”è¯¥ä¼šå›æ˜¾ç‰ˆæœ¬å·ç­‰ä¿¡æ¯ï¼Œçœ‹åˆ°å°±è¯´æ˜å®‰è£…æˆåŠŸäº†ã€‚\n1.3 é…ç½® é…ç½®ä¸»è¦é’ˆå¯¹ä¸¤æ–‡ä»¶ï¼š/etc/pam.d/sshd å’Œ /etc/ssh/sshd_config\n/etc/pam.d/sshd\nå°†ä»¥ä¸‹å†…å®¹æ”¾åˆ°ç¬¬ä¸€è¡Œ\nauth required pam_google_authenticator.so nullok no_increment_hotp å…¶ä¸­ nullok å’Œ no_increment_hotp è¿™ä¸¤ä¸ªå¯é€‰å‚æ•°èƒ½å¤Ÿåœ¨ Github ä¸Šçš„ README æ–‡ä»¶ä¸­æ‰¾åˆ°è§£é‡Š\nnullok è¡¨æ˜ç›®å‰å¤šå› å­ç™»å½•æ˜¯ä¸€ä¸ªå¯é€‰é¡¹ï¼Œé€‚ç”¨äºå¯†é’¥è¿˜æ²¡åˆ†å‘åˆ°æ‰€æœ‰äººçš„æ—¶å€™ï¼Œå¦‚æœç¡®è®¤æ‰€æœ‰æˆæƒè€…éƒ½æ‹¿åˆ°äº†å¯†é’¥åº”å½“å°†æ­¤åˆ é™¤\nno_increment_hotp å»ºè®®é…ç½®ï¼Œæ­¤é€‰é¡¹å¯ä»¥ä¸æŠŠ OTP è®¤è¯å¤±è´¥è®°ä½œ SSH ç™»é™†å¤±è´¥ï¼Œé¿å…æœ‰ç¬¨æ¯”æƒ…å†µå‘ç”Ÿï¼ˆæ¯”æ–¹è¯´æˆ‘æµ‹è¯•è®¤è¯çš„æ—¶å€™å¤´é“ï¼ŒOTP ç¡¬æ˜¯è¿‡ä¸å»ï¼Œå»æŸ¥æ—¥å¿—æ‰å‘ç°å®‰è£…åå°‘äº†ä¸€ä¸ªè½¯è¿æ¥æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯ç³»ç»ŸåŸå› ï¼‰é”å®šè´¦æˆ·\nln -s /usr/local/lib/security/pam_google_authenticator.so /usr/lib64/security/pam_google_authenticator.so /etc/ssh/sshd_config ä¿è¯æœ‰ä»¥ä¸‹ä¸¤ä¸ªæ¡ç›®\nPubkeyAuthentication yes ChallengeResponseAuthentication yes ä¿å­˜å¹¶å…³é—­\nè‡³æ­¤é…ç½®å®Œæˆï¼Œä½ çš„ç³»ç»Ÿåœ¨ sshd æœåŠ¡é‡å¯ä¹‹ååº”è¯¥å°±èƒ½æ­£ç¡®ä½¿ç”¨ä¸¤æ­¥è®¤è¯ç™»å½•äº†ã€‚\n1.4 ç”ŸæˆäºŒæ¬¡éªŒè¯ä»£ç  ä»¥åŠå¦‚ä½•å¯åœ å‡ºå¤„ https://cloud.tencent.com/developer/article/1698883\nä½¿ç”¨ä¸‹é¢å‘½ä»¤è¿è¡Œ Google Authenticator è®¾ç½®ç¨‹åºï¼š\ngoogle-authenticator -t -f -d -w 3 -e 10 -r 3 -R 30 é€‰é¡¹è¯´æ˜ï¼š -t : ä½¿ç”¨ TOTP éªŒè¯ -f : å°†é…ç½®ä¿å­˜åˆ° ~/.google_authenticator -d : ä¸å…è®¸é‡å¤ä½¿ç”¨ä»¥å‰ä½¿ç”¨çš„ä»¤ç‰Œ -w 3 : å…è®¸çš„ä»¤ç‰Œçš„çª—å£å¤§å°ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œä»¤ç‰Œæ¯ 30 ç§’è¿‡æœŸä¸€æ¬¡ã€‚ çª—å£å¤§å° 3 å…è®¸åœ¨å½“å‰ä»¤ç‰Œä¹‹å‰å’Œä¹‹åä½¿ç”¨ä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯ä»¥è¿›è¡Œæ—¶é’Ÿåç§»ã€‚ -e 10 : ç”Ÿæˆ 10 ä¸ªç´§æ€¥å¤‡ç”¨ä»£ç  -r 3 -R 30 : é™é€Ÿï¼Œæ¯ 30 ç§’å…è®¸ 3 æ¬¡ç™»å½• æ›´å¤šå¸®åŠ©ä¿¡æ¯å¯ä»¥ä½¿ç”¨ --help é€‰é¡¹æŸ¥çœ‹ã€‚ ç¨‹åºè¿è¡Œåï¼Œå°†ä¼šæ›´æ–°é…ç½®æ–‡ä»¶ï¼Œå¹¶ä¸”æ˜¾ç¤ºä¸‹é¢ä¿¡æ¯ï¼š\näºŒç»´ç ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å¤§å¤šæ•°èº«ä»½éªŒè¯å™¨åº”ç”¨ç¨‹åºæ‰«ææ­¤ä»£ç ã€‚\nä¸€ä¸ªå¯†é’¥ï¼Œå¦‚æœæ‚¨æ— æ³•æ‰«æäºŒç»´ç ï¼Œè¯·åœ¨æ‚¨çš„åº”ç”¨ä¸­è¾“å…¥æ­¤å¯†é’¥ã€‚\næ­¤æ—¶ç¨‹åºä¼šæç¤ºè®©ä½ è¾“å…¥åˆå§‹éªŒè¯ç æ¥æµ‹è¯•ï¼Œè¾“å…¥ä½ ç”¨å„ç±»éªŒè¯å™¨è·å–åˆ°çš„ä¸€æ¬¡æ€§å¯†ç å³å¯\nå®Œæˆæµ‹è¯•åä¼šç»™å‡º 10 ä¸ªä¸€æ¬¡æ€§ä½¿ç”¨ç´§æ€¥ä»£ç çš„åˆ—è¡¨ï¼Œè¯·å¦¥å–„ä¿å­˜ï¼Œå¦‚æœæœ‰æ‰€æœ‰äººéƒ½ç™»å½•ä¸ä¸Šçš„æƒ…å†µæŒ‡ä¸å®šå¯ä»¥ç”¨è¿™ä¸ªæ•‘æ€¥ï¼Œä½†æ˜¯æ³¨æ„æ¯ä¸€ä¸ªä½¿ç”¨è¿‡çš„éªŒè¯ç éƒ½ä¼šå¤±æ•ˆã€‚\nå¦‚æœéœ€è¦ä»…å¯¹ç‰¹å®šç”¨æˆ·ä½¿ç”¨ä¸¤æ¬¡éªŒè¯ï¼Œé‚£å°± su åˆ°å¯¹åº”ç”¨æˆ·å¹¶è¿›å…¥å…¶ home ç›®å½•ï¼Œæ‰§è¡Œç”Ÿæˆä»£ç æ“ä½œå³å¯ï¼Œç”Ÿæˆå®Œæ¯•åä¼šåœ¨ home ç›®å½•ç”Ÿæˆ.google_authenticator æ–‡ä»¶ï¼Œé‡Œé¢ä¿å­˜äº†è¯¥è´¦æˆ·çš„ OTP å¯†é’¥ä»¥åŠç´§æ€¥ä»£ç ã€‚\nä¸éœ€è¦ä½¿ç”¨ä¸¤æ­¥éªŒè¯æ—¶ï¼Œåªè¦åˆ é™¤.google_authenticator å³å¯ï¼ŒåŒæ—¶å»ºè®®æ›´æ”¹ PAM é…ç½®æ–‡ä»¶ï¼Œæ³¨é‡Šæˆ‘ä»¬æ·»åŠ çš„å†…å®¹ã€‚\nä»¥ä¸Š.\n","permalink":"https://www.lvbibir.cn/posts/tech/kylinos-7.6-install-otp/","summary":"0 å‰è¨€ åšç­‰ä¿ä¸‰çº§é¡¹ç›®å®‰å…¨é›†æˆå»ºè®¾ï¼Œæµ‹è¯„çš„æ—¶å€™æœ‰ä¸ªé«˜å±ä¸ç¬¦åˆé¡¹å«åšå¤šå› å­è®¤è¯ï¼ˆç­‰ä¿é‡Œé¢é«˜å±æ˜¯ä¸€ç¥¨å¦å†³é¡¹æ‰€ä»¥å¿…é¡»æ•´æ”¹ï¼‰ã€‚è¿™ä¸€é¡¹è¦æ±‚åœ¨ç™»å½•å ¡å’æœºçš„æ—¶å€™åšå¤šå› å­è®¤è¯ï¼ˆçŸ­ä¿¡ã€æ‰‹æœºä»¤ç‰Œã€Ukey ç­‰ï¼‰ï¼Œåœ¨ç™»å½•å ¡å’æœºåæ¯å°æœåŠ¡å™¨ç™»å½•æ—¶ä»è¦è¿›è¡Œä¸€æ¬¡å¤šå› å­è®¤è¯ã€‚ä½†æ˜¯å› ä¸ºä¸€äº›åŸå› æœ¬æ¥è¿™ä¸ªäº‹åº”è¯¥ç”±ä¸»æœºå®‰","title":"éº’éºŸ 7.6 å®‰è£…è°·æ­Œ OTP è®¤è¯æ¨¡å—"},{"content":"# ä¸Šä¼  openssh å’Œ openssl åˆ° /opt # https://www.openssl.org/source/openssl-1.1.1i.tar.gz # https://mirrors.aliyun.com/pub/OpenBSD/OpenSSH/portable/openssh-9.7p1.tar.gz # openssl cd /opt/ tar zxf openssl-1.1.1i.tar.gz mv /usr/bin/openssl{,-1.0.2j-fips} mv /usr/include/openssl{,-1.0.2j-fips} cd openssl-1.1.1i/ ./config shared \u0026amp;\u0026amp; make \u0026amp;\u0026amp; make install ln -s /usr/local/bin/openssl /usr/bin/openssl ln -s /usr/local/include/openssl/ /usr/include/openssl echo \u0026#34;/usr/local/lib64\u0026#34; \u0026gt;\u0026gt; /etc/ld.so.conf /sbin/ldconfig openssl version # openssh mv /etc/ssh{,-7.2p2} cd /opt tar zxf openssh-9.7p1.tar.gz cd openssh-9.7p1/ ./configure --prefix=/usr/local/openssh --sysconfdir=/etc/ssh --with-openssl-includes=/usr/local/include --with-ssl-dir=/usr/local/lib64 --with-zlib --with-md5-passwords make make install sed -i \u0026#39;s/^#UseDNS.*/UseDNS no/\u0026#39; /etc/ssh/sshd_config sed -i \u0026#39;s/^#PermitRootLogin.*/PermitRootLogin yes/\u0026#39; /etc/ssh/sshd_config sed -i \u0026#39;s/^#PubkeyAuthentication.*/PubkeyAuthentication yes/\u0026#39; /etc/ssh/sshd_config sed -i \u0026#39;s/^#PasswordAuthentication.*/PasswordAuthentication yes/\u0026#39; /etc/ssh/sshd_config sed -i \u0026#39;s/^#X11Forwarding.*/X11Forwarding yes/\u0026#39; /etc/ssh/sshd_config sed -i \u0026#39;s/^#X11UseLocalhost.*/X11UseLocalhost no/\u0026#39; /etc/ssh/sshd_config sed -i \u0026#39;s%^#XAuthLocation.*%XAuthLocation /usr/bin/xauth%\u0026#39; /etc/ssh/sshd_config mv /usr/sbin/sshd{,-7.2p2} mv /usr/bin/ssh{,-7.2p2} mv /usr/bin/ssh-keygen{,-7.2p2} ln -s /usr/local/openssh/bin/ssh /usr/bin/ssh ln -s /usr/local/openssh/bin/ssh-keygen /usr/bin/ssh-keygen ln -s /usr/local/openssh/sbin/sshd /usr/sbin/sshd mv /usr/lib/systemd/system/sshd.service{,-7.2p2} cp -a contrib/suse/rc.sshd /etc/init.d/sshd chmod +x /etc/init.d/sshd chkconfig --add sshd systemctl enable sshd --now systemctl restart sshd ä»¥ä¸Š.\n","permalink":"https://www.lvbibir.cn/posts/tech/suse-12sp5-update-openssl-openssh/","summary":"# ä¸Šä¼  openssh å’Œ openssl åˆ° /opt # https://www.openssl.org/source/openssl-1.1.1i.tar.gz # https://mirrors.aliyun.com/pub/OpenBSD/OpenSSH/portable/openssh-9.7p1.tar.gz # openssl cd /opt/ tar zxf openssl-1.1.1i.tar.gz mv /usr/bin/openssl{,-1.0.2j-fips} mv /usr/include/openssl{,-1.0.2j-fips} cd openssl-1.1.1i/ ./config shared \u0026amp;\u0026amp; make \u0026amp;\u0026amp; make install ln -s /usr/local/bin/openssl /usr/bin/openssl ln -s /usr/local/include/openssl/ /usr/include/openssl echo \u0026#34;/usr/local/lib64\u0026#34; \u0026gt;\u0026gt; /etc/ld.so.conf /sbin/ldconfig openssl version # openssh mv /etc/ssh{,-7.2p2} cd /opt tar zxf openssh-9.7p1.tar.gz cd openssh-9.7p1/ ./configure --prefix=/usr/local/openssh --sysconfdir=/etc/ssh --with-openssl-includes=/usr/local/include --with-ssl-dir=/usr/local/lib64 --with-zlib --with-md5-passwords make make install sed -i \u0026#39;s/^#UseDNS.*/UseDNS no/\u0026#39; /etc/ssh/sshd_config sed -i \u0026#39;s/^#PermitRootLogin.*/PermitRootLogin yes/\u0026#39; /etc/ssh/sshd_config sed -i \u0026#39;s/^#PubkeyAuthentication.*/PubkeyAuthentication yes/\u0026#39; /etc/ssh/sshd_config sed -i \u0026#39;s/^#PasswordAuthentication.*/PasswordAuthentication yes/\u0026#39; /etc/ssh/sshd_config sed -i \u0026#39;s/^#X11Forwarding.*/X11Forwarding yes/\u0026#39; /etc/ssh/sshd_config sed -i \u0026#39;s/^#X11UseLocalhost.*/X11UseLocalhost no/\u0026#39; /etc/ssh/sshd_config sed -i \u0026#39;s%^#XAuthLocation.*%XAuthLocation /usr/bin/xauth%\u0026#39; /etc/ssh/sshd_config mv /usr/sbin/sshd{,-7.2p2} mv /usr/bin/ssh{,-7.2p2} mv /usr/bin/ssh-keygen{,-7.2p2} ln -s /usr/local/openssh/bin/ssh /usr/bin/ssh ln -s /usr/local/openssh/bin/ssh-keygen /usr/bin/ssh-keygen ln -s /usr/local/openssh/sbin/sshd /usr/sbin/sshd mv /usr/lib/systemd/system/sshd.service{,-7.2p2} cp -a contrib/suse/rc.sshd /etc/init.d/sshd chmod +x /etc/init.d/sshd chkconfig --add sshd systemctl enable sshd --now systemctl restart sshd","title":"suse 12sp5 å‡çº§ openssh åŠ openssl"},{"content":"0 å‰è¨€ ç³»ç»Ÿä½¿ç”¨ Gnome ç¯å¢ƒ\n1 å®‰è£… å®‰è£…ä¾èµ–\nzypper in libatomic1 zypper in perl-JSON ä¸‹è½½ mysql å®‰è£…åŒ…, é“¾æ¥\ntar xf mysql-5.7.44-1.sles12.x86_64.rpm-bundle.tar rpm -ivh mysql-community-common-5.7.44-1.sles12.x86_64.rpm rpm -ivh mysql-community-libs-5.7.44-1.sles12.x86_64.rpm rpm -ivh mysql-community-client-5.7.44-1.sles12.x86_64.rpm rpm -ivh mysql-community-server-5.7.44-1.sles12.x86_64.rpm mkdir -p /data/mysql/{data,tmp} chown -R mysql /data/mysql mysqld --initialize --datadir=/data/mysql/data/ --user=mysql ä¿®æ”¹ /etc/my.cnf é…ç½®æ–‡ä»¶\n[client] port = 3306 socket = /data/mysql/mysql.sock default-character-set=utf8 [mysqld] port = 3306 skip-grant-tables datadir = /data/mysql/data tmpdir = /data/mysql/tmp socket = /data/mysql/mysql.sock character-set-server = utf8 collation-server = utf8_general_ci pid-file = /data/mysql/mysql.pid user = mysql explicit_defaults_for_timestamp lower_case_table_names = 1 max_connections = 1000 back_log = 1024 open_files_limit = 10240 table_open_cache = 5120 skip-external-locking local-infile = 1 key_buffer_size = 32M max_allowed_packet = 1M table_open_cache = 64 sort_buffer_size = 512K net_buffer_length = 8K read_buffer_size = 256K read_rnd_buffer_size = 512K myisam_sort_buffer_size = 8M log-bin = /data/mysql/mysql-bin binlog_format = mixed server-id = 1 innodb_data_file_path = ibdata1:10M:autoextend innodb_buffer_pool_size = 256M innodb_buffer_pool_instances = 2 innodb_read_io_threads = 8 innodb_write_io_threads = 8 innodb_purge_threads = 1 slow_query_log = 1 long_query_time = 10 log-queries-not-using-indexes log-error = /data/mysql/mysql.err expire-logs-days = 10 [mysqldump] quick max_allowed_packet = 512M net_buffer_length = 16384 [mysql] auto-rehash [myisamchk] key_buffer_size = 20M sort_buffer_size = 20M read_buffer = 2M write_buffer = 2M [mysqlhotcopy] interactive-timeout 2 é…ç½® é¦–æ¬¡å¯åŠ¨å¹¶ä¿®æ”¹å¯†ç \nsystemctl start mysql mysql -uroot -p use mysql; update user set authentication_string = password(\u0026#39;D`N~Wv`%=XJeX\u0026#39;), password_expired = \u0026#39;N\u0026#39;, password_last_changed = now() where user = \u0026#39;root\u0026#39;; ä¿®æ”¹å®Œå¯†ç åæ³¨é‡Šæ‰ /etc/my.cnf ä¸­çš„ skip-grant-tables å¹¶é‡å¯ mysql\nsystemctl restart mysql è®¾ç½®è¿œç¨‹è®¿é—®\nmysql -uroot -p use mysql; grant all PRIVILEGES on *.* to root@\u0026#39;%\u0026#39; identified by \u0026#39;D`N~Wv`%=XJeX\u0026#39;; flush privileges; ä»¥ä¸Š.\n","permalink":"https://www.lvbibir.cn/posts/tech/suse-12sp5-deploy-mysql57/","summary":"0 å‰è¨€ ç³»ç»Ÿä½¿ç”¨ Gnome ç¯å¢ƒ 1 å®‰è£… å®‰è£…ä¾èµ– zypper in libatomic1 zypper in perl-JSON ä¸‹è½½ mysql å®‰è£…åŒ…, é“¾æ¥ tar xf mysql-5.7.44-1.sles12.x86_64.rpm-bundle.tar rpm -ivh mysql-community-common-5.7.44-1.sles12.x86_64.rpm rpm -ivh mysql-community-libs-5.7.44-1.sles12.x86_64.rpm rpm -ivh mysql-community-client-5.7.44-1.sles12.x86_64.rpm rpm -ivh mysql-community-server-5.7.44-1.sles12.x86_64.rpm mkdir -p /data/mysql/{data,tmp} chown -R mysql /data/mysql mysqld --initialize --datadir=/data/mysql/data/ --user=mysql ä¿®æ”¹ /etc/my.cnf é…ç½®æ–‡ä»¶ [client] port = 3306 socket = /data/mysql/mysql.sock default-character-set=utf8 [mysqld] port = 3306 skip-grant-tables datadir = /data/mysql/data tmpdir = /data/mysql/tmp socket = /data/mysql/mysql.sock character-set-server = utf8 collation-server = utf8_general_ci pid-file = /data/mysql/mysql.pid user = mysql explicit_defaults_for_timestamp lower_case_table_names = 1 max_connections = 1000 back_log = 1024 open_files_limit = 10240 table_open_cache = 5120 skip-external-locking local-infile = 1 key_buffer_size = 32M max_allowed_packet = 1M table_open_cache = 64 sort_buffer_size = 512K net_buffer_length = 8K read_buffer_size = 256K read_rnd_buffer_size = 512K","title":"suse 12sp5 éƒ¨ç½² mysql 5.7"},{"content":" åœ¨ 20 å²åˆ° 30 å²è¿™åå¹´çš„è¿‡ç¨‹ä¸­, æˆ‘ä»¬éƒ½èµ°è¿‡ä¸€æ ·çš„è·¯. ä½ è§‰å¾—å­¤ç‹¬å°±å¯¹äº†, é‚£æ˜¯è®©ä½ è®¤è¯†è‡ªå·±çš„æœºä¼š. ä½ è§‰å¾—ä¸è¢«ç†è§£å°±å¯¹äº†, é‚£æ˜¯è®©ä½ è®¤æ¸…æœ‹å‹çš„æœºä¼š. ä½ è§‰å¾—é»‘æš—å°±å¯¹äº†, é‚£æ ·ä½ æ‰åˆ†è¾¨å¾—å‡ºä»€ä¹ˆæ˜¯ä½ çš„å…‰èŠ’. ä½ è§‰å¾—æ— åŠ©å°±å¯¹äº†, é‚£æ ·ä½ æ‰èƒ½æ˜ç™½è°æ˜¯ä½ æˆé•¿ä¸­èƒ½æ‰¶ä½ ä¸€æŠŠçš„äºº. ä½ è§‰å¾—è¿·èŒ«å°±å¯¹äº†, è°çš„é’æ˜¥ä¸è¿·èŒ«.\nè¿™ä¸ªå‡æœŸè§äº†å¾ˆå¤šåŒå­¦å’Œè€å‹, å–äº†å¾ˆå¤šé…’. ä»¥å‰æˆ‘ä¹Ÿæƒ³, ç­‰åˆ°æ¯•ä¸šä¸€å¹´, ä¸‰å¹´, äº”å¹´å†è§, ä½†å…¶å®è¿‡ç¨‹ä¸­å¾ˆå¤šäººå°±æ–­äº†è”ç³». æ‰€ç”±ç°åœ¨èƒ½è§åˆ°çš„æœ‹å‹éƒ½æ˜¯è§ä¸€æ¬¡å°‘ä¸€æ¬¡, ä½ ç”šè‡³ä¸çŸ¥é“ä¸‹ä¸€æ¬¡å†è§çš„æ—¶é—´, æ‰€æœ‰å°‘å¹´ç›¸çº¦çš„æ‰¿è¯ºéƒ½åªæ˜¯å½“ä¸‹çš„å®‰æ…°. ä½ æ€»æœ‰ä¸€å¤©ä¼šæ˜ç™½: æœ‰äº›äºº, æœ‰äº›äº‹, ä¸€æ—¶é”™è¿‡, å°±æ˜¯ä¸€ä¸–.\næˆ‘ä»¬å¿ƒé‡Œæ°¸è¿œæœ‰ä¸€ä¸ªäºº, ä¸æ˜¯ä»–, ä¹Ÿä¼šæœ‰åˆ«äºº. åˆšå¼€å§‹æˆ‘ä»¬éƒ½ä¼šæŠ˜ç£¨è‡ªå·±, åŸ‹æ€¨è‡ªå·±, æ¨è‡ªå·±ä¸ºä»€ä¹ˆä¸€ç›´æ”¾ä¸ä¸‹è¿™ä¸ªäºº. åæ¥æ‰çŸ¥é“, ä¸æ˜¯ä½ æ”¾ä¸ä¸‹è°, è€Œæ˜¯ä½ æ”¾ä¸ä¸‹æƒ³å¿µå¯¹æ–¹çš„é‚£ä¸ªè‡ªå·±.\nå¾ˆå¤šäº‹æƒ…, åªè¦èƒ½åšåˆ°å¿ƒç”˜æƒ…æ„¿, ä¸€åˆ‡éƒ½ç†æ‰€å½“ç„¶.\næ¯å ‚è¯¾ 45 åˆ†é’Ÿ, å¦‚æœæ”¾åˆ°ç°åœ¨, æ¯ä¸€åˆ†æ¯ä¸€ç§’æˆ‘éƒ½å°½åŠ›è®°ä½è€å¸ˆè¯´çš„æ¯å¥è¯, éš”å£å‘¨å›´çš„æ¯å¼ è„¸å§.\nçœ‹ä¸Šäº†å°±è¿½, ç›¸ä¸­äº†å°±ä¹°, ç»ä¸å†åšåæ‚”çš„äº‹æƒ…. ç°åœ¨æœ‰äººé—®æˆ‘, ä¸ºä»€ä¹ˆä½ æ€»æ˜¯é‚£ä¹ˆæ¿€åŠ¨, é‚£ä¹ˆè‰ç‡åœ°åšå†³å®š? çœ‹åˆ°è¿™ç¯‡æ—¥å¿—, æˆ‘æ‰æƒ³èµ·æ¥, åŸæ¥æ—©åœ¨é‚£ä¹ˆå¤šå¹´å‰æˆ‘å°±è¯´æœè‡ªå·±è¦æ”¹å˜. å®è‚¯åšä¸€ä¸ªè‰ç‡åœ°å†³å®š, ä¹Ÿä¸è¦ä¸€ç›´åæ‚”åœ°å›å¿†.\nå–œæ¬¢ä¸€ä¸ªäº‹ç‰©å…‰æœ‰è‡ªå·±çš„å‹‡æ°”æ˜¯ä¸è¡Œçš„, ä¸€å®šè¦è®©åˆ«äººè§‰å¾—ä½ å–œæ¬¢çš„ä¸œè¥¿æ˜¯ä¸–ç•Œä¸Šæœ€å¥½çš„, è€Œä¸”è¦å¤§å£°åœ°è¯´, å¤§èƒ†åœ°è¯´, ç†ç›´æ°”å£®åœ°è¯´.\næ— è®ºå†çŸ«æƒ…å†å¹¼ç¨šå†åšä½œ, é‚£éƒ½æ˜¯ä¸€ä¸ªçœŸçœŸå®å®çš„æˆ‘ä»¬, æ²¡æœ‰ä»€ä¹ˆå¥½é„™è§†, æ›´ä¸ç”¨ä¸€ä¸ªæ¿€åŠ¨å°±æŒ‰äº†åˆ é™¤é”®. è¦çŸ¥é“ä½ åˆ é™¤çš„å¹¶ä¸æ˜¯å¹¼ç¨š, è€Œæ˜¯ä¸€æ®µé’æ˜¥å¥½çœ‹çš„é£æ™¯, è¿™äº›é£æ™¯æˆ–è®¸ä½ ç°åœ¨éšå¤„å¯è§, ä½†è¿™äº›é£æ™¯æœªæ¥ä½ ä¸–ç•Œéš¾å¯».\næ„Ÿæƒ…ä¸èƒ½å‡æ‰‹äºäºº, ä¸­é—´ä¸€æ—¦æºæ‚äº†ç­‰ä»·äº¤æ¢ç‰©, ä¹Ÿè®¸æœ€åè®°å¾—çš„åªæ˜¯ç­‰ä»·ç‰©äº†.\nä»»ä½•äº‹æƒ…, ä¸è¦å°†å¸Œæœ›å¯„æ‰˜åˆ°åˆ«äººèº«ä¸Š, æ— è®ºæ˜¯æƒ…æ„Ÿè¿˜æ˜¯å·¥ä½œ, å¦åˆ™å”¯ä¸€çš„ç»“æœä¾¿æ˜¯æªæ‰‹ä¸åŠ, å®‰å…¨æ„Ÿåªèƒ½è‡ªå·±ç»™è‡ªå·±.\nä½ é”™è¿‡çš„, åˆ«äººæ‰ä¼šå¾—åˆ°, æ­£å¦‚ä½ å¾—åˆ°çš„éƒ½æ˜¯åˆ«äººé”™è¿‡çš„.\næˆé•¿ä¸­æ‰€æœ‰é‡åˆ°çš„é—®é¢˜, éƒ½æ˜¯é‡èº«å®šåšçš„. è§£å†³äº†, ä½ å°±æˆä¸ºè¿™ç±»äººä¸­çš„å¹¸å­˜è€…. ä¸è§£å†³, ä½ æ°¸è¿œä¸çŸ¥é“è‡ªå·±å¯èƒ½æˆä¸ºè°.\nå› ä¸ºå¹´è½», æ‰€ä»¥æ²¡æœ‰é€‰æ‹©, åªèƒ½è¯•è¯•.\nä¸å¦‚æˆ‘ä»¬å®šä¸‹ä¸€ä¸ªèª“çº¦, çœ‹çœ‹åå¹´ä¹‹å, æˆ‘ä»¬å½¼æ­¤åˆåœ¨å“ªé‡Œ, å¬è°çš„æ­Œ, çœ‹è°çš„å­—, èº«è¾¹çš„äººåˆæ˜¯è°?\nå¥½å¤šå¥½å¤šç¾å¥½çš„äº‹æƒ…, å°±åº”è¯¥é‡è§, è€Œä¸æ˜¯è¿½é€, æˆ–è€…ç­‰å¾….\næˆ‘ä»¬ä¹‹æ‰€ä»¥è¿·èŒ«, å¹¶ä¸æ˜¯å› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“è‡ªå·±æƒ³è¦ä»€ä¹ˆ. è€Œæ˜¯å› ä¸º, æ— æ•°äººæ•™è‚²æˆ‘ä»¬åº”è¯¥è¦æ€ä¹ˆæ ·, å´å¿˜äº†å‘Šè¯‰æˆ‘ä»¬, æƒ³è¦æ›´é‡è¦. æ‰€ä»¥æˆ‘ä»¬åœ¨åº”è¯¥å’Œæƒ³ä¹‹é—´å¾˜å¾Š, å°±æ˜¯è¿·èŒ«. å…¶å®, åšè‡ªå·±å°±å¥½.\næ‰€è°“æˆé•¿, ä¸æ˜¯å­¦ä¼š, å°±æ˜¯æ‡‚å¾—.\næˆ‘å¦ˆè¯´: æ²¡æœ‰äººä¼šä¸€ç›´æ­£ç¡®, ä»–ä»¬åªä¼šè¶Šæ¥è¶Šæ­£ç¡®.\nè¿™è¾ˆå­æˆ‘ä»¬éœ€è¦ä¸€è§é’Ÿæƒ…å¾ˆå¤šäºº, ä¸¤æƒ…ç›¸æ‚¦ä¸€äº›äºº, ç„¶åç™½å¤´å•è€ä¸€ä¸ªäºº.\næ¢¦é‡Œæ‰€æœ‰çš„ä¸€åˆ‡éƒ½é¡ºç†æˆç« , è€Œæ¸…é†’ä¹‹åæ¼æ´ç™¾å‡º.\næˆé•¿æœ‰ä¸€ç¬é—´ç»™æˆ‘çš„æ„Ÿè§‰å°±æ˜¯, å¹¶ä¸æ˜¯å­¦ä¼šäº†é¿å¼€å±é™©, è€Œæ˜¯å­¦ä¼šäº†ä¸æ€•ç–¼ç—›.\nä¸å¦‚æˆ‘ä»¬ç«‹ä¸ªçº¦å®š, è§è¯å½¼æ­¤çš„ä¸‹ä¸€å¹´. å¸Œæœ›åœ¨æœªæ¥çš„æ—¥å­é‡Œ, æˆ‘ä»¬ä¸ä¸ºäº†ç”Ÿæ´»è€Œå¿˜äº†æ¢¦æƒ³, ä¸ä¸ºäº†è€ç»ƒè€Œä¸¢å¼ƒå†²åŠ¨, ä¸ä¸ºäº†æˆç†Ÿè€Œå¤±å»æ ¼è°ƒ.\n","permalink":"https://www.lvbibir.cn/posts/read/shei-de-qing-chun-bu-mi-mang/","summary":"åœ¨ 20 å²åˆ° 30 å²è¿™åå¹´çš„è¿‡ç¨‹ä¸­, æˆ‘ä»¬éƒ½èµ°è¿‡ä¸€æ ·çš„è·¯. ä½ è§‰å¾—å­¤ç‹¬å°±å¯¹äº†, é‚£æ˜¯è®©ä½ è®¤è¯†è‡ªå·±çš„æœºä¼š. ä½ è§‰å¾—ä¸è¢«ç†è§£å°±å¯¹äº†, é‚£æ˜¯è®©ä½ è®¤æ¸…æœ‹å‹çš„æœºä¼š. ä½ è§‰å¾—é»‘æš—å°±å¯¹äº†, é‚£æ ·ä½ æ‰åˆ†è¾¨å¾—å‡ºä»€ä¹ˆæ˜¯ä½ çš„å…‰èŠ’. ä½ è§‰å¾—æ— åŠ©å°±å¯¹äº†, é‚£æ ·ä½ æ‰èƒ½æ˜ç™½è°æ˜¯ä½ æˆé•¿ä¸­èƒ½æ‰¶ä½ ä¸€æŠŠçš„äºº. ä½ è§‰å¾—è¿·èŒ«å°±å¯¹äº†, è°çš„é’æ˜¥ä¸è¿·èŒ«.","title":"ã€Šè°çš„é’æ˜¥ä¸è¿·èŒ«ã€‹"},{"content":"0 å‰è¨€ ä¸€ç›´æ²¡æœ‰å•ç‹¬è®°å½•è¿‡ docker çš„å®‰è£…æ­¥éª¤, æ•…æœ‰æ­¤æ–‡\n1 å®‰è£… docker # å¦‚æ²¡æœ‰ wget, å¯ä»¥ä½¿ç”¨ curl, -O æ›¿æ¢æˆ -o wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo yum list docker-ce --show-duplicates yum install docker-ce-20.10.23-3.el7.x86_64 2 é•œåƒåŠ é€Ÿå™¨ mkdir /etc/docker cat \u0026gt; /etc/docker/daemon.json \u0026lt;\u0026lt; EOF { \u0026#34;registry-mirrors\u0026#34;: [ \u0026#34;http://hub-mirror.c.163.com\u0026#34;, \u0026#34;https://docker.mirrors.ustc.edu.cn\u0026#34;, \u0026#34;https://jc0srqak.mirror.aliyuncs.com\u0026#34; ] } EOF systemctl daemon-reload systemctl enable docker \u0026amp;\u0026amp; systemctl start docker docker info # åº”çœ‹åˆ°é…ç½®çš„é•œåƒåœ°å€ ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/docker-deploy/","summary":"0 å‰è¨€ ä¸€ç›´æ²¡æœ‰å•ç‹¬è®°å½•è¿‡ docker çš„å®‰è£…æ­¥éª¤, æ•…æœ‰æ­¤æ–‡ 1 å®‰è£… docker # å¦‚æ²¡æœ‰ wget, å¯ä»¥ä½¿ç”¨ curl, -O æ›¿æ¢æˆ -o wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo yum list docker-ce --show-duplicates yum install docker-ce-20.10.23-3.el7.x86_64 2 é•œåƒåŠ é€Ÿå™¨ mkdir /etc/docker cat \u0026gt; /etc/docker/daemon.json \u0026lt;\u0026lt; EOF { \u0026#34;registry-mirrors\u0026#34;: [ \u0026#34;http://hub-mirror.c.163.com\u0026#34;, \u0026#34;https://docker.mirrors.ustc.edu.cn\u0026#34;, \u0026#34;https://jc0srqak.mirror.aliyuncs.com\u0026#34; ] } EOF systemctl daemon-reload systemctl enable docker \u0026amp;\u0026amp; systemctl start docker docker info # åº”çœ‹åˆ°é…ç½®çš„é•œåƒåœ°å€ ä»¥ä¸Š","title":"docker | centos7 éƒ¨ç½² docker"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\næŒ‡å°–é£èˆ: vscode + vim é«˜æ•ˆå¼€å‘ vim å¤‡å¿˜æ¸…å• ä¸€ç›´æ†§æ†¬ vim çš„å…¨é”®ç›˜æ“ä½œ, äºæ˜¯å¼€å§‹æŠ˜è…¾å°† obsidian å’Œ vscode çš„ç¼–è¾‘æ¨¡å¼éƒ½è½¬åˆ° vim, obsidian ä½¿ç”¨è‡ªå¸¦çš„ vim æ¨¡å¼åŠ  vimrc æ’ä»¶, vscode ä½¿ç”¨ vim æ’ä»¶\nä¸ºäº†ä¿æŒ obsidian, vscode, wsl åŠ linux ä¸­çš„ vim ä¹ æƒ¯ä¸€è‡´, æˆ‘çš„ vim ä½¿ç”¨ç†å¿µ:\nå°½é‡ä½¿ç”¨ vim åŸç”Ÿè‡ªå¸¦çš„åŠŸèƒ½, æ‹’ç»ä»»ä½•ä¸‰æ–¹æ’ä»¶ å°½é‡ä½¿ç”¨å„å¹³å°é€šç”¨çš„ vimrc é…ç½® (é™¤äº† vscode ä½¿ç”¨ setting.json) 1 vim é€šç”¨æ“ä½œ 1.1 ç¤ºä¾‹ vim ä¸­çš„æ“ä½œéƒ½æ˜¯é€šè¿‡å¦‚ä¸‹æ–¹å¼è¿›è¡Œæ“ä½œçš„:\n[æ•°å­—] \u0026lt;æ“ä½œç¬¦\u0026gt; \u0026lt;åŠ¨ä½œ\u0026gt;/\u0026lt;æ–‡æœ¬å¯¹è±¡\u0026gt; \u0026lt;æ“ä½œç¬¦\u0026gt; [æ•°å­—] \u0026lt;åŠ¨ä½œ\u0026gt;/\u0026lt;æ–‡æœ¬å¯¹è±¡\u0026gt; \u0026gt;i{ | å°†å½“å‰ {} å†…çš„å†…å®¹å‘å³ç¼©è¿› dfa | åˆ é™¤ç›´åˆ° a å­—ç¬¦ d/hello | åˆ é™¤ç›´åˆ° hello ggyG | å¤åˆ¶æ•´ä¸ªæ–‡æ¡£ dip | åˆ é™¤æ•´ä¸ªæ®µè½ ciw | æ›´æ”¹å½“å‰ word cit | æ›´æ”¹å½“å‰ html æ ‡ç­¾çš„å†…å®¹ 1.2 operator æ“ä½œç¬¦ d | åˆ é™¤ y | yank (å¤åˆ¶) c | æ›´æ”¹ (åˆ é™¤ç„¶åæ’å…¥) p | ç²˜è´´ = | æ ¼å¼ä»£ç  g~ | åˆ‡æ¢æ¡ˆä¾‹ gU | å¤§å†™ gu | å°å†™ \u0026gt; | å³ç¼©è¿› \u0026lt; | å·¦ç¼©è¿› ! | å¤–éƒ¨ç¨‹åºè¿‡æ»¤ 1.3 motion åŠ¨ä½œ åŸºç¡€åŠ¨ä½œ\nh/j/k/l | å·¦/ä¸‹/ä¸Š/å³ ctrl + u/d | ä¸Š/ä¸‹ åŠé¡µ ctrl + b/f | ä¸Š/ä¸‹ ç¿»é¡µ å­— (è¯)\nb/w | ä¸Šä¸€ä¸ª/ä¸‹ä¸€ä¸ª å•è¯å¼€å§‹ ge/e | ä¸Šä¸€ä¸ª/ä¸‹ä¸€ä¸ª å•è¯æœ«å°¾ è¡Œ\n0/$ | è¡Œé¦–/è¡Œå°¾ ^ | è¡Œé¦– (éç©ºç™½) å­—ç¬¦ä¸²\nFe/fe | ç§»åŠ¨åˆ°ä¸Šä¸€ä¸ª/ä¸‹ä¸€ä¸ª e To/to | åœ¨ä¸Šä¸€ä¸ª/ä¸‹ä¸€ä¸ª o ä¹‹å‰/ä¹‹åç§»åŠ¨ | / n| | è½¬åˆ°ä¸€ä¸ª /n åˆ— æ–‡æ¡£\ngg/G | ç¬¬ä¸€è¡Œ/æœ€åä¸€è¡Œ :n/nG | è½¬åˆ°ç¬¬ n è¡Œ { / } | ä¸Šä¸€ä¸ª/ä¸‹ä¸€ä¸ªç©ºè¡Œ çª—å£\nH/M/L | ä¸Š/ä¸­/ä¸‹ å±å¹• zt/zz/zb | ä¸Š/ä¸­/ä¸‹ è¿™æ¡çº¿ 1.4 æ–‡æœ¬å¯¹è±¡ inner(å†…éƒ¨) / around(å‘¨å›´)\np | æ®µè½ w | å•è¯ W | WORD(è¢«ç©ºæ ¼åŒ…å›´) s | å¥å­ [({\u0026lt;\u0026gt;})] | [], (), {} æˆ–è€… \u0026lt;\u0026gt; å— \u0026#39;\u0026#34;\\` | å¸¦å¼•å·çš„å­—ç¬¦ä¸² b | åŒ () B | åŒ {} t | html æ ‡ç­¾å— 2 vscode ä¸­çš„ vim ä¸‹è¿°åŠŸèƒ½æºäº vscode vim æ’ä»¶\n2.1 easymotion \u0026lt;leader\u0026gt;\u0026lt;leader\u0026gt;s\u0026lt;str\u0026gt; | å¯ä»¥å¿«é€Ÿå‘åæŸ¥æ‰¾ \u0026lt;leader\u0026gt;\u0026lt;leader\u0026gt;f\u0026lt;str\u0026gt; | å¯ä»¥å¿«é€Ÿå‘å‰æŸ¥æ‰¾ 2.2 surround cs\u0026#34;\u0026#39; | å°† `\u0026#34;` æ›¿æ¢ä¸º \u0026#39; ds\u0026#34; | åˆ é™¤åŒ…å›´çš„ \u0026#34; ys\u0026lt;motion\u0026gt;\u0026#34; | æ·»åŠ åŒ…å›´çš„ \u0026#34;, å¦‚ ysiw\u0026#34; 2.3 multi-cursor å¤šå…‰æ ‡ å¯ä»¥ä½¿ç”¨ gb ä»£æ›¿ vscode ä¸­çš„ ctrl-d\n2.4 å…¶ä»–æ“ä½œ gh | å¯ä»¥æ¨¡æ‹Ÿé¼ æ ‡æ‚¬æµ® gd | å¯ä»¥åˆ‡æ¢å®šä¹‰ 3 vimrc vimrc çš„ä½ç½®:\nobsidian: åœ¨æ’ä»¶é…ç½®ä¸­æˆ‘å°† vimrc çš„é»˜è®¤æ–‡ä»¶åä» .obsidian.vimrc æ”¹æˆäº† .vimrc å­˜æ”¾åˆ°äº† obsidian ä»“åº“çš„æ ¹ç›®å½• wsl: æˆ‘çš„ wsl æ˜¯ ubuntu, ä¸ºäº†ä½¿ç”¨ sudo æ—¶ vimrc é…ç½®ç”Ÿæ•ˆ, vimrc ä¿®æ”¹é€šè¿‡ä¿®æ”¹ /etc/vim/vimrc å®ç° vscode: vscode ç›´æ¥ä½¿ç”¨ setting.json ä¸­ vim çš„é…ç½® æˆ‘çš„ vimrc é…ç½®ç¤ºä¾‹\n\u0026#34; æ’å…¥æ¨¡å¼ä¸‹ä½¿ç”¨ jj å¿«é€Ÿè¿”å›åˆ° normal æ¨¡å¼ inoremap jj \u0026lt;Esc\u0026gt; \u0026#34; ä½¿ä¸Šä¸‹ç§»åŠ¨çš„æ—¶å€™æŒ‰ç…§è§†è§‰çš„è¡Œæ•°ç§»åŠ¨, å¯¹äºå¤šè¡Œçš„æ®µè½å¾ˆæœ‰æ•ˆ nmap j gj nmap k gk \u0026#34; å¿«æ·è¡Œé¦–å’Œè¡Œå°¾ \u0026#34; normal æ¨¡å¼ä½¿ç”¨ nmap H ^ nmap L $ \u0026#34; æ“ä½œæ¨¡å¼ä½¿ç”¨, ç”¨äº yL, dH ç­‰æ“ä½œ omap H ^ omap L $ \u0026#34; visual æ¨¡å¼ä½¿ç”¨ vmap H ^ vmap L $ vscode ä¸­çš„ vim é…ç½®ç¤ºä¾‹\n// vim ç›¸å…³ \u0026#34;vim.leader\u0026#34;: \u0026#34;\u0026lt;space\u0026gt;\u0026#34;, \u0026#34;vim.incsearch\u0026#34;: true, \u0026#34;vim.easymotion\u0026#34;: true, // ä½¿ç”¨ç³»ç»Ÿå‰ªè´´æ¿ä½œä¸º vim å¯„å­˜å™¨ \u0026#34;vim.useSystemClipboard\u0026#34;: true, // ç”± vim æ¥ç®¡ ctrl + any å¿«æ·é”® \u0026#34;vim.useCtrlKeys\u0026#34;: true, // çªå‡ºæ˜¾ç¤ºä¸å½“å‰æœç´¢åŒ¹é…çš„æ‰€æœ‰æ–‡æœ¬ \u0026#34;vim.hlsearch\u0026#34;: true, // ä¸‹åˆ—æŒ‰é”®ç”± vscode æ¥ç®¡è€Œä¸æ˜¯ vim \u0026#34;vim.handleKeys\u0026#34;: { \u0026#34;\u0026lt;C-a\u0026gt;\u0026#34;: false, \u0026#34;\u0026lt;C-f\u0026gt;\u0026#34;: false, \u0026#34;\u0026lt;C-k\u0026gt;\u0026#34;: false, \u0026#34;\u0026lt;C-n\u0026gt;\u0026#34;: false, \u0026#34;\u0026lt;C-p\u0026gt;\u0026#34;: false, }, \u0026#34;vim.insertModeKeyBindings\u0026#34;: [ { \u0026#34;before\u0026#34;: [\u0026#34;j\u0026#34;, \u0026#34;j\u0026#34;], \u0026#34;after\u0026#34;: [\u0026#34;\u0026lt;Esc\u0026gt;\u0026#34;] } ], \u0026#34;vim.normalModeKeyBindingsNonRecursive\u0026#34;: [ { \u0026#34;before\u0026#34;: [\u0026#34;j\u0026#34;], \u0026#34;after\u0026#34;: [\u0026#34;g\u0026#34;, \u0026#34;j\u0026#34;] }, { \u0026#34;before\u0026#34;: [\u0026#34;k\u0026#34;], \u0026#34;after\u0026#34;: [\u0026#34;g\u0026#34;, \u0026#34;k\u0026#34;] }, { \u0026#34;before\u0026#34;: [\u0026#34;K\u0026#34;], \u0026#34;commands\u0026#34;: [\u0026#34;lineBreakInsert\u0026#34;], \u0026#34;silent\u0026#34;: true }, { \u0026#34;before\u0026#34;: [\u0026#34;L\u0026#34;], \u0026#34;after\u0026#34;: [\u0026#34;$\u0026#34;] }, { \u0026#34;before\u0026#34;: [\u0026#34;H\u0026#34;], \u0026#34;after\u0026#34;: [\u0026#34;^\u0026#34;] } ], \u0026#34;vim.operatorPendingModeKeyBindings\u0026#34;: [ { \u0026#34;before\u0026#34;: [\u0026#34;L\u0026#34;], \u0026#34;after\u0026#34;: [\u0026#34;$\u0026#34;] }, { \u0026#34;before\u0026#34;: [\u0026#34;H\u0026#34;], \u0026#34;after\u0026#34;: [\u0026#34;^\u0026#34;] } ], \u0026#34;vim.visualModeKeyBindingsNonRecursive\u0026#34;: [ { \u0026#34;before\u0026#34;: [\u0026#34;L\u0026#34;], \u0026#34;after\u0026#34;: [\u0026#34;$\u0026#34;] }, { \u0026#34;before\u0026#34;: [\u0026#34;H\u0026#34;], \u0026#34;after\u0026#34;: [\u0026#34;^\u0026#34;] } ], \u0026#34;extensions.experimental.affinity\u0026#34;: { \u0026#34;vscodevim.vim\u0026#34;: 1 }, ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/vim/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: æŒ‡å°–é£èˆ: vscode + vim é«˜æ•ˆå¼€å‘ vim å¤‡å¿˜æ¸…å• ä¸€ç›´æ†§æ†¬ vim çš„å…¨é”®ç›˜æ“ä½œ, äºæ˜¯å¼€å§‹æŠ˜è…¾å°† obsidian å’Œ vscode çš„ç¼–è¾‘æ¨¡å¼éƒ½è½¬åˆ° vim, obsidian ä½¿ç”¨è‡ªå¸¦çš„ vim æ¨¡å¼åŠ  vimrc æ’ä»¶, vscode ä½¿ç”¨ vim æ’ä»¶ ä¸ºäº†ä¿æŒ obsidian, vscode, wsl åŠ linux ä¸­çš„ vim ä¹ æƒ¯ä¸€è‡´, æˆ‘çš„ vim ä½¿ç”¨ç†å¿µ: å°½é‡ä½¿ç”¨ vim åŸç”Ÿè‡ªå¸¦çš„åŠŸèƒ½, æ‹’ç»ä»»ä½•ä¸‰æ–¹æ’ä»¶ å°½é‡ä½¿ç”¨å„å¹³å°é€šç”¨çš„ vimrc é…ç½® (","title":"vim | åŸºç¡€é…ç½®å’Œä½¿ç”¨"},{"content":"0 å‰è¨€ ç”¨äº†å¾ˆå¤šå¹´çš„æœç‹—è¾“å…¥æ³•, è‹¦äºè¶Šæ¥è¶Šå¤šçš„åå°, åˆæ¢åˆ°å¾®è½¯åŸç”Ÿçš„è¾“å…¥æ³•, ç»“æœåˆå‡ºç°äº† vscode vim ä¸­ä½¿ç”¨ä¸­æ–‡è¾“å…¥æ³•çš„æ—¶å€™ä¼šä¸€ç›´ä¹±è·³, é‚åˆäº§ç”Ÿäº†æ¢è¾“å…¥æ³•çš„æƒ³æ³•\næˆ‘å¯¹è¾“å…¥æ³•çš„è¦æ±‚å¾ˆç®€å•: ç®€æ´æ–¹ä¾¿, åå°å¹²å‡€, è‡ªå¸¦è‰¯å¥½çš„è¯åº“å³å¯, æœ€åäº†è§£åˆ°äº†å°ç‹¼æ¯«è¾“å…¥æ³• (rime çš„ windows ç‰ˆæœ¬, åˆç§° rime weasel) åŠ  é›¾å‡‡æ–¹æ¡ˆ, å¯å®šåˆ¶é¡¹éå¸¸å¤š, ä¹Ÿå¯ä»¥é›†æˆå…¶ä»–æ–¹æ¡ˆ, æ…¢æ…¢æ‰“ç£¨æˆè‡ªå·±é¡ºæ‰‹çš„è¾“å…¥æ³•\n1 å®‰è£… å®‰è£…å‰ç¡®è®¤åŒºåŸŸå’Œè¯­è¨€è®¾ç½®ä¸­æ–‡çš„è¾“å…¥æ³•ä¸ºå¾®è½¯é»˜è®¤çš„è¾“å…¥æ³•, å®‰è£…å®Œæˆååœ¨åŒºåŸŸå’Œè¯­è¨€è®¾ç½®ä¸­æ–°å¢å°ç‹¼æ¯«è¾“å…¥æ³•å¹¶åˆ é™¤å¾®è½¯é»˜è®¤è¾“å…¥æ³•\nrime ç”±äº windows ä¸Šçš„ rime æ›´æ–°æœ‰ç‚¹æ…¢, å½“å‰ç‰ˆæœ¬çš„ vim mode æœ‰äº›é—®é¢˜, æ‰€ä»¥è¿™é‡Œæˆ‘é‡‡ç”¨äº† rime nightly build é¢„è§ˆç‰ˆ, ä¸‹è½½ exe å®‰è£…åŒ…è¿›è¡Œå®‰è£…å³å¯\nå®‰è£…ä½ç½®é€‰æ‹© D:\\software\\Rime, ç”¨æˆ·æ–‡ä»¶å¤¹é€‰æ‹© D:\\software\\Rime\\profile\né›¾å‡‡æ–¹æ¡ˆ ç›´æ¥ä¸‹è½½ zip è§£å‹åå°†æ‰€æœ‰æ–‡ä»¶å¤åˆ¶åˆ° D:\\software\\Rime\\profile å³å¯\nä¹‹ååœ¨ä»»åŠ¡æ çš„è¯­è¨€æ å³å‡»å°ç‹¼æ¯«å›¾æ ‡é€‰æ‹©é‡æ–°éƒ¨ç½², ç­‰å¾…éƒ¨ç½²å®ŒæˆåæŒ‰ F4 é€‰æ‹© é›¾å‡‡æ–¹æ¡ˆ å³å¯, ä¹Ÿå¯ä»¥åˆ‡æ¢ç®€ç¹ä½“, ä¸­è‹±æ–‡æ ‡ç‚¹å’Œå…¨åŠè§’ç­‰\n2 é…ç½® é›¾å‡‡æ–¹æ¡ˆ - å®˜æ–¹é…ç½®æŒ‡å— rime weasel - wiki\nå¯ä»¥é€šè¿‡ç›´æ¥ä¿®æ”¹ profile ä¸‹çš„ default.yaml å’Œ weasel.yaml å®ç°, ä½†æ˜¯åç»­æ— æ³•å†æ–¹ä¾¿åœ°è¿›è¡Œæ›´æ–°, æ¨èé€šè¿‡ patch æ–¹å¼è¿›è¡Œä¿®æ”¹, æ¯”å¦‚ default.yaml çš„ patch æ–‡ä»¶å°±æ˜¯ default.custom.yaml\nä¿®æ”¹ D:\\software\\Rime\\profile\\weasel.custom.yaml, æ·»åŠ å¦‚ä¸‹\npatch: # é…è‰²æ–¹æ¡ˆ \u0026#34;style/color_scheme\u0026#34;: \u0026#34;lost_temple\u0026#34; # å­—ä½“ç›¸å…³é…ç½® \u0026#34;style/font_face\u0026#34;: \u0026#34;LXGW WenKai, Segoe UI Emoji:30:39, Segoe UI Emoji:23:23, Segoe UI Emoji:2a:2a, Segoe UI Emoji:fe0f:fe0f, Segoe UI Emoji:20e3:20e3, Microsoft YaHei, SF Pro, Segoe UI Emoji, Noto Color Emoji\u0026#34; # æ ‡ç­¾å­—ä½“ \u0026#34;style/label_font_face\u0026#34;: \u0026#34;LXGW WenKai\u0026#34; # æ³¨é‡Šå­—ä½“ \u0026#34;style/comment_font_face\u0026#34;: \u0026#34;LXGW WenKai\u0026#34; # å…¨å±€å­—ä½“å­—å· \u0026#34;style/font_point\u0026#34;: 16 # æ ‡ç­¾å­—ä½“å­—å·ï¼Œä¸è®¾å®š fallback åˆ° font_point \u0026#34;style/label_font_point\u0026#34;: 16 # æ³¨é‡Šå­—ä½“å­—å·ï¼Œä¸è®¾å®š fallback åˆ° font_point \u0026#34;style/comment_font_point\u0026#34;: 14 # è¡Œå†…å–æ¶ˆæ˜¾ç¤ºé¢„ç¼–è¾‘åŒº, å¯ä»¥è§£å†³ vscode è¾“å…¥ä¸­æ–‡çš„å…‰æ ‡è·³åŠ¨é—®é¢˜ \u0026#34;style/inline_preedit\u0026#34;: false # é’ˆå¯¹ä¸åŒçš„åº”ç”¨ç¨‹åºè®¾ç½®è¾“å…¥æ³•çš„é»˜è®¤çŠ¶æ€ # ascii_mode true è¡¨ç¤ºä½¿ç”¨è‹±æ–‡ # vim_mode true è¡¨ç¤ºåœ¨ä½¿ç”¨ \u0026lt;Esc\u0026gt; æˆ–è€… ctrl + [ æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°è‹±æ–‡ app_options: WindowsTerminal.exe: ascii_mode: true vim_mode: true Obsidian.exe: ascii_mode: true vim_mode: true Code.exe: ascii_mode: true vim_mode: true MobaXterm.exe: ascii_mode: true vim_mode: true ä¿®æ”¹ D:\\software\\Rime\\profile\\default.custom.yaml\npatch: # æ–¹æ¡ˆé€‰å•, æˆ‘åªä½¿ç”¨å…¨æ‹¼ schema_list: - {schema: rime_ice} # ä¿®æ”¹äº†é»˜è®¤é…ç½®ä¸­çš„å¿«æ·é”®å’Œæ˜¯å¦æŠ˜å  switcher: caption: [æ–¹æ¡ˆé€‰å•] # ä¿®æ”¹å¿«æ·é”® F4 å‘¼å‡ºæ–¹æ¡ˆé€‰å• hotkeys: - F4 save_options: - ascii_punct - traditionalization - emoji - full_shape - single_char # å‘¼å‡ºæ—¶æ˜¯å¦æŠ˜å  fold_options: false # æŠ˜å æ—¶æ˜¯å¦ç¼©å†™é€‰é¡¹ abbreviate_options: true # æŠ˜å æ—¶çš„é€‰é¡¹åˆ†éš”ç¬¦ option_list_separator: \u0026#39; | \u0026#39; # æ·»åŠ  , å’Œ . ç¿»é¡µ key_binder/bindings/+: - { when: paging, accept: comma, send: Page_Up } - { when: has_menu, accept: period, send: Page_Down } ä¿®æ”¹å®Œæˆåé‡æ–°éƒ¨ç½²å³å¯, åç»­æ›´æ”¹é…ç½®åŸºæœ¬åªéœ€è¦ä¿®æ”¹è¿™ä¸¤ä¸ªæ–‡ä»¶, æ›´æ–°æ–¹æ¡ˆç›´æ¥é€šè¿‡è¦†ç›–æ–‡ä»¶çš„æ–¹å¼è¿›è¡Œå…¨é‡æ›´æ–°\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/windowns-rime-input-method/","summary":"0 å‰è¨€ ç”¨äº†å¾ˆå¤šå¹´çš„æœç‹—è¾“å…¥æ³•, è‹¦äºè¶Šæ¥è¶Šå¤šçš„åå°, åˆæ¢åˆ°å¾®è½¯åŸç”Ÿçš„è¾“å…¥æ³•, ç»“æœåˆå‡ºç°äº† vscode vim ä¸­ä½¿ç”¨ä¸­æ–‡è¾“å…¥æ³•çš„æ—¶å€™ä¼šä¸€ç›´ä¹±è·³, é‚åˆäº§ç”Ÿäº†æ¢è¾“å…¥æ³•çš„æƒ³æ³• æˆ‘å¯¹è¾“å…¥æ³•çš„è¦æ±‚å¾ˆç®€å•: ç®€æ´æ–¹ä¾¿, åå°å¹²å‡€, è‡ªå¸¦è‰¯å¥½çš„è¯åº“å³å¯, æœ€åäº†è§£åˆ°äº†å°ç‹¼æ¯«è¾“å…¥æ³• (rime çš„ windows ç‰ˆæœ¬, åˆç§° rime weasel) åŠ  é›¾å‡‡æ–¹æ¡ˆ, å¯å®šåˆ¶é¡¹éå¸¸","title":"windows | rime è¾“å…¥æ³• \u0026 é›¾å‡‡æ–¹æ¡ˆ"},{"content":"#!/bin/bash username=\u0026#34;root\u0026#34; password=\u0026#34;123123\u0026#34; port=\u0026#34;22\u0026#34; # åˆ¤æ–­ipæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ if [ ! -f \u0026#34;./ip_check.txt\u0026#34; ]; then # æ¸…ç©ºæ£€æŸ¥æ–‡ä»¶ /usr/bin/true \u0026gt;./ip_check.txt else # åˆ›å»ºæ£€æŸ¥æ–‡ä»¶ /usr/bin/touch ./ip_check.txt fi # ä¼ è¾“æ–‡ä»¶ execut_ftp_file() { IFS=$\u0026#39;\\n\u0026#39; for file in $(cat ./ftp_file.conf); do /opt/sshpass/bin/sshpass -p $password scp -o StrictHostKeyChecking=no ./$file $username@$1:/opt/ echo \u0026#34;$1 ---- $file æ–‡ä»¶ä¼ è¾“å®Œæˆ\u0026#34; done } execut_commad_file() { IFS=$\u0026#39;\\n\u0026#39; for com in $(cat ./execut_commad.conf); do /opt/sshpass/bin/sshpass -p $password ssh -o StrictHostKeyChecking=no $username@$1 $com echo \u0026#34;$1 ---------- $com å‘½ä»¤æ‰§è¡Œå®Œæˆ\u0026#34; sleep 3 done } for line in $(cat ./ip.txt); do Ture_ip=$(/usr/bin/ping -c 2 $line) if [ $? != \u0026#34;0\u0026#34; ]; then echo \u0026#34;$line is blocked\u0026#34; \u0026gt;\u0026gt;./ip_check.txt else execut_ftp_file $line sleep 2 execut_commad_file $line fi done ","permalink":"https://www.lvbibir.cn/posts/tech/shell-sshpass-batch-execcute/","summary":"#!/bin/bash username=\u0026#34;root\u0026#34; password=\u0026#34;123123\u0026#34; port=\u0026#34;22\u0026#34; # åˆ¤æ–­ipæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ if [ ! -f \u0026#34;./ip_check.txt\u0026#34; ]; then # æ¸…ç©ºæ£€æŸ¥æ–‡ä»¶ /usr/bin/true \u0026gt;./ip_check.txt else # åˆ›å»ºæ£€æŸ¥æ–‡ä»¶ /usr/bin/touch ./ip_check.txt fi # ä¼ è¾“æ–‡ä»¶ execut_ftp_file() { IFS=$\u0026#39;\\n\u0026#39; for file in $(cat ./ftp_file.conf); do /opt/sshpass/bin/sshpass -p $password scp -o StrictHostKeyChecking=no ./$file $username@$1:/opt/ echo \u0026#34;$1 ---- $file æ–‡ä»¶ä¼ è¾“å®Œæˆ\u0026#34; done } execut_commad_file() { IFS=$\u0026#39;\\n\u0026#39; for com in $(cat ./execut_commad.conf); do /opt/sshpass/bin/sshpass -p $password ssh -o StrictHostKeyChecking=no $username@$1 $com echo \u0026#34;$1 ---------- $com å‘½ä»¤æ‰§è¡Œå®Œæˆ\u0026#34; sleep 3 done } for line in $(cat ./ip.txt); do Ture_ip=$(/usr/bin/ping -c 2 $line) if [ $? != \u0026#34;0\u0026#34; ]; then echo \u0026#34;$line is blocked\u0026#34;","title":"shell | sshpass æ‰¹é‡ä¼ è¾“æ–‡ä»¶åŠæ‰§è¡Œå‘½ä»¤"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\ndocker æ–‡æ¡£ - ä½¿ç”¨ä¾¿åˆ©æ€§è„šæœ¬è¿›è¡Œå®‰è£… docker engine docker æ–‡æ¡£ - é…ç½® http proxy è®°å½•ä¸€ä¸‹ wsl2 åŸç”Ÿ linux æ–¹å¼å®‰è£… docker çš„è¿‡ç¨‹\n1 å®‰è£… å®‰è£…è¿‡ç¨‹ä¸­ä¼šæç¤ºå»ºè®®ä½¿ç”¨ docker desktop, ç­‰å¾… 20s å³å¯\ncurl https://get.docker.com -o get-docker.sh sudo bash get-docker.sh sudo docker info å®‰è£…å®Œä¹‹å docker ä¼šé»˜è®¤å¼€æœºè‡ªå¯, ä¹‹åç®¡ç† docker ä½¿ç”¨ systemctl å³å¯\nsudo systemctl stop|start|restart docker 2 é…ç½® 2.1 ä¿®æ”¹é•œåƒæº proxies éƒ¨åˆ†å¯ä»¥ä¸ç”¨é…ç½®, å› ä¸ºæˆ‘è¿™é‡Œç¯å¢ƒç‰¹æ®Š, å¿…é¡»èµ°ä»£ç†æ‰èƒ½è®¿é—®äº’è”ç½‘\nsudo vim /etc/docker/daemon.json # æ·»åŠ å¦‚ä¸‹å†…å®¹ { \u0026#34;registry-mirrors\u0026#34;: [ \u0026#34;https://docker.mirrors.ustc.edu.cn\u0026#34;, \u0026#34;https://jc0srqak.mirror.aliyuncs.com\u0026#34;, \u0026#34;http://hub-mirror.c.163.com\u0026#34; ], \u0026#34;proxies\u0026#34;: { \u0026#34;http-proxy\u0026#34;: \u0026#34;http://proxy1.bj.petrochina:8080\u0026#34;, \u0026#34;https-proxy\u0026#34;: \u0026#34;http://proxy1.bj.petrochina:8080\u0026#34;, \u0026#34;no-proxy\u0026#34;: \u0026#34;localhost,127.0.0.0/8\u0026#34; } } sudo systemctl daemon-reload sudo systemctl restart docker sudo docker info # åº”çœ‹åˆ°é•œåƒä»“åº“ä¿¡æ¯å’Œä»£ç†ä¿¡æ¯ 2.2 docker-compose ä½¿ç”¨å®‰è£…è„šæœ¬å®Œåä¼šé»˜è®¤å®‰è£… docker-compose-plugin, å¯ä»¥ä½¿ç”¨ docker compose è°ƒç”¨, å¦‚æœä½ æ›´ä¹ æƒ¯ä½¿ç”¨ docker-compose, å¯ä»¥æ‰‹åŠ¨æ·»åŠ ä¸€ä¸‹è½¯è¿æ¥\nsudo ln -s /usr/libexec/docker/cli-plugins/docker-compose /usr/sbin/docker-compose sudo docker-compose --version 3 æµ‹è¯• æœ€åç®€å•æµ‹è¯•ä¸€ä¸‹\nmkdir docker; cd docker cat \u0026gt; docker-compose.yml \u0026lt;\u0026lt;-\u0026#39;EOF\u0026#39; version: \u0026#39;3.1\u0026#39; services: nginx: image: superng6/nginx:debian-stable-1.18.0 container_name: nginx restart: always ports: - 80:80 EOF sudo docker-compose up -d ç”±äº wsl2 è§£å†³äº†å’Œ windows ä½¿ç”¨ç›¸åŒçš„ç½‘ç»œ (é•œåƒç½‘ç»œ), æ‰€ä»¥å¯ä»¥ç›´æ¥é€šè¿‡ windows ç«¯æµè§ˆå™¨è®¿é—® http://localhost å³å¯è·³è½¬åˆ° docker ä¸­è¿è¡Œçš„ nginx å®¹å™¨\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/windows-wsl-6-docker/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: docker æ–‡æ¡£ - ä½¿ç”¨ä¾¿åˆ©æ€§è„šæœ¬è¿›è¡Œå®‰è£… docker engine docker æ–‡æ¡£ - é…ç½® http proxy è®°å½•ä¸€ä¸‹ wsl2 åŸç”Ÿ linux æ–¹å¼å®‰è£… docker çš„è¿‡ç¨‹ 1 å®‰è£… å®‰è£…è¿‡ç¨‹ä¸­ä¼šæç¤ºå»ºè®®ä½¿ç”¨ docker desktop, ç­‰å¾… 20s å³å¯ curl https://get.docker.com -o get-docker.sh sudo bash get-docker.sh sudo docker info å®‰è£…å®Œä¹‹å docker ä¼šé»˜è®¤å¼€æœºè‡ªå¯, ä¹‹åç®¡ç† docker ä½¿ç”¨ systemctl å³å¯ sudo systemctl stop|start|restart docker 2 é…ç½® 2.1 ä¿®æ”¹é•œåƒæº proxies éƒ¨åˆ†å¯ä»¥ä¸ç”¨é…ç½®, å› ä¸ºæˆ‘è¿™é‡Œç¯å¢ƒç‰¹","title":"wsl | åŸç”Ÿ linux æ–¹å¼å®‰è£… docker"},{"content":"0 å‰è¨€ åœ¨ wsl2 ä¸­å®‰è£…é…ç½® nodejs ç¯å¢ƒ, ä½¿ç”¨ nvm ç®¡ç†ç‰ˆæœ¬\n1 å®‰è£… # è‡ªåŠ¨è·å–æœ€æ–°ç‰ˆæœ¬çš„ nvm å¹¶å®‰è£… curl -o- \u0026#34;https://raw.githubusercontent.com/nvm-sh/nvm/$(curl -s https://api.github.com/repos/nvm-sh/nvm/releases/latest | grep \u0026#39;\u0026#34;tag_name\u0026#34;:\u0026#39; | sed -E \u0026#39;s/.*\u0026#34;([^\u0026#34;]+)\u0026#34;.*/\\1/\u0026#39;)/install.sh\u0026#34; | bash source ~/.bashrc # æˆ–è€…é‡æ–°è¿›ä¸€ä¸‹ç»ˆç«¯ nvm -v å®‰è£… nodejs\nnvm install --lts nvm use --lts node --version 2 é…ç½® 2.1 ä¿®æ”¹é»˜è®¤æºåœ°å€ npm config set registry https://registry.npmmirror.com npm config get registry 2.2 å®‰è£…ç»„ä»¶ npm install -g @anthropic-ai/claude-code npm install -g @google/gemini-cli npm install -g @openai/codex ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/windows-wsl-5-nodejs/","summary":"0 å‰è¨€ åœ¨ wsl2 ä¸­å®‰è£…é…ç½® nodejs ç¯å¢ƒ, ä½¿ç”¨ nvm ç®¡ç†ç‰ˆæœ¬ 1 å®‰è£… # è‡ªåŠ¨è·å–æœ€æ–°ç‰ˆæœ¬çš„ nvm å¹¶å®‰è£… curl -o- \u0026#34;https://raw.githubusercontent.com/nvm-sh/nvm/$(curl -s https://api.github.com/repos/nvm-sh/nvm/releases/latest | grep \u0026#39;\u0026#34;tag_name\u0026#34;:\u0026#39; | sed -E \u0026#39;s/.*\u0026#34;([^\u0026#34;]+)\u0026#34;.*/\\1/\u0026#39;)/install.sh\u0026#34; | bash source ~/.bashrc # æˆ–è€…é‡æ–°è¿›ä¸€ä¸‹ç»ˆç«¯ nvm -v å®‰è£… nodejs nvm install --lts nvm use --lts node --version 2 é…ç½® 2.1 ä¿®æ”¹é»˜è®¤æºåœ°å€ npm config set registry https://registry.npmmirror.com npm config get registry 2.2 å®‰è£…ç»„ä»¶ npm install -g @anthropic-ai/claude-code npm install -g @google/gemini-cli npm install -g @openai/codex ä»¥ä¸Š","title":"wsl | å®‰è£…é…ç½® nodejs ç¯å¢ƒ"},{"content":"0 å‰è¨€ ä¹‹å‰å†™è¿‡ä¸€ç¯‡ windows å®‰è£… miniconda çš„æ–‡ç« , åé¢åœ¨æ¥è§¦äº† wsl åå‘ç°ç”¨èµ·æ¥è¦æ¯”åœ¨åŸç”Ÿ windows ä¸Šèˆ’æœå¾ˆå¤š, æ¯•ç«Ÿæˆ‘å†™ python å¤šæ˜¯ä¸ºäº†åœ¨ linux æœåŠ¡å™¨ä¸Šè·‘, ç”¨ wsl ä¼šæ›´é¡ºæ»‘ä¸€äº›, è™šæ‹Ÿç¯å¢ƒåŒæ ·é€‰æ‹©æ›´è½»é‡çš„ miniconda\n1 å®‰è£… ä¸‹è½½å¹¶å®‰è£…, ä¸€è·¯ yes å³å¯\nwget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh sh Miniconda3-latest-Linux-x86_64.sh 2 é…ç½® ä¿®æ”¹ conda é…ç½®æ–‡ä»¶\ncat \u0026gt; ${HOME}/.condarc \u0026lt;\u0026lt;- \u0026#39;EOF\u0026#39; channels: - defaults show_channel_urls: true default_channels: - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/r - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/msys2 custom_channels: conda-forge: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud msys2: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud bioconda: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud menpo: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud pytorch: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud pytorch-lts: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud simpleitk: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud deepmodeling: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/ # ä¸è‡ªåŠ¨æ¿€æ´» base ç¯å¢ƒ auto_activate_base: false # è™šæ‹Ÿç¯å¢ƒå­˜æ”¾è·¯å¾„ envs_dirs: - /home/lvbibir/miniconda3/envs # pkg å­˜æ”¾è·¯å¾„ pkgs_dirs: - /home/lvbibir/miniconda3/pkgs EOF ä¸ºäº†ä¸æå conda çš„é»˜è®¤ base ç¯å¢ƒ, æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒ, æ¯æ¬¡é»˜è®¤è¿›è¿™ä¸ªè™šæ‹Ÿç¯å¢ƒ\nconda create -n py37 python=3.7 cat \u0026gt;\u0026gt; ${HOME}/.bash_profile \u0026lt;\u0026lt;- \u0026#39;EOF\u0026#39; conda deactivate conda activate py37 EOF é€€å‡ºé‡è¿›åå‘ç°å·²ç»é»˜è®¤æ¿€æ´» py37 äº†\næœ€åæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ pip çš„é…ç½®, æ·»åŠ æ¸…åæº\nmkdir ${HOME}/.pip cat \u0026gt; ${HOME}/.pip/pip.conf \u0026lt;\u0026lt;- \u0026#39;EOF\u0026#39; [global] timeout = 6000 index-url = http://pypi.tuna.tsinghua.edu.cn/simple trusted-host = pypi.tuna.tsinghua.edu.cn EOF pip config list æµ‹è¯•ä¸€ä¸‹ pip\npip install paramiko 3 è™šæ‹Ÿç¯å¢ƒ åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ\n# å®‰è£…ä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒ conda create -n py37 python=3.7 # ä»ç°æœ‰ç¯å¢ƒå¤åˆ¶ä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒ conda create -n py37-temp --clone py37 æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ\nconda activate py37 é€€å‡ºè™šæ‹Ÿç¯å¢ƒ\nconda deactivate æŸ¥çœ‹è™šæ‹Ÿç¯å¢ƒåˆ—è¡¨, å¸¦æœ‰ * çš„è¡Œå°±æ˜¯å½“å‰æ‰€å¤„çš„è™šæ‹Ÿç¯å¢ƒ\nconda env list åˆ é™¤è™šæ‹Ÿç¯å¢ƒ,\nconda env remove -n py37 4 å…¶ä»– conda æœ€ä¸ºäººè¯Ÿç—…çš„ç‚¹åº”è¯¥æ˜¯åŒ…ç®¡ç†è·Ÿ pip å¯èƒ½ä¼šäº§ç”Ÿä¸€äº›å†²çª, conda å®˜æ–¹ç»™å‡ºçš„æœ€ä½³æ–¹æ¡ˆæ˜¯\nå…¨ç¨‹ä½¿ç”¨ conda install æ¥å®‰è£…æ¨¡å—, å®åœ¨ä¸è¡Œå†ç”¨ pip ä½¿ç”¨ conda åˆ›å»ºå®Œè™šæ‹Ÿç¯å¢ƒå, ä¸€ç›´ç”¨ pip æ¥ç®¡ç†æ¨¡å— pip åº”ä½¿ç”¨ â€“upgrade-strategy only-if-needed å‚æ•°è¿è¡Œ, ä»¥é˜²æ­¢é€šè¿‡ conda å®‰è£…çš„è½¯ä»¶åŒ…è¿›è¡Œä¸å¿…è¦çš„å‡çº§. è¿™æ˜¯è¿è¡Œ pip æ—¶çš„é»˜è®¤è®¾ç½®, ä¸åº”æ›´æ”¹ ä¸è¦å°† pip ä¸ â€“user å‚æ•°ä¸€èµ·ä½¿ç”¨ï¼Œé¿å…æ‰€æœ‰ç”¨æˆ·å®‰è£… æ€»ç»“ä¸€ä¸‹å°±æ˜¯ä¸è¦æ¥å›åœ°ç”¨ pip å’Œ conda, ä¸“ä¸€ä¸€ç‚¹ (ç¬‘\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/windows-wsl-4-miniconda/","summary":"0 å‰è¨€ ä¹‹å‰å†™è¿‡ä¸€ç¯‡ windows å®‰è£… miniconda çš„æ–‡ç« , åé¢åœ¨æ¥è§¦äº† wsl åå‘ç°ç”¨èµ·æ¥è¦æ¯”åœ¨åŸç”Ÿ windows ä¸Šèˆ’æœå¾ˆå¤š, æ¯•ç«Ÿæˆ‘å†™ python å¤šæ˜¯ä¸ºäº†åœ¨ linux æœåŠ¡å™¨ä¸Šè·‘, ç”¨ wsl ä¼šæ›´é¡ºæ»‘ä¸€äº›, è™šæ‹Ÿç¯å¢ƒåŒæ ·é€‰æ‹©æ›´è½»é‡çš„ miniconda 1 å®‰è£… ä¸‹è½½å¹¶å®‰è£…, ä¸€è·¯ yes å³å¯ wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh sh Miniconda3-latest-Linux-x86_64.sh 2 é…ç½® ä¿®æ”¹ conda é…ç½®æ–‡ä»¶ cat \u0026gt; ${HOME}/.condarc \u0026lt;\u0026lt;- \u0026#39;EOF\u0026#39; channels: - defaults show_channel_urls: true default_channels: - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/r - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/msys2 custom_channels: conda-forge: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud msys2: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud bioconda: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud menpo: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud pytorch: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud pytorch-lts: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud simpleitk:","title":"wsl | å®‰è£…é…ç½® miniconda è™šæ‹Ÿç¯å¢ƒ"},{"content":"0 å‰è¨€ ç›®å‰æˆ‘ä½¿ç”¨ wsl è¿‡ç¨‹ä¸­æœ‰ä»¥ä¸‹ä¸¤ä¸ªåœºæ™¯éœ€è¦ä½¿ç”¨åˆ°ä»£ç†:\nåœºæ™¯ä¸€: æŸäº›ç§‘å­¦ä¸Šç½‘çš„åœºæ™¯, æ¯”å¦‚ github åŠ é€Ÿç­‰ åœºæ™¯äºŒ: å…¬å¸å†…ç½‘æœºå™¨éœ€è¦é€šè¿‡å…¬å¸æä¾›çš„ä»£ç†ä¸Šç½‘ é’ˆå¯¹åœºæ™¯ä¸€, å¯ä»¥é€šè¿‡å°†ä»£ç†è®¾ç½®ä¸º clash æˆ–è€…å…¶ä»–å®¢æˆ·ç«¯æä¾›çš„ç«¯å£, å¦‚ä½¿ç”¨ clash è®°å¾—æ‰“å¼€è®¾ç½®ä¸­çš„å…è®¸å±€åŸŸç½‘\né’ˆå¯¹åœºæ™¯äºŒ, ç›´æ¥è®¾ç½®å…¬å¸æä¾›çš„ä»£ç†åœ°å€å³å¯\n1 é…ç½®ä»£ç† wsl ä¸­æ·»åŠ å¦‚ä¸‹è„šæœ¬, å®ç°å…¨å±€çš„ç³»ç»Ÿä»£ç†, git çš„ http(s) ä»£ç†å’Œ ssh ä»£ç†, apt ä»£ç†, docker é•œåƒçš„ä»£ç†æŒ‰éœ€å¼€å¯, ä½¿ç”¨å›½å†…çš„åŠ é€Ÿç«™ä¹Ÿå¯\ncat \u0026gt; ~/proxy #!/bin/bash # æç¤ºç”¨æˆ·å¿…é¡»ä½¿ç”¨ source æ‰§è¡Œ if [ \u0026#34;$0\u0026#34; = \u0026#34;$BASH_SOURCE\u0026#34; ]; then echo \u0026#34;é”™è¯¯: è¯·ä½¿ç”¨ \u0026#39;source ~/proxy-unset\u0026#39; æˆ– \u0026#39;. ~/proxy-unset\u0026#39; æ¥æ‰§è¡Œæ­¤è„šæœ¬\u0026#34; echo \u0026#34;ç›´æ¥æ‰§è¡Œæ— æ³•æ¸…é™¤å½“å‰ shell çš„ç¯å¢ƒå˜é‡å’Œ alias\u0026#34; exit 1 fi # normal proxy # æŒ‡å®š url çš„æ–¹å¼ # proxy_type=\u0026#34;http\u0026#34; # proxy_ip=\u0026#34;proxy1.bj.petrochina\u0026#34; # proxy_port=\u0026#34;8080\u0026#34; # ä½¿ç”¨ windows ä¸»æœºä¸Šè¿è¡Œçš„ä»£ç†ç¨‹åº, ä¾‹å¦‚ clash # wsl ä¸­çš„åœ°å€æ˜¯ä¸å›ºå®šçš„, è¿™é‡Œé€šè¿‡è„šæœ¬è·å–, æ¯æ¬¡å¯åŠ¨ wsl éƒ½å¯ä»¥å®æ—¶æ›´æ–° proxy_type=\u0026#34;http\u0026#34; proxy_ip=$(cat /etc/resolv.conf |grep \u0026#34;nameserver\u0026#34; |cut -f 2 -d \u0026#34; \u0026#34;) proxy_port=\u0026#34;7890\u0026#34; proxy=\u0026#34;${proxy_type}://${proxy_ip}:${proxy_port}\u0026#34; # ç³»ç»Ÿå…¨å±€ä»£ç† export ALL_PROXY=\u0026#34;${proxy}\u0026#34; export all_proxy=\u0026#34;${proxy}\u0026#34; export http_proxy=\u0026#34;${proxy}\u0026#34; export https_proxy=\u0026#34;${proxy}\u0026#34; # docker ä»£ç† # åªåœ¨é…ç½®å˜åŒ–æ—¶æ‰æ›´æ–°å¹¶é‡å¯ docker docker_config=$(cat \u0026lt;\u0026lt;- EOF { \u0026#34;insecure-registries\u0026#34; : [\u0026#34;http://11.14.1.40\u0026#34;], \u0026#34;proxies\u0026#34;: { \u0026#34;http-proxy\u0026#34;: \u0026#34;${proxy}\u0026#34;, \u0026#34;https-proxy\u0026#34;: \u0026#34;${proxy}\u0026#34;, \u0026#34;no-proxy\u0026#34;: \u0026#34;localhost,127.0.0.0/8\u0026#34; } } EOF ) current_config=\u0026#34;\u0026#34; if [ -f /etc/docker/daemon.json ]; then current_config=$(sudo cat /etc/docker/daemon.json 2\u0026gt;/dev/null) fi if [ \u0026#34;$docker_config\u0026#34; != \u0026#34;$current_config\u0026#34; ]; then echo \u0026#34;$docker_config\u0026#34; | sudo tee /etc/docker/daemon.json \u0026gt; /dev/null sudo systemctl reset-failed docker 2\u0026gt;/dev/null sudo systemctl restart docker fi # apt ä»£ç† # å¦‚æœä¸åŠ  sudo, ä¼šå¯¼è‡´ç”¨ sudo æ‰§è¡Œ apt ç­‰å‘½ä»¤æ—¶æ— æ³•è¯†åˆ« alias alias sudo=\u0026#39;sudo \u0026#39; alias apt=\u0026#34;apt -o Acquire::http::proxy=${proxy}\u0026#34; alias apt-get=\u0026#34;apt-get -o Acquire::http::proxy=${proxy}\u0026#34; # git çš„ http æˆ–è€… https ä»£ç† git config --global http.https://github.com.proxy ${proxy} git config --global https.https://github.com.proxy ${proxy} # git çš„ ssh ä»£ç† tee ~/.ssh/config \u0026gt; /dev/null \u0026lt;\u0026lt;- EOF # git-bash ç¯å¢ƒ: ProxyCommand \u0026#34;C:\\\\APP\\\\Git\\\\mingw64\\\\bin\\\\connect\u0026#34; -S ${proxy_ip}:${proxy_port} -a none %h %p # Centos7 ç¯å¢ƒ: ProxyCommand ncat --proxy ${proxy_ip}:${proxy_port} --proxy-type ${proxy_type} %h %p # Ubuntu ç¯å¢ƒ: ProxyCommand nc -v -x ${proxy_ip}:${proxy_port} -X ${proxy_type} %h %p Host github.com User git Port 22 Hostname github.com ProxyCommand nc -v -x ${proxy_ip}:${proxy_port} %h %p IdentityFile \u0026#34;/home/lvbibir/.ssh/id_rsa\u0026#34; TCPKeepAlive yes EOF åŠ å…¥ç¯å¢ƒå˜é‡, æ¯æ¬¡å¯åŠ¨ wsl è‡ªåŠ¨è®¾ç½® proxy\ncat \u0026gt;\u0026gt; ~/.bashrc \u0026lt;\u0026lt;- \u0026#39;EOF\u0026#39; source ${HOME}/proxy EOF # æ‰‹åŠ¨è°ƒç”¨ source ~/proxy 2 å–æ¶ˆä»£ç† cat ~/proxy-unset #!/bin/bash # æç¤ºç”¨æˆ·å¿…é¡»ä½¿ç”¨ source æ‰§è¡Œ if [ \u0026#34;$0\u0026#34; = \u0026#34;$BASH_SOURCE\u0026#34; ]; then echo \u0026#34;é”™è¯¯: è¯·ä½¿ç”¨ \u0026#39;source ~/proxy-unset\u0026#39; æˆ– \u0026#39;. ~/proxy-unset\u0026#39; æ¥æ‰§è¡Œæ­¤è„šæœ¬\u0026#34; echo \u0026#34;ç›´æ¥æ‰§è¡Œæ— æ³•æ¸…é™¤å½“å‰ shell çš„ç¯å¢ƒå˜é‡å’Œ alias\u0026#34; exit 1 fi # æ¸…é™¤ç¯å¢ƒå˜é‡ unset http_proxy unset https_proxy unset all_proxy unset ALL_PROXY # docker ä»£ç† # åªåœ¨é…ç½®å˜åŒ–æ—¶æ‰æ›´æ–°å¹¶é‡å¯ docker docker_config=$(cat \u0026lt;\u0026lt;- \u0026#39;EOF\u0026#39; { \u0026#34;insecure-registries\u0026#34; : [\u0026#34;http://11.14.1.40\u0026#34;] } EOF ) current_config=\u0026#34;\u0026#34; if [ -f /etc/docker/daemon.json ]; then current_config=$(sudo cat /etc/docker/daemon.json 2\u0026gt;/dev/null) fi if [ \u0026#34;$docker_config\u0026#34; != \u0026#34;$current_config\u0026#34; ]; then echo \u0026#34;$docker_config\u0026#34; | sudo tee /etc/docker/daemon.json \u0026gt; /dev/null sudo systemctl reset-failed docker 2\u0026gt;/dev/null sudo systemctl restart docker echo \u0026#34;Docker é…ç½®å·²æ›´æ–°å¹¶é‡å¯\u0026#34; fi # æ¸…é™¤ alias unalias sudo 2\u0026gt;/dev/null unalias apt 2\u0026gt;/dev/null unalias apt-get 2\u0026gt;/dev/null # æ¸…é™¤ git çš„ http/https ä»£ç† git config --global --unset http.https://github.com.proxy 2\u0026gt;/dev/null git config --global --unset https.https://github.com.proxy 2\u0026gt;/dev/null # git çš„ ssh ä»£ç† tee ~/.ssh/config \u0026gt; /dev/null \u0026lt;\u0026lt;- EOF Host github.com User git Port 22 Hostname github.com IdentityFile \u0026#34;/home/lvbibir/.ssh/id_rsa\u0026#34; TCPKeepAlive yes EOF echo \u0026#34;ä»£ç†é…ç½®å·²æ¸…é™¤ (å½“å‰ shell ä¼šè¯)\u0026#34; echo \u0026#34;æ³¨æ„: æ–°å¼€çš„ shell ä¼šè¯ä»ä¼šé€šè¿‡ .bashrc åŠ è½½ proxy\u0026#34; # æ‰‹åŠ¨è°ƒç”¨ source ~/proxy-unset ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/windows-wsl-3-set-proxy/","summary":"0 å‰è¨€ ç›®å‰æˆ‘ä½¿ç”¨ wsl è¿‡ç¨‹ä¸­æœ‰ä»¥ä¸‹ä¸¤ä¸ªåœºæ™¯éœ€è¦ä½¿ç”¨åˆ°ä»£ç†: åœºæ™¯ä¸€: æŸäº›ç§‘å­¦ä¸Šç½‘çš„åœºæ™¯, æ¯”å¦‚ github åŠ é€Ÿç­‰ åœºæ™¯äºŒ: å…¬å¸å†…ç½‘æœºå™¨éœ€è¦é€šè¿‡å…¬å¸æä¾›çš„ä»£ç†ä¸Šç½‘ é’ˆå¯¹åœºæ™¯ä¸€, å¯ä»¥é€šè¿‡å°†ä»£ç†è®¾ç½®ä¸º clash æˆ–è€…å…¶ä»–å®¢æˆ·ç«¯æä¾›çš„ç«¯å£, å¦‚ä½¿ç”¨ clash è®°å¾—æ‰“å¼€è®¾ç½®ä¸­çš„å…è®¸å±€åŸŸç½‘ é’ˆå¯¹åœºæ™¯äºŒ, ç›´æ¥è®¾ç½®å…¬å¸æä¾›çš„ä»£ç†åœ°å€å³å¯ 1 é…","title":"wsl | è‡ªåŠ¨æ›´æ–°ç³»ç»Ÿä»£ç†"},{"content":"0 å‰è¨€ è£…å®Œ wsl åå‘ç°ç”¨æˆ·ç›®å½•ä¸‹çš„ .bashrc æ–‡ä»¶æ€»æ˜¯æ— æ³•æ­£å¸¸è¯»å–, github ä¸Šå…³äºæ­¤é—®é¢˜çš„ è®¨è®º ä¹Ÿæ²¡æœ‰æ¯”è¾ƒå¥½çš„è§£å†³æ–¹æ³•\n1 è§£å†³åŠæ³• æˆ‘è¿™é‡Œå–å·§äº†ä¸€ä¸‹, åœ¨ .bash_profile ä¸­å†è°ƒç”¨ä¸€ä¸‹ .bashrc, å¦‚ä¸‹\necho \u0026gt;\u0026gt; ${HOME}/.bash_profile \u0026lt;\u0026lt;- \u0026#39;EOF\u0026#39; source ${HOME}/.bashrc EOF source ${HOME}/.bash_profile ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/windows-wsl-2-bashrc/","summary":"0 å‰è¨€ è£…å®Œ wsl åå‘ç°ç”¨æˆ·ç›®å½•ä¸‹çš„ .bashrc æ–‡ä»¶æ€»æ˜¯æ— æ³•æ­£å¸¸è¯»å–, github ä¸Šå…³äºæ­¤é—®é¢˜çš„ è®¨è®º ä¹Ÿæ²¡æœ‰æ¯”è¾ƒå¥½çš„è§£å†³æ–¹æ³• 1 è§£å†³åŠæ³• æˆ‘è¿™é‡Œå–å·§äº†ä¸€ä¸‹, åœ¨ .bash_profile ä¸­å†è°ƒç”¨ä¸€ä¸‹ .bashrc, å¦‚ä¸‹ echo \u0026gt;\u0026gt; ${HOME}/.bash_profile \u0026lt;\u0026lt;- \u0026#39;EOF\u0026#39; source ${HOME}/.bashrc EOF source ${HOME}/.bash_profile ä»¥ä¸Š","title":"wsl | bashrc ç¯å¢ƒå˜é‡ä¸æ­£ç¡®åŠ è½½çš„å¤„ç†æ–¹æ³•"},{"content":"0 å‰è¨€ æœ¬æ–‡å†…å®¹å‚è€ƒä»¥ä¸‹é“¾æ¥:\nhttps://zhuanlan.zhihu.com/p/466001838 https://learn.microsoft.com/zh-cn/windows/wsl/install-manual ä»Šå¤©ä¸å°å¿ƒæŠŠæˆ‘ç”µè„‘çš„ wsl è¯¯åˆ äº†, åˆšå¥½é‡è£…è®°å½•ä¸€ä¸‹å®‰è£…æ­¥éª¤\n# è¿™ç§æ–¹å¼ä¼¼ä¹ä¹Ÿå¯ä»¥, æœªéªŒè¯ # https://linux.do/t/topic/1015067 wsl --install ubuntu-24.04 --name ubuntu-24.04 --location D:\\ubuntu 1 å®‰è£… 1.1 æ‰“å¼€ç³»ç»ŸåŠŸèƒ½ é¦–å…ˆé€šè¿‡ç®¡ç†å‘˜æ‰“å¼€ powershell æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤, ç”¨äºæ‰“å¼€ç³»ç»ŸåŠŸèƒ½\ndism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart ç„¶ååœ¨ Microsoft Store ä¸­å®‰è£… Windows Subsystem for Linux\nå®‰è£…å¥½ä¹‹åé‡å¯\né‡å¯å®Œæˆååœ¨ powershell æ‰§è¡Œ\nwsl --set-default-version 2 1.2 å®‰è£…å†…æ ¸æ›´æ–°åŒ… ç‚¹å‡» æ­¤é“¾æ¥ ä¸‹è½½å†…æ ¸æ›´æ–°åŒ…, å³å‡»å®‰è£…å³å¯\n1.3 å®‰è£… wsl åˆ° D ç›˜ å¦‚æœä¸éœ€è¦è£…åˆ°å…¶ä»–ç›˜, 1.3 çš„æ­¥éª¤æ— éœ€æ“ä½œ ç›´æ¥ powershell æ‰§è¡Œ wsl \u0026ndash;install -d Ubuntu-20.04 å³å¯\né€šè¿‡ chrome æˆ–è€… IDM è¾“å…¥ https://aka.ms/wslubuntu2004 ä¸‹è½½å®‰è£…åŒ…, chrome å¯èƒ½ä¼šæç¤ºæœªç»éªŒè¯, ç›´æ¥æ— è§†åä¿å­˜å³å¯\næˆ–è€…æ‰§è¡Œå¦‚ä¸‹ powershell å‘½ä»¤ä¸‹è½½\ncd D:\\ Invoke-WebRequest -Uri https://aka.ms/wslubuntu2004 -OutFile Ubuntu.appx -UseBasicParsing # æˆ–è€…ä½¿ç”¨ curl ä¸‹è½½ curl.exe -L -o ubuntu-2004.appx https://aka.ms/wslubuntu2004 å°†ä¸‹è½½åçš„æ–‡ä»¶åç¼€ç›´æ¥æ”¹ä¸º zip, , å†å°† x64 çš„ appx æ–‡ä»¶åç¼€æ”¹æˆ zip, å°†æ­¤ zip è§£å‹åˆ°æŒ‡å®šç›®å½•, æ­¤ç›®å½•å°±æ˜¯åç»­ ubuntu å­˜æ”¾æ•°æ®çš„åœ°æ–¹, æˆ‘è¿™é‡Œæ”¾åˆ°äº† D:\\ubuntu ç›®å½•\næœ€åæ‰§è¡Œè§£å‹åçš„ exe è¿›è¡Œå®‰è£…, æŒ‰ç…§æç¤ºè®¾ç½®è´¦å·å¯†ç å³å¯\ncd D:\\ubuntu .\\ubuntu2004.exe 1.4 æ›´æ¢ç³»ç»Ÿæº cmd æˆ–è€… powershell ä¸­æ‰§è¡Œ wsl è¿›å…¥ ubuntu, æ›´æ¢ç³»ç»Ÿæº\nsudo apt-get install --only-upgrade ca-certificates sudo cp /etc/apt/sources.list /etc/apt/sources.list.origin sudo cat \u0026gt; /etc/apt/sources.list \u0026lt;\u0026lt;- \u0026#39;EOF\u0026#39; deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse deb http://security.ubuntu.com/ubuntu/ focal-security main restricted universe multiverse EOF sudo apt-get update 2 é…ç½® 2.1 åå°ä¿æ´» å¦‚æœæ²¡æœ‰ä»»ä½•æ´»åŠ¨çš„ wsl ç»ˆç«¯, æ¯è¿‡ä¸€æ®µæ—¶é—´ windows ä¼šå°† wsl å…³é—­, å¯¼è‡´æƒ³è¦ä½¿ç”¨çš„æ—¶å€™éœ€è¦ç­‰å®ƒå¯åŠ¨ä¸€æ®µæ—¶é—´ä»¥åŠä¸€äº›å…¶ä»–çš„é—®é¢˜\nå¯ä»¥é€šè¿‡ vbs è„šæœ¬ç®€å•å®ç°è¿™ä¸ªåŠŸèƒ½\nSet shell = CreateObject(\u0026#34;WScript.Shell\u0026#34;) \u0026#39; è¿™é‡Œçš„ Ubuntu æ›¿æ¢æˆä½ å®é™…çš„å‘è¡Œç‰ˆåç§° \u0026#39; 0 ä»£è¡¨éšè—è¿è¡Œï¼ŒFalse ä»£è¡¨ä¸éœ€è¦ç­‰å¾…è¿›ç¨‹ç»“æŸ shell.Run \u0026#34;wsl.exe -d Ubuntu-20.04 -u root -- sleep infinity\u0026#34;, 0, False ç›´æ¥åŒå‡»è¿è¡Œå°±å¯ä»¥äº†, åå°ä¼šè·‘ä¸€ä¸ªæ— æ„Ÿçš„ wsl è¿›ç¨‹\nå¦‚æœéœ€è¦å¼€æœºè¿è¡Œå¯ä»¥æŠŠè¿™ä¸ª vbs è„šæœ¬æ”¾åˆ°å¼€æœºè‡ªå¯ç›®å½•ä¸­, é€šè¿‡ windows + r è°ƒå‡ºè¿è¡Œæ§åˆ¶å°, ç„¶åè¾“å…¥ shell:startup å›è½¦å³å¯æ‰“å¼€ windows è‡ªå¯åŠ¨ç›®å½•.\n2.2 alias é…ç½® cat .bashrc alias ll=\u0026#39;ls -l\u0026#39; alias di=\u0026#39;sudo docker images\u0026#39; alias dp=\u0026#39;sudo docker ps\u0026#39; alias dc=\u0026#39;sudo docker compose\u0026#39; alias python=\u0026#39;echo \u0026#34;dont use python! use uv run\u0026#34;\u0026#39; alias pip=\u0026#39;echo \u0026#34;dont use pip! use uv pip or uv add\u0026#34;\u0026#39; ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/windows-wsl-1-install/","summary":"0 å‰è¨€ æœ¬æ–‡å†…å®¹å‚è€ƒä»¥ä¸‹é“¾æ¥: https://zhuanlan.zhihu.com/p/466001838 https://learn.microsoft.com/zh-cn/windows/wsl/install-manual ä»Šå¤©ä¸å°å¿ƒæŠŠæˆ‘ç”µè„‘çš„ wsl è¯¯åˆ äº†, åˆšå¥½é‡è£…è®°å½•ä¸€ä¸‹å®‰è£…æ­¥éª¤ # è¿™ç§æ–¹å¼ä¼¼ä¹ä¹Ÿå¯ä»¥, æœªéªŒè¯ # https://linux.do/t/topic/1015067 wsl --install ubuntu-24.04 --name ubuntu-24.04 --location D:\\ubuntu 1 å®‰è£… 1.1 æ‰“å¼€ç³»ç»ŸåŠŸèƒ½ é¦–å…ˆé€šè¿‡ç®¡ç†å‘˜æ‰“å¼€ powershell æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤, ç”¨äºæ‰“å¼€ç³»ç»ŸåŠŸèƒ½ dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart ç„¶ååœ¨ Microsoft Store ä¸­å®‰è£… Windows Subsystem for Linux å®‰è£…å¥½ä¹‹åé‡å¯ é‡å¯å®Œæˆååœ¨ powershell æ‰§","title":"wsl | win10 å®‰è£… wsl2"},{"content":"0 å‰è¨€ å‰æ®µæ—¶é—´åœ¨é…ç½® jenkins publish over ssh æ—¶å‘ç° jenkins æ— æ³•è¿æ¥æŸä¸ªæœåŠ¡å™¨, ç»æµ‹è¯• ssh å¯ä»¥æ­£å¸¸ç™»å½•, ä½†æ˜¯ scp æ—¶æŠ¥é”™ subsystem request failed on channel 0, è®°å½•ä¸€ä¸‹è¿™ä¸ªé—®é¢˜çš„æ’æŸ¥æ€è·¯\n1 å¤§è‡´æ€è·¯ å½±å“åˆ° ssh çš„é…ç½®æ— éæ˜¯ä»¥ä¸‹è¿™äº›:\nç½‘ç»œé—®é¢˜: server å’Œ client ä¹‹é—´çš„ç½‘ç»œä¸é€šæˆ–è€…é˜²ç«å¢™é…ç½® è®¤è¯é—®é¢˜: è´¦å·å¯†ç æˆ–è€…å¯†é’¥é”™è¯¯ é…ç½®é—®é¢˜: server ç«¯æœ¬èº« sshd æœåŠ¡æŠ¥é”™æœªæ­£å¸¸ server ç«¯æ‹’ç» client çš„åŠ å¯†ç®—æ³•, å¸¸å‡ºç°åœ¨æ—§ç‰ˆæœ¬ ssh è¿æ¥é«˜ç‰ˆæœ¬æ—¶å‡ºç° server ç«¯æ‹’ç»æŸäº›ç”¨æˆ·çš„ç™»å½•, æ¯”å¦‚ç”Ÿäº§ç¯å¢ƒåŸºæœ¬éƒ½ç¦æ­¢ root ç™»å½• å¤§è‡´æ€è·¯æ˜¯å°½é‡æ‰¾ç›¸åŒé…ç½®çš„ server å’Œ client è¿›è¡Œäº¤å‰éªŒè¯å¯¹æ¯”, å®šä½é—®é¢˜ç‚¹, æ¶‰åŠåˆ°å¦‚ä¸‹å››ä¸ªè§’è‰², æœ¬æ¬¡æ•…éšœæ˜¯åœ¨ client-docker åœ¨ scp server-1 æ—¶å‡ºç°çš„\nè§’è‰² OS ç‰ˆæœ¬ ssh ç‰ˆæœ¬ å¤‡æ³¨ client-1 Centos 7.9 OpenSSH_7.4p1 client-docker docker container OpenSSH_9.2p1 fail server-1 Centos 7.9 OpenSSH_7.4p1 fail server-2 Centos 7.9 OpenSSH_7.4p1 ç»æµ‹è¯•, é™¤äº†ä¸Šè¿°æ•…éšœ, æ‰€æœ‰ client å¯¹æ‰€æœ‰ server æ‰§è¡Œ ssh æˆ–è€… scp éƒ½æ˜¯æ²¡æœ‰é—®é¢˜çš„, èƒ½ ssh æˆåŠŸå…¶å®å°±ä»£è¡¨å‡ºç°é—®é¢˜çš„åœ°æ–¹å¹¶ä¸æ˜¯æˆ‘ä»¬ä¹‹å‰é¢„æƒ³çš„é‚£äº›\n2 debug é‚£å°±çº³é—·äº†, å¹¸å¥½ scp å‘½ä»¤æä¾›äº† -v å‚æ•°, å¯ä»¥å±•ç¤ºå‡ºæ›´å¤šçš„ debug ä¿¡æ¯, äºæ˜¯ç€æ‰‹å°†å¼‚å¸¸ scp çš„ debug ä¿¡æ¯ä¸æ­£å¸¸ scp çš„ debug ä¿¡æ¯è¿›è¡Œå¯¹æ¯”, å¼€å§‹æ„‰å¿«çš„ æ‰¾ä¸åŒ ç¯èŠ‚\n(æ­£å¸¸æƒ…å†µ) client-1 scp server-1 çš„ debug ä¿¡æ¯\n# scp -v test app@server-1:/home/app/ ...... debug1: Authentication succeeded (password). Authenticated to 11.53.57.80 ([11.53.57.80]:22). debug1: channel 0: new [client-session] debug1: Requesting no-more-sessions@openssh.com debug1: Entering interactive session. debug1: pledge: network debug1: client_input_global_request: rtype hostkeys-00@openssh.com want_reply 0 debug1: Sending environment. debug1: Sending env LANG = en_US.UTF-8 debug1: Sending command: scp -v -t /home/app/ Sending file modes: C0644 0 test Sink: C0644 0 test test 100% 0 0.0KB/s 00:00 debug1: client_input_channel_req: channel 0 rtype exit-status reply 0 debug1: channel 0: free: client-session, nchannels 1 debug1: fd 0 clearing O_NONBLOCK debug1: fd 1 clearing O_NONBLOCK Transferred: sent 2120, received 2344 bytes, in 0.2 seconds Bytes per second: sent 12262.0, received 13557.6 debug1: Exit status 0 (æ­£å¸¸æƒ…å†µ) client-docker scp server-2 çš„ debug ä¿¡æ¯\n# scp -v test app@server-2:/home/app/ ...... Authenticated to 11.53.57.74 ([11.53.57.74]:22) using \u0026#34;password\u0026#34;. debug1: channel 0: new session [client-session] (inactive timeout: 0) debug1: Requesting no-more-sessions@openssh.com debug1: Entering interactive session. debug1: pledge: filesystem debug1: client_input_global_request: rtype hostkeys-00@openssh.com want_reply 0 debug1: client_input_hostkeys: searching /root/.ssh/known_hosts for 11.53.57.74 / (none) debug1: client_input_hostkeys: searching /root/.ssh/known_hosts2 for 11.53.57.74 / (none) debug1: client_input_hostkeys: hostkeys file /root/.ssh/known_hosts2 does not exist debug1: Sending environment. debug1: channel 0: setting env LANG = \u0026#34;C.UTF-8\u0026#34; debug1: Sending subsystem: sftp debug1: client_global_hostkeys_prove_confirm: server used untrusted RSA signature algorithm ssh-rsa for key 0, disregarding debug1: update_known_hosts: known hosts file /root/.ssh/known_hosts2 does not exist debug1: pledge: fork test 100% 0 0.0KB/s 00:00 scp: debug1: truncating at 0 debug1: client_input_channel_req: channel 0 rtype exit-status reply 0 debug1: channel 0: free: client-session, nchannels 1 Transferred: sent 3124, received 3084 bytes, in 0.0 seconds Bytes per second: sent 88478.9, received 87346.1 debug1: Exit status 0 (å¼‚å¸¸æƒ…å†µ) client-docker scp server-1 çš„ debug ä¿¡æ¯\n# scp -v test app@server-1:/home/app/ ...... Authenticated to 11.53.57.80 ([11.53.57.80]:22) using \u0026#34;password\u0026#34;. debug1: channel 0: new session [client-session] (inactive timeout: 0) debug1: Requesting no-more-sessions@openssh.com debug1: Entering interactive session. debug1: pledge: filesystem debug1: client_input_global_request: rtype hostkeys-00@openssh.com want_reply 0 debug1: client_input_hostkeys: searching /root/.ssh/known_hosts for 11.53.57.80 / (none) debug1: client_input_hostkeys: searching /root/.ssh/known_hosts2 for 11.53.57.80 / (none) debug1: client_input_hostkeys: hostkeys file /root/.ssh/known_hosts2 does not exist debug1: Sending environment. debug1: channel 0: setting env LANG = \u0026#34;C.UTF-8\u0026#34; debug1: Sending subsystem: sftp debug1: client_global_hostkeys_prove_confirm: server used untrusted RSA signature algorithm ssh-rsa for key 0, disregarding debug1: update_known_hosts: known hosts file /root/.ssh/known_hosts2 does not exist debug1: pledge: fork subsystem request failed on channel 0 scp: Connection closed æ’é™¤å†—ä½™ä¿¡æ¯åå¯ä»¥å‘ç°:\n(æ­£å¸¸æƒ…å†µ) client-1 scp server-1 çš„ debug ä¿¡æ¯ä¸­, Sending environment ä¹‹åçš„æ­¥éª¤æ˜¯ Sending command: scp -v -t /home/app/ (æ­£å¸¸æƒ…å†µ) client-docker scp server-2 çš„ debug ä¿¡æ¯ä¸­, Sending environment ä¹‹åçš„æ­¥éª¤æ˜¯ Sending subsystem: sftp (å¼‚å¸¸æƒ…å†µ) client-docker scp server-1 çš„ debug ä¿¡æ¯ä¸­, Sending environment ä¹‹åçš„æ­¥éª¤æ˜¯ Sending subsystem: sftp, ä½†æ˜¯ subsystem request failed å¯ä»¥æ¨æ–­å‡ºé—®é¢˜ç‚¹åœ¨äº scp çš„æµç¨‹ä¸­è°ƒç”¨äº† sftp, ä½†ç”±äº sftp çš„æŸäº›åŸå› å¯¼è‡´å‡ºç°äº†é—®é¢˜\n3 sftp é‚å»å¯¹æ¯”ä¸€ä¸‹ä¸¤ä¸ª server çš„ ssh é…ç½®ä¸­å…³äº sftp çš„é…ç½®\næ­£å¸¸ server çš„é…ç½®\n# grep -i \u0026#39;sftp\u0026#39; /etc/ssh/sshd_config #Subsystem sftp /usr/libexec/openssh/sftp-server Subsystem sftp internal-sftp Match Group sftp ChrootDirectory /data/sftp/mysftp ForceCommand internal-sftp å¼‚å¸¸ server çš„é…ç½®\n# grep -i \u0026#39;sftp\u0026#39; /etc/ssh/sshd_config #Subsystem sftp /usr/libexec/openssh/sftp-server å¯ä»¥çœ‹åˆ°å¼‚å¸¸ server çš„ sftp æ˜¯æ²¡å¼€çš„\nå»æ‰ sftp çš„æ³¨é‡Šåé‡å¯ sshd, å†æ¬¡è¿›è¡Œå°è¯•åä¸å‡ºæ„æ–™åœ°æ¢å¤æ­£å¸¸äº†\n4 æ€»ç»“ è‡³æ­¤, æˆ‘ä»¬å¯ä»¥ç¡®å®šé—®é¢˜ç‚¹æ˜¯ç”±äº scp ä¸­ä½¿ç”¨ sftp åè®®è¿›è¡Œä¼ è¾“, è€Œ server ç«¯æœªå¼€å¯ sftp å¯¼è‡´ scp å¤±è´¥\næœ€åå°±æ˜¯ç¡®è®¤ä¸€ä¸‹ä¸ºä»€ä¹ˆ scp ä¼šè°ƒç”¨ sftp, åœ¨ openssh 9.0p1 release ä¸­å‘ç°å¦‚ä¸‹è¯´æ˜:\nThis release switches scp(1) from using the legacy scp/rcp protocol to using the SFTP protocol by default.\nä» 9.0p1 å¼€å§‹, scp å°†é»˜è®¤ä½¿ç”¨ sftp è¿›è¡Œä¼ è¾“, å¯ä»¥ä½¿ç”¨ -O é€‰é¡¹ä½¿ scp ä½¿ç”¨ legacy SCP protocol è¿›è¡Œä¼ è¾“\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/troubleshooting-ssh-success-but-scp-failed/","summary":"0 å‰è¨€ å‰æ®µæ—¶é—´åœ¨é…ç½® jenkins publish over ssh æ—¶å‘ç° jenkins æ— æ³•è¿æ¥æŸä¸ªæœåŠ¡å™¨, ç»æµ‹è¯• ssh å¯ä»¥æ­£å¸¸ç™»å½•, ä½†æ˜¯ scp æ—¶æŠ¥é”™ subsystem request failed on channel 0, è®°å½•ä¸€ä¸‹è¿™ä¸ªé—®é¢˜çš„æ’æŸ¥æ€è·¯ 1 å¤§è‡´æ€è·¯ å½±å“åˆ° ssh çš„é…ç½®æ— éæ˜¯ä»¥ä¸‹è¿™äº›: ç½‘ç»œé—®é¢˜: server å’Œ client ä¹‹é—´çš„ç½‘ç»œä¸é€šæˆ–è€…é˜²ç«å¢™é…ç½® è®¤è¯é—®é¢˜: è´¦å·å¯†ç æˆ–è€…å¯†é’¥é”™è¯¯ é…ç½®é—®é¢˜: server ç«¯æœ¬èº« sshd æœåŠ¡æŠ¥é”™æœªæ­£å¸¸ server ç«¯","title":"troubleshooting | ssh æˆåŠŸä½†æ˜¯ scp å¤±è´¥"},{"content":"1 æ–‡æœ¬å¤„ç† 1.1 sed æˆªå– rpm åŒ…å\ncat rpms | sed -e s/-[[:digit:]]./@/ | awk -F \u0026#39;@\u0026#39; \u0026#39;{print $1}\u0026#39; 1.2 awk # æ‰“å°æŸåˆ—ä¹‹åçš„æ‰€æœ‰åˆ— awk â€˜{ $1=\u0026#34;\u0026#34;; print $0 }â€™ file_name 1.3 grep # å»é™¤æ³¨é‡Šå’Œç©ºè¡Œ grep -Ev \u0026#39;^$|#\u0026#39; filename # æŸ¥æ‰¾ä¸€ä¸ªç›®å½•ä¸­ä¸åŒ…å« \u0026#34;description\u0026#34; çš„æ–‡ä»¶ grep -Lr \u0026#34;description\u0026#34; /your/directory/* # æŸ¥æ‰¾ä¸€ä¸ªç›®å½•ä¸­åŒ…å« \u0026#34;title\u0026#34; ä½†æ˜¯ä¸åŒ…å« \u0026#34;description\u0026#34; çš„æ–‡ä»¶ grep -r -l \u0026#39;title\u0026#39; /your/directory/* | xargs grep -L \u0026#39;description\u0026#39; 1.4 tee # \u0026lt;\u0026lt; EOF è¦æ±‚ç»“æŸç¬¦ EOF å¿…é¡»é¡¶æ ¼å†™ä¸”å•ç‹¬ä¸€è¡Œ # \u0026lt;\u0026lt;- EOF å…è®¸ç»“æŸç¬¦ EOF ä¹‹å‰å­˜åœ¨åˆ¶è¡¨ç¬¦ # EOF ä¸åŠ å¼•å·, ä¼šè¿›è¡Œå˜é‡æ‰©å±• # \u0026#39;EOF\u0026#39; åŠ å¼•å·, ä¸ä¼šè¿›è¡Œå˜é‡æ‰©å±• tee test.txt \u0026lt;\u0026lt;- \u0026#39;EOF\u0026#39; line 1 line 2 EOF 2 ç³»ç»Ÿè¿›ç¨‹ 2.1 ps # æŸ¥çœ‹è·å–æœåŠ¡å™¨å†…å­˜å ç”¨å†…å­˜è¾ƒé«˜çš„10ä¸ªè¿›ç¨‹ ps aux | head -1; ps aux | grep -v PID | sort -rn -k +4 | head -10 # æŸ¥çœ‹è·å–æœåŠ¡å™¨ CPU å ç”¨å†…å­˜è¾ƒé«˜çš„10ä¸ªè¿›ç¨‹ ps aux | head -1; ps aux | grep -v PID | sort -rn -k +3 | head -10 # æŸ¥çœ‹è¿›ç¨‹å¯åŠ¨æ—¶é—´ ps -eo pid,lstart,etime,cmd | grep java | grep 8082 3 ç½‘ç»œ 3.1 traceroute # tcp traceroute -n -T -p \u0026lt;port\u0026gt; \u0026lt;ip\u0026gt; tcptraceroute \u0026lt;ip\u0026gt; \u0026lt;port\u0026gt; # udp traceroute -n -U -p \u0026lt;port\u0026gt; \u0026lt;ip\u0026gt; 3.2 nc # tcp nc -zvw 5 10.30.214.22 7001 # udp nc -zvuw 5 11.53.89.7 5030 4 other 4.1 find # æŸ¥æ‰¾æ–‡ä»¶å¹¶åˆ é™¤ find . -type f -name \u0026#39;*flac\u0026#39; -print0| xargs -0 rm -f # æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶çš„æ–‡ä»¶ç±»å‹ find . -type f -exec file \u0026#34;{}\u0026#34; \u0026#34;;\u0026#34; | awk -F \u0026#39;: \u0026#39; \u0026#39;$2 !~ /ASCII/ {print $1 \u0026#34;: \u0026#34; $2}\u0026#39; # å°†ç›®å½•å†…æ‰€æœ‰çš„ crlf æ–‡ä»¶è½¬ä¸º lf find . -type f -exec file \u0026#34;{}\u0026#34; \u0026#34;;\u0026#34; | awk -F \u0026#39;: \u0026#39; \u0026#39;$2 !~ /ASCII/ {print $1 \u0026#34;: \u0026#34; $2}\u0026#39; | grep CRLF | awk -F\u0026#39;:\u0026#39; \u0026#39;{print $1}\u0026#39; | xargs dos2unix # æŸ¥çœ‹ç›®å½•ä¸‹30å¤©å†…æœªæ”¹åŠ¨çš„æ–‡ä»¶ find /var/log -type f -mtime +30 # åˆ é™¤ç›®å½•ä¸‹30å¤©å†…æœªæ”¹åŠ¨çš„æ–‡ä»¶ find /var/log -type f -mtime +30 -delete # æŸ¥æ‰¾ä¸€çº§ç›®å½•ä¸‹çš„äºŒçº§ç›®å½•åŒ…å«çš„ä¸‰çº§ç›®å½•æ•°é‡ for dir in $(ls /home/media/media/500509/servicerecord); do echo $dir $(find $dir -maxdepth 1 -type d | wc -l); done | sort -nk2 4.2 tar xz å¤šæ ¸å‹ç¼©\n# å¤šæ ¸å‹ç¼© tar cf - linux-3.10.0-327.36.4.el7/ | xz -4e -T8 \u0026gt; linux-3.10.0-327.36.4.el7.tar.xz rpm -qpi \u0026lt;rpm_pkg\u0026gt; --changelog rpm -qi \u0026lt;installed_pkg\u0026gt; --changelog cat /root/rpmbuild/SOURCES/openssh-5.8p1-packet.patch | patch -p1 -b --suffix .packet --fuzz=0 4.3 rsync # å°† test1 ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å’Œç›®å½•å¤åˆ¶è¿› test2, å¦‚æœ test1 åé¢æ²¡æœ‰è·Ÿ /, åˆ™è¡¨ç¤ºå°† test1 ç›®å½•å¤åˆ¶è¿› test2 rsync -avuzc test1/* test2/ # ä½¿ test1 ä¸ test2 ç›®å½•å®Œå…¨åŒæ­¥ rsync -avzc --delete test1/* test2/ 4.4 du # æŸ¥çœ‹ç›®å½•å†…æ–‡ä»¶å’Œå­ç›®å½•çš„å¤§å°å¹¶æŒ‰ç…§å¤§å°æ’åº du -sh ./* | sort -rh | head 4.5 ç½®ç©º docker å®¹å™¨æ—¥å¿— container_name_or_id=\u0026#34;acs-admin-web\u0026#34; \u0026amp;\u0026amp; cid=$(docker inspect --format=\u0026#39;{{.Id}}\u0026#39; $container_name_or_id 2\u0026gt;/dev/null) \u0026amp;\u0026amp; sudo truncate -s 0 /var/lib/docker/containers/$cid/$cid-json.log ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/linux-offen-used-command/","summary":"1 æ–‡æœ¬å¤„ç† 1.1 sed æˆªå– rpm åŒ…å cat rpms | sed -e s/-[[:digit:]]./@/ | awk -F \u0026#39;@\u0026#39; \u0026#39;{print $1}\u0026#39; 1.2 awk # æ‰“å°æŸåˆ—ä¹‹åçš„æ‰€æœ‰åˆ— awk â€˜{ $1=\u0026#34;\u0026#34;; print $0 }â€™ file_name 1.3 grep # å»é™¤æ³¨é‡Šå’Œç©ºè¡Œ grep -Ev \u0026#39;^$|#\u0026#39; filename # æŸ¥æ‰¾ä¸€ä¸ªç›®å½•ä¸­ä¸åŒ…å« \u0026#34;description\u0026#34; çš„æ–‡ä»¶ grep -Lr \u0026#34;description\u0026#34; /your/directory/* # æŸ¥æ‰¾ä¸€ä¸ªç›®å½•ä¸­åŒ…å« \u0026#34;title\u0026#34; ä½†æ˜¯ä¸åŒ…å« \u0026#34;description\u0026#34; çš„æ–‡ä»¶ grep -r -l \u0026#39;title\u0026#39; /your/directory/* | xargs grep -L \u0026#39;description\u0026#39; 1.4 tee # \u0026lt;\u0026lt; EOF è¦æ±‚ç»“æŸç¬¦ EOF å¿…é¡»é¡¶æ ¼å†™ä¸”å•ç‹¬ä¸€è¡Œ # \u0026lt;\u0026lt;- EOF å…è®¸ç»“æŸç¬¦ EOF ä¹‹","title":"linux | å¸¸ç”¨å‘½ä»¤æ€»ç»“"},{"content":"0 å‰è¨€ æ„Ÿè°¢ piclist ä½œè€…çš„ ä¸åè§£ç­”\næœ€è¿‘ä» typora è¿ç§»åˆ°äº† obsidian, typora å¯ä»¥å¾ˆæ–¹ä¾¿çš„è‡ªåŠ¨è°ƒç”¨ picgo å®ç°å›¾ç‰‡ä¸Šä¼ , obsidian å¾—ç›Šäºä¸°å¯Œçš„æ’ä»¶å¸‚åœº, å¯ä»¥é€šè¿‡ Image Auto Upload Plugin æ’ä»¶è°ƒç”¨ picgo, ä½†æ˜¯å¿…é¡»æ‰‹åŠ¨å¯åŠ¨ picgo åæ‰èƒ½æ­£å¸¸ä½¿ç”¨\nåœ¨æ’ä»¶é…ç½®çš„æ³¨é‡Šä¸­å‘ç°äº† piclist, ç»äº†è§£å‘ç°è¿™ä¸ªäºŒå¼€ç‰ˆæœ¬æ”¯æŒ docker éƒ¨ç½², ç»¼åˆè€ƒè™‘äº†ä¸€ä¸‹è¿˜æ˜¯å€¼å¾—æŠ˜è…¾ä¸€ä¸‹çš„, æ—¢èƒ½é¿å…æ‰‹åŠ¨æ‰“å¼€ picgo çš„ç¹ç, ä¹Ÿå¯ä»¥åœ¨æˆ‘æ‰€æœ‰çš„ pc ä¸Šå¸è½½æ‰ä¸€ä¸ªè½¯ä»¶, åŒæ—¶è¿˜èƒ½æ°´ä¸€æ–‡\næ³¨æ„æœ¬æ–‡ä»¥å·²æœ‰æœåŠ¡å™¨/ip/åŸŸåä¸” web æœåŠ¡ä½¿ç”¨ nginx ä¸ºå‰æ, å¦‚æœä¸æ»¡è¶³ä¸Šè¿°å‰æ, éœ€è¦å°† piclist çš„ 36677 ç«¯å£æ˜ å°„åˆ°ä¸»æœº, éƒ¨ç½²å®Œ piclist åç›´æ¥é€šè¿‡ ip åŠ ç«¯å£çš„å½¢å¼è°ƒç”¨å³å¯\n1 éƒ¨ç½² 1.1 piclist é…ç½® docker-compose.yml ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®\nversion: \u0026#39;3.1\u0026#39; services: piclist: image: \u0026#39;kuingsmile/piclist:v1.7.0\u0026#39; container_name: piclist restart: always networks: blog_net: ipv4_address: 172.19.0.5 volumes: - \u0026#39;$PWD/data/piclist:/root/.piclist\u0026#39; # éœ€è¦åœ¨ .env æ–‡ä»¶ä¸­é…ç½®ç¯å¢ƒå˜é‡ env_file: - .env command: node /usr/local/bin/picgo-server -k ${piclist_key} networks: blog_net: driver: bridge ipam: config: - subnet: 172.19.0.0/16 æ·»åŠ  .env ç¯å¢ƒå˜é‡æ–‡ä»¶å¹¶å¯åŠ¨ piclist å®¹å™¨, æ­¤ç¯å¢ƒå˜é‡ç”¨äº client(obsidian) å’Œ piclist server ä¹‹é—´çš„é‰´æƒ\n# å°† 123456 è®¾ç½®ä¸ºè‡ªå®šä¹‰çš„å¯†ç  cat \u0026gt; .env \u0026lt;\u0026lt;-\u0026#39;EOF\u0026#39; # PicList é…ç½® # è¯·ä¿®æ”¹ä¸ºä½ çš„å®é™… key å€¼ piclist_key=\u0026#39;123456\u0026#39; EOF docker-compose up -d ä¿®æ”¹ data/piclist/config.json çš„é…ç½®, ä»¥é˜¿é‡Œäº‘ OSS ä¸ºä¾‹æ·»åŠ å›¾åºŠé…ç½®, å†…å®¹è‡ªè¡Œä¿®æ”¹, å®˜æ–¹æ²¡æœ‰é…ç½®æ–‡ä»¶çš„è¯¦ç»†æ–‡æ¡£, å¯ä»¥æŠ˜ä¸­ä¸€ä¸‹, å…ˆ windows å®‰è£… piclist, æµ‹è¯•æ— è¯¯åå¯¼å‡ºé…ç½®\n{ \u0026#34;picBed\u0026#34;: { \u0026#34;current\u0026#34;: \u0026#34;aliyun\u0026#34;, \u0026#34;uploader\u0026#34;: \u0026#34;aliyun\u0026#34;, \u0026#34;aliyun\u0026#34;: { \u0026#34;accessKeyId\u0026#34;: \u0026#34;******\u0026#34;, \u0026#34;accessKeySecret\u0026#34;: \u0026#34;******\u0026#34;, \u0026#34;bucket\u0026#34;: \u0026#34;lvbibir-image\u0026#34;, \u0026#34;area\u0026#34;: \u0026#34;oss-cn-beijing\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;blog/\u0026#34;, \u0026#34;customUrl\u0026#34;: \u0026#34;https://image.lvbibir.cn\u0026#34;, \u0026#34;options\u0026#34;: \u0026#34;\u0026#34; } }, \u0026#34;picgoPlugins\u0026#34;: {} } æœ€åå†é‡å¯ä¸€ä¸‹ piclist\ndocker restart piclist 1.2 nginx é…ç½® nginx ä¸­æ·»åŠ å¦‚ä¸‹ location é…ç½®\nlocation /piclist/ { proxy_pass http://172.19.0.5:36677/; proxy_redirect off; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Real-Port $remote_port; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header HTTP_X_FORWARDED_FOR $remote_addr; proxy_set_header X-Forwarded-Proto $scheme; proxy_set_header Host $host; proxy_set_header X-NginX-Proxy true; proxy_set_header Accept-Encoding \u0026#34;br\u0026#34;; } æ‰§è¡Œ docker restart nginx-proxy é‡å¯ nginx\næœ€åä¿®æ”¹ obsidian çš„ Image auto upload Plugin æ’ä»¶çš„é…ç½®\næ‰“å¼€è¿œç¨‹æœåŠ¡å™¨æ¨¡å¼ å°†æ¥å£ url è®¾ç½®ä¸º https://\u0026lt;ä½ çš„åŸŸå\u0026gt;/piclist/upload?key=\u0026lt;ä½ çš„key\u0026gt;, è¿™é‡Œçš„ key å°±æ˜¯å¯åŠ¨å®¹å™¨æ—¶é…ç½®çš„ç¯å¢ƒå˜é‡çš„å€¼, éœ€æ³¨æ„å¦‚æœ key ä¸­æœ‰ç‰¹æ®Šå­—ç¬¦éœ€è¦ url è½¬ä¹‰ä¸€ä¸‹ æœ€åæµ‹è¯•ä¸€ä¸‹å›¾ç‰‡ä¸Šä¼ å³å¯, å¦‚æœæœ‰æŠ¥é”™å¯ä»¥é€šè¿‡ docker logs -f piclist æŸ¥çœ‹æ—¥å¿—\n2 å¸¸è§é—®é¢˜ 2.1 ä¸Šä¼ å¤±è´¥ obsdian ç›´æ¥æç¤ºä¸Šä¼ å¤±è´¥, å¯èƒ½æ˜¯ key ä¸­æœ‰ç‰¹æ®Šå­—ç¬¦æ²¡æœ‰è½¬ä¹‰æˆ–è€…æ²¡æœ‰æ‰“å¼€è¿œç¨‹æœåŠ¡å™¨æ¨¡å¼ æ—¥å¿—ä¸­æœ‰å¦‚ä¸‹ Unauthorized access æŠ¥é”™, ä¸€èˆ¬æ˜¯ key ä¸åŒ¹é… 2.2 å¿˜è®° piclist_key å¦‚æœå·²ç»å¯åŠ¨äº†çš„å®¹å™¨å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹\ndocker exec -it piclist ps -ef | grep -v grep | grep node ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/blog/docker-deploy-piclist/","summary":"0 å‰è¨€ æ„Ÿè°¢ piclist ä½œè€…çš„ ä¸åè§£ç­” æœ€è¿‘ä» typora è¿ç§»åˆ°äº† obsidian, typora å¯ä»¥å¾ˆæ–¹ä¾¿çš„è‡ªåŠ¨è°ƒç”¨ picgo å®ç°å›¾ç‰‡ä¸Šä¼ , obsidian å¾—ç›Šäºä¸°å¯Œçš„æ’ä»¶å¸‚åœº, å¯ä»¥é€šè¿‡ Image Auto Upload Plugin æ’ä»¶è°ƒç”¨ picgo, ä½†æ˜¯å¿…é¡»æ‰‹åŠ¨å¯åŠ¨ picgo åæ‰èƒ½æ­£å¸¸ä½¿ç”¨ åœ¨æ’ä»¶é…ç½®çš„æ³¨é‡Šä¸­å‘ç°äº† piclist, ç»äº†è§£å‘ç°è¿™ä¸ªäºŒå¼€ç‰ˆæœ¬æ”¯æŒ docker éƒ¨ç½², ç»¼åˆè€ƒè™‘äº†ä¸€ä¸‹è¿˜æ˜¯å€¼å¾—æŠ˜è…¾ä¸€ä¸‹çš„, æ—¢èƒ½é¿å…æ‰‹åŠ¨æ‰“å¼€ picgo çš„ç¹","title":"docker éƒ¨ç½² piclist"},{"content":"è„šæœ¬å†…å®¹å¦‚ä¸‹, æ›¿æ¢é’‰é’‰ bot çš„ token, å°†è„šæœ¬æ”¾è‡³ crontab æ‰§è¡Œå³å¯\n#!/bin/bash export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin # è®¾ç½®è¦æ£€æµ‹çš„ç½‘é¡µURL urls=(\u0026#34;https://emp.cnpc.com.cn/index.html\u0026#34; \u0026#34;https://mdm.cnpc.com.cn/\u0026#34;) #urls=(\u0026#34;https://emp.cnpc.com.cn/index.html\u0026#34; \u0026#34;https://mdm.cnpc.com.cn/\u0026#34; \u0026#34;https://www.956100.com\u0026#34; \u0026#34;https://mm.956100.com\u0026#34; \u0026#34;https://app.956100.com\u0026#34;) # é’‰é’‰æœºå™¨äººçš„ webhook åœ°å€ webhook=\u0026#34;https://oapi.dingtalk.com/robot/send?access_token=******************************\u0026#34; # æœ€å¤§è¿ç»­æ— æ³•è®¿é—®æ¬¡æ•° max_attempts=3 # è®¾ç½®å¹¶å‘è¿›ç¨‹æ•°ä¸º URL æ•°é‡ max_concurrent=${#urls[@]} # åˆå§‹åŒ–è®¡æ•°å™¨ completed=0 for url in \u0026#34;${urls[@]}\u0026#34;; do # åœ¨åå°å¯åŠ¨ä¸€ä¸ªå­è¿›ç¨‹è¿›è¡Œæµ‹è¯• ( attempts=0 while [ $attempts -lt $max_attempts ]; do # ä½¿ç”¨curlè·å–ç½‘é¡µå†…å®¹ï¼Œå¹¶ä¿å­˜HTTPçŠ¶æ€ç åˆ°å˜é‡response_code response_code=$(curl -s --connect-timeout 5 -o /dev/null -w \u0026#34;%{http_code}\u0026#34; \u0026#34;$url\u0026#34;) # åˆ¤æ–­HTTPçŠ¶æ€ç æ¥ç¡®å®šç½‘é¡µæ˜¯å¦å¯è®¿é—® if [ \u0026#34;$response_code\u0026#34; -eq 200 ]; then break else attempts=$((attempts + 1)) fi if [ $attempts -ge $max_attempts ]; then message=\u0026#34;å‘Šè­¦: $(date +\u0026#34;%Yå¹´%mæœˆ%dæ—¥-%H:%M:%S\u0026#34;) ${url} ç½‘é¡µæ— æ³•è®¿é—®ï¼ŒHTTPçŠ¶æ€ç : $response_code\u0026#34; curl -X POST ${webhook} -H \u0026#34;Content-Type: application/json\u0026#34; -d \u0026#34;{\\\u0026#34;msgtype\\\u0026#34;: \\\u0026#34;text\\\u0026#34;, \\\u0026#34;text\\\u0026#34;: {\\\u0026#34;content\\\u0026#34;:\\\u0026#34;$message\\\u0026#34;}}\u0026#34; break fi sleep 60 # ç­‰å¾… 20 ç§’åå†æ¬¡å°è¯• done completed=$((completed + 1)) ) \u0026amp; # æ§åˆ¶å¹¶å‘è¿›ç¨‹æ•° if [ $completed -ge $max_concurrent ]; then wait completed=0 fi done # ç­‰å¾…å‰©ä½™çš„å¹¶å‘è¿›ç¨‹å®Œæˆ wait exit 0 ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/shell-check-website-available/","summary":"è„šæœ¬å†…å®¹å¦‚ä¸‹, æ›¿æ¢é’‰é’‰ bot çš„ token, å°†è„šæœ¬æ”¾è‡³ crontab æ‰§è¡Œå³å¯ #!/bin/bash export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin # è®¾ç½®è¦æ£€æµ‹çš„ç½‘é¡µURL urls=(\u0026#34;https://emp.cnpc.com.cn/index.html\u0026#34; \u0026#34;https://mdm.cnpc.com.cn/\u0026#34;) #urls=(\u0026#34;https://emp.cnpc.com.cn/index.html\u0026#34; \u0026#34;https://mdm.cnpc.com.cn/\u0026#34; \u0026#34;https://www.956100.com\u0026#34; \u0026#34;https://mm.956100.com\u0026#34; \u0026#34;https://app.956100.com\u0026#34;) # é’‰é’‰æœºå™¨äººçš„ webhook åœ°å€ webhook=\u0026#34;https://oapi.dingtalk.com/robot/send?access_token=******************************\u0026#34; # æœ€å¤§è¿ç»­æ— æ³•è®¿é—®æ¬¡æ•° max_attempts=3 # è®¾ç½®å¹¶å‘è¿›ç¨‹æ•°ä¸º URL æ•°é‡ max_concurrent=${#urls[@]} # åˆå§‹åŒ–è®¡æ•°å™¨ completed=0 for url in \u0026#34;${urls[@]}\u0026#34;; do # åœ¨åå°å¯åŠ¨ä¸€ä¸ªå­è¿›ç¨‹è¿›è¡Œæµ‹è¯• ( attempts=0 while [ $attempts -lt $max_attempts ]; do # ä½¿ç”¨curlè·å–ç½‘é¡µå†…å®¹ï¼Œå¹¶ä¿å­˜HTTP","title":"shell | æ£€æµ‹ç½‘ç«™å­˜æ´»å¹¶è‡ªåŠ¨é’‰é’‰å‘Šè­¦"},{"content":"0 å‰è¨€ æœ¬æ–‡å®ç°è¢«æ£€æµ‹ä¸»æœºåˆ°ç‰¹å®š ip çš„ç‰¹å®šç«¯å£çš„è¿é€šæ€§, é€šè¿‡ nc å‘½ä»¤æµ‹è¯•ç«¯å£å¯ç”¨æ€§, å½“ nc è¶…æ—¶æ—¶è‡ªåŠ¨æ‰§è¡Œ traceroute è¿½è¸ªè·¯ç”±å®šä½ç½‘ç»œæ•…éšœç‚¹, æœ¬æ–‡çš„æ¡ˆä¾‹æ˜¯ç›‘æ§æˆ‘ä»¬ç”Ÿäº§çš„çŸ­ä¿¡ä¸šåŠ¡æœåŠ¡å™¨åˆ°è¿è¥å•†æä¾›çš„çŸ­ä¿¡æ¥å£ä¹‹é—´çš„è¿é€šæ€§.\nç¯å¢ƒä¿¡æ¯:\nCentOS 7.6 Zabbix 3.4 ç¡®ä¿éœ€è¦æ£€æµ‹ç«¯å£è¿é€šæ€§çš„æœåŠ¡å™¨å®‰è£…äº† nc åŠ traceroute\n1 æœåŠ¡å™¨é…ç½® æ¯ä¸ªéœ€è¦æ£€æµ‹çš„æœåŠ¡å™¨éƒ½è¦åšå¦‚ä¸‹æ“ä½œ\nä¿®æ”¹ traceroute æƒé™\nchmod u+s /usr/bin/traceroute åˆ›å»ºæ£€æµ‹è„šæœ¬, è„šæœ¬ä¼ å…¥ä¸‰ä¸ªå‚æ•°: nc å‘½ä»¤çš„è¶…æ—¶æ—¶é—´, è¦æ£€æµ‹çš„ ip ä»¥åŠç«¯å£, traceroute æ—¥å¿—ä¿å­˜åˆ° /var/log/smslink_monitor ç›®å½•\nvim /etc/zabbix/zabbix_agentd.d/smslink.sh #!/bin/bash start_time=$(date +\u0026#34;%Y%m%d-%H%M%S\u0026#34;) timeout=$1 ip=$2 port=$3 LOG_DIRECTORY=/var/log/smslink_monitor [ -d \u0026#34;${LOG_DIRECTORY}\u0026#34; ] || mkdir -p \u0026#34;${LOG_DIRECTORY}\u0026#34; # å¼€å§‹ nc æµ‹è¯•è¿é€šæ€§ nc_result=$(/bin/nc -z -w ${timeout} ${ip} ${port}; echo $?) echo ${nc_result} # å¦‚æœ nc æµ‹è¯•å¤±è´¥åˆ™æ‰§è¡Œ traceroute if [ ${nc_result} -ne 0 ]; then log_file=\u0026#34;${LOG_DIRECTORY}/${start_time}-${ip}-${port}.log\u0026#34; /bin/nohup /usr/bin/traceroute -n -T -p ${port} ${ip} \u0026gt; ${log_file} 2\u0026gt;\u0026amp;1 \u0026amp; fi exit 0 æ­¤æ­¥å¯ä»¥ç•¥è¿‡, å¦‚æœç”¨ root ç”¨æˆ·æ‰§è¡Œè¿‡è„šæœ¬è¿›è¡Œæµ‹è¯•, éœ€è¦æ‰§è¡Œä¸€ä¸‹, å› ä¸º root ç”¨æˆ·æ‰§è¡Œè¿‡è„šæœ¬å, è¿™ä¸ªç›®å½•çš„å±ä¸»å°†æ˜¯ root, è€Œ zabbix æ‰§è¡Œè„šæœ¬ä½¿ç”¨çš„æ˜¯ zabbix ç”¨æˆ·, ä¼šå¯¼è‡´æ²¡æœ‰æƒé™å†™å…¥\nchown zabbix:zabbix /var/log/smslink_monitor æ–°å¢ zabbix agent é…ç½®æ–‡ä»¶, é€šè¿‡è°ƒç”¨æˆ‘ä»¬åˆšæ‰åˆ›å»ºçš„è„šæœ¬å®ç°\nvim /etc/zabbix/zabbix_agentd.d/smslink.conf # $1: timeout # $2: ip # $3: port UserParameter=get_smslink_status[*],/bin/sh /etc/zabbix/zabbix_agentd.d/smslink.sh $1 $2 $3 é‡å¯ zabbix agent\nsystemctl restart zabbix-agent åœ¨ zabbix server ç«¯æµ‹è¯•ç›‘æ§é¡¹, * ä¸ºå ä½ç¬¦, æ”¹æˆè‡ªå·±çš„å®é™… ip, è¿”å›å€¼ 0 ä¸ºæ­£å¸¸, å…¶ä»–å€¼ä¸ºå¼‚å¸¸\n[root@klmy-kfyy-jxwh-0003 ~]# zabbix_get -s 192.168.4.72 -p 10050 -k get_smslink_status[3,10.**.**.22,7001] 0 [root@klmy-kfyy-jxwh-0003 ~]# zabbix_get -s 192.168.4.73 -p 10050 -k get_smslink_status[3,10.**.**.22,7001] 0 [root@klmy-kfyy-jxwh-0003 ~]# zabbix_get -s 192.168.4.74 -p 10050 -k get_smslink_status[3,10.**.**.22,7001] 0 æ”¹æˆä¸€ä¸ªé”™è¯¯çš„ç«¯å£, å¯ä»¥çœ‹åˆ°è¿”å›å€¼å˜æˆäº† 1\n[root@klmy-kfyy-jxwh-0003 ~]# zabbix_get -s 192.168.4.72 -p 10050 -k get_smslink_status[3,10.**.**.22,7002] 1 åœ¨ 4.72 ä¸Šçœ‹ä¸‹ traceroute æ—¥å¿—è¾“å‡º\n[root@klmy-kfyy-dxpt-0003 ~]# ls -ltr /var/log/smslink_monitor/ -rw-rw-r-- 1 zabbix zabbix 595 Dec 7 11:21 20231207-112058-10.**.**.22-7002.log [root@klmy-kfyy-dxpt-0003 ~]# cat /var/log/smslink_monitor/20231207-112058-10.**.**.22-7002.log traceroute to 10.**.**.22 (10.**.**.22), 30 hops max, 60 byte packets 1 * * * 2 * * * 3 100.32.34.2 5.202 ms 5.198 ms 5.187 ms 4 * * * 5 11.54.13.201 6.103 ms 6.076 ms 6.074 ms 6 11.54.13.1 6.873 ms 2.104 ms 1.598 ms 7 * * * 8 10.33.253.129 2.086 ms 3.160 ms 3.110 ms 9 10.11.1.153 71.703 ms 70.821 ms 69.009 ms 10 10.33.0.82 77.203 ms 69.230 ms 69.315 ms 11 * * * 12 * * * 13 * * * å¯ä»¥çœ‹åˆ°ä¸­æ–­çš„ç‚¹, è¿™é‡Œä¸­æ–­æ˜¯å› ä¸ºæˆ‘ä»¬é›†å›¢å¹¿åŸŸç½‘æ²¡å¼€ 7002 ç«¯å£çš„ç­–ç•¥, æ‰€ä»¥åˆ°å¹¿åŸŸç½‘ç›´æ¥æ–­æ‰äº†\n2 zabbix é…ç½® 2.1 åˆ›å»ºæ¨¡æ¿ é€‰æ‹©é“¾æ¥çš„ä¸»æœºæˆ–è€…ä¸»æœºç¾¤ç»„\n2.2 åˆ›å»ºåº”ç”¨é›† 2.3 åˆ›å»ºç›‘æ§é¡¹ å…«æ¡é“¾è·¯éƒ½åˆ›å»ºä¸€ä¸‹\nåœ¨æœ€æ–°æ•°æ®å¤„çœ‹ä¸‹é”®å€¼è·å–æ˜¯å¦æ­£å¸¸\n2.4 åˆ›å»ºè§¦å‘å™¨ è¿™é‡Œçš„è¡¨è¾¾å¼ä»£è¡¨å¦‚æœè¿ç»­çš„ä¸¤ä¸ªå€¼çš„æœ€å°å€¼ä¸ä¸º 0 åˆ™è§¦å‘å‘Šè­¦, å³è¿ç»­ä¸¤æ¬¡å€¼éƒ½ä¸ä¸º 0 è§¦å‘å‘Šè­¦, è¿™æ˜¯è€ƒè™‘åˆ°æ•´ä½“ç½‘ç»œæ¯”è¾ƒå¤æ‚, ç½‘ç»œæ³¢åŠ¨å¯èƒ½ä¼šå¯¼è‡´è¯¯æŠ¥\nå…«æ¡é“¾è·¯åˆ†åˆ«æ·»åŠ ä¸€ä¸‹è§¦å‘å™¨\n2.5 é…ç½®å‘Šè­¦åŠ¨ä½œ 2.6 æµ‹è¯•éªŒè¯ æˆ‘è¿™é‡Œæ˜¯æ‰¾ç½‘ç»œä¾§çš„åŒäº‹ä¸­æ–­äº†ä¸€ä¸‹é“¾è·¯è¿›è¡Œæµ‹è¯•çš„, å„ä½å¯ä»¥è‡ªè¡Œé€‰æ‹©é€‚åˆè‡ªå·±çš„æ–¹æ³•\n2.7 æ·»åŠ èšåˆå›¾å½¢ æœ€åå¯ä»¥æ·»åŠ ä¸€ä¸ªèšåˆå›¾å½¢, æ–¹ä¾¿åç»­æŸ¥çœ‹\nåœ¨æ¨¡æ¿å¤„æ·»åŠ å›¾å½¢\nåœ¨ ç›‘æµ‹ä¸­ -\u0026gt; èšåˆå›¾å½¢ å¤„æ·»åŠ èšåˆå›¾å½¢, ä¸‰å°ä¸»æœº, é€‰æ‹©ä¸€è¡Œæ˜¾ç¤ºå‡ºæ¥\nè¿›å…¥åˆšæ‰åˆ›å»ºçš„èšåˆå›¾å½¢, é€‰æ‹©å³ä¸Šè§’çš„ç¼–è¾‘èšåˆå›¾å½¢, ç„¶åç‚¹å‡» æ›´æ”¹ æ·»åŠ å›¾å½¢\næŠŠä¸‰ä¸ªèŠ‚ç‚¹éƒ½æ·»åŠ ä¸€ä¸‹\næœ€åå°†æ­¤èšåˆå›¾å½¢é€šè¿‡å³ä¸Šè§’çš„æŒ‰é’®æ·»åŠ åˆ°å¸¸ç”¨, å°±å¯ä»¥åœ¨é¦–é¡µç›´æ¥ç‚¹å‡»è¿›æ¥äº†\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/zabbix-tcp-port-monitor/","summary":"0 å‰è¨€ æœ¬æ–‡å®ç°è¢«æ£€æµ‹ä¸»æœºåˆ°ç‰¹å®š ip çš„ç‰¹å®šç«¯å£çš„è¿é€šæ€§, é€šè¿‡ nc å‘½ä»¤æµ‹è¯•ç«¯å£å¯ç”¨æ€§, å½“ nc è¶…æ—¶æ—¶è‡ªåŠ¨æ‰§è¡Œ traceroute è¿½è¸ªè·¯ç”±å®šä½ç½‘ç»œæ•…éšœç‚¹, æœ¬æ–‡çš„æ¡ˆä¾‹æ˜¯ç›‘æ§æˆ‘ä»¬ç”Ÿäº§çš„çŸ­ä¿¡ä¸šåŠ¡æœåŠ¡å™¨åˆ°è¿è¥å•†æä¾›çš„çŸ­ä¿¡æ¥å£ä¹‹é—´çš„è¿é€šæ€§. ç¯å¢ƒä¿¡æ¯: CentOS 7.6 Zabbix 3.4 ç¡®ä¿éœ€è¦æ£€æµ‹ç«¯å£è¿é€šæ€§çš„æœåŠ¡å™¨å®‰è£…äº† nc åŠ traceroute 1 æœåŠ¡å™¨é…ç½® æ¯ä¸ªéœ€è¦æ£€","title":"Zabbix | ç›‘æ§ç«¯å£è¿é€šæ€§å¹¶è‡ªåŠ¨è¿½è¸ª TCP è·¯ç”±"},{"content":"0 å‰è¨€ æœ€è¿‘æ³¨æ„åˆ° windows ç³»ç»Ÿä¸­å½“ onedrive å’Œ clash åŒæ—¶å¼€æœºè‡ªå¯æ—¶ä¼šå¯¼è‡´ onedrive æ— æ³•è‡ªåŠ¨ç™»å½•, éœ€è¦é€€å‡º onedrive é‡æ–°å¯åŠ¨ä¸€ä¸‹æ‰èƒ½æ­£å¸¸ç™»å½•.\nå‡ºç°è¿™ä¸ªé—®é¢˜çš„åŸå› æ˜¯ onedrive å¯åŠ¨é€Ÿåº¦è¦æ¯” clash å¿«, å¯¼è‡´ onedrive å¯åŠ¨æ—¶è®¿é—®ä¸åˆ° clash. å…¶å®åªè¦å°†è¿™ä¸¤ä¸ªå…¶ä¸­ä¸€ä¸ªä¸è®¾ç½®ä¸ºå¼€æœºè‡ªå¯å³å¯è§£å†³, ä½†æ˜¯è¿™ä¸¤ä¸ªéƒ½æ˜¯åˆšéœ€, æ”¾ä¸‹ä»»ä½•ä¸€ä¸ªéƒ½ä¼šä¸èˆ’æœ.\nä¸€ç•ª google ä¸‹æ¥, å¤§éƒ¨åˆ†çš„è§£å†³æ–¹æ¡ˆéƒ½æ˜¯æ·»åŠ  windows çš„è®¡åˆ’ä»»åŠ¡, æˆ‘å°è¯•äº†åŠå¤©ä¹Ÿæ²¡åŠæ³•æ— æ³•æˆåŠŸ, æœ€åç»ˆäºæ‰¾åˆ°äº†æ»¡è¶³éœ€æ±‚çš„ è§£å†³æ–¹æ¡ˆ, ä½¿ç”¨ EarlyStart å®ç°åœ¨ windows explorer å¯åŠ¨å‰å°±å¯åŠ¨è‡ªå®šä¹‰çš„è½¯ä»¶.\nåŒæ—¶è¿˜èƒ½é¡ºä¾¿è§£å†³ä¹‹å‰æ„Ÿè§‰æœ‰ç‚¹ä¸èˆ’æœçš„ä¸¤ä¸ªé—®é¢˜:\nTranslucentTB: è‡ªå¯åŠ¨æ—¶ä¼šæ…¢ä¸€æ‹, åˆšè¿›ç³»ç»Ÿæ—¶ä»»åŠ¡æ æ²¡æœ‰é€æ˜, ç­‰ä¸ªå‡ ç§’å¯åŠ¨åæ‰èƒ½æ­£å¸¸ utools: åŒæ ·çš„, è¿›ç³»ç»Ÿåç¬¬ä¸€æ—¶é—´ä¸èƒ½ä½¿ç”¨, å¾—ç­‰å‡ ç§’å¯åŠ¨åæ‰è¡Œ 1 å®‰è£… EarlyStart ä¸‹è½½ EarlyStart.zip\nè§£å‹åä½¿ç”¨ç®¡ç†å‘˜æ‰“å¼€ powershell å¹¶è¿›å…¥å®‰è£…ç›®å½•\ncd D:\\software\\1-portable\\EarlyStart # å®‰è£… C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\InstallUtil.exe .\\EarlyStart.exe # å¸è½½ C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\InstallUtil.exe /u .\\EarlyStart.exe 2 é…ç½®å¯åŠ¨é¡¹ é¦–å…ˆå°†è¦é…ç½®å¿«é€Ÿå¯åŠ¨çš„åº”ç”¨é»˜è®¤çš„å¼€æœºè‡ªå¯ç»™å…³æ‰\nåœ¨ä½ è‡ªå·±çš„ç”¨æˆ·ç›®å½• %USERPROFILE% åˆ›å»ºä¸€ä¸ªåä¸º .earlystart çš„æ–‡ä»¶, æ¯ä¸€è¡Œè¾“å…¥ä¸€ä¸ª exe çš„è·¯å¾„\nå¦‚æœè¦è¿è¡Œ ps1 ç­‰è„šæœ¬ç¨‹åº, å‚è€ƒæˆ‘ä¸‹é¢çš„å†™æ³•, -File åé¢å°±æ˜¯ä½ çš„ ps1 è„šæœ¬çš„æ–‡ä»¶äº†, æœ€åçš„ start æ˜¯ç»™ ps1 ä¼ çš„å‚æ•°\n\u0026#34;C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\u0026#34; -ExecutionPolicy Bypass -NoProfile -WindowStyle Hidden -File \u0026#34;D:\\software\\1-portable\\mihomo\\mihomo-manager.ps1\u0026#34; start ç„¶åè¿˜éœ€è¦ä¿®æ”¹ä¸€ä¸‹è´¦æˆ·é…ç½®\né…ç½®å®Œæˆä¹‹åé‡å¯ç³»ç»Ÿå³å¯\nä»¥ä¸Š.\n","permalink":"https://www.lvbibir.cn/posts/tech/windows-early-auto-start/","summary":"0 å‰è¨€ æœ€è¿‘æ³¨æ„åˆ° windows ç³»ç»Ÿä¸­å½“ onedrive å’Œ clash åŒæ—¶å¼€æœºè‡ªå¯æ—¶ä¼šå¯¼è‡´ onedrive æ— æ³•è‡ªåŠ¨ç™»å½•, éœ€è¦é€€å‡º onedrive é‡æ–°å¯åŠ¨ä¸€ä¸‹æ‰èƒ½æ­£å¸¸ç™»å½•. å‡ºç°è¿™ä¸ªé—®é¢˜çš„åŸå› æ˜¯ onedrive å¯åŠ¨é€Ÿåº¦è¦æ¯” clash å¿«, å¯¼è‡´ onedrive å¯åŠ¨æ—¶è®¿é—®ä¸åˆ° clash. å…¶å®åªè¦å°†è¿™ä¸¤ä¸ªå…¶ä¸­ä¸€ä¸ªä¸è®¾ç½®ä¸ºå¼€æœºè‡ªå¯å³å¯è§£å†³, ä½†æ˜¯è¿™ä¸¤ä¸ªéƒ½æ˜¯åˆšéœ€, æ”¾ä¸‹ä»»ä½•ä¸€ä¸ªéƒ½ä¼šä¸èˆ’æœ. ä¸€ç•ª google ä¸‹æ¥, å¤§éƒ¨åˆ†çš„","title":"windows | è‡ªå®šä¹‰å¼€æœºå¿«é€Ÿå¯åŠ¨é¡¹"},{"content":"0 å‰è¨€ python è™šæ‹Ÿç¯å¢ƒçš„é‡è¦æ€§å·²ç»æ— éœ€å¤šè¨€äº†, ç›®å‰æ‰€æœ‰æ”¯æŒ python è™šæ‹Ÿç¯å¢ƒçš„å·¥å…·ä¸­æœ€å¥½ç”¨çš„åº”è¯¥å°±æ˜¯ conda äº†, æœ€é‡è¦çš„ä¸€ç‚¹æ˜¯å¯ä»¥ä¸€é”®åˆ›å»ºä¸åŒç‰ˆæœ¬çš„ python ç¯å¢ƒä»¥é€‚åº”ä¸åŒçš„éœ€æ±‚.\nAnaconda æ¯”è¾ƒè‡ƒè‚¿, æœ¬æ–‡ä½¿ç”¨æ—  GUI çš„ miniconda.\nç¯å¢ƒ:\nwin10 miniconda3-py11-23.5.2-0 1 å®‰è£… å®‰è£…å‰éœ€è¦ç¡®è®¤ä¸€ä¸‹ç³»ç»ŸåŠç”¨æˆ·çš„ç¯å¢ƒå˜é‡ä¸­ä¸è¦å­˜åœ¨ä¸­æ–‡, åœ¨ CMD ä¸­ç›´æ¥æ‰§è¡Œ path æˆ–è€… git-bash ä¸­æ‰§è¡Œ echo $PATH è¿›è¡Œç¡®è®¤, è¿™ä¸ªé—®é¢˜å½“æ—¶è¢«æŠ˜ç£¨ç–¯äº†, è¿˜ç»™ conda é¡¹ç›®æäº† issue.\næœ€æ–°ç‰ˆä¸‹è½½åœ°å€\né€‰å¥½è·¯å¾„ç›´æ¥ä¸‹ä¸€æ­¥å³å¯, æ²¡æœ‰éœ€è¦æ³¨æ„çš„è‡ªå®šä¹‰é…ç½®é¡¹\n2 é…ç½® 2.1 ç¯å¢ƒå˜é‡ åœ¨ç”¨æˆ·ç¯å¢ƒå˜é‡ PATH æ·»åŠ å¦‚ä¸‹é¡¹, æˆ‘çš„å®‰è£…è·¯å¾„æ˜¯ D:\\miniconda, æŒ‰å®é™…æƒ…å†µä¿®æ”¹\nD:\\software\\miniconda D:\\software\\miniconda\\Scripts D:\\software\\miniconda\\Library\\bin æ·»åŠ å®Œåé‡å¯ç³»ç»Ÿ, è®©ç³»ç»Ÿé‡æ–°è¯»å–ä¸€ä¸‹ç¯å¢ƒå˜é‡\n2.2 conda é…ç½® å‚è€ƒé“¾æ¥\nminiconda é»˜è®¤æ²¡æœ‰ .condarc é…ç½®æ–‡ä»¶, éœ€è¦ç”Ÿæˆä¸€ä¸‹\nconda config --set show_channel_urls yes .condarc ä¼šç”Ÿæˆåˆ°ç”¨æˆ·ç›®å½•ä¸‹\n$ cat .condarc channels: - defaults show_channel_urls: true default_channels: - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/r - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/msys2 custom_channels: conda-forge: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud msys2: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud bioconda: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud menpo: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud pytorch: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud pytorch-lts: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud simpleitk: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud deepmodeling: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/ # ä¸è‡ªåŠ¨æ¿€æ´» base ç¯å¢ƒ auto_activate_base: false # è™šæ‹Ÿç¯å¢ƒå­˜æ”¾è·¯å¾„ envs_dirs: - D:\\software\\python\\envs # pkg å­˜æ”¾è·¯å¾„ pkgs_dirs: - D:\\software\\python\\pkgs ä¸Šè¿°é…ç½®æ–‡ä»¶ä¸­ä¸»è¦é…ç½®äº†ä¸‰é¡¹: conda çš„æ¸…åå›½å†…æº, è™šæ‹Ÿç¯å¢ƒå’Œ pkg çš„å­˜å‚¨è·¯å¾„\nå¦‚ä¸é…ç½®åˆ›å»ºè™šæ‹Ÿç¯å¢ƒæ—¶å¯èƒ½ä¼šç”Ÿæˆåˆ°ç”¨æˆ·ç›®å½•ä¸‹, å¯¼è‡´ç³»ç»Ÿç›˜è‡ƒè‚¿, å»ºè®®æ–°å»ºä¸€ä¸ªç›®å½•ä¸“é—¨å­˜æ”¾\n2.3 pip é…ç½® ç³»ç»Ÿä¸­ç›´æ¥å®‰è£…çš„ python, å…¶ pip çš„é…ç½®æ–‡ä»¶ä¸€èˆ¬å­˜æ”¾åœ¨ç”¨æˆ·ç›®å½•çš„ .pip/pip.ini, ä½¿ç”¨ conda åˆ›å»ºçš„è™šæ‹Ÿç¯å¢ƒçš„ pip åˆ™ä¸åŒ, å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹, è¿™ä¸ªé—®é¢˜å½“æ—¶ä¹ŸæŠ˜ç£¨äº†æˆ‘å¾ˆä¹…\n$ pip -v config list For variant \u0026#39;global\u0026#39;, will try loading \u0026#39;C:\\ProgramData\\pip\\pip.ini\u0026#39; For variant \u0026#39;user\u0026#39;, will try loading \u0026#39;C:\\Users\\lvbibir\\pip\\pip.ini\u0026#39; For variant \u0026#39;user\u0026#39;, will try loading \u0026#39;C:\\Users\\lvbibir\\AppData\\Roaming\\pip\\pip.ini\u0026#39; For variant \u0026#39;site\u0026#39;, will try loading \u0026#39;D:\\software\\miniconda\\pip.ini\u0026#39; è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ç”¨æˆ·ç›®å½•å­˜æ”¾é…ç½®æ–‡ä»¶, é»˜è®¤ä¹Ÿæ˜¯æ²¡æœ‰çš„\n$ cat pip/pip.ini [global] timeout = 6000 index-url = http://pypi.tuna.tsinghua.edu.cn/simple trusted-host = pypi.tuna.tsinghua.edu.cn proxy=http://127.0.0.1:7890 é…ç½® pip ä½¿ç”¨å›½å†…çš„æ¸…åæº, æœ€åä¸€æ¡ proxy å¯ä»¥ä¸å†™, è¿™ä¸ªé—®é¢˜æ˜¯å› ä¸ºæˆ‘å¸¸å¼€ä»£ç†, pip é»˜è®¤ç”¨ https è®¿é—®ç³»ç»Ÿä»£ç†, å¯¼è‡´ pip æŠ¥é”™.\n2.4 ç®¡ç†è™šæ‹Ÿç¯å¢ƒ ä¸Šè¿°æ­¥éª¤åšå®Œåå°±å¯ä»¥æ­£å¼ä½¿ç”¨ conda åˆ›å»ºè™šæ‹Ÿç¯å¢ƒäº†\nç”¨ç®¡ç†å‘˜æ‰“å¼€ powershell ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤åˆå§‹åŒ– conda\nconda init powershell conda init cmd conda init bash ä¹‹åé‡æ–°æ‰“å¼€ç»ˆç«¯, åˆ›å»ºä½ çš„è™šæ‹Ÿç¯å¢ƒ, -n è¡¨ç¤ºè™šæ‹Ÿç¯å¢ƒçš„åå­—, ä¸æŒ‡å®š python ç‰ˆæœ¬é»˜è®¤æœ€æ–°\nconda create -n py37 python=3.7 æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ\nconda activate py37 é€€å‡ºè™šæ‹Ÿç¯å¢ƒ\nconda deactivate æŸ¥çœ‹è™šæ‹Ÿç¯å¢ƒåˆ—è¡¨\nconda env list åˆ é™¤è™šæ‹Ÿç¯å¢ƒ\nconda env remove -n py37 --all 3 å…¶ä»– conda æœ€ä¸ºäººè¯Ÿç—…çš„ç‚¹åº”è¯¥æ˜¯åŒ…ç®¡ç†è·Ÿ pip å¯èƒ½ä¼šäº§ç”Ÿä¸€äº›å†²çª, conda å®˜æ–¹ç»™å‡ºçš„æœ€ä½³æ–¹æ¡ˆæ˜¯\nå…¨ç¨‹ä½¿ç”¨ conda install æ¥å®‰è£…æ¨¡å—, å®åœ¨ä¸è¡Œå†ç”¨ pip ä½¿ç”¨ conda åˆ›å»ºå®Œè™šæ‹Ÿç¯å¢ƒå, ä¸€ç›´ç”¨ pip æ¥ç®¡ç†æ¨¡å— pip åº”ä½¿ç”¨ â€“upgrade-strategy only-if-needed å‚æ•°è¿è¡Œ, ä»¥é˜²æ­¢é€šè¿‡ conda å®‰è£…çš„è½¯ä»¶åŒ…è¿›è¡Œä¸å¿…è¦çš„å‡çº§. è¿™æ˜¯è¿è¡Œ pip æ—¶çš„é»˜è®¤è®¾ç½®, ä¸åº”æ›´æ”¹ ä¸è¦å°† pip ä¸ â€“user å‚æ•°ä¸€èµ·ä½¿ç”¨ï¼Œé¿å…æ‰€æœ‰ç”¨æˆ·å®‰è£… æ€»ç»“ä¸€ä¸‹å°±æ˜¯ä¸è¦æ¥å›åœ°ç”¨ pip å’Œ conda, ä¸“ä¸€ä¸€ç‚¹ (ç¬‘\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/windows-miniconda/","summary":"0 å‰è¨€ python è™šæ‹Ÿç¯å¢ƒçš„é‡è¦æ€§å·²ç»æ— éœ€å¤šè¨€äº†, ç›®å‰æ‰€æœ‰æ”¯æŒ python è™šæ‹Ÿç¯å¢ƒçš„å·¥å…·ä¸­æœ€å¥½ç”¨çš„åº”è¯¥å°±æ˜¯ conda äº†, æœ€é‡è¦çš„ä¸€ç‚¹æ˜¯å¯ä»¥ä¸€é”®åˆ›å»ºä¸åŒç‰ˆæœ¬çš„ python ç¯å¢ƒä»¥é€‚åº”ä¸åŒçš„éœ€æ±‚. Anaconda æ¯”è¾ƒè‡ƒè‚¿, æœ¬æ–‡ä½¿ç”¨æ—  GUI çš„ miniconda. ç¯å¢ƒ: win10 miniconda3-py11-23.5.2-0 1 å®‰è£… å®‰è£…å‰éœ€è¦ç¡®è®¤ä¸€ä¸‹ç³»ç»ŸåŠç”¨æˆ·çš„ç¯å¢ƒå˜é‡ä¸­ä¸è¦å­˜åœ¨ä¸­æ–‡, åœ¨ CMD ä¸­ç›´æ¥æ‰§è¡Œ path æˆ–è€… git-bash ä¸­æ‰§è¡Œ echo","title":"windows | miniconda é…ç½® python è™šæ‹Ÿç¯å¢ƒ"},{"content":"0 å‰è¨€ åˆ†äº«ä¸€ä¸‹å¦‚ä½•ç›‘æ§æŸä¸ªä¸»æœºä¸Šçš„ç½‘å¡åˆ°æŒ‡å®š ip çš„æµé‡å¤§å°, æµ‹è¯•ç¯å¢ƒå·²å®‰è£… tcpdump å¹¶é…ç½®äº† zabbix_agent\nè¢«æ£€æµ‹ç«¯ ip ä¸º 1.1.1.11, è¦æ£€æµ‹åˆ° 1.1.1.12-17 è¿™äº› ip çš„å‡ºå£æµé‡\nå¤§è‡´æµç¨‹ä¸º:\nåˆ›å»ºä¸€ä¸ªç›‘æ§è„šæœ¬, åˆ†æ 1 åˆ†é’Ÿå†…æŒ‡å®šç½‘å¡å‘é€åˆ°æŒ‡å®š ip çš„æ•°æ®åŒ…å¤§å°å¹¶è¾“å‡ºåˆ°æ—¥å¿—æ–‡ä»¶ å°†è¯¥è„šæœ¬æ”¾åˆ° crontab ä¸­, æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ é…ç½® zabbix-agent åˆ›å»ºæ•°æ®é‡‡é›†è„šæœ¬, æå–æ—¥å¿—æ–‡ä»¶ä¸­çš„å†…å®¹ æ·»åŠ è‡ªå®šä¹‰é…ç½®, åˆ›å»ºé‡‡é›†çš„é”®å€¼ é…ç½® zabbix-server æ·»åŠ ç›‘æ§é¡¹ æ·»åŠ è§¦å‘å™¨ æ·»åŠ ä»ªè¡¨ç›˜ 1 ç›‘æ§è„šæœ¬ æ·»åŠ  /opt/traffic_monitor.sh\n#!/bin/bash export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin set -e # æ£€æŸ¥æ˜¯å¦å®‰è£…äº†tcpdumpå‘½ä»¤ if which tcpdump \u0026gt;/dev/null 2\u0026gt;\u0026amp;1; then # å¦‚æœå·²å®‰è£…ï¼Œåˆ™ä¸è¿›è¡Œä»»ä½•æç¤º : else echo \u0026#34;ç³»ç»Ÿä¸­æœªå®‰è£… tcpdump å‘½ä»¤ï¼Œè¯·å…ˆå®‰è£… tcpdumpã€‚\u0026#34; exit 1 fi # æ£€æŸ¥æ˜¯å¦æœ‰ tcpdump æ®‹ç•™è¿›ç¨‹ existing_tcpdump_pids=$(pgrep -f \u0026#34;tcpdump -i ens32 -nn dst\u0026#34;) || true # æ£€æŸ¥ tcpdump è¿›ç¨‹æ•°é‡ tcpdump_count=$(echo \u0026#34;${existing_tcpdump_pids}\u0026#34; | wc -w) if [ \u0026#34;$tcpdump_count\u0026#34; -gt 6 ]; then # å¦‚æœæ•°é‡å¤§äº 6 è§†ä¸ºä¹‹å‰çš„è¿›ç¨‹æœªæ­£ç¡®å…³é—­, æ€æ­»æ‰€æœ‰ tcpdump è¿›ç¨‹ kill -9 ${existing_tcpdump_pids} fi IPLIST=(\u0026#34;1.1.1.12\u0026#34; \u0026#34;1.1.1.13\u0026#34; \u0026#34;1.1.1.14\u0026#34; \u0026#34;1.1.1.15\u0026#34; \u0026#34;1.1.1.16\u0026#34; \u0026#34;1.1.1.17\u0026#34;) LOG_DIRECTORY=/var/log/traffic_monitor LOG_FILE=${LOG_DIRECTORY}/traffic_monitor.log [ -d \u0026#34;${LOG_DIRECTORY}\u0026#34; ] || mkdir -p \u0026#34;${LOG_DIRECTORY}\u0026#34; [ -f \u0026#34;${LOG_FILE}\u0026#34; ] || touch \u0026#34;${LOG_FILE}\u0026#34; # è·å–æ–‡ä»¶å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ log_file_size=$(du -b \u0026#34;$LOG_FILE\u0026#34; | cut -f1) # è®¾ç½®100Må¯¹åº”çš„å­—èŠ‚æ•° limit_size=$((100 * 1024 * 1024)) # æ£€æŸ¥æ–‡ä»¶å¤§å°æ˜¯å¦å¤§äº100M if [ \u0026#34;$log_file_size\u0026#34; -gt \u0026#34;$limit_size\u0026#34; ]; then # æ¸…ç©ºæ–‡ä»¶ echo \u0026#34;\u0026#34; \u0026gt; \u0026#34;$LOG_FILE\u0026#34; fi start_time=$(date +\u0026#34;%Y%m%d-%H%M%S\u0026#34;) for ip in \u0026#34;${IPLIST[@]}\u0026#34;; do ( # å¼€å§‹ tcpdump æŠ“åŒ… output_file=/tmp/monitor-${ip}-${start_time}.output nohup tcpdump -i ens32 -nn dst ${ip} and not icmp 2\u0026gt;/dev/null \u0026gt; ${output_file} \u0026amp; # ç­‰å¾… 60 ç§’åå…³é—­ tcpdump tcpdump_pid=$! sleep 60 \u0026amp;\u0026amp; kill ${tcpdump_pid} stop_time=$(date +\u0026#34;%Y%m%d-%H%M%S\u0026#34;) # åˆ†ææµé‡å¤§å°, ä»¥ KB ä¸ºå•ä½ traffic_size=$(cat ${output_file} | awk -F\u0026#39;length \u0026#39; \u0026#39;{print $2}\u0026#39; | awk \u0026#39;{sum+=$1} END {printf \u0026#34;%.2f\u0026#34;, sum / 1024}\u0026#39;) # åˆ é™¤ tcpdump çš„è¾“å‡ºæ–‡ä»¶ rm -f ${output_file} echo \u0026#34;${ip} ==== ${start_time} ----\u0026gt; ${stop_time} ===== (KB) ${traffic_size}\u0026#34; \u0026gt;\u0026gt; ${LOG_FILE} ) \u0026amp; done # ç­‰å¾…æ‰€æœ‰åå°ä»»åŠ¡å®Œæˆ wait exit 0 æ”¾åˆ° crontab ä¸­\n* * * * * /bin/bash /opt/traffic_monitor.sh \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 æ—¥å¿—æ–‡ä»¶åº”æœ‰ç±»ä¼¼å¦‚ä¸‹è¾“å‡º\n$ tail -12 /var/log/traffic_monitor/traffic_monitor.log 1.1.1.14 ==== 20230804-154601 ----\u0026gt; 20230804-154701 ===== (KB) 1964.99 1.1.1.12 ==== 20230804-154601 ----\u0026gt; 20230804-154701 ===== (KB) 0.23 1.1.1.17 ==== 20230804-154601 ----\u0026gt; 20230804-154701 ===== (KB) 1029.35 1.1.1.16 ==== 20230804-154601 ----\u0026gt; 20230804-154701 ===== (KB) 1029.35 1.1.1.15 ==== 20230804-154601 ----\u0026gt; 20230804-154701 ===== (KB) 1029.35 1.1.1.13 ==== 20230804-154601 ----\u0026gt; 20230804-154701 ===== (KB) 1029.35 1.1.1.12 ==== 20230804-154701 ----\u0026gt; 20230804-154801 ===== (KB) 1029.49 1.1.1.14 ==== 20230804-154701 ----\u0026gt; 20230804-154801 ===== (KB) 0.00 1.1.1.15 ==== 20230804-154701 ----\u0026gt; 20230804-154801 ===== (KB) 0.00 1.1.1.16 ==== 20230804-154701 ----\u0026gt; 20230804-154801 ===== (KB) 1029.35 1.1.1.13 ==== 20230804-154701 ----\u0026gt; 20230804-154801 ===== (KB) 0.00 1.1.1.17 ==== 20230804-154701 ----\u0026gt; 20230804-154801 ===== (KB) 3086.44 2 é…ç½® zabbix-agent æ·»åŠ  /opt/zabbix_traffic_monitor.sh, æ ¹æ® ip ç­›é€‰æœ€åä¸€ä¸ªåŒ¹é…é¡¹çš„æ•°å€¼\n#!/bin/bash LOG_DIRECTORY=/var/log/traffic_monitor LOG_FILE=${LOG_DIRECTORY}/traffic_monitor.log grep \u0026#34;$1\u0026#34; \u0026#34;${LOG_FILE}\u0026#34; | awk \u0026#39;{last_column=$NF} END {print last_column}\u0026#39; æ·»åŠ  /etc/zabbix/zabbix_agentd.d/get_traffic_monitor.conf é…ç½®æ–‡ä»¶\nUserParameter=get_traffic_monitor[*],/opt/zabbix_traffic_monitor.sh $1 é‡å¯ zabbix-agent\nsystemctl restart zabbix-agent 3 é…ç½® zabbix-server åˆ›å»ºç›‘æ§é¡¹, æœ‰å‡ ä¸ª ip åˆ›å»ºå‡ ä¸ªç›‘æ§é¡¹\nç›‘æ§é¡¹æµ‹è¯•, æ­¤å¤„åº”æœ‰å€¼\nåˆ›å»ºè§¦å‘å™¨, åŒæ ·çš„, æœ‰å‡ ä¸ª ip åˆ›å»ºå‡ ä¸ª\nä»ªè¡¨ç›˜æ·»åŠ å›¾å½¢\n4 æµ‹è¯• æ‰¾ä¸€å°æœåŠ¡å™¨é…ç½®å¤š ip\nIPADDR=1.1.1.12 NETMASK=255.255.255.0 GATEWAY=1.1.1.254 DNS1=8.8.8.8 DNS2=114.114.114.114 IPADDR1=1.1.1.13 NETMASK1=255.255.255.0 IPADDR2=1.1.1.14 NETMASK2=255.255.255.0 IPADDR3=1.1.1.15 NETMASK3=255.255.255.0 IPADDR4=1.1.1.16 NETMASK4=255.255.255.0 IPADDR5=1.1.1.17 NETMASK5=255.255.255.0 é‡å¯ network\né…ç½® 1.1.1.11 åˆ° 1.1.1.12-17 çš„å…å¯†ç™»å½•\nssh-keygen ssh-copy-id root@1.1.1.12 # æ¯ä¸ª ip éƒ½ ssh ä¸€ä¸‹, æ·»åŠ ä¸€ä¸‹ hotkey ssh root@1.1.1.13 ssh root@1.1.1.14 ssh root@1.1.1.15 ssh root@1.1.1.16 ssh root@1.1.1.17 è¿è¡Œä¸€ä¸ªè„šæœ¬æ¨¡æ‹Ÿç½‘ç»œæµé‡\n#!/bin/bash # è®¾ç½®ç›®æ ‡IPåœ°å€åˆ—è¡¨ ip_list=(\u0026#34;1.1.1.12\u0026#34; \u0026#34;1.1.1.13\u0026#34; \u0026#34;1.1.1.14\u0026#34; \u0026#34;1.1.1.15\u0026#34; \u0026#34;1.1.1.16\u0026#34; \u0026#34;1.1.1.17\u0026#34;) dd if=/dev/zero of=/tmp/test bs=1M count=1 while true; do # ç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼ŒèŒƒå›´ä¸º 0 åˆ° 5 random_index=$((RANDOM % 6)) # éšæœºé€‰æ‹©ä¸€ä¸ªIP target_ip=\u0026#34;${ip_list[random_index]}\u0026#34; echo ${target_ip} /usr/bin/scp /tmp/test root@${target_ip}:/tmp/ # ç­‰å¾…10ç§’ sleep 10 done è¿è¡Œè„šæœ¬, åº”æœ‰å¦‚ä¸‹è¾“å‡º\nè¿‡æ®µæ—¶é—´åæŸ¥çœ‹ä»ªè¡¨ç›˜, èƒ½çœ‹åˆ°æµé‡æ•°æ®\nè§¦å‘å™¨ä¹Ÿåº”æ­£å¸¸å·¥ä½œ\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/zabbix-ip-traffic-monitor/","summary":"0 å‰è¨€ åˆ†äº«ä¸€ä¸‹å¦‚ä½•ç›‘æ§æŸä¸ªä¸»æœºä¸Šçš„ç½‘å¡åˆ°æŒ‡å®š ip çš„æµé‡å¤§å°, æµ‹è¯•ç¯å¢ƒå·²å®‰è£… tcpdump å¹¶é…ç½®äº† zabbix_agent è¢«æ£€æµ‹ç«¯ ip ä¸º 1.1.1.11, è¦æ£€æµ‹åˆ° 1.1.1.12-17 è¿™äº› ip çš„å‡ºå£æµé‡ å¤§è‡´æµç¨‹ä¸º: åˆ›å»ºä¸€ä¸ªç›‘æ§è„šæœ¬, åˆ†æ 1 åˆ†é’Ÿå†…æŒ‡å®šç½‘å¡å‘é€åˆ°æŒ‡å®š ip çš„æ•°æ®åŒ…å¤§å°å¹¶è¾“å‡ºåˆ°æ—¥å¿—æ–‡ä»¶ å°†è¯¥è„šæœ¬æ”¾åˆ° crontab ä¸­, æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ é…ç½® zabbix-agent åˆ›å»ºæ•°æ®é‡‡é›†è„šæœ¬, æå–æ—¥å¿—æ–‡","title":"Zabbix | ç›‘æ§ä¸»æœºåˆ°æŒ‡å®š ip çš„æµé‡å¤§å°"},{"content":"0 å‰è¨€ ä»¥ centos7 ä¸ºä¾‹, é€šå¸¸æˆ‘ä»¬æ–°è£…å®Œæ“ä½œç³»ç»Ÿåéœ€è¦è¿›è¡Œé…ç½® yum æº, iptables, selinux, ntp ä»¥åŠä¼˜åŒ– kernel ç­‰æ“ä½œ, ç°åˆ†äº«ä¸€äº›è¾ƒä¸ºé€šç”¨çš„é…ç½®. åŒæ—¶åšä¸»å°†è¿™äº›é…ç½®æ•´ç†æˆäº†è„šæœ¬, å¯ä»¥ä¸€é”®æ‰§è¡Œ.\n1 å¸¸ç”¨é…ç½® 1.1 iptables \u0026amp; selinux sed -i \u0026#39;/SELINUX/s/enforcing/disabled/\u0026#39; /etc/selinux/config setenforce 0 iptables -F systemctl disable --now firewalld 1.2 PS1 ç»ˆç«¯ç¾åŒ– cat \u0026gt; /etc/profile.d/PS1_conf.sh \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; export PS1=\u0026#34;\\n[\\[\\e[31m\\]\\u\\[\\e[m\\]@\\[\\e[32m\\]\\h\\[\\e[m\\]] -\\$?- \\[\\e[33m\\]\\$(pwd)\\[\\e[m\\] \\[\\e[34m\\]\\$(date +\u0026#39;%F %T\u0026#39;)\\[\\e[m\\] \\n(\\#)$ \u0026#34; EOF source /etc/profile.d/PS1_conf.sh 1.3 history æ ¼å¼åŒ– cat \u0026gt; /etc/profile.d/history_conf.sh \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; export HISTFILE=\u0026#34;$HOME/.bash_history\u0026#34; # å†™å…¥æ–‡ä»¶ export HISTSIZE=1000 # historyè¾“å‡ºè®°å½•æ•° export HISTFILESIZE=10000 # HISTFILEæ–‡ä»¶è®°å½•æ•° export HISTIGNORE=\u0026#34;cmd1:cmd2:...\u0026#34; # å¿½ç•¥æŒ‡å®šcmd1,cmd2...çš„å‘½ä»¤ä¸è¢«è®°å½•åˆ°æ–‡ä»¶ï¼›(åŠ å‚æ•°æ—¶ä¼šè®°å½•) export HISTCONTOL=ignoredups # ignoredups ä¸è®°å½•â€œé‡å¤â€çš„å‘½ä»¤ï¼›è¿ç»­ä¸”ç›¸åŒ æ–¹ä¸ºâ€œé‡å¤â€ export PROMPT_COMMAND=\u0026#34;history -a\u0026#34; # è®¾ç½®æ¯æ¡å‘½ä»¤æ‰§è¡Œå®Œç«‹å³å†™å…¥HISTFILE(é»˜è®¤ç­‰å¾…é€€å‡ºä¼šè¯å†™å…¥) export HISTTIMEFORMAT=\u0026#34;$(whoami) %F %T \u0026#34; # è®¾ç½®å‘½ä»¤æ‰§è¡Œæ—¶é—´æ ¼å¼ï¼Œè®°å½•æ–‡ä»¶å¢åŠ æ—¶é—´æˆ³ shopt -s histappend # é˜²æ­¢ä¼šè¯é€€å‡ºæ—¶è¦†ç›–å…¶ä»–ä¼šè¯å†™åˆ°HISTFILEçš„å†…å®¹ EOF source /etc/profile.d/history_conf.sh 1.4 ssh å…¬é’¥ mkdir /root/.ssh || true chmod 700 /root/.ssh cat \u0026gt; /root/.ssh/authorized_keys \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCeQZmPg93SNx6zzR/l4RiPnHtFPbDTSOL7AtJOIvrlMm300x1OM8a48VqYuKEx7B7WM7UhszVndg8efJv9UdOtOaa0o8L0Wd2uujn2rFKKok69c5i7c/jmU1my9MkEsKpkx1MHQWVZTFqayv/DB9L5GaE/ShChsTSlXoQ6rc6JC4k1zgSsoNSTLwPrbZcDOZWprt/AOhqCklf9mL1E50WTx9XsjxBLqJIwwVEzmHAhzIiVowjBKjJpQ6hEvygCz67gNVn0vAvHPvCz3amrkCQa333Z9r8tbY7mJpq2Anj4qWtlnL9kHreVK6YoKGvM8+DrbVoT5/zM7wMZ+tdLmreUsu4OhgDkE4IgUMHWQ3T1GyD1EjCkqCdSfJbrLaAR8v7g92uDXO5irIyYMc/iQJ8v4okus9Iid61zFF0SPgZEykOVfT7jJqH0a/630D41uD0TK90v5PicVdh1FfEfok8P4F4UHGLUly2jRVBESQ/TXVGPaMITHPEtYEpmT3kmnOk= 15810243114@163.com EOF chmod 600 /root/.ssh/authorized_keys 1.5 åŠ é€Ÿ ssh è¿æ¥ echo \u0026#34;UseDNS no\u0026#34; \u0026gt;\u0026gt; /etc/ssh/sshd_config 1.6 é…ç½® yum æº ä»¥å®æµ‹æœ€å¿«çš„ä¸­ç§‘å¤§æºä¸ºä¾‹\nmkdir /etc/yum.repos.d/bak || true mv /etc/yum.repos.d/*.repo /etc/yum.repos.d/bak/ || true cat \u0026gt; /etc/yum.repos.d/centos-ustc.repo \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; [base] name=CentOS-$releasever - Base baseurl=https://mirrors.ustc.edu.cn/centos-vault/centos/$releasever/os/$basearch/ gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7 [updates] name=CentOS-$releasever - Updates baseurl=https://mirrors.ustc.edu.cn/centos-vault/centos/$releasever/updates/$basearch/ gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7 [extras] name=CentOS-$releasever - Extras baseurl=https://mirrors.ustc.edu.cn/centos-vault/centos/$releasever/extras/$basearch/ gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7 [centosplus] name=CentOS-$releasever - Plus baseurl=https://mirrors.ustc.edu.cn/centos-vault/centos/$releasever/centosplus/$basearch/ gpgcheck=1 enabled=0 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7 EOF cat \u0026gt; /etc/yum.repos.d/epel-ustc.repo \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; [epel] name=Extra Packages for Enterprise Linux $releasever - $basearch baseurl=https://mirrors.ustc.edu.cn/epel-archive/7/x86_64/ enabled=1 gpgcheck=1 countme=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-$releasever [epel-debuginfo] name=Extra Packages for Enterprise Linux $releasever - $basearch - Debug baseurl=https://mirrors.ustc.edu.cn/epel-archive/7/x86_64/debug/ enabled=0 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-$releasever gpgcheck=1 [epel-source] name=Extra Packages for Enterprise Linux $releasever - $basearch - Source baseurl=https://mirrors.ustc.edu.cn/epel-archive/7/source/tree/ enabled=0 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-$releasever gpgcheck=1 EOF yum clean all yum makecache fast yum install -y wget net-tools vim bash-completion ntpdate 1.7 æ—¶é—´é…ç½® timedatectl set-timezone Asia/Shanghai ntpdate time.windows.com 1.8 limit cat \u0026gt;\u0026gt; /etc/security/limits.conf \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; * soft nofile 65535 * hard nofile 65535 * soft nproc 65535 * hard nproc 65535 EOF 1.9 kernel cat \u0026gt;\u0026gt; /etc/sysctl.d/99-sysctl.conf \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; # å…³é—­ipv6 net.ipv6.conf.all.disable_ipv6 = 1 net.ipv6.conf.default.disable_ipv6 = 1 # é¿å…æ”¾å¤§æ”»å‡» net.ipv4.icmp_echo_ignore_broadcasts = 1 # å¼€å¯æ¶æ„icmpé”™è¯¯æ¶ˆæ¯ä¿æŠ¤ net.ipv4.icmp_ignore_bogus_error_responses = 1 # å¼€å¯åå‘è·¯å¾„è¿‡æ»¤ net.ipv4.conf.all.rp_filter = 1 net.ipv4.conf.default.rp_filter = 1 # å…³é—­sysrqåŠŸèƒ½ kernel.sysrq = 0 # coreæ–‡ä»¶åä¸­æ·»åŠ pidä½œä¸ºæ‰©å±•å kernel.core_uses_pid = 1 net.ipv4.tcp_syncookies = 1 # ä¿®æ”¹æ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦ kernel.msgmnb = 65536 kernel.msgmax = 65536 # è®¾ç½®æœ€å¤§å†…å­˜å…±äº«æ®µå¤§å°bytes kernel.shmmax = 68719476736 kernel.shmall = 4294967296 # timewaitçš„æ•°é‡ï¼Œé»˜è®¤180000 net.ipv4.tcp_max_tw_buckets = 6000 net.ipv4.tcp_sack = 1 net.ipv4.tcp_window_scaling = 1 net.ipv4.tcp_rmem = 4096 87380 4194304 net.ipv4.tcp_wmem = 4096 16384 4194304 net.core.wmem_default = 8388608 net.core.rmem_default = 8388608 net.core.rmem_max = 16777216 net.core.wmem_max = 16777216 net.core.netdev_max_backlog = 262144 # é™åˆ¶ä»…ä»…æ˜¯ä¸ºäº†é˜²æ­¢ç®€å•çš„DoS æ”»å‡» net.ipv4.tcp_max_orphans = 3276800 # æ”¶åˆ°å®¢æˆ·ç«¯ç¡®è®¤ä¿¡æ¯çš„è¿æ¥è¯·æ±‚çš„æœ€å¤§å€¼ net.ipv4.tcp_max_syn_backlog = 262144 net.ipv4.tcp_timestamps = 0 # å†…æ ¸æ”¾å¼ƒå»ºç«‹è¿æ¥ä¹‹å‰å‘é€SYNACK åŒ…çš„æ•°é‡ net.ipv4.tcp_synack_retries = 1 # å†…æ ¸æ”¾å¼ƒå»ºç«‹è¿æ¥ä¹‹å‰å‘é€SYN åŒ…çš„æ•°é‡ net.ipv4.tcp_syn_retries = 1 # å¯ç”¨timewait å¿«é€Ÿå›æ”¶ net.ipv4.tcp_tw_recycle = 1 # å¼€å¯é‡ç”¨ã€‚å…è®¸å°†TIME-WAIT sockets é‡æ–°ç”¨äºæ–°çš„TCPè¿æ¥ net.ipv4.tcp_tw_reuse = 1 net.ipv4.tcp_mem = 94500000 915000000 927000000 net.ipv4.tcp_fin_timeout = 1 # å½“keepalive èµ·ç”¨çš„æ—¶å€™ï¼ŒTCP å‘é€keepalive æ¶ˆæ¯çš„é¢‘åº¦ã€‚ç¼ºçœæ˜¯2 å°æ—¶ net.ipv4.tcp_keepalive_time = 30 # ä¿®æ”¹é˜²ç«å¢™è¡¨å¤§å°ï¼Œé»˜è®¤65536 #net.netfilter.nf_conntrack_max=655350 #net.netfilter.nf_conntrack_tcp_timeout_established=1200 EOF sysctl -p 2 ä¸€é”®è„šæœ¬ #!/bin/bash set -e if [ \u0026#34;$(id -u)\u0026#34; -ne 0 ]; then echo \u0026#34;å½“å‰ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜ã€‚è¯·ä½¿ç”¨ç®¡ç†å‘˜æƒé™è¿è¡Œæ­¤è„šæœ¬ã€‚\u0026#34; exit 1 fi echo \u0026#34;========start=============\u0026#34; function setup_selinux_firewalld() { echo \u0026#34;========selinux===========\u0026#34; sed -i \u0026#39;/SELINUX/s/enforcing/disabled/\u0026#39; /etc/selinux/config setenforce 0 echo \u0026#34;========firewalld=========\u0026#34; iptables -F systemctl disable --now firewalld } function setup_format_history() { echo \u0026#34;========history format========\u0026#34; cat \u0026gt; /etc/profile.d/history_conf.sh \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; export HISTFILE=\u0026#34;$HOME/.bash_history\u0026#34; # å†™å…¥æ–‡ä»¶ export HISTSIZE=1000 # historyè¾“å‡ºè®°å½•æ•° export HISTFILESIZE=10000 # HISTFILEæ–‡ä»¶è®°å½•æ•° export HISTIGNORE=\u0026#34;cmd1:cmd2:...\u0026#34; # å¿½ç•¥æŒ‡å®šcmd1,cmd2...çš„å‘½ä»¤ä¸è¢«è®°å½•åˆ°æ–‡ä»¶ï¼›(åŠ å‚æ•°æ—¶ä¼šè®°å½•) export HISTCONTOL=ignoredups # ignoredups ä¸è®°å½•â€œé‡å¤â€çš„å‘½ä»¤ï¼›è¿ç»­ä¸”ç›¸åŒ æ–¹ä¸ºâ€œé‡å¤â€ export PROMPT_COMMAND=\u0026#34;history -a\u0026#34; # è®¾ç½®æ¯æ¡å‘½ä»¤æ‰§è¡Œå®Œç«‹å³å†™å…¥HISTFILE(é»˜è®¤ç­‰å¾…é€€å‡ºä¼šè¯å†™å…¥) export HISTTIMEFORMAT=\u0026#34;$(whoami) %F %T \u0026#34; # è®¾ç½®å‘½ä»¤æ‰§è¡Œæ—¶é—´æ ¼å¼ï¼Œè®°å½•æ–‡ä»¶å¢åŠ æ—¶é—´æˆ³ shopt -s histappend # é˜²æ­¢ä¼šè¯é€€å‡ºæ—¶è¦†ç›–å…¶ä»–ä¼šè¯å†™åˆ°HISTFILEçš„å†…å®¹ EOF source /etc/profile.d/history_conf.sh } function setup_ssh() { echo \u0026#34;========add ssh key========\u0026#34; mkdir /root/.ssh || true chmod 700 /root/.ssh cat \u0026gt; /root/.ssh/authorized_keys \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCeQZmPg93SNx6zzR/l4RiPnHtFPbDTSOL7AtJOIvrlMm300x1OM8a48VqYuKEx7B7WM7UhszVndg8efJv9UdOtOaa0o8L0Wd2uujn2rFKKok69c5i7c/jmU1my9MkEsKpkx1MHQWVZTFqayv/DB9L5GaE/ShChsTSlXoQ6rc6JC4k1zgSsoNSTLwPrbZcDOZWprt/AOhqCklf9mL1E50WTx9XsjxBLqJIwwVEzmHAhzIiVowjBKjJpQ6hEvygCz67gNVn0vAvHPvCz3amrkCQa333Z9r8tbY7mJpq2Anj4qWtlnL9kHreVK6YoKGvM8+DrbVoT5/zM7wMZ+tdLmreUsu4OhgDkE4IgUMHWQ3T1GyD1EjCkqCdSfJbrLaAR8v7g92uDXO5irIyYMc/iQJ8v4okus9Iid61zFF0SPgZEykOVfT7jJqH0a/630D41uD0TK90v5PicVdh1FfEfok8P4F4UHGLUly2jRVBESQ/TXVGPaMITHPEtYEpmT3kmnOk= 15810243114@163.com EOF chmod 600 /root/.ssh/authorized_keys echo \u0026#34;=========setup ssh========\u0026#34; echo \u0026#34;UseDNS no\u0026#34; \u0026gt;\u0026gt; /etc/ssh/sshd_config } function setup_yum() { echo \u0026#34;====backup repo===========\u0026#34; mkdir /etc/yum.repos.d/bak || true mv /etc/yum.repos.d/*.repo /etc/yum.repos.d/bak/ || true echo \u0026#34;====configure tuna repo====\u0026#34; cat \u0026gt; /etc/yum.repos.d/centos-tuna.repo \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; [base] name=CentOS-$releasever - Base baseurl=https://mirrors.ustc.edu.cn/centos-vault/centos/$releasever/os/$basearch/ gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7 [updates] name=CentOS-$releasever - Updates baseurl=https://mirrors.ustc.edu.cn/centos-vault/centos/$releasever/updates/$basearch/ gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7 [extras] name=CentOS-$releasever - Extras baseurl=https://mirrors.ustc.edu.cn/centos-vault/centos/$releasever/extras/$basearch/ gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7 [centosplus] name=CentOS-$releasever - Plus baseurl=https://mirrors.ustc.edu.cn/centos-vault/centos/$releasever/centosplus/$basearch/ gpgcheck=1 enabled=0 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7 EOF cat \u0026gt; /etc/yum.repos.d/epel-ustc.repo \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; [epel] name=Extra Packages for Enterprise Linux $releasever - $basearch baseurl=https://mirrors.ustc.edu.cn/epel-archive/7/x86_64/ enabled=1 gpgcheck=1 countme=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-$releasever [epel-debuginfo] name=Extra Packages for Enterprise Linux $releasever - $basearch - Debug baseurl=https://mirrors.ustc.edu.cn/epel-archive/7/x86_64/debug/ enabled=0 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-$releasever gpgcheck=1 [epel-source] name=Extra Packages for Enterprise Linux $releasever - $basearch - Source baseurl=https://mirrors.ustc.edu.cn/epel-archive/7/source/tree/ enabled=0 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-$releasever gpgcheck=1 EOF echo \u0026#34;====upgrade yum============\u0026#34; yum clean all yum makecache fast echo \u0026#34;====dowload tools=========\u0026#34; yum install -y wget net-tools vim bash-completion ntpdate } function setup_time_limit() { echo \u0026#34;=======setup timezone and ntp======\u0026#34; timedatectl set-timezone Asia/Shanghai ntpdate time.windows.com echo \u0026#34;=======modify limit=========\u0026#34; cat \u0026gt;\u0026gt; /etc/security/limits.conf \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; * soft nofile 65535 * hard nofile 65535 * soft nproc 65535 * hard nproc 65535 EOF } function setup_kernel() { echo \u0026#34;========Optimize kernel========\u0026#34; cat \u0026gt;\u0026gt; /etc/sysctl.d/99-sysctl.conf \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; # å…³é—­ipv6 net.ipv6.conf.all.disable_ipv6 = 1 net.ipv6.conf.default.disable_ipv6 = 1 # é¿å…æ”¾å¤§æ”»å‡» net.ipv4.icmp_echo_ignore_broadcasts = 1 # å¼€å¯æ¶æ„icmpé”™è¯¯æ¶ˆæ¯ä¿æŠ¤ net.ipv4.icmp_ignore_bogus_error_responses = 1 # å¼€å¯åå‘è·¯å¾„è¿‡æ»¤ net.ipv4.conf.all.rp_filter = 1 net.ipv4.conf.default.rp_filter = 1 # å…³é—­sysrqåŠŸèƒ½ kernel.sysrq = 0 # coreæ–‡ä»¶åä¸­æ·»åŠ pidä½œä¸ºæ‰©å±•å kernel.core_uses_pid = 1 net.ipv4.tcp_syncookies = 1 # ä¿®æ”¹æ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦ kernel.msgmnb = 65536 kernel.msgmax = 65536 # è®¾ç½®æœ€å¤§å†…å­˜å…±äº«æ®µå¤§å°bytes kernel.shmmax = 68719476736 kernel.shmall = 4294967296 # timewaitçš„æ•°é‡ï¼Œé»˜è®¤180000 net.ipv4.tcp_max_tw_buckets = 6000 net.ipv4.tcp_sack = 1 net.ipv4.tcp_window_scaling = 1 net.ipv4.tcp_rmem = 4096 87380 4194304 net.ipv4.tcp_wmem = 4096 16384 4194304 net.core.wmem_default = 8388608 net.core.rmem_default = 8388608 net.core.rmem_max = 16777216 net.core.wmem_max = 16777216 net.core.netdev_max_backlog = 262144 # é™åˆ¶ä»…ä»…æ˜¯ä¸ºäº†é˜²æ­¢ç®€å•çš„DoS æ”»å‡» net.ipv4.tcp_max_orphans = 3276800 # æ”¶åˆ°å®¢æˆ·ç«¯ç¡®è®¤ä¿¡æ¯çš„è¿æ¥è¯·æ±‚çš„æœ€å¤§å€¼ net.ipv4.tcp_max_syn_backlog = 262144 net.ipv4.tcp_timestamps = 0 # å†…æ ¸æ”¾å¼ƒå»ºç«‹è¿æ¥ä¹‹å‰å‘é€SYNACK åŒ…çš„æ•°é‡ net.ipv4.tcp_synack_retries = 1 # å†…æ ¸æ”¾å¼ƒå»ºç«‹è¿æ¥ä¹‹å‰å‘é€SYN åŒ…çš„æ•°é‡ net.ipv4.tcp_syn_retries = 1 # å¯ç”¨timewait å¿«é€Ÿå›æ”¶ net.ipv4.tcp_tw_recycle = 1 # å¼€å¯é‡ç”¨ã€‚å…è®¸å°†TIME-WAIT sockets é‡æ–°ç”¨äºæ–°çš„TCPè¿æ¥ net.ipv4.tcp_tw_reuse = 1 net.ipv4.tcp_mem = 94500000 915000000 927000000 net.ipv4.tcp_fin_timeout = 1 # å½“keepalive èµ·ç”¨çš„æ—¶å€™ï¼ŒTCP å‘é€keepalive æ¶ˆæ¯çš„é¢‘åº¦ã€‚ç¼ºçœæ˜¯2 å°æ—¶ net.ipv4.tcp_keepalive_time = 30 # ä¿®æ”¹é˜²ç«å¢™è¡¨å¤§å°ï¼Œé»˜è®¤65536 #net.netfilter.nf_conntrack_max=655350 #net.netfilter.nf_conntrack_tcp_timeout_established=1200 EOF sysctl -p } setup_selinux_firewalld setup_format_history setup_ssh setup_yum setup_time_limit setup_kernel echo \u0026#34;=========finish============\u0026#34; exit 0 ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/shell-centos-init/","summary":"0 å‰è¨€ ä»¥ centos7 ä¸ºä¾‹, é€šå¸¸æˆ‘ä»¬æ–°è£…å®Œæ“ä½œç³»ç»Ÿåéœ€è¦è¿›è¡Œé…ç½® yum æº, iptables, selinux, ntp ä»¥åŠä¼˜åŒ– kernel ç­‰æ“ä½œ, ç°åˆ†äº«ä¸€äº›è¾ƒä¸ºé€šç”¨çš„é…ç½®. åŒæ—¶åšä¸»å°†è¿™äº›é…ç½®æ•´ç†æˆäº†è„šæœ¬, å¯ä»¥ä¸€é”®æ‰§è¡Œ. 1 å¸¸ç”¨é…ç½® 1.1 iptables \u0026amp; selinux sed -i \u0026#39;/SELINUX/s/enforcing/disabled/\u0026#39; /etc/selinux/config setenforce 0 iptables -F systemctl disable --now firewalld 1.2 PS1 ç»ˆç«¯ç¾åŒ– cat \u0026gt; /etc/profile.d/PS1_conf.sh \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; export PS1=\u0026#34;\\n[\\[\\e[31m\\]\\u\\[\\e[m\\]@\\[\\e[32m\\]\\h\\[\\e[m\\]] -\\$?- \\[\\e[33m\\]\\$(pwd)\\[\\e[m\\] \\[\\e[34m\\]\\$(date +\u0026#39;%F %T\u0026#39;)\\[\\e[m\\] \\n(\\#)$ \u0026#34; EOF source /etc/profile.d/PS1_conf.sh 1.3 history æ ¼å¼åŒ– cat \u0026gt; /etc/profile.d/history_conf.sh \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; export HISTFILE=\u0026#34;$HOME/.bash_history\u0026#34; # å†™å…¥æ–‡ä»¶ export HISTSIZE=1000","title":"shell | centos åˆå§‹åŒ–"},{"content":"0 å‰è¨€ åŸºäº centos7.9 docker-ce-20.10.18 kubelet-1.22.3-0 loki-2.3.0 promtail-2.3.0\nè¿™æ¬¡éƒ¨ç½²çš„ loki æ•´ä½“æ¶æ„å¦‚ä¸‹, loki ä½¿ç”¨ statefulset çš„æ–¹å¼è¿è¡Œ, promtail ä»¥ daemonset çš„æ–¹å¼è¿è¡Œåœ¨ k8s é›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹.\n1 promtail 1.1 éƒ¨ç½² namespace\napiVersion: v1 kind: Namespace metadata: name: logging rbac\napiVersion: v1 kind: ServiceAccount metadata: name: loki-promtail labels: app: promtail namespace: logging --- kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1 metadata: labels: app: promtail name: promtail-clusterrole namespace: logging rules: - apiGroups: [\u0026#34;\u0026#34;] resources: - nodes - nodes/proxy - services - endpoints - pods verbs: [\u0026#34;get\u0026#34;, \u0026#34;watch\u0026#34;, \u0026#34;list\u0026#34;] --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: promtail-clusterrolebinding labels: app: promtail namespace: logging subjects: - kind: ServiceAccount name: loki-promtail namespace: logging roleRef: kind: ClusterRole name: promtail-clusterrole apiGroup: rbac.authorization.k8s.io configmap\napiVersion: v1 kind: ConfigMap metadata: name: loki-promtail namespace: logging labels: app: promtail data: promtail.yaml: | client: # é…ç½®Promtailå¦‚ä½•è¿æ¥åˆ°Lokiçš„å®ä¾‹ backoff_config: # é…ç½®å½“è¯·æ±‚å¤±è´¥æ—¶å¦‚ä½•é‡è¯•è¯·æ±‚ç»™Loki max_period: 5m max_retries: 10 min_period: 500ms batchsize: 1048576 # å‘é€ç»™Lokiçš„æœ€å¤§æ‰¹æ¬¡å¤§å°(ä»¥å­—èŠ‚ä¸ºå•ä½) batchwait: 1s # å‘é€æ‰¹å¤„ç†å‰ç­‰å¾…çš„æœ€å¤§æ—¶é—´ï¼ˆå³ä½¿æ‰¹æ¬¡å¤§å°æœªè¾¾åˆ°æœ€å¤§å€¼ï¼‰ external_labels: {} # æ‰€æœ‰å‘é€ç»™Lokiçš„æ—¥å¿—æ·»åŠ é™æ€æ ‡ç­¾ timeout: 10s # ç­‰å¾…æœåŠ¡å™¨å“åº”è¯·æ±‚çš„æœ€å¤§æ—¶é—´ positions: filename: /run/promtail/positions.yaml server: http_listen_port: 3101 target_config: sync_period: 10s scrape_configs: - job_name: kubernetes-pods-name pipeline_stages: - docker: {} kubernetes_sd_configs: - role: pod relabel_configs: - source_labels: - __meta_kubernetes_pod_label_name target_label: __service__ - source_labels: - __meta_kubernetes_pod_node_name target_label: __host__ - action: drop regex: \u0026#39;\u0026#39; source_labels: - __service__ - action: labelmap regex: __meta_kubernetes_pod_label_(.+) - action: replace replacement: $1 separator: / source_labels: - __meta_kubernetes_namespace - __service__ target_label: job - action: replace source_labels: - __meta_kubernetes_namespace target_label: namespace - action: replace source_labels: - __meta_kubernetes_pod_name target_label: pod - action: replace source_labels: - __meta_kubernetes_pod_container_name target_label: container - replacement: /var/log/pods/*$1/*.log separator: / source_labels: - __meta_kubernetes_pod_uid - __meta_kubernetes_pod_container_name target_label: __path__ - job_name: kubernetes-pods-app pipeline_stages: - docker: {} kubernetes_sd_configs: - role: pod relabel_configs: - action: drop regex: .+ source_labels: - __meta_kubernetes_pod_label_name - source_labels: - __meta_kubernetes_pod_label_app target_label: __service__ - source_labels: - __meta_kubernetes_pod_node_name target_label: __host__ - action: drop regex: \u0026#39;\u0026#39; source_labels: - __service__ - action: labelmap regex: __meta_kubernetes_pod_label_(.+) - action: replace replacement: $1 separator: / source_labels: - __meta_kubernetes_namespace - __service__ target_label: job - action: replace source_labels: - __meta_kubernetes_namespace target_label: namespace - action: replace source_labels: - __meta_kubernetes_pod_name target_label: pod - action: replace source_labels: - __meta_kubernetes_pod_container_name target_label: container - replacement: /var/log/pods/*$1/*.log separator: / source_labels: - __meta_kubernetes_pod_uid - __meta_kubernetes_pod_container_name target_label: __path__ - job_name: kubernetes-pods-direct-controllers pipeline_stages: - docker: {} kubernetes_sd_configs: - role: pod relabel_configs: - action: drop regex: .+ separator: \u0026#39;\u0026#39; source_labels: - __meta_kubernetes_pod_label_name - __meta_kubernetes_pod_label_app - action: drop regex: \u0026#39;[0-9a-z-.]+-[0-9a-f]{8,10}\u0026#39; source_labels: - __meta_kubernetes_pod_controller_name - source_labels: - __meta_kubernetes_pod_controller_name target_label: __service__ - source_labels: - __meta_kubernetes_pod_node_name target_label: __host__ - action: drop regex: \u0026#39;\u0026#39; source_labels: - __service__ - action: labelmap regex: __meta_kubernetes_pod_label_(.+) - action: replace replacement: $1 separator: / source_labels: - __meta_kubernetes_namespace - __service__ target_label: job - action: replace source_labels: - __meta_kubernetes_namespace target_label: namespace - action: replace source_labels: - __meta_kubernetes_pod_name target_label: pod - action: replace source_labels: - __meta_kubernetes_pod_container_name target_label: container - replacement: /var/log/pods/*$1/*.log separator: / source_labels: - __meta_kubernetes_pod_uid - __meta_kubernetes_pod_container_name target_label: __path__ - job_name: kubernetes-pods-indirect-controller pipeline_stages: - docker: {} kubernetes_sd_configs: - role: pod relabel_configs: - action: drop regex: .+ separator: \u0026#39;\u0026#39; source_labels: - __meta_kubernetes_pod_label_name - __meta_kubernetes_pod_label_app - action: keep regex: \u0026#39;[0-9a-z-.]+-[0-9a-f]{8,10}\u0026#39; source_labels: - __meta_kubernetes_pod_controller_name - action: replace regex: \u0026#39;([0-9a-z-.]+)-[0-9a-f]{8,10}\u0026#39; source_labels: - __meta_kubernetes_pod_controller_name target_label: __service__ - source_labels: - __meta_kubernetes_pod_node_name target_label: __host__ - action: drop regex: \u0026#39;\u0026#39; source_labels: - __service__ - action: labelmap regex: __meta_kubernetes_pod_label_(.+) - action: replace replacement: $1 separator: / source_labels: - __meta_kubernetes_namespace - __service__ target_label: job - action: replace source_labels: - __meta_kubernetes_namespace target_label: namespace - action: replace source_labels: - __meta_kubernetes_pod_name target_label: pod - action: replace source_labels: - __meta_kubernetes_pod_container_name target_label: container - replacement: /var/log/pods/*$1/*.log separator: / source_labels: - __meta_kubernetes_pod_uid - __meta_kubernetes_pod_container_name target_label: __path__ - job_name: kubernetes-pods-static pipeline_stages: - docker: {} kubernetes_sd_configs: - role: pod relabel_configs: - action: drop regex: \u0026#39;\u0026#39; source_labels: - __meta_kubernetes_pod_annotation_kubernetes_io_config_mirror - action: replace source_labels: - __meta_kubernetes_pod_label_component target_label: __service__ - source_labels: - __meta_kubernetes_pod_node_name target_label: __host__ - action: drop regex: \u0026#39;\u0026#39; source_labels: - __service__ - action: labelmap regex: __meta_kubernetes_pod_label_(.+) - action: replace replacement: $1 separator: / source_labels: - __meta_kubernetes_namespace - __service__ target_label: job - action: replace source_labels: - __meta_kubernetes_namespace target_label: namespace - action: replace source_labels: - __meta_kubernetes_pod_name target_label: pod - action: replace source_labels: - __meta_kubernetes_pod_container_name target_label: container - replacement: /var/log/pods/*$1/*.log separator: / source_labels: - __meta_kubernetes_pod_annotation_kubernetes_io_config_mirror - __meta_kubernetes_pod_container_name target_label: __path__ daemonset\napiVersion: apps/v1 kind: DaemonSet metadata: name: loki-promtail namespace: logging labels: app: promtail spec: selector: matchLabels: app: promtail updateStrategy: rollingUpdate: maxUnavailable: 1 type: RollingUpdate template: metadata: labels: app: promtail spec: serviceAccountName: loki-promtail containers: - name: promtail image: grafana/promtail:2.3.0 imagePullPolicy: IfNotPresent args: - -config.file=/etc/promtail/promtail.yaml - -client.url=http://loki:3100/loki/api/v1/push env: - name: HOSTNAME valueFrom: fieldRef: apiVersion: v1 fieldPath: spec.nodeName volumeMounts: - mountPath: /etc/promtail name: config - mountPath: /run/promtail name: run - mountPath: /var/lib/docker/containers name: docker readOnly: true - mountPath: /var/log/pods name: pods readOnly: true ports: - containerPort: 3101 name: http protocol: TCP securityContext: readOnlyRootFilesystem: true runAsGroup: 0 runAsUser: 0 readinessProbe: failureThreshold: 5 httpGet: path: /ready port: http-metrics scheme: HTTP initialDelaySeconds: 10 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 1 tolerations: - operator: Exists volumes: - name: config configMap: defaultMode: 420 name: loki-promtail - name: run hostPath: path: /run/promtail type: \u0026#34;\u0026#34; - name: docker hostPath: path: /var/lib/docker/containers - name: pods hostPath: path: /var/log/pods 1.2 é…ç½®è¯¦è§£ ä¸»è¦è§£é‡Šä¸€ä¸‹ promtail ä¸­çš„åŒ¹é…è§„åˆ™, å› ä¸ºé‡‡é›†çš„æ—¥å¿—å¯ä»¥è¯´éå¸¸åœ°æ‚ä¹±, å¦‚ä½•å°†åº”ç”¨æ—¥å¿—åˆ†ç±»å°±å°¤ä¸ºé‡è¦, å¯ä»¥è¯´åŒ¹é…è§„åˆ™æ˜¯ promtail çš„æ ¸å¿ƒæ‰€åœ¨\né€šå¸¸æˆ‘ä»¬åˆ†ç±» pod çš„æ‰‹æ®µåŸºæœ¬ä¸º namespace + labels + controller , åœ¨ loki ä¸­ä¹Ÿä¸€æ ·, åœ¨ä¸Šè¿° configmap çš„é…ç½®ä¸­å°† k8s ä¸­çš„æ‰€æœ‰ pod åˆ†ä¸ºäº†äº”ç±»:\nå®šä¹‰äº† label_name æœªå®šä¹‰ label_name, å®šä¹‰äº† label_app æœªå®šä¹‰ label_name \u0026amp; label_app, ç”± Daemonset æ§åˆ¶ æœªå®šä¹‰ label_name \u0026amp; label_app, ç”±é Daemonset æ§åˆ¶ æœªå®šä¹‰ label_name \u0026amp; label_app, ç”± kubelet ç›´æ¥æ§åˆ¶ å¯¹åº”ä¸Šè¿° configmap ä¸­é…ç½®çš„äº”ä¸ª job:\nkubernetes-pods-name job=namespace/label_name kubernetes-pods-app job=namespace/label_app kubernetes-pods-direct-controllers job=namespace/controller kubernetes-pods-indirect-controllers job=namespace/controller kubernetes-pods-static job=namespace/label_component æ¯ä¸ªæŒ‡æ ‡æ•°æ®å°†ç”±ä¸Šè¿°è§„åˆ™åˆ†ç±», æ·»åŠ ä¸€ä¸ª job çš„ label\nç„¶ååŸºäºæŒ‡æ ‡æ•°æ®å¯¹åº” pod çš„æ‰€æœ‰ label é™„åŠ åˆ°æŒ‡æ ‡æ•°æ®ä¸Š\n- action: labelmap regex: __meta_kubernetes_pod_label_(.+) å†åŠ ä¸ŠæŒ‡æ ‡æ•°æ®æœ¬èº«æºå¸¦çš„ä¸€äº› label, æˆ‘ä»¬å°±å¯ä»¥å¯¹ pod æ—¥å¿—åšä¸€ä¸ªååˆ†ç»†è‡´çš„åŒºåˆ†\n2 loki rbac\napiVersion: v1 kind: ServiceAccount metadata: name: loki namespace: logging --- apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: name: loki namespace: logging rules: - apiGroups: - extensions resourceNames: - loki resources: - podsecuritypolicies verbs: - use --- apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: loki namespace: logging roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: loki subjects: - kind: ServiceAccount name: loki configmap\napiVersion: v1 kind: ConfigMap metadata: name: loki namespace: logging labels: app: loki data: loki.yaml: | auth_enabled: false ingester: chunk_idle_period: 3m # å¦‚æœå—æ²¡æœ‰è¾¾åˆ°æœ€å¤§çš„å—å¤§å°ï¼Œé‚£ä¹ˆåœ¨åˆ·æ–°ä¹‹å‰ï¼Œå—åº”è¯¥åœ¨å†…å­˜ä¸­ä¸æ›´æ–°å¤šé•¿æ—¶é—´ chunk_block_size: 262144 chunk_retain_period: 1m # å—åˆ·æ–°ååº”è¯¥åœ¨å†…å­˜ä¸­ä¿ç•™å¤šé•¿æ—¶é—´ max_transfer_retries: 0 # Number of times to try and transfer chunks when leaving before falling back to flushing to the store. Zero = no transfers are done. lifecycler: # é…ç½®ingesterçš„ç”Ÿå‘½å‘¨æœŸï¼Œä»¥åŠåœ¨å“ªé‡Œæ³¨å†Œä»¥è¿›è¡Œå‘ç° ring: kvstore: store: inmemory # ç”¨äºringçš„åç«¯å­˜å‚¨ï¼Œæ”¯æŒconsulã€etcdã€inmemory replication_factor: 1 # å†™å…¥å’Œè¯»å–çš„ingestersæ•°é‡ï¼Œè‡³å°‘ä¸º1ï¼ˆä¸ºäº†å†—ä½™å’Œå¼¹æ€§ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸º3) limits_config: enforce_metric_name: false reject_old_samples: true # æ—§æ ·å“æ˜¯å¦ä¼šè¢«æ‹’ç» reject_old_samples_max_age: 168h # æ‹’ç»æ—§æ ·æœ¬çš„æœ€å¤§æ—¶é™ schema_config: # é…ç½®ä»ç‰¹å®šæ—¶é—´æ®µå¼€å§‹åº”è¯¥ä½¿ç”¨å“ªäº›ç´¢å¼•æ¨¡å¼ configs: - from: 2020-10-24 # åˆ›å»ºç´¢å¼•çš„æ—¥æœŸã€‚å¦‚æœè¿™æ˜¯å”¯ä¸€çš„schema_configï¼Œåˆ™ä½¿ç”¨è¿‡å»çš„æ—¥æœŸï¼Œå¦åˆ™ä½¿ç”¨å¸Œæœ›åˆ‡æ¢æ¨¡å¼æ—¶çš„æ—¥æœŸ store: boltdb-shipper # ç´¢å¼•ä½¿ç”¨å“ªä¸ªå­˜å‚¨ï¼Œå¦‚ï¼šcassandra, bigtable, dynamodbï¼Œæˆ–boltdb object_store: filesystem # ç”¨äºå—çš„å­˜å‚¨ï¼Œå¦‚ï¼šgcs, s3ï¼Œ inmemory, filesystem, cassandraï¼Œå¦‚æœçœç•¥ï¼Œé»˜è®¤å€¼ä¸storeç›¸åŒ schema: v11 index: # é…ç½®å¦‚ä½•æ›´æ–°å’Œå­˜å‚¨ç´¢å¼• prefix: index_ # æ‰€æœ‰å‘¨æœŸè¡¨çš„å‰ç¼€ period: 24h # è¡¨å‘¨æœŸ server: http_listen_port: 3100 storage_config: # ä¸ºç´¢å¼•å’Œå—é…ç½®ä¸€ä¸ªæˆ–å¤šä¸ªå­˜å‚¨ boltdb_shipper: active_index_directory: /data/loki/boltdb-shipper-active cache_location: /data/loki/boltdb-shipper-cache cache_ttl: 24h shared_store: filesystem filesystem: directory: /data/loki/chunks chunk_store_config: # é…ç½®å¦‚ä½•ç¼“å­˜å—ï¼Œä»¥åŠåœ¨å°†å®ƒä»¬ä¿å­˜åˆ°å­˜å‚¨ä¹‹å‰ç­‰å¾…å¤šé•¿æ—¶é—´ max_look_back_period: 0s # é™åˆ¶æŸ¥è¯¢æ•°æ®çš„æ—¶é—´ï¼Œé»˜è®¤æ˜¯ç¦ç”¨çš„ï¼Œè¿™ä¸ªå€¼åº”è¯¥å°äºæˆ–ç­‰äºtable_manager.retention_periodä¸­çš„å€¼ table_manager: retention_deletes_enabled: true # æ—¥å¿—ä¿ç•™å‘¨æœŸå¼€å…³ï¼Œç”¨äºè¡¨ä¿ç•™åˆ é™¤ retention_period: 48h # æ—¥å¿—ä¿ç•™å‘¨æœŸï¼Œä¿ç•™æœŸå¿…é¡»æ˜¯ç´¢å¼•/å—çš„å€æ•° compactor: working_directory: /data/loki/boltdb-shipper-compactor shared_store: filesystem ruler: storage: type: local local: directory: /etc/loki/rules/rules1.yaml rule_path: /tmp/loki/rules-temp alertmanager_url: http://alertmanager-main.monitoring.svc:9093 ring: kvstore: store: inmemory enable_api: true enable_alertmanager_v2: true statefulset service, æ³¨æ„ä¿®æ”¹ storageClass ä¸ºè‡ªå·±çš„\n--- apiVersion: v1 kind: Service metadata: name: loki namespace: logging labels: app: loki spec: type: ClusterIP ports: - port: 3100 protocol: TCP name: http targetPort: http selector: app: loki --- apiVersion: apps/v1 kind: StatefulSet metadata: name: loki namespace: logging labels: app: loki spec: podManagementPolicy: OrderedReady replicas: 1 selector: matchLabels: app: loki serviceName: loki updateStrategy: type: RollingUpdate template: metadata: labels: app: loki spec: serviceAccountName: loki securityContext: fsGroup: 10001 runAsGroup: 10001 runAsNonRoot: true runAsUser: 10001 initContainers: [] containers: - name: loki image: grafana/loki:2.3.0 imagePullPolicy: IfNotPresent args: - -config.file=/etc/loki/loki.yaml volumeMounts: - name: config mountPath: /etc/loki - name: storage mountPath: /data ports: - name: http-metrics containerPort: 3100 protocol: TCP livenessProbe: httpGet: path: /ready port: http-metrics scheme: HTTP initialDelaySeconds: 45 timeoutSeconds: 1 periodSeconds: 10 successThreshold: 1 failureThreshold: 3 readinessProbe: httpGet: path: /ready port: http-metrics scheme: HTTP initialDelaySeconds: 45 timeoutSeconds: 1 periodSeconds: 10 successThreshold: 1 failureThreshold: 3 securityContext: readOnlyRootFilesystem: true terminationGracePeriodSeconds: 4800 volumes: - name: config configMap: defaultMode: 420 name: loki volumeClaimTemplates: - metadata: name: storage labels: app: loki annotations: volume.beta.kubernetes.io/storage-class: \u0026#34;nfs\u0026#34; # æ³¨æ„ä¿®æ”¹ storageClass åç§° spec: accessModes: - ReadWriteOnce resources: requests: storage: \u0026#34;2Gi\u0026#34; åº”ç”¨æ‰€æœ‰é…ç½®æ–‡ä»¶, ä¸Šè¿°é…ç½®æ˜¯ loki é’ˆå¯¹ k8s çš„ä¸€å¥—æ¯”è¾ƒæ ‡å‡†çš„é…ç½®, æ‰€ä»¥ç›®å‰çš„é…ç½®ä»…èƒ½æŠ“å– k8s ä¸­æ‰€æœ‰ pod å‘é€åˆ° stdout å’Œ stderr çš„ä¿¡æ¯, å¦‚æœéœ€è¦æŠ“å–æ—¥å¿—æ–‡ä»¶è¿˜éœ€å¦å¤–é…ç½®.\n[root@k8s-node1 ~]# kubectl apply -f /opt/loki/ [root@k8s-node1 ~]# kubectl get pods -n logging NAME READY STATUS RESTARTS AGE loki-0 1/1 Running 0 3m29s loki-promtail-4kskw 1/1 Running 0 3m36s loki-promtail-p7qzr 1/1 Running 0 3m36s loki-promtail-wc5f7 1/1 Running 0 3m37s [root@k8s-node1 ~]# kubectl get svc -n logging NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE loki ClusterIP 10.105.115.178 \u0026lt;none\u0026gt; 3100/TCP 4m26s 3 Grafana grafana éƒ¨ç½²è¯·å‚è€ƒåšä¸»çš„ prometheus ç³»åˆ—æ–‡ç« \n3.1 é…ç½® åœ¨ grafana ä¸­æ·»åŠ  loki ä½œä¸º data source, è¿™é‡Œæˆ‘çš„ grafana æ˜¯ç›´æ¥éƒ¨ç½²åœ¨ k8s ä¸­çš„, æ‰€ä»¥å¯ä»¥é€šè¿‡ \u0026lt;svc-name\u0026gt;.\u0026lt;namespace\u0026gt; è®¿é—®åˆ° loki\nåœ¨ Explore =\u0026gt; loki =\u0026gt; {job=\u0026quot;kube-system/kube-apiserver\u0026quot;} å¯ä»¥çœ‹åˆ° k8s çš„ api-server ç›¸å…³æ—¥å¿—\n3.1 å…‰æ ‡è·³åŠ¨é—®é¢˜ åœ¨ grafana ä¸­æ‰‹åŠ¨å†™ logQL æŸ¥è¯¢æ•°æ®æ—¶æ€»ä¼šå‡ºç°å…‰æ ‡è¦ä¹ˆä¸€ç›´å¾€è¡Œé¦–è·³, è¦ä¹ˆä¸€ç›´å¾€è¡Œå°¾è·³, Github ä¹Ÿæœ‰å¾ˆå¤šäººé‡åˆ°äº†åŒæ ·çš„é—®é¢˜, ç¤¾åŒºä»æœªè§£å†³è¯¥é—®é¢˜, ç›®å‰å¯ä»¥é€šè¿‡ F12 æ§åˆ¶å°è¾“å…¥ä¸€æ¡æŒ‡ä»¤å•æ¬¡åœ°ä¿®å¤è¿™ä¸ªé—®é¢˜, æŒ‡ä»¤å¦‚ä¸‹\ndocument.querySelectorAll(\u0026#34;.slate-query-field \u0026gt; div\u0026#34;)[0][\u0026#39;style\u0026#39;].removeProperty(\u0026#39;-webkit-user-modify\u0026#39;); 4 dashboard ç¤ºä¾‹ 4.1 traefik traefik éƒ¨ç½²å‚è€ƒåšä¸»çš„ traefik ç³»åˆ—æ–‡ç« \nå¦‚ä¸‹å›¾æ‰€ç¤º, å·²ç»å¯ä»¥çœ‹åˆ°æ”¶é›†åˆ°çš„ traefik æ—¥å¿—\næˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ dashboard å®æ—¶å±•ç¤º traefik çš„ä¿¡æ¯, åœ¨ grafana å¯¼å…¥ 13713 å·æ¨¡æ¿\næ­¤ dashboard é»˜è®¤çš„ traefik çš„é‡‡é›†è¯­å¥æ˜¯ {job=\u0026quot;/var/log/traefik.log\u0026quot;} , æˆ‘ä»¬éœ€è¦æŒ‰ç…§å®é™…æƒ…å†µè¿›è¡Œä¿®æ”¹, è¿™é‡Œæˆ‘æ”¹æˆäº† {app=\u0026quot;traefik/traefik\u0026quot;}\nå¯¼å…¥ä¿®æ”¹å¥½çš„ yaml, é€‰æ‹©æ•°æ®æº\nå¯ä»¥çœ‹åˆ°å·²ç»å¯ä»¥æ­£å¸¸å±•ç¤ºæ•°æ®äº†\nä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªå°æŠ¥é”™, æ˜¯å› ä¸ºè¿™ä¸ª dashboard ä¾èµ– grafana-piechart-panel è¿™ä¸ªæ’ä»¶, æˆ‘ä»¬åœ¨ grafana å®¹å™¨å†…æ‰§è¡Œå®‰è£…æ’ä»¶\n[root@k8s-node1 manifests]# kubectl exec -it grafana-78bb4557f5-7rbbq -n monitoring -- grafana-cli plugins install grafana-piechart-panel âœ” Downloaded grafana-piechart-panel v1.6.4 zip successfully Please restart Grafana after installing plugins. Refer to Grafana documentation for instructions if necessary. [root@k8s-node1 manifests]# kubectl delete pod grafana-78bb4557f5-7rbbq -n monitoring pod \u0026#34;grafana-78bb4557f5-7rbbq\u0026#34; deleted ç­‰å¾…é‡å»º pod, å¯ä»¥çœ‹åˆ°è¿™é‡Œå·²ç»å¯ä»¥æ­£å¸¸æ˜¾ç¤ºäº†\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-loki-2-deploy/","summary":"0 å‰è¨€ åŸºäº centos7.9 docker-ce-20.10.18 kubelet-1.22.3-0 loki-2.3.0 promtail-2.3.0 è¿™æ¬¡éƒ¨ç½²çš„ loki æ•´ä½“æ¶æ„å¦‚ä¸‹, loki ä½¿ç”¨ statefulset çš„æ–¹å¼è¿è¡Œ, promtail ä»¥ daemonset çš„æ–¹å¼è¿è¡Œåœ¨ k8s é›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹. 1 promtail 1.1 éƒ¨ç½² namespace apiVersion: v1 kind: Namespace metadata: name: logging rbac apiVersion: v1 kind: ServiceAccount metadata: name: loki-promtail labels: app: promtail namespace: logging --- kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1 metadata: labels: app: promtail name: promtail-clusterrole namespace: logging rules: - apiGroups: [\u0026#34;\u0026#34;] resources: - nodes - nodes/proxy - services - endpoints - pods verbs: [\u0026#34;get\u0026#34;, \u0026#34;watch\u0026#34;, \u0026#34;list\u0026#34;] --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: promtail-clusterrolebinding labels: app: promtail namespace: logging subjects: - kind: ServiceAccount name: loki-promtail namespace: logging roleRef: kind: ClusterRole name: promtail-clusterrole apiGroup: rbac.authorization.k8s.io configmap apiVersion: v1","title":"loki (äºŒ) éƒ¨ç½²"},{"content":"0 å‰è¨€ åŸºäº centos7.9 docker-ce-20.10.18 kubelet-1.22.3-0 loki-2.3.0 promtail-2.3.0\n1 ç®€ä»‹ é¡¹ç›®åœ°å€ å®˜æ–¹æ–‡æ¡£\nLoki æ˜¯ Grafana Labs å›¢é˜Ÿæœ€æ–°çš„å¼€æºé¡¹ç›®ï¼Œæ˜¯ä¸€ä¸ªæ°´å¹³å¯æ‰©å±•ï¼Œé«˜å¯ç”¨æ€§ï¼Œå¤šç§Ÿæˆ·çš„æ—¥å¿—èšåˆç³»ç»Ÿã€‚å®ƒçš„è®¾è®¡éå¸¸ç»æµé«˜æ•ˆä¸”æ˜“äºæ“ä½œï¼Œå› ä¸ºå®ƒä¸ä¼šä¸ºæ—¥å¿—å†…å®¹ç¼–åˆ¶ç´¢å¼•ï¼Œè€Œæ˜¯ä¸ºæ¯ä¸ªæ—¥å¿—æµç¼–åˆ¶ä¸€ç»„æ ‡ç­¾ï¼Œä¸“é—¨ä¸º Prometheus å’Œ Kubernetes ç”¨æˆ·åšäº†ç›¸å…³ä¼˜åŒ–ã€‚è¯¥é¡¹ç›®å— Prometheus å¯å‘ï¼Œå®˜æ–¹çš„ä»‹ç»å°±æ˜¯ï¼š Like Prometheus, But For Logs.\n2 ä¼˜ç¼ºç‚¹ ä¸å…¶ä»–æ—¥å¿—èšåˆç³»ç»Ÿç›¸æ¯”ï¼Œ Loki å…·æœ‰ä¸‹é¢çš„ä¸€äº›ç‰¹æ€§:\nä½ç´¢å¼•å¼€é”€ ä¸å¯¹æ—¥å¿—è¿›è¡Œå…¨æ–‡ç´¢å¼•ã€‚é€šè¿‡å­˜å‚¨å‹ç¼©éç»“æ„åŒ–æ—¥å¿—å’Œä»…ç´¢å¼•å…ƒæ•°æ®ï¼ŒLoki æ“ä½œèµ·æ¥ä¼šæ›´ç®€å•ï¼Œæ›´çœæˆæœ¬ã€‚ è¿™æ ·åšå¯ä»¥å¤§å¹…é™ä½ç´¢å¼•èµ„æºå¼€é”€, es æ— è®ºä½ æŸ¥ä¸æŸ¥ï¼Œå·¨å¤§çš„ç´¢å¼•å¼€é”€å¿…é¡»æ—¶åˆ»æ‰¿æ‹… å¹¶å‘æŸ¥è¯¢ ä¸ºäº†å¼¥è¡¥æ²¡æœ‰å…¨æ–‡ç´¢å¼•å¸¦æ¥çš„æŸ¥è¯¢é™é€Ÿä½¿ç”¨ï¼ŒLoki å°†æŠŠæŸ¥è¯¢åˆ†è§£æˆè¾ƒå°çš„åˆ†ç‰‡ï¼Œå¯ä»¥ç†è§£ä¸ºå¹¶å‘çš„ grep å’Œ prometheus é‡‡ç”¨ç›¸åŒçš„æ ‡ç­¾ï¼Œå¯¹æ¥ alertmanager Loki å’Œ Prometheus ä¹‹é—´çš„æ ‡ç­¾ä¸€è‡´æ˜¯ Loki çš„è¶…çº§èƒ½åŠ›ä¹‹ä¸€ å—åˆ° Grafana åŸç”Ÿæ”¯æŒ é¿å… kibana å’Œ grafana æ¥å›åˆ‡æ¢ æœåŠ¡å‘ç° æ”¯æŒä¸ prometheus ä¸€æ ·çš„æœåŠ¡å‘ç°åŠŸèƒ½, ç‰¹åˆ«é€‚åˆå‚¨å­˜ Kubernetes Pod æ—¥å¿— æ— éœ€ä½¿ç”¨æ—¥å¿—è½ç›˜æˆ–è€… sidecar å½“ç„¶, å®ƒä¹Ÿæœ‰ä¸€å®šçš„ç¼ºç‚¹:\næŠ€æœ¯æ¯”è¾ƒæ–°é¢–ï¼Œç›¸å¯¹åº”çš„è®ºå›ä¸æ˜¯éå¸¸æ´»è·ƒã€‚ åŠŸèƒ½å•ä¸€ï¼Œåªé’ˆå¯¹æ—¥å¿—çš„æŸ¥çœ‹ï¼Œç­›é€‰æœ‰å¥½çš„è¡¨ç°ï¼Œå¯¹äºæ•°æ®çš„å¤„ç†ä»¥åŠæ¸…æ´—æ²¡æœ‰ ELK å¼ºå¤§ï¼ŒåŒæ—¶ä¸ ELK ç›¸æ¯”ï¼Œå¯¹äºåæœŸï¼ŒELK å¯ä»¥è¿ç”¨å„ç§æŠ€æœ¯è¿›è¡Œæ—¥å¿—çš„å¤§æ•°æ®å¤„ç†ï¼Œä½†æ˜¯ loki ä¸è¡Œã€‚ 3 æ¶æ„ 3.1 æ•´ä½“æ¶æ„ åœ¨ Loki æ¶æ„ä¸­æœ‰ä»¥ä¸‹å‡ ä¸ªæ¦‚å¿µï¼š\nGrafanaï¼šç›¸å½“äº EFK ä¸­çš„ Kibana ï¼Œç”¨äº UI çš„å±•ç¤ºã€‚ Lokiï¼šç›¸å½“äº EFK ä¸­çš„ ElasticSearch ï¼Œç”¨äºå­˜å‚¨æ—¥å¿—å’Œå¤„ç†æŸ¥è¯¢ã€‚ Promtailï¼šç›¸å½“äº EFK ä¸­çš„ Filebeat/Fluentd ï¼Œç”¨äºé‡‡é›†æ—¥å¿—å¹¶å°†å…¶å‘é€ç»™ Loki ã€‚ LogQLï¼šLoki æä¾›çš„æ—¥å¿—æŸ¥è¯¢è¯­è¨€ï¼Œç±»ä¼¼ Prometheus çš„ PromQLï¼Œè€Œä¸” Loki æ”¯æŒ LogQL æŸ¥è¯¢ç›´æ¥è½¬æ¢ä¸º Prometheus æŒ‡æ ‡ã€‚ 3.2 promtail å®˜æ–¹æ–‡æ¡£\npromtail æ˜¯ loki æ¶æ„ä¸­æœ€å¸¸ç”¨çš„é‡‡é›†å™¨, ç›¸å½“äº EFK ä¸­çš„ filebeat/fluentd\nå®ƒçš„ä¸»è¦å·¥ä½œæµç¨‹:\nä½¿ç”¨ fsnotify ç›‘å¬æŒ‡å®šç›®å½•ä¸‹ï¼ˆä¾‹å¦‚ï¼š/var/log/*.logï¼‰çš„æ–‡ä»¶åˆ›å»ºä¸åˆ é™¤ å¯¹æ¯ä¸ªæ´»è·ƒçš„æ—¥å¿—æ–‡ä»¶èµ·ä¸€ä¸ª goroutine è¿›è¡Œç±»ä¼¼ tail -f çš„è¯»å–ï¼Œè¯»å–åˆ°çš„å†…å®¹å‘é€ç»™ channel æœ‰ä¸€ä¸ªå•ç‹¬çš„ goroutine ä¼šè¯»å– channel ä¸­çš„æ—¥å¿—è¡Œï¼Œåˆ†æ‰¹å¹¶é™„åŠ ä¸Šæ ‡ç­¾åæ¨é€ç»™ Loki 3.3 loki Loki é‡‡ç”¨è¯»å†™åˆ†ç¦»æ¶æ„ï¼Œå…³é”®ç»„ä»¶æœ‰ï¼š\nDistributor åˆ†å‘å™¨ï¼šæ—¥å¿—æ•°æ®ä¼ è¾“çš„â€œç¬¬ä¸€ç«™â€ï¼ŒDistributor åˆ†å‘å™¨æ¥æ”¶åˆ°æ—¥å¿—æ•°æ®åï¼Œæ ¹æ®å…ƒæ•°æ®å’Œ hash ç®—æ³•ï¼Œå°†æ—¥å¿—åˆ†æ‰¹å¹¶è¡Œåœ°å‘é€åˆ°å¤šä¸ª Ingester æ¥æ”¶å™¨ä¸Š Ingester æ¥æ”¶å™¨ï¼šæ¥æ”¶å™¨æ˜¯ä¸€ä¸ªæœ‰çŠ¶æ€çš„ç»„ä»¶ï¼Œåœ¨æ—¥å¿—è¿›å…¥æ—¶å¯¹å…¶è¿›è¡Œ gzip å‹ç¼©æ“ä½œï¼Œå¹¶è´Ÿè´£æ„å»ºå’Œåˆ·æ–° chunck å—ï¼Œå½“ chunk å—è¾¾åˆ°ä¸€å®šçš„æ•°é‡æˆ–è€…æ—¶é—´åï¼Œå°±ä¼šåˆ·æ–° chunk å—å’Œå¯¹åº”çš„ Index ç´¢å¼•å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ Querier æŸ¥è¯¢å™¨ï¼šç»™å®šä¸€ä¸ªæ—¶é—´èŒƒå›´å’Œæ ‡ç­¾é€‰æ‹©å™¨ï¼ŒQuerier æŸ¥è¯¢å™¨å¯ä»¥ä»æ•°æ®åº“ä¸­æŸ¥çœ‹ Index ç´¢å¼•ä»¥ç¡®å®šå“ªäº› chunck å—åŒ¹é…ï¼Œå¹¶é€šè¿‡ greps å°†ç»“æœæ˜¾ç¤ºå‡ºæ¥ï¼Œå®ƒè¿˜ä¼šç›´æ¥ä» Ingester æ¥æ”¶å™¨è·å–å°šæœªåˆ·æ–°çš„æœ€æ–°æ•°æ® Query frontend æŸ¥è¯¢å‰ç«¯ï¼šæŸ¥è¯¢å‰ç«¯æ˜¯ä¸€ä¸ªå¯é€‰çš„ç»„ä»¶ï¼Œè¿è¡Œåœ¨ Querier æŸ¥è¯¢å™¨ä¹‹å‰ï¼Œèµ·åˆ°ç¼“å­˜ï¼Œå‡è¡¡è°ƒåº¦çš„åŠŸèƒ½ï¼Œç”¨äºåŠ é€Ÿæ—¥å¿—æŸ¥è¯¢ Loki æä¾›äº†ä¸¤ç§éƒ¨ç½²æ–¹å¼ï¼š\nå•ä½“æ¨¡å¼ï¼ŒALL IN ONEï¼šLoki æ”¯æŒå•ä¸€è¿›ç¨‹æ¨¡å¼ï¼Œå¯åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­è¿è¡Œæ‰€æœ‰å¿…éœ€çš„ç»„ä»¶ã€‚å•è¿›ç¨‹æ¨¡å¼éå¸¸é€‚åˆæµ‹è¯• Loki æˆ–ä»¥å°è§„æ¨¡è¿è¡Œã€‚ä¸è¿‡å°½ç®¡æ¯ä¸ªç»„ä»¶éƒ½ä»¥ç›¸åŒçš„è¿›ç¨‹è¿è¡Œï¼Œä½†å®ƒä»¬ä»å°†é€šè¿‡æœ¬åœ°ç½‘ç»œç›¸äº’è¿æ¥è¿›è¡Œç»„ä»¶ä¹‹é—´çš„é€šä¿¡ï¼ˆgrpcï¼‰ã€‚ä½¿ç”¨ Helm éƒ¨ç½²å°±æ˜¯é‡‡ç”¨çš„è¯¥æ¨¡å¼ã€‚ å¾®æœåŠ¡æ¨¡å¼ï¼šä¸ºäº†å®ç°æ°´å¹³å¯ä¼¸ç¼©æ€§ï¼ŒLoki æ”¯æŒç»„ä»¶æ‹†åˆ†ä¸ºå•ç‹¬çš„ç»„ä»¶åˆ†å¼€éƒ¨ç½²ï¼Œä»è€Œä½¿å®ƒä»¬å½¼æ­¤ç‹¬ç«‹åœ°æ‰©å±•ã€‚æ¯ä¸ªç»„ä»¶éƒ½äº§ç”Ÿä¸€ä¸ªç”¨äºå†…éƒ¨è¯·æ±‚çš„ gRPC æœåŠ¡å™¨å’Œä¸€ä¸ªç”¨äºå¤–éƒ¨ API è¯·æ±‚çš„ HTTP æœåŠ¡ï¼Œæ‰€æœ‰ç»„ä»¶éƒ½å¸¦æœ‰ HTTP æœåŠ¡å™¨ï¼Œä½†æ˜¯å¤§å¤šæ•°åªæš´éœ²å°±ç»ªæ¥å£ã€è¿è¡ŒçŠ¶å†µå’ŒæŒ‡æ ‡ç«¯ç‚¹ã€‚ 4 æ—¥å¿—å‘Šè­¦ Loki æ”¯æŒä¸‰ç§æ¨¡å¼åˆ›å»ºæ—¥å¿—å‘Šè­¦ï¼š\nåœ¨ Promtail ä¸­çš„ pipeline ç®¡é“çš„ metrics çš„é˜¶æ®µï¼Œæ ¹æ®éœ€æ±‚å¢åŠ ä¸€ä¸ªç›‘æ§æŒ‡æ ‡ï¼Œç„¶åä½¿ç”¨ Prometheus ç»“åˆ Alertmanager å®Œæˆç›‘æ§æŠ¥è­¦ã€‚ é€šè¿‡ Loki è‡ªå¸¦çš„æŠ¥è­¦åŠŸèƒ½ï¼ˆ Ruler ç»„ä»¶ï¼‰å¯ä»¥æŒç»­æŸ¥è¯¢ä¸€ä¸ª rules è§„åˆ™ï¼Œå¹¶å°†è¶…è¿‡é˜ˆå€¼çš„äº‹ä»¶æ¨é€ç»™ AlertManager æˆ–è€…å…¶ä»– Webhook æœåŠ¡ã€‚ å°† LogQL æŸ¥è¯¢è½¬æ¢ä¸º Prometheus æŒ‡æ ‡ã€‚å¯ä»¥é€šè¿‡ Grafana è‡ªå¸¦çš„ Alert rules \u0026amp; notificationsï¼Œå®šä¹‰æœ‰å…³ LogQL æŒ‡æ ‡çš„æŠ¥è­¦ï¼Œæ¨é€åˆ° Notification channelsï¼ˆ Prometheus Alertmanager ï¼Œ Webhook ç­‰ï¼‰ã€‚ ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-loki-1-jianjie/","summary":"0 å‰è¨€ åŸºäº centos7.9 docker-ce-20.10.18 kubelet-1.22.3-0 loki-2.3.0 promtail-2.3.0 1 ç®€ä»‹ é¡¹ç›®åœ°å€ å®˜æ–¹æ–‡æ¡£ Loki æ˜¯ Grafana Labs å›¢é˜Ÿæœ€æ–°çš„å¼€æºé¡¹ç›®ï¼Œæ˜¯ä¸€ä¸ªæ°´å¹³å¯æ‰©å±•ï¼Œé«˜å¯ç”¨æ€§ï¼Œå¤šç§Ÿæˆ·çš„æ—¥å¿—èšåˆç³»ç»Ÿã€‚å®ƒçš„è®¾è®¡éå¸¸ç»æµé«˜æ•ˆä¸”æ˜“äºæ“ä½œï¼Œå› ä¸ºå®ƒä¸ä¼šä¸ºæ—¥å¿—å†…å®¹ç¼–åˆ¶ç´¢å¼•ï¼Œè€Œæ˜¯ä¸ºæ¯ä¸ªæ—¥å¿—æµç¼–åˆ¶ä¸€ç»„æ ‡ç­¾ï¼Œä¸“é—¨ä¸º Prometheus å’Œ Kubernetes ç”¨æˆ·åšäº†ç›¸å…³ä¼˜åŒ–ã€‚è¯¥é¡¹ç›®å— Prometheus å¯å‘ï¼Œå®˜æ–¹çš„ä»‹ç»å°±æ˜¯ï¼š Like Prometheus, But","title":"loki (ä¸€) ç®€ä»‹"},{"content":"0 å‰è¨€ åŸºäº centos7.9 docker-ce-20.10.18 kubelet-1.22.3-0 kube-prometheus-0.10 prometheus-v2.32.1\n1 alertmanager prometheus æ¶æ„ä¸­é‡‡é›†æ•°æ®å’Œå‘é€å‘Šè­¦æ˜¯ç‹¬ç«‹å‡ºæ¥çš„, å‘Šè­¦è§¦å‘åå°†ä¿¡æ¯è½¬å‘åˆ°ç‹¬ç«‹çš„ç»„ä»¶ alertmanager, ç”± alertmanager å¯¹æŠ¥è­¦è¿›è¡Œç»Ÿä¸€å¤„ç†, æœ€åé€šè¿‡æ¥æ”¶å™¨ recevier å‘é€ç»™æŒ‡å®šç”¨æˆ·\n1.1 å·¥ä½œæœºåˆ¶ Alertmanager æ”¶åˆ°å‘Šè­¦ä¿¡æ¯å:\nè¿›è¡Œåˆ†ç»„ group é€šè¿‡å®šä¹‰å¥½çš„è·¯ç”± routing è½¬å‘åˆ°æ­£ç¡®çš„æ¥æ”¶å™¨ recevier recevier é€šè¿‡ email dingtalk wechat ç­‰æ–¹å¼é€šçŸ¥ç»™å®šä¹‰å¥½çš„æ¥æ”¶äºº 1.2 å››å¤§åŠŸèƒ½ åˆ†ç»„ (Grouping): å°†åŒç±»å‹çš„å‘Šè­¦è¿›è¡Œåˆ†ç»„, åˆå¹¶å¤šæ¡å‘Šè­¦åˆ°ä¸€ä¸ªé€šçŸ¥ä¸­ æŠ‘åˆ¶ (Inhibition): å½“æŸæ¡å‘Šè­¦å·²ç»å‘é€, åœæ­¢é‡å¤å‘é€ç”±æ­¤å‘Šè­¦å¼•èµ·çš„å…¶ä»–å¼‚å¸¸æˆ–è€…æ•…éšœ é™é»˜ (Silences): æ ¹æ®æ ‡ç­¾å¿«é€Ÿå¯¹å‘Šè­¦è¿›è¡Œé™é»˜å¤„ç†, å¦‚æœå‘Šè­¦ç¬¦åˆé™é»˜çš„é…ç½®, Alertmanager åˆ™ä¸ä¼šå‘é€å‘Šè­¦é€šçŸ¥ è·¯ç”± (route): ç”¨äºé…ç½® Alertmanager å¦‚ä½•å¤„ç†ä¼ å…¥çš„ç‰¹å®šç±»å‹çš„å‘Šè­¦é€šçŸ¥ 1.3 é…ç½®è¯¦è§£ global: # ç»è¿‡æ­¤æ—¶é—´åï¼Œå¦‚æœå°šæœªæ›´æ–°å‘Šè­¦ï¼Œåˆ™å°†å‘Šè­¦å£°æ˜ä¸ºå·²æ¢å¤ã€‚(å³ prometheus æ²¡æœ‰å‘ alertmanager å‘é€å‘Šè­¦äº†) resolve_timeout: 5m # é…ç½®å‘é€é‚®ä»¶ä¿¡æ¯ smtp_smarthost: \u0026#39;smtp.qq.com:465\u0026#39; smtp_from: \u0026#39;742899387@qq.com\u0026#39; smtp_auth_username: \u0026#39;742899387@qq.com\u0026#39; smtp_auth_password: \u0026#39;password\u0026#39; smtp_require_tls: false # è¯»å–å‘Šè­¦é€šçŸ¥æ¨¡æ¿çš„ç›®å½•ã€‚ templates: - \u0026#39;/etc/alertmanager/template/*.tmpl\u0026#39; # æ‰€æœ‰æŠ¥è­¦éƒ½ä¼šè¿›å…¥åˆ°è¿™ä¸ªæ ¹è·¯ç”±ä¸‹ï¼Œå¯ä»¥æ ¹æ®æ ¹è·¯ç”±ä¸‹çš„å­è·¯ç”±è®¾ç½®æŠ¥è­¦åˆ†å‘ç­–ç•¥ route: # å…ˆè§£é‡Šä¸€ä¸‹åˆ†ç»„ï¼Œåˆ†ç»„å°±æ˜¯å°†å¤šæ¡å‘Šè­¦ä¿¡æ¯èšåˆæˆä¸€æ¡å‘é€ï¼Œè¿™æ ·å°±ä¸ä¼šæ”¶åˆ°è¿ç»­çš„æŠ¥è­¦äº†ã€‚ # å°†ä¼ å…¥çš„å‘Šè­¦æŒ‰æ ‡ç­¾åˆ†ç»„(æ ‡ç­¾åœ¨ prometheus ä¸­çš„ rules ä¸­å®šä¹‰)ï¼Œä¾‹å¦‚ï¼š # æ¥æ”¶åˆ°çš„å‘Šè­¦ä¿¡æ¯é‡Œé¢æœ‰è®¸å¤šå…·æœ‰ cluster=A å’Œ alertname=LatencyHigh çš„æ ‡ç­¾ï¼Œè¿™äº›ä¸ªå‘Šè­¦å°†è¢«åˆ†ä¸ºä¸€ä¸ªç»„ã€‚ # # å¦‚æœä¸æƒ³ä½¿ç”¨åˆ†ç»„ï¼Œå¯ä»¥è¿™æ ·å†™group_by: [...] group_by: [\u0026#39;alertname\u0026#39;, \u0026#39;cluster\u0026#39;, \u0026#39;service\u0026#39;] # ç¬¬ä¸€ç»„å‘Šè­¦å‘é€é€šçŸ¥éœ€è¦ç­‰å¾…çš„æ—¶é—´ï¼Œè¿™ç§æ–¹å¼å¯ä»¥ç¡®ä¿æœ‰è¶³å¤Ÿçš„æ—¶é—´ä¸ºåŒä¸€åˆ†ç»„è·å–å¤šä¸ªå‘Šè­¦ï¼Œç„¶åä¸€èµ·è§¦å‘è¿™ä¸ªå‘Šè­¦ä¿¡æ¯ã€‚ group_wait: 30s # å‘é€ç¬¬ä¸€ä¸ªå‘Šè­¦åï¼Œç­‰å¾…\u0026#34;group_interval\u0026#34;å‘é€ä¸€ç»„æ–°å‘Šè­¦ã€‚ group_interval: 5m # åˆ†ç»„å†…å‘é€ç›¸åŒå‘Šè­¦çš„æ—¶é—´é—´éš”ã€‚è¿™é‡Œçš„é…ç½®æ˜¯æ¯3å°æ—¶å‘é€å‘Šè­¦åˆ°åˆ†ç»„ä¸­ã€‚ä¸¾ä¸ªä¾‹å­ï¼šæ”¶åˆ°å‘Šè­¦åï¼Œä¸€ä¸ªåˆ†ç»„è¢«åˆ›å»ºï¼Œç­‰å¾…5åˆ†é’Ÿå‘é€ç»„å†…å‘Šè­¦ï¼Œå¦‚æœåç»­ç»„å†…çš„å‘Šè­¦ä¿¡æ¯ç›¸åŒ,è¿™äº›å‘Šè­¦ä¼šåœ¨3å°æ—¶åå‘é€ï¼Œä½†æ˜¯3å°æ—¶å†…è¿™äº›å‘Šè­¦ä¸ä¼šè¢«å‘é€ã€‚ repeat_interval: 3h # è¿™é‡Œå…ˆè¯´ä¸€ä¸‹ï¼Œå‘Šè­¦å‘é€æ˜¯éœ€è¦æŒ‡å®šæ¥æ”¶å™¨çš„ï¼Œæ¥æ”¶å™¨åœ¨receiversä¸­é…ç½®ï¼Œæ¥æ”¶å™¨å¯ä»¥æ˜¯emailã€webhookã€pagerdutyã€wechatç­‰ç­‰ã€‚ä¸€ä¸ªæ¥æ”¶å™¨å¯ä»¥æœ‰å¤šç§å‘é€æ–¹å¼ã€‚ # æŒ‡å®šé»˜è®¤çš„æ¥æ”¶å™¨ receiver: team-X-mails # ä¸‹é¢é…ç½®çš„æ˜¯å­è·¯ç”±ï¼Œå­è·¯ç”±çš„å±æ€§ç»§æ‰¿äºæ ¹è·¯ç”±(å³ä¸Šé¢çš„é…ç½®)ï¼Œåœ¨å­è·¯ç”±ä¸­å¯ä»¥è¦†ç›–æ ¹è·¯ç”±çš„é…ç½® # ä¸‹é¢æ˜¯å­è·¯ç”±çš„é…ç½® routes: # ä½¿ç”¨æ­£åˆ™çš„æ–¹å¼åŒ¹é…å‘Šè­¦æ ‡ç­¾ - match_re: # è¿™é‡Œå¯ä»¥åŒ¹é…å‡ºæ ‡ç­¾å«æœ‰ service=foo1 æˆ– service=foo2 æˆ– service=baz çš„å‘Šè­¦ service: ^(foo1|foo2|baz)$ # æŒ‡å®šæ¥æ”¶å™¨ä¸º team-X-mails receiver: team-X-mails # è¿™é‡Œé…ç½®çš„æ˜¯å­è·¯ç”±çš„å­è·¯ç”±ï¼Œå½“æ»¡è¶³çˆ¶è·¯ç”±çš„çš„åŒ¹é…æ—¶ï¼Œè¿™æ¡å­è·¯ç”±ä¼šè¿›ä¸€æ­¥åŒ¹é…å‡º severity=critical çš„å‘Šè­¦ï¼Œå¹¶ä½¿ç”¨ team-X-pager æ¥æ”¶å™¨å‘é€å‘Šè­¦ï¼Œæ²¡æœ‰åŒ¹é…åˆ°çš„å‘Šè­¦ä¼šç”±çˆ¶è·¯ç”±è¿›è¡Œå¤„ç†ã€‚ routes: - match: severity: critical receiver: team-X-pager # è¿™é‡Œä¹Ÿæ˜¯ä¸€æ¡å­è·¯ç”±ï¼Œä¼šåŒ¹é…å‡ºæ ‡ç­¾å«æœ‰ service=files çš„å‘Šè­¦ï¼Œå¹¶ä½¿ç”¨ team-Y-mails æ¥æ”¶å™¨å‘é€å‘Šè­¦ - match: service: files receiver: team-Y-mails # è¿™é‡Œé…ç½®çš„æ˜¯å­è·¯ç”±çš„å­è·¯ç”±ï¼Œå½“æ»¡è¶³çˆ¶è·¯ç”±çš„çš„åŒ¹é…æ—¶ï¼Œè¿™æ¡å­è·¯ç”±ä¼šè¿›ä¸€æ­¥åŒ¹é…å‡º severity=critical çš„å‘Šè­¦ï¼Œå¹¶ä½¿ç”¨ team-Y-pager æ¥æ”¶å™¨å‘é€å‘Šè­¦ï¼Œæ²¡æœ‰åŒ¹é…åˆ°çš„ä¼šç”±çˆ¶è·¯ç”±è¿›è¡Œå¤„ç†ã€‚ routes: - match: severity: critical receiver: team-Y-pager # è¯¥è·¯ç”±å¤„ç†æ¥è‡ªæ•°æ®åº“æœåŠ¡çš„æ‰€æœ‰è­¦æŠ¥ã€‚å¦‚æœæ²¡æœ‰å›¢é˜Ÿæ¥å¤„ç†ï¼Œåˆ™é»˜è®¤ä¸ºæ•°æ®åº“å›¢é˜Ÿã€‚ - match: # é¦–å…ˆåŒ¹é…æ ‡ç­¾service=database service: database # æŒ‡å®šæ¥æ”¶å™¨ receiver: team-DB-pager # æ ¹æ®å—å½±å“çš„æ•°æ®åº“å¯¹å‘Šè­¦è¿›è¡Œåˆ†ç»„ group_by: [alertname, cluster, database] routes: - match: owner: team-X receiver: team-X-pager # å‘Šè­¦æ˜¯å¦ç»§ç»­åŒ¹é…åç»­çš„åŒçº§è·¯ç”±èŠ‚ç‚¹ï¼Œé»˜è®¤falseï¼Œä¸‹é¢å¦‚æœä¹Ÿå¯ä»¥åŒ¹é…æˆåŠŸï¼Œä¼šå‘ä¸¤ç§æ¥æ”¶å™¨éƒ½å‘é€å‘Šè­¦ä¿¡æ¯(çŒœæµ‹ã€‚ã€‚ã€‚) continue: true - match: owner: team-Y receiver: team-Y-pager # ä¸‹é¢æ˜¯å…³äºinhibit(æŠ‘åˆ¶)çš„é…ç½®ï¼Œå…ˆè¯´ä¸€ä¸‹æŠ‘åˆ¶æ˜¯ä»€ä¹ˆï¼šæŠ‘åˆ¶è§„åˆ™å…è®¸åœ¨å¦ä¸€ä¸ªè­¦æŠ¥æ­£åœ¨è§¦å‘çš„æƒ…å†µä¸‹ä½¿ä¸€ç»„å‘Šè­¦é™éŸ³ã€‚å…¶å®å¯ä»¥ç†è§£ä¸ºå‘Šè­¦ä¾èµ–ã€‚æ¯”å¦‚ä¸€å°æ•°æ®åº“æœåŠ¡å™¨æ‰ç”µäº†ï¼Œä¼šå¯¼è‡´dbç›‘æ§å‘Šè­¦ã€ç½‘ç»œå‘Šè­¦ç­‰ç­‰ï¼Œå¯ä»¥é…ç½®æŠ‘åˆ¶è§„åˆ™å¦‚æœæœåŠ¡å™¨æœ¬èº«downäº†ï¼Œé‚£ä¹ˆå…¶ä»–çš„æŠ¥è­¦å°±ä¸ä¼šè¢«å‘é€å‡ºæ¥ã€‚ inhibit_rules: #ä¸‹é¢é…ç½®çš„å«ä¹‰ï¼šå½“æœ‰å¤šæ¡å‘Šè­¦åœ¨å‘Šè­¦ç»„é‡Œæ—¶ï¼Œå¹¶ä¸”ä»–ä»¬çš„æ ‡ç­¾alertname,cluster,serviceéƒ½ç›¸ç­‰ï¼Œå¦‚æœseverity: \u0026#39;critical\u0026#39;çš„å‘Šè­¦äº§ç”Ÿäº†ï¼Œé‚£ä¹ˆå°±ä¼šæŠ‘åˆ¶severity: \u0026#39;warning\u0026#39;çš„å‘Šè­¦ã€‚ - source_match: # æºå‘Šè­¦(æˆ‘ç†è§£æ˜¯æ ¹æ®è¿™ä¸ªæŠ¥è­¦æ¥æŠ‘åˆ¶target_matchä¸­åŒ¹é…çš„å‘Šè­¦) severity: \u0026#39;critical\u0026#39; # æ ‡ç­¾åŒ¹é…æ»¡è¶³severity=criticalçš„å‘Šè­¦ä½œä¸ºæºå‘Šè­¦ target_match: # ç›®æ ‡å‘Šè­¦(è¢«æŠ‘åˆ¶çš„å‘Šè­¦) severity: \u0026#39;warning\u0026#39; # å‘Šè­¦å¿…é¡»æ»¡è¶³æ ‡ç­¾åŒ¹é…severity=warningæ‰ä¼šè¢«æŠ‘åˆ¶ã€‚ equal: [\u0026#39;alertname\u0026#39;, \u0026#39;cluster\u0026#39;, \u0026#39;service\u0026#39;] # å¿…é¡»åœ¨æºå‘Šè­¦å’Œç›®æ ‡å‘Šè­¦ä¸­å…·æœ‰ç›¸ç­‰å€¼çš„æ ‡ç­¾æ‰èƒ½ä½¿æŠ‘åˆ¶ç”Ÿæ•ˆã€‚(å³æºå‘Šè­¦å’Œç›®æ ‡å‘Šè­¦ä¸­è¿™ä¸‰ä¸ªæ ‡ç­¾çš„å€¼ç›¸ç­‰\u0026#39;alertname\u0026#39;, \u0026#39;cluster\u0026#39;, \u0026#39;service\u0026#39;) # ä¸‹é¢é…ç½®çš„æ˜¯æ¥æ”¶å™¨ receivers: # æ¥æ”¶å™¨çš„åç§°ã€é€šè¿‡é‚®ä»¶çš„æ–¹å¼å‘é€ã€ - name: \u0026#39;team-X-mails\u0026#39; email_configs: # å‘é€ç»™å“ªäº›äºº - to: \u0026#39;team-X+alerts@example.org\u0026#39; # æ˜¯å¦é€šçŸ¥å·²è§£å†³çš„è­¦æŠ¥ send_resolved: true # æ¥æ”¶å™¨çš„åç§°ã€é€šè¿‡é‚®ä»¶å’Œpagerdutyçš„æ–¹å¼å‘é€ã€å‘é€ç»™å“ªäº›äººï¼ŒæŒ‡å®špagerdutyçš„service_key - name: \u0026#39;team-X-pager\u0026#39; email_configs: - to: \u0026#39;team-X+alerts-critical@example.org\u0026#39; pagerduty_configs: - service_key: \u0026lt;team-X-key\u0026gt; # æ¥æ”¶å™¨çš„åç§°ã€é€šè¿‡é‚®ä»¶çš„æ–¹å¼å‘é€ã€å‘é€ç»™å“ªäº›äºº - name: \u0026#39;team-Y-mails\u0026#39; email_configs: - to: \u0026#39;team-Y+alerts@example.org\u0026#39; # æ¥æ”¶å™¨çš„åç§°ã€é€šè¿‡pagerdutyçš„æ–¹å¼å‘é€ã€æŒ‡å®špagerdutyçš„service_key - name: \u0026#39;team-Y-pager\u0026#39; pagerduty_configs: - service_key: \u0026lt;team-Y-key\u0026gt; # ä¸€ä¸ªæ¥æ”¶å™¨é…ç½®å¤šç§å‘é€æ–¹å¼ - name: \u0026#39;ops\u0026#39; webhook_configs: - url: \u0026#39;http://prometheus-webhook-dingtalk.kube-ops.svc.cluster.local:8060/dingtalk/webhook1/send\u0026#39; send_resolved: true email_configs: - to: \u0026#39;742899387@qq.com\u0026#39; send_resolved: true - to: \u0026#39;soulchild@soulchild.cn\u0026#39; send_resolved: true 1.4 Alertmanager CRD Prometheus Operator ä¸º alertmanager æŠ½è±¡äº†ä¸¤ä¸ª CRD èµ„æº:\nalertmanager CRD: åŸºäº statefulset, å®ç° alertmanager çš„éƒ¨ç½²ä»¥åŠæ‰©å®¹ç¼©å®¹ alertmanagerconfig CRD: å®ç°æ¨¡å—åŒ–ä¿®æ”¹ alertmanager çš„é…ç½® é€šè¿‡ alertManager CRD éƒ¨ç½²çš„å®ä¾‹é…ç½®æ–‡ä»¶ç”± secret/alertmanager-main-generated æä¾›\n# kubectl get pod alertmanager-main-0 -n monitoring -o jsonpath=\u0026#39;{.spec.volumes[?(@.name==\u0026#34;config-volume\u0026#34;)]}\u0026#39; | python -m json.tool { \u0026#34;name\u0026#34;: \u0026#34;config-volume\u0026#34;, \u0026#34;secret\u0026#34;: { \u0026#34;defaultMode\u0026#34;: 420, \u0026#34;secretName\u0026#34;: \u0026#34;alertmanager-main-generated\u0026#34; } } # kubectl get secret alertmanager-main-generated -n monitoring -o jsonpath=\u0026#39;{.data.alertmanager\\.yaml}\u0026#39; | base64 --decode \u0026#34;global\u0026#34;: \u0026#34;resolve_timeout\u0026#34;: \u0026#34;5m\u0026#34; \u0026#34;inhibit_rules\u0026#34;: - \u0026#34;equal\u0026#34;: - \u0026#34;namespace\u0026#34; - \u0026#34;alertname\u0026#34; \u0026#34;source_matchers\u0026#34;: ...... secret alertmanager-main-generated æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„, åŸºäº secret alertmanager-main å’Œ CRD alertmanagerConfig\n[root@k8s-node1 manifests]# kubectl explain alertmanager.spec.configSecret DESCRIPTION: ConfigSecret is the name of a Kubernetes Secret in the same namespace as the Alertmanager object, which contains configuration for this Alertmanager instance. Defaults to \u0026#39;alertmanager-\u0026lt;alertmanager-name\u0026gt;\u0026#39; The secret is mounted into /etc/alertmanager/config. ç»¼ä¸Š, ä¿®æ”¹ alertmanager é…ç½®å¯ä»¥ä¿®æ”¹ secret alertmanager-main æˆ–è€… CRD alertmanagerconfig\n2 ç¤ºä¾‹ 2.1 secret æ–°å»º alertmanager.yaml é…ç½®æ–‡ä»¶\nglobal: resolve_timeout: 5m smtp_from: \u0026#39;15810243114@163.com\u0026#39; smtp_smarthost: \u0026#39;smtp.163.com:25\u0026#39; smtp_auth_username: \u0026#39;15810243114@163.com\u0026#39; smtp_auth_password: \u0026#39;******\u0026#39; smtp_require_tls: false smtp_hello: \u0026#39;163.com\u0026#39; route: receiver: Default group_by: - namespace continue: false routes: - receiver: Critical matchers: - severity=\u0026#34;critical\u0026#34; continue: false group_wait: 30s group_interval: 5m repeat_interval: 12h inhibit_rules: - source_matchers: - severity=\u0026#34;critical\u0026#34; target_matchers: - severity=~\u0026#34;warning|info\u0026#34; equal: - namespace - alertname - source_matchers: - severity=\u0026#34;warning\u0026#34; target_matchers: - severity=\u0026#34;info\u0026#34; equal: - namespace - alertname receivers: - name: Default email_configs: - to: \u0026#39;lvbibir@foxmail.com\u0026#39; send_resolved: true - name: Critical email_configs: - to: \u0026#39;lvbibir@foxmail.com\u0026#39; send_resolved: true ä¿®æ”¹ secret alertmanager-main\nkubectl create secret generic additional-scrape-configs -n monitoring --from-file=prometheus-additional.yaml \u0026gt; additional-scrape-configs.yaml kubectl apply -f additional-scrape-configs.yaml æŸ¥çœ‹ç”Ÿæˆçš„ secret alertmanager-main-generated\nkubectl get secret alertmanager-main-generated -n monitoring -o jsonpath=\u0026#39;{.data.alertmanager\\.yaml}\u0026#39; | base64 --decode ä¹‹å prometheus-operator ä¼šè‡ªåŠ¨æ›´æ–° alertmanager çš„é…ç½®\n# kubectl logs -n monitoring -l app.kubernetes.io/name=prometheus-operator | tail -1 level=info ts=2023-04-30T11:43:01.104579363Z caller=operator.go:741 component=alertmanageroperator key=monitoring/main msg=\u0026#34;sync alertmanager\u0026#34; 2.2 alertmanagerconfig é»˜è®¤æƒ…å†µä¸‹é…ç½® alertmanager æ˜¯æ— æ³•è·å–åˆ°çš„, æˆ‘ä»¬éœ€è¦å…ˆä¿®æ”¹ä¸€ä¸‹ alertmanager å®ä¾‹, æ·»åŠ æ ‡ç­¾é€‰æ‹©å™¨\napiVersion: monitoring.coreos.com/v1 kind: Alertmanager metadata: spec: alertmanagerConfigSelector: matchLabels: alertmanager: main åˆ›å»º alertmanager CRD èµ„æº\napiVersion: monitoring.coreos.com/v1alpha1 kind: AlertmanagerConfig metadata: name: dinghook namespace: monitoring labels: alertmanager: main spec: receivers: - name: web webhookConfigs: - url: http://dingtalk-hook-web sendResolved: true - name: db webhookConfigs: - url: http://dingtalk-hook-db sendResolved: true route: groupBy: [\u0026#34;app\u0026#34;] groupWait: 30s groupInterval: 5m repeatInterval: 12h continue: false receiver: web routes: - matchers: - name: app value: nginx receiver: web - matchers: - name: app value: mysql receiver: db åŒæ ·çš„, prometheus-operator ä¼šæ›´æ–° alertmanager é…ç½®\n# kubectl logs -n monitoring -l app.kubernetes.io/name=prometheus-operator | tail -1 level=info ts=2023-04-30T11:55:00.309492873Z caller=operator.go:741 component=alertmanageroperator key=monitoring/main msg=\u0026#34;sync alertmanager\u0026#34; æŸ¥çœ‹æœ€åç”Ÿæˆçš„é…ç½®\n# kubectl get secret alertmanager-main-generated -n monitoring -o jsonpath=\u0026#39;{.data.alertmanager\\.yaml}\u0026#39; | base64 --decode global: resolve_timeout: 5m smtp_from: 15810243114@163.com smtp_hello: 163.com smtp_smarthost: smtp.163.com:25 smtp_auth_username: 15810243114@163.com smtp_auth_password: ********* smtp_require_tls: false route: receiver: Default group_by: - namespace routes: - receiver: monitoring-dinghook-web group_by: - app matchers: - namespace=\u0026#34;monitoring\u0026#34; # æŒ‡å®šåŒ¹é…äº† namespace continue: true # continue ä¹Ÿæ²¡æœ‰æŒ‰ç…§é¢„è®¾é…ç½® routes: - receiver: monitoring-dinghook-web match: app: nginx - receiver: monitoring-dinghook-db match: app: mysql group_wait: 30s group_interval: 5m repeat_interval: 12h - receiver: Critical matchers: - severity=\u0026#34;critical\u0026#34; group_wait: 30s group_interval: 5m repeat_interval: 12h inhibit_rules: - target_matchers: - severity=~\u0026#34;warning|info\u0026#34; source_matchers: - severity=\u0026#34;critical\u0026#34; equal: - namespace - alertname - target_matchers: - severity=\u0026#34;info\u0026#34; source_matchers: - severity=\u0026#34;warning\u0026#34; equal: - namespace - alertname receivers: - name: Default email_configs: - send_resolved: true to: lvbibir@foxmail.com - name: Critical email_configs: - send_resolved: true to: lvbibir@foxmail.com - name: monitoring-dinghook-web webhook_configs: - send_resolved: true url: http://dingtalk-hook-web - name: monitoring-dinghook-db webhook_configs: - send_resolved: true url: http://dingtalk-hook-db templates: [] ç›®å‰ alertmanagerconfig è¿™ä¸ª CRD ä½¿ç”¨èµ·æ¥æ„Ÿè§‰æœ‰ç‚¹éº»çƒ¦, ä¸€çº§ route ç›®å‰åªèƒ½æŒ‰ç…§ namespace ç­›é€‰, è€Œä¸” continue ä¹Ÿåªèƒ½è®¾ç½®æˆ false , è€Œä¸”æ— æ³•æŒ‡å®šå…¶ä»–é…ç½®ä¸­çš„ receiver, æ¯”å¦‚å…¨å±€é…ç½®ä¸­çš„ Default\n[root@k8s-node1 ~]# kubectl explain alertmanagerconfig.spec.route.continue DESCRIPTION: Boolean indicating whether an alert should continue matching subsequent sibling nodes. It will always be overridden to true for the first-level route by the Prometheus operator. [root@k8s-node1 ~]# kubectl explain alertmanagerconfig.spec.route.matchers DESCRIPTION: List of matchers that the alertâ€™s labels should match. For the first level route, the operator removes any existing equality and regexp matcher on the `namespace` label and adds a `namespace: \u0026lt;object namespace\u0026gt;` matcher. 2.3 å‘Šè­¦æ¨¡æ¿ alertmanager æ”¶åˆ°çš„å‘Šè­¦å¤§æ¦‚é•¿è¿™ä¸ªæ ·å­\nalertmanager CRD æ”¯æŒ configMaps å‚æ•°, ä¼šè‡ªåŠ¨æŒ‚è½½åˆ° /etc/alertmanager/configmaps ç›®å½•, æˆ‘ä»¬å¯ä»¥å°†æ¨¡æ¿æ–‡ä»¶é…ç½®æˆ configmap\n[root@k8s-node1 ~]# kubectl explain alertmanager.spec.configMaps DESCRIPTION: ConfigMaps is a list of ConfigMaps in the same namespace as the Alertmanager object, which shall be mounted into the Alertmanager Pods. The ConfigMaps are mounted into /etc/alertmanager/configmaps/\u0026lt;configmap-name\u0026gt;. åˆ›å»ºæ¨¡æ¿æ–‡ä»¶ email.tmpl\n{{ define \u0026#34;email.html\u0026#34; }} {{- if gt (len .Alerts.Firing) 0 -}} {{- range $index, $alert := .Alerts -}} ========= ERROR ==========\u0026lt;br\u0026gt; å‘Šè­¦åç§°ï¼š{{ .Labels.alertname }}\u0026lt;br\u0026gt; å‘Šè­¦çº§åˆ«ï¼š{{ .Labels.severity }}\u0026lt;br\u0026gt; å‘Šè­¦æœºå™¨ï¼š{{ .Labels.instance }} {{ .Labels.device }}\u0026lt;br\u0026gt; å‘Šè­¦è¯¦æƒ…ï¼š{{ .Annotations.summary }}\u0026lt;br\u0026gt; å‘Šè­¦æ—¶é—´ï¼š{{ (.StartsAt.Add 28800e9).Format \u0026#34;2006-01-02 15:04:05\u0026#34; }}\u0026lt;br\u0026gt; ========= END ==========\u0026lt;br\u0026gt; {{- end }} {{- end }} {{- if gt (len .Alerts.Resolved) 0 -}} {{- range $index, $alert := .Alerts -}} ========= INFO ==========\u0026lt;br\u0026gt; å‘Šè­¦åç§°ï¼š{{ .Labels.alertname }}\u0026lt;br\u0026gt; å‘Šè­¦çº§åˆ«ï¼š{{ .Labels.severity }}\u0026lt;br\u0026gt; å‘Šè­¦æœºå™¨ï¼š{{ .Labels.instance }}\u0026lt;br\u0026gt; å‘Šè­¦è¯¦æƒ…ï¼š{{ .Annotations.summary }}\u0026lt;br\u0026gt; å‘Šè­¦æ—¶é—´ï¼š{{ (.StartsAt.Add 28800e9).Format \u0026#34;2006-01-02 15:04:05\u0026#34; }}\u0026lt;br\u0026gt; æ¢å¤æ—¶é—´ï¼š{{ (.EndsAt.Add 28800e9).Format \u0026#34;2006-01-02 15:04:05\u0026#34; }}\u0026lt;br\u0026gt; ========= END ==========\u0026lt;br\u0026gt; {{- end }} {{- end }} {{- end }} åˆ›å»º configmap\nkubectl create configmap alertmanager-templates --from-file=email.tmpl --dry-run -o yaml -n monitoring \u0026gt; alertmanager-configmap-templates.yaml kubectl apply -f alertmanager-configmap-templates.yaml æ›´æ–° alertmanager ç¤ºä¾‹, æ·»åŠ  configmap\napiVersion: monitoring.coreos.com/v1 kind: Alertmanager metadata: spec: alertmanagerConfigSelector: matchLabels: alertmanager: main configMaps: - alertmanager-templates æŸ¥çœ‹æŒ‚è½½\n# kubectl get pod -n monitoring alertmanager-main-0 -o jsonpath=\u0026#34;{.spec.volumes[?(@.name==\u0026#39;configmap-alertmanager-templates\u0026#39;)]}\u0026#34; | python -m json.tool { \u0026#34;configMap\u0026#34;: { \u0026#34;defaultMode\u0026#34;: 420, \u0026#34;name\u0026#34;: \u0026#34;alertmanager-templates\u0026#34; }, \u0026#34;name\u0026#34;: \u0026#34;configmap-alertmanager-templates\u0026#34; } æŸ¥çœ‹å®¹å™¨å†…çš„è·¯å¾„\n# kubectl exec -it alertmanager-main-0 -n monitoring -- sh /alertmanager $ cat /etc/alertmanager/configmaps/alertmanager-templates/email.tmpl ä¿®æ”¹ alertmanager.yaml é…ç½®æ–‡ä»¶, æŒ‡å®šæ¨¡æ¿æ–‡ä»¶\nreceivers: - name: Default email_configs: - to: \u0026#39;lvbibir@foxmail.com\u0026#39; send_resolved: true html: \u0026#39;{{ template \u0026#34;email.html\u0026#34; . }}\u0026#39; # æ·»åŠ  ä¸æ¨¡æ¿ä¸­çš„ define å¯¹åº” - name: Critical email_configs: - to: \u0026#39;lvbibir@foxmail.com\u0026#39; send_resolved: true html: \u0026#39;{{ template \u0026#34;email.html\u0026#34; . }}\u0026#39; # æ·»åŠ  ä¸æ¨¡æ¿ä¸­çš„ define å¯¹åº” templates: - \u0026#39;/etc/alertmanager/configmaps/alertmanager-templates/*.tmpl\u0026#39; æ›´æ–° secret\nkubectl create secret generic alertmanager-main -n monitoring --from-file=alertmanager.yaml --dry-run -oyaml \u0026gt; alertmanager-main-secret.yaml kubectl apply -f alertmanager-main-secret.yaml æŸ¥çœ‹é…ç½®æ˜¯å¦ç”Ÿæ•ˆ, åœ¨ webUI ç•Œé¢æŸ¥çœ‹\næŸ¥çœ‹æ–°ç”Ÿæˆçš„å‘Šè­¦é‚®ä»¶\nå‘Šè­¦é‚®ä»¶ æ¢å¤é‚®ä»¶ ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-prometheus-6-alertmanager/","summary":"0 å‰è¨€ åŸºäº centos7.9 docker-ce-20.10.18 kubelet-1.22.3-0 kube-prometheus-0.10 prometheus-v2.32.1 1 alertmanager prometheus æ¶æ„ä¸­é‡‡é›†æ•°æ®å’Œå‘é€å‘Šè­¦æ˜¯ç‹¬ç«‹å‡ºæ¥çš„, å‘Šè­¦è§¦å‘åå°†ä¿¡æ¯è½¬å‘åˆ°ç‹¬ç«‹çš„ç»„ä»¶ alertmanager, ç”± alertmanager å¯¹æŠ¥è­¦è¿›è¡Œç»Ÿä¸€å¤„ç†, æœ€åé€šè¿‡æ¥æ”¶å™¨ recevier å‘é€ç»™æŒ‡å®šç”¨æˆ· 1.1 å·¥ä½œæœºåˆ¶ Alertmanager æ”¶åˆ°å‘Šè­¦ä¿¡æ¯å: è¿›è¡Œåˆ†ç»„ group é€šè¿‡å®šä¹‰å¥½çš„è·¯ç”± routing è½¬å‘åˆ°æ­£ç¡®çš„æ¥æ”¶å™¨ recevier recevier é€šè¿‡ email dingtalk wechat ç­‰æ–¹å¼é€šçŸ¥ç»™å®šä¹‰å¥½çš„æ¥æ”¶äºº 1.2 å››å¤§åŠŸèƒ½ åˆ†ç»„","title":"prometheus (å…­) Alertmanager"},{"content":"0 å‰è¨€ åŸºäº centos7.9 docker-ce-20.10.18 kubelet-1.22.3-0 kube-prometheus-0.10 prometheus-v2.32.1\n1 å‘Šè­¦è§„åˆ™ prometheus æ”¯æŒä¸¤ç§ç±»å‹çš„è§„åˆ™, è®°å½•è§„åˆ™ recording rule å’Œå‘Šè­¦è§„åˆ™ alerting rule\n1.1 recording rule è®°å½•è§„åˆ™: å…è®¸é¢„å…ˆè®¡ç®—ç»å¸¸éœ€è¦æˆ–è®¡ç®—é‡å¤§çš„è¡¨è¾¾å¼ï¼Œå¹¶å°†å…¶ç»“æœä¿å­˜ä¸ºä¸€ç»„æ–°çš„æ—¶é—´åºåˆ—ã€‚æŸ¥è¯¢é¢„å…ˆè®¡ç®—çš„ç»“æœé€šå¸¸æ¯”æ¯æ¬¡éœ€è¦æ—¶éƒ½æ‰§è¡ŒåŸå§‹è¡¨è¾¾å¼è¦å¿«å¾—å¤šã€‚è¿™å¯¹äºæ¯æ¬¡åˆ·æ–°æ—¶éƒ½éœ€è¦é‡å¤æŸ¥è¯¢ç›¸åŒè¡¨è¾¾å¼çš„ä»ªè¡¨æ¿ç‰¹åˆ«æœ‰ç”¨ã€‚\nå¦‚ä¸‹ç¤ºä¾‹, å°†ç»Ÿè®¡ cpu ä¸ªæ•°çš„è¡¨è¾¾å¼å­˜ä¸ºä¸€ä¸ªæ–°çš„æ—¶é—´åºåˆ— instance:node_num_cpu:sum\ngroups: - name: node-exporter.rules rules: - record: instance:node_num_cpu:sum expr: | count without (cpu, mode) ( node_cpu_seconds_total{job=\u0026#34;node-exporter\u0026#34;,mode=\u0026#34;idle\u0026#34;} ) åŸå§‹è¡¨è¾¾å¼ç»“æœ\næ–°è¡¨è¾¾å¼ç»“æœ\n1.2 alerting rule å‘Šè­¦è§„åˆ™: å½“æ»¡è¶³æŒ‡å®šçš„è§¦å‘æ¡ä»¶æ—¶å‘é€å‘Šè­¦\nalert: å‘Šè­¦è§„åˆ™çš„åç§° expr: å‘Šè­¦è§¦å‘æ¡ä»¶, åŸºäº PromQL è¡¨è¾¾å¼, å¦‚æœè¡¨è¾¾å¼æ‰§è¡Œç»“æœä¸º True åˆ™æ¨é€å‘Šè­¦ for: ç­‰å¾…è¯„ä¼°æ—¶é—´, å¯é€‰å‚æ•°. è¡¨ç¤ºå½“è§¦å‘æ¡ä»¶æŒç»­ä¸€å®šæ—¶é—´åæ‰å‘é€å‘Šè­¦, åœ¨ç­‰å¾…æœŸé—´å‘Šè­¦çš„çŠ¶æ€ä¸º pending labels: è‡ªå®šä¹‰æ ‡ç­¾ annotaions: æŒ‡å®šä¸€ç»„é™„åŠ ä¿¡æ¯, å¯ä»¥ä½¿ç”¨ $labels $externalLabels $value æ ¼å¼åŒ–ä¿¡æ¯. $labels å‚¨å­˜æŠ¥è­¦å®ä¾‹çš„æ—¶åºæ•°æ®; $externalLabels å‚¨å­˜ prometheus ä¸­ global.external_labels é…ç½®çš„æ ‡ç­¾; $value ä¿å­˜æŠ¥è­¦å®ä¾‹çš„è¯„ä¼°å€¼ description: è¯¦ç»†ä¿¡æ¯ summary: æè¿°ä¿¡æ¯ å¦‚ä¸‹ç¤ºä¾‹, å½“èŠ‚ç‚¹çš„æŸä¸ªæ–‡ä»¶ç³»ç»Ÿå‰©ä½™ç©ºé—´ä¸è¶³ 10% è¾¾åˆ° 30 åˆ†é’Ÿåå°†å‘é€å‘Šè­¦\ngroups: - name: test rules: - alert: NodeFilesystemAlmostOutOfSpace expr: node_filesystem_avail_bytes{job=\u0026#34;node-exporter\u0026#34;,fstype!=\u0026#34;\u0026#34;} / node_filesystem_size_bytes{job=\u0026#34;node-exporter\u0026#34;,fstype!=\u0026#34;\u0026#34;} * 100 \u0026lt; 10 for: 30m labels: severity: warning annotations: description: \u0026#39; {{ $labels.instance }} èŠ‚ç‚¹ {{ $labels.device }} æ–‡ä»¶ç³»ç»Ÿå‰©ä½™ç©ºé—´: {{ printf \u0026#34;%.2f\u0026#34; $value }}% \u0026#39; summary: \u0026#39;æ–‡ä»¶ç³»ç»Ÿå‰©ä½™ç©ºé—´ä¸è¶³ 10%\u0026#39; 1.3 prometheusrule CRD Prometheus Operator æŠ½è±¡å‡ºæ¥ä¸€ä¸ª prometheusrule CRD èµ„æº, é€šè¿‡ç®¡ç†è¿™ä¸ª CRD èµ„æºå®ç°å‘Šè­¦è§„åˆ™çš„ç»Ÿä¸€ç®¡ç†\nkube-prometheus é»˜è®¤å¸®æˆ‘ä»¬åˆ›å»ºäº†ä¸€äº›å‘Šè­¦è§„åˆ™\n# kubectl get prometheusrule -A NAMESPACE NAME AGE monitoring alertmanager-main-rules 8d monitoring kube-prometheus-rules 8d monitoring kube-state-metrics-rules 8d monitoring kubernetes-monitoring-rules 8d monitoring node-exporter-rules 8d monitoring prometheus-k8s-prometheus-rules 8d monitoring prometheus-operator-rules 8d prometheusrule å®šä¹‰ä¸€ç³»åˆ—æŠ¥è­¦è§„åˆ™\napiVersion: monitoring.coreos.com/v1 kind: PrometheusRule metadata: labels: name: demo namespace: monitoring spec: groups: - name: group1 rules: - alert: alert1 annotations: description: alert-1 summary: alert-1 expr: up == 0 for: 15m labels: severity: critical - alert: alert2 ...... - name: group2 rules: - alert: alert3 ...... å¯¹äº prometheusrule çš„æ›´æ–°æ“ä½œ (create, delete, update) éƒ½ä¼šè¢« watch åˆ°, ç„¶åæ›´æ–°åˆ°ç»Ÿä¸€çš„ä¸€ä¸ª configmap ä¸­, ç„¶å prometheus è‡ªåŠ¨é‡è½½é…ç½®\næ¯ä¸ª prometheusrule ä¼šä½œä¸º configmap prometheus-k8s-rulefiles-0 ä¸­çš„ä¸€ä¸ª data , data çš„å‘½åè§„åˆ™ä¸º \u0026lt;namespace\u0026gt;-\u0026lt;rulename\u0026gt;-ruleuid\n# kubectl get cm prometheus-k8s-rulefiles-0 -n monitoring NAME DATA AGE prometheus-k8s-rulefiles-0 7 41m # prometheus å®ä¾‹çš„æŒ‚è½½ä¿¡æ¯ # kubectl get pod prometheus-k8s-0 -n monitoring -o jsonpath=\u0026#39;{.spec.volumes[?(@.name==\u0026#34;prometheus-k8s-rulefiles-0\u0026#34;)]}\u0026#39; | python -m json.tool { \u0026#34;configMap\u0026#34;: { \u0026#34;defaultMode\u0026#34;: 420, \u0026#34;name\u0026#34;: \u0026#34;prometheus-k8s-rulefiles-0\u0026#34; }, \u0026#34;name\u0026#34;: \u0026#34;prometheus-k8s-rulefiles-0\u0026#34; } # prometheus ä¸­å®é™…çš„å­˜å‚¨è·¯å¾„ # kubectl exec -it prometheus-k8s-0 -n monitoring -- ls /etc/prometheus/rules/prometheus-k8s-rulefiles-0/ monitoring-alertmanager-main-rules-79a2aba8-1a50-4bbc-b201-e9c8ee43e6aa.yaml monitoring-kube-prometheus-rules-9867eba7-cd4c-4677-b931-4268744ae5e7.yaml monitoring-kube-state-metrics-rules-b787fea0-dba2-4d6d-9fd6-0b470ce45059.yaml monitoring-kubernetes-monitoring-rules-b1939032-6a22-4ce1-b0ce-6482db094018.yaml monitoring-node-exporter-rules-0140bdd4-b858-4672-85be-930eabdc95eb.yaml monitoring-prometheus-k8s-prometheus-rules-87a80a69-f3be-4d3e-8a26-e1da2ade3a0a.yaml monitoring-prometheus-operator-rules-8688aa7b-a157-4ddc-bd09-21781f8ac567.yaml prometheus çš„é…ç½®ä¸­å®šä¹‰äº† rule_files è·¯å¾„\n2 ç¤ºä¾‹ 2.1 ç£ç›˜ä½¿ç”¨ç‡ å½“ç£ç›˜å¯ç”¨ç©ºé—´å°‘äº 50% æ—¶è§¦å‘å‘Šè­¦\nåˆ›å»º prometheusrule\napiVersion: monitoring.coreos.com/v1 kind: PrometheusRule metadata: name: demo namespace: monitoring spec: groups: - name: demo rules: - alert: nodeDiskUsage annotations: description: | èŠ‚ç‚¹ {{$labels.instance }} æŒ‚è½½ç›®å½• {{ $labels.mountpoint }} å½“å‰å¯ç”¨ç©ºé—´ {{ printf \u0026#34;%.2f\u0026#34; $value }}% summary: | æŒ‚è½½ç›®å½•å¯ç”¨ç©ºé—´ä½äº 50% expr: | node_filesystem_avail_bytes{fstype!=\u0026#34;\u0026#34;,job=\u0026#34;node-exporter\u0026#34;} / node_filesystem_size_bytes{fstype!=\u0026#34;\u0026#34;,job=\u0026#34;node-exporter\u0026#34;} * 100 \u0026lt; 50 for: 1m labels: severity: warning æŸ¥çœ‹ç”Ÿæˆçš„å‘Šè­¦è§„åˆ™, å½“å‰çŠ¶æ€æ˜¯ inactive\nnode1 å½“å‰çŠ¶æ€, / ç›®å½•æ€»å®¹é‡ 45G, å¯ç”¨ç©ºé—´ä¸º 82%\n[root@k8s-node1 manifests]# df -hT | head -1 \u0026amp;\u0026amp; df -hT | grep -E \u0026#34;/$\u0026#34; Filesystem Type Size Used Avail Use% Mounted on /dev/mapper/centos_one-root xfs 45G 7.8G 38G 18% / æ¥ä¸‹æ¥ç”¨ dd æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª 25G çš„å¤§æ–‡ä»¶, æ­¤æ—¶å‰©ä½™ç©ºé—´ä»…å‰© 27%\n[root@k8s-node1 manifests]# dd if=/dev/zero of=/tmp/demo bs=1G count=25 [root@k8s-node1 manifests]# df -hT | head -1 \u0026amp;\u0026amp; df -hT | grep -E \u0026#34;/$\u0026#34; Filesystem Type Size Used Avail Use% Mounted on /dev/mapper/centos_one-root xfs 45G 33G 13G 73% / æ­¤æ—¶å‘Šè­¦è§„åˆ™å·²ç»è¿›å…¥ pending çŠ¶æ€äº†, æˆ‘ä»¬è®¾ç½®äº† 1m çš„è¯„ä¼°ç­‰å¾…æ—¶é—´\nä¸€åˆ†é’Ÿè¿‡åè¿›å…¥ firing çŠ¶æ€, æ­£å¼å‘å‡ºå‘Šè­¦, æ­¤æ—¶æˆ‘ä»¬è®¾ç½®çš„ $label è¿˜æ²¡æœ‰è§£æ\næˆ‘ä»¬å» alertmanager çœ‹ä¸€ä¸‹, æˆåŠŸæ”¶åˆ°äº†å‘Šè­¦, ä¸” $labels å’Œ $value ä¹Ÿå·²ç»æ­£å¸¸è§£æäº†\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-prometheus-5-rule/","summary":"0 å‰è¨€ åŸºäº centos7.9 docker-ce-20.10.18 kubelet-1.22.3-0 kube-prometheus-0.10 prometheus-v2.32.1 1 å‘Šè­¦è§„åˆ™ prometheus æ”¯æŒä¸¤ç§ç±»å‹çš„è§„åˆ™, è®°å½•è§„åˆ™ recording rule å’Œå‘Šè­¦è§„åˆ™ alerting rule 1.1 recording rule è®°å½•è§„åˆ™: å…è®¸é¢„å…ˆè®¡ç®—ç»å¸¸éœ€è¦æˆ–è®¡ç®—é‡å¤§çš„è¡¨è¾¾å¼ï¼Œå¹¶å°†å…¶ç»“æœä¿å­˜ä¸ºä¸€ç»„æ–°çš„æ—¶é—´åºåˆ—ã€‚æŸ¥è¯¢é¢„å…ˆè®¡ç®—çš„ç»“æœé€šå¸¸æ¯”æ¯æ¬¡éœ€è¦æ—¶éƒ½æ‰§è¡ŒåŸå§‹è¡¨è¾¾å¼è¦å¿«å¾—å¤šã€‚è¿™å¯¹äºæ¯æ¬¡åˆ·æ–°æ—¶éƒ½éœ€è¦é‡å¤æŸ¥è¯¢ç›¸åŒè¡¨è¾¾å¼çš„ä»ªè¡¨æ¿ç‰¹åˆ«","title":"prometheus (äº”) è®°å½•è§„åˆ™ä¸å‘Šè­¦è§„åˆ™"},{"content":"0 å‰è¨€ åŸºäº centos7.9 docker-ce-20.10.18 kubelet-1.22.3-0 kube-prometheus-0.10 prometheus-v2.32.1\n1 ç®€ä»‹ Probe çš„ API æ–‡æ¡£\n1.1 ç™½ç›’ç›‘æ§ vs é»‘ç›’ç›‘æ§ ç™½ç›’ç›‘æ§: æˆ‘ä»¬ç›‘æ§ä¸»æœºçš„èµ„æºç”¨é‡ã€å®¹å™¨çš„è¿è¡ŒçŠ¶æ€ã€æ•°æ®åº“ä¸­é—´ä»¶çš„è¿è¡Œæ•°æ®ç­‰ç­‰ï¼Œè¿™äº›éƒ½æ˜¯æ”¯æŒä¸šåŠ¡å’ŒæœåŠ¡çš„åŸºç¡€è®¾æ–½ï¼Œé€šè¿‡ç™½ç›’èƒ½å¤Ÿäº†è§£å…¶å†…éƒ¨çš„å®é™…è¿è¡ŒçŠ¶æ€ï¼Œé€šè¿‡å¯¹ç›‘æ§æŒ‡æ ‡çš„è§‚å¯Ÿèƒ½å¤Ÿé¢„åˆ¤å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼Œä»è€Œå¯¹æ½œåœ¨çš„ä¸ç¡®å®šå› ç´ è¿›è¡Œä¼˜åŒ–\né»‘ç›’ç›‘æ§: ä»¥ç”¨æˆ·çš„èº«ä»½æµ‹è¯•æœåŠ¡çš„å¤–éƒ¨å¯è§æ€§ï¼Œå¸¸è§çš„é»‘ç›’ç›‘æ§åŒ…æ‹¬ HTTP æ¢é’ˆ TCP æ¢é’ˆ ç­‰ç”¨äºæ£€æµ‹ç«™ç‚¹æˆ–è€…æœåŠ¡çš„å¯è®¿é—®æ€§ï¼Œä»¥åŠè®¿é—®æ•ˆç‡ç­‰ã€‚\né»‘ç›’ç›‘æ§ç›¸è¾ƒäºç™½ç›’ç›‘æ§æœ€å¤§çš„ä¸åŒåœ¨äºé»‘ç›’ç›‘æ§æ˜¯ä»¥æ•…éšœä¸ºå¯¼å‘çš„. å½“æ•…éšœå‘ç”Ÿæ—¶ï¼Œé»‘ç›’ç›‘æ§èƒ½å¿«é€Ÿå‘ç°æ•…éšœï¼Œè€Œç™½ç›’ç›‘æ§åˆ™ä¾§é‡äºä¸»åŠ¨å‘ç°æˆ–è€…é¢„æµ‹æ½œåœ¨çš„é—®é¢˜ã€‚ä¸€ä¸ªå®Œå–„çš„ç›‘æ§ç›®æ ‡æ˜¯è¦èƒ½å¤Ÿä»ç™½ç›’çš„è§’åº¦å‘ç°æ½œåœ¨é—®é¢˜ï¼Œèƒ½å¤Ÿåœ¨é»‘ç›’çš„è§’åº¦å¿«é€Ÿå‘ç°å·²ç»å‘ç”Ÿçš„é—®é¢˜ã€‚\n1.2 blackbox exporter Blackbox Exporter æ˜¯ Prometheus ç¤¾åŒºæä¾›çš„å®˜æ–¹é»‘ç›’ç›‘æ§è§£å†³æ–¹æ¡ˆï¼Œå…¶å…è®¸ç”¨æˆ·é€šè¿‡ HTTP HTTPS DNS TCP ICMP ä»¥åŠ gPRC çš„æ–¹å¼å¯¹ endpoints ç«¯ç‚¹è¿›è¡Œæ¢æµ‹ã€‚\nåœ¨ kube-prometheus çš„é»˜è®¤é…ç½®ä¸­å·²ç»éƒ¨ç½²äº† Blackbox Exporter ä»¥ä¾›ç”¨æˆ·ä½¿ç”¨\n[root@k8s-node1 kube-prometheus]# ls manifests/blackboxExporter-* | cat manifests/blackboxExporter-clusterRoleBinding.yaml manifests/blackboxExporter-clusterRole.yaml manifests/blackboxExporter-configuration.yaml manifests/blackboxExporter-deployment.yaml manifests/blackboxExporter-serviceAccount.yaml manifests/blackboxExporter-serviceMonitor.yaml manifests/blackboxExporter-service.yaml 1.3 Probe CRD prometheus-operator æä¾›äº†ä¸€ä¸ª Probe CRD å¯¹è±¡ï¼Œå¯ä»¥ç”¨æ¥è¿›è¡Œé»‘ç›’ç›‘æ§ï¼Œå…·ä½“çš„æ¢æµ‹åŠŸèƒ½ç”± Blackbox-exporter å®ç°ã€‚\nProbe æ”¯æŒ staticConfig å’Œ ingress ä¸¤ç§é…ç½®æ–¹å¼, ä½¿ç”¨ ingress æ—¶å¯ä»¥è‡ªåŠ¨å‘ç° ingress ä»£ç†çš„ url å¹¶è¿›è¡Œæ¢æµ‹\nå¤§æ¦‚æ­¥éª¤:\né¦–å…ˆï¼Œç”¨æˆ·åˆ›å»ºä¸€ä¸ª Probe CRD å¯¹è±¡ï¼Œå¯¹è±¡ä¸­æŒ‡å®šæ¢æµ‹æ–¹å¼ã€æ¢æµ‹ç›®æ ‡ç­‰å‚æ•°ï¼› ç„¶åï¼Œprometheus-operator watch åˆ° Probe å¯¹è±¡åˆ›å»ºï¼Œç„¶åç”Ÿæˆå¯¹åº”çš„ prometheus æ‹‰å–é…ç½®ï¼Œreload åˆ° prometheus ä¸­ï¼› æœ€åï¼Œprometheus ä½¿ç”¨ url=/probe?target={æ¢æµ‹ç›®æ ‡}\u0026amp;module={æ¢æµ‹æ–¹å¼}ï¼Œæ‹‰å– blackbox-exporter ï¼Œæ­¤æ—¶ blackbox-exporter ä¼šå¯¹ç›®æ ‡è¿›è¡Œæ¢æµ‹ï¼Œå¹¶ä»¥ metrics æ ¼å¼è¿”å›æ¢æµ‹ç»“æœï¼› 2 probe ç¤ºä¾‹ 2.1 staticConfig 2.1.1 kube-dns ä½¿ç”¨é»‘ç›’ç›‘æ§ç›‘æµ‹ kube-dns çš„å¯ç”¨æ€§\né»˜è®¤é…ç½®ä¸‹çš„ blackbox exporter æœªå¼€å¯ dns æ¨¡å—, æˆ‘ä»¬æ‰‹åŠ¨å¼€å¯ä¸€ä¸‹\nä¿®æ”¹ blackboxExporter-configuration.yaml æ–‡ä»¶, æ·»åŠ  dns æ¨¡å—\napiVersion: v1 data: config.yml: |- \u0026#34;modules\u0026#34;: \u0026#34;dns\u0026#34;: # DNS æ£€æµ‹æ¨¡å— \u0026#34;prober\u0026#34;: \u0026#34;dns\u0026#34; \u0026#34;dns\u0026#34;: \u0026#34;transport_protocol\u0026#34;: \u0026#34;tcp\u0026#34; # é»˜è®¤æ˜¯ udp \u0026#34;preferred_ip_protocol\u0026#34;: \u0026#34;ip4\u0026#34; # é»˜è®¤æ˜¯ ip6 \u0026#34;query_name\u0026#34;: \u0026#34;kubernetes.default.svc.cluster.local\u0026#34; æ›´æ–° configmap é…ç½®æ–‡ä»¶, prometheus-opertor ä¼š watch åˆ°æ›´æ–°ç„¶åé€šè¿‡ pod ä¸­çš„ module-configmap-reloader å®¹å™¨é€šçŸ¥ blackbox-exporter é‡è½½é…ç½®\n# æ¯ä¸ª blackbox-exporter POD ä¸­æœ‰ä¸‰ä¸ª container [root@k8s-node1 manifests]# kubectl get pods -n monitoring -l app.kubernetes.io/name=blackbox-exporter \\ -o jsonpath=\u0026#39;{.items[*].spec.containers[*].name}{\u0026#34;\\n\u0026#34;}\u0026#39; blackbox-exporter module-configmap-reloader kube-rbac-proxy [root@k8s-node1 manifests]# kubectl apply -f blackboxExporter-configuration.yaml configmap/blackbox-exporter-configuration configured [root@k8s-node1 manifests]# kubectl logs -n monitoring -l app.kubernetes.io/name=blackbox-exporter | tail -2 level=info ts=2023-04-23T02:23:49.614Z caller=tls_config.go:191 msg=\u0026#34;TLS is disabled.\u0026#34; http2=false level=info ts=2023-04-28T06:40:48.168Z caller=main.go:278 msg=\u0026#34;Reloaded config file\u0026#34; åˆ›å»º Probe CRD èµ„æº\napiVersion: monitoring.coreos.com/v1 kind: Probe metadata: name: blackbox-kube-dns namespace: monitoring spec: jobName: blackbox-kube-dns interval: 10s module: dns prober: # æŒ‡å®šblackboxçš„åœ°å€ url: blackbox-exporter:19115 # blackbox-exporter çš„ åœ°å€ å’Œ ç«¯å£ path: /probe # è·¯å¾„ targets: staticConfig: static: - kube-dns.kube-system:53 # è¦æ£€æµ‹çš„ url æŸ¥çœ‹ç”Ÿæˆçš„ target\nç°åœ¨å¯ä»¥é€šè¿‡:\nprobe_success{job=\u0026quot;blackbox-kube-dns\u0026quot;} æŸ¥çœ‹æœåŠ¡çŠ¶æ€æ˜¯å¦å¯ç”¨ probe_dns_lookup_time_seconds{job='blackbox-kube-dns'} DNS è§£æè€—æ—¶ æŸ¥çœ‹ blackbox exporter ä¸€æ¬¡ dns æ¢æµ‹ç”Ÿæˆçš„ metrics æŒ‡æ ‡\n2.2.1 http http æ¢æµ‹ä¸€èˆ¬ä½¿ç”¨ http_2xx æ¨¡å—, è™½ç„¶é»˜è®¤æœ‰è¿™ä¸ªæ¨¡å—, ä½†æ˜¯é»˜è®¤çš„é…ç½®ä¸å¤ªåˆç†, æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹\napiVersion: v1 data: config.yml: |- \u0026#34;modules\u0026#34;: \u0026#34;dns\u0026#34;: # DNS æ£€æµ‹æ¨¡å— \u0026#34;prober\u0026#34;: \u0026#34;dns\u0026#34; \u0026#34;dns\u0026#34;: \u0026#34;transport_protocol\u0026#34;: \u0026#34;tcp\u0026#34; # é»˜è®¤æ˜¯ udp \u0026#34;preferred_ip_protocol\u0026#34;: \u0026#34;ip4\u0026#34; # é»˜è®¤æ˜¯ ip6 \u0026#34;query_name\u0026#34;: \u0026#34;kubernetes.default.svc.cluster.local\u0026#34; \u0026#34;http_2xx\u0026#34;: \u0026#34;http\u0026#34;: \u0026#34;preferred_ip_protocol\u0026#34;: \u0026#34;ip4\u0026#34; \u0026#34;valid_status_codes\u0026#34;: \u0026#34;[200]\u0026#34; # æœ€å¥½åŠ ä¸ŠçŠ¶æ€ç , æ–¹ä¾¿ grafana å±•ç¤ºæ•°æ® \u0026#34;valid_http_versions\u0026#34;: [\u0026#34;HTTP/1.1\u0026#34;, \u0026#34;HTTP/2\u0026#34;] \u0026#34;method\u0026#34;: \u0026#34;GET\u0026#34; \u0026#34;prober\u0026#34;: \u0026#34;http\u0026#34; æ›´æ–°é…ç½®\n[root@k8s-node1 manifests]# kubectl apply -f blackboxExporter-configuration.yaml configmap/blackbox-exporter-configuration configured å¿«é€Ÿåˆ›å»ºä¸€ä¸ª nginx åº”ç”¨\nkubectl create deployment nginx --image=nginx:1.22.1 --port=80 kubectl expose deployment nginx --name=nginx --port=80 --target-port=80 åˆ›å»º Probe èµ„æº\napiVersion: monitoring.coreos.com/v1 kind: Probe metadata: name: blackbox-http-nginx namespace: monitoring spec: jobName: blackbox-http-nginx prober: url: blackbox-exporter:19115 path: /probe module: http_2xx # é…ç½®æ–‡ä»¶ä¸­çš„æ£€æµ‹æ¨¡å— targets: staticConfig: static: - nginx.default æŸ¥çœ‹ç”Ÿæˆçš„ target\næŸ¥çœ‹ä¸€æ¬¡ http æ¢æµ‹ç”Ÿæˆçš„ metrics æŒ‡æ ‡\n2.2 ingress è‡ªåŠ¨å‘ç° æ¥ä¸‹æ¥ä½¿ç”¨ ingrss è‡ªåŠ¨å‘ç°å®ç°é›†ç¾¤å†…çš„ ingress å¹¶è¿›è¡Œé»‘ç›’æ¢æµ‹\nå…ˆåˆ›å»ºä¸¤ä¸ª web åº”ç”¨\nkubectl create deployment web-1 --image=nginx:1.22.1 --port=80 kubectl expose deployment web-1 --name=web-1 --port=80 --target-port=80 kubectl create deployment web-2 --image=nginx:1.22.1 --port=80 kubectl expose deployment web-2 --name=web-2 --port=80 --target-port=80 2.2.1 åˆ›å»º ingress åŒ…å«ä¸‰ä¸ªè·¯å¾„: http://web1.test.com http://web1.test.com/test http://web2.test.com\napiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: demo-web namespace: default labels: prometheus.io/http-probe: \u0026#34;true\u0026#34; # ç”¨äºç›‘æµ‹ annotations: kubernetes.io/ingress.class: traefik traefik.ingress.kubernetes.io/router.entrypoints: web spec: rules: - host: web1.test.com http: paths: - pathType: Prefix path: / backend: service: name: web-1 port: number: 80 - pathType: Prefix path: /test backend: service: name: web-1 port: number: 80 - host: web2.test.com http: paths: - pathType: Prefix path: / backend: service: name: web-2 port: number: 80 éƒ¨ç½²å¹¶è®¿é—®æµ‹è¯•\n[root@k8s-node1 manifests]# echo \u0026#34;1.1.1.1 web1.test.com web2.test.com\u0026#34; \u0026gt;\u0026gt; /etc/hosts [root@k8s-node1 manifests]# curl -sI web1.test.com | head -1 HTTP/1.1 200 OK [root@k8s-node1 manifests]# curl -sI web1.test.com/test | head -1 HTTP/1.1 404 Not Found [root@k8s-node1 manifests]# curl -sI web2.test.com | head -1 HTTP/1.1 200 OK 2.2.2 åˆ›å»º probe å¯ä»¥ä½¿ç”¨ label æˆ–è€… annotation ä¸¤ç§æ–¹å¼ç­›é€‰ç›‘æµ‹çš„ ingress, ä¸é…ç½®ç›‘æµ‹æ‰€æœ‰ ingress\napiVersion: monitoring.coreos.com/v1 kind: Probe metadata: name: blackbox-ingress namespace: monitoring spec: jobName: blackbox-ingress prober: url: blackbox-exporter:19115 path: /probe module: http_2xx targets: ingress: namespaceSelector: # ç›‘æµ‹æ‰€æœ‰ namespace # any: true # åªç›‘æµ‹æŒ‡å®š namespace çš„ ingress matchNames: - default - monitoring # åªç›‘æµ‹é…ç½®äº†æ ‡ç­¾ prometheus.io/http-probe: true çš„ ingress selector: matchLabels: prometheus.io/http-probe: \u0026#34;true\u0026#34; # åªç›‘æµ‹é…ç½®äº†æ³¨è§£ prometheus.io/http_probe: true çš„ ingress # relabelingConfigs: # - action: keep # sourceLabels: # - __meta_kubernetes_ingress_annotation_prometheus_io_http_probe # regex: \u0026#34;true\u0026#34; æŸ¥çœ‹ targets\nä¸è¿‡ç”±äº ingress é…ç½®çš„åŸŸåæ— æ³•è§£æ, æ‰€ä»¥ç›‘æµ‹åˆ°çš„çŠ¶æ€æ˜¯å¤±è´¥çš„:\n2.2.3 é…ç½® coredns æˆ‘ä»¬ä¸º coredns æ·»åŠ è‡ªå®šä¹‰ hosts, å®ç° blackbox å¯ä»¥è§£æåˆ°æˆ‘ä»¬çš„è‡ªå®šä¹‰åŸŸå\n# kubectl edit cm coredns -n kube-system apiVersion: v1 data: Corefile: | .:53 { errors health { lameduck 5s } ready kubernetes cluster.local in-addr.arpa ip6.arpa { pods insecure fallthrough in-addr.arpa ip6.arpa ttl 30 } prometheus :9153 forward . /etc/resolv.conf { max_concurrent 1000 } hosts { # æ·»åŠ  hosts é…ç½® 1.1.1.1 web1.test.com 1.1.1.1 web2.test.com fallthrough } cache 30 loop reload loadbalance } kind: ConfigMap ç­‰å¾… coredns çš„é…ç½®ç”Ÿæ•ˆå, æˆ‘ä»¬é‡æ–°å†çœ‹ä¸€ä¸‹ target çŠ¶æ€\n3 additionalScrapeConfigs ç›®å‰ prometheus operator åªæ”¯æŒ ingress æ–¹å¼çš„è‡ªåŠ¨å‘ç°, è€Œä¸”è‡ªå®šä¹‰é…ç½®å…¶å®ä¸æ˜¯å¾ˆå¤š, æ›´æ¨èä½¿ç”¨ additionalScrapeConfigs é™æ€é…ç½®çš„æ–¹å¼å®ç°\n3.2 service è‡ªåŠ¨å‘ç° æ²¿ç”¨ 2.2 ç« èŠ‚ä¸­åˆ›å»ºçš„ä¸¤ä¸ª service\nä¿®æ”¹ service web-1, æ·»åŠ  annotation\n# kubectl edit svc web-1 metadata: annotations: prometheus.io/http-probe: \u0026#34;true\u0026#34; # æ§åˆ¶æ˜¯å¦ç›‘æµ‹ prometheus.io/http-probe-path: / # æ§åˆ¶ç›‘æµ‹è·¯å¾„ prometheus.io/http-probe-port: \u0026#34;80\u0026#34; # æ§åˆ¶ç›‘æµ‹ç«¯å£ ä¿®æ”¹é™æ€é…ç½®\n# vim prometheus-additional.yaml - job_name: \u0026#34;kubernetes-services\u0026#34; metrics_path: /probe params: module: - \u0026#34;http_2xx\u0026#34; ## ä½¿ç”¨ Kubernetes åŠ¨æ€æœåŠ¡å‘ç°,ä¸”ä½¿ç”¨ Service ç±»å‹çš„å‘ç° kubernetes_sd_configs: - role: service relabel_configs: ## è®¾ç½®åªç›‘æµ‹ Annotation é‡Œé…ç½®äº† prometheus.io/http_probe: true çš„ service - action: keep source_labels: [__meta_kubernetes_service_annotation_prometheus_io_http_probe] regex: \u0026#34;true\u0026#34; - action: replace source_labels: - \u0026#34;__meta_kubernetes_service_name\u0026#34; - \u0026#34;__meta_kubernetes_namespace\u0026#34; - \u0026#34;__meta_kubernetes_service_annotation_prometheus_io_http_probe_port\u0026#34; - \u0026#34;__meta_kubernetes_service_annotation_prometheus_io_http_probe_path\u0026#34; target_label: __param_target regex: (.+);(.+);(.+);(.+) replacement: $1.$2:$3$4 - target_label: __address__ replacement: blackbox-exporter:19115 - source_labels: [__param_target] target_label: instance - action: labelmap regex: __meta_kubernetes_service_label_(.+) - source_labels: [__meta_kubernetes_namespace] target_label: kubernetes_namespace - source_labels: [__meta_kubernetes_service_name] target_label: kubernetes_name æ›´æ–° secret\nkubectl create secret generic additional-scrape-configs -n monitoring --from-file=prometheus-additional.yaml \u0026gt; additional-scrape-configs.yaml kubectl apply -f additional-scrape-configs.yaml ç¡®ä¿ prometheus CRD å®ä¾‹é…ç½®äº† secret\n[root@k8s-node1 manifests]# grep -A2 additionalScrapeConfigs prometheus-prometheus.yaml additionalScrapeConfigs: name: additional-scrape-configs # secret name key: prometheus-additional.yaml # secret key æŸ¥çœ‹ target, å¯ä»¥çœ‹åˆ°åªæœ‰ web-1 å‘ç°æˆåŠŸ, å› ä¸º web-2 æ²¡æœ‰é…ç½® annotation\næŸ¥çœ‹ä¸€ä¸‹ç›‘æµ‹çŠ¶æ€, ç›´æ¥ä½¿ç”¨ \u0026lt;service-name\u0026gt;.\u0026lt;namespace\u0026gt; è®¿é—®, åœ¨é›†ç¾¤å†…æ˜¯å¯ä»¥æ­£å¸¸è§£æçš„, æ‰€ä»¥è¿™é‡Œ http çŠ¶æ€ç ä¸ºæ­£å¸¸çš„ 200\n3.1 ingress è‡ªåŠ¨å‘ç° ä¾æ—§ä½¿ç”¨ 2.2 ç« èŠ‚ä¸­åˆ›å»ºçš„ ingress\nä¸º ingress æ·»åŠ  annotation æ³¨è§£\n# kubectl edit ingress demo-web annotations: # æ·»åŠ å¦‚ä¸‹é¡¹ prometheus.io/http-probe: \u0026#34;true\u0026#34; # ç”¨äºæ§åˆ¶æ˜¯å¦ç›‘æµ‹ prometheus.io/http-probe-port: \u0026#34;80\u0026#34; # ç”¨äºæ§åˆ¶ç›‘æµ‹ç«¯å£ ä¿®æ”¹é™æ€é…ç½®\n# cat prometheus-additional.yaml - job_name: \u0026#34;kubernetes-ingresses\u0026#34; metrics_path: /probe params: module: - \u0026#34;http_2xx\u0026#34; ## ä½¿ç”¨ Kubernetes åŠ¨æ€æœåŠ¡å‘ç°,ä¸”ä½¿ç”¨ ingress ç±»å‹çš„å‘ç° kubernetes_sd_configs: - role: ingress relabel_configs: ## è®¾ç½®åªç›‘æµ‹ Annotation é‡Œé…ç½®äº† prometheus.io/http_probe: true çš„ ingress - action: keep source_labels: [__meta_kubernetes_ingress_annotation_prometheus_io_http_probe] regex: \u0026#34;true\u0026#34; - action: replace source_labels: - \u0026#34;__meta_kubernetes_ingress_scheme\u0026#34; - \u0026#34;__meta_kubernetes_ingress_host\u0026#34; - \u0026#34;__meta_kubernetes_ingress_annotation_prometheus_io_http_probe_port\u0026#34; - \u0026#34;__meta_kubernetes_ingress_path\u0026#34; target_label: __param_target regex: (.+);(.+);(.+);(.+) replacement: ${1}://${2}:${3}${4} - target_label: __address__ replacement: blackbox-exporter:19115 - source_labels: [__param_target] target_label: instance - action: labelmap regex: __meta_kubernetes_ingress_label_(.+) - source_labels: [__meta_kubernetes_namespace] target_label: namespace - source_labels: [__meta_kubernetes_ingress_name] target_label: ingress_name æ›´æ–° secret\nkubectl create secret generic additional-scrape-configs -n monitoring --from-file=prometheus-additional.yaml \u0026gt; additional-scrape-configs.yaml kubectl apply -f additional-scrape-configs.yaml ç¡®ä¿ prometheus CRD å®ä¾‹é…ç½®äº† secret\n[root@k8s-node1 manifests]# grep -A2 additionalScrapeConfigs prometheus-prometheus.yaml additionalScrapeConfigs: name: additional-scrape-configs # secret name key: prometheus-additional.yaml # secret key æŸ¥çœ‹ target\næŸ¥çœ‹ç›‘æµ‹çŠ¶æ€, ä¸é¢„æœŸé…ç½®ä¸€æ ·\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-prometheus-4-blackbox-probe/","summary":"0 å‰è¨€ åŸºäº centos7.9 docker-ce-20.10.18 kubelet-1.22.3-0 kube-prometheus-0.10 prometheus-v2.32.1 1 ç®€ä»‹ Probe çš„ API æ–‡æ¡£ 1.1 ç™½ç›’ç›‘æ§ vs é»‘ç›’ç›‘æ§ ç™½ç›’ç›‘æ§: æˆ‘ä»¬ç›‘æ§ä¸»æœºçš„èµ„æºç”¨é‡ã€å®¹å™¨çš„è¿è¡ŒçŠ¶æ€ã€æ•°æ®åº“ä¸­é—´ä»¶çš„è¿è¡Œæ•°æ®ç­‰ç­‰ï¼Œè¿™äº›éƒ½æ˜¯æ”¯æŒä¸šåŠ¡å’ŒæœåŠ¡çš„åŸºç¡€è®¾æ–½ï¼Œé€šè¿‡ç™½ç›’èƒ½å¤Ÿäº†è§£å…¶å†…éƒ¨çš„å®é™…è¿è¡ŒçŠ¶æ€ï¼Œé€šè¿‡å¯¹ç›‘æ§æŒ‡æ ‡çš„è§‚å¯Ÿèƒ½å¤Ÿé¢„åˆ¤å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼Œä»è€Œå¯¹æ½œåœ¨çš„ä¸ç¡®å®šå› ç´ è¿›è¡Œä¼˜åŒ–","title":"prometheus (å››) é»‘ç›’ç›‘æ§"},{"content":"0 å‰è¨€ åŸºäº centos7.9 docker-ce-20.10.18 kubelet-1.22.3-0 kube-prometheus-0.10 prometheus-v2.32.1\n1 ç®€ä»‹ æ‰‹åŠ¨æ·»åŠ  job é…ç½®æœªå…è¿‡äºç¹ç, prometheus æ”¯æŒå¾ˆå¤šç§æ–¹å¼çš„æœåŠ¡å‘ç°, åœ¨ k8s ä¸­æ˜¯é€šè¿‡ kubernetes_sd_config é…ç½®å®ç°çš„. é€šè¿‡æŠ“å– k8s REST API è‡ªåŠ¨å‘ç°æˆ‘ä»¬éƒ¨ç½²åœ¨ k8s é›†ç¾¤ä¸­çš„ exporter å®ä¾‹\nåœ¨ Prometheus Operator ä¸­, æˆ‘ä»¬æ— éœ€æ‰‹åŠ¨ç¼–è¾‘é…ç½®æ–‡ä»¶æ·»åŠ  kubernetes_sd_config é…ç½®, Prometheus Operator æä¾›äº†ä¸‹è¿°èµ„æº:\nserviceMonitor: åˆ›å»º endpoints çº§åˆ«çš„æœåŠ¡å‘ç° podMonitor: åˆ›å»º pod çº§åˆ«çš„æœåŠ¡å‘ç° probe: åˆ›å»º ingress çº§åˆ«çš„æœåŠ¡å‘ç° (ç”¨äºé»‘ç›’ç›‘æ§) é€šè¿‡å¯¹è¿™ä¸‰ç§ CRD èµ„æºçš„ç®¡ç†å®ç° prometheus åŠ¨æ€çš„æœåŠ¡å‘ç°.\n1.1 kubernetes_sd_config kubernets_sd_config å®˜æ–¹æ–‡æ¡£\nkubernetes_sd_config æ”¯æŒ node service pod endpoints ingress 5 ç§æœåŠ¡å‘ç°æ¨¡å¼.\nnode é€‚ç”¨äºä¸ä¸»æœºç›¸å…³çš„ç›‘æ§èµ„æºï¼Œå¦‚ Kubernetes ç»„ä»¶çŠ¶æ€ã€èŠ‚ç‚¹ä¸Šè¿è¡Œçš„å®¹å™¨çŠ¶æ€ç­‰ï¼› service å’Œ ingress ç”¨äºé»‘ç›’ç›‘æ§çš„åœºæ™¯ï¼Œå¦‚å¯¹æœåŠ¡çš„å¯ç”¨æ€§ä»¥åŠæœåŠ¡è´¨é‡çš„ç›‘æ§ï¼› endpoints å’Œ pod ç”¨äºè·å– Pod çš„ç›‘æ§æ•°æ®ï¼Œå¦‚ç›‘æ§ç”¨æˆ·éƒ¨ç½²çš„æ”¯æŒ Prometheus çš„åº”ç”¨ã€‚ æ¯ç§å‘ç°æ¨¡å¼éƒ½æ”¯æŒå¾ˆå¤š label, prometheus å¯ä»¥é€šè¿‡ relabel_config åˆ†æè¿™äº›æ ‡ç­¾è¿›è¡Œæ ‡ç­¾é‡å†™æˆ–è€…ä¸¢å¼ƒ target\nåœ¨ kube-prometheus çš„æ¨¡æ¿é…ç½®ä¸­, æ‰€æœ‰çš„ target éƒ½æ˜¯é€šè¿‡ endpoints æ¨¡å¼å®ç°çš„.\nendpoints æ¨¡å¼çš„è‡ªåŠ¨å‘ç°ä¼šæ·»åŠ  endpoints åç«¯æ‰€æœ‰ pod æš´éœ²å‡ºæ¥çš„æ‰€æœ‰ port. å¦‚ä¸‹æ‰€ç¤º\n# å…±æœ‰ 10 ä¸ª endpoints, åç«¯åŒ…å« 15 ä¸ª pod, æ‰€æœ‰ ip+port çš„ç»„åˆæœ‰ 44 ä¸ª endpoints ===\u0026gt; pods ===\u0026gt; pod-ip+port 10 15 44 åŒæ ·, åœ¨ prometheus åç«¯çœ‹åˆ°çš„ targets å°†ä¼šæ˜¯ 44 ä¸ª, ç„¶åæŒ‰ç…§ relabel è§„åˆ™åœ¨è¿™äº›æ‰€æœ‰çš„ target ä¸­é€‰æ‹©åˆé€‚çš„ target å¹¶è¿›è¡Œ active\n2 serviceMonitor CRD 2.1 node-exporter ä»¥ä¸ŠèŠ‚éƒ¨ç½²çš„ kube-prometheus ä¸ºä¾‹, å­¦ä¹  prometheus å¦‚ä½•é€šè¿‡ endpoints æ¨¡å¼çš„æœåŠ¡å‘ç°æ¥æ·»åŠ æˆ‘ä»¬åˆ›å»ºçš„ node-exporter ä¸º target\néœ€è¦æ³¨æ„çš„æ˜¯, ä¸ä¸€èˆ¬éƒ¨ç½²çš„ node-exporter ä¸åŒ, kube-prometheus é¢å¤–åˆ›å»ºäº†ä¸€ä¸ª headless service, éšç€ service åˆ›å»ºçš„ endpoints å°†ç”¨äº prometheus çš„è‡ªåŠ¨å‘ç°.\n# cat manifests/nodeExporter-service.yaml apiVersion: v1 kind: Service metadata: labels: app.kubernetes.io/component: exporter app.kubernetes.io/name: node-exporter app.kubernetes.io/part-of: kube-prometheus app.kubernetes.io/version: 1.3.1 name: node-exporter namespace: monitoring spec: clusterIP: None ports: - name: https port: 9100 targetPort: https selector: app.kubernetes.io/component: exporter app.kubernetes.io/name: node-exporter app.kubernetes.io/part-of: kube-prometheus æŸ¥çœ‹ endpoints\n[root@k8s-node1 ~]# kubectl get ep -n monitoring -l app.kubernetes.io/name=node-exporter NAME ENDPOINTS AGE node-exporter 1.1.1.1:9100,1.1.1.2:9100,1.1.1.3:9100 10d æŸ¥çœ‹ serviceMonitor\n# cat manifests/nodeExporter-serviceMonitor.yaml apiVersion: monitoring.coreos.com/v1 kind: ServiceMonitor metadata: labels: app.kubernetes.io/component: exporter app.kubernetes.io/name: node-exporter app.kubernetes.io/part-of: kube-prometheus app.kubernetes.io/version: 1.3.1 name: node-exporter namespace: monitoring spec: endpoints: - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token interval: 15s port: https relabelings: - action: replace regex: (.*) replacement: $1 sourceLabels: - __meta_kubernetes_pod_node_name targetLabel: instance scheme: https tlsConfig: insecureSkipVerify: true jobLabel: app.kubernetes.io/name selector: matchLabels: # æ ‡ç­¾åŒ¹é…è§„åˆ™, ç¬¦åˆ label æ¡ä»¶çš„ target æ‰ä¼šè¢« active app.kubernetes.io/component: exporter app.kubernetes.io/name: node-exporter app.kubernetes.io/part-of: kube-prometheus ä¸Šè¿°çš„ serviceMonitor å°†ä¼šä¸º prometheus ç”Ÿæˆä¸€ä¸ª job, ä½¿ç”¨äº† endpoints æ¨¡å¼çš„ kubernetes_sd_config, ç”¨äºè‡ªåŠ¨å‘ç°é›†ç¾¤å†…ç¬¦åˆæ¡ä»¶çš„ node-exporter\n##### job åŸºç¡€ä¿¡æ¯ ######## - job_name: serviceMonitor/monitoring/node-exporter/0 honor_timestamps: true scrape_interval: 15s scrape_timeout: 10s metrics_path: /metrics scheme: https authorization: type: Bearer credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token tls_config: insecure_skip_verify: true follow_redirects: true ##### kubernetes_sd_configs è‡ªåŠ¨å‘ç°çš„é…ç½® ######### kubernetes_sd_configs: - role: endpoints kubeconfig_file: \u0026#34;\u0026#34; follow_redirects: true namespaces: names: - monitoring ##### å¼€å§‹æ‰§è¡Œ relabel, ç¬¬ä¸€ä¸ªè§„åˆ™æ˜¯æ›¿æ¢ä»»åŠ¡å ################ relabel_configs: - source_labels: [job] separator: ; regex: (.*) target_label: __tmp_prometheus_job_name replacement: $1 action: replace ###### ä»¥ä¸‹æ˜¯åŒ¹é…è§„åˆ™, å¦‚æœä¸æ»¡è¶³ label åŒ¹é…è§„åˆ™å°±ä¸¢å¼ƒ target, å¯¹åº” serviceMonitor é…ç½®çš„ matchlabels ###### - source_labels: [__meta_kubernetes_service_label_app_kubernetes_io_component, __meta_kubernetes_service_labelpresent_app_kubernetes_io_component] separator: ; regex: (exporter);true replacement: $1 action: keep # å¦‚æœä¸æ»¡è¶³, ä¸¢å¼ƒæ­¤ target - source_labels: [__meta_kubernetes_service_label_app_kubernetes_io_name, __meta_kubernetes_service_labelpresent_app_kubernetes_io_name] separator: ; regex: (node-exporter);true replacement: $1 action: keep - source_labels: [__meta_kubernetes_service_label_app_kubernetes_io_part_of, __meta_kubernetes_service_labelpresent_app_kubernetes_io_part_of] separator: ; regex: (kube-prometheus);true replacement: $1 action: keep - source_labels: [__meta_kubernetes_endpoint_port_name] separator: ; regex: https replacement: $1 action: keep ##### ä»¥ä¸‹æ˜¯ replace æ›¿æ¢æ ‡ç­¾çš„æ“ä½œ, å¯ä»¥ä½¿æˆ‘ä»¬çš„ target æ ‡ç­¾æœ‰æ›´å¥½çš„å¯è¯»æ€§ ##### - source_labels: [__meta_kubernetes_endpoint_address_target_kind, __meta_kubernetes_endpoint_address_target_name] separator: ; regex: Node;(.*) target_label: node replacement: ${1} action: replace - source_labels: [__meta_kubernetes_endpoint_address_target_kind, __meta_kubernetes_endpoint_address_target_name] separator: ; regex: Pod;(.*) target_label: pod replacement: ${1} action: replace - source_labels: [__meta_kubernetes_namespace] separator: ; regex: (.*) target_label: namespace replacement: $1 action: replace - source_labels: [__meta_kubernetes_service_name] separator: ; regex: (.*) target_label: service replacement: $1 action: replace - source_labels: [__meta_kubernetes_pod_name] separator: ; regex: (.*) target_label: pod replacement: $1 action: replace - source_labels: [__meta_kubernetes_pod_container_name] separator: ; regex: (.*) target_label: container replacement: $1 action: replace - source_labels: [__meta_kubernetes_service_name] separator: ; regex: (.*) target_label: job replacement: ${1} action: replace - source_labels: [__meta_kubernetes_service_label_app_kubernetes_io_name] separator: ; regex: (.+) target_label: job replacement: ${1} action: replace - separator: ; regex: (.*) target_label: endpoint replacement: https action: replace - source_labels: [__meta_kubernetes_pod_node_name] separator: ; regex: (.*) target_label: instance replacement: $1 action: replace - source_labels: [__address__] separator: ; regex: (.*) modulus: 1 target_label: __tmp_hash replacement: $1 action: hashmod - source_labels: [__tmp_hash] separator: ; regex: \u0026#34;0\u0026#34; replacement: $1 action: keep åœ¨ prometheus çš„æœåŠ¡å‘ç°ç•Œé¢å¯ä»¥çœ‹åˆ°é‡‡é›†åˆ°çš„æ‰€æœ‰ target, æ¯ä¸ª target å°±å¯¹åº”äº†ä¸€ä¸ª pod-ip+Port ,æ¯ä¸ª target å«æœ‰è®¸å¤šåŸå§‹æ ‡ç­¾, relebal_config å°±æ˜¯é’ˆå¯¹è¿™äº›æ ‡ç­¾è¿›è¡Œç­›é€‰å’Œé‡å†™ç­‰å…¶ä»–æ“ä½œ.\nendpoints çº§åˆ«çš„æ ‡ç­¾\nservice å’Œ pod çº§åˆ«çš„æ ‡ç­¾\næŸ¥çœ‹è‡ªåŠ¨æ³¨å†Œåˆ° prometheus çš„ node-exporter\nå¯ä»¥å‘ç°:\nç»è¿‡ keep è§„åˆ™æˆåŠŸä» 44 ä¸ª target ä¸­ç­›é€‰åˆ°äº†å¯¹åº”çš„ node-exporter ç»è¿‡ replace è§„åˆ™ä¹‹å target-labels æœ‰äº†æ›´å¥½çš„å¯è¯»æ€§ 2.2 traefik æ¥ä¸‹æ¥æ¼”ç¤ºä¸€ä¸‹é€šè¿‡åˆ›å»º serviceMonitor å®ç°é‡‡é›† traefik çš„ metrics æŒ‡æ ‡, traefik å®‰è£…è¯·å‚è€ƒ traefikç³»åˆ—æ–‡ç« \nåœ¨é…ç½®ä¸­å¼€å¯ metric\nè®¿é—®æµ‹è¯•\n[root@k8s-node1 ~]# kubectl get svc traefik-metrics -n traefik NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE traefik-metrics ClusterIP 10.103.102.23 \u0026lt;none\u0026gt; 9100/TCP 19s [root@k8s-node1 ~]# [root@k8s-node1 ~]# curl -s 10.103.102.23:9100/metrics | head -5 # HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles. # TYPE go_gc_duration_seconds summary go_gc_duration_seconds{quantile=\u0026#34;0\u0026#34;} 4.8217e-05 go_gc_duration_seconds{quantile=\u0026#34;0.25\u0026#34;} 7.3819e-05 go_gc_duration_seconds{quantile=\u0026#34;0.5\u0026#34;} 0.000203355 2.2.1 rbac åˆ›å»ºä¸€ä¸ªç”¨äºè®¿é—® traefik å‘½åç©ºé—´çš„ role\nä¿®æ”¹ manifests/prometheus-roleSpecificNamespaces.yaml, æ–°å¢å¦‚ä¸‹é…ç½®\n- apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: labels: app.kubernetes.io/component: prometheus app.kubernetes.io/instance: k8s app.kubernetes.io/name: prometheus app.kubernetes.io/part-of: kube-prometheus app.kubernetes.io/version: 2.32.1 name: prometheus-k8s namespace: traefik rules: - apiGroups: - \u0026#34;\u0026#34; resources: - services - endpoints - pods verbs: - get - list - watch - apiGroups: - extensions resources: - ingresses verbs: - get - list - watch - apiGroups: - networking.k8s.io resources: - ingresses verbs: - get - list - watch å°†ä¸Šä¸€æ­¥åˆ›å»ºçš„ role ä¸ serviceAccount prometheus-k8s ç»‘å®š\nä¿®æ”¹ manifests/prometheus-roleBindingSpecificNamespaces.yaml, æ–°å¢å¦‚ä¸‹é…ç½®\n- apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: labels: app.kubernetes.io/component: prometheus app.kubernetes.io/instance: k8s app.kubernetes.io/name: prometheus app.kubernetes.io/part-of: kube-prometheus app.kubernetes.io/version: 2.32.1 name: prometheus-k8s namespace: traefik roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: prometheus-k8s subjects: - kind: ServiceAccount name: prometheus-k8s namespace: monitoring éªŒè¯\n[root@k8s-node1 kube-prometheus]# kubectl get role,rolebinding -n traefik NAME CREATED AT role.rbac.authorization.k8s.io/prometheus-k8s 2023-04-26T06:50:22Z NAME ROLE AGE rolebinding.rbac.authorization.k8s.io/prometheus-k8s Role/prometheus-k8s 75m 2.2.2 serviceMonitor åˆ›å»º serviceMonitor\napiVersion: monitoring.coreos.com/v1 kind: ServiceMonitor metadata: name: traefik namespace: monitoring labels: app.kubernetes.io/name: traefik spec: jobLabel: app.kubernetes.io/name endpoints: - interval: 15s port: metrics # endpoint(service) ä¸­å®šä¹‰çš„ portName path: /metrics # metrics è®¿é—®è·¯å¾„ namespaceSelector: # æŒ‡å®š namespace matchNames: - traefik selector: matchLabels: app: traefik-metrics # endpoint çš„ label ç­›é€‰ éƒ¨ç½²\nkubectl apply -f manifests/traefik-serviceMonitor.yml 2.2.3 éªŒè¯ prometheus çš„ configuration ç•Œé¢è‡ªåŠ¨ç”Ÿæˆçš„é…ç½®å¦‚ä¸‹\n- job_name: serviceMonitor/monitoring/traefik/0 honor_timestamps: true scrape_interval: 15s scrape_timeout: 10s metrics_path: /metrics scheme: http follow_redirects: true relabel_configs: - source_labels: [job] separator: ; regex: (.*) target_label: __tmp_prometheus_job_name replacement: $1 action: replace - source_labels: [__meta_kubernetes_service_label_app, __meta_kubernetes_service_labelpresent_app] separator: ; regex: (traefik-metrics);true replacement: $1 action: keep - source_labels: [__meta_kubernetes_endpoint_port_name] separator: ; regex: metrics replacement: $1 action: keep - source_labels: [__meta_kubernetes_endpoint_address_target_kind, __meta_kubernetes_endpoint_address_target_name] separator: ; regex: Node;(.*) target_label: node replacement: ${1} action: replace - source_labels: [__meta_kubernetes_endpoint_address_target_kind, __meta_kubernetes_endpoint_address_target_name] separator: ; regex: Pod;(.*) target_label: pod replacement: ${1} action: replace - source_labels: [__meta_kubernetes_namespace] separator: ; regex: (.*) target_label: namespace replacement: $1 action: replace - source_labels: [__meta_kubernetes_service_name] separator: ; regex: (.*) target_label: service replacement: $1 action: replace - source_labels: [__meta_kubernetes_pod_name] separator: ; regex: (.*) target_label: pod replacement: $1 action: replace - source_labels: [__meta_kubernetes_pod_container_name] separator: ; regex: (.*) target_label: container replacement: $1 action: replace - source_labels: [__meta_kubernetes_service_name] separator: ; regex: (.*) target_label: job replacement: ${1} action: replace - source_labels: [__meta_kubernetes_service_label_app_kubernetes_io_name] separator: ; regex: (.+) target_label: job replacement: ${1} action: replace - separator: ; regex: (.*) target_label: endpoint replacement: metrics action: replace - source_labels: [__address__] separator: ; regex: (.*) modulus: 1 target_label: __tmp_hash replacement: $1 action: hashmod - source_labels: [__tmp_hash] separator: ; regex: \u0026#34;0\u0026#34; replacement: $1 action: keep kubernetes_sd_configs: - role: endpoints kubeconfig_file: \u0026#34;\u0026#34; follow_redirects: true namespaces: names: - traefik Service Discovery ç•Œé¢\nTargets ç•Œé¢\n3 podMonitor CRD 3.1 calico-node ä»¥ calico ä¸ºä¾‹, ä½¿ç”¨ podMonitor èµ„æºç›‘æ§ calico-node\ncalico ä¸­æ ¸å¿ƒçš„ç»„ä»¶æ˜¯ Felixï¼Œå®ƒè´Ÿè´£è®¾ç½®è·¯ç”±è¡¨å’Œ ACL è§„åˆ™ï¼ŒåŒæ—¶è¿˜è´Ÿè´£æä¾›ç½‘ç»œå¥åº·çŠ¶å†µçš„æ•°æ®ï¼›è¿™äº›æ•°æ®ä¼šè¢«å†™å…¥ etcdã€‚\nç›‘æ§ calico çš„æ ¸å¿ƒä¾¿æ˜¯ç›‘æ§ felixï¼Œfelix ç›¸å½“äº calico çš„å¤§è„‘ã€‚\nå¦‚ä¸‹æ‰€ç¤º, ä¸€èˆ¬ calico-node éƒ½æ˜¯ä½¿ç”¨ daemonset æ–¹å¼éƒ¨ç½²åœ¨é›†ç¾¤ä¸­çš„\n[root@k8s-node1 ~]# kubectl get pods -n kube-system -l k8s-app=calico-node -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES calico-node-8p9w5 1/1 Running 2 (5d16h ago) 7d23h 1.1.1.2 k8s-node2 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; calico-node-bw2kb 1/1 Running 2 (5d16h ago) 7d23h 1.1.1.1 k8s-node1 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; calico-node-gt688 1/1 Running 2 (5d16h ago) 7d23h 1.1.1.3 k8s-node3 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; calico-node é»˜è®¤æ˜¯æ²¡æœ‰æ‰“å¼€ metrics ç›‘å¬çš„, æˆ‘ä»¬ä¿®æ”¹ calico çš„ daemonset é…ç½®æ–‡ä»¶, å¯ä»¥ç›´æ¥ä¿®æ”¹éƒ¨ç½²æ—¶çš„ yaml, ä¹Ÿå¯ä»¥ kubectl edit ds calico-node -n kube-system\nkind: DaemonSet spec: template: spec: containers: - name: calico-node env: # æ·»åŠ å¦‚ä¸‹é…ç½®, å¼€å¯ FELIX çš„ metrics çš„ç›‘å¬ç«¯å£ä¸º 9101 (9100 ç«¯å£è¢« node-exporter å æ®äº†) - name: FELIX_PROMETHEUSMETRICSENABLED value: \u0026#34;True\u0026#34; - name: FELIX_PROMETHEUSMETRICSPORT value: \u0026#34;9101\u0026#34; ports: - containerPort: 9101 name: metrics protocol: TCP ä¿®æ”¹å®Œç­‰å¾… calico-node çš„ pod é‡æ–°éƒ¨ç½², ç„¶åè®¿é—®æµ‹è¯•\n[root@k8s-node1 ~]# curl -s k8s-node2:9101/metrics | head -6 # HELP felix_active_local_endpoints Number of active endpoints on this host. # TYPE felix_active_local_endpoints gauge felix_active_local_endpoints 9 # HELP felix_active_local_policies Number of active policies on this host. # TYPE felix_active_local_policies gauge felix_active_local_policies 0 ç”±äº kube-prometheus é»˜è®¤å·²ç»å¸®æˆ‘ä»¬åˆ›å»ºäº†åŸºäº kube-sysetm å‘½åç©ºé—´çš„æˆæƒ, æˆ‘ä»¬æ— éœ€å†é¢å¤–é…ç½®\nåˆ›å»º podMonitor\napiVersion: monitoring.coreos.com/v1 kind: PodMonitor metadata: labels: app.kubernetes.io/name: calico-node name: calico-node namespace: monitoring spec: jobLabel: app.kubernetes.io/name podMetricsEndpoints: - interval: 15s path: /metrics port: metrics # ç¡®ä¿ä¸ calico-node çš„ containerPort åç§°ä¸€è‡´ namespaceSelector: matchNames: - kube-system # ç¡®ä¿å‘½åç©ºé—´æ­£ç¡® selector: matchLabels: k8s-app: calico-node # ç¡®ä¿ label é…ç½®æ­£ç¡® æŸ¥çœ‹ prometheus\n4 é›†ç¾¤èŒƒå›´çš„è‡ªåŠ¨å‘ç° å½“æˆ‘ä»¬çš„ k8s é›†ç¾¤ä¸­ service å’Œ pod è¾¾åˆ°ä¸€å®šè§„æ¨¡åæ‰‹åŠ¨ä¸€ä¸ªä¸€ä¸ªåˆ›å»º serviceMonitor å’Œ podMonitor ä¸å…åˆéº»çƒ¦äº†èµ·æ¥, æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸é™åˆ¶ namespace çš„ kubernetes_sd_configs å®ç°é›†ç¾¤èŒƒå›´å†…è‡ªåŠ¨å‘ç°æ‰€æœ‰çš„ exporter å®ä¾‹\næ¥ä¸‹æ¥çš„æ¼”ç¤ºä¸­æˆ‘ä»¬ç›‘æ§é›†ç¾¤èŒƒå›´å†…çš„æ‰€æœ‰ endpoints, å¹¶ä¸”å°†å¸¦æœ‰ prometheus.io/scrape=true è¿™ä¸ª annotations çš„ service æ³¨å†Œåˆ° prometheus\n4.1 rbac ç”±äºéœ€è¦è®¿é—®è®¿é—®é›†ç¾¤èŒƒå›´å†…çš„èµ„æºå¯¹è±¡, ç»§ç»­ä½¿ç”¨ role+roleBinding æ¨¡å¼æ˜¾ç„¶ä¸é€‚åˆ, prometheus-k8s è¿™ä¸ª serviceAccount è¿˜ç»‘å®šä¸€ä¸ªåä¸º prometheus-k8s çš„ clusterRole, è¯¥ clusterRole é»˜è®¤æƒé™æ˜¯ä¸å¤Ÿçš„, æ·»åŠ éœ€è¦çš„æƒé™:\n# vim manifests/prometheus-clusterRole.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: labels: app.kubernetes.io/component: prometheus app.kubernetes.io/instance: k8s app.kubernetes.io/name: prometheus app.kubernetes.io/part-of: kube-prometheus app.kubernetes.io/version: 2.32.1 name: prometheus-k8s namespace: monitoring rules: - apiGroups: - \u0026#34;\u0026#34; resources: - nodes - services - endpoints - pods - nodes/metrics verbs: - get - list - watch - apiGroups: - \u0026#34;\u0026#34; resources: - configmaps - nodes/metrics verbs: - get - nonResourceURLs: - /metrics verbs: - get # kubectl apply -f manifests/prometheus-clusterRole.yaml 4.2 è‡ªåŠ¨å‘ç°é…ç½® é€šè¿‡ä¸Šä¸€ç¯‡æ–‡ç« ä¸­çš„ additionalScrapeConfigs æ·»åŠ è‡ªåŠ¨å‘ç°é…ç½®\n# vim prometheus-additional.yaml - job_name: \u0026#39;kubernetes-service-endpoints\u0026#39; kubernetes_sd_configs: - role: endpoints relabel_configs: - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape] action: keep regex: true - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme] action: replace target_label: __scheme__ regex: (https?) - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path] action: replace target_label: __metrics_path__ regex: (.+) - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port] action: replace target_label: __address__ regex: ([^:]+)(?::\\d+)?;(\\d+) replacement: $1:$2 - action: labelmap regex: __meta_kubernetes_service_label_(.+) - source_labels: [__meta_kubernetes_namespace] action: replace target_label: kubernetes_namespace - source_labels: [__meta_kubernetes_service_name] action: replace target_label: kubernetes_name ä¿®æ”¹ secret\nkubectl create secret generic additional-scrape-configs -n monitoring --from-file=prometheus-additional.yaml \u0026gt; additional-scrape-configs.yaml kubectl apply -f additional-scrape-configs.yaml ç¡®ä¿ prometheus CRD ä¸­æ·»åŠ äº† additionalScrapeConfigs é…ç½®\nkind: Prometheus spec: additionalScrapeConfigs: name: additional-scrape-configs # secret name key: prometheus-additional.yaml # secret key 4.3 éªŒè¯ service kube-dns é»˜è®¤æœ‰ prometheus.io/scrape=true è¿™ä¸ªæ³¨è§£, å·²ç»æˆåŠŸæ³¨å†Œ:\nåˆ›å»ºä¸€ä¸ªç¤ºä¾‹åº”ç”¨\n# vim node-exporter-deploy-svc.yml apiVersion: v1 kind: Namespace metadata: name: test --- apiVersion: v1 kind: Service metadata: name: test-node-exporter namespace: test labels: app: test-node-exporter annotations: prometheus.io/scrape: \u0026#34;true\u0026#34; prometheus.io/port: \u0026#34;9200\u0026#34; spec: selector: app: test-node-exporter ports: - name: metrics port: 9200 targetPort: metrics --- apiVersion: apps/v1 kind: Deployment metadata: name: test-node-exporter namespace: test labels: app: test-node-exporter spec: replicas: 1 selector: matchLabels: app: test-node-exporter template: metadata: labels: app: test-node-exporter spec: containers: - args: - --web.listen-address=:9200 image: registry.cn-hangzhou.aliyuncs.com/lvbibir/node-exporter:v1.3.1 name: node-exporter ports: - name: metrics containerPort: 9200 # kubectl apply -f node-exporter-deploy-svc.yml å¦‚ä¸‹, æˆ‘ä»¬éƒ¨ç½²çš„ node-exporter å·²ç»æˆåŠŸæ³¨å†Œ, åªè¦ service è®¾ç½®äº† annotations å³å¯\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-prometheus-3-servicemonitor-podmonitor/","summary":"0 å‰è¨€ åŸºäº centos7.9 docker-ce-20.10.18 kubelet-1.22.3-0 kube-prometheus-0.10 prometheus-v2.32.1 1 ç®€ä»‹ æ‰‹åŠ¨æ·»åŠ  job é…ç½®æœªå…è¿‡äºç¹ç, prometheus æ”¯æŒå¾ˆå¤šç§æ–¹å¼çš„æœåŠ¡å‘ç°, åœ¨ k8s ä¸­æ˜¯é€šè¿‡ kubernetes_sd_config é…ç½®å®ç°çš„. é€šè¿‡æŠ“å– k8s REST API è‡ªåŠ¨å‘ç°æˆ‘ä»¬éƒ¨ç½²åœ¨ k8s é›†ç¾¤ä¸­çš„ exporter å®ä¾‹ åœ¨ Prometheus Operator ä¸­, æˆ‘ä»¬æ— éœ€æ‰‹åŠ¨ç¼–è¾‘é…ç½®æ–‡ä»¶æ·»åŠ  kubernetes_sd_config é…ç½®, Prometheus Operator æä¾›äº†ä¸‹è¿°èµ„æº: serviceMonitor: åˆ›å»º endpoints çº§åˆ«çš„æœåŠ¡å‘ç° podMonitor: åˆ›å»º pod çº§åˆ«çš„æœåŠ¡å‘ç° probe: åˆ›å»º ingress çº§åˆ«çš„","title":"prometheus (ä¸‰) æœåŠ¡å‘ç°"},{"content":"0 å‰è¨€ åŸºäº centos7.9 docker-ce-20.10.18 kubelet-1.22.3-0 kube-prometheus-0.10 prometheus-v2.32.1\n1 ç®€ä»‹ ä½¿ç”¨åŸç”Ÿçš„ prometheus æ—¶, æˆ‘ä»¬åˆ›å»º job ç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶å³å¯, ç„¶è€Œåœ¨ prometheus-operator ä¸­æ‰€æœ‰çš„é…ç½®éƒ½æŠ½è±¡æˆäº† k8s CRD èµ„æº, æ‰‹åŠ¨é…ç½® job éœ€è¦:\nåˆ›å»º secret åœ¨ prometheus CRD èµ„æºä¸­é…ç½® additionalScrapeConfigs additional-scrape-config å®˜æ–¹ç¤ºä¾‹\n2 ç¤ºä¾‹ 2.1 node-exporter æ·»åŠ  k8s é›†ç¾¤å¤–çš„ node-exporter metrics\nåœ¨ 1.1.1.4 éƒ¨ç½² node-exporter\ndocker run -d --name node-exporter \\ -p 9102:9100 \\ -v \u0026#34;/proc:/host/proc:ro\u0026#34; \\ -v \u0026#34;/sys:/host/sys:ro\u0026#34; \\ -v \u0026#34;/:/rootfs:ro\u0026#34; \\ registry.cn-hangzhou.aliyuncs.com/lvbibir/node-exporter:v1.3.1 \\ --path.sysfs=/host/sys \\ --path.rootfs=/roofs # éªŒè¯å¯ç”¨æ€§ [root@1-1-1-4 ~]# curl -s 1.1.1.4:9100/metrics | head -5 # HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles. # TYPE go_gc_duration_seconds summary go_gc_duration_seconds{quantile=\u0026#34;0\u0026#34;} 0.000326036 go_gc_duration_seconds{quantile=\u0026#34;0.25\u0026#34;} 0.000326036 go_gc_duration_seconds{quantile=\u0026#34;0.5\u0026#34;} 0.000714158 åˆ›å»º job é…ç½® prometheus-additional.yaml\n- job_name: \u0026#34;node-exporter\u0026#34; static_configs: - targets: - \u0026#34;1.1.1.4:9100\u0026#34; åˆ›å»º secret additional-scrape-configs.yaml\nkubectl create secret generic additional-scrape-configs -n monitoring --from-file=prometheus-additional.yaml \u0026gt; additional-scrape-configs.yaml kubectl apply -f additional-scrape-configs.yaml ä¿®æ”¹ prometheus èµ„æº prometheus-prometheus.yaml , æ·»åŠ  additionalScrapeConfigs\nkind: Prometheus spec: # æ·»åŠ å¦‚ä¸‹ä¸‰è¡Œ additionalScrapeConfigs: name: additional-scrape-configs # secret name key: prometheus-additional.yaml # secret key æ›´æ–°ä¸€ä¸‹ prometheus\n[root@k8s-node1 demo]# kubectl apply -f ../prometheus-prometheus.yaml æŸ¥çœ‹ç»“æœ\n3 åŠ¨æ€æ›´æ–° åç»­æ‰€æœ‰çš„è‡ªå®šä¹‰é…ç½®ç›´æ¥æ›´æ–°ç°æœ‰çš„ secret å³å¯\næ¯”å¦‚åœ¨ä¹‹å‰çš„ node-exporter çš„ job ä¸­æ–°å¢ä¸€ä¸ª target\nä¿®æ”¹ prometheus-additional.yaml\n- job_name: \u0026#34;node-exporter\u0026#34; static_configs: - targets: - \u0026#34;1.1.1.4:9100\u0026#34; - \u0026#34;192.168.17.99:59100\u0026#34; æ›´æ–° secret\nkubectl create secret generic additional-scrape-configs -n monitoring --from-file=prometheus-additional.yaml \u0026gt; additional-scrape-configs.yaml kubectl apply -f additional-scrape-configs.yaml prometheus ä¼šè‡ªåŠ¨é‡è½½é…ç½®\n4 æ›´æ–°å¤±è´¥æ’æŸ¥ å¦‚æœä¿®æ”¹äº† secret ä¸ç”Ÿæ•ˆä¸€å®šè¦æ³¨æ„ secret éƒ¨ç½²çš„ namespace æ˜¯ä¸æ˜¯ monitoring\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-prometheus-2-additionalscrapeconfig/","summary":"0 å‰è¨€ åŸºäº centos7.9 docker-ce-20.10.18 kubelet-1.22.3-0 kube-prometheus-0.10 prometheus-v2.32.1 1 ç®€ä»‹ ä½¿ç”¨åŸç”Ÿçš„ prometheus æ—¶, æˆ‘ä»¬åˆ›å»º job ç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶å³å¯, ç„¶è€Œåœ¨ prometheus-operator ä¸­æ‰€æœ‰çš„é…ç½®éƒ½æŠ½è±¡æˆäº† k8s CRD èµ„æº, æ‰‹åŠ¨é…ç½® job éœ€è¦: åˆ›å»º secret åœ¨ prometheus CRD èµ„æºä¸­é…ç½® additionalScrapeConfigs additional-scrape-config å®˜æ–¹ç¤ºä¾‹ 2 ç¤ºä¾‹ 2.1 node-exporter æ·»åŠ  k8s é›†ç¾¤å¤–çš„ node-exporter metrics åœ¨ 1.1.1.4 éƒ¨ç½² node-exporter docker run -d --name node-exporter \\ -p 9102:9100 \\ -v \u0026#34;/proc:/host/proc:ro\u0026#34; \\ -v \u0026#34;/sys:/host/sys:ro\u0026#34; \\ -v \u0026#34;/:/rootfs:ro\u0026#34; \\ registry.cn-hangzhou.aliyuncs.com/lvbibir/node-exporter:v1.3.1 \\ --path.sysfs=/host/sys \\ --path.rootfs=/roofs # éªŒè¯å¯ç”¨æ€§ [root@1-1-1-4 ~]# curl -s 1.1.1.4:9100/metrics | head -5 # HELP","title":"prometheus (äºŒ) é™æ€é…ç½®"},{"content":"0 å‰è¨€ åŸºäº centos7.9 docker-ce-20.10.18 kubelet-1.22.3-0 kube-prometheus-0.10 prometheus-v2.32.1\n1 ç®€ä»‹ 1.1 prometheus operator Prometheus Operator: åœ¨ Kubernetes ä¸Šç®¡ç† Prometheus é›†ç¾¤ã€‚è¯¥é¡¹ç›®çš„ç›®çš„æ˜¯ç®€åŒ–å’Œè‡ªåŠ¨åŒ–åŸºäº Prometheus çš„ Kubernetes é›†ç¾¤ç›‘æ§å †æ ˆçš„é…ç½®ã€‚\næ‰€æœ‰ CRD èµ„æºçš„ API æ–‡æ¡£\nPrometheus Operator çš„æ ¸å¿ƒç‰¹æ€§æ˜¯ watch Kubernetes API æœåŠ¡å™¨å¯¹ç‰¹å®šå¯¹è±¡çš„æ›´æ”¹ï¼Œå¹¶ç¡®ä¿å½“å‰ Prometheus éƒ¨ç½²ä¸è¿™äº›å¯¹è±¡åŒ¹é…ã€‚\nmonitoring.coreos.com/v1:\nprometheus ç›¸å…³ Prometheus: é…ç½® Prometheus statefulset åŠ Prometheus çš„ä¸€äº›é…ç½®ã€‚ ServiceMonitor: ç”¨äºé€šè¿‡ Service å¯¹ K8S ä¸­çš„èµ„æºè¿›è¡Œç›‘æ§ï¼Œæ¨èé¦–é€‰ ServiceMonitor. å®ƒå£°æ˜æ€§åœ°æŒ‡å®šäº† Kubernetes service åº”è¯¥å¦‚ä½•è¢«ç›‘æ§ã€‚ PodMonitor: ç”¨äºå¯¹ Pod è¿›è¡Œç›‘æ§ï¼Œæ¨èé¦–é€‰ ServiceMonitor. PodMonitor å£°æ˜æ€§åœ°æŒ‡å®šäº†åº”è¯¥å¦‚ä½•ç›‘è§†ä¸€ç»„ podã€‚ Probe: å®ƒå£°æ˜æ€§åœ°æŒ‡å®šäº†åº”è¯¥å¦‚ä½•ç›‘è§† ingress æˆ–é™æ€ç›®æ ‡ç»„. ä¸€èˆ¬ç”¨äºé»‘ç›’ç›‘æ§. PrometheusRule: ç”¨äºç®¡ç† Prometheus å‘Šè­¦è§„åˆ™ï¼›å®ƒå®šä¹‰äº†ä¸€å¥—æ‰€éœ€çš„ Prometheus è­¦æŠ¥å’Œ/æˆ–è®°å½•è§„åˆ™ã€‚å¯ä»¥è¢« Prometheus å®ä¾‹æŒ‚è½½ä½¿ç”¨ã€‚ Alertmanager ç›¸å…³ Alertmanager: é…ç½® AlertManager statefulset åŠ AlertManager çš„ä¸€äº›é…ç½®ã€‚ AlertmanagerConfig: ç”¨äºç®¡ç† AlertManager é…ç½®æ–‡ä»¶ï¼›å®ƒå£°æ˜æ€§åœ°æŒ‡å®š Alertmanager é…ç½®çš„å­éƒ¨åˆ†ï¼Œå…è®¸å°†è­¦æŠ¥è·¯ç”±åˆ°è‡ªå®šä¹‰æ¥æ”¶å™¨ï¼Œå¹¶è®¾ç½®ç¦æ­¢è§„åˆ™ã€‚ å…¶ä»– ThanosRuler: ç®¡ç† ThanosRuler deploymentï¼› 1.2 kube-prometheus kube-prometheus æä¾›äº†ä¸€ä¸ªåŸºäº Prometheus å’Œ Prometheus Operator çš„å®Œæ•´é›†ç¾¤ç›‘æ§å †æ ˆçš„ç¤ºä¾‹é…ç½®ã€‚è¿™åŒ…æ‹¬éƒ¨ç½²å¤šä¸ª Prometheus å’Œ Alertmanager å®ä¾‹ã€ç”¨äºæ”¶é›†èŠ‚ç‚¹æŒ‡æ ‡çš„æŒ‡æ ‡å¯¼å‡ºå™¨ï¼ˆå¦‚ node_exporters)ã€å°† Prometheus é“¾æ¥åˆ°å„ç§æŒ‡æ ‡ç«¯ç‚¹çš„ç›®æ ‡é…ç½®ï¼Œä»¥åŠç”¨äºé€šçŸ¥é›†ç¾¤ä¸­æ½œåœ¨é—®é¢˜çš„ç¤ºä¾‹è­¦æŠ¥è§„åˆ™ã€‚\n2 éƒ¨ç½² kubernets ä¸ kube-prometheus çš„å…¼å®¹æ€§å…³ç³»å¦‚ä¸‹\nkube-prometheus stack Kubernetes 1.21 Kubernetes 1.22 Kubernetes 1.23 Kubernetes 1.24 Kubernetes 1.25 release-0.9 âœ” âœ” âœ— âœ— âœ— release-0.10 âœ— âœ” âœ” âœ— âœ— release-0.11 âœ— âœ— âœ” âœ” âœ— release-0.12 âœ— âœ— âœ— âœ” âœ” kube-prometheus é¡¹ç›®æä¾›çš„ yaml ä¸­ä½¿ç”¨çš„é•œåƒå¤§éƒ¨åˆ†æ˜¯ quay.io æˆ–è€… k8s.gcr.io ç­‰å¤–ç½‘ä»“åº“çš„é•œåƒï¼Œåšä¸»å·²ç»å°†æ‰€éœ€é•œåƒä¸Šä¼ åˆ°äº†é˜¿é‡Œäº‘ï¼Œä¸” fork å®˜æ–¹ä»“åº“åä¿®æ”¹äº† yaml ä¸­çš„é•œåƒä»“åº“åœ°å€ï¼Œå¯ä»¥ç›´æ¥æ‹‰å–æˆ‘ä¿®æ”¹åçš„ yaml\nè¿™é‡Œæˆ‘çš„ k8s æµ‹è¯•é›†ç¾¤ç‰ˆæœ¬æ˜¯ 1.22.3ï¼Œéƒ¨ç½² release-0.10 ç‰ˆæœ¬çš„ kube-prometheus\n[root@k8s-node1 opt]# cd /opt/ \u0026amp;\u0026amp; git clone https://github.com/lvbibir/kube-prometheus -b release-0.10 [root@k8s-node1 kube-prometheus]# cd /opt/kube-prometheus/ [root@k8s-node1 kube-prometheus]# kubectl create -f manifests/setup/ [root@k8s-node1 kube-prometheus]# kubectl create -f manifests/ éªŒè¯\n[root@k8s-node1 kube-prometheus]# kubectl get pods -n monitoring NAME READY STATUS RESTARTS AGE alertmanager-main-0 2/2 Running 0 5m16s alertmanager-main-1 2/2 Running 0 5m16s alertmanager-main-2 2/2 Running 0 5m16s blackbox-exporter-7c8787786-r9lmv 3/3 Running 0 8m12s grafana-795c6dd64b-8cspz 1/1 Running 0 8m11s kube-state-metrics-56f79b8fdc-9p97x 3/3 Running 0 8m11s node-exporter-4scm6 2/2 Running 0 8m11s node-exporter-7hlrp 2/2 Running 0 8m11s node-exporter-pph2d 2/2 Running 0 8m11s prometheus-adapter-5595dcc894-nmn2w 1/1 Running 0 8m10s prometheus-adapter-5595dcc894-rzdhv 1/1 Running 0 8m10s prometheus-k8s-0 2/2 Running 0 5m15s prometheus-k8s-1 2/2 Running 0 5m15s prometheus-operator-7575c94984-7r4l9 2/2 Running 0 8m10s [root@k8s-node1 kube-prometheus]# kubectl get svc -n monitoring NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE alertmanager-main NodePort 10.104.94.103 \u0026lt;none\u0026gt; 9093:39093/TCP,8080:10422/TCP 9m12s alertmanager-operated ClusterIP None \u0026lt;none\u0026gt; 9093/TCP,9094/TCP,9094/UDP 6m16s blackbox-exporter ClusterIP 10.103.168.130 \u0026lt;none\u0026gt; 9115/TCP,19115/TCP 9m12s grafana NodePort 10.108.134.168 \u0026lt;none\u0026gt; 3000:33000/TCP 9m11s kube-state-metrics ClusterIP None \u0026lt;none\u0026gt; 8443/TCP,9443/TCP 9m11s node-exporter ClusterIP None \u0026lt;none\u0026gt; 9100/TCP 9m11s prometheus-adapter ClusterIP 10.111.22.126 \u0026lt;none\u0026gt; 443/TCP 9m10s prometheus-k8s NodePort 10.111.183.173 \u0026lt;none\u0026gt; 9090:39090/TCP,8080:43263/TCP 9m11s prometheus-operated ClusterIP None \u0026lt;none\u0026gt; 9090/TCP 6m15s prometheus-operator ClusterIP None \u0026lt;none\u0026gt; 8443/TCP 9m10s å¯ä»¥é€šè¿‡ nodePort è®¿é—®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ ingress å°† grafana æš´éœ²åˆ°å¤–éƒ¨\ngrafana é»˜è®¤ç”¨æˆ·åå¯†ç ä¸º admin/admin\n2.1 ç»„ä»¶ä»‹ç» kube-prometheus ä¸­éƒ¨ç½²äº†å¦‚ä¸‹ç»„ä»¶:\nCRD èµ„æº: manifests/setup ç›®å½•ä¸­çš„å†…å®¹ å®é™…çš„ç»„ä»¶éƒ¨ç½²å’Œé…ç½®: manifests ç›®å½•ä¸­çš„å†…å®¹ exporter æ•°æ®é‡‡é›†å™¨: node-exporter blackbox-exporter ç”¨äºé»‘ç›’ç›‘æ§ prometheus å®ä¾‹ grafana å®ä¾‹ alertmanager å®ä¾‹ adapter å®ä¾‹, æ›¿ä»£åŸå§‹ metrics-server ç»„ä»¶, å®ç°è‡ªå®šä¹‰ HPA æŒ‡æ ‡, å‚è€ƒ 3 æ•°æ®æŒä¹…åŒ– 3.1 prometheus prometheus é»˜è®¤çš„æ•°æ®æ–‡ä»¶ä½¿ç”¨çš„æ˜¯ emptydir æ–¹å¼è¿›è¡Œçš„æŒä¹…åŒ–, æˆ‘ä»¬æ”¹ä¸º nfs\nä¿®æ”¹ manifests/prometheus-prometheus.yaml\nåœ¨æ–‡ä»¶æœ€åæ–°å¢é…ç½®\nretention: 15d # ç›‘æ§æ•°æ®ä¿å­˜çš„æ—¶é—´ä¸º 15 å¤© storage: # å­˜å‚¨é…ç½®, ä½¿ç”¨ nfs çš„ storageClass volumeClaimTemplate: spec: storageClassName: \u0026#34;nfs\u0026#34; accessModes: - ReadWriteOnce resources: requests: storage: 10Gi åº”ç”¨åæŸ¥çœ‹æ–°å»ºçš„ pod ä¸­çš„ volumes ä¿¡æ¯\n# pod.spec.container.volumeMounts [root@k8s-node1 ~]# kubectl get pod prometheus-k8s-0 -n monitoring -o jsonpath=\u0026#39;{.spec.containers[?(@.name==\u0026#34;prometheus\u0026#34;)].volumeMounts[?(@.name==\u0026#34;prometheus-k8s-db\u0026#34;)]}{\u0026#34;\\n\u0026#34;}\u0026#39; | python -m json.tool { \u0026#34;mountPath\u0026#34;: \u0026#34;/prometheus\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;prometheus-k8s-db\u0026#34;, \u0026#34;subPath\u0026#34;: \u0026#34;prometheus-db\u0026#34; } # pod.spec.volumes [root@k8s-node1 ~]# kubectl get pod prometheus-k8s-0 -n monitoring -o jsonpath=\u0026#39;{.spec.volumes[?(@.name==\u0026#34;prometheus-k8s-db\u0026#34;)]}\u0026#39; | python -m json.tool { \u0026#34;name\u0026#34;: \u0026#34;prometheus-k8s-db\u0026#34;, \u0026#34;persistentVolumeClaim\u0026#34;: { \u0026#34;claimName\u0026#34;: \u0026#34;prometheus-k8s-db-prometheus-k8s-0\u0026#34; } } ä¸ä¼ ç»Ÿ statefulset ä¸åŒçš„æ˜¯, prometheus è¯†åˆ«åˆ° .spec.storage.volumeClaimTemplate é…ç½®åä¼šè‡ªåŠ¨å°† prometheus çš„æ•°æ®æ–‡ä»¶æŒ‚è½½åˆ°è‡ªåŠ¨åˆ›å»ºçš„ pvc ä¸Š, æ— éœ€æ‰‹åŠ¨æŒ‡å®š name ç„¶åæŒ‚è½½\n3.2 alertmanager ä¸ prometheus ç±»ä¼¼, è¿™é‡Œå°±ä¸èµ˜è¿°äº†\nmanifests/alertmanager-alertmanager.yaml\nstorage: # å­˜å‚¨é…ç½®, ä½¿ç”¨ nfs çš„ storageClass volumeClaimTemplate: spec: storageClassName: \u0026#34;nfs\u0026#34; accessModes: - ReadWriteOnce resources: requests: storage: 1Gi é‡æ–° apply ä¹‹å, æŸ¥çœ‹æ–°ç”Ÿæˆ pod çš„ volumes\n# pod.spec.container.volumeMounts [root@k8s-node1 ~]# kubectl get pod alertmanager-main-0 -n monitoring -o jsonpath=\u0026#39;{.spec.containers[?(@.name==\u0026#34;alertmanager\u0026#34;)].volumeMounts[?(@.name==\u0026#34;alertmanager-main-db\u0026#34;)]}{\u0026#34;\\n\u0026#34;}\u0026#39; | python -m json.tool { \u0026#34;mountPath\u0026#34;: \u0026#34;/alertmanager\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;alertmanager-main-db\u0026#34;, \u0026#34;subPath\u0026#34;: \u0026#34;alertmanager-db\u0026#34; } # pod.spec.volumes [root@k8s-node1 ~]# kubectl get pod alertmanager-main-0 -n monitoring -o jsonpath=\u0026#39;{.spec.volumes[?(@.name==\u0026#34;alertmanager-main-db\u0026#34;)]}\u0026#39; | python -m json.tool { \u0026#34;name\u0026#34;: \u0026#34;alertmanager-main-db\u0026#34;, \u0026#34;persistentVolumeClaim\u0026#34;: { \u0026#34;claimName\u0026#34;: \u0026#34;alertmanager-main-db-alertmanager-main-0\u0026#34; } } 3.3 grafana grafana å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ deployment åº”ç”¨, ç›´æ¥ä¿®æ”¹ yaml ä¸­çš„ volume é…ç½®å³å¯\n[root@k8s-node1 ~]# mkdir /nfs/kubernetes/grafana-data [root@k8s-node1 ~]# chmod -R 777 /nfs/kubernetes/grafana-data ä¿®æ”¹ manifests/grafana-deployment.yaml ç›´æ¥å°†é»˜è®¤çš„ emptydir ä¿®æ”¹ä¸º nfs å³å¯\nvolumes: - name: grafana-storage nfs: server: k8s-node1 path: /nfs/kubernetes/grafana-data ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-prometheus-1-deploy/","summary":"0 å‰è¨€ åŸºäº centos7.9 docker-ce-20.10.18 kubelet-1.22.3-0 kube-prometheus-0.10 prometheus-v2.32.1 1 ç®€ä»‹ 1.1 prometheus operator Prometheus Operator: åœ¨ Kubernetes ä¸Šç®¡ç† Prometheus é›†ç¾¤ã€‚è¯¥é¡¹ç›®çš„ç›®çš„æ˜¯ç®€åŒ–å’Œè‡ªåŠ¨åŒ–åŸºäº Prometheus çš„ Kubernetes é›†ç¾¤ç›‘æ§å †æ ˆçš„é…ç½®ã€‚ æ‰€æœ‰ CRD èµ„æºçš„ API æ–‡æ¡£ Prometheus Operator çš„æ ¸å¿ƒç‰¹æ€§æ˜¯ watch Kubernetes API æœåŠ¡å™¨å¯¹ç‰¹å®šå¯¹è±¡çš„æ›´æ”¹ï¼Œå¹¶ç¡®ä¿å½“å‰ Prometheus éƒ¨ç½²ä¸è¿™äº›å¯¹è±¡åŒ¹é…ã€‚ monitoring.coreos.com/v1: prometheus ç›¸å…³ Prometheus: é…ç½® Prometheus statefulset åŠ Prometheus çš„ä¸€äº›é…ç½®ã€‚ ServiceMonitor: ç”¨äºé€šè¿‡ Service å¯¹ K8S ä¸­çš„èµ„æºè¿›è¡Œç›‘æ§ï¼Œæ¨èé¦–","title":"prometheus (ä¸€) ç®€ä»‹åŠéƒ¨ç½²"},{"content":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0ï¼Œ traefik-2.9.10\nç¤ºä¾‹ä¸­ç”¨åˆ°çš„ myapp å’Œ secret èµ„æºè¯·æŸ¥çœ‹ç³»åˆ—æ–‡ç« ç¬¬äºŒç¯‡ä¸­çš„æ¼”ç¤º\n1 ç®€ä»‹ traefik çš„è·¯ç”±è§„åˆ™å°±å¯ä»¥å®ç° 4 å±‚å’Œ 7 å±‚çš„åŸºæœ¬è´Ÿè½½å‡è¡¡æ“ä½œï¼Œä½¿ç”¨ IngressRoute IngressRouteTCP IngressRouteUDP èµ„æºå³å¯ã€‚ä½†æ˜¯å¦‚æœæƒ³è¦å®ç° åŠ æƒè½®è¯¢ã€æµé‡å¤åˆ¶ ç­‰é«˜çº§æ“ä½œï¼Œtraefik æŠ½è±¡å‡ºäº†ä¸€ä¸ª TraefikService èµ„æºã€‚æ­¤æ—¶æ•´ä½“æµé‡èµ°å‘ä¸ºï¼šå¤–éƒ¨æµé‡å…ˆé€šè¿‡ entryPoints ç«¯å£è¿›å…¥ traefikï¼Œç„¶åç”± IngressRoute/IngressRouteTCP/IngressRouteUDP åŒ¹é…åè¿›å…¥ TraefikServiceï¼Œåœ¨ TraefikService è¿™ä¸€å±‚å®ç°åŠ æƒè½®å¾ªå’Œæµé‡å¤åˆ¶ï¼Œæœ€åå°†è¯·æ±‚è½¬å‘è‡³ kubernetes çš„ serviceã€‚\né™¤æ­¤ä¹‹å¤– traefik è¿˜æ”¯æŒ 7 å±‚çš„ç²˜æ€§ä¼šè¯ã€å¥åº·æ£€æŸ¥ã€ä¼ é€’è¯·æ±‚å¤´ã€å“åº”è½¬å‘ã€æ•…éšœè½¬ç§»ç­‰æ“ä½œã€‚\n2 ç°åº¦å‘å¸ƒ (åŠ æƒè½®è¯¢) å®˜æ–¹æ–‡æ¡£\nç°åº¦å‘å¸ƒä¹Ÿç§°ä¸ºé‡‘ä¸é›€å‘å¸ƒï¼Œè®©ä¸€éƒ¨åˆ†å³å°†ä¸Šçº¿çš„æœåŠ¡å‘å¸ƒåˆ°çº¿ä¸Šï¼Œè§‚å¯Ÿæ˜¯å¦è¾¾åˆ°ä¸Šçº¿è¦æ±‚ï¼Œä¸»è¦é€šè¿‡åŠ æƒè½®è¯¢çš„æ–¹å¼å®ç°ã€‚\nåˆ›å»º traefikService å’Œ inressRoute èµ„æºï¼Œå®ç° wrr åŠ æƒè½®è¯¢\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: ingressroutewrr namespace: default spec: entryPoints: - web routes: - match: Host(`myapp.test.com`) \u0026amp;\u0026amp; PathPrefix(`/`) kind: Rule services: - name: wrr namespace: default kind: TraefikService --- apiVersion: traefik.containo.us/v1alpha1 kind: TraefikService metadata: name: wrr namespace: default spec: weighted: services: - name: myapp1 port: 80 weight: 1 # å®šä¹‰æƒé‡ kind: Service # å¯é€‰ï¼Œé»˜è®¤å°±æ˜¯ Service - name: myapp2 port: 80 weight: 2 æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°æ¯ 3 æ¬¡è®¿é—®ä¼šæœ‰ 1 æ¬¡æµé‡è½åˆ° v1 åº”ç”¨ï¼Œ 2 æ¬¡æµé‡è½åˆ° v2 åº”ç”¨\n[root@k8s-node1 ~]# for i in {1..9}; do curl http://myapp.test.com \u0026amp;\u0026amp; sleep 1; done Hello MyApp | Version: v1 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; Hello MyApp | Version: v2 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; Hello MyApp | Version: v2 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; Hello MyApp | Version: v1 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; Hello MyApp | Version: v2 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; Hello MyApp | Version: v2 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; Hello MyApp | Version: v1 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; Hello MyApp | Version: v2 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; Hello MyApp | Version: v2 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; 3 ä¼šè¯ä¿æŒ (ç²˜æ€§ä¼šè¯) å®˜æ–¹æ–‡æ¡£\nä¼šè¯ä¿æŒåŠŸèƒ½ä¾èµ–åŠ æƒè½®è¯¢åŠŸèƒ½\nå½“æˆ‘ä»¬ä½¿ç”¨ traefik çš„è´Ÿè½½å‡è¡¡æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹è½®å¾ªå¤šä¸ª k8s çš„ service æœåŠ¡ï¼Œå¦‚æœç”¨æˆ·å¯¹åŒä¸€å†…å®¹çš„å¤šæ¬¡è¯·æ±‚ï¼Œå¯èƒ½è¢«è½¬å‘åˆ°äº†ä¸åŒçš„åç«¯æœåŠ¡å™¨ã€‚å‡è®¾ç”¨æˆ·å‘å‡ºè¯·æ±‚è¢«åˆ†é…è‡³æœåŠ¡å™¨ Aï¼Œä¿å­˜äº†ä¸€äº›ä¿¡æ¯åœ¨ session ä¸­ï¼Œè¯¥ç”¨æˆ·å†æ¬¡å‘é€è¯·æ±‚è¢«åˆ†é…åˆ°æœåŠ¡å™¨ Bï¼Œè¦ç”¨ä¹‹å‰ä¿å­˜çš„ä¿¡æ¯ï¼Œè‹¥æœåŠ¡å™¨ A å’Œ B ä¹‹é—´æ²¡æœ‰ session ç²˜æ»ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ B å°±æ‹¿ä¸åˆ°ä¹‹å‰çš„ä¿¡æ¯ï¼Œè¿™æ ·ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ã€‚traefik åŒæ ·ä¹Ÿæ”¯æŒç²˜æ€§ä¼šè¯ï¼Œå¯ä»¥è®©ç”¨æˆ·åœ¨ä¸€æ¬¡ä¼šè¯å‘¨æœŸå†…çš„æ‰€æœ‰è¯·æ±‚å§‹ç»ˆè½¬å‘åˆ°ä¸€å°ç‰¹å®šçš„åç«¯æœåŠ¡å™¨ä¸Šã€‚\nåˆ›å»º traefikervie å’Œ ingressRouteï¼Œå®ç°åŸºäº cookie çš„ä¼šè¯ä¿æŒ\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: ingressroute-sticky namespace: default spec: entryPoints: - web routes: - match: Host(`myapp.test.com`) \u0026amp;\u0026amp; PathPrefix(`/`) kind: Rule services: - name: sticky namespace: default kind: TraefikService --- apiVersion: traefik.containo.us/v1alpha1 kind: TraefikService metadata: name: sticky namespace: default spec: weighted: services: - name: myapp1 port: 80 weight: 1 # å®šä¹‰æƒé‡ - name: myapp2 port: 80 weight: 2 sticky: # å¼€å¯ç²˜æ€§ä¼šè¯ cookie: # åŸºäºcookieåŒºåˆ†å®¢æˆ·ç«¯ name: test-cookie # æŒ‡å®šå®¢æˆ·ç«¯è¯·æ±‚æ—¶ï¼ŒåŒ…å«çš„cookieåç§° å®¢æˆ·ç«¯è®¿é—®æµ‹è¯•ï¼Œæºå¸¦ cookie\n[root@k8s-node1 ~]# for i in {1..5}; do curl -b \u0026#34;test-cookie=default-myapp2-80\u0026#34; http://myapp.test.com; done Hello MyApp | Version: v2 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; Hello MyApp | Version: v2 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; Hello MyApp | Version: v2 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; Hello MyApp | Version: v2 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; Hello MyApp | Version: v2 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; [root@k8s-node1 ~]# for i in {1..5}; do curl -b \u0026#34;test-cookie=default-myapp1-80\u0026#34; http://myapp.test.com; done Hello MyApp | Version: v1 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; Hello MyApp | Version: v1 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; Hello MyApp | Version: v1 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; Hello MyApp | Version: v1 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; Hello MyApp | Version: v1 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; 4 æµé‡å¤åˆ¶ å®˜æ–¹æ–‡æ¡£\næ‰€è°“çš„æµé‡å¤åˆ¶ï¼Œä¹Ÿç§°ä¸ºé•œåƒæœåŠ¡æ˜¯æŒ‡å°†è¯·æ±‚çš„æµé‡æŒ‰è§„åˆ™å¤åˆ¶ä¸€ä»½å‘é€ç»™å…¶å®ƒæœåŠ¡ï¼Œå¹¶ä¸”ä¼šå¿½ç•¥è¿™éƒ¨åˆ†è¯·æ±‚çš„å“åº”ï¼Œè¿™ä¸ªåŠŸèƒ½åœ¨åšä¸€äº›å‹æµ‹æˆ–è€…é—®é¢˜å¤ç°çš„æ—¶å€™å¾ˆæœ‰ç”¨ã€‚\nåˆ›å»º traefikService å’Œ ingressRoute\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: ingressroute-mirror namespace: default spec: entryPoints: - web routes: - match: Host(`myapp.test.com`) \u0026amp;\u0026amp; PathPrefix(`/`) kind: Rule services: - name: mirror-from-service namespace: default kind: TraefikService --- apiVersion: traefik.containo.us/v1alpha1 kind: TraefikService metadata: name: mirror-from-service namespace: default spec: mirroring: name: myapp1 # å‘é€ 100% çš„è¯·æ±‚åˆ° myapp1 port: 80 mirrors: - name: myapp2 # ç„¶åå¤åˆ¶ 10% çš„è¯·æ±‚åˆ° myapp2 port: 80 percent: 10, æµ‹è¯•å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°åªæœ‰ myapp1 åº”ç”¨ä¼šæœ‰æ•°æ®è¿”å›\n[root@k8s-node1 ~]# for i in {1..20}; do curl http://myapp.test.com \u0026amp;\u0026amp; sleep 1; done Hello MyApp | Version: v1 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; Hello MyApp | Version: v1 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; Hello MyApp | Version: v1 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; ....... myapp2 åº”ç”¨åŒæ ·æ”¶åˆ°äº†è¯·æ±‚ï¼Œä¸é¢„æœŸç›¸åŒï¼Œæ”¶åˆ°äº† 10% çš„æµé‡ï¼Œ\n[root@k8s-node1 ~]# kubectl logs -l app=bar .... 10.244.36.64 - - [20/Apr/2023:07:04:33 +0000] \u0026#34;GET / HTTP/1.1\u0026#34; 200 65 \u0026#34;-\u0026#34; \u0026#34;curl/7.29.0\u0026#34; \u0026#34;1.1.1.1\u0026#34; 10.244.36.64 - - [20/Apr/2023:07:04:43 +0000] \u0026#34;GET / HTTP/1.1\u0026#34; 200 65 \u0026#34;-\u0026#34; \u0026#34;curl/7.29.0\u0026#34; \u0026#34;1.1.1.1\u0026#34; ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-traefik-4-traefikservice/","summary":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0ï¼Œ traefik-2.9.10 ç¤ºä¾‹ä¸­ç”¨åˆ°çš„ myapp å’Œ secret èµ„æºè¯·æŸ¥çœ‹ç³»åˆ—æ–‡ç« ç¬¬äºŒç¯‡ä¸­çš„æ¼”ç¤º 1 ç®€ä»‹ traefik çš„è·¯ç”±è§„åˆ™å°±å¯ä»¥å®ç° 4 å±‚å’Œ 7 å±‚çš„åŸºæœ¬è´Ÿè½½å‡è¡¡æ“ä½œï¼Œä½¿ç”¨ IngressRoute IngressRouteTCP IngressRouteUDP èµ„æºå³å¯ã€‚ä½†æ˜¯å¦‚æœæƒ³è¦å®ç° åŠ æƒè½®è¯¢ã€æµé‡å¤åˆ¶ ç­‰é«˜çº§æ“ä½œï¼Œt","title":"traefik (å››) TraefikService æœåŠ¡"},{"content":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0ï¼Œ traefik-2.9.10\nç¤ºä¾‹ä¸­ç”¨åˆ°çš„ myapp å’Œ secret èµ„æºè¯·æŸ¥çœ‹ç³»åˆ—æ–‡ç« ç¬¬äºŒç¯‡ä¸­çš„æ¼”ç¤º\n1 ç®€ä»‹ å®˜æ–¹æ–‡æ¡£\nTraefik Middlewares æ˜¯ä¸€ä¸ªå¤„äºè·¯ç”±å’Œåç«¯æœåŠ¡ä¹‹å‰çš„ä¸­é—´ä»¶ï¼Œåœ¨å¤–éƒ¨æµé‡è¿›å…¥ Traefikï¼Œä¸”è·¯ç”±è§„åˆ™åŒ¹é…æˆåŠŸåï¼Œå°†æµé‡å‘é€åˆ°å¯¹åº”çš„åç«¯æœåŠ¡å‰ï¼Œå…ˆå°†å…¶å‘ç»™ä¸­é—´ä»¶è¿›è¡Œä¸€ç³»åˆ—å¤„ç†ï¼ˆç±»ä¼¼äºè¿‡æ»¤å™¨é“¾ Filterï¼Œè¿›è¡Œä¸€ç³»åˆ—å¤„ç†ï¼‰ï¼Œä¾‹å¦‚ï¼Œæ·»åŠ  Header å¤´ä¿¡æ¯ã€é‰´æƒã€æµé‡è½¬å‘ã€å¤„ç†è®¿é—®è·¯å¾„å‰ç¼€ã€IP ç™½åå•ç­‰ç­‰ï¼Œç»è¿‡ä¸€ä¸ªæˆ–è€…å¤šä¸ªä¸­é—´ä»¶å¤„ç†å®Œæˆåï¼Œå†å‘é€ç»™åç«¯æœåŠ¡ï¼Œè¿™ä¸ªå°±æ˜¯ä¸­é—´ä»¶çš„ä½œç”¨ã€‚\nTraefik å†…ç½®äº†å¾ˆå¤šä¸åŒåŠŸèƒ½çš„ Middlewareï¼Œä¸»è¦æ˜¯é’ˆå¯¹ HTTP å’Œ TCPï¼Œè¿™é‡ŒæŒ‘é€‰å‡ ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„è¿›è¡Œæ¼”ç¤ºã€‚\n1.1 é‡å®šå‘ -redirectScheme å®˜æ–¹æ–‡æ¡£\nå®šä¹‰ä¸€ä¸ª ingressrouteï¼ŒåŒ…å«ä¸€ä¸ªè‡ªåŠ¨å°† http è·³è½¬åˆ° https çš„ä¸­é—´ä»¶\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: myapp2 spec: entryPoints: - web routes: - match: Host(`myapp2.test.com`) kind: Rule services: - name: myapp2 port: 80 middlewares: - name: redirect-https-middleware # æŒ‡å®šä½¿ç”¨RedirectSchemeä¸­é—´ä»¶ï¼Œå®Œæˆhttpå¼ºåˆ¶è·³è½¬è‡³https --- apiVersion: traefik.containo.us/v1alpha1 kind: Middleware metadata: name: redirect-https-middleware spec: redirectScheme: scheme: https # è‡ªåŠ¨è·³è½¬åˆ° https æµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ°è®¿é—® http è‡ªåŠ¨ 307 é‡å®šå‘åˆ°äº† https\n[root@k8s-node1 ~]# curl -I http://myapp2.test.com HTTP/1.1 307 Temporary Redirect Location: https://myapp2.test.com/ Date: Wed, 19 Apr 2023 07:58:34 GMT Content-Length: 18 Content-Type: text/plain; charset=utf-8 1.2 å»é™¤è¯·æ±‚è·¯å¾„å‰ç¼€ -stripPrefix å®˜æ–¹æ–‡æ¡£\nå‡è®¾ç°åœ¨æœ‰è¿™æ ·ä¸€ä¸ªéœ€æ±‚ï¼Œå½“è®¿é—® http://myapp.test.com/v1 æ—¶ï¼Œæµé‡è°ƒåº¦è‡³ myapp1ã€‚å½“è®¿é—® http://myapp.test.com/v2 æ—¶ï¼Œæµé‡è°ƒåº¦è‡³ myapp2ã€‚è¿™ç§éœ€æ±‚æ˜¯éå¸¸å¸¸è§çš„ï¼Œåœ¨ NGINX ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®å¤šä¸ª Location æ¥å®šåˆ¶è§„åˆ™ï¼Œä½¿ç”¨ Traefik ä¹Ÿå¯ä»¥è¿™ä¹ˆåšã€‚ä½†æ˜¯å®šåˆ¶ä¸åŒçš„å‰ç¼€åï¼Œç”±äºåº”ç”¨æœ¬èº«å¹¶æ²¡æœ‰è¿™äº›å‰ç¼€ï¼Œå¯¼è‡´è¯·æ±‚è¿”å› 404ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦å¯¹è¯·æ±‚çš„ path è¿›è¡Œå¤„ç†ã€‚\nåˆ›å»ºä¸€ä¸ª IngressRouteï¼Œå¹¶è®¾ç½®ä¸¤æ¡è§„åˆ™ï¼Œæ ¹æ®ä¸åŒçš„è®¿é—®è·¯å¾„ä»£ç†è‡³ç›¸å¯¹åº”çš„ service\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: myapp spec: entryPoints: - web routes: - match: Host(`myapp.test.com`) \u0026amp;\u0026amp; PathPrefix(`/v1`) kind: Rule services: - name: myapp1 port: 80 middlewares: - name: prefix-url-middleware - match: Host(`myapp.test.com`) \u0026amp;\u0026amp; PathPrefix(`/v2`) kind: Rule services: - name: myapp2 port: 80 middlewares: - name: prefix-url-middleware --- apiVersion: traefik.containo.us/v1alpha1 kind: Middleware metadata: name: prefix-url-middleware spec: stripPrefix: # å»é™¤å‰ç¼€çš„ä¸­é—´ä»¶ stripPrefixï¼ŒæŒ‡å®šå°†è¯·æ±‚è·¯å¾„ä¸­çš„v1ã€v2å»é™¤ã€‚ prefixes: - /v1 - /v2 éƒ¨ç½²æµ‹è¯•\n[root@k8s-node1 ~]# curl http://myapp.test.com/v1 Hello MyApp | Version: v1 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; [root@k8s-node1 ~]# curl http://myapp.test.com/v2 Hello MyApp | Version: v2 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; [root@k8s-node1 ~]# kubectl logs -l app=myapp1 | tail -2 # æœªæ·»åŠ æ’ä»¶çš„è®¿é—®è·¯å¾„ä¸º /v1/ 10.244.36.64 - - [19/Apr/2023:08:02:03 +0000] \u0026#34;GET /v1/ HTTP/1.1\u0026#34; 404 169 \u0026#34;-\u0026#34; \u0026#34;curl/7.29.0\u0026#34; \u0026#34;1.1.1.1\u0026#34; # æ·»åŠ æ’ä»¶åçš„è®¿é—®è·¯å¾„ä¸º / 10.244.36.64 - - [19/Apr/2023:08:04:31 +0000] \u0026#34;GET / HTTP/1.1\u0026#34; 200 65 \u0026#34;-\u0026#34; \u0026#34;curl/7.29.0\u0026#34; \u0026#34;1.1.1.1\u0026#34; 1.3 ç™½åå• -IPWhiteList å®˜æ–¹æ–‡æ¡£\nä¸ºæé«˜å®‰å…¨æ€§ï¼Œé€šå¸¸æƒ…å†µä¸‹ä¸€äº›ç®¡ç†å‘˜ç•Œé¢ä¼šè®¾ç½® ip è®¿é—®ç™½åå•ï¼Œåªå¸Œæœ›ä¸ªåˆ«ç”¨æˆ·å¯ä»¥è®¿é—®ã€‚\nç¤ºä¾‹\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: myapp spec: entryPoints: - web routes: - match: Host(`myapp1.test.com`) kind: Rule services: - name: myapp1 port: 80 middlewares: - name: ip-white-list-middleware --- apiVersion: traefik.containo.us/v1alpha1 kind: Middleware metadata: name: ip-white-list-middleware spec: ipWhiteList: sourceRange: - 127.0.0.1/32 - 1.1.1.253 æµ‹è¯•\n# ç™½åå•å¤–ä¸»æœº [root@k8s-node1 ~]# curl -I http://myapp1.test.com HTTP/1.1 403 Forbidden # ç™½åå•å†…ä¸»æœº Admin@BJLPT0152 MINGW64 ~ $ ipconfig | grep 1.1.1.253 IPv4 åœ°å€ . . . . . . . . . . . . : 1.1.1.253 Admin@BJLPT0152 MINGW64 ~ $ curl -i http://myapp1.test.com Hello MyApp | Version: v1 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; 1.4 åŸºç¡€ç”¨æˆ·è®¤è¯ -basicAuth å®˜æ–¹æ–‡æ¡£\né€šå¸¸ä¼ä¸šå®‰å…¨è¦æ±‚è§„èŒƒé™¤äº†è¦å¯¹ç®¡ç†å‘˜é¡µé¢é™åˆ¶è®¿é—® ip å¤–ï¼Œè¿˜éœ€è¦æ·»åŠ è´¦å·å¯†ç è®¤è¯ï¼Œè€Œ traefik é»˜è®¤æ²¡æœ‰æä¾›è´¦å·å¯†ç è®¤è¯åŠŸèƒ½ï¼Œæ­¤æ—¶å°±å¯ä»¥é€šè¿‡ BasicAuth ä¸­é—´ä»¶å®Œæˆç”¨æˆ·è®¤è¯ï¼Œåªæœ‰è®¤è¯é€šè¿‡çš„æˆæƒç”¨æˆ·æ‰å¯ä»¥è®¿é—®é¡µé¢ã€‚\nå®‰è£… htpasswd å·¥å…·ç”Ÿæˆå¯†ç æ–‡ä»¶\n[root@k8s-node1 ~]# yum install -y httpd [root@k8s-node1 ~]# htpasswd -bc basic-auth-secret-lvbibir lvbibir 123 Adding password for user lvbibir [root@k8s-node1 ~]# kubectl create secret generic basic-auth-lvbibir --from-file=basic-auth-secret-lvbibir secret/basic-auth-lvbibir created åˆ›å»º ingressrouteï¼Œä½¿ç”¨ basicAuth ä¸­é—´ä»¶\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: myapp spec: entryPoints: - web routes: - match: Host(`myapp1.test.com`) kind: Rule services: - name: myapp1 port: 80 middlewares: - name: basic-auth-middleware --- apiVersion: traefik.containo.us/v1alpha1 kind: Middleware metadata: name: basic-auth-middleware spec: basicAuth: secret: basic-auth-lvbibir è®¿é—®æµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ°å¼¹å‡ºç•Œé¢æç¤ºéœ€è¦è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œè¾“å…¥åå›è½¦æ˜¾ç¤ºæ­£å¸¸é¡µé¢\n1.5 ä¿®æ”¹è¯·æ±‚/å“åº”å¤´ä¿¡æ¯ -headers å®˜æ–¹æ–‡æ¡£\nä¸ºäº†æé«˜ä¸šåŠ¡çš„å®‰å…¨æ€§ï¼Œå®‰å…¨å›¢é˜Ÿä¼šå®šæœŸè¿›è¡Œæ¼æ´æ‰«æï¼Œå…¶ä¸­æœ‰äº› web æ¼æ´å°±éœ€è¦é€šè¿‡ä¿®æ”¹å“åº”å¤´å¤„ç†ï¼Œtraefik çš„ Headers ä¸­é—´ä»¶ä¸ä»…å¯ä»¥ä¿®æ”¹è¿”å›å®¢æˆ·ç«¯çš„å“åº”å¤´ä¿¡æ¯ï¼Œè¿˜èƒ½ä¿®æ”¹åå‘ä»£ç†åç«¯ service æœåŠ¡çš„è¯·æ±‚å¤´ä¿¡æ¯ã€‚\nä¾‹å¦‚å¯¹ https://myapp2.test.com æé«˜å®‰å…¨ç­–ç•¥ï¼Œå¼ºåˆ¶å¯ç”¨ HSTS\nHSTSï¼šå³ HTTP ä¸¥æ ¼ä¼ è¾“å®‰å…¨å“åº”å¤´ï¼Œæ”¶åˆ°è¯¥å“åº”å¤´çš„æµè§ˆå™¨ä¼šåœ¨ 63072000sï¼ˆçº¦ 2 å¹´ï¼‰çš„æ—¶é—´å†…ï¼Œåªè¦è®¿é—®è¯¥ç½‘ç«™ï¼Œå³ä½¿è¾“å…¥çš„æ˜¯ httpï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨è·³è½¬åˆ° httpsã€‚ï¼ˆHSTS æ˜¯æµè§ˆå™¨ç«¯çš„è·³è½¬ï¼Œä¹‹å‰çš„ HTTP é‡å®šå‘åˆ° HTTPS æ˜¯æœåŠ¡å™¨ç«¯çš„è·³è½¬ï¼‰\nåˆ›å»º ingressRoute å’Œ headers ä¸­é—´ä»¶\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: myapp2-tls spec: entryPoints: - web - websecure routes: - match: Host(`myapp2.test.com`) kind: Rule services: - name: myapp2 port: 80 middlewares: - name: hsts-header-middleware tls: secretName: myapp2-tls # æŒ‡å®štlsè¯ä¹¦åç§° --- apiVersion: traefik.containo.us/v1alpha1 kind: Middleware metadata: name: hsts-header-middleware spec: headers: customResponseHeaders: Strict-Transport-Security: \u0026#39;max-age=63072000\u0026#39; è®¿é—®æµ‹è¯•\n[root@k8s-node1 ~]# curl -kI https://myapp2.test.com HTTP/1.1 200 OK Accept-Ranges: bytes Content-Length: 65 Content-Type: text/html Date: Wed, 19 Apr 2023 08:37:07 GMT Etag: \u0026#34;5a9251f0-41\u0026#34; Last-Modified: Sun, 25 Feb 2018 06:04:32 GMT Server: nginx/1.12.2 Strict-Transport-Security: max-age=63072000 # headers æ’ä»¶æ·»åŠ çš„å“åº”å¤´ 1.6 é™æµ -rateLimit å®˜æ–¹æ–‡æ¡£\nåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæµé‡é™åˆ¶ä¹Ÿæ˜¯ç»å¸¸ç”¨åˆ°çš„ï¼Œå®ƒå¯ä»¥ç”¨ä½œå®‰å…¨ç›®çš„ï¼Œæ¯”å¦‚å¯ä»¥å‡æ…¢æš´åŠ›å¯†ç ç ´è§£çš„é€Ÿç‡ã€‚é€šè¿‡å°†ä¼ å…¥è¯·æ±‚çš„é€Ÿç‡é™åˆ¶ä¸ºçœŸå®ç”¨æˆ·çš„å…¸å‹å€¼ï¼Œå¹¶æ ‡è¯†ç›®æ ‡ URL åœ°å€ (é€šè¿‡æ—¥å¿—)ï¼Œè¿˜å¯ä»¥ç”¨æ¥æŠµå¾¡ DDOS æ”»å‡»ã€‚æ›´å¸¸è§çš„æƒ…å†µï¼Œè¯¥åŠŸèƒ½è¢«ç”¨æ¥ä¿æŠ¤ä¸‹æ¸¸åº”ç”¨æœåŠ¡å™¨ä¸è¢«åŒæ—¶å¤ªå¤šç”¨æˆ·è¯·æ±‚æ‰€å‹å®ã€‚\nåˆ›å»º ingressRoute å’Œ rateLimit ä¸­é—´ä»¶\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: myapp1 spec: entryPoints: - web routes: - match: Host(`myapp1.test.com`) kind: Rule services: - name: myapp1 port: 80 middlewares: - name: rate-limit-middleware --- apiVersion: traefik.containo.us/v1alpha1 kind: Middleware metadata: name: rate-limit-middleware spec: rateLimit: # æŒ‡å®š 1s å†…è¯·æ±‚æ•°å¹³å‡å€¼ä¸å¤§äº 10 ä¸ªï¼Œé«˜å³°æœ€å¤§å€¼ä¸å¤§äº 50 ä¸ªã€‚ burst: 10 average: 50 å‹åŠ›æµ‹è¯•ï¼Œä½¿ç”¨ ab å·¥å…·è¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œä¸€å…±è¯·æ±‚ 100 æ¬¡ï¼Œæ¯æ¬¡å¹¶å‘ 10ã€‚æµ‹è¯•ç»“æœå¤±è´¥çš„è¯·æ±‚ä¸º 72 æ¬¡ï¼Œæ€»è€—æ—¶ 0.409 ç§’\n[root@k8s-node1 ~]# ab -n 100 -c 10 \u0026#34;http://myapp1.test.com/\u0026#34; Concurrency Level: 10 Time taken for tests: 0.409 seconds Complete requests: 100 Failed requests: 72 (Connect: 0, Receive: 0, Length: 72, Exceptions: 0) Non-2xx responses: 72 1.7 ç†”æ–­ -circuitBreaker å®˜æ–¹æ–‡æ¡£\næœåŠ¡ç†”æ–­çš„ä½œç”¨ç±»ä¼¼äºä¿é™©ä¸ï¼Œå½“æŸæœåŠ¡å‡ºç°ä¸å¯ç”¨æˆ–å“åº”è¶…æ—¶çš„æƒ…å†µæ—¶ï¼Œä¸ºäº†é˜²æ­¢æ•´ä¸ªç³»ç»Ÿå‡ºç°é›ªå´©ï¼Œæš‚æ—¶åœæ­¢å¯¹è¯¥æœåŠ¡çš„è°ƒç”¨ã€‚\nç†”æ–­å™¨ä¸‰ç§çŠ¶æ€\nClosedï¼šå…³é—­çŠ¶æ€ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½æ­£å¸¸è®¿é—®ã€‚ Openï¼šæ‰“å¼€çŠ¶æ€ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼šè¢«é™çº§ã€‚traefik ä¼šå¯¹è¯·æ±‚æƒ…å†µè®¡æ•°ï¼Œå½“ä¸€å®šæ—¶é—´å†…å¤±è´¥è¯·æ±‚ç™¾åˆ†æ¯”è¾¾åˆ°é˜ˆå€¼ï¼Œåˆ™è§¦å‘ç†”æ–­ï¼Œæ–­è·¯å™¨ä¼šå®Œå…¨æ‰“å¼€ã€‚ Recoveringï¼šåŠå¼€æ¢å¤çŠ¶æ€ï¼Œopen çŠ¶æ€ä¸æ˜¯æ°¸ä¹…çš„ï¼Œæ‰“å¼€åä¼šè¿›å…¥ä¼‘çœ æ—¶é—´ã€‚éšåæ–­è·¯å™¨ä¼šè‡ªåŠ¨è¿›å…¥åŠå¼€çŠ¶æ€ã€‚æ­¤æ—¶ä¼šé‡Šæ”¾éƒ¨åˆ†è¯·æ±‚é€šè¿‡ï¼Œè‹¥è¿™äº›è¯·æ±‚éƒ½æ˜¯å¥åº·çš„ï¼Œåˆ™ä¼šå®Œå…¨å…³é—­æ–­è·¯å™¨ï¼Œå¦åˆ™ç»§ç»­ä¿æŒæ‰“å¼€ï¼Œå†æ¬¡è¿›è¡Œä¼‘çœ è®¡æ—¶ æœåŠ¡ç†”æ–­åŸç† (æ–­è·¯å™¨çš„åŸç†)\nç»Ÿè®¡ç”¨æˆ·åœ¨æŒ‡å®šçš„æ—¶é—´èŒƒå›´ï¼ˆé»˜è®¤ 10sï¼‰ä¹‹å†…çš„è¯·æ±‚æ€»æ•°è¾¾åˆ°æŒ‡å®šçš„æ•°é‡ä¹‹åï¼Œå¦‚æœä¸å¥åº·çš„è¯·æ±‚ (è¶…æ—¶ã€å¼‚å¸¸) å æ€»è¯·æ±‚æ•°é‡çš„ç™¾åˆ†æ¯”ï¼ˆ50%ï¼‰è¾¾åˆ°äº†æŒ‡å®šçš„é˜ˆå€¼ä¹‹åï¼Œå°±ä¼šè§¦å‘ç†”æ–­ã€‚è§¦å‘ç†”æ–­ï¼Œæ–­è·¯å™¨å°±ä¼šæ‰“å¼€ (open),æ­¤æ—¶æ‰€æœ‰è¯·æ±‚éƒ½ä¸èƒ½é€šè¿‡ã€‚åœ¨ 5s ä¹‹åï¼Œæ–­è·¯å™¨ä¼šæ¢å¤åˆ°åŠå¼€çŠ¶æ€ (half open)ï¼Œä¼šå…è®¸å°‘é‡è¯·æ±‚é€šè¿‡ï¼Œå¦‚æœè¿™äº›è¯·æ±‚éƒ½æ˜¯å¥åº·çš„ï¼Œé‚£ä¹ˆæ–­è·¯å™¨ä¼šå›åˆ°å…³é—­çŠ¶æ€ (close).å¦‚æœè¿™äº›è¯·æ±‚è¿˜æ˜¯å¤±è´¥çš„è¯·æ±‚,æ–­è·¯å™¨è¿˜æ˜¯æ¢å¤åˆ°æ‰“å¼€çš„çŠ¶æ€ (open).\ntraefik æ”¯æŒçš„è§¦å‘å™¨\nNetworkErrorRatioï¼šç½‘ç»œé”™è¯¯ç‡ ResponseCodeRatioï¼šçŠ¶æ€ä»£ç æ¯”ç‡ LatencyAtQuantileMSï¼šåˆ†ä½æ•°çš„å»¶è¿Ÿï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½ï¼‰ åˆ›å»º ingressRoute ï¼Œæ·»åŠ  circuitBreaker ä¸­é—´ä»¶ï¼ŒæŒ‡å®š 50% çš„è¯·æ±‚æ¯”ä¾‹å“åº”æ—¶é—´å¤§äº 1MS æ—¶ç†”æ–­ã€‚\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: myapp1 spec: entryPoints: - web routes: - match: Host(`myapp1.test.com`) kind: Rule services: - name: myapp1 port: 80 middlewares: - name: circuit-breaker-middleware --- apiVersion: traefik.containo.us/v1alpha1 kind: Middleware metadata: name: circuit-breaker-middleware spec: circuitBreaker: expression: LatencyAtQuantileMS(50.0) \u0026gt; 1 å‹åŠ›æµ‹è¯•ï¼Œä¸€å…±è¯·æ±‚ 1000 æ¬¡ï¼Œæ¯æ¬¡å¹¶å‘ 100 æ¬¡ã€‚è§¦å‘ç†”æ–­æœºåˆ¶ï¼Œæµ‹è¯•ç»“æœå¤±è´¥çš„è¯·æ±‚ä¸º 999 æ¬¡ï¼Œæ€»è€—æ—¶ 1.742 ç§’ã€‚\n[root@k8s-node1 traefik]# ab -n 1000 -c 100 \u0026#34;http://myapp1.test.com/\u0026#34; Concurrency Level: 100 Time taken for tests: 1.742 seconds Complete requests: 1000 Failed requests: 999 (Connect: 0, Receive: 0, Length: 2, Exceptions: 0) Write errors: 0 Non-2xx responses: 999 1.8 è‡ªå®šä¹‰é”™è¯¯é¡µ -errorPages å®˜æ–¹æ–‡æ¡£\nåœ¨å®é™…çš„ä¸šåŠ¡ä¸­ï¼Œè‚¯å®šä¼šå­˜åœ¨ 4XX 5XX ç›¸å…³çš„é”™è¯¯å¼‚å¸¸ï¼Œå¦‚æœæ¯ä¸ªåº”ç”¨éƒ½å¼€å‘ä¸€ä¸ªå•ç‹¬çš„é”™è¯¯é¡µï¼Œæ— ç–‘å¤§å¤§å¢åŠ äº†å¼€å‘æˆæœ¬ï¼Œtraefik åŒæ ·ä¹Ÿæ”¯æŒè‡ªå®šä¹‰é”™è¯¯é¡µï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé”™è¯¯é¡µé¢ä¸æ˜¯ç”± traefik å­˜å‚¨å¤„ç†ï¼Œè€Œæ˜¯é€šè¿‡å®šä¹‰ä¸­é—´ä»¶ï¼Œå°†é”™è¯¯çš„è¯·æ±‚é‡å®šå‘åˆ°å…¶ä»–çš„é¡µé¢ã€‚\né¦–å…ˆï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªåº”ç”¨ã€‚è¿™ä¸ª web åº”ç”¨çš„åŠŸèƒ½æ˜¯ï¼š\nå½“è¯·æ±‚ / æ—¶ï¼Œè¿”å›çŠ¶æ€ç ä¸º 200 å½“è¯·æ±‚ /400 æ—¶ï¼Œè¿”å› 400 çŠ¶æ€ç  å½“è¯·æ±‚ /500 æ—¶ï¼Œè¿”å› 500 çŠ¶æ€ç  åˆ›å»º deployment svc\napiVersion: apps/v1 kind: Deployment metadata: name: flask spec: selector: matchLabels: app: flask template: metadata: labels: app: flask spec: containers: - name: flask image: cuiliang0302/request-code:v2.0 imagePullPolicy: IfNotPresent resources: limits: memory: \u0026#34;128Mi\u0026#34; cpu: \u0026#34;500m\u0026#34; ports: - containerPort: 5000 --- apiVersion: v1 kind: Service metadata: name: flask spec: type: ClusterIP selector: app: flask ports: - port: 5000 targetPort: 5000 åˆ›å»º ingressRoute\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: flask spec: entryPoints: - web routes: - match: Host(`flask.test.com`) kind: Rule services: - name: flask port: 5000 è®¿é—®æµ‹è¯•ï¼Œæ¨¡æ‹Ÿ 400 500 é”™è¯¯\n[root@k8s-node1 ~]# curl -I http://flask.test.com HTTP/1.1 200 OK [root@k8s-node1 ~]# curl -I http://flask.test.com/400 HTTP/1.1 400 Bad Request [root@k8s-node1 ~]# curl -I http://flask.test.com/500 HTTP/1.1 500 Internal Server Error [root@k8s-node1 ~]# curl -I http://flask.test.com/404 HTTP/1.1 404 Not Found ç°åœ¨æå‡ºä¸€ä¸ªæ–°çš„éœ€æ±‚ï¼Œå½“æˆ‘è®¿é—® flask é¡¹ç›®æ—¶ï¼Œå¦‚æœé”™è¯¯ç ä¸º 400ï¼Œè¿”å› myapp1 çš„é¡µé¢ï¼Œå¦‚æœé”™è¯¯ç ä¸º 500ï¼Œè¿”å› myapp2 çš„é¡µé¢ (å‰ææ˜¯ myapp1 å’Œ myapp2 æœåŠ¡å·²åˆ›å»º)ã€‚\nåˆ›å»º errors ä¸­é—´ä»¶\napiVersion: traefik.containo.us/v1alpha1 kind: Middleware metadata: name: errors5 spec: errors: status: - \u0026#34;500-599\u0026#34; # query: /{status}.html # å¯ä»¥ä¸ºæ¯ä¸ªé¡µé¢å®šä¹‰ä¸€ä¸ªçŠ¶æ€ç ï¼Œä¹Ÿå¯ä»¥æŒ‡å®š5XXä½¿ç”¨ç»Ÿä¸€é¡µé¢è¿”å› query : / # æŒ‡å®šè¿”å›myapp2çš„è¯·æ±‚è·¯å¾„ service: name: myapp2 port: 80 --- apiVersion: traefik.containo.us/v1alpha1 kind: Middleware metadata: name: errors4 spec: errors: status: - \u0026#34;400-499\u0026#34; # query: /{status}.html # å¯ä»¥ä¸ºæ¯ä¸ªé¡µé¢å®šä¹‰ä¸€ä¸ªçŠ¶æ€ç ï¼Œä¹Ÿå¯ä»¥æŒ‡å®š5XXä½¿ç”¨ç»Ÿä¸€é¡µé¢è¿”å› query : / # æŒ‡å®šè¿”å›myapp1çš„è¯·æ±‚è·¯å¾„ service: name: myapp1 port: 80 ä¿®æ”¹ ingressRoute\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: flask spec: entryPoints: - web routes: - match: Host(`flask.test.com`) kind: Rule services: - name: flask port: 5000 middlewares: - name: errors4 - name: errors5 è®¿é—®æµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ° 400 é¡µé¢å’Œ 500 é¡µé¢å·²ç»æˆåŠŸé‡å®šå‘äº†\n[root@k8s-node1 ~]# curl http://flask.test.com/ \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; \u0026lt;title\u0026gt;flask\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;hello flask\u0026lt;/h1\u0026gt; \u0026lt;img src=\u0026#34;/static/photo.jpg\u0026#34; alt=\u0026#34;photo\u0026#34;\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; [root@k8s-node1 ~]# curl http://flask.test.com/400 Hello MyApp | Version: v1 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; [root@k8s-node1 ~]# curl http://flask.test.com/500 Hello MyApp | Version: v2 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; 1.9 æ•°æ®å‹ç¼© -compress å®˜æ–¹æ–‡æ¡£\næœ‰æ—¶å€™å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ä¼šä¼ è¾“æ¯”è¾ƒå¤§çš„æŠ¥æ–‡æ•°æ®ï¼Œè¿™æ—¶å€™å°±å ç”¨è¾ƒå¤§çš„ç½‘ç»œå¸¦å®½å’Œæ—¶é•¿ã€‚ä¸ºäº†èŠ‚çœå¸¦å®½ï¼ŒåŠ é€ŸæŠ¥æ–‡çš„å“åº”é€Ÿé€Ÿï¼Œå¯ä»¥å°†ä¼ è¾“çš„æŠ¥æ–‡æ•°æ®å…ˆè¿›è¡Œå‹ç¼©ï¼Œç„¶åå†è¿›è¡Œä¼ è¾“ï¼Œtraefik ä¹ŸåŒæ ·æ”¯æŒæ•°æ®å‹ç¼©ã€‚\ntraefik é»˜è®¤åªå¯¹å¤§äº 1024 å­—èŠ‚ï¼Œä¸”è¯·æ±‚æ ‡å¤´åŒ…å« Accept-Encoding gzip çš„èµ„æºè¿›è¡Œå‹ç¼©ã€‚å¯ä»¥æŒ‡å®šæ’é™¤ç‰¹å®šç±»å‹ä¸å¯ç”¨å‹ç¼©æˆ–è€…æ ¹æ®å†…å®¹å¤§å°æ¥å†³å®šæ˜¯å¦å‹ç¼©ã€‚\nç»§ç»­ä½¿ç”¨ä¸Šé¢åˆ›å»ºçš„ flask åº”ç”¨ï¼Œç°åœ¨åˆ›å»ºä¸­é—´ä»¶å¹¶ä¿®æ”¹ ingressRouteï¼Œä½¿ç”¨é»˜è®¤é…ç½®ç­–ç•¥å³å¯ã€‚\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: flask spec: entryPoints: - web routes: - match: Host(`flask.test.com`) kind: Rule services: - name: flask port: 5000 middlewares: - name: compress --- apiVersion: traefik.containo.us/v1alpha1 kind: Middleware metadata: name: compress spec: compress: {} è®¿é—®æµ‹è¯•\nhtml æ–‡ä»¶å°äº 1024 å­—èŠ‚ï¼Œæœªå¼€å¯å‹ç¼©\nå›¾ç‰‡èµ„æºå¤§äº 1024 å­—èŠ‚ï¼Œå¼€å¯äº†å‹ç¼©\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-traefik-3-middleware/","summary":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0ï¼Œ traefik-2.9.10 ç¤ºä¾‹ä¸­ç”¨åˆ°çš„ myapp å’Œ secret èµ„æºè¯·æŸ¥çœ‹ç³»åˆ—æ–‡ç« ç¬¬äºŒç¯‡ä¸­çš„æ¼”ç¤º 1 ç®€ä»‹ å®˜æ–¹æ–‡æ¡£ Traefik Middlewares æ˜¯ä¸€ä¸ªå¤„äºè·¯ç”±å’Œåç«¯æœåŠ¡ä¹‹å‰çš„ä¸­é—´ä»¶ï¼Œåœ¨å¤–éƒ¨æµé‡è¿›å…¥ Traefikï¼Œä¸”è·¯ç”±è§„åˆ™åŒ¹é…æˆåŠŸåï¼Œå°†æµé‡å‘é€åˆ°å¯¹åº”çš„","title":"traefik (ä¸‰) Middleware ä¸­é—´ä»¶"},{"content":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0ï¼Œ traefik-2.9.10\n1 ç®€ä»‹ å®˜æ–¹æ–‡æ¡£\n1.1 ä¸‰ç§æ–¹å¼ Traefik åˆ›å»ºè·¯ç”±è§„åˆ™æœ‰å¤šç§æ–¹å¼ï¼Œæ¯”å¦‚ï¼š\nåŸç”Ÿ Ingress å†™æ³• ä½¿ç”¨ CRD IngressRoute æ–¹å¼ ä½¿ç”¨ GatewayAPI çš„æ–¹å¼ ç›¸è¾ƒäºåŸç”Ÿ Ingress å†™æ³•ï¼ŒingressRoute æ˜¯ 2.1 ä»¥åæ–°å¢åŠŸèƒ½ï¼Œç®€å•æ¥è¯´ï¼Œä»–ä»¬éƒ½æ”¯æŒè·¯å¾„ (path) è·¯ç”±å’ŒåŸŸå (host) HTTP è·¯ç”±ï¼Œä»¥åŠ HTTPS é…ç½®ï¼ŒåŒºåˆ«åœ¨äº IngressRoute éœ€è¦å®šä¹‰ CRD æ‰©å±•ï¼Œä½†æ˜¯å®ƒæ”¯æŒäº† TCPã€UDP è·¯ç”±ä»¥åŠä¸­é—´ä»¶ç­‰æ–°ç‰¹æ€§ï¼Œå¼ºçƒˆæ¨èä½¿ç”¨ ingressRoute\n1.2 åŒ¹é…è§„åˆ™ è§„åˆ™ æè¿° Headers(key, value) æ£€æŸ¥ headers ä¸­æ˜¯å¦æœ‰ä¸€ä¸ªé”®ä¸º key å€¼ä¸º value çš„é”®å€¼å¯¹ HeadersRegexp(key, regexp) æ£€æŸ¥ headers ä¸­æ˜¯å¦æœ‰ä¸€ä¸ªé”®ä½ key å€¼ä¸ºæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…çš„é”®å€¼å¯¹ Host(example.com, â€¦) æ£€æŸ¥è¯·æ±‚çš„åŸŸåæ˜¯å¦åŒ…å«åœ¨ç‰¹å®šçš„åŸŸåä¸­ HostRegexp(example.com, {subdomain:[a-z]+}.example.com, â€¦) æ£€æŸ¥è¯·æ±‚çš„åŸŸåæ˜¯å¦åŒ…å«åœ¨ç‰¹å®šçš„æ­£åˆ™è¡¨è¾¾å¼åŸŸåä¸­ Method(GET, â€¦) æ£€æŸ¥è¯·æ±‚æ–¹æ³•æ˜¯å¦ä¸ºç»™å®šçš„ methods(GETã€POSTã€PUTã€DELETEã€PATCH) ä¸­ Path(/path, /articles/{cat:[a-z]+}/{id:[0-9]+}, â€¦) åŒ¹é…ç‰¹å®šçš„è¯·æ±‚è·¯å¾„ï¼Œå®ƒæ¥å—ä¸€ç³»åˆ—æ–‡å­—å’Œæ­£åˆ™è¡¨è¾¾å¼è·¯å¾„ PathPrefix(/products/, /articles/{cat:[a-z]+}/{id:[0-9]+}) åŒ¹é…ç‰¹å®šçš„å‰ç¼€è·¯å¾„ï¼Œå®ƒæ¥å—ä¸€ç³»åˆ—æ–‡å­—å’Œæ­£åˆ™è¡¨è¾¾å¼å‰ç¼€è·¯å¾„ Query(foo=bar, bar=baz) åŒ¹é…æŸ¥è¯¢å­—ç¬¦ä¸²å‚æ•°ï¼Œæ¥å— key=value çš„é”®å€¼å¯¹ ClientIP(10.0.0.0/16, ::1) å¦‚æœè¯·æ±‚å®¢æˆ·ç«¯ IP æ˜¯ç»™å®šçš„ IP/CIDR ä¹‹ä¸€ï¼Œåˆ™åŒ¹é…ã€‚å®ƒæ¥å— IPv4ã€IPv6 å’Œç½‘æ®µæ ¼å¼ã€‚ 2 dashboard æ¡ˆä¾‹ ä¹‹å‰çš„éƒ¨ç½²ç« èŠ‚ä¸­æˆ‘ä»¬æ˜¯ä»¥ nodePort å’Œ service nodePort çš„æ–¹å¼è®¿é—®çš„ traefik çš„ dashboardï¼Œæ¥ä¸‹æ¥ä»¥ä¸‰ç§æ–¹å¼æ¼”ç¤ºé€šè¿‡åŸŸåè®¿é—® dashboard\n2.1 ingress apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: traefik-dashboard namespace: traefik annotations: kubernetes.io/ingress.class: traefik traefik.ingress.kubernetes.io/router.entrypoints: web spec: rules: - host: ingress.test.com http: paths: - pathType: Prefix path: / backend: service: name: traefik port: number: 9000 è®¿é—®: http://ingress.test.com\n2.2 ingressRoute apiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: dashboard namespace: traefik spec: entryPoints: - web routes: - match: Host(`traefik.test.com`) kind: Rule services: - name: api@internal kind: TraefikService namespace: traefik è®¿é—®ï¼šhttp://traefik.test.com\n2.3 Gateway API ç›®å‰ï¼ŒTraefik å¯¹ Gateway APIs çš„å®ç°æ˜¯åŸºäº v1alpha1 ç‰ˆæœ¬çš„è§„èŒƒï¼Œç›®å‰æœ€æ–°çš„è§„èŒƒæ˜¯ v1alpha2ï¼Œæ‰€ä»¥å’Œæœ€æ–°çš„è§„èŒƒå¯èƒ½æœ‰ä¸€äº›å‡ºå…¥çš„åœ°æ–¹ã€‚\nåˆ›å»º gatewayClass\napiVersion: networking.x-k8s.io/v1alpha1 kind: GatewayClass metadata: name: traefik spec: controller: traefik.io/gateway-controller åˆ›å»º gateway\napiVersion: networking.x-k8s.io/v1alpha1 kind: Gateway metadata: name: http-gateway namespace: kube-system spec: gatewayClassName: traefik listeners: - protocol: HTTP port: 80 routes: kind: HTTPRoute namespaces: from: All selector: matchLabels: app: traefik åˆ›å»º httproute\napiVersion: networking.x-k8s.io/v1alpha1 kind: HTTPRoute metadata: name: traefik-dashboard namespace: kube-system labels: app: traefik spec: hostnames: - \u0026#34;gateway.test.com\u0026#34; rules: - matches: - path: type: Prefix value: / forwardTo: - serviceName: traefik port: 9000 weight: 1 è®¿é—®ï¼šhttp://gateway.test.com\n3 myapp ç¯å¢ƒå‡†å¤‡ myapp1\napiVersion: apps/v1 kind: Deployment metadata: name: myapp1 spec: selector: matchLabels: app: myapp1 template: metadata: labels: app: myapp1 spec: containers: - name: myapp1 image: ikubernetes/myapp:v1 resources: limits: memory: \u0026#34;128Mi\u0026#34; cpu: \u0026#34;500m\u0026#34; ports: - containerPort: 80 --- apiVersion: v1 kind: Service metadata: name: myapp1 spec: type: ClusterIP selector: app: myapp1 ports: - port: 80 targetPort: 80 myapp2\napiVersion: apps/v1 kind: Deployment metadata: name: myapp2 spec: selector: matchLabels: app: myapp2 template: metadata: labels: app: myapp2 spec: containers: - name: myapp2 image: ikubernetes/myapp:v2 resources: limits: memory: \u0026#34;128Mi\u0026#34; cpu: \u0026#34;500m\u0026#34; ports: - containerPort: 80 --- apiVersion: v1 kind: Service metadata: name: myapp2 spec: type: ClusterIP selector: app: myapp2 ports: - port: 80 targetPort: 80 åˆ›å»ºèµ„æºå¹¶è®¿é—®æµ‹è¯•\n[root@k8s-node1 ~]# vim demo/app/myapp1.yml [root@k8s-node1 ~]# vim demo/app/myapp2.yml [root@k8s-node1 ~]# kubectl apply -f demo/app/ deployment.apps/myapp1 created service/myapp1 created deployment.apps/myapp2 created service/myapp2 created [root@k8s-node1 ~]# kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.96.0.1 \u0026lt;none\u0026gt; 443/TCP 12d myapp1 ClusterIP 10.100.229.135 \u0026lt;none\u0026gt; 80/TCP 33s myapp2 ClusterIP 10.96.56.49 \u0026lt;none\u0026gt; 80/TCP 33s [root@k8s-node1 ~]# curl 10.100.229.135 Hello MyApp | Version: v1 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; [root@k8s-node1 ~]# curl 10.96.56.49 Hello MyApp | Version: v2 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; 4 ingressRoute 4.1 http è·¯ç”± å®ç°ç›®æ ‡ï¼šé›†ç¾¤å¤–éƒ¨ç”¨æˆ·é€šè¿‡è®¿é—® http://myapp1.test.com åŸŸåæ—¶ï¼Œå°†è¯·æ±‚ä»£ç†è‡³ myapp1 åº”ç”¨ã€‚\nåˆ›å»º ingressRoute\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: myapp1 spec: entryPoints: - web # ä¸ configmap ä¸­å®šä¹‰çš„ entrypoint åå­—ç›¸åŒ routes: - match: Host(`myapp1.test.com`) # åŸŸå kind: Rule services: - name: myapp1 # ä¸svcçš„nameä¸€è‡´ port: 80 # ä¸svcçš„portä¸€è‡´ éƒ¨ç½²\n[root@k8s-node1 ~]# vim demo/ingressroute/http-myapp1.yml [root@k8s-node1 ~]# kubectl apply -f demo/ingressroute/http-myapp1.yml ingressroute.traefik.containo.us/myapp1 created è®¿é—®æµ‹è¯•\n4.2 https è·¯ç”± è‡ªç­¾åè¯ä¹¦\nopenssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj \u0026#34;/CN=myapp2.test.com\u0026#34; åˆ›å»º tls ç±»å‹çš„ secret\nkubectl create secret tls myapp2-tls --cert=tls.crt --key=tls.key åˆ›å»º ingressRoute\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: myapp2 spec: entryPoints: - websecure # ç›‘å¬ websecure è¿™ä¸ªå…¥å£ç‚¹ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡ 443 ç«¯å£æ¥è®¿é—® routes: - match: Host(`myapp2.test.com`) kind: Rule services: - name: myapp2 port: 80 tls: secretName: myapp2-tls # æŒ‡å®štlsè¯ä¹¦åç§° éƒ¨ç½²\n[root@k8s-node1 ~]# vim demo/ingressroute/https-myapp2.yml [root@k8s-node1 ~]# kubectl apply -f demo/ingressroute/https-myapp2.yml ingressroute.traefik.containo.us/myapp2 created è®¿é—®æµ‹è¯•ï¼Œç”±äºæ˜¯è‡ªç­¾åè¯ä¹¦ï¼Œæ‰€ä»¥ä¼šæç¤ºä¸å®‰å…¨\n5 ingressRouteTCP ingreeRouteTCP å®˜æ–¹æ–‡æ¡£\n5.1 ä¸å¸¦ TLS è¯ä¹¦ éƒ¨ç½² mysql\napiVersion: v1 kind: ConfigMap metadata: name: mysql labels: app: mysql namespace: default data: my.cnf: | [mysqld] character-set-server = utf8mb4 collation-server = utf8mb4_unicode_ci skip-character-set-client-handshake = 1 default-storage-engine = INNODB max_allowed_packet = 500M explicit_defaults_for_timestamp = 1 long_query_time = 10 --- apiVersion: apps/v1 kind: Deployment metadata: labels: app: mysql name: mysql spec: selector: matchLabels: app: mysql template: metadata: labels: app: mysql spec: containers: - name: mysql image: mysql:5.7 imagePullPolicy: IfNotPresent env: - name: MYSQL_ROOT_PASSWORD value: abc123 ports: - containerPort: 3306 volumeMounts: - mountPath: /etc/mysql/conf.d/my.cnf subPath: my.cnf name: cm volumes: - name: cm configMap: name: mysql --- apiVersion: v1 kind: Service metadata: name: mysql namespace: default spec: ports: - port: 3306 protocol: TCP targetPort: 3306 selector: app: mysql ingressRouteTCP\nSNI ä¸ºæœåŠ¡åç§°æ ‡è¯†ï¼Œæ˜¯ TLS åè®®çš„æ‰©å±•ã€‚å› æ­¤ï¼Œåªæœ‰ TLS è·¯ç”±æ‰èƒ½ä½¿ç”¨è¯¥è§„åˆ™æŒ‡å®šåŸŸåã€‚é TLS è·¯ç”±ä½¿ç”¨å¸¦æœ‰ * çš„è§„åˆ™æ¥å£°æ˜æ¯ä¸ªé TLS è¯·æ±‚éƒ½å°†ç”±è·¯ç”±è¿›è¡Œå¤„ç†ã€‚\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRouteTCP metadata: name: mysql namespace: default spec: entryPoints: - tcpep # 9200 ç«¯å£ routes: - match: HostSNI(`*`) # ç”±äº Traefik ä¸­ä½¿ç”¨ TCP è·¯ç”±é…ç½®éœ€è¦ SNIï¼Œè€Œ SNI åˆæ˜¯ä¾èµ– TLS çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é…ç½®è¯ä¹¦æ‰è¡Œï¼Œå¦‚æœæ²¡æœ‰è¯ä¹¦çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é€šé…ç¬¦*(é€‚é…ip)è¿›è¡Œé…ç½® services: - name: mysql port: 3306 éƒ¨ç½²\n[root@k8s-node1 ~]# vim demo/ingressrouteTCP/mysql.yml [root@k8s-node1 ~]# kubectl apply -f demo/ingressrouteTCP/mysql.yml configmap/mysql created deployment.apps/mysql created service/mysql created [root@k8s-node1 ~]# vim demo/ingressrouteTCP/route.yml [root@k8s-node1 ~]# kubectl apply -f demo/ingressrouteTCP/route.yml ingressroutetcp.traefik.containo.us/mysql created é›†ç¾¤å¤–ä¸»æœºéªŒè¯\næ·»åŠ  hosts (mysql.test.com) ä»¥ root \u0026amp; abc123 è®¿é—® 9200 ç«¯å£ 5.2 å¸¦ TLS è¯ä¹¦ å¤§å¤šæ•°æƒ…å†µä¸‹ tcp è·¯ç”±ä¸éœ€è¦é…ç½® TLS ï¼Œä¸‹é¢ä»…æ¼”ç¤ºä¸¤ä¸ªå…³é”®æ­¥éª¤\nåˆ›å»º tls ç±»å‹çš„ secret\nkubectl create secret tls redis-tls --key=redis.key --cert=redis.crt åˆ›å»º ingressRouteTCPï¼Œéœ€è¦æºå¸¦ secret\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRouteTCP metadata: name: redis spec: entryPoints: - redisep routes: - match: HostSNI(`redis.test.com`) services: - name: redis port: 6379 tls: secretName: redis-tls 6 ingressRouteUDP åˆ›å»ºåº”ç”¨\nkind: Deployment apiVersion: apps/v1 metadata: name: whoamiudp labels: app: whoamiudp spec: replicas: 2 selector: matchLabels: app: whoamiudp template: metadata: labels: app: whoamiudp spec: containers: - name: whoamiudp image: traefik/whoamiudp:latest ports: - containerPort: 8080 --- apiVersion: v1 kind: Service metadata: name: whoamiudp spec: ports: - port: 8080 protocol: UDP selector: app: whoamiudp é…ç½® ingressRouteUDP\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRouteUDP metadata: name: whoamiudp spec: entryPoints: - udpep routes: - services: - name: whoamiudp port: 8080 ç›´æ¥è®¿é—® svc éªŒè¯\n[root@k8s-node1 traefik]# kubectl get svc whoamiudp NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE whoamiudp ClusterIP 10.96.119.116 \u0026lt;none\u0026gt; 8080/UDP 2m22s [root@k8s-node1 traefik]# echo \u0026#34;WHO\u0026#34; | socat - udp4-datagram:10.96.119.116:8080 Hostname: whoamiudp-6ff7dd6fb9-8qfc7 IP: 127.0.0.1 IP: 10.244.169.174 [root@k8s-node1 traefik]# echo \u0026#34;test\u0026#34; | socat - udp4-datagram:10.96.119.116:8080 Received: test è®¿é—® udp è·¯ç”±éªŒè¯\n[root@k8s-node1 traefik]# echo \u0026#34;WHO\u0026#34; | socat - udp4-datagram:k8s-node1:9300 Hostname: whoamiudp-6ff7dd6fb9-5l8rd IP: 127.0.0.1 IP: 10.244.107.243 [root@k8s-node1 traefik]# echo \u0026#34;test\u0026#34; | socat - udp4-datagram:1.1.1.1:9300 Received: test 7 è´Ÿè½½å‡è¡¡ apiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: myapp1 spec: entryPoints: - web # ä¸ configmap ä¸­å®šä¹‰çš„ entrypoint åå­—ç›¸åŒ routes: - match: Host(`lb.test.com`) # åŸŸå kind: Rule services: - name: myapp1 # ä¸svcçš„nameä¸€è‡´ port: 80 # ä¸svcçš„portä¸€è‡´ - name: myapp2 # ä¸svcçš„nameä¸€è‡´ port: 80 # ä¸svcçš„portä¸€è‡´ éƒ¨ç½²\n[root@k8s-node1 ~]# vim demo/lb/lb.yml [root@k8s-node1 ~]# kubectl apply -f demo/lb/lb.yml ingressroute.traefik.containo.us/myapp1 created è®¿é—®æµ‹è¯•ï¼Œå¯ä»¥å‘ç°å¾ªç¯ç›¸åº” myapp1 å’Œ myapp2 çš„å†…å®¹\n[root@k8s-node1 ~]# curl http://lb.test.com Hello MyApp | Version: v1 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; [root@k8s-node1 ~]# curl http://lb.test.com Hello MyApp | Version: v2 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; [root@k8s-node1 ~]# curl http://lb.test.com Hello MyApp | Version: v1 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; [root@k8s-node1 ~]# curl http://lb.test.com Hello MyApp | Version: v2 | \u0026lt;a href=\u0026#34;hostname.html\u0026#34;\u0026gt;Pod Name\u0026lt;/a\u0026gt; ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-traefik-2-router/","summary":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0ï¼Œ traefik-2.9.10 1 ç®€ä»‹ å®˜æ–¹æ–‡æ¡£ 1.1 ä¸‰ç§æ–¹å¼ Traefik åˆ›å»ºè·¯ç”±è§„åˆ™æœ‰å¤šç§æ–¹å¼ï¼Œæ¯”å¦‚ï¼š åŸç”Ÿ Ingress å†™æ³• ä½¿ç”¨ CRD IngressRoute æ–¹å¼ ä½¿ç”¨ GatewayAPI çš„æ–¹å¼ ç›¸è¾ƒäºåŸç”Ÿ Ingress å†™æ³•ï¼ŒingressRoute æ˜¯ 2.1 ä»¥åæ–°å¢åŠŸèƒ½ï¼Œç®€å•æ¥è¯´ï¼Œä»–ä»¬éƒ½æ”¯æŒè·¯å¾„ (path)","title":"traefik (äºŒ) ingressRoute è·¯ç”±"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\nhttps://www.cuiliangblog.cn/detail/section/29427812 åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0ï¼Œ traefik-2.9.10\n1 ç®€ä»‹ 1.1 Traefik ç®€ä»‹ Traefik æ˜¯ä¸€ä¸ªä¸ºäº†è®©éƒ¨ç½²å¾®æœåŠ¡æ›´åŠ ä¾¿æ·è€Œè¯ç”Ÿçš„ç°ä»£ HTTP åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡å·¥å…·ã€‚ å®ƒæ”¯æŒå¤šç§åå° (Docker, Swarm, Kubernetes, Marathon, Mesos, Consul, Etcd, Zookeeper, BoltDB, Rest API, fileâ€¦) æ¥è‡ªåŠ¨åŒ–ã€åŠ¨æ€çš„åº”ç”¨å®ƒçš„é…ç½®æ–‡ä»¶è®¾ç½®ã€‚\nå®ƒæ˜¯ä¸€ä¸ªè¾¹ç¼˜è·¯ç”±å™¨ï¼Œå®ƒä¼šæ‹¦æˆªå¤–éƒ¨çš„è¯·æ±‚å¹¶æ ¹æ®é€»è¾‘è§„åˆ™é€‰æ‹©ä¸åŒçš„æ“ä½œæ–¹å¼ï¼Œè¿™äº›è§„åˆ™å†³å®šç€è¿™äº›è¯·æ±‚åˆ°åº•è¯¥å¦‚ä½•å¤„ç†ã€‚Traefik æä¾›è‡ªåŠ¨å‘ç°èƒ½åŠ›ï¼Œä¼šå®æ—¶æ£€æµ‹æœåŠ¡ï¼Œå¹¶è‡ªåŠ¨æ›´æ–°è·¯ç”±è§„åˆ™ã€‚\n1.2 Traefik æ ¸å¿ƒç»„ä»¶ ä»ä¸Šå›¾å¯çŸ¥ï¼Œå½“è¯·æ±‚ Traefik æ—¶ï¼Œè¯·æ±‚é¦–å…ˆåˆ° entrypointsï¼Œç„¶ååˆ†æä¼ å…¥çš„è¯·æ±‚ï¼ŒæŸ¥çœ‹ä»–ä»¬æ˜¯å¦ä¸å®šä¹‰çš„ Routers åŒ¹é…ã€‚å¦‚æœåŒ¹é…ï¼Œåˆ™ä¼šé€šè¿‡ä¸€ç³»åˆ— middlewares å¤„ç†ï¼Œå†åˆ° traefikServices ä¸Šåšæµé‡è½¬å‘ï¼Œæœ€åè¯·æ±‚åˆ° kubernetesçš„servicesä¸Š ã€‚\nè¿™å°±æ¶‰åŠåˆ°ä»¥ä¸‹å‡ ä¸ªé‡è¦çš„æ ¸å¿ƒç»„ä»¶:\nProviders æ˜¯åŸºç¡€ç»„ä»¶ï¼ŒTraefik çš„é…ç½®å‘ç°æ˜¯é€šè¿‡å®ƒæ¥å®ç°çš„ï¼Œå®ƒå¯ä»¥æ˜¯åè°ƒå™¨ï¼Œå®¹å™¨å¼•æ“ï¼Œäº‘æä¾›å•†æˆ–è€…é”®å€¼å­˜å‚¨ã€‚Traefik é€šè¿‡æŸ¥è¯¢ Providers çš„ API æ¥æŸ¥è¯¢è·¯ç”±çš„ç›¸å…³ä¿¡æ¯ï¼Œä¸€æ—¦æ£€æµ‹åˆ°å˜åŒ–ï¼Œå°±ä¼šåŠ¨æ€çš„æ›´æ–°è·¯ç”±ã€‚ Entrypoints æ˜¯ Traefik çš„ç½‘ç»œå…¥å£ï¼Œå®ƒå®šä¹‰æ¥æ”¶è¯·æ±‚çš„æ¥å£ï¼Œä»¥åŠæ˜¯å¦ç›‘å¬ TCP æˆ–è€… UDPã€‚ Routers ä¸»è¦ç”¨äºåˆ†æè¯·æ±‚ï¼Œå¹¶è´Ÿè´£å°†è¿™äº›è¯·æ±‚è¿æ¥åˆ°å¯¹åº”çš„æœåŠ¡ä¸Šå»ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒRouters è¿˜å¯ä»¥ä½¿ç”¨ Middlewares æ¥æ›´æ–°è¯·æ±‚ï¼Œæ¯”å¦‚åœ¨æŠŠè¯·æ±‚å‘åˆ°æœåŠ¡ä¹‹å‰æ·»åŠ ä¸€äº› Headersã€‚ Services è´Ÿè´£é…ç½®å¦‚ä½•åˆ°è¾¾æœ€ç»ˆå°†å¤„ç†ä¼ å…¥è¯·æ±‚çš„å®é™…æœåŠ¡ã€‚ Middlewares ç”¨æ¥ä¿®æ”¹è¯·æ±‚æˆ–è€…æ ¹æ®è¯·æ±‚æ¥åšå‡ºä¸€äº›åˆ¤æ–­ï¼ˆauthentication, rate limiting, headers, â€¦ï¼‰ï¼Œä¸­é—´ä»¶è¢«é™„ä»¶åˆ°è·¯ç”±ä¸Šï¼Œæ˜¯ä¸€ç§åœ¨è¯·æ±‚å‘é€åˆ°ä½ çš„æœåŠ¡ä¹‹å‰ï¼ˆæˆ–è€…åœ¨æœåŠ¡çš„å“åº”å‘é€åˆ°å®¢æˆ·ç«¯ä¹‹å‰ï¼‰è°ƒæ•´è¯·æ±‚çš„ä¸€ç§æ–¹æ³•ã€‚ 1.3 Traefik CRD èµ„æº å®˜æ–¹æ–‡æ¡£\ntraefik é€šè¿‡è‡ªå®šä¹‰èµ„æºå®ç°äº†å¯¹ traefik èµ„æºçš„åˆ›å»ºå’Œç®¡ç†ï¼Œæ”¯æŒçš„ crd èµ„æºç±»å‹å¦‚ä¸‹æ‰€ç¤ºï¼š\nkind åŠŸèƒ½ IngressRoute HTTP è·¯ç”±é…ç½® Middleware HTTP ä¸­é—´ä»¶é…ç½® TraefikService HTTP è´Ÿè½½å‡è¡¡/æµé‡å¤åˆ¶é…ç½® IngressRouteTCP TCP è·¯ç”±é…ç½® MiddlewareTCP TCP ä¸­é—´ä»¶é…ç½® IngressRouteUDP UDP è·¯ç”±é…ç½® TLSOptions TLS è¿æ¥å‚æ•°é…ç½® TLSStores TLS å­˜å‚¨é…ç½® ServersTransport traefik ä¸åç«¯ä¹‹é—´çš„ä¼ è¾“é…ç½® 2 Traefik éƒ¨ç½² traefik æ˜¯æ”¯æŒ helm éƒ¨ç½²çš„ï¼Œä½†æ˜¯æŸ¥çœ‹ helm åŒ…çš„ value.yaml é…ç½®å‘ç°æ€»å…±æœ‰ 500 å¤šè¡Œé…ç½®ï¼Œå½“éœ€è¦ä¿®æ”¹é…ç½®é¡¹æˆ–è€…å¯¹ traefik åšä¸€ä¸‹è‡ªå®šä¹‰é…ç½®æ—¶ï¼Œå¹¶ä¸çµæ´»ã€‚å¦‚æœåªæ˜¯ä½¿ç”¨ traefik çš„åŸºç¡€åŠŸèƒ½ï¼Œæ¨èä½¿ç”¨ helm éƒ¨ç½²ã€‚å¦‚æœæƒ³æ·±å…¥ç ”ç©¶ä½¿ç”¨ traefik çš„è¯ï¼Œæ¨èä½¿ç”¨è‡ªå®šä¹‰æ–¹å¼éƒ¨ç½²ã€‚\n2.1 crd rbac serviceaccount crd\n[root@k8s-node1 ~]# mkdir /opt/traefik [root@k8s-node1 ~]# cd /opt/traefik [root@k8s-node1 traefik]# wget https://raw.githubusercontent.com/traefik/traefik/v2.9/docs/content/reference/dynamic-configuration/kubernetes-crd-definition-v1.yml [root@k8s-node1 traefik]# kubectl apply -f kubernetes-crd-definition-v1.yml rbac\n[root@k8s-node1 traefik]# wget https://raw.githubusercontent.com/traefik/traefik/v2.9/docs/content/reference/dynamic-configuration/kubernetes-crd-rbac.yml [root@k8s-node1 traefik]# kubectl apply -f kubernetes-crd-rbac.yml clusterrole.rbac.authorization.k8s.io/traefik-ingress-controller created clusterrolebinding.rbac.authorization.k8s.io/traefik-ingress-controller created serviceaccount.yml\napiVersion: v1 kind: Namespace metadata: name: traefik --- apiVersion: v1 kind: ServiceAccount metadata: namespace: traefik name: traefik-ingress-controller --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: traefik-ingress-controller roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: traefik-ingress-controller subjects: - kind: ServiceAccount name: traefik-ingress-controller namespace: traefik 2.2 configmap åœ¨ Traefik ä¸­æœ‰ä¸‰ç§æ–¹å¼å®šä¹‰é™æ€é…ç½®ï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­ã€åœ¨å‘½ä»¤è¡Œå‚æ•°ä¸­ã€é€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’ï¼Œç”±äº Traefik é…ç½®å¾ˆå¤šï¼Œé€šè¿‡ CLI å®šä¹‰ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œä¸€èˆ¬æ—¶å€™é€‰æ‹©å°†å…¶é…ç½®é€‰é¡¹æ”¾åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼Œç„¶åå­˜å…¥ ConfigMapï¼Œå°†å…¶æŒ‚å…¥ traefik ä¸­ã€‚\nconfigmap.yml æ–‡ä»¶å†…å®¹ï¼š\napiVersion: v1 kind: ConfigMap metadata: name: traefik-config namespace: traefik data: traefik.yaml: |- global: checkNewVersion: false # å‘¨æœŸæ€§çš„æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬å‘å¸ƒ sendAnonymousUsage: false # å‘¨æœŸæ€§çš„åŒ¿åå‘é€ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯ serversTransport: insecureSkipVerify: true # Traefikå¿½ç•¥éªŒè¯ä»£ç†æœåŠ¡çš„TLSè¯ä¹¦ api: insecure: true # å…è®¸HTTP æ–¹å¼è®¿é—®API dashboard: true # å¯ç”¨Dashboard debug: false # å¯ç”¨Debugè°ƒè¯•æ¨¡å¼ metrics: prometheus: # é…ç½®Prometheusç›‘æ§æŒ‡æ ‡æ•°æ®ï¼Œå¹¶ä½¿ç”¨é»˜è®¤é…ç½® addRoutersLabels: true # æ·»åŠ routers metrics entryPoint: \u0026#34;metrics\u0026#34; # æŒ‡å®šmetricsç›‘å¬åœ°å€ entryPoints: web: address: \u0026#34;:80\u0026#34; # é…ç½®80ç«¯å£ï¼Œå¹¶è®¾ç½®å…¥å£åç§°ä¸º web forwardedHeaders: insecure: true # ä¿¡ä»»æ‰€æœ‰çš„forward headers websecure: address: \u0026#34;:443\u0026#34; # é…ç½®443ç«¯å£ï¼Œå¹¶è®¾ç½®å…¥å£åç§°ä¸º websecure forwardedHeaders: insecure: true traefik: address: \u0026#34;:9000\u0026#34; # é…ç½®9000ç«¯å£ä¸º dashboard çš„ç«¯å£ï¼Œä¸è®¾ç½®é»˜è®¤å€¼ä¸º 8080 metrics: address: \u0026#34;:9100\u0026#34; # é…ç½®9100ç«¯å£ï¼Œä½œä¸ºmetricsæ”¶é›†å…¥å£ tcpep: address: \u0026#34;:9200\u0026#34; # é…ç½®9200ç«¯å£ï¼Œä½œä¸ºtcpå…¥å£ udpep: address: \u0026#34;:9300/udp\u0026#34; # é…ç½®9300ç«¯å£ï¼Œä½œä¸ºudpå…¥å£ providers: kubernetesIngress: \u0026#34;\u0026#34; # å¯ç”¨ Kubernetes Ingress æ–¹å¼æ¥é…ç½®è·¯ç”±è§„åˆ™ kubernetesGateway: \u0026#34;\u0026#34; # å¯ç”¨ Kubernetes Gateway API kubernetesCRD: # å¯ç”¨Kubernetes CRDæ–¹å¼æ¥é…ç½®è·¯ç”±è§„åˆ™ ingressClass: \u0026#34;\u0026#34; # æŒ‡å®štraefikçš„ingressClassåç§° allowCrossNamespace: true #å…è®¸è·¨namespace allowEmptyServices: true #å…è®¸ç©ºendpointsçš„service log: filePath: \u0026#34;/etc/traefik/logs/traefik.log\u0026#34; # è®¾ç½®è°ƒè¯•æ—¥å¿—æ–‡ä»¶å­˜å‚¨è·¯å¾„ï¼Œå¦‚æœä¸ºç©ºåˆ™è¾“å‡ºåˆ°æ§åˆ¶å° level: \u0026#34;DEBUG\u0026#34; # è®¾ç½®è°ƒè¯•æ—¥å¿—çº§åˆ« format: \u0026#34;json\u0026#34; # è®¾ç½®è°ƒè¯•æ—¥å¿—æ ¼å¼ accessLog: filePath: \u0026#34;/etc/traefik/logs/access.log\u0026#34; # è®¾ç½®è®¿é—®æ—¥å¿—æ–‡ä»¶å­˜å‚¨è·¯å¾„ï¼Œå¦‚æœä¸ºç©ºåˆ™è¾“å‡ºåˆ° stdout å’Œ stderr format: \u0026#34;json\u0026#34; # è®¾ç½®è®¿é—®è°ƒè¯•æ—¥å¿—æ ¼å¼ bufferingSize: 0 # è®¾ç½®è®¿é—®æ—¥å¿—ç¼“å­˜è¡Œæ•° fields: # è®¾ç½®è®¿é—®æ—¥å¿—ä¸­çš„å­—æ®µæ˜¯å¦ä¿ç•™ï¼ˆkeepä¿ç•™ã€dropä¸ä¿ç•™ï¼‰ defaultMode: keep # è®¾ç½®é»˜è®¤ä¿ç•™è®¿é—®æ—¥å¿—å­—æ®µ names: # é’ˆå¯¹è®¿é—®æ—¥å¿—ç‰¹åˆ«å­—æ®µç‰¹åˆ«é…ç½®ä¿ç•™æ¨¡å¼ ClientUsername: drop StartUTC: drop # ç¦ç”¨æ—¥å¿—timestampä½¿ç”¨UTC headers: # è®¾ç½®Headerä¸­å­—æ®µæ˜¯å¦ä¿ç•™ defaultMode: keep # è®¾ç½®é»˜è®¤ä¿ç•™Headerä¸­å­—æ®µ names: # é’ˆå¯¹Headerä¸­ç‰¹åˆ«å­—æ®µç‰¹åˆ«é…ç½®ä¿ç•™æ¨¡å¼ # User-Agent: redact# å¯ä»¥é’ˆå¯¹æŒ‡å®šagent Authorization: drop Content-Type: keep è®¾ç½®èŠ‚ç‚¹ labelï¼Œç”¨äºæ§åˆ¶åœ¨å“ªäº›èŠ‚ç‚¹éƒ¨ç½² Traefikï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ k8s-node1(master) èŠ‚ç‚¹ä½œä¸ºè¾¹ç¼˜èŠ‚ç‚¹éƒ¨ç½²\nkubectl label node k8s-node1 IngressProxy=true 2.3 deployment service ä½¿ç”¨ DeamonSet æˆ–è€… Deployment å‡å¯ï¼Œæ­¤å¤„ä½¿ç”¨ Deployment æ–¹å¼éƒ¨ç½² Traefikï¼Œè°ƒåº¦è‡³å«æœ‰ IngressProxy=true çš„è¾¹ç¼˜èŠ‚ç‚¹\nåŒæ—¶ä½¿ç”¨ podAntiAffinity é¿å…å¤šä¸ª traefik å®ä¾‹è¿è¡Œåœ¨åŒä¸€èŠ‚ç‚¹é€ æˆå•ç‚¹æ•…éšœ.\nkubectl apply -f deployment.yml\napiVersion: apps/v1 kind: Deployment metadata: name: traefik namespace: traefik labels: app: traefik spec: replicas: 1 selector: matchLabels: app: traefik template: metadata: name: traefik labels: app: traefik spec: affinity: podAntiAffinity: requiredDuringSchedulingIgnoredDuringExecution: - labelSelector: matchExpressions: - key: app operator: In values: - traefik topologyKey: \u0026#34;kubernetes.io/hostname\u0026#34; spec: serviceAccountName: traefik-ingress-controller terminationGracePeriodSeconds: 5 # ç­‰å¾…å®¹å™¨ä¼˜é›…é€€å‡ºçš„æ—¶é•¿ tolerations: # è®¾ç½®å®¹å¿æ‰€æœ‰æ±¡ç‚¹ï¼Œé˜²æ­¢èŠ‚ç‚¹è¢«è®¾ç½®æ±¡ç‚¹ - operator: \u0026#34;Exists\u0026#34; nodeSelector: # è®¾ç½®nodeç­›é€‰å™¨ï¼Œåœ¨ç‰¹å®šlabelçš„èŠ‚ç‚¹ä¸Šå¯åŠ¨ IngressProxy: \u0026#34;true\u0026#34; # è°ƒåº¦è‡³IngressProxy: \u0026#34;true\u0026#34;çš„èŠ‚ç‚¹ containers: - name: traefik image: traefik:v2.9 env: - name: KUBERNETES_SERVICE_HOST # æ‰‹åŠ¨æŒ‡å®šk8s api,é¿å…ç½‘ç»œç»„ä»¶ä¸ç¨³å®šã€‚ value: \u0026#34;1.1.1.1\u0026#34; - name: KUBERNETES_SERVICE_PORT_HTTPS # API serverç«¯å£ value: \u0026#34;6443\u0026#34; - name: KUBERNETES_SERVICE_PORT # API serverç«¯å£ value: \u0026#34;6443\u0026#34; - name: TZ # æŒ‡å®šæ—¶åŒº value: \u0026#34;Asia/Shanghai\u0026#34; ports: - name: web containerPort: 80 - name: websecure containerPort: 443 - name: dashboard containerPort: 9000 # Traefik Dashboard ç«¯å£ - name: metrics containerPort: 9100 - name: tcpep containerPort: 9200 # tcpç«¯å£ - name: udpep containerPort: 9300 # udpç«¯å£ securityContext: # åªå¼€æ”¾ç½‘ç»œæƒé™ capabilities: drop: - ALL add: - NET_BIND_SERVICE args: - --configfile=/etc/traefik/config/traefik.yaml volumeMounts: - mountPath: /etc/traefik/config name: config - mountPath: /etc/traefik/logs name: logdir - mountPath: /etc/localtime name: timezone readOnly: true resources: requests: memory: \u0026#34;5Mi\u0026#34; cpu: \u0026#34;10m\u0026#34; limits: memory: \u0026#34;256Mi\u0026#34; cpu: \u0026#34;1000m\u0026#34; volumes: - name: config # traefiké…ç½®æ–‡ä»¶ configMap: name: traefik-config - name: logdir # traefikæ—¥å¿—ç›®å½• hostPath: path: /var/log/traefik type: \u0026#34;DirectoryOrCreate\u0026#34; - name: timezone # æŒ‚è½½æ—¶åŒºæ–‡ä»¶ hostPath: path: /etc/localtime type: File service kubectl apply -f service.yml\napiVersion: v1 kind: Service metadata: labels: app: traefik name: traefik # å®é™…æä¾›æœåŠ¡çš„ service, ä½¿ç”¨ NodePort æ¨¡å¼ namespace: traefik spec: type: NodePort selector: app: traefik ports: - name: web protocol: TCP port: 80 targetPort: 80 nodePort: 80 - name: websecure protocol: TCP port: 443 targetPort: 443 nodePort: 443 - name: dashboard protocol: TCP port: 9000 targetPort: 9000 nodePort: 9000 - name: tcpep protocol: TCP port: 9200 targetPort: 9200 nodePort: 9200 - name: udpep protocol: UDP port: 9300 targetPort: 9300 nodePort: 9300 --- apiVersion: v1 kind: Service metadata: labels: app: traefik-metrics name: traefik-metrics # metrics ç”¨äºç»™é›†ç¾¤å†…çš„ prometheus æä¾›æ•°æ® namespace: traefik spec: selector: app: traefik ports: - name: metrics protocol: TCP port: 9100 targetPort: 9100 2.4 éªŒè¯ [root@k8s-node1 traefik]# kubectl get pod,cm,sa,svc -n traefik |grep traefik pod/traefik-69bd67497f-v27qp 1/1 Running 0 12m configmap/traefik-config 1 7d5h serviceaccount/traefik-ingress-controller 1 7d5h service/traefik NodePort 10.101.142.158 \u0026lt;none\u0026gt; 80:80/TCP,443:443/TCP,9000:9000/TCP,9200:9200/TCP,9300:9300/UDP 11m service/traefik-metrics ClusterIP 10.98.89.13 \u0026lt;none\u0026gt; 9100/TCP 12m å¯ä»¥ç›´æ¥é€šè¿‡ http://1.1.1.1:9000 è®¿é—®åˆ° dashboard\n2.5 å…¶ä»–é…ç½® 2.5.1 å¼ºåˆ¶ä½¿ç”¨ TLS v1.2+ å®˜æ–¹æ–‡æ¡£\nå¦‚ä»Šï¼ŒTLS v1.0 å’Œ v1.1 å› ä¸ºå­˜åœ¨å®‰å…¨é—®é¢˜ï¼Œç°åœ¨å·²è¢«å¼ƒç”¨ã€‚ä¸ºäº†ä¿éšœç³»ç»Ÿå®‰å…¨ï¼Œæ‰€æœ‰å…¥å£è·¯ç”±éƒ½åº”è¯¥å¼ºåˆ¶ä½¿ç”¨ TLS v1.2 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚\n[root@k8s-node1 traefik]# tee traefik-tlsoption.yml \u0026lt;\u0026lt;-\u0026#39;EOF\u0026#39; apiVersion: traefik.containo.us/v1alpha1 kind: TLSOption metadata: name: default namespace: traefik spec: minVersion: VersionTLS12 cipherSuites: - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 # TLS 1.2 - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305 # TLS 1.2 - TLS_AES_256_GCM_SHA384 # TLS 1.3 - TLS_CHACHA20_POLY1305_SHA256 # TLS 1.3 curvePreferences: - CurveP521 - CurveP384 sniStrict: true EOF [root@k8s-node1 traefik]# kubectl apply -f traefik-tlsoption.yml tlsoption.traefik.containo.us/default created 2.5.2 æ—¥å¿—åˆ‡å‰² å®˜æ–¹å¹¶æ²¡æœ‰æ—¥å¿—è½®æ¢çš„åŠŸèƒ½ï¼Œä½†æ˜¯ traefik æ”¶åˆ° USR1 ä¿¡å·åä¼šé‡å»ºæ—¥å¿—æ–‡ä»¶ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ logrotate å®ç°æ—¥å¿—è½®æ¢\nmkdir -p /etc/logrotate.d/traefik tee /etc/logrotate.d/traefik/config \u0026lt;\u0026lt;-\u0026#39;EOF\u0026#39; /var/log/traefik/*.log { daily rotate 15 missingok notifempty compress dateext dateyesterday dateformat .%Y-%m-%d create 0644 root root postrotate docker kill --signal=\u0026#34;USR1\u0026#34; $(docker ps | grep traefik |grep -v pause| awk \u0026#39;{print $1}\u0026#39;) endscript } EOF åˆ›å»ºå®šæ—¶ä»»åŠ¡\ncrontab -e 0 0 * * * /usr/sbin/logrotate -f /etc/logrotate.d/traefik/config \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 2.6 å¤šæ§åˆ¶å™¨ æœ‰çš„ä¸šåŠ¡åœºæ™¯ä¸‹å¯èƒ½éœ€è¦åœ¨ä¸€ä¸ªé›†ç¾¤ä¸­éƒ¨ç½²å¤šä¸ª traefikï¼Œä¾‹å¦‚ï¼šé¿å…å•ä¸ª traefik é…ç½®è§„åˆ™è¿‡å¤šå¯¼è‡´åŠ è½½å¤„ç†ç¼“æ…¢ã€‚æ¯ä¸ª namespace éƒ¨ç½²ä¸€ä¸ª traefikã€‚æˆ–è€… traefik ç”Ÿäº§ä¸æµ‹è¯•ç¯å¢ƒåŒºåˆ†ç­‰åœºæ™¯ï¼Œéœ€è¦ä¸åŒçš„å®ä¾‹æ§åˆ¶ä¸åŒçš„ IngressRoute èµ„æºå¯¹è±¡ï¼Œè¦å®ç°è¯¥åŠŸèƒ½æœ‰ä¸¤ç§æ–¹æ³•\n2.6.1 annotations æ³¨è§£ç­›é€‰ é¦–å…ˆåœ¨ traefik é…ç½®æ–‡ä»¶ä¸­çš„ providers ä¸‹å¢åŠ  Ingressclass å‚æ•°ï¼ŒæŒ‡å®šå…·ä½“çš„å€¼\nproviders: kubernetesCRD: # å¯ç”¨Kubernetes CRDæ–¹å¼æ¥é…ç½®è·¯ç”±è§„åˆ™ ingressClass: \u0026#34;traefik-v2.9\u0026#34; # æŒ‡å®štraefikçš„ingressClasså®ä¾‹åç§° allowCrossNamespace: true #å…è®¸è·¨namespace allowEmptyServices: true #å…è®¸ç©ºendpointsçš„service æ¥ä¸‹æ¥åœ¨ IngressRoute èµ„æºå¯¹è±¡ä¸­çš„ annotations å‚æ•°ä¸­æ·»åŠ  kubernetes.io/ingress.class: traefik-v2.9 å³å¯\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: dashboard namespace: traefik annotations: kubernetes.io/ingress.class: traefik-v2.9 # å› ä¸ºé™æ€é…ç½®æ–‡ä»¶æŒ‡å®šäº†ingressclassï¼Œæ‰€ä»¥è¿™é‡Œçš„annotations è¦æŒ‡å®šï¼Œå¦åˆ™è®¿é—®ä¼š404 spec: entryPoints: - web routes: - match: Host(`traefik.test.com`) kind: Rule services: - name: api@internal kind: TraefikService namespace: traefik 2.6.2 label æ ‡ç­¾é€‰æ‹©å™¨ç­›é€‰ é¦–å…ˆåœ¨ traefik é…ç½®æ–‡ä»¶ä¸­çš„ providers ä¸‹å¢åŠ  labelSelector å‚æ•°ï¼ŒæŒ‡å®šå…·ä½“çš„æ ‡ç­¾é”®å€¼ã€‚\nproviders: kubernetesCRD: # å¯ç”¨Kubernetes CRDæ–¹å¼æ¥é…ç½®è·¯ç”±è§„åˆ™ # ingressClass: \u0026#34;traefik-v2.9\u0026#34; # æŒ‡å®štraefikçš„ingressClassåç§° labelSelector: \u0026#34;app=traefik-v2.9\u0026#34; # é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨æŒ‡å®štraefikæ ‡ç­¾ allowCrossNamespace: true #å…è®¸è·¨namespace allowEmptyServices: true #å…è®¸ç©ºendpointsçš„service ç„¶ååœ¨ IngressRoute èµ„æºå¯¹è±¡ä¸­æ·»åŠ  labels æ ‡ç­¾é€‰æ‹©å™¨ï¼Œé€‰æ‹© app: traefik-v2.9 è¿™ä¸ªæ ‡ç­¾å³å¯\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: dashboard labels: # é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨ï¼Œè¯¥IngressRouteèµ„æºç”±é…ç½®äº†app=traefik-v2.9çš„traefikå¤„ç† app: traefik-v2.9 # annotations: # kubernetes.io/ingress.class: traefik-v2.9 spec: entryPoints: - web routes: - match: Host(`traefik.test.com`) kind: Rule services: - name: api@internal kind: TraefikService namespace: traefik ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-traefik-1-deploy/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: https://www.cuiliangblog.cn/detail/section/29427812 åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0ï¼Œ traefik-2.9.10 1 ç®€ä»‹ 1.1 Traefik ç®€ä»‹ Traefik æ˜¯ä¸€ä¸ªä¸ºäº†è®©éƒ¨ç½²å¾®æœåŠ¡æ›´åŠ ä¾¿æ·è€Œè¯ç”Ÿçš„ç°ä»£ HTTP åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡å·¥å…·ã€‚ å®ƒæ”¯æŒå¤šç§åå° (Docker, Swarm, Kubernetes, Marathon, Mesos, Consul, Etcd, Zookeeper, BoltDB, Rest API, fileâ€¦) æ¥è‡ªåŠ¨åŒ–ã€åŠ¨æ€çš„åº”ç”¨å®ƒçš„","title":"traefik (ä¸€) ç®€ä»‹ã€éƒ¨ç½²å’Œé…ç½®"},{"content":"1 ç®€ä»‹ Gateway APIï¼ˆä¹‹å‰å« Service APIï¼‰æ˜¯ç”± SIG-NETWORK ç¤¾åŒºç®¡ç†çš„å¼€æºé¡¹ç›®ï¼Œé¡¹ç›®åœ°å€\nIngress èµ„æºå¯¹è±¡ä¸èƒ½å¾ˆå¥½çš„æ»¡è¶³ç½‘ç»œéœ€æ±‚ï¼Œå¾ˆå¤šåœºæ™¯ä¸‹ Ingress æ§åˆ¶å™¨éƒ½éœ€è¦é€šè¿‡å®šä¹‰ annotations æˆ–è€… crd æ¥è¿›è¡ŒåŠŸèƒ½æ‰©å±•ï¼Œè¿™å¯¹äºä½¿ç”¨æ ‡å‡†å’Œæ”¯æŒæ˜¯éå¸¸ä¸åˆ©çš„ï¼Œæ–°æ¨å‡ºçš„ Gateway API æ—¨åœ¨é€šè¿‡å¯æ‰©å±•çš„é¢å‘è§’è‰²çš„æ¥å£æ¥å¢å¼ºæœåŠ¡ç½‘ç»œã€‚\nGateway API æ˜¯ Kubernetes ä¸­çš„ä¸€ä¸ª API èµ„æºé›†åˆï¼ŒåŒ…æ‹¬ GatewayClassã€Gatewayã€HTTPRouteã€TCPRouteã€Service ç­‰ï¼Œè¿™äº›èµ„æºå…±åŒä¸ºå„ç§ç½‘ç»œç”¨ä¾‹æ„å»ºæ¨¡å‹ã€‚\n2 éƒ¨ç½² 2.1 crd å†…å®¹è¾ƒé•¿ï¼Œç›´æ¥å¤åˆ¶ å®˜ç½‘yaml\n[root@k8s-node1 traefik]# kubectl apply -f gateway-api-crd.yml customresourcedefinition.apiextensions.k8s.io/gatewayclasses.networking.x-k8s.io created customresourcedefinition.apiextensions.k8s.io/gateways.networking.x-k8s.io created customresourcedefinition.apiextensions.k8s.io/httproutes.networking.x-k8s.io created customresourcedefinition.apiextensions.k8s.io/tcproutes.networking.x-k8s.io created customresourcedefinition.apiextensions.k8s.io/tlsroutes.networking.x-k8s.io created 2.2 rbac --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: gateway-role rules: - apiGroups: - \u0026#34;\u0026#34; resources: - services - endpoints - secrets verbs: - get - list - watch - apiGroups: - networking.x-k8s.io resources: - gatewayclasses - gateways - httproutes - tcproutes - tlsroutes verbs: - get - list - watch - apiGroups: - networking.x-k8s.io resources: - gatewayclasses/status - gateways/status - httproutes/status - tcproutes/status - tlsroutes/status verbs: - update --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: gateway-controller roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: gateway-role subjects: - kind: ServiceAccount name: traefik-ingress-controller namespace: default åº”ç”¨ yaml\n[root@k8s-node1 traefik]# kubectl apply -f gateway-api-rbac.yml clusterrole.rbac.authorization.k8s.io/gateway-role created clusterrolebinding.rbac.authorization.k8s.io/gateway-controller created ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-gatewayapi/","summary":"1 ç®€ä»‹ Gateway APIï¼ˆä¹‹å‰å« Service APIï¼‰æ˜¯ç”± SIG-NETWORK ç¤¾åŒºç®¡ç†çš„å¼€æºé¡¹ç›®ï¼Œé¡¹ç›®åœ°å€ Ingress èµ„æºå¯¹è±¡ä¸èƒ½å¾ˆå¥½çš„æ»¡è¶³ç½‘ç»œéœ€æ±‚ï¼Œå¾ˆå¤šåœºæ™¯ä¸‹ Ingress æ§åˆ¶å™¨éƒ½éœ€è¦é€šè¿‡å®šä¹‰ annotations æˆ–è€… crd æ¥è¿›è¡ŒåŠŸèƒ½æ‰©å±•ï¼Œè¿™å¯¹äºä½¿ç”¨æ ‡å‡†å’Œæ”¯æŒæ˜¯éå¸¸ä¸åˆ©çš„ï¼Œæ–°æ¨å‡ºçš„ Gateway API æ—¨åœ¨é€šè¿‡å¯æ‰©å±•çš„é¢å‘è§’è‰²çš„æ¥å£æ¥å¢å¼ºæœåŠ¡ç½‘ç»œã€‚ Gateway API æ˜¯ Kubernetes ä¸­çš„ä¸€ä¸ª API èµ„æºé›†åˆï¼ŒåŒ…æ‹¬","title":"kubernetes | Gateway API ç®€ä»‹åŠéƒ¨ç½²"},{"content":"0 å‰è¨€ dns é…ç½®æ–‡ä»¶ /etc/resolv.conf ä¸­å¸¸çœ‹åˆ°æœ‰ search è®¾ç½®ï¼Œä»¥å‰ä»¥ä¸ºæ˜¯æ ¹æ® search ä¸­çš„åŸŸå»æŒ‡å®š nameserverï¼Œå…¶å®ä¸æ˜¯è¿™æ ·ç”¨çš„ã€‚å®ƒçš„ä¸€ä¸ªç”¨å¤„æ˜¯ç¨‹åºåªéœ€è¦çŸ¥é“ä¸»æœºåå°±å¯ä»¥è§£æåˆ° ipï¼Œä¸å¿…çŸ¥é“åŸŸååç¼€ domain æ˜¯ä»€ä¹ˆ\nFQDN (Fully Qualified Domain Name) å«ä¹‰æ˜¯å®Œæ•´çš„åŸŸå. ä¾‹å¦‚, ä¸€å°æœºå™¨ä¸»æœºå (hostname) æ˜¯ www, åŸŸååç¼€ (domain) æ˜¯ baidu.com, é‚£ä¹ˆè¯¥ä¸»æœºçš„ FQDN åº”è¯¥æ˜¯ www.baidu.com. æœ€åæ˜¯ä»¥ . æ¥ç»“å°¾çš„, ä½†æ˜¯å¤§éƒ¨åˆ†çš„åº”ç”¨å’ŒæœåŠ¡å™¨éƒ½å…è®¸å¿½ç•¥æœ€åè¿™ä¸ªç‚¹ . æ‰€æœ‰å¤§å®¶ç›´æ¥è¾“å…¥ www.baidu.com ä¹Ÿå¯ä»¥è¯†åˆ«\nhttps://www.man7.org/linux/man-pages/man5/resolv.conf.5.html\n1 search ä¸‹é¢ä»¥å‡ ä¸ªç¤ºä¾‹æ¼”ç¤ºä¸€ä¸‹ search æ˜¯å¦‚ä½•å·¥ä½œçš„\n/etc/resolv.conf é…ç½®æ–‡ä»¶å†…å®¹\nnameserver 8.8.8.8 search foo.local bar.local è§£æ test ï¼Œä¼˜å…ˆä»¥ hostname çš„å½¢å¼æ‹¼æ¥åˆ° search ä¸­é…ç½®çš„ domain ä¸Šè¿›è¡ŒæŸ¥è¯¢ï¼Œå¦‚æœå¤±è´¥ç›´æ¥ä»¥ FQDN çš„å½¢å¼æŸ¥è¯¢\n[root@k8s-node1 ~]# host -a test Trying \u0026#34;test.foo.local\u0026#34; Trying \u0026#34;test.bar.local\u0026#34; Trying \u0026#34;test\u0026#34; Host test not found: 3(NXDOMAIN) Received 97 bytes from 8.8.8.8#53 in 53 ms è§£æ test.hello ï¼Œä¼˜å…ˆä»¥ FQDN çš„å½¢å¼æŸ¥è¯¢ï¼Œå¦‚æœå¤±è´¥åˆ™ä»¥ hostname çš„å½¢å¼æ‹¼æ¥åˆ° search ä¸­é…ç½®çš„ domain ä¸Šè¿›è¡ŒæŸ¥è¯¢\n[root@k8s-node1 ~]# host -a test.hello Trying \u0026#34;test.hello\u0026#34; Received 103 bytes from 8.8.8.8#53 in 48 ms Trying \u0026#34;test.hello.foo.local\u0026#34; Trying \u0026#34;test.hello.bar.local\u0026#34; Host test.hello not found: 3(NXDOMAIN) Received 113 bytes from 8.8.8.8#53 in 49 ms è§£æ test. ï¼Œç›´æ¥è®¤å®šä¸º FQDN ï¼Œä»¥ FQDN çš„å½¢å¼æŸ¥è¯¢ï¼Œä¸ä¼šè¿›è¡Œæ‹¼æ¥æŸ¥è¯¢\n[root@k8s-node1 ~]# host -a test. Trying \u0026#34;test\u0026#34; Host test. not found: 3(NXDOMAIN) Received 97 bytes from 8.8.8.8#53 in 54 ms 2 options ndots å¯ä»¥å‘ç°ï¼Œé…ç½®äº† search ä¹‹åï¼Œé™¤éä»¥æœ€åä¸€ç§å½¢å¼æŸ¥è¯¢ï¼Œæ€»ä¼šå°† hostname å’Œ search è¿›è¡Œæ‹¼æ¥æŸ¥è¯¢\nå…¶å®å®ƒæ˜¯ç”± options ndots:[number] é€‰é¡¹æ§åˆ¶çš„ï¼šå½“æŸ¥è¯¢çš„åŸŸåæœ‰ \u0026gt;= number ä¸ª . æ—¶ï¼Œä¼˜å…ˆä»¥ FQDN çš„å½¢å¼æŸ¥è¯¢ï¼Œå¦‚æœå¤±è´¥å†æ‹¼æ¥æŸ¥è¯¢\né…ç½® /etc/resolv.conf\nnameserver 8.8.8.8 search foo.local bar.local options ndots:2 è§‚å¯Ÿä¸‹è¿°ç¤ºä¾‹\ntest\n[root@k8s-node1 ~]# host -a test Trying \u0026#34;test.foo.local\u0026#34; Trying \u0026#34;test.bar.local\u0026#34; Trying \u0026#34;test\u0026#34; Host test not found: 3(NXDOMAIN) Received 97 bytes from 8.8.8.8#53 in 45 ms test.hello\n[root@k8s-node1 ~]# host -a test.hello Trying \u0026#34;test.hello.foo.local\u0026#34; Trying \u0026#34;test.hello.bar.local\u0026#34; Trying \u0026#34;test.hello\u0026#34; Host test.hello not found: 3(NXDOMAIN) Received 103 bytes from 8.8.8.8#53 in 46 ms test.hello.world\n[root@k8s-node1 ~]# host -a test.hello.world Trying \u0026#34;test.hello.world\u0026#34; Received 119 bytes from 8.8.8.8#53 in 57 ms Trying \u0026#34;test.hello.world.foo.local\u0026#34; Trying \u0026#34;test.hello.world.bar.local\u0026#34; Host test.hello.world not found: 3(NXDOMAIN) Received 119 bytes from 8.8.8.8#53 in 45 ms test.\n[root@k8s-node1 ~]# host -a test. Trying \u0026#34;test\u0026#34; Host test. not found: 3(NXDOMAIN) Received 97 bytes from 8.8.8.8#53 in 45 ms ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/linux-dns-search/","summary":"0 å‰è¨€ dns é…ç½®æ–‡ä»¶ /etc/resolv.conf ä¸­å¸¸çœ‹åˆ°æœ‰ search è®¾ç½®ï¼Œä»¥å‰ä»¥ä¸ºæ˜¯æ ¹æ® search ä¸­çš„åŸŸå»æŒ‡å®š nameserverï¼Œå…¶å®ä¸æ˜¯è¿™æ ·ç”¨çš„ã€‚å®ƒçš„ä¸€ä¸ªç”¨å¤„æ˜¯ç¨‹åºåªéœ€è¦çŸ¥é“ä¸»æœºåå°±å¯ä»¥è§£æåˆ° ipï¼Œä¸å¿…çŸ¥é“åŸŸååç¼€ domain æ˜¯ä»€ä¹ˆ FQDN (Fully Qualified Domain Name) å«ä¹‰æ˜¯å®Œæ•´çš„åŸŸå. ä¾‹å¦‚, ä¸€å°æœºå™¨ä¸»æœºå (hostname) æ˜¯ www, åŸŸååç¼€ (domain) æ˜¯ baidu.com, é‚£ä¹ˆè¯¥ä¸»æœºçš„ FQDN åº”è¯¥æ˜¯ www.baidu.com. æœ€åæ˜¯ä»¥ .","title":"linux | dns é…ç½®æ–‡ä»¶ä¸­ search å’Œ options ndots è¯¦è§£"},{"content":"1 command args å¦‚æœæŒ‡å®šäº† containers.commandï¼ŒDockerfile ä¸­çš„ ENTRYPOINT ä¼šè¢«è¦†ç›–ä¸” CMD æŒ‡ä»¤è¢«å¿½ç•¥ å¦‚æœæŒ‡å®šäº† containers.argsï¼ŒDockerfile ä¸­çš„ ENTRYPOINT ç»§ç»­æ‰§è¡Œï¼Œ CMD æŒ‡ä»¤ è¢«è¦†ç›– ENTRYPOINT CMD command args finally [\u0026quot;/ep1\u0026quot;] [\u0026ldquo;foo\u0026rdquo;, \u0026ldquo;bar\u0026rdquo;] ep-1 foo bar [\u0026quot;/ep1\u0026quot;] [\u0026ldquo;foo\u0026rdquo;, \u0026ldquo;bar\u0026rdquo;] [\u0026quot;/ep-2\u0026quot;] ep-2 [\u0026quot;/ep1\u0026quot;] [\u0026ldquo;foo\u0026rdquo;, \u0026ldquo;bar\u0026rdquo;] [\u0026ldquo;zoo\u0026rdquo;, \u0026ldquo;boo\u0026rdquo;] ep-1 zoo boo [\u0026quot;/ep1\u0026quot;] [\u0026ldquo;foo\u0026rdquo;, \u0026ldquo;bar\u0026rdquo;] [\u0026quot;/ep-2\u0026quot;] [\u0026ldquo;zoo\u0026rdquo;, \u0026ldquo;boo\u0026rdquo;] ep-2 zoo boo 2 CMD ENTRYPOINT æˆ‘ä»¬å¤§æ¦‚å¯ä»¥æ€»ç»“å‡ºä¸‹é¢å‡ æ¡è§„å¾‹ï¼š\nå¦‚æœ ENTRYPOINT ä½¿ç”¨äº† shell æ¨¡å¼ï¼ŒCMD æŒ‡ä»¤ä¼šè¢«å¿½ç•¥ã€‚ å¦‚æœ ENTRYPOINT ä½¿ç”¨äº† exec æ¨¡å¼ï¼ŒCMD æŒ‡å®šçš„å†…å®¹è¢«è¿½åŠ ä¸º ENTRYPOINT æŒ‡å®šå‘½ä»¤çš„å‚æ•°ã€‚ å¦‚æœ ENTRYPOINT ä½¿ç”¨äº† exec æ¨¡å¼ï¼ŒCMD ä¹Ÿåº”è¯¥ä½¿ç”¨ exec æ¨¡å¼ã€‚ è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå¦‚æœä½¿ç”¨ docker run --entrypoint è¦†ç›–äº† Dockerfile ä¸­çš„ ENTRYPOINT , åŒæ—¶ CMD æŒ‡ä»¤ä¹Ÿä¼šè¢«å¿½ç•¥\nçœŸå®çš„æƒ…å†µè¦è¿œæ¯”è¿™ä¸‰æ¡è§„å¾‹å¤æ‚ï¼Œå¥½åœ¨ docker ç»™å‡ºäº† å®˜æ–¹çš„è§£é‡Šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-command-args-docker-entrypoint-cmd/","summary":"1 command args å¦‚æœæŒ‡å®šäº† containers.commandï¼ŒDockerfile ä¸­çš„ ENTRYPOINT ä¼šè¢«è¦†ç›–ä¸” CMD æŒ‡ä»¤è¢«å¿½ç•¥ å¦‚æœæŒ‡å®šäº† containers.argsï¼ŒDockerfile ä¸­çš„ ENTRYPOINT ç»§ç»­æ‰§è¡Œï¼Œ CMD æŒ‡ä»¤ è¢«è¦†ç›– ENTRYPOINT CMD command args finally [\u0026quot;/ep1\u0026quot;] [\u0026ldquo;foo\u0026rdquo;, \u0026ldquo;bar\u0026rdquo;] ep-1 foo bar [\u0026quot;/ep1\u0026quot;] [\u0026ldquo;foo\u0026rdquo;, \u0026ldquo;bar\u0026rdquo;] [\u0026quot;/ep-2\u0026quot;] ep-2 [\u0026quot;/ep1\u0026quot;] [\u0026ldquo;foo\u0026rdquo;, \u0026ldquo;bar\u0026rdquo;] [\u0026ldquo;zoo\u0026rdquo;, \u0026ldquo;boo\u0026rdquo;] ep-1 zoo boo [\u0026quot;/ep1\u0026quot;] [\u0026ldquo;foo\u0026rdquo;, \u0026ldquo;bar\u0026rdquo;] [\u0026quot;/ep-2\u0026quot;] [\u0026ldquo;zoo\u0026rdquo;, \u0026ldquo;boo\u0026rdquo;] ep-2 zoo boo 2 CMD ENTRYPOINT æˆ‘ä»¬å¤§æ¦‚å¯ä»¥æ€»ç»“","title":"kubernetes |  command args å’Œ dockerfile ä¸­çš„ ENTRYPOINT CMD"},{"content":"1 åŸºç¡€æ¦‚å¿µ StatefulSet åº”ç”¨åœºæ™¯ï¼šåˆ†å¸ƒå¼åº”ç”¨ã€é›†ç¾¤\néƒ¨ç½²æœ‰çŠ¶æ€åº”ç”¨ è§£å†³ Pod ç‹¬ç«‹ç”Ÿå‘½å‘¨æœŸï¼Œä¿æŒ Pod å¯åŠ¨é¡ºåºå’Œå”¯ä¸€æ€§ ç¨³å®šï¼Œå”¯ä¸€çš„ç½‘ç»œæ ‡è¯†ç¬¦ï¼ŒæŒä¹…å­˜å‚¨ æœ‰åºï¼Œä¼˜é›…çš„éƒ¨ç½²å’Œæ‰©å±•ã€åˆ é™¤å’Œç»ˆæ­¢ æœ‰åºï¼Œæ»šåŠ¨æ›´æ–° StatefulSet æ§åˆ¶å™¨çš„ä¼˜åŠ¿\nç¨³å®šçš„å­˜å‚¨ StatefulSet çš„å­˜å‚¨å·ä½¿ç”¨ VolumeClaimTemplate åˆ›å»ºï¼Œç§°ä¸ºå·ç”³è¯·æ¨¡æ¿ï¼Œå½“ StatefulSet ä½¿ç”¨ VolumeClaimTemplate åˆ›å»ºä¸€ä¸ª PersistentVolume æ—¶ï¼ŒåŒæ ·ä¹Ÿä¼šä¸ºæ¯ä¸ª Pod åˆ†é…å¹¶åˆ›å»ºä¸€ä¸ªç¼–å·çš„ PVCã€‚è¯¥ PVC å’Œ PV ä¸ä¼šéšç€ StatefulSet çš„åˆ é™¤è€Œåˆ é™¤ ç¨³å®šçš„ç½‘ç»œ ID StatefulSet ä¸­çš„æ¯ä¸ª POD åç§°å›ºå®šï¼š\u0026lt;statefulset-name\u0026gt;-\u0026lt;number\u0026gt; é€šè¿‡ serviceName å­—æ®µæŒ‡å®š Headless Service ï¼Œå¯ä»¥ä¸ºæ¯ä¸ª POD åˆ†é…ä¸€ä¸ªå›ºå®šçš„ DNS è§£æï¼Œé‡å¯æˆ–è€…é‡å»º POD æ—¶è™½ç„¶ ip æœ‰æ‰€å˜åŠ¨ï¼Œä½† DNS è§£æä¼šä¿æŒç¨³å®š ç¤ºä¾‹ yaml\napiVersion: v1 kind: Service metadata: name: statefulset-nginx labels: app: statefulset-nginx spec: selector: app: statefulset-nginx clusterIP: None ports: - name: web port: 80 --- apiVersion: apps/v1 kind: StatefulSet metadata: name: statefulset-nginx spec: serviceName: \u0026#34;statefulset-nginx\u0026#34; replicas: 2 selector: matchLabels: app: statefulset-nginx template: metadata: labels: app: statefulset-nginx spec: terminationGracePeriodSeconds: 5 containers: - name: statefulset-nginx image: nginx:1.22.1 imagePullPolicy: IfNotPresent ports: - name: web containerPort: 80 volumeMounts: - name: www mountPath: /usr/share/nginx/html volumeClaimTemplates: - metadata: name: www spec: storageClassName: \u0026#34;nfs\u0026#34; accessModes: - ReadWriteOnce resources: requests: storage: 1Gi 2 ç¨³å®šçš„å­˜å‚¨ å¯ä»¥çœ‹åˆ°ä¸ deployment ä¸åŒï¼Œstatefulset ä¸­çš„æ¯ä¸ª pod éƒ½åˆ†é…åˆ°äº†ç‹¬ç«‹çš„ pvï¼Œä¸”é‡å¯ pod åå­˜å‚¨å¯¹åº”å…³ç³»ä¸å˜\n[root@k8s-node1 ~]# kubectl get pod,pvc,pv | awk \u0026#39;{print $1}\u0026#39; # pod NAME pod/nfs-client-provisioner-66d6cb77fd-47hsf pod/statefulset-nginx-0 pod/statefulset-nginx-1 # pvc NAME persistentvolumeclaim/www-statefulset-nginx-0 persistentvolumeclaim/www-statefulset-nginx-1 # pv NAME persistentvolume/pvc-17751fde-1b23-4535-98bb-a70342ddd6fe persistentvolume/pvc-b7519f46-b2af-42e4-b66d-d7459be2e87c [root@k8s-node1 ~]# ls /nfs/ default-www-statefulset-nginx-0-pvc-17751fde-1b23-4535-98bb-a70342ddd6fe default-www-statefulset-nginx-1-pvc-b7519f46-b2af-42e4-b66d-d7459be2e87c 3 ç¨³å®šçš„ç½‘ç»œ ID æ‰‹åŠ¨åˆ é™¤ pod åé™¤äº† pod çš„ ip ä¼šå˜åŠ¨ï¼Œä¸»æœºåå’Œ dns è§£æéƒ½æ­£å¸¸\n# PODåå­—å›ºå®š [root@k8s-node1 ~]# kubectl get pods -l app=statefulset-nginx NAME READY STATUS RESTARTS AGE statefulset-nginx-0 1/1 Running 0 5m18s statefulset-nginx-1 1/1 Running 0 5m17s # ä¸»æœºåå›ºå®š [root@k8s-node1 ~]# for i in 0 1; do kubectl exec \u0026#34;statefulset-nginx-$i\u0026#34; -- hostname; done statefulset-nginx-0 statefulset-nginx-1 # DNSè§£æå›ºå®š [root@k8s-node1 ~]# kubectl run -it --rm --restart=Never --image busybox:1.28 dns-test -- nslookup statefulset-nginx Server: 10.96.0.10 Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local Name: statefulset-nginx Address 1: 10.244.107.230 statefulset-nginx-1.statefulset-nginx.default.svc.cluster.local Address 2: 10.244.169.157 statefulset-nginx-0.statefulset-nginx.default.svc.cluster.local pod \u0026#34;dns-test\u0026#34; deleted 4 æš´éœ²åº”ç”¨ ç”±äºä½¿ç”¨çš„æ˜¯ Headless Service ï¼Œæ— æ³•ä½¿ç”¨ NodePort çš„æ–¹å¼æš´éœ²åº”ç”¨ç«¯å£ï¼Œæˆ‘ä»¬å¯ä»¥å•ç‹¬åˆ›å»º service æ¥æš´éœ²ç‰¹å®š pod åº”ç”¨\nStatefulSet æ§åˆ¶å™¨ä¸­çš„ pod åç§°éƒ½æ˜¯å›ºå®šçš„ï¼š \u0026lt;statefulset-name\u0026gt;-\u0026lt;number\u0026gt; ï¼Œå¯ä»¥é€šè¿‡ statefulset.kubernetes.io/pod-name æ ‡ç­¾å›ºå®š pod\nç¤ºä¾‹å¦‚ä¸‹\napiVersion: v1 kind: Service metadata: name: ss-nginx-0 labels: app: ss-nginx-0 spec: selector: statefulset.kubernetes.io/pod-name: statefulset-nginx-0 type: NodePort ports: - name: web port: 80 targetPort: 80 nodePort: 30003 éªŒè¯\n[root@k8s-node1 ~]# kubectl get svc ss-nginx-0 NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE ss-nginx-0 NodePort 10.111.69.1 \u0026lt;none\u0026gt; 80:30003/TCP 3h53m [root@k8s-node1 ~]# kubectl get ep ss-nginx-0 NAME ENDPOINTS AGE ss-nginx-0 10.244.169.188:80 3h53m ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-statefulset/","summary":"1 åŸºç¡€æ¦‚å¿µ StatefulSet åº”ç”¨åœºæ™¯ï¼šåˆ†å¸ƒå¼åº”ç”¨ã€é›†ç¾¤ éƒ¨ç½²æœ‰çŠ¶æ€åº”ç”¨ è§£å†³ Pod ç‹¬ç«‹ç”Ÿå‘½å‘¨æœŸï¼Œä¿æŒ Pod å¯åŠ¨é¡ºåºå’Œå”¯ä¸€æ€§ ç¨³å®šï¼Œå”¯ä¸€çš„ç½‘ç»œæ ‡è¯†ç¬¦ï¼ŒæŒä¹…å­˜å‚¨ æœ‰åºï¼Œä¼˜é›…çš„éƒ¨ç½²å’Œæ‰©å±•ã€åˆ é™¤å’Œç»ˆæ­¢ æœ‰åºï¼Œæ»šåŠ¨æ›´æ–° StatefulSet æ§åˆ¶å™¨çš„ä¼˜åŠ¿ ç¨³å®šçš„å­˜å‚¨ StatefulSet çš„å­˜å‚¨å·ä½¿ç”¨ VolumeClaimTemplate åˆ›å»ºï¼Œç§°ä¸ºå·ç”³è¯·æ¨¡æ¿ï¼Œå½“ StatefulSet ä½¿ç”¨ VolumeClaimTemplate åˆ›å»ºä¸€ä¸ª PersistentVolume æ—¶ï¼ŒåŒæ ·ä¹Ÿä¼šä¸ºæ¯ä¸ª Pod åˆ†é…","title":"kubernetes | statefulset æ§åˆ¶å™¨è¯¦è§£"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹å†…å®¹:\nå¦‚ä½•ç¼–å†™æœ€ä½³çš„ Dockerfile åœ¨ä½¿ç”¨ Docker çš„è¿‡ç¨‹ä¸­ï¼Œç¼–å†™ Dockerfile æ˜¯éå¸¸é‡è¦çš„ä¸€éƒ¨åˆ†å·¥ä½œã€‚åˆç†ç¼–å†™ Dockerfile ä¼šä½¿æˆ‘ä»¬æ„å»ºå‡ºæ¥çš„ Docker image æ‹¥æœ‰æ›´ä½³çš„æ€§èƒ½å’Œå¥å£®æ€§\nç›®æ ‡:\næ›´å¿«çš„æ„å»ºé€Ÿåº¦ æ›´å°çš„ Docker é•œåƒå¤§å° æ›´å°‘çš„ Docker é•œåƒå±‚ å……åˆ†åˆ©ç”¨é•œåƒç¼“å­˜ å¢åŠ  Dockerfile å¯è¯»æ€§ è®© Docker å®¹å™¨ä½¿ç”¨èµ·æ¥æ›´ç®€å• æ€»ç»“\nç¼–å†™.dockerignore æ–‡ä»¶ å®¹å™¨åªè¿è¡Œå•ä¸ªåº”ç”¨ å°†å¤šä¸ª RUN æŒ‡ä»¤åˆå¹¶ä¸ºä¸€ä¸ª åŸºç¡€é•œåƒçš„æ ‡ç­¾ä¸è¦ç”¨ latest æ¯ä¸ª RUN æŒ‡ä»¤ååˆ é™¤å¤šä½™æ–‡ä»¶ é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ (alpine ç‰ˆæœ¬æœ€å¥½) è®¾ç½® WORKDIR å’Œ CMD ä½¿ç”¨ ENTRYPOINT (å¯é€‰) åœ¨ entrypoint è„šæœ¬ä¸­ä½¿ç”¨ exec COPY ä¸ ADD ä¼˜å…ˆä½¿ç”¨å‰è€… åˆç†è°ƒæ•´ COPY ä¸ RUN çš„é¡ºåº è®¾ç½®é»˜è®¤çš„ç¯å¢ƒå˜é‡ï¼Œæ˜ å°„ç«¯å£å’Œæ•°æ®å· ä½¿ç”¨ LABEL è®¾ç½®é•œåƒå…ƒæ•°æ® æ·»åŠ  HEALTHCHECK å¯ä»¥è¯´æ¯æ¡ Dockerfile æŒ‡ä»¤éƒ½æœ‰ç›¸å…³çš„ä¼˜åŒ–é¡¹ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€èµ˜è¿°äº†ï¼Œä¸‹é¢ä»…åˆ—ä¸¾ä¸€äº›å¸¸è§ä¸”é‡è¦çš„è®¾ç½®\n1 å®¹å™¨çš„ä¼˜é›…é€€å‡º ä¼—æ‰€å‘¨çŸ¥ï¼Œdocker å®¹å™¨æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªä¸ªè¿›ç¨‹ï¼Œè¿›ç¨‹çš„ä¼˜é›…é€€å‡ºéœ€è¦è€ƒè™‘çš„æ˜¯å¦‚ä½•æ­£ç¡®å¤„ç† SIGTERM ä¿¡å·ï¼Œå…³äºè¿™ç‚¹åœ¨æˆ‘çš„å¦ä¸€ç¯‡åšæ–‡ä¸­ä»‹ç»è¿‡ killå‘½ä»¤è¯¦è§£ä»¥åŠlinuxä¸­çš„ä¿¡å·\næ— è®ºæ˜¯ docker stop è¿˜æ˜¯åœ¨ kubernetes ä¸­ä½¿ç”¨å®¹å™¨ï¼Œä¸€èˆ¬å…³é—­å®¹å™¨éƒ½æ˜¯å‘å®¹å™¨å†…çš„ 1 å·è¿›ç¨‹å‘é€ SIGTERM ä¿¡å·ï¼Œç­‰å¾…å®¹å™¨è‡ªè¡Œè¿›è¡Œèµ„æºæ¸…ç†ç­‰æ“ä½œï¼Œç­‰å¾…æ—¶é—´ docker é»˜è®¤ 10sï¼Œk8s é»˜è®¤ 30sï¼Œå¦‚æœå®¹å™¨ä»æœªé€€å‡ºï¼Œåˆ™å‘é€ SIGKILL ä¿¡å·å¼ºåˆ¶æ€æ­»è¿›ç¨‹\nç»¼ä¸Šï¼Œæˆ‘ä»¬åªéœ€è¦è€ƒè™‘ 2 ç‚¹\nåº”ç”¨ç¨‹åºå¦‚ä½•å¤„ç†ä¿¡å· è¿™å°±éœ€è¦åœ¨åº”ç”¨ç¨‹åºä¸­å®šä¹‰å¯¹ä¿¡å·çš„å¤„ç†é€»è¾‘äº†ï¼ŒåŒ…æ‹¬å¯¹æ¯ä¸ªä¿¡å·å¦‚ä½•å¤„ç†å¦‚ä½•è½¬å‘ç»™å­è¿›ç¨‹ç­‰ã€‚\nåº”ç”¨ç¨‹åºå¦‚ä½•è·å–ä¿¡å· docker å®¹å™¨çš„ä¸€å·è¿›ç¨‹æ˜¯ç”± CMD ENTRYPOINT è¿™ä¸¤ä¸ªæŒ‡ä»¤å†³å®šçš„ï¼Œæ‰€ä»¥æ­£ç¡®ä½¿ç”¨è¿™ä¸¤ä¸ªæŒ‡ä»¤ååˆ†å…³é”®\nCMD å’Œ ENTRYPOINT åˆ†åˆ«éƒ½æœ‰ exec å’Œ shell ä¸¤ç§æ ¼å¼ï¼š\nä½¿ç”¨ exec æ ¼å¼æ—¶ï¼Œæˆ‘ä»¬æ‰§è¡Œçš„å‘½ä»¤å°±æ˜¯ä¸€å·è¿›ç¨‹ ä½¿ç”¨ shell æ ¼å¼æ—¶ï¼Œå®é™…ä¼šä»¥ /bin/sh -c command argâ€¦ çš„æ–¹å¼è¿è¡Œï¼Œè¿™ç§æƒ…å†µä¸‹å®¹å™¨çš„ä¸€å·è¿›ç¨‹å°†ä¼šæ˜¯ /bin/shï¼Œå½“æ”¶åˆ°ä¿¡å·æ—¶ /bin/sh ä¸ä¼šå°†ä¿¡å·è½¬å‘ç»™æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œå¯¼è‡´æ„æ–™ä¹‹å¤–çš„é”™è¯¯ï¼Œæ‰€ä»¥ååˆ†ä¸æ¨èä½¿ç”¨ shell æ ¼å¼ æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ tini ä½œä¸º init ç³»ç»Ÿç®¡ç†è¿›ç¨‹\nå®˜æ–¹åœ°å€ï¼šhttps://github.com/krallin/tini\nTini (Tiny but Independent) æ˜¯ä¸€ä¸ªå°å‹çš„ã€å¯æ‰§è¡Œçš„ç¨‹åºï¼Œå®ƒçš„ä¸»è¦ç›®çš„æ˜¯ä½œä¸ºä¸€ä¸ª init ç³»ç»Ÿçš„æ›¿ä»£å“ï¼Œç”¨äºåœ¨å®¹å™¨ä¸­å¯åŠ¨åº”ç”¨ç¨‹åºã€‚\nåœ¨å®¹å™¨ä¸­å¯åŠ¨åº”ç”¨ç¨‹åºæ—¶ï¼Œé€šå¸¸ä¼šä½¿ç”¨ init ç³»ç»Ÿæ¥ç®¡ç†è¿›ç¨‹ã€‚ç„¶è€Œï¼Œç”±äºå®¹å™¨çš„ç‰¹æ®Šæ€§ï¼Œä¼ ç»Ÿçš„ init ç³»ç»Ÿå¯èƒ½æ— æ³•å®Œå…¨æ»¡è¶³å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„éœ€æ±‚ã€‚Tini ä½œä¸ºä¸€ä¸ªå°å·§è€Œç‹¬ç«‹çš„ç¨‹åºï¼Œå¯ä»¥å¸®åŠ©è§£å†³å®¹å™¨å¯åŠ¨æ—¶å¯èƒ½é‡åˆ°çš„å„ç§é—®é¢˜ï¼Œå¦‚åƒµå°¸è¿›ç¨‹ã€ä¿¡å·å¤„ç†ç­‰ã€‚\nåœ¨ Docker ä¸­ä½¿ç”¨ Tini çš„ä¸»è¦æ„ä¹‰åœ¨äºæé«˜å®¹å™¨çš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚Tini å¯ä»¥ç¡®ä¿å®¹å™¨ä¸­çš„åº”ç”¨ç¨‹åºåœ¨å¯åŠ¨å’Œé€€å‡ºæ—¶æ­£ç¡®å¤„ç†ä¿¡å·ï¼Œé¿å…åƒµå°¸è¿›ç¨‹å’Œå…¶å®ƒå¸¸è§é—®é¢˜çš„å‡ºç°ã€‚æ­¤å¤–ï¼ŒTini è¿˜å¯ä»¥æœ‰æ•ˆåœ°é™åˆ¶å®¹å™¨ä¸­çš„èµ„æºä½¿ç”¨ï¼Œé¿å…åº”ç”¨ç¨‹åºå´©æºƒæˆ–è€…å ç”¨è¿‡å¤šçš„ç³»ç»Ÿèµ„æºï¼Œä»è€Œæé«˜å®¹å™¨çš„å¯ç”¨æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚\næ€»ä¹‹ï¼Œä½¿ç”¨ Tini å¯ä»¥è®©å®¹å™¨ä¸­çš„åº”ç”¨ç¨‹åºæ›´åŠ å¥å£®ã€ç¨³å®šå’Œå¯é ï¼Œè¿™å¯¹äºè¿è¡Œç”Ÿäº§ç¯å¢ƒä¸­çš„åº”ç”¨ç¨‹åºéå¸¸é‡è¦ã€‚\nä½¿ç”¨ç¤ºä¾‹\nFROM nginx ENV TINI_VERSION=v0.19.0 ADD https://github.com/krallin/tini/releases/download/${TINI_VERSION}/tini /tini RUN chmod +x /tini ENTRYPOINT [\u0026#34;/tini\u0026#34;, \u0026#34;--\u0026#34;, \u0026#34;/docker-entrypoint.sh\u0026#34;] CMD [\u0026#34;nginx\u0026#34;, \u0026#34;-g\u0026#34;, \u0026#34;daemon off;\u0026#34;] Alpine Linux\nRUN apk add --no-cache tini # Tini is now available at /sbin/tini ENTRYPOINT [\u0026#34;/sbin/tini\u0026#34;, \u0026#34;--\u0026#34;] NixOS\nnix-env --install tini Debian\napt-get install tini Arch Linux\npacaur -S tini 2 RUN æŒ‡ä»¤ RUN æŒ‡ä»¤ä¸€èˆ¬ç”¨äºå®‰è£…é…ç½®è½¯ä»¶åŒ…ç­‰æ“ä½œï¼Œé€šå¸¸éœ€è¦æ¯”è¾ƒå¤šçš„æ­¥éª¤ï¼Œå¦‚æœæ¯æ¡å‘½ä»¤éƒ½å•ç‹¬ç”¨ RUN æŒ‡ä»¤å»è·‘ä¼šå¯¼è‡´é•œåƒå±‚æ•°éå¸¸å¤šï¼Œæ‰€ä»¥å°½å¯èƒ½å°†æ‰€æœ‰ RUN æŒ‡ä»¤æ‹¼æ¥èµ·æ¥æ˜¯å½“å‰çš„äº‹å®æ ‡å‡†\nä¹Ÿè¦å°† RUN æŒ‡ä»¤ä¸­ç”Ÿäº§çš„ä¸€äº›é™„å±æ–‡ä»¶åˆ é™¤ä»¥ç¼©å°æœ€ç»ˆé•œåƒçš„å¤§å°\nå¦‚ä¸‹ç¤ºä¾‹\nFROM debian:stretch RUN set -x; buildDeps=\u0026#39;gcc libc6-dev make wget\u0026#39; \\ \u0026amp;\u0026amp; apt-get update \\ \u0026amp;\u0026amp; apt-get install -y $buildDeps \\ \u0026amp;\u0026amp; wget -O redis.tar.gz \u0026#34;http://download.redis.io/releases/redis-5.0.3.tar.gz\u0026#34; \\ \u0026amp;\u0026amp; mkdir -p /usr/src/redis \\ \u0026amp;\u0026amp; tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \\ \u0026amp;\u0026amp; make -C /usr/src/redis \\ \u0026amp;\u0026amp; make -C /usr/src/redis install \\ \u0026amp;\u0026amp; rm -rf /var/lib/apt/lists/* \\ \u0026amp;\u0026amp; rm redis.tar.gz \\ \u0026amp;\u0026amp; rm -r /usr/src/redis \\ \u0026amp;\u0026amp; apt-get purge -y --auto-remove $buildDeps 3 å¤šé˜¶æ®µæ„å»º å¾ˆå¤šæ—¶å€™æˆ‘ä»¬çš„åº”ç”¨å®¹å™¨ä¼šåŒ…å« æ„å»º å’Œ è¿è¡Œ ä¸¤å¤§åŠŸèƒ½ï¼Œè€Œè¿è¡Œæ‰€éœ€è¦çš„ä¾èµ–æ•°é‡æ˜æ˜¾å°‘äºæ„å»ºæ—¶çš„ä¾èµ–ï¼Œæˆ‘ä»¬æœ€ç»ˆçš„ image äº¤ä»˜ç‰©æœ‰è¿è¡Œç¯å¢ƒå°±è¶³å¤Ÿäº†\nåœ¨å¾ˆå¤šçš„åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬éƒ½ä¼šåˆ¶ä½œä¸¤ä¸ª Dockerfile åˆ†åˆ«ç”¨äºæ„å»ºå’Œè¿è¡Œï¼Œæ–‡ä»¶äº¤ä»˜èµ·æ¥ååˆ†éº»çƒ¦\nåœ¨ Docker Engine 17.05 ä¸­å¼•å…¥äº†å¤šé˜¶æ®µæ„å»ºï¼Œä»¥æ­¤é™ä½æ„å»ºå¤æ‚åº¦ï¼ŒåŒæ—¶ä½¿ç¼©å°é•œåƒå°ºå¯¸æ›´ä¸ºç®€å•\nå¦‚ä¸‹ç¤ºä¾‹ï¼Œgo ç¨‹åºç¼–è¯‘å®Œåå‡ ä¹ä¸éœ€è¦ä»»ä½•ä¾èµ–ç¯å¢ƒå³å¯è¿è¡Œ\n# é˜¶æ®µ1 FROM golang:1.16 WORKDIR /go/src COPY app.go ./ RUN go build app.go -o myapp # é˜¶æ®µ2ï¼Œå¼•ç”¨ç©ºé•œåƒ scratch FROM scratch WORKDIR /server # å¤åˆ¶æ–‡ä»¶ï¼Œé€šè¿‡ç¼–å·å¼•ç”¨ï¼Œ0 ä»£è¡¨é˜¶æ®µ 1 COPY --from=0 /go/src/myapp ./ CMD [\u0026#34;./myapp\u0026#34;] ä¸Šè¿°ä¾‹å­å¯ä»¥ä¿®æ”¹ä¸€ä¸‹ï¼Œå¯è¯»æ€§æ›´å¼º\n# é˜¶æ®µ1å‘½åä¸ºbuilder FROM golang:1.16 as builder WORKDIR /go/src COPY app.go ./ RUN go build app.go -o myapp # é˜¶æ®µ2ï¼Œå¼•ç”¨ç©ºé•œåƒ scratch FROM scratch WORKDIR /server # å¤åˆ¶æ–‡ä»¶ï¼Œé€šè¿‡åç§°å¼•ç”¨ COPY --from=builder /go/src/myapp ./ CMD [\u0026#34;./myapp\u0026#34;] åªæ„å»ºæŸä¸ªé˜¶æ®µ\næ„å»ºé•œåƒæ—¶ï¼Œä¸ä¸€å®šéœ€è¦æ„å»ºæ•´ä¸ª Dockerfileï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ --target å‚æ•°æŒ‡å®šæŸä¸ªç›®æ ‡é˜¶æ®µæ„å»ºï¼Œæ¯”å¦‚æˆ‘ä»¬å¼€å‘é˜¶æ®µæˆ‘ä»¬åªæ„å»º builder é˜¶æ®µè¿›è¡Œæµ‹è¯•ã€‚\ndocker build --target builder -t builder_app:v1 . ä½¿ç”¨å¤–éƒ¨é•œåƒ\nCOPY --from httpd:latest /usr/local/apache2/conf/httpd.conf ./httpd.conf ä»ä¸Šä¸€é˜¶æ®µåˆ›å»ºæ–°çš„é˜¶æ®µ\n# é˜¶æ®µ1å‘½åä¸ºbuilder FROM golang:1.16 as builder WORKDIR /go/src COPY app.go ./ RUN go build app.go -o myapp # é˜¶æ®µ2ï¼Œå¼•ç”¨é˜¶æ®µ1å†è¿›è¡Œä¸€æ¬¡æ„å»º FROM builder as builder_ex ADD dest.tar ./ ... ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/docker-dockerfile-optimization/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹å†…å®¹: å¦‚ä½•ç¼–å†™æœ€ä½³çš„ Dockerfile åœ¨ä½¿ç”¨ Docker çš„è¿‡ç¨‹ä¸­ï¼Œç¼–å†™ Dockerfile æ˜¯éå¸¸é‡è¦çš„ä¸€éƒ¨åˆ†å·¥ä½œã€‚åˆç†ç¼–å†™ Dockerfile ä¼šä½¿æˆ‘ä»¬æ„å»ºå‡ºæ¥çš„ Docker image æ‹¥æœ‰æ›´ä½³çš„æ€§èƒ½å’Œå¥å£®æ€§ ç›®æ ‡: æ›´å¿«çš„æ„å»ºé€Ÿåº¦ æ›´å°çš„ Docker é•œåƒå¤§å° æ›´å°‘çš„ Docker é•œåƒå±‚ å……åˆ†åˆ©ç”¨é•œåƒç¼“å­˜ å¢åŠ  Dockerfile å¯è¯»æ€§ è®© Docker å®¹å™¨ä½¿ç”¨èµ·æ¥æ›´ç®€å• æ€»ç»“ ç¼–å†™.dockerignore æ–‡ä»¶","title":"docker | dockerfile æœ€ä½³å®è·µ"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥ï¼š\nDockerfile æŒ‡ä»¤è¯¦è§£ Dockerfile ç”¨äºæ„å»º docker é•œåƒ, å®é™…ä¸Šå°±æ˜¯æŠŠåœ¨ linux ä¸‹çš„å‘½ä»¤æ“ä½œå†™åˆ°äº† Dockerfile ä¸­, é€šè¿‡ Dockerfile å»æ‰§è¡Œè®¾ç½®å¥½çš„æ“ä½œå‘½ä»¤, ä¿è¯é€šè¿‡ Dockerfile çš„æ„å»ºé•œåƒæ˜¯ä¸€è‡´çš„.\nDockerfile æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶, å…¶å†…åŒ…å«äº†ä¸€æ¡æ¡çš„æŒ‡ä»¤ (Instruction), æ¯ä¸€æ¡æŒ‡ä»¤æ„å»ºä¸€å±‚, å› æ­¤æ¯ä¸€æ¡æŒ‡ä»¤çš„å†…å®¹, å°±æ˜¯æè¿°è¯¥å±‚åº”å½“å¦‚ä½•æ„å»º.\n1 FROM æŒ‡å®šåŸºç¡€é•œåƒ å‘½ä»¤æ ¼å¼\nFROM IMAGE[:TAG][@DIGEST] æˆ‘ä»¬å¯ä»¥ç”¨ä»»æ„å·²å­˜åœ¨çš„é•œåƒä¸ºåŸºç¡€æ„å»ºæˆ‘ä»¬çš„è‡ªå®šä¹‰é•œåƒ\næ¯”å¦‚:\nç³»ç»Ÿé•œåƒ: centos, ubuntu, debian, alpine åº”ç”¨é•œåƒ: nginx, redis, mongo, mysql, httpd è¿è¡Œç¯å¢ƒé•œåƒ: php, java, golang å·¥å…·é•œåƒ: busybox ç¤ºä¾‹\n# tag é»˜è®¤ä½¿ç”¨ latest FROM alpine # æŒ‡å®š tag FROM alpine:3.17.3 # æŒ‡å®š digest FROM alpine@sha256:b6ca290b6b4cdcca5b3db3ffa338ee0285c11744b4a6abaa9627746ee3291d8d # åŒæ—¶æŒ‡å®š tag å’Œ digest FROM alpine:3.17.3@sha256:b6ca290b6b4cdcca5b3db3ffa338ee0285c11744b4a6abaa9627746ee3291d8d é™¤äº†é€‰æ‹©ç°æœ‰é•œåƒä¸ºåŸºç¡€é•œåƒå¤–, Docker è¿˜å­˜åœ¨ä¸€ä¸ªç‰¹æ®Šçš„é•œåƒ, åä¸º scratch. è¿™ä¸ªé•œåƒæ— æ³•ä»åˆ«å¤„æ‹‰å–, å¯ä»¥ç†è§£ä¸ºæ˜¯ Docker è‡ª 1.5.0 ç‰ˆæœ¬å¼€å§‹çš„è‡ªå¸¦é•œåƒ, å®ƒä»…åŒ…å«ä¸€ä¸ªç©ºçš„æ–‡ä»¶ç³»ç»Ÿ.\nscratch é•œåƒä¸€èˆ¬ç”¨äºæ„å»ºåŸºç¡€é•œåƒ, æ¯”å¦‚å®˜æ–¹é•œåƒ Ubuntu\n2 COPY å¤åˆ¶æ–‡ä»¶ æ ¼å¼:\nCOPY [--chown=\u0026lt;user\u0026gt;:\u0026lt;group\u0026gt;] \u0026lt;æºè·¯å¾„1\u0026gt; [æºè·¯å¾„2] â€¦ \u0026lt;ç›®æ ‡è·¯å¾„\u0026gt; COPY [--chown=\u0026lt;user\u0026gt;:\u0026lt;group\u0026gt;] [\u0026quot;\u0026lt;æºè·¯å¾„1\u0026gt;\u0026quot;, \u0026quot;[æºè·¯å¾„2]\u0026quot;, â€¦, \u0026quot;\u0026lt;ç›®æ ‡è·¯å¾„\u0026gt;\u0026quot;] COPY æŒ‡ä»¤å°†ä»æ„å»ºä¸Šä¸‹æ–‡ç›®å½•ä¸­ \u0026lt;æºè·¯å¾„\u0026gt; çš„æ–‡ä»¶/ç›®å½•å¤åˆ¶åˆ°æ–°çš„é•œåƒå±‚å†…çš„ \u0026lt;ç›®æ ‡è·¯å¾„\u0026gt; ä½ç½®\n\u0026lt;æºè·¯å¾„\u0026gt; å¯ä»¥æ˜¯å¤šä¸ª, ç”šè‡³å¯ä»¥æ˜¯é€šé…ç¬¦, å…¶é€šé…ç¬¦è§„åˆ™è¦æ»¡è¶³ Go çš„ filepath.Match è§„åˆ™\nCOPY hom* /mydir/ COPY hom?.txt /mydir/ ç›®æ ‡è·¯å¾„ å¯ä»¥æ˜¯å®¹å™¨å†…çš„ç»å¯¹è·¯å¾„, ä¹Ÿå¯ä»¥æ˜¯ç›¸å¯¹äºå·¥ä½œç›®å½•çš„ç›¸å¯¹è·¯å¾„ (å·¥ä½œç›®å½•å¯ä»¥ç”¨ WORKDIR æŒ‡ä»¤æ¥æŒ‡å®š), ç›®æ ‡è·¯å¾„ä¸éœ€è¦äº‹å…ˆåˆ›å»º, å¦‚æœç›®å½•ä¸å­˜åœ¨ä¼šåœ¨å¤åˆ¶æ–‡ä»¶å‰å…ˆè¡Œåˆ›å»ºç¼ºå¤±ç›®å½•\næ­¤å¤–, è¿˜éœ€è¦æ³¨æ„ä¸€ç‚¹, ä½¿ç”¨ COPY æŒ‡ä»¤, æºæ–‡ä»¶çš„å„ç§å…ƒæ•°æ®éƒ½ä¼šä¿ç•™. æ¯”å¦‚è¯»ã€å†™ã€æ‰§è¡Œæƒé™ã€æ–‡ä»¶å˜æ›´æ—¶é—´ç­‰. è¿™ä¸ªç‰¹æ€§å¯¹äºé•œåƒå®šåˆ¶å¾ˆæœ‰ç”¨. ç‰¹åˆ«æ˜¯æ„å»ºç›¸å…³æ–‡ä»¶éƒ½åœ¨ä½¿ç”¨ Git è¿›è¡Œç®¡ç†çš„æ—¶å€™\nåœ¨ä½¿ç”¨è¯¥æŒ‡ä»¤çš„æ—¶å€™è¿˜å¯ä»¥åŠ ä¸Š --chown=\u0026lt;user\u0026gt;:\u0026lt;group\u0026gt; é€‰é¡¹æ¥æ”¹å˜æ–‡ä»¶çš„æ‰€å±ç”¨æˆ·åŠæ‰€å±ç»„.\nCOPY --chown=55:mygroup files* /mydir/ COPY --chown=bin files* /mydir/ COPY --chown=1 files* /mydir/ COPY --chown=10:11 files* /mydir/ 3 ADD æ›´é«˜çº§çš„å¤åˆ¶æ–‡ä»¶ ADD æŒ‡ä»¤å’Œ COPY çš„æ ¼å¼å’Œæ€§è´¨åŸºæœ¬ä¸€è‡´. åŒæ ·æ”¯æŒ --chown=\u0026lt;user\u0026gt;:\u0026lt;group\u0026gt; æŒ‡ä»¤ä¿®æ”¹å±ä¸»å’Œå±ç»„.\nä½†æ˜¯åœ¨ COPY åŸºç¡€ä¸Šå¢åŠ äº†ä¸€äº›åŠŸèƒ½:\n\u0026lt;æºè·¯å¾„\u0026gt; å¯ä»¥æ˜¯ä¸€ä¸ª URL, è¿™ç§æƒ…å†µä¸‹, Docker å¼•æ“ä¼šè¯•å›¾å»ä¸‹è½½è¿™ä¸ªé“¾æ¥çš„æ–‡ä»¶æ”¾åˆ° \u0026lt;ç›®æ ‡è·¯å¾„\u0026gt; å». ä¸‹è½½åçš„æ–‡ä»¶æƒé™è‡ªåŠ¨è®¾ç½®ä¸º 600, å¦‚æœè¿™å¹¶ä¸æ˜¯æƒ³è¦çš„æƒé™, é‚£ä¹ˆè¿˜éœ€è¦å¢åŠ é¢å¤–çš„ä¸€å±‚ RUN è¿›è¡Œæƒé™è°ƒæ•´. å¦‚æœ \u0026lt;æºè·¯å¾„\u0026gt; ä¸ºä¸€ä¸ª tar å‹ç¼©æ–‡ä»¶çš„è¯, å‹ç¼©æ ¼å¼ä¸º gzip, bzip2 ä»¥åŠ xz çš„æƒ…å†µä¸‹, ADD æŒ‡ä»¤å°†ä¼šè‡ªåŠ¨è§£å‹ç¼©è¿™ä¸ªå‹ç¼©æ–‡ä»¶åˆ° \u0026lt;ç›®æ ‡è·¯å¾„\u0026gt; å». Docker å®˜æ–¹è¦æ±‚å°½å¯èƒ½çš„ä½¿ç”¨ COPY, å› ä¸º COPY çš„è¯­ä¹‰å¾ˆæ˜ç¡®, å°±æ˜¯å¤åˆ¶æ–‡ä»¶è€Œå·², è€Œ ADD åˆ™åŒ…å«äº†æ›´å¤æ‚çš„åŠŸèƒ½, å…¶è¡Œä¸ºä¹Ÿä¸ä¸€å®šå¾ˆæ¸…æ™°. æœ€é€‚åˆä½¿ç”¨ ADD çš„åœºåˆ, å°±æ˜¯æ‰€æåŠçš„éœ€è¦è‡ªåŠ¨è§£å‹ç¼©çš„åœºåˆ.\nå¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯, ADD æŒ‡ä»¤ä¼šä»¤é•œåƒæ„å»ºç¼“å­˜å¤±æ•ˆ, ä»è€Œå¯èƒ½ä¼šä»¤é•œåƒæ„å»ºå˜å¾—æ¯”è¾ƒç¼“æ…¢.\n4 RUN æ‰§è¡Œå‘½ä»¤ æ ¼å¼:\nshell æ ¼å¼:RUN [command] \u0026lt;parameter1\u0026gt; \u0026lt;parameter2\u0026gt; â€¦, ç­‰ä»·äºåœ¨ linux ä¸­æ‰§è¡Œ /bin/sh -c \u0026quot;command parameter1 parameter2 â€¦\u0026quot;\nRUN ls -l exec æ ¼å¼:RUN [\u0026quot;command\u0026quot;, \u0026quot;parameter1\u0026quot;, \u0026quot;parameter2\u0026quot;â€¦], ä¸ä¼šé€šè¿‡ shell æ‰§è¡Œ, æ‰€ä»¥åƒ $HOME è¿™æ ·çš„å˜é‡å°±æ— æ³•è·å–.\nRUN [\u0026#34;ls\u0026#34;, \u0026#34;-l\u0026#34;] RUN [\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;ls -l\u0026#34;] # å¯ä»¥è·å–ç¯å¢ƒå˜é‡ RUN æŒ‡ä»¤ç”¨äºæŒ‡å®šæ„å»ºé•œåƒæ—¶æ‰§è¡Œçš„å‘½ä»¤, Dockerfile å…è®¸å¤šä¸ª RUN æŒ‡ä»¤, å¹¶ä¸”æ¯ä¸ª RUN æŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªé•œåƒå±‚.\nRUN æŒ‡ä»¤ä¸€èˆ¬ç”¨äºå®‰è£…é…ç½®è½¯ä»¶åŒ…ç­‰æ“ä½œ, ä¸ºé¿å…é•œåƒå±‚æ•°è¿‡å¤š, ä¸€èˆ¬ RUN æŒ‡ä»¤ä½¿ç”¨ shell æ ¼å¼ä¸”ä½¿ç”¨æ¢è¡Œç¬¦æ¥æ‰§è¡Œå¤šä¸ªå‘½ä»¤, ä¸”å°½é‡å°† RUN æŒ‡ä»¤äº§ç”Ÿçš„é™„å±ç‰©åˆ é™¤ä»¥ç¼©å°é•œåƒå¤§å°\nå¦‚ä¸‹ç¤ºä¾‹\nFROM debian:stretch RUN set -x; buildDeps=\u0026#39;gcc libc6-dev make wget\u0026#39; \\ \u0026amp;\u0026amp; apt-get update \\ \u0026amp;\u0026amp; apt-get install -y $buildDeps \\ \u0026amp;\u0026amp; wget -O redis.tar.gz \u0026#34;http://download.redis.io/releases/redis-5.0.3.tar.gz\u0026#34; \\ \u0026amp;\u0026amp; mkdir -p /usr/src/redis \\ \u0026amp;\u0026amp; tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \\ \u0026amp;\u0026amp; make -C /usr/src/redis \\ \u0026amp;\u0026amp; make -C /usr/src/redis install \\ \u0026amp;\u0026amp; rm -rf /var/lib/apt/lists/* \\ \u0026amp;\u0026amp; rm redis.tar.gz \\ \u0026amp;\u0026amp; rm -r /usr/src/redis \\ \u0026amp;\u0026amp; apt-get purge -y --auto-remove $buildDeps 5 CMD å®¹å™¨å¯åŠ¨å‘½ä»¤ CMD æŒ‡ä»¤çš„æ ¼å¼å’Œ RUN ç›¸ä¼¼, ä¹Ÿæ˜¯ä¸¤ç§æ ¼å¼ï¼š\nshell æ ¼å¼ï¼šCMD [command] \u0026lt;parameters\u0026gt; exec æ ¼å¼ï¼šCMD [\u0026quot;command\u0026quot;, \u0026quot;\u0026lt;parameter1\u0026gt;\u0026quot;, \u0026quot;parameter2\u0026quot;, â€¦] å‚æ•°åˆ—è¡¨æ ¼å¼ï¼šCMD [\u0026quot;å‚æ•°1\u0026quot;, \u0026quot;å‚æ•°2\u0026quot;â€¦]. åœ¨æŒ‡å®šäº† ENTRYPOINT æŒ‡ä»¤å, ç”¨ CMD æŒ‡å®šå…·ä½“çš„å‚æ•°. CMD æŒ‡ä»¤ç”¨äºè®¾ç½®å®¹å™¨å¯åŠ¨æ—¶ é»˜è®¤æ‰§è¡Œ çš„æŒ‡ä»¤, ä¸€èˆ¬ä¼šè®¾ç½®ä¸ºåº”ç”¨ç¨‹åºçš„å¯åŠ¨è„šæœ¬æˆ–è€…å·¥å…·é•œåƒçš„ bash, è®¾ç½®äº†å¤šæ¡ CMD æŒ‡ä»¤æ—¶, åªæœ‰æœ€åä¸€æ¡ CMD ä¼šè¢«æ‰§è¡Œ.\nåœ¨è¿è¡Œæ—¶å¯ä»¥æŒ‡å®šæ–°çš„å‘½ä»¤æ¥æ›¿ä»£é•œåƒè®¾ç½®ä¸­çš„è¿™ä¸ªé»˜è®¤å‘½ä»¤, æ¯”å¦‚, ubuntu é•œåƒé»˜è®¤çš„ CMD æ˜¯ /bin/bash, å¦‚æœæˆ‘ä»¬ç›´æ¥ docker run -it ubuntu çš„è¯, ä¼šç›´æ¥è¿›å…¥ bash. æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨è¿è¡Œæ—¶æŒ‡å®šè¿è¡Œåˆ«çš„å‘½ä»¤, å¦‚ docker run -it ubuntu cat /etc/os-release. è¿™å°±æ˜¯ç”¨ cat /etc/os-release å‘½ä»¤æ›¿æ¢äº†é»˜è®¤çš„ /bin/bash å‘½ä»¤äº†, ä¼šè¾“å‡ºç³»ç»Ÿç‰ˆæœ¬ä¿¡æ¯.\nåœ¨æŒ‡ä»¤æ ¼å¼ä¸Š, ä¸€èˆ¬æ¨èä½¿ç”¨ exec æ ¼å¼, è¿™ç±»æ ¼å¼åœ¨è§£ææ—¶ä¼šè¢«è§£æä¸º JSON æ•°ç»„, å› æ­¤ä¸€å®šè¦ä½¿ç”¨åŒå¼•å· \u0026quot;, è€Œä¸è¦ä½¿ç”¨å•å¼•å·.\nä¾‹å¦‚ä¸€èˆ¬ nginx å®¹å™¨çš„ CMD æŒ‡ä»¤:\nCMD [\u0026#34;nginx\u0026#34;, \u0026#34;-g\u0026#34;, \u0026#34;daemon off;\u0026#34;] 6 ENTRYPOINT å…¥å£ç‚¹ ENTRYPOINT çš„æ ¼å¼å’Œ RUN æŒ‡ä»¤æ ¼å¼ä¸€æ ·, åˆ†ä¸º exec æ ¼å¼å’Œ shell æ ¼å¼.\nshell æ ¼å¼ï¼šENTRYPOINT [command] \u0026lt;parameters\u0026gt; exec æ ¼å¼ï¼šENTRYPOINT [\u0026quot;command\u0026quot;, \u0026quot;\u0026lt;parameter1\u0026gt;\u0026quot;, \u0026quot;\u0026lt;parameter2\u0026gt;\u0026quot;, â€¦] ENTRYPOINT çš„ç›®çš„å’Œ CMD ä¸€æ ·, éƒ½æ˜¯åœ¨æŒ‡å®šå®¹å™¨å¯åŠ¨ç¨‹åºåŠå‚æ•°. ENTRYPOINT åœ¨è¿è¡Œæ—¶ä¹Ÿå¯ä»¥æ›¿ä»£, ä¸è¿‡æ¯” CMD è¦ç•¥æ˜¾ç¹ç, éœ€è¦é€šè¿‡ docker run çš„å‚æ•° --entrypoint æ¥æŒ‡å®š.\nå½“æŒ‡å®šäº† ENTRYPOINT ä¸”ä½¿ç”¨çš„æ˜¯ exec æ ¼å¼æ—¶, CMD çš„å«ä¹‰å°±å‘ç”Ÿäº†æ”¹å˜, ä¸å†æ˜¯ç›´æ¥çš„è¿è¡Œå…¶å‘½ä»¤, è€Œæ˜¯å°† CMD çš„å†…å®¹ä½œä¸ºå‚æ•°ä¼ ç»™ ENTRYPOINT æŒ‡ä»¤, æ¢å¥è¯è¯´å®é™…æ‰§è¡Œæ—¶, å°†å˜ä¸ºï¼š\nENTRYPOINT [\u0026#34;command\u0026#34;, \u0026#34;\u0026lt;parameter1\u0026gt;\u0026#34;, \u0026#34;\u0026lt;parameter2\u0026gt;\u0026#34;, \u0026#34;CMD\u0026#34;] ä»¥ä¸‹ç¤ºä¾‹å°†å±•ç¤º CMD æŒ‡ä»¤ä½œä¸ºå‚æ•°ä¼ ç»™ ENTRYPOINT çš„åœºæ™¯\nåœºæ™¯ä¸€ï¼šæˆ‘ä»¬è‡ªå·±æ„å»ºäº†ä¸€ä¸ªç”¨äºæŸ¥çœ‹å¤–ç½‘ ip å’Œå½’å±åœ°çš„é•œåƒ\nFROM alpine RUN sed -i \u0026#39;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g\u0026#39; /etc/apk/repositories \\ \u0026amp;\u0026amp; apk --update add curl CMD [ \u0026#34;-s\u0026#34; ] ENTRYPOINT [ \u0026#34;curl\u0026#34;, \u0026#34;http://myip.ipip.net\u0026#34; ] æ„å»º\ndocker build -t busybox-curl . ä»¥ä¸¤ç§æ–¹å¼è¿è¡Œ\n# å®¹å™¨ä¸­å®é™…æ‰§è¡Œçš„æŒ‡ä»¤ä¸º curl http://myip.ipip.net -s [root@lvbibir learn]# docker run -it --rm busybox-curl å½“å‰ IPï¼š101.201.150.47 æ¥è‡ªäºï¼šä¸­å›½ åŒ—äº¬ åŒ—äº¬ é˜¿é‡Œäº‘ # å®¹å™¨ä¸­å®é™…æ‰§è¡Œçš„æŒ‡ä»¤ä¸º curl http://myip.ipip.net -i [root@lvbibir learn]# docker run -it --rm busybox-curl -i HTTP/1.1 200 OK Date: Mon, 10 Apr 2023 03:21:59 GMT Content-Type: text/plain; charset=utf-8 Content-Length: 72 Connection: keep-alive Node: ipip-myip5 X-Cache: BYPASS X-Request-Id: e309720b9197e8b94cec18b409c69d1d Server: WAF Connection: close Accept-Ranges: bytes å½“å‰ IPï¼š101.201.150.47 æ¥è‡ªäºï¼šä¸­å›½ åŒ—äº¬ åŒ—äº¬ é˜¿é‡Œäº‘ åœºæ™¯äºŒï¼šåº”ç”¨è¿è¡Œå‰çš„å‡†å¤‡å·¥ä½œ\nå¯åŠ¨å®¹å™¨å°±æ˜¯å¯åŠ¨ä¸»è¿›ç¨‹, ä½†æœ‰äº›æ—¶å€™, å¯åŠ¨ä¸»è¿›ç¨‹å‰, éœ€è¦ä¸€äº›å‡†å¤‡å·¥ä½œ.\næ¯”å¦‚ mysql ç±»çš„æ•°æ®åº“, å¯èƒ½éœ€è¦ä¸€äº›æ•°æ®åº“é…ç½®ã€åˆå§‹åŒ–çš„å·¥ä½œ, è¿™äº›å·¥ä½œè¦åœ¨æœ€ç»ˆçš„ mysql æœåŠ¡å™¨è¿è¡Œä¹‹å‰è§£å†³.\næ­¤å¤–, å¯èƒ½å¸Œæœ›é¿å…ä½¿ç”¨ root ç”¨æˆ·å»å¯åŠ¨æœåŠ¡, ä»è€Œæé«˜å®‰å…¨æ€§, è€Œåœ¨å¯åŠ¨æœåŠ¡å‰è¿˜éœ€è¦ä»¥ root èº«ä»½æ‰§è¡Œä¸€äº›å¿…è¦çš„å‡†å¤‡å·¥ä½œ, æœ€ååˆ‡æ¢åˆ°æœåŠ¡ç”¨æˆ·èº«ä»½å¯åŠ¨æœåŠ¡. æˆ–è€…é™¤äº†æœåŠ¡å¤–, å…¶å®ƒå‘½ä»¤ä¾æ—§å¯ä»¥ä½¿ç”¨ root èº«ä»½æ‰§è¡Œ, æ–¹ä¾¿è°ƒè¯•ç­‰.\nè¿™äº›å‡†å¤‡å·¥ä½œæ˜¯å’Œå®¹å™¨ CMD æ— å…³çš„, æ— è®º CMD ä¸ºä»€ä¹ˆ, éƒ½éœ€è¦äº‹å…ˆè¿›è¡Œä¸€ä¸ªé¢„å¤„ç†çš„å·¥ä½œ. è¿™ç§æƒ…å†µä¸‹, å¯ä»¥å†™ä¸€ä¸ªè„šæœ¬, ç„¶åæ”¾å…¥ ENTRYPOINT ä¸­å»æ‰§è¡Œ, è€Œè¿™ä¸ªè„šæœ¬ä¼šå°†æ¥åˆ°çš„å‚æ•°ï¼ˆä¹Ÿå°±æ˜¯ \u0026lt;CMD\u0026gt;ï¼‰ä½œä¸ºå‘½ä»¤, åœ¨è„šæœ¬æœ€åæ‰§è¡Œ. æ¯”å¦‚å®˜æ–¹é•œåƒ redis ä¸­å°±æ˜¯è¿™ä¹ˆåšçš„ï¼š\nFROM alpine:3.4 ... RUN addgroup -S redis \u0026amp;\u0026amp; adduser -S -G redis redis ... ENTRYPOINT [\u0026#34;docker-entrypoint.sh\u0026#34;] EXPOSE 6379 CMD [ \u0026#34;redis-server\u0026#34; ] å¯ä»¥çœ‹åˆ°å…¶ä¸­ä¸ºäº† redis æœåŠ¡åˆ›å»ºäº† redis ç”¨æˆ·, å¹¶åœ¨æœ€åæŒ‡å®šäº† ENTRYPOINT ä¸º docker-entrypoint.sh è„šæœ¬ï¼š\n#!/bin/sh ... # allow the container to be started with `--user` if [ \u0026#34;$1\u0026#34; = \u0026#39;redis-server\u0026#39; -a \u0026#34;$(id -u)\u0026#34; = \u0026#39;0\u0026#39; ]; then find . \\! -user redis -exec chown redis \u0026#39;{}\u0026#39; + exec gosu redis \u0026#34;$0\u0026#34; \u0026#34;$@\u0026#34; fi exec \u0026#34;$@\u0026#34; è¯¥è„šæœ¬çš„å†…å®¹å°±æ˜¯æ ¹æ® CMD çš„å†…å®¹æ¥åˆ¤æ–­, å¦‚æœæ˜¯ redis-server çš„è¯, åˆ™åˆ‡æ¢åˆ° redis ç”¨æˆ·èº«ä»½å¯åŠ¨æœåŠ¡å™¨, å¦åˆ™ä¾æ—§ä½¿ç”¨ root èº«ä»½æ‰§è¡Œ. æ¯”å¦‚ï¼š\n[root@lvbibir learn]# docker run -it redis id uid=0(root) gid=0(root) groups=0(root) 7 ENV è®¾ç½®ç¯å¢ƒå˜é‡ æ ¼å¼æœ‰ä¸¤ç§ï¼š\nENV \u0026lt;key\u0026gt; \u0026lt;value\u0026gt; ENV \u0026lt;key1\u0026gt;=\u0026lt;value1\u0026gt; \u0026lt;key2\u0026gt;=\u0026lt;value2\u0026gt;â€¦ ENV ç”¨äºè®¾ç½®ç¯å¢ƒå˜é‡, æ—¢å¯ä»¥åœ¨ Dockerfile ä¸­è°ƒç”¨, ä¹Ÿå¯ä»¥åœ¨æ„å»ºå®Œçš„å®¹å™¨è¿è¡Œæ—¶ä¸­ä½¿ç”¨.\næ”¯æŒçš„æŒ‡ä»¤ï¼š ADDã€COPYã€ENVã€EXPOSEã€FROMã€LABELã€USERã€WORKDIRã€VOLUMEã€STOPSIGNALã€ONBUILDã€RUN\nä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­æ¼”ç¤ºäº†å¦‚ä½•æ¢è¡Œ, ä»¥åŠå¯¹å«æœ‰ç©ºæ ¼çš„å€¼ç”¨åŒå¼•å·æ‹¬èµ·æ¥çš„åŠæ³•, è¿™å’Œ Shell ä¸‹çš„è¡Œä¸ºæ˜¯ä¸€è‡´çš„.\nENV VERSION=1.0 DEBUG=on \\ NAME=\u0026#34;Happy Feet\u0026#34; ç¤ºä¾‹\nFROM alpine ENV VERSION=1.0 \\ DEBUG=on \\ NAME=\u0026#34;Happy Feet\u0026#34; RUN echo \u0026#34;name: ${NAME}\u0026#34; \u0026gt; /test \\ \u0026amp;\u0026amp; echo \u0026#34;version: ${VERSION}\u0026#34; \u0026gt;\u0026gt; /test æ„å»º\n[root@lvbibir learn]# docker build -t demo-env . æ„å»ºæ—¶è°ƒç”¨äº†ç¯å¢ƒå˜é‡\n[root@lvbibir learn]# docker run -it --rm demo-env cat /test name: Happy Feet version: 1.0 æ„å»ºåçš„å®¹å™¨è¿è¡Œæ—¶ä¸­è°ƒç”¨, è¿™é‡Œéœ€è¦ä½¿ç”¨ /bin/sh -c çš„æ–¹å¼, ä¸ç„¶æ— æ³•è¯»å–å˜é‡. ä¸”å¯¹ $ è¿›è¡Œè½¬ä¹‰, ä¸ç„¶è¯»å–çš„å°†ä¼šæ˜¯å®¿ä¸»æœºçš„å˜é‡\n[root@lvbibir learn]# docker run -it --rm demo-env /bin/sh -c \u0026#34;echo \\${DEBUG}\u0026#34; on 8 ARG æ„å»ºå‚æ•° æ„å»ºå‚æ•°å’Œ ENV çš„æ•ˆæœä¸€æ ·, éƒ½æ˜¯è®¾ç½®ç¯å¢ƒå˜é‡. æ‰€ä¸åŒçš„æ˜¯, ARG æ‰€è®¾ç½®çš„æ„å»ºç¯å¢ƒçš„ç¯å¢ƒå˜é‡, åœ¨å°†æ¥å®¹å™¨è¿è¡Œæ—¶æ˜¯ä¸ä¼šå­˜åœ¨è¿™äº›ç¯å¢ƒå˜é‡çš„. ä½†æ˜¯ä¸è¦å› æ­¤å°±ä½¿ç”¨ ARG ä¿å­˜å¯†ç ä¹‹ç±»çš„ä¿¡æ¯, å› ä¸º docker history è¿˜æ˜¯å¯ä»¥çœ‹åˆ°æ‰€æœ‰å€¼çš„.\nDockerfile ä¸­çš„ ARG æŒ‡ä»¤æ˜¯å®šä¹‰å‚æ•°åç§°, ä»¥åŠå®šä¹‰å…¶é»˜è®¤å€¼. è¯¥é»˜è®¤å€¼å¯ä»¥åœ¨æ„å»ºå‘½ä»¤ docker build ä¸­ç”¨ --build-arg \u0026lt;å‚æ•°å\u0026gt;=\u0026lt;å€¼\u0026gt; æ¥è¦†ç›–.\nçµæ´»çš„ä½¿ç”¨ ARG æŒ‡ä»¤, èƒ½å¤Ÿåœ¨ä¸ä¿®æ”¹ Dockerfile çš„æƒ…å†µä¸‹, æ„å»ºå‡ºä¸åŒçš„é•œåƒ.\nARG æŒ‡ä»¤æœ‰ç”Ÿæ•ˆèŒƒå›´, å¦‚æœåœ¨ FROM æŒ‡ä»¤ä¹‹å‰æŒ‡å®š, é‚£ä¹ˆåªèƒ½ç”¨äº FROM æŒ‡ä»¤ä¸­, FROM æŒ‡ä»¤å¯ä»¥æ˜¯å¤šä¸ª\nARG DOCKER_USERNAME=library FROM ${DOCKER_USERNAME}/alpine RUN set -x ; echo ${DOCKER_USERNAME} ä½¿ç”¨ä¸Šè¿° Dockerfile ä¼šå‘ç°æ— æ³•è¾“å‡º ${DOCKER_USERNAME} å˜é‡çš„å€¼, è¦æƒ³æ­£å¸¸è¾“å‡º, ä½ å¿…é¡»åœ¨ FROM ä¹‹åå†æ¬¡æŒ‡å®š ARG, å¦‚ä¸‹ç¤ºä¾‹\n# åªåœ¨ FROM ä¸­ç”Ÿæ•ˆ ARG DOCKER_USERNAME=library FROM ${DOCKER_USERNAME}/alpine # è¦æƒ³åœ¨ FROM ä¹‹åä½¿ç”¨, å¿…é¡»å†æ¬¡æŒ‡å®š ARG DOCKER_USERNAME=library RUN set -x ; echo ${DOCKER_USERNAME} å¦‚ä¸‹ç¤ºä¾‹, å˜é‡å°†ä¼šåœ¨æ¯ä¸ª FROM æŒ‡ä»¤ä¸­ç”Ÿæ•ˆ\n# è¿™ä¸ªå˜é‡åœ¨æ¯ä¸ª FROM ä¸­éƒ½ç”Ÿæ•ˆ ARG DOCKER_USERNAME=library FROM ${DOCKER_USERNAME}/alpine RUN set -x ; echo 1 FROM ${DOCKER_USERNAME}/alpine RUN set -x ; echo 2 å¦‚ä¸‹ç¤ºä¾‹, å¯¹äºåœ¨å„ä¸ªé˜¶æ®µä¸­ä½¿ç”¨çš„å˜é‡éƒ½å¿…é¡»åœ¨æ¯ä¸ªé˜¶æ®µåˆ†åˆ«æŒ‡å®š\nARG DOCKER_USERNAME=library FROM ${DOCKER_USERNAME}/alpine # åœ¨FROM ä¹‹åä½¿ç”¨å˜é‡, å¿…é¡»åœ¨æ¯ä¸ªé˜¶æ®µåˆ†åˆ«æŒ‡å®š ARG DOCKER_USERNAME=library RUN set -x ; echo ${DOCKER_USERNAME} FROM ${DOCKER_USERNAME}/alpine # åœ¨FROM ä¹‹åä½¿ç”¨å˜é‡, å¿…é¡»åœ¨æ¯ä¸ªé˜¶æ®µåˆ†åˆ«æŒ‡å®š ARG DOCKER_USERNAME=library RUN set -x ; echo ${DOCKER_USERNAME} 9 VOLUME å®šä¹‰åŒ¿åå· æ ¼å¼ä¸ºï¼š\nVOLUME [\u0026quot;\u0026lt;è·¯å¾„1\u0026gt;\u0026quot;, \u0026quot;\u0026lt;è·¯å¾„2\u0026gt;\u0026quot;â€¦] VOLUME \u0026lt;è·¯å¾„\u0026gt; å®¹å™¨è¿è¡Œæ—¶åº”è¯¥å°½é‡ä¿æŒå®¹å™¨å­˜å‚¨å±‚ä¸å‘ç”Ÿå†™æ“ä½œ, å¯¹äºæ•°æ®åº“ç±»éœ€è¦ä¿å­˜åŠ¨æ€æ•°æ®çš„åº”ç”¨, å…¶æ•°æ®åº“æ–‡ä»¶åº”è¯¥ä¿å­˜äºå· (volume) ä¸­.\nä¸ºäº†é˜²æ­¢è¿è¡Œæ—¶ç”¨æˆ·å¿˜è®°å°†åŠ¨æ€æ–‡ä»¶æ‰€ä¿å­˜ç›®å½•æŒ‚è½½ä¸ºå·, åœ¨ Dockerfile ä¸­, æˆ‘ä»¬å¯ä»¥äº‹å…ˆæŒ‡å®šæŸäº›ç›®å½•æŒ‚è½½ä¸ºåŒ¿åå·, è¿™æ ·åœ¨è¿è¡Œæ—¶å¦‚æœç”¨æˆ·ä¸æŒ‡å®šæŒ‚è½½, å…¶åº”ç”¨ä¹Ÿå¯ä»¥æ­£å¸¸è¿è¡Œ, ä¸ä¼šå‘å®¹å™¨å­˜å‚¨å±‚å†™å…¥å¤§é‡æ•°æ®, ä»è€Œä¿è¯äº†å®¹å™¨å­˜å‚¨å±‚çš„æ— çŠ¶æ€åŒ–.\nVOLUME åˆ›å»ºçš„åŒ¿åå·ä¼šæŒ‚è½½åˆ°ç³»ç»Ÿ /var/lib/docker/volumes/\u0026lt;CONTAINER-ID\u0026gt;/\u0026lt;_VOLUME\u0026gt; ç›®å½•ä¸‹, ä¸”ä¸ä¼šéšç€å®¹å™¨åˆ é™¤è€Œåˆ é™¤, éœ€è¦æ‰‹åŠ¨åˆ é™¤\nå¦‚ä¸‹ç¤ºä¾‹\nFROM alpine VOLUME /data æ„å»ºè¿è¡Œ\n[root@lvbibir learn]# docker build -t demo-volume . [root@lvbibir learn]# docker run -itd --name=demo-volume demo-volume [root@lvbibir learn]# docker exec -it demo-volume ls -ld /data drwxr-xr-x 2 root root 4096 Apr 10 05:24 /data æŸ¥çœ‹æŒ‚è½½ç›®å½•\n[root@lvbibir learn]# docker inspect --format=\u0026#39;{{json .Mounts}}\u0026#39; demo-volume | python -m json.tool [ { \u0026#34;Destination\u0026#34;: \u0026#34;/data\u0026#34;, \u0026#34;Driver\u0026#34;: \u0026#34;local\u0026#34;, \u0026#34;Mode\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;Name\u0026#34;: \u0026#34;49cf915dd297292e3d0e4b2c7a66ead6875cfb0dbd010de15189040ab1158b3b\u0026#34;, \u0026#34;Propagation\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;RW\u0026#34;: true, \u0026#34;Source\u0026#34;: \u0026#34;/var/lib/docker/volumes/49cf915dd297292e3d0e4b2c7a66ead6875cfb0dbd010de15189040ab1158b3b/_data\u0026#34;, \u0026#34;Type\u0026#34;: \u0026#34;volume\u0026#34; } ] å¦‚ä¸‹ç¤ºä¾‹, è¿è¡Œå®¹å™¨æ—¶, å¯ä»¥æŒ‡å®š -v å‚æ•°å°†ç›®å½•æŒ‚è½½åˆ°æŒ‡å®šä½ç½®\n[root@lvbibir learn]# docker run -itd -v /mydata:/data --name demo-volume-2 demo-volume [root@lvbibir learn]# docker inspect --format=\u0026#39;{{json .Mounts}}\u0026#39; demo-volume-2 | python -m json.tool [ { \u0026#34;Destination\u0026#34;: \u0026#34;/data\u0026#34;, \u0026#34;Mode\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;Propagation\u0026#34;: \u0026#34;rprivate\u0026#34;, \u0026#34;RW\u0026#34;: true, \u0026#34;Source\u0026#34;: \u0026#34;/mydata\u0026#34;, \u0026#34;Type\u0026#34;: \u0026#34;bind\u0026#34; } ] 10 EXPOSE æš´éœ²ç«¯å£ æ ¼å¼ä¸º EXPOSE \u0026lt;ç«¯å£1\u0026gt; [ç«¯å£2] â€¦\nEXPOSE æŒ‡ä»¤æ˜¯å£°æ˜å®¹å™¨è¿è¡Œæ—¶æä¾›æœåŠ¡çš„ç«¯å£, è¿™åªæ˜¯ä¸€ä¸ªå£°æ˜, åœ¨å®¹å™¨è¿è¡Œæ—¶å¹¶ä¸ä¼šå› ä¸ºè¿™ä¸ªå£°æ˜åº”ç”¨å°±ä¼šå¼€å¯è¿™ä¸ªç«¯å£çš„æœåŠ¡\nåœ¨ Dockerfile ä¸­å†™å…¥è¿™æ ·çš„å£°æ˜æœ‰ä¸¤ä¸ªå¥½å¤„ï¼š\nä¸€ä¸ªæ˜¯å¸®åŠ©é•œåƒä½¿ç”¨è€…ç†è§£è¿™ä¸ªé•œåƒæœåŠ¡çš„å®ˆæŠ¤ç«¯å£, ä»¥æ–¹ä¾¿é…ç½®æ˜ å°„ï¼› å¦ä¸€ä¸ªç”¨å¤„åˆ™æ˜¯åœ¨è¿è¡Œæ—¶ä½¿ç”¨éšæœºç«¯å£æ˜ å°„æ—¶, ä¹Ÿå°±æ˜¯ docker run -P æ—¶, ä¼šè‡ªåŠ¨éšæœºæ˜ å°„ EXPOSE çš„ç«¯å£. è¦å°† EXPOSE å’Œåœ¨è¿è¡Œæ—¶ä½¿ç”¨ -p \u0026lt;å®¿ä¸»ç«¯å£\u0026gt;:\u0026lt;å®¹å™¨ç«¯å£\u0026gt; åŒºåˆ†å¼€æ¥. -p, æ˜¯æ˜ å°„å®¿ä¸»ç«¯å£å’Œå®¹å™¨ç«¯å£, æ¢å¥è¯è¯´, å°±æ˜¯å°†å®¹å™¨çš„å¯¹åº”ç«¯å£æœåŠ¡å…¬å¼€ç»™å¤–ç•Œè®¿é—®, è€Œ EXPOSE ä»…ä»…æ˜¯å£°æ˜å®¹å™¨æ‰“ç®—ä½¿ç”¨ä»€ä¹ˆç«¯å£è€Œå·², å¹¶ä¸ä¼šè‡ªåŠ¨åœ¨å®¿ä¸»è¿›è¡Œç«¯å£æ˜ å°„.\n11 WORKDIR æŒ‡å®šå·¥ä½œç›®å½• æ ¼å¼ä¸º WORKDIR \u0026lt;è·¯å¾„\u0026gt;\nä½¿ç”¨ WORKDIR æŒ‡ä»¤å¯ä»¥æ¥æŒ‡å®šå·¥ä½œç›®å½•ï¼ˆæˆ–è€…ç§°ä¸ºå½“å‰ç›®å½•ï¼‰, ä»¥åå„å±‚çš„å½“å‰ç›®å½•å°±è¢«æ”¹ä¸ºæŒ‡å®šçš„ç›®å½•, å¦‚è¯¥ç›®å½•ä¸å­˜åœ¨, WORKDIR ä¼šå¸®ä½ å»ºç«‹ç›®å½•\nå¦‚ä¸‹ç¤ºä¾‹, æ˜¯ä¸€ä¸ªå¸¸è§çš„é”™è¯¯, world.txt æœ€ç»ˆä¼šåœ¨ /app ç›®å½•ä¸‹, è€Œä¸æ˜¯æœŸæœ›çš„ /app/demo ç›®å½•\nWORKDIR /app RUN mkdir demo \u0026amp;\u0026amp; cd demo RUN echo \u0026#34;hello\u0026#34; \u0026gt; world.txt ä¸Šè¿°éœ€æ±‚å¯ä»¥è¿›è¡Œå¦‚ä¸‹ä¼˜åŒ–, æ¨èä½¿ç”¨ç¬¬äºŒç§å†™æ³•\nWORKDIR /app/demo RUN echo \u0026#34;hello\u0026#34; \u0026gt; world.txt # æˆ–è€… WORKDIR /app RUN mkdir demo \\ \u0026amp;\u0026amp; echo \u0026#34;hello\u0026#34; \u0026gt; demo/world.txt # æˆ–è€… WORKDIR /app RUN mkdir demo \\ \u0026amp;\u0026amp; cd demo \\ \u0026amp;\u0026amp; echo \u0026#34;hello\u0026#34; \u0026gt; demo/world.txt å¦‚æœä½ çš„ WORKDIR æŒ‡ä»¤ä½¿ç”¨çš„ç›¸å¯¹è·¯å¾„, é‚£ä¹ˆæ‰€åˆ‡æ¢çš„è·¯å¾„ä¸ä¹‹å‰çš„ WORKDIR æœ‰å…³\nå¦‚ä¸‹ç¤ºä¾‹, pwd çš„è¾“å‡ºå°†ä¼šæ˜¯ /a/b/c\nWORKDIR /a WORKDIR b WORKDIR c RUN pwd 12 USER æŒ‡å®šå½“å‰ç”¨æˆ· æ ¼å¼ï¼šUSER \u0026lt;ç”¨æˆ·å\u0026gt;[:\u0026lt;ç”¨æˆ·ç»„\u0026gt;]\nUSER æŒ‡ä»¤å’Œ WORKDIR ç›¸ä¼¼, éƒ½æ˜¯æ”¹å˜ç¯å¢ƒçŠ¶æ€å¹¶å½±å“ä»¥åçš„å±‚. WORKDIR æ˜¯æ”¹å˜å·¥ä½œç›®å½•, USER åˆ™æ˜¯æ”¹å˜ä¹‹åå±‚çš„æ‰§è¡Œ RUN, CMD ä»¥åŠ ENTRYPOINT è¿™ç±»å‘½ä»¤çš„èº«ä»½.\næ³¨æ„, USER åªæ˜¯å¸®åŠ©ä½ åˆ‡æ¢åˆ°æŒ‡å®šç”¨æˆ·è€Œå·², è¿™ä¸ªç”¨æˆ·å¿…é¡»æ˜¯äº‹å…ˆå»ºç«‹å¥½çš„, å¦åˆ™æ— æ³•åˆ‡æ¢.\nRUN groupadd -r redis \u0026amp;\u0026amp; useradd -r -g redis redis USER redis RUN [ \u0026#34;redis-server\u0026#34; ] å¦‚æœä»¥ root æ‰§è¡Œçš„è„šæœ¬, åœ¨æ‰§è¡ŒæœŸé—´å¸Œæœ›æ”¹å˜èº«ä»½, æ¯”å¦‚å¸Œæœ›ä»¥æŸä¸ªå·²ç»å»ºç«‹å¥½çš„ç”¨æˆ·æ¥è¿è¡ŒæŸä¸ªæœåŠ¡è¿›ç¨‹, ä¸è¦ä½¿ç”¨ su æˆ–è€… sudo, è¿™äº›éƒ½éœ€è¦æ¯”è¾ƒéº»çƒ¦çš„é…ç½®, è€Œä¸”åœ¨ TTY ç¼ºå¤±çš„ç¯å¢ƒä¸‹ç»å¸¸å‡ºé”™. å»ºè®®ä½¿ç”¨ gosu\nä¸è¿‡æ›´æ¨èçš„è¿˜æ˜¯ ä¸Šæ–‡ ä¸­æåˆ°è¿‡çš„é€šè¿‡ ENTRYPOINT è„šæœ¬çš„æ–¹å¼\nä½¿ç”¨ gosu ç¤ºä¾‹\n# å»ºç«‹ redis ç”¨æˆ·, å¹¶ä½¿ç”¨ gosu æ¢å¦ä¸€ä¸ªç”¨æˆ·æ‰§è¡Œå‘½ä»¤ RUN groupadd -r redis \u0026amp;\u0026amp; useradd -r -g redis redis # ä¸‹è½½ gosu RUN wget -O /usr/local/bin/gosu \u0026#34;https://github.com/tianon/gosu/releases/download/1.12/gosu-amd64\u0026#34; \\ \u0026amp;\u0026amp; chmod +x /usr/local/bin/gosu \\ \u0026amp;\u0026amp; gosu nobody true # è®¾ç½® CMD, å¹¶ä»¥å¦å¤–çš„ç”¨æˆ·æ‰§è¡Œ CMD [ \u0026#34;exec\u0026#34;, \u0026#34;gosu\u0026#34;, \u0026#34;redis\u0026#34;, \u0026#34;redis-server\u0026#34; ] 13 HEALTHCHECK å¥åº·æ£€æŸ¥ æ ¼å¼ï¼š\nHEALTHCHECK [é€‰é¡¹] CMD \u0026lt;å‘½ä»¤\u0026gt;ï¼šè®¾ç½®æ£€æŸ¥å®¹å™¨å¥åº·çŠ¶å†µçš„å‘½ä»¤ HEALTHCHECK NONEï¼šå¦‚æœåŸºç¡€é•œåƒæœ‰å¥åº·æ£€æŸ¥æŒ‡ä»¤, ä½¿ç”¨è¿™è¡Œå¯ä»¥å±è”½æ‰å…¶å¥åº·æ£€æŸ¥æŒ‡ä»¤ HEALTHCHECK æŒ‡ä»¤æ˜¯å‘Šè¯‰ Docker åº”è¯¥å¦‚ä½•è¿›è¡Œåˆ¤æ–­å®¹å™¨çš„çŠ¶æ€æ˜¯å¦æ­£å¸¸, è¿™æ˜¯ Docker 1.12 å¼•å…¥çš„æ–°æŒ‡ä»¤.\nåœ¨æ²¡æœ‰ HEALTHCHECK æŒ‡ä»¤å‰, Docker å¼•æ“åªå¯ä»¥é€šè¿‡å®¹å™¨å†…ä¸»è¿›ç¨‹æ˜¯å¦é€€å‡ºæ¥åˆ¤æ–­å®¹å™¨æ˜¯å¦çŠ¶æ€å¼‚å¸¸. å¾ˆå¤šæƒ…å†µä¸‹è¿™æ²¡é—®é¢˜, ä½†æ˜¯å¦‚æœç¨‹åºè¿›å…¥æ­»é”çŠ¶æ€, æˆ–è€…æ­»å¾ªç¯çŠ¶æ€, åº”ç”¨è¿›ç¨‹å¹¶ä¸é€€å‡º, ä½†æ˜¯è¯¥å®¹å™¨å·²ç»æ— æ³•æä¾›æœåŠ¡äº†. åœ¨ 1.12 ä»¥å‰, Docker ä¸ä¼šæ£€æµ‹åˆ°å®¹å™¨çš„è¿™ç§çŠ¶æ€, ä»è€Œä¸ä¼šé‡æ–°è°ƒåº¦, å¯¼è‡´å¯èƒ½ä¼šæœ‰éƒ¨åˆ†å®¹å™¨å·²ç»æ— æ³•æä¾›æœåŠ¡äº†å´è¿˜åœ¨æ¥å—ç”¨æˆ·è¯·æ±‚.\nHEALTHCHECK æ”¯æŒä¸‹åˆ—é€‰é¡¹ï¼š\n--interval=\u0026lt;é—´éš”\u0026gt;ï¼šä¸¤æ¬¡å¥åº·æ£€æŸ¥çš„é—´éš”, é»˜è®¤ä¸º 30 ç§’ï¼› --timeout=\u0026lt;æ—¶é•¿\u0026gt;ï¼šå¥åº·æ£€æŸ¥å‘½ä»¤è¿è¡Œè¶…æ—¶æ—¶é—´, å¦‚æœè¶…è¿‡è¿™ä¸ªæ—¶é—´, æœ¬æ¬¡å¥åº·æ£€æŸ¥å°±è¢«è§†ä¸ºå¤±è´¥, é»˜è®¤ 30 ç§’ï¼› --retries=\u0026lt;æ¬¡æ•°\u0026gt;ï¼šå½“è¿ç»­å¤±è´¥æŒ‡å®šæ¬¡æ•°å, åˆ™å°†å®¹å™¨çŠ¶æ€è§†ä¸º unhealthy, é»˜è®¤ 3 æ¬¡. å’Œ CMD, ENTRYPOINT ä¸€æ ·, HEALTHCHECK åªå¯ä»¥å‡ºç°ä¸€æ¬¡, å¦‚æœå†™äº†å¤šä¸ª, åªæœ‰æœ€åä¸€ä¸ªç”Ÿæ•ˆ.\nåœ¨ HEALTHCHECK [é€‰é¡¹] CMD åé¢çš„å‘½ä»¤, æ ¼å¼å’Œ ENTRYPOINT ä¸€æ ·, åˆ†ä¸º shell æ ¼å¼, å’Œ exec æ ¼å¼. å‘½ä»¤çš„è¿”å›å€¼å†³å®šäº†è¯¥æ¬¡å¥åº·æ£€æŸ¥çš„æˆåŠŸä¸å¦ï¼š\n0ï¼šæˆåŠŸï¼› 1ï¼šå¤±è´¥ï¼› 2ï¼šä¿ç•™, ä¸è¦ä½¿ç”¨è¿™ä¸ªå€¼. å¦‚ä¸‹ç¤ºä¾‹, å‡è®¾æˆ‘ä»¬æœ‰ä¸ªé•œåƒæ˜¯ä¸ªæœ€ç®€å•çš„ Web æœåŠ¡, æˆ‘ä»¬å¸Œæœ›å¢åŠ å¥åº·æ£€æŸ¥æ¥åˆ¤æ–­å…¶ Web æœåŠ¡æ˜¯å¦åœ¨æ­£å¸¸å·¥ä½œ, æˆ‘ä»¬å¯ä»¥ç”¨ curl æ¥å¸®åŠ©åˆ¤æ–­\nFROM nginx HEALTHCHECK --interval=5s --timeout=3s --retries=3\\ CMD curl -fs http://localhost/ || exit 1 æ„å»ºè¿è¡Œ\n[root@lvbibir learn]# docker build -t myweb . [root@lvbibir learn]# docker run -d --name demo-myweb -p 800:80 myweb # æ­¤æ—¶æ˜¯ starting çŠ¶æ€ [root@lvbibir learn]# docker ps | grep myweb e6f585df60a6 myweb \u0026#34;/docker-entrypoint.â€¦\u0026#34; About a minute ago Up 2 seconds (health: starting) 0.0.0.0:800-\u0026gt;80/tcp demo-myweb # ç­‰å¾…å‡ ç§’å˜ä¸º healthy çŠ¶æ€ [root@lvbibir learn]# docker ps | grep myweb e6f585df60a6 myweb \u0026#34;/docker-entrypoint.â€¦\u0026#34; 2 minutes ago Up About a minute (healthy) 0.0.0.0:800-\u0026gt;80/tcp demo-myweb åˆ é™¤ index.html æ–‡ä»¶æ¨¡æ‹Ÿæ•…éšœ\n[root@lvbibir learn]# docker exec -it demo-myweb rm -f /usr/share/nginx/html/index.html # çŠ¶æ€å˜ä¸ºunhealthy [root@lvbibir learn]# docker ps | grep myweb e6f585df60a6 myweb \u0026#34;/docker-entrypoint.â€¦\u0026#34; 6 minutes ago Up 5 minutes (unhealthy) 0.0.0.0:800-\u0026gt;80/tcp demo-myweb ä¸ºäº†å¸®åŠ©æ’éšœ, å¥åº·æ£€æŸ¥å‘½ä»¤çš„è¾“å‡ºï¼ˆåŒ…æ‹¬ stdout ä»¥åŠ stderrï¼‰éƒ½ä¼šè¢«å­˜å‚¨äºå¥åº·çŠ¶æ€é‡Œ, å¯ä»¥ç”¨ docker inspect æ¥æŸ¥çœ‹.\n[root@lvbibir learn]# docker inspect --format \u0026#39;{{json .State.Health}}\u0026#39; demo-myweb | python -m json.tool { \u0026#34;FailingStreak\u0026#34;: 25, \u0026#34;Log\u0026#34;: [ { \u0026#34;End\u0026#34;: \u0026#34;2023-04-10T14:41:51.393698555+08:00\u0026#34;, \u0026#34;ExitCode\u0026#34;: 1, \u0026#34;Output\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;Start\u0026#34;: \u0026#34;2023-04-10T14:41:51.285647058+08:00\u0026#34; }, { \u0026#34;End\u0026#34;: \u0026#34;2023-04-10T14:41:56.504282619+08:00\u0026#34;, \u0026#34;ExitCode\u0026#34;: 1, \u0026#34;Output\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;Start\u0026#34;: \u0026#34;2023-04-10T14:41:56.401745529+08:00\u0026#34; }, ........... ], \u0026#34;Status\u0026#34;: \u0026#34;unhealthy\u0026#34; } æ¢å¤æ–‡ä»¶\n[root@lvbibir learn]# docker exec -it demo-myweb /bin/bash root@e6f585df60a6:/# echo test \u0026gt; /usr/share/nginx/html/index.html root@e6f585df60a6:/# exit [root@lvbibir learn]# docker inspect --format \u0026#39;{{json .State.Health}}\u0026#39; demo-myweb | python -m json.tool { \u0026#34;FailingStreak\u0026#34;: 0, \u0026#34;Log\u0026#34;: [ { \u0026#34;End\u0026#34;: \u0026#34;2023-04-10T14:48:30.482498808+08:00\u0026#34;, \u0026#34;ExitCode\u0026#34;: 0, \u0026#34;Output\u0026#34;: \u0026#34;test\\n\u0026#34;, \u0026#34;Start\u0026#34;: \u0026#34;2023-04-10T14:48:30.378197999+08:00\u0026#34; }, { \u0026#34;End\u0026#34;: \u0026#34;2023-04-10T14:48:35.599150547+08:00\u0026#34;, \u0026#34;ExitCode\u0026#34;: 0, \u0026#34;Output\u0026#34;: \u0026#34;test\\n\u0026#34;, \u0026#34;Start\u0026#34;: \u0026#34;2023-04-10T14:48:35.490433323+08:00\u0026#34; }, ....... ], \u0026#34;Status\u0026#34;: \u0026#34;healthy\u0026#34; } 14 ONBUILD ä¸ºä»–äººä½œå«è¡£è£³ æ ¼å¼ï¼šONBUILD \u0026lt;å…¶å®ƒæŒ‡ä»¤\u0026gt;.\nONBUILD æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æŒ‡ä»¤, å®ƒåé¢è·Ÿçš„æ˜¯å…¶å®ƒæŒ‡ä»¤, æ¯”å¦‚ RUN, COPY ç­‰, è€Œè¿™äº›æŒ‡ä»¤, åœ¨å½“å‰é•œåƒæ„å»ºæ—¶å¹¶ä¸ä¼šè¢«æ‰§è¡Œ. åªæœ‰å½“ä»¥å½“å‰é•œåƒä¸ºåŸºç¡€é•œåƒ, å»æ„å»ºä¸‹ä¸€çº§é•œåƒçš„æ—¶å€™æ‰ä¼šè¢«æ‰§è¡Œ.\nDockerfile ä¸­çš„å…¶å®ƒæŒ‡ä»¤éƒ½æ˜¯ä¸ºäº†å®šåˆ¶å½“å‰é•œåƒè€Œå‡†å¤‡çš„, å”¯æœ‰ ONBUILD æ˜¯ä¸ºäº†å¸®åŠ©åˆ«äººå®šåˆ¶è‡ªå·±è€Œå‡†å¤‡çš„.\nå‡è®¾æˆ‘ä»¬è¦åˆ¶ä½œ Node.js æ‰€å†™çš„åº”ç”¨çš„é•œåƒ. æˆ‘ä»¬éƒ½çŸ¥é“ Node.js ä½¿ç”¨ npm è¿›è¡ŒåŒ…ç®¡ç†, æ‰€æœ‰ä¾èµ–ã€é…ç½®ã€å¯åŠ¨ä¿¡æ¯ç­‰ä¼šæ”¾åˆ° package.json æ–‡ä»¶é‡Œ. åœ¨æ‹¿åˆ°ç¨‹åºä»£ç å, éœ€è¦å…ˆè¿›è¡Œ npm install æ‰å¯ä»¥è·å¾—æ‰€æœ‰éœ€è¦çš„ä¾èµ–. ç„¶åå°±å¯ä»¥é€šè¿‡ npm start æ¥å¯åŠ¨åº”ç”¨. å› æ­¤, ä¸€èˆ¬æ¥è¯´ä¼šè¿™æ ·å†™ Dockerfileï¼š\nFROM node:slim WORKDIR /app COPY ./package.json /app RUN [ \u0026#34;npm\u0026#34;, \u0026#34;install\u0026#34; ] COPY . /app/ CMD [ \u0026#34;npm\u0026#34;, \u0026#34;start\u0026#34; ] æŠŠè¿™ä¸ª Dockerfile æ”¾åˆ° Node.js é¡¹ç›®çš„æ ¹ç›®å½•, æ„å»ºå¥½é•œåƒå, å°±å¯ä»¥ç›´æ¥æ‹¿æ¥å¯åŠ¨å®¹å™¨è¿è¡Œ. ä½†æ˜¯å¦‚æœæˆ‘ä»¬è¿˜æœ‰ç¬¬äºŒä¸ª Node.js é¡¹ç›®ä¹Ÿå·®ä¸å¤šå‘¢ï¼Ÿå¥½å§, é‚£å°±å†æŠŠè¿™ä¸ª Dockerfile å¤åˆ¶åˆ°ç¬¬äºŒä¸ªé¡¹ç›®é‡Œ. é‚£å¦‚æœæœ‰ç¬¬ä¸‰ä¸ªé¡¹ç›®å‘¢ï¼Ÿå†å¤åˆ¶ä¹ˆï¼Ÿæ–‡ä»¶çš„å‰¯æœ¬è¶Šå¤š, ç‰ˆæœ¬æ§åˆ¶å°±è¶Šå›°éš¾, è®©æˆ‘ä»¬ç»§ç»­çœ‹è¿™æ ·çš„åœºæ™¯ç»´æŠ¤çš„é—®é¢˜.\nå¦‚æœç¬¬ä¸€ä¸ª Node.js é¡¹ç›®åœ¨å¼€å‘è¿‡ç¨‹ä¸­, å‘ç°è¿™ä¸ª Dockerfile é‡Œå­˜åœ¨é—®é¢˜, æ¯”å¦‚æ•²é”™å­—äº†ã€æˆ–è€…éœ€è¦å®‰è£…é¢å¤–çš„åŒ…, ç„¶åå¼€å‘äººå‘˜ä¿®å¤äº†è¿™ä¸ª Dockerfile, å†æ¬¡æ„å»º, é—®é¢˜è§£å†³. ç¬¬ä¸€ä¸ªé¡¹ç›®æ²¡é—®é¢˜äº†, ä½†æ˜¯ç¬¬äºŒä¸ªé¡¹ç›®å‘¢ï¼Ÿè™½ç„¶æœ€åˆ Dockerfile æ˜¯å¤åˆ¶ã€ç²˜è´´è‡ªç¬¬ä¸€ä¸ªé¡¹ç›®çš„, ä½†æ˜¯å¹¶ä¸ä¼šå› ä¸ºç¬¬ä¸€ä¸ªé¡¹ç›®ä¿®å¤äº†ä»–ä»¬çš„ Dockerfile, è€Œç¬¬äºŒä¸ªé¡¹ç›®çš„ Dockerfile å°±ä¼šè¢«è‡ªåŠ¨ä¿®å¤.\né‚£ä¹ˆæˆ‘ä»¬å¯ä¸å¯ä»¥åšä¸€ä¸ªåŸºç¡€é•œåƒ, ç„¶åå„ä¸ªé¡¹ç›®ä½¿ç”¨è¿™ä¸ªåŸºç¡€é•œåƒå‘¢ï¼Ÿè¿™æ ·åŸºç¡€é•œåƒæ›´æ–°, å„ä¸ªé¡¹ç›®ä¸ç”¨åŒæ­¥ Dockerfile çš„å˜åŒ–, é‡æ–°æ„å»ºåå°±ç»§æ‰¿äº†åŸºç¡€é•œåƒçš„æ›´æ–°ï¼Ÿå¥½å§, å¯ä»¥, è®©æˆ‘ä»¬çœ‹çœ‹è¿™æ ·çš„ç»“æœ.\nåŸºç¡€é•œåƒ (my-node) Dockerfile\nFROM node:slim WORKDIR /app CMD [ \u0026#34;npm\u0026#34;, \u0026#34;start\u0026#34; ] åº”ç”¨é•œåƒ (my-app1) Dockerfile\nFROM my-node COPY ./package.json /app RUN [ \u0026#34;npm\u0026#34;, \u0026#34;install\u0026#34; ] COPY . /app/ åŸºç¡€é•œåƒå˜åŒ–å, å„ä¸ªé¡¹ç›®éƒ½ç”¨è¿™ä¸ª Dockerfile é‡æ–°æ„å»ºé•œåƒ, ä¼šç»§æ‰¿åŸºç¡€é•œåƒçš„æ›´æ–°.\né‚£ä¹ˆ, é—®é¢˜è§£å†³äº†ä¹ˆï¼Ÿæ²¡æœ‰. å‡†ç¡®è¯´, åªè§£å†³äº†ä¸€åŠ. å¦‚æœè¿™ä¸ª Dockerfile é‡Œé¢æœ‰äº›ä¸œè¥¿éœ€è¦è°ƒæ•´å‘¢ï¼Ÿæ¯”å¦‚ npm install éƒ½éœ€è¦åŠ ä¸€äº›å‚æ•°, é‚£æ€ä¹ˆåŠï¼Ÿè¿™ä¸€è¡Œ RUN æ˜¯ä¸å¯èƒ½æ”¾å…¥åŸºç¡€é•œåƒçš„, å› ä¸ºæ¶‰åŠåˆ°äº†å½“å‰é¡¹ç›®çš„ ./package.json, éš¾é“åˆè¦ä¸€ä¸ªä¸ªä¿®æ”¹ä¹ˆï¼Ÿæ‰€ä»¥è¯´, è¿™æ ·åˆ¶ä½œåŸºç¡€é•œåƒ, åªè§£å†³äº†åŸæ¥çš„ Dockerfile çš„å‰ 4 æ¡æŒ‡ä»¤çš„å˜åŒ–é—®é¢˜, è€Œåé¢ä¸‰æ¡æŒ‡ä»¤çš„å˜åŒ–åˆ™å®Œå…¨æ²¡åŠæ³•å¤„ç†.\nONBUILD å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜. è®©æˆ‘ä»¬ç”¨ ONBUILD é‡æ–°å†™ä¸€ä¸‹åŸºç¡€é•œåƒçš„ Dockerfile:\nFROM node:slim WORKDIR /app ONBUILD COPY ./package.json /app ONBUILD RUN [ \u0026#34;npm\u0026#34;, \u0026#34;install\u0026#34; ] ONBUILD COPY . /app/ CMD [ \u0026#34;npm\u0026#34;, \u0026#34;start\u0026#34; ] åº”ç”¨é•œåƒ Dcokerfile\nFROM my-node æ˜¯çš„, åªæœ‰è¿™ä¹ˆä¸€è¡Œ. å½“åœ¨å„ä¸ªé¡¹ç›®ç›®å½•ä¸­, ç”¨è¿™ä¸ªåªæœ‰ä¸€è¡Œçš„ Dockerfile æ„å»ºé•œåƒæ—¶, ä¹‹å‰åŸºç¡€é•œåƒçš„é‚£ä¸‰è¡Œ ONBUILD å°±ä¼šå¼€å§‹æ‰§è¡Œ, æˆåŠŸçš„å°†å½“å‰é¡¹ç›®çš„ä»£ç å¤åˆ¶è¿›é•œåƒã€å¹¶ä¸”é’ˆå¯¹æœ¬é¡¹ç›®æ‰§è¡Œ npm install, ç”Ÿæˆåº”ç”¨é•œåƒ.\n15 LABEL ä¸ºé•œåƒæ·»åŠ å…ƒæ•°æ® LABEL æŒ‡ä»¤ç”¨æ¥ç»™é•œåƒä»¥é”®å€¼å¯¹çš„å½¢å¼æ·»åŠ ä¸€äº›å…ƒæ•°æ®ï¼ˆmetadataï¼‰.\nLABEL \u0026lt;key\u0026gt;=\u0026lt;value\u0026gt; \u0026lt;key\u0026gt;=\u0026lt;value\u0026gt; \u0026lt;key\u0026gt;=\u0026lt;value\u0026gt; ... æˆ‘ä»¬è¿˜å¯ä»¥ç”¨ä¸€äº›æ ‡ç­¾æ¥ç”³æ˜é•œåƒçš„ä½œè€…ã€æ–‡æ¡£åœ°å€ç­‰ï¼š\nLABEL org.opencontainers.image.authors=\u0026#34;yeasy\u0026#34; LABEL org.opencontainers.image.documentation=\u0026#34;https://yeasy.gitbooks.io\u0026#34; å…·ä½“å¯ä»¥å‚è€ƒ https://github.com/opencontainers/image-spec/blob/master/annotations.md\n16 SHELL æŒ‡å®š shell æ ¼å¼ï¼šSHELL [\u0026quot;executable\u0026quot;, \u0026quot;parameters\u0026quot;]\nSHELL æŒ‡ä»¤å¯ä»¥æŒ‡å®š RUN ENTRYPOINT CMD æŒ‡ä»¤çš„ shell, Linux ä¸­é»˜è®¤ä¸º `[\u0026quot;/bin/sh\u0026quot;, \u0026ldquo;-c\u0026rdquo;]\nå¦‚ä¸‹ç¤ºä¾‹, ä¸¤ä¸ª RUN è¿è¡ŒåŒä¸€å‘½ä»¤, ç¬¬äºŒä¸ª RUN è¿è¡Œçš„å‘½ä»¤ä¼šæ‰“å°å‡ºæ¯æ¡å‘½ä»¤å¹¶å½“é‡åˆ°é”™è¯¯æ—¶é€€å‡º.\nSHELL [\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;] RUN lll ; ls SHELL [\u0026#34;/bin/sh\u0026#34;, \u0026#34;-cex\u0026#34;] RUN lll ; ls å¦‚ä¸‹ç¤ºä¾‹, å½“ ENTRYPOINT CMD ä»¥ shell æ ¼å¼æŒ‡å®šæ—¶, SHELL æŒ‡ä»¤æ‰€æŒ‡å®šçš„ shell ä¹Ÿä¼šæˆä¸ºè¿™ä¸¤ä¸ªæŒ‡ä»¤çš„ shell\nSHELL [\u0026#34;/bin/sh\u0026#34;, \u0026#34;-cex\u0026#34;] # /bin/sh -cex \u0026#34;nginx\u0026#34; ENTRYPOINT nginx # /bin/sh -cex \u0026#34;nginx\u0026#34; CMD nginx ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/docker-dockerfile-instruction/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥ï¼š Dockerfile æŒ‡ä»¤è¯¦è§£ Dockerfile ç”¨äºæ„å»º docker é•œåƒ, å®é™…ä¸Šå°±æ˜¯æŠŠåœ¨ linux ä¸‹çš„å‘½ä»¤æ“ä½œå†™åˆ°äº† Dockerfile ä¸­, é€šè¿‡ Dockerfile å»æ‰§è¡Œè®¾ç½®å¥½çš„æ“ä½œå‘½ä»¤, ä¿è¯é€šè¿‡ Dockerfile çš„æ„å»ºé•œåƒæ˜¯ä¸€è‡´çš„. Dockerfile æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶, å…¶å†…åŒ…å«äº†ä¸€æ¡æ¡çš„æŒ‡ä»¤ (Instruction), æ¯ä¸€æ¡æŒ‡ä»¤æ„å»ºä¸€å±‚, å› æ­¤æ¯ä¸€æ¡æŒ‡ä»¤çš„å†…å®¹, å°±æ˜¯æè¿°è¯¥å±‚åº”å½“å¦‚ä½•æ„å»º. 1 FROM æŒ‡å®šåŸºç¡€é•œåƒ å‘½","title":"docker | dockerfile æŒ‡ä»¤è¯¦è§£"},{"content":"1 ç®€ä»‹ kill å‘½ä»¤å¾ˆå®¹æ˜“è®©äººäº§ç”Ÿè¯¯è§£, ä»¥ä¸ºä»…ä»…æ˜¯ç”¨æ¥ç»ˆæ­¢ linux ä¸­çš„è¿›ç¨‹.\nåœ¨ man æ‰‹å†Œä¸­å¯¹ kill å‘½ä»¤çš„è§£é‡Šå¦‚ä¸‹, ä¸éš¾çœ‹å‡º, kill å‘½ä»¤æ˜¯ä¸€ä¸ªç”¨äºå°†æŒ‡å®šçš„ signal å‘é€ç»™è¿›ç¨‹çš„å·¥å…·\nDESCRIPTION The command kill sends the specified signal to the specified process or process group. If no signal is specified, the TERM signal is sent. The TERM signal will kill processes which do not catch this signal. For other processes, it may be necessary to use the KILL (9) signal, since this signal cannot be caught. Most modern shells have a builtin kill function, with a usage rather similar to that of the command described here. The \u0026lsquo;-a\u0026rsquo; and \u0026lsquo;-p\u0026rsquo; options, and the possibility to specify processes by command name are a local extension. If sig is 0, then no signal is sent, but error checking is still performed.\nå‘½ä»¤æ ¼å¼\nkill [-s signal|-p] [-q sigval] [-a] [--] pid... å¸¸ç”¨å‚æ•°\n-l # åˆ—å‡ºæ‰€æœ‰æ”¯æŒçš„signal -s NAME # ä½¿ç”¨NAMEæŒ‡å®šsignal -NUM # ä½¿ç”¨ç¼–å·æŒ‡å®šsignal kill -s HUP å’Œ kill -1 æ•ˆæœä¸€æ · 2 æ”¯æŒçš„ä¿¡å· [root@lvbibir ~]# kill -l 1) SIGHUP 2) SIGINT 3) SIGQUIT 4) SIGILL 5) SIGTRAP 6) SIGABRT 7) SIGBUS 8) SIGFPE 9) SIGKILL 10) SIGUSR1 11) SIGSEGV 12) SIGUSR2 13) SIGPIPE 14) SIGALRM 15) SIGTERM 16) SIGSTKFLT 17) SIGCHLD 18) SIGCONT 19) SIGSTOP 20) SIGTSTP 21) SIGTTIN 22) SIGTTOU 23) SIGURG 24) SIGXCPU 25) SIGXFSZ 26) SIGVTALRM 27) SIGPROF 28) SIGWINCH 29) SIGIO 30) SIGPWR 31) SIGSYS 34) SIGRTMIN 35) SIGRTMIN+1 36) SIGRTMIN+2 37) SIGRTMIN+3 38) SIGRTMIN+4 39) SIGRTMIN+5 40) SIGRTMIN+6 41) SIGRTMIN+7 42) SIGRTMIN+8 43) SIGRTMIN+9 44) SIGRTMIN+10 45) SIGRTMIN+11 46) SIGRTMIN+12 47) SIGRTMIN+13 48) SIGRTMIN+14 49) SIGRTMIN+15 50) SIGRTMAX-14 51) SIGRTMAX-13 52) SIGRTMAX-12 53) SIGRTMAX-11 54) SIGRTMAX-10 55) SIGRTMAX-9 56) SIGRTMAX-8 57) SIGRTMAX-7 58) SIGRTMAX-6 59) SIGRTMAX-5 60) SIGRTMAX-4 61) SIGRTMAX-3 62) SIGRTMAX-2 63) SIGRTMAX-1 64) SIGRTMAX å¯ä»¥çœ‹åˆ° kill æ”¯æŒçš„ä¿¡å·éå¸¸å¤š, åœ¨è¿™äº›ä¿¡å·ä¸­åªæœ‰ 9) SIGKILL å¯ä»¥æ— æ¡ä»¶åœ°ç»ˆæ­¢ process, å…¶ä»–ä¿¡å·éƒ½å°†ä¾ç…§ process ä¸­å®šä¹‰çš„ä¿¡å·å¤„ç†è§„åˆ™æ¥è¿›è¡Œå¿½ç•¥æˆ–è€…å¤„ç†.\nä¸Šè¿°ä¿¡å·ä¸­å¸¸ç”¨çš„å…¶å®å¾ˆå°‘, å¦‚ä¸‹è¡¨æ‰€ç¤º\nç¼–å· åç§° è§£é‡Š 1 SIGHUP å¯åŠ¨è¢«ç»ˆæ­¢çš„ç¨‹åº, ä¹Ÿå¯ä»¥è®©è¿›ç¨‹é‡æ–°è¯»å–è‡ªå·±çš„é…ç½®æ–‡ä»¶, ç±»ä¼¼é‡æ–°å¯åŠ¨ 2 SIGINT ç›¸å½“äºè¾“å…¥ ctrl-c æ¥ä¸­æ–­ä¸€ä¸ªç¨‹åº 9 SIGKILL å¼ºåˆ¶ä¸­æ–­ä¸€ä¸ªç¨‹åº, ä¸ä¼šè¿›è¡Œèµ„æºçš„æ¸…ç†å·¥ä½œ. å¦‚æœè¯¥ç¨‹åºè¿›è¡Œåˆ°ä¸€åŠ, å¯èƒ½ä¼šæœ‰åŠæˆå“äº§ç”Ÿ, ç±»ä¼¼ vim çš„ .filename.swp ä¿ç•™ä¸‹æ¥ 15 SIGTERM ä»¥æ­£å¸¸ (ä¼˜é›…) çš„æ–¹å¼æ¥ç»ˆæ­¢è¿›ç¨‹, ç”±ç¨‹åºè‡ªèº«å†³å®šè¯¥å¦‚ä½•ç»ˆæ­¢ 19 SIGSTOP ç›¸å½“äºè¾“å…¥ ctrl-z æ¥æš‚åœä¸€ä¸ªç¨‹åº 3 å¸¸ç”¨å‘½ä»¤ ä»¥æ­£å¸¸çš„æ–¹å¼ç»ˆæ­¢è¿›ç¨‹, ç”±äºä¿¡å· 15 æ˜¯æœ€å¸¸ç”¨ä¹Ÿæ˜¯æœ€ä½³çš„ç¨‹åºé€€å‡ºæ–¹å¼, æ‰€ä»¥ kill å‘½ä»¤ä¸æŒ‡å®šä¿¡å·æ—¶, é»˜è®¤ä½¿ç”¨çš„å°±æ˜¯ä¿¡å· 15\nkill pid # æˆ–è€… kill -15 pid å¼ºåˆ¶ç»ˆæ­¢è¿›ç¨‹\nkill -9 pid ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/linux-command-kill/","summary":"1 ç®€ä»‹ kill å‘½ä»¤å¾ˆå®¹æ˜“è®©äººäº§ç”Ÿè¯¯è§£, ä»¥ä¸ºä»…ä»…æ˜¯ç”¨æ¥ç»ˆæ­¢ linux ä¸­çš„è¿›ç¨‹. åœ¨ man æ‰‹å†Œä¸­å¯¹ kill å‘½ä»¤çš„è§£é‡Šå¦‚ä¸‹, ä¸éš¾çœ‹å‡º, kill å‘½ä»¤æ˜¯ä¸€ä¸ªç”¨äºå°†æŒ‡å®šçš„ signal å‘é€ç»™è¿›ç¨‹çš„å·¥å…· DESCRIPTION The command kill sends the specified signal to the specified process or process group. If no signal is specified, the TERM signal is sent. The TERM signal will kill processes which do not catch this signal. For other processes, it may be necessary to use the KILL (9) signal, since this signal cannot be caught. Most modern shells have a builtin kill function, with a usage rather","title":"linux | kill å‘½ä»¤è¯¦è§£ä»¥åŠ linux ä¸­çš„ä¿¡å·"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\ngithub issue # 638 1 æŠ¥é”™ä¿¡æ¯ æŠ¥é”™è¯¦ç»†ä¿¡æ¯\nException in thread \u0026#34;main\u0026#34; java.nio.file.NotDirectoryException: /usr/share/elasticsearch/plugins/plugin-descriptor.properties at java.base/sun.nio.fs.UnixFileSystemProvider.newDirectoryStream(UnixFileSystemProvider.java:439) at java.base/java.nio.file.Files.newDirectoryStream(Files.java:482) at java.base/java.nio.file.Files.list(Files.java:3793) at org.elasticsearch.tools.launchers.BootstrapJvmOptions.getPluginInfo(BootstrapJvmOptions.java:49) at org.elasticsearch.tools.launchers.BootstrapJvmOptions.bootstrapJvmOptions(BootstrapJvmOptions.java:34) at org.elasticsearch.tools.launchers.JvmOptionsParser.jvmOptions(JvmOptionsParser.java:137) at org.elasticsearch.tools.launchers.JvmOptionsParser.main(JvmOptionsParser.java:86) å®‰è£…æ’ä»¶æ—¶ç›´æ¥å°†æ’ä»¶çš„ zip è§£å‹åˆ°äº† plugins ç›®å½• å¯¼è‡´çš„ï¼Œæ¯ä¸ªæ’ä»¶åº”ä»¥ç›®å½•çš„å½¢å¼å­˜æ”¾åœ¨ plugins ç›®å½• ä¸­\n[root@21-centos-7 ~]# ls /data/elasticsearch/plugins/ commons-codec-1.9.jar commons-logging-1.2.jar config elasticsearch-analysis-ik-7.17.3.jar httpclient-4.5.2.jar httpcore-4.4.4.jar plugin-descriptor.properties plugin-security.policy 2 è§£å†³ åªéœ€è¦ä¸ºæ¯ä¸ªæ’ä»¶åˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œå¹¶æŠŠæ’ä»¶è§£å‹åˆ°å¯¹åº”ç›®å½•å³å¯\nmkdir /data/elasticsearch/plugins/elasticsearch-analysis-ik/ unzip elasticsearch-analysis-ik-7.17.3.zip -d /data/elasticsearch/plugins/elasticsearch-analysis-ik/ ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/troubleshooting-elasticsearch-plugin-error/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: github issue # 638 1 æŠ¥é”™ä¿¡æ¯ æŠ¥é”™è¯¦ç»†ä¿¡æ¯ Exception in thread \u0026#34;main\u0026#34; java.nio.file.NotDirectoryException: /usr/share/elasticsearch/plugins/plugin-descriptor.properties at java.base/sun.nio.fs.UnixFileSystemProvider.newDirectoryStream(UnixFileSystemProvider.java:439) at java.base/java.nio.file.Files.newDirectoryStream(Files.java:482) at java.base/java.nio.file.Files.list(Files.java:3793) at org.elasticsearch.tools.launchers.BootstrapJvmOptions.getPluginInfo(BootstrapJvmOptions.java:49) at org.elasticsearch.tools.launchers.BootstrapJvmOptions.bootstrapJvmOptions(BootstrapJvmOptions.java:34) at org.elasticsearch.tools.launchers.JvmOptionsParser.jvmOptions(JvmOptionsParser.java:137) at org.elasticsearch.tools.launchers.JvmOptionsParser.main(JvmOptionsParser.java:86) å®‰è£…æ’ä»¶æ—¶ç›´æ¥å°†æ’ä»¶çš„ zip è§£å‹åˆ°äº† plugins ç›®å½• å¯¼è‡´çš„ï¼Œæ¯ä¸ªæ’ä»¶åº”ä»¥ç›®å½•çš„å½¢å¼å­˜æ”¾åœ¨ plugins ç›®å½• ä¸­ [root@21-centos-7 ~]# ls /data/elasticsearch/plugins/ commons-codec-1.9.jar commons-logging-1.2.jar config elasticsearch-analysis-ik-7.17.3.jar httpclient-4.5.2.jar httpcore-4.4.4.jar plugin-descriptor.properties plugin-security.policy 2 è§£å†³ åªéœ€è¦ä¸ºæ¯ä¸ªæ’ä»¶åˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œå¹¶æŠŠæ’ä»¶è§£å‹åˆ°å¯¹åº”ç›®å½•å³å¯ mkdir /data/elasticsearch/plugins/elasticsearch-analysis-ik/ unzip elasticsearch-analysis-ik-7.17.3.zip -d /data/elasticsearch/plugins/elasticsearch-analysis-ik/ ä»¥ä¸Š","title":"troubleshooting | elasticsearch å®‰è£…æ’ä»¶æŠ¥é”™"},{"content":"1 åŸºæœ¬è¯­æ³• if [ command ];then ç¬¦åˆè¯¥æ¡ä»¶æ‰§è¡Œçš„è¯­å¥ elif [ command ];then ç¬¦åˆè¯¥æ¡ä»¶æ‰§è¡Œçš„è¯­å¥ else ç¬¦åˆè¯¥æ¡ä»¶æ‰§è¡Œçš„è¯­å¥ fi 2 å­—ç¬¦ä¸²åˆ¤æ–­ è¡¨è¾¾å¼ è§£é‡Š [ -z STRING ] å¦‚æœ STRING çš„é•¿åº¦ä¸ºé›¶åˆ™ä¸ºçœŸ ï¼Œå³åˆ¤æ–­æ˜¯å¦ä¸ºç©ºï¼Œç©ºå³æ˜¯çœŸï¼› [ -n STRING ] or [ STRING ] å¦‚æœ STRING çš„é•¿åº¦éé›¶åˆ™ä¸ºçœŸ ï¼Œå³åˆ¤æ–­æ˜¯å¦ä¸ºéç©ºï¼Œéç©ºå³æ˜¯çœŸï¼› [ STRING1 = STRING2 ] å¦‚æœä¸¤ä¸ªå­—ç¬¦ä¸²ç›¸åŒåˆ™ä¸ºçœŸ ï¼› [ STRING1 != STRING2 ] å¦‚æœå­—ç¬¦ä¸²ä¸ç›¸åŒåˆ™ä¸ºçœŸ ï¼› 3 æ•°å€¼åˆ¤æ–­ è¡¨è¾¾å¼ è§£é‡Š [ INT1 -eq INT2 ] INT1 å’Œ INT2 ä¸¤æ•°ç›¸ç­‰ä¸ºçœŸï¼Œ= [ INT1 -ne INT2 ] INT1 å’Œ INT2 ä¸¤æ•°ä¸ç­‰ä¸ºçœŸï¼Œ!= [ INT1 -gt INT2 ] INT1 å¤§äº INT1 ä¸ºçœŸï¼Œ\u0026gt; [ INT1 -ge INT2 ] INT1 å¤§äºç­‰äº INT2 ä¸ºçœŸï¼Œ\u0026gt;= [ INT1 -lt INT2 ] INT1 å°äº INT2 ä¸ºçœŸï¼Œ\u0026lt; [ INT1 -le INT2 ] INT1 å°äºç­‰äº INT2 ä¸ºçœŸï¼Œ\u0026lt;= 4 æ–‡ä»¶/ç›®å½•åˆ¤æ–­ è¡¨è¾¾å¼ è§£é‡Š [ -b FILE ] å¦‚æœ FILE å­˜åœ¨ä¸”æ˜¯ä¸€ä¸ªå—ç‰¹æ®Šæ–‡ä»¶åˆ™ä¸ºçœŸ [ -c FILE ] å¦‚æœ FILE å­˜åœ¨ä¸”æ˜¯ä¸€ä¸ªå­—ç‰¹æ®Šæ–‡ä»¶åˆ™ä¸ºçœŸ [ -d DIR ] å¦‚æœ FILE å­˜åœ¨ä¸”æ˜¯ä¸€ä¸ªç›®å½•åˆ™ä¸ºçœŸ [ -e FILE ] å¦‚æœ FILE å­˜åœ¨åˆ™ä¸ºçœŸ [ -f FILE ] å¦‚æœ FILE å­˜åœ¨ä¸”æ˜¯ä¸€ä¸ªæ™®é€šæ–‡ä»¶åˆ™ä¸ºçœŸ [ -g FILE ] å¦‚æœ FILE å­˜åœ¨ä¸”å·²ç»è®¾ç½®äº† SGID åˆ™ä¸ºçœŸ [ -k FILE ] å¦‚æœ FILE å­˜åœ¨ä¸”å·²ç»è®¾ç½®äº†ç²˜åˆ¶ä½åˆ™ä¸ºçœŸ [ -p FILE ] å¦‚æœ FILE å­˜åœ¨ä¸”æ˜¯ä¸€ä¸ªåå­—ç®¡é“ (F å¦‚æœ O) åˆ™ä¸ºçœŸ [ -r FILE ] å¦‚æœ FILE å­˜åœ¨ä¸”æ˜¯å¯è¯»çš„åˆ™ä¸ºçœŸ [ -s FILE ] å¦‚æœ FILE å­˜åœ¨ä¸”å¤§å°ä¸ä¸º 0 åˆ™ä¸ºçœŸ [ -t FD ] å¦‚æœæ–‡ä»¶æè¿°ç¬¦ FD æ‰“å¼€ä¸”æŒ‡å‘ä¸€ä¸ªç»ˆç«¯åˆ™ä¸ºçœŸ [ -u FILE ] å¦‚æœ FILE å­˜åœ¨ä¸”è®¾ç½®äº† SUID (set user ID) åˆ™ä¸ºçœŸ [ -w FILE ] å¦‚æœ FILE å­˜åœ¨ä¸”æ˜¯å¯å†™çš„åˆ™ä¸ºçœŸ [ -x FILE ] å¦‚æœ FILE å­˜åœ¨ä¸”æ˜¯å¯æ‰§è¡Œçš„åˆ™ä¸ºçœŸ [ -O FILE ] å¦‚æœ FILE å­˜åœ¨ä¸”å±æœ‰æ•ˆç”¨æˆ· ID åˆ™ä¸ºçœŸ [ -G FILE ] å¦‚æœ FILE å­˜åœ¨ä¸”å±æœ‰æ•ˆç”¨æˆ·ç»„åˆ™ä¸ºçœŸ [ -L FILE ] å¦‚æœ FILE å­˜åœ¨ä¸”æ˜¯ä¸€ä¸ªç¬¦å·è¿æ¥åˆ™ä¸ºçœŸ [ -N FILE ] å¦‚æœ FILE å­˜åœ¨ä¸”è‡ªä¸Šæ¬¡é˜…è¯»ä»¥æ¥å·²è¿›è¡Œäº†ä¿®æ”¹åˆ™ä¸ºçœŸ [ -S FILE ] å¦‚æœ FILE å­˜åœ¨ä¸”æ˜¯ä¸€ä¸ªå¥—æ¥å­—åˆ™ä¸ºçœŸ [ FILE1 -nt FILE2 ] å¦‚æœ FILE1 æ¯” FILE2 æ›´æ–°ï¼Œæˆ–è€… FILE1 å­˜åœ¨ä¸” FILE2 ä¸å­˜åœ¨åˆ™ä¸ºçœŸ [ FILE1 -ot FILE2 ] å¦‚æœ FILE1 æ¯” FILE2 è¦è€ï¼Œæˆ–è€… FILE2 å­˜åœ¨ä¸” FILE1 ä¸å­˜åœ¨åˆ™ä¸ºçœŸ [ FILE1 -ef FILE2 ] å¦‚æœ FILE1 å’Œ FILE2 æŒ‡å‘ç›¸åŒçš„è®¾å¤‡å’ŒèŠ‚ç‚¹å·åˆ™ä¸ºçœŸ 5 ä¸æˆ–é -a \u0026amp;\u0026amp; ä¸ï¼Œä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³ -o || æˆ–ï¼Œä¸¤ä¸ªæ¡ä»¶åªæ»¡è¶³ä¸€ä¸ªæ¡ä»¶ ! éï¼Œä¸¤ä¸ªæ¡ä»¶éƒ½ä¸æ»¡è¶³ ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/shell-if/","summary":"1 åŸºæœ¬è¯­æ³• if [ command ];then ç¬¦åˆè¯¥æ¡ä»¶æ‰§è¡Œçš„è¯­å¥ elif [ command ];then ç¬¦åˆè¯¥æ¡ä»¶æ‰§è¡Œçš„è¯­å¥ else ç¬¦åˆè¯¥æ¡ä»¶æ‰§è¡Œçš„è¯­å¥ fi 2 å­—ç¬¦ä¸²åˆ¤æ–­ è¡¨è¾¾å¼ è§£é‡Š [ -z STRING ] å¦‚æœ STRING çš„é•¿åº¦ä¸ºé›¶åˆ™ä¸ºçœŸ ï¼Œå³åˆ¤æ–­æ˜¯å¦ä¸ºç©ºï¼Œç©ºå³æ˜¯çœŸï¼› [ -n STRING ] or [ STRING ] å¦‚æœ STRING çš„é•¿åº¦éé›¶åˆ™ä¸ºçœŸ ï¼Œå³åˆ¤æ–­æ˜¯å¦ä¸ºéç©ºï¼Œéç©ºå³æ˜¯çœŸï¼› [ STRING1 = STRING2 ] å¦‚æœä¸¤ä¸ªå­—ç¬¦ä¸²ç›¸åŒåˆ™ä¸ºçœŸ ï¼› [ STRING1","title":"shell | if æ¡ä»¶åˆ¤æ–­"},{"content":"0 å‰è¨€ ç›®å‰æœ€æ¨èä½¿ç”¨ ç« èŠ‚ 4 ä»¥åŠ 5 ä¸­çš„æ–¹æ³•, å‰ä¸‰ç§éƒ½æŒºæŠ˜è…¾\n1 é˜¿é‡Œäº‘æ„å»º 1.1 git ä»“åº“è®¾ç½® 1.1.1 åˆ›å»ºä»“åº“ ç”¨äºå­˜æ”¾ Dockerfile\n1.1.2 ä¸Šä¼  Dockerfile #æ¢æˆè‡ªå·±çš„ä»“åº“åœ°å€ git clone https://github.com/lvbibir/docker-images cd docker-images mkdir -p k8s.gcr.io/pause-3.2/ echo \u0026#34;FROM k8s.gcr.io/pause:3.2\u0026#34; \u0026gt; k8s.gcr.io/pause-3.2/Dockerfile git add . git commit -m \u0026#39;new image: k8s.gcr.io/pause:3.2\u0026#39; # é»˜è®¤åˆ†æ”¯å¯èƒ½æ˜¯mainï¼Œå–å†³äºä½ çš„githubè®¾ç½® git push origin master 1.2 é˜¿é‡Œäº‘è®¾ç½® ç™»é™†é˜¿é‡Œäº‘ï¼Œè®¿é—® é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡\n1.2.1 åˆ›å»ºä¸ªäººå®ä¾‹ 1.2.2 è¿›å…¥ä¸ªäººå®ä¾‹åˆ›å»ºå‘½åç©ºé—´ 1.2.3 åˆ›å»ºè®¿é—®å‡­è¯ 1.2.4 ç»‘å®š github è´¦å· 1.2.5 æ–°å»ºé•œåƒä»“åº“ æŒ‡å®šåˆšæ‰åˆ›å»ºçš„ github ä»“åº“ï¼Œè®°å¾—å‹¾é€‰æµ·å¤–æœºå™¨æ„å»º\n1.2.6 æ–°å»ºæ„å»º æ‰‹åŠ¨è§¦å‘æ„å»ºï¼Œæ­£å¸¸çŠ¶å†µåº”è¯¥å¯ä»¥çœ‹åˆ°æ„å»ºæˆåŠŸ\n1.2.7 é•œåƒä¸‹è½½ æ“ä½œæŒ‡å—é‡Œå¯ä»¥çœ‹åˆ°å¦‚ä½•ä¸‹è½½é•œåƒï¼Œæ ‡ç­¾å³åˆšæ‰æ–°å»ºæ„å»ºæ—¶æŒ‡å®šçš„é•œåƒç‰ˆæœ¬\n2 gcr.io_mirror é¡¹ç›®åœ°å€\nè¯¥é¡¹ç›®é€šè¿‡ Github Actions å°† gcr.ioã€k8s.gcr.ioã€registry.k8s.ioã€quay.ioã€ghcr.io é•œåƒä»“åº“çš„é•œåƒæ¬è¿è‡³ dockerhub\nç›´æ¥æäº¤ issueï¼Œåœ¨æ¨¡æ¿ issue çš„ [PORTER] åé¢æ·»åŠ æƒ³è¦æ¬è¿çš„é•œåƒ tagï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨å…³é—­çš„ issue åˆ—è¡¨ä¸­æ£€ç´¢ï¼Œå¯èƒ½ä¹Ÿä¼šæœ‰å…¶ä»–äººæ¬è¿è¿‡ï¼Œç›´æ¥ç”¨å°±è¡Œäº†\nç¨ç­‰ä¸€å°ä¼šå¯ä»¥çœ‹åˆ°é•œåƒå·²ç»æ¬è¿åˆ° dockerhub äº†\n3 Docker Playground Docker Playground æ˜¯ä¸€ä¸ªå…è´¹çš„çº¿ä¸Š docker ç¯å¢ƒï¼Œç”±äºæ˜¯å¤–ç½‘ç¯å¢ƒæ‰€ä»¥ä¸‹è½½é•œåƒã€æ¨é€åˆ° dockerhub éƒ½å¾ˆå¿«ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ¨åˆ°é˜¿é‡Œäº‘çš„ä»“åº“\ndocker login --username=lvbibir registry.cn-hangzhou.aliyuncs.com docker pull \u0026lt;image\u0026gt;:\u0026lt;tag\u0026gt; dokcer tag \u0026lt;image\u0026gt;:\u0026lt;tag\u0026gt; registry.cn-hangzhou.aliyuncs.com/lvbibir/\u0026lt;image\u0026gt;:\u0026lt;tag\u0026gt; docker push registry.cn-hangzhou.aliyuncs.com/lvbibir/\u0026lt;image\u0026gt;:\u0026lt;tag\u0026gt; 4 http proxy å¦‚æœæœ‰ä»£ç†è½¯ä»¶å¯ä»¥åœ¨ docker ä¸­é…ç½®ä»£ç†å®ç°, å‚è€ƒ å®˜æ–¹æ–‡æ¡£\nä¿®æ”¹ docker pull ç­‰æ“ä½œçš„ä»£ç†å¯ä»¥é€šè¿‡ docker çš„ daemon.json æ–‡ä»¶æˆ–è€… service ä¸¤ç§æ–¹å¼è¿›è¡Œä¿®æ”¹, æ¨èä½¿ç”¨ç¬¬ä¸€ç§\nä¿®æ”¹ /etc/docker/daemon.json { \u0026#34;proxies\u0026#34;: { \u0026#34;http-proxy\u0026#34;: \u0026#34;http://proxy1.bj.petrochina:8080\u0026#34;, \u0026#34;https-proxy\u0026#34;: \u0026#34;http://proxy1.bj.petrochina:8080\u0026#34;, \u0026#34;no-proxy\u0026#34;: \u0026#34;localhost,127.0.0.0/8\u0026#34; } } ä¿®æ”¹ docker service sudo vim /lib/systemd/system/docker.service # åœ¨ [Service] ä¸‹æ·»åŠ å¦‚ä¸‹ä¸‰è¡Œ Environment=HTTP_PROXY=http://proxy1.bj.petrochina:8080 Environment=HTTPS_PROXY=http://proxy1.bj.petrochina:8080 Environment=NO_PROXY=localhost,127.0.0.1 ä¸Šè¿°ä¸¤ç§æ–¹å¼ä»»æ„ä¸€ç§ä¿®æ”¹å®Œæˆåé‡å¯ docker å³å¯\nsudo systemctl daemon-reload sudo systemctl restart docker sudo docker info | grep proxy 5 ä½¿ç”¨å›½å†…ç°æˆçš„é•œåƒç«™ è¿™ç§æ–¹å¼çš„é—®é¢˜ä¸»è¦æ˜¯é•œåƒä¸å…¨ï¼Œä¸”æ²¡æœ‰ç»Ÿä¸€çš„ç®¡ç†ï¼Œå»ºè®®ä½¿ç”¨ä¹‹å‰çš„å››ç§æ–¹å¼\né˜¿é‡Œäº‘ä»“åº“\ndocker pull k8s.gcr.io/sig-storage/csi-node-driver-registrar:v2.3.0 # æ¢æˆ docker pull registry.aliyuncs.com/google_containers/csi-node-driver-registrar:v2.3.0 ä¹Ÿå¯ä»¥ä½¿ç”¨ lank8s.cnï¼Œä»–ä»¬çš„å¯¹åº”å…³ç³» k8s.gcr.io â€“\u0026gt; lank8s.cnï¼Œgcr.io â€“\u0026gt; gcr.lank8s.cn\ndocker pull k8s.gcr.io/sig-storage/csi-node-driver-registrar:v2.3.0 # æ¢æˆ docker pull lank8s.cn/sig-storage/csi-node-driver-registrar:v2.3.0 ä¸­ç§‘å¤§\ndocker image pull quay.io/kubevirt/virt-api:v0.45.0 # æ¢æˆ docker pull quay.mirrors.ustc.edu.cn/kubevirt/virt-api:v0.45.0 ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/docker-download-foreign-images/","summary":"0 å‰è¨€ ç›®å‰æœ€æ¨èä½¿ç”¨ ç« èŠ‚ 4 ä»¥åŠ 5 ä¸­çš„æ–¹æ³•, å‰ä¸‰ç§éƒ½æŒºæŠ˜è…¾ 1 é˜¿é‡Œäº‘æ„å»º 1.1 git ä»“åº“è®¾ç½® 1.1.1 åˆ›å»ºä»“åº“ ç”¨äºå­˜æ”¾ Dockerfile 1.1.2 ä¸Šä¼  Dockerfile #æ¢æˆè‡ªå·±çš„ä»“åº“åœ°å€ git clone https://github.com/lvbibir/docker-images cd docker-images mkdir -p k8s.gcr.io/pause-3.2/ echo \u0026#34;FROM k8s.gcr.io/pause:3.2\u0026#34; \u0026gt; k8s.gcr.io/pause-3.2/Dockerfile git add . git commit -m \u0026#39;new image: k8s.gcr.io/pause:3.2\u0026#39; # é»˜è®¤åˆ†æ”¯å¯èƒ½æ˜¯mainï¼Œå–å†³äºä½ çš„githubè®¾ç½® git push origin master 1.2 é˜¿é‡Œäº‘è®¾ç½® ç™»é™†é˜¿é‡Œäº‘ï¼Œè®¿é—® é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ 1.2.1","title":"docker | ä¸‹è½½å¤–ç½‘é•œåƒçš„å‡ ç§æ–¹å¼"},{"content":"åŸé¢˜å¦‚ä¸‹\né¬¼è°·å­éšæ„ä» 2-99 ä¸­é€‰å–äº†ä¸¤ä¸ªæ•°ã€‚ä»–æŠŠè¿™ä¸¤ä¸ªæ•°çš„å’Œå‘Šè¯‰äº†åºæ¶“ï¼Œ æŠŠè¿™ä¸¤ä¸ªæ•°çš„ä¹˜ç§¯å‘Šè¯‰äº†å­™è†‘ã€‚ä½†å­™è†‘å’Œåºæ¶“å½¼æ­¤ä¸çŸ¥é“å¯¹æ–¹å¾—åˆ°çš„æ•°ã€‚ç¬¬äºŒå¤©ï¼Œ åºæ¶“å¾ˆæœ‰è‡ªä¿¡çš„å¯¹å­™è†‘è¯´ï¼šè™½ç„¶æˆ‘ä¸çŸ¥é“è¿™ä¸¤ä¸ªæ•°æ˜¯ä»€ä¹ˆï¼Œä½†æˆ‘çŸ¥é“ä½ ä¸€å®šä¹Ÿä¸çŸ¥é“ã€‚éšåï¼Œå­™è†‘è¯´ï¼šé‚£æˆ‘çŸ¥é“äº†ã€‚åºæ¶“è¯´ï¼šé‚£æˆ‘ä¹ŸçŸ¥é“äº†ã€‚è¿™ä¸¤ä¸ªæ•°æ˜¯ä»€ä¹ˆï¼Ÿ\nä»£ç ç¤ºä¾‹\n#!/usr/bin/env python # -*- coding: utf-8 -*- \u0026#39;\u0026#39;\u0026#39; ç¬¬ä¸€æ­¥ åºå‘Šè¯‰å­™ï¼Œå·²çŸ¥å’ŒSumæ»¡è¶³æœ‰è‡³å°‘ä¸¤ç§abç»„åˆï¼Œä¸”ä»»æ„ä¸€ç»„abçš„ä¹˜ç§¯Proéƒ½æ»¡è¶³è‡³å°‘æœ‰ä¸¤ç§abç»„åˆï¼Œé€šè¿‡isPangå‡½æ•°å°†å¯èƒ½çš„abç»„åˆæ”¾å…¥abList_1 ç¬¬äºŒæ­¥ å­™å‘Šè¯‰åºï¼ŒabList_1ä¸­çš„abç»„åˆä¹˜ç§¯å¾—proï¼Œè¯¥proæ»¡è¶³è‡³å°‘æœ‰ä¸¤ç§abç»„åˆï¼Œä¸”æ‰€æœ‰çš„abç»„åˆæœ‰ä¸”ä»…æœ‰ä¸€ç»„abç»„åˆæ»¡è¶³isPangå‡½æ•°ï¼Œé€šè¿‡isSunå‡½æ•°å°†abListä¸­æ»¡è¶³æ¡ä»¶çš„abç»„åˆæ”¾å…¥abList_2ï¼Œabç»„åˆçš„ç§¯æ”¾å…¥proList ç¬¬ä¸‰æ­¥ åºå‘Šè¯‰å­™ï¼ŒabList_2ä¸­çš„abç»„åˆç›¸åŠ å¾—Sumï¼Œè¯¥Sumæ»¡è¶³è‡³å°‘æœ‰ä¸¤ç§abç»„åˆï¼Œä¸”æ‰€æœ‰çš„abç»„åˆæœ‰ä¸”ä»…æœ‰ä¸€ç»„abæ‰€å¾—ä¹˜ç§¯proåœ¨proListä¸­ï¼Œå°†æ»¡è¶³æ¡ä»¶çš„abç»„åˆæ”¾å…¥abListï¼Œå³æœ€ç»ˆç­”æ¡ˆ \u0026#39;\u0026#39;\u0026#39; # æ ¹æ®ç»™å‡ºçš„sumï¼Œéå†æ‰€æœ‰å¯èƒ½çš„aå’Œbçš„ç»„åˆ def getCombinationSum(sum): combination = [] for a in range(2, 100): for b in range(2, 100): if a + b == sum and a \u0026lt;= b: combination.append((a, b)) return combination # æ ¹æ®ç»™å‡ºçš„proï¼Œéå†æ‰€æœ‰å¯èƒ½çš„aå’Œbçš„ç»„åˆ def getCombinationPro(pro): combination = [] for a in range(2, 100): for b in range(2, 100): if a * b == pro and a \u0026lt;= b: combination.append((a, b)) return combination def isPang(sum): \u0026#39;\u0026#39;\u0026#39; ç¬¬ä¸€æ­¥ï¼Œä¼ å…¥çš„sumæ»¡è¶³ä»¥ä¸‹æ¡ä»¶è¿”å›Trueï¼Œå¦åˆ™False: 1. å¯ä»¥æ‹†åˆ†æˆè‹¥å¹²ç»„abçš„åŠ å’Œ 2. æ¯ä¸€ç»„æ‹†åˆ†å‡ºæ¥çš„abä¹˜ç§¯è¿ç®—å¾—proï¼Œè¯¥proæ»¡è¶³æœ‰è‡³å°‘ä¸¤ç»„abçš„ä¹˜ç§¯ \u0026#39;\u0026#39;\u0026#39; if len(getCombinationSum(sum)) \u0026lt; 2: return False else: combinationSum = getCombinationSum(sum) for i in combinationSum: status = 0 pro = i[0] * i[1] # æœ‰å…¶ä¸­ä¸€ç»„abä¸æ»¡è¶³å°±æ‰“æ–­å¾ªç¯ if len(getCombinationPro(pro)) \u0026lt; 2: status = 1 break if status == 0: return True else: return False def isSun(pro): \u0026#39;\u0026#39;\u0026#39; ç¬¬äºŒæ­¥ï¼Œä¼ å…¥çš„proæ»¡è¶³ä»¥ä¸‹æ¡ä»¶è¿”å›ä¸€ç»„abç»„åˆ(å…ƒç»„)ï¼Œå¦åˆ™False 1. å¯ä»¥æ‹†åˆ†æˆè‹¥å¹²ç»„abçš„ä¹˜ç§¯ 2. æ¯ä¸€ç»„æ‹†åˆ†å‡ºæ¥çš„abç›¸åŠ è¿ç®—å¾—sumï¼Œæ‰€æœ‰abåŠ å’Œçš„sumæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæ»¡è¶³ç¬¬ä¸€æ­¥çš„æ¡ä»¶(æ”¾å…¥isPangå‡½æ•°åè¿”å›True) \u0026#39;\u0026#39;\u0026#39; combination = [] combinationPro = getCombinationPro(pro) if len(combinationPro) \u0026gt; 1: for i in combinationPro: sum = i[0] + i[1] if isPang(sum): combination.append(i) if len(combination) == 1: return combination else: return False if __name__ == \u0026#39;__main__\u0026#39;: # ç¬¬ä¸€æ­¥ abList_1 = [] for sum in range(4, 198+1): if isPang(sum): abList_1 += getCombinationSum(sum) # ç¬¬äºŒæ­¥ abList_2 = [] proList = [] for i in abList_1: pro = i[0] * i[1] if isSun(pro): abList_2.append(i) proList.append(pro) # ç¬¬ä¸‰æ­¥ abList = [] for i in abList_2: sum = i[0] + i[1] n = 0 for j in getCombinationSum(sum): if j[0] * j[1] in proList: n += 1 if n == 1: abList.append(i) print(abList) ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/python-logic-problem-guiguzi/","summary":"åŸé¢˜å¦‚ä¸‹ é¬¼è°·å­éšæ„ä» 2-99 ä¸­é€‰å–äº†ä¸¤ä¸ªæ•°ã€‚ä»–æŠŠè¿™ä¸¤ä¸ªæ•°çš„å’Œå‘Šè¯‰äº†åºæ¶“ï¼Œ æŠŠè¿™ä¸¤ä¸ªæ•°çš„ä¹˜ç§¯å‘Šè¯‰äº†å­™è†‘ã€‚ä½†å­™è†‘å’Œåºæ¶“å½¼æ­¤ä¸çŸ¥é“å¯¹æ–¹å¾—åˆ°çš„æ•°ã€‚ç¬¬äºŒå¤©ï¼Œ åºæ¶“å¾ˆæœ‰è‡ªä¿¡çš„å¯¹å­™è†‘è¯´ï¼šè™½ç„¶æˆ‘ä¸çŸ¥é“è¿™ä¸¤ä¸ªæ•°æ˜¯ä»€ä¹ˆï¼Œä½†æˆ‘çŸ¥é“ä½ ä¸€å®šä¹Ÿä¸çŸ¥é“ã€‚éšåï¼Œå­™è†‘è¯´ï¼šé‚£æˆ‘çŸ¥é“äº†ã€‚åºæ¶“è¯´ï¼šé‚£æˆ‘ä¹ŸçŸ¥é“äº†ã€‚è¿™ä¸¤ä¸ªæ•°æ˜¯ä»€ä¹ˆï¼Ÿ ä»£","title":"python | é¬¼è°·å­æ•°å­¦é—®é¢˜"},{"content":"0 å‰è¨€ æŒ‚åˆ€æ˜¯æŒ‡ä»é¥°å“äº¤æ˜“å¹³å°è´­ä¹°æ¸¸æˆé¥°å“ï¼Œåœ¨ steam å¸‚åœºå‡ºå”®ä»¥å®ç°å°†äººæ°‘å¸è½¬æ¢ä¸º steam é˜¿æ ¹å»·è´¦å·ä½™é¢ã€‚\nsteam åœ£è¯ä¿ƒé”€æ´»åŠ¨å¿«ç»“æŸäº†ï¼Œä¹°äº†å‡ æ¬¾æ¸¸æˆåå‘ç°é˜¿æ ¹å»·è´¦å·ä½™é¢æ²¡å¤šå°‘äº†ï¼ŒæŒ‚åˆ€è¿‡ç¨‹åˆæ¯”è¾ƒç¹çï¼Œæ•…æœ‰æ­¤æ–‡è®°å½•ä¸€ä¸‹æŒ‚åˆ€æä½™é¢çš„æ­¥éª¤ã€‚\n1 æ­¥éª¤ 1.1 ç½‘æ˜“ buff è´¦å·æ³¨å†ŒåŠç»‘å®š buff è´¦å·ä½¿ç”¨æ‰‹æœºå·æ³¨å†Œå³å¯ï¼Œç»‘å®šéœ€è¦æä½™é¢çš„ steam è´¦å·ï¼ŒåŒæ—¶éœ€è¦æä¾› steam è´¦å·çš„ API key å’Œ äº¤æ˜“é“¾æ¥ï¼Œè¿™éƒ¨åˆ† buff æœ‰æ•™ç¨‹ï¼Œæˆ–è€…ç™¾åº¦ï¼Œå¾ˆå®¹æ˜“æ‰¾åˆ°\n1.2 æŒ‚åˆ€æ²¹çŒ´è„šæœ¬ è„šæœ¬é“¾æ¥\nè„šæœ¬å®‰è£…æˆåŠŸè¿›å…¥ ç½‘é¡µç‰ˆbuff åï¼Œç®€å•è®¾ç½®ä¸€ä¸‹è„šæœ¬ï¼Œæ¨èè®¾ç½®äº†ä¸€ä¸‹è´§å¸è½¬æ¢ä¸ºé˜¿æ ¹å»·æ¯”ç´¢å’Œé»˜è®¤æ’åºè§„åˆ™\n1.3 è„šæœ¬æä¾›çš„ä¿¡æ¯ æ¯ä¸ªé¥°å“éœ€è¦å…³æ³¨çš„æœ‰å¦‚ä¸‹ä¿¡æ¯ï¼š\næŒ‚åˆ€æ¯”ä¾‹ è¶Šä½ä»£è¡¨å”®å‡ºåå¯è·å¾—çš„ä½™é¢æ›´å¤š å·¦è¾¹æ˜¯ buff å”®ä»·ï¼Œå³è¾¹æ˜¯å¸‚åœºå”®ä»·ï¼ˆé˜¿æ ¹å»·æ¯”ç´¢ï¼‰\nsteam æ±‚è´­äººæ•°\n1.4 å¯»æ‰¾åˆé€‚é¥°å“ ä»¥ä»¥ä¸‹å‡ ä¸ªç»´åº¦å…¥æ‰‹ï¼Œé€‰æ‹©åˆé€‚çš„é¥°å“ï¼š\næ¯”ä¾‹è¾ƒä½ æ±‚è´­äººæ•°å¤š ä»·æ ¼åˆé€‚ï¼Œå¤ªé«˜å¯èƒ½å–çš„æ…¢ï¼Œå¤ªä½è¦è¾¾åˆ°è‡ªå·±çš„è¦æ±‚å¯èƒ½éœ€è¦å€’å¥½å‡ ä¸ªç”šè‡³åå‡ ä¸ªé¥°å“æ‰å¤Ÿ é€‰æ‹©å¥½åç›´æ¥è´­ä¹°å³å¯ï¼Œåç»­æ­¥éª¤æŒ‰ç…§ buff æ•™ç¨‹æ¥\n1.5 å–å‡ºé¥°å“ è„šæœ¬æä¾›çš„æ”¶ç›Šåªèƒ½å‚è€ƒï¼Œå…·ä½“è¿˜æ˜¯è¦åœ¨å¸‚åœºçœ‹ï¼Œç€æ€¥å°±æŒ‰ç…§æœ€ä½ä»·å–å³å¯ï¼Œåˆ«äººè´­ä¹°åå°±å¯ä»¥æ„‰å¿«çš„ä¹°æ–°æ¸¸æˆå•¦\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/life/steam-guadao/","summary":"0 å‰è¨€ æŒ‚åˆ€æ˜¯æŒ‡ä»é¥°å“äº¤æ˜“å¹³å°è´­ä¹°æ¸¸æˆé¥°å“ï¼Œåœ¨ steam å¸‚åœºå‡ºå”®ä»¥å®ç°å°†äººæ°‘å¸è½¬æ¢ä¸º steam é˜¿æ ¹å»·è´¦å·ä½™é¢ã€‚ steam åœ£è¯ä¿ƒé”€æ´»åŠ¨å¿«ç»“æŸäº†ï¼Œä¹°äº†å‡ æ¬¾æ¸¸æˆåå‘ç°é˜¿æ ¹å»·è´¦å·ä½™é¢æ²¡å¤šå°‘äº†ï¼ŒæŒ‚åˆ€è¿‡ç¨‹åˆæ¯”è¾ƒç¹çï¼Œæ•…æœ‰æ­¤æ–‡è®°å½•ä¸€ä¸‹æŒ‚åˆ€æä½™é¢çš„æ­¥éª¤ã€‚ 1 æ­¥éª¤ 1.1 ç½‘æ˜“ buff è´¦å·æ³¨å†ŒåŠç»‘å®š buff è´¦å·ä½¿ç”¨æ‰‹æœºå·æ³¨å†Œå³å¯ï¼Œç»‘å®šéœ€è¦æä½™é¢","title":"steamæŒ‚åˆ€æ•™ç¨‹"},{"content":"åœ¨ /etc/prifile.d ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œç”¨æˆ·ç™»å½•ç³»ç»Ÿæ—¶è‡ªåŠ¨ç”Ÿæ•ˆ\nvim /etc/profile.d/history_conf.sh source /etc/profile.d/history_conf.sh # æ‰‹åŠ¨ç”Ÿæ•ˆ æ–‡ä»¶å†…å®¹\nexport HISTFILE=\u0026#34;$HOME/.bash_history\u0026#34; # æŒ‡å®šå‘½ä»¤å†™å…¥æ–‡ä»¶(é»˜è®¤~/.bash_history) export HISTSIZE=1000 # historyè¾“å‡ºè®°å½•æ•° export HISTFILESIZE=10000 # HISTFILEæ–‡ä»¶è®°å½•æ•° export HISTIGNORE=\u0026#34;cmd1:cmd2:...\u0026#34; # å¿½ç•¥æŒ‡å®šcmd1,cmd2...çš„å‘½ä»¤ä¸è¢«è®°å½•åˆ°æ–‡ä»¶ï¼›(åŠ å‚æ•°æ—¶ä¼šè®°å½•) export HISTCONTOL=ignoredups # ignoredups ä¸è®°å½•â€œé‡å¤â€çš„å‘½ä»¤ï¼›è¿ç»­ä¸”ç›¸åŒ æ–¹ä¸ºâ€œé‡å¤â€ ï¼› # ignorespace ä¸è®°å½•æ‰€æœ‰ä»¥ç©ºæ ¼å¼€å¤´çš„å‘½ä»¤ï¼› # ignoreboth è¡¨ç¤ºignoredups:ignorespace ,æ•ˆæœç›¸å½“äºä»¥ä¸Šä¸¤ç§çš„ç»„åˆï¼› # erasedups åˆ é™¤é‡å¤å‘½ä»¤ï¼› export PROMPT_COMMAND=\u0026#34;history -a\u0026#34; # è®¾ç½®æ¯æ¡å‘½ä»¤æ‰§è¡Œå®Œç«‹å³å†™å…¥HISTFILE(é»˜è®¤ç­‰å¾…é€€å‡ºä¼šè¯å†™å…¥) export HISTTIMEFORMAT=\u0026#34;`whoami` %F %T \u0026#34; # è®¾ç½®å‘½ä»¤æ‰§è¡Œæ—¶é—´æ ¼å¼ï¼Œè®°å½•æ–‡ä»¶å¢åŠ æ—¶é—´æˆ³ shopt -s histappend # é˜²æ­¢ä¼šè¯é€€å‡ºæ—¶è¦†ç›–å…¶ä»–ä¼šè¯å†™åˆ°HISTFILEçš„å†…å®¹ï¼› æ•ˆæœå¦‚ä¸‹\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/linux-history-format/","summary":"åœ¨ /etc/prifile.d ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œç”¨æˆ·ç™»å½•ç³»ç»Ÿæ—¶è‡ªåŠ¨ç”Ÿæ•ˆ vim /etc/profile.d/history_conf.sh source /etc/profile.d/history_conf.sh # æ‰‹åŠ¨ç”Ÿæ•ˆ æ–‡ä»¶å†…å®¹ export HISTFILE=\u0026#34;$HOME/.bash_history\u0026#34; # æŒ‡å®šå‘½ä»¤å†™å…¥æ–‡ä»¶(é»˜è®¤~/.bash_history) export HISTSIZE=1000 # historyè¾“å‡ºè®°å½•æ•° export HISTFILESIZE=10000 # HISTFILEæ–‡ä»¶è®°å½•æ•° export HISTIGNORE=\u0026#34;cmd1:cmd2:...\u0026#34; # å¿½ç•¥æŒ‡å®šcmd1,cmd2...çš„å‘½ä»¤ä¸è¢«è®°å½•åˆ°æ–‡ä»¶ï¼›(åŠ å‚æ•°æ—¶ä¼šè®°å½•) export HISTCONTOL=ignoredups # ignoredups","title":"linux | history å‘½ä»¤çš„æ ¼å¼åŒ–è¾“å‡º"},{"content":"æµç¨‹å›¾\nä»£ç ç¤ºä¾‹\nä½¿ç”¨å‰éœ€è¦ç™»å½• harbor\nç¡®ä¿é•œåƒçš„é¡¹ç›®ååœ¨ harbor ä¸­å·²å­˜åœ¨\næ ¼å¼ä¸‰ç±»å‹çš„é•œåƒä¼šæ¨é€åˆ° harbor çš„ library é¡¹ç›®ä¸­\n#!/bin/bash # author: Amadeus Liu # date: 2022-10-11 17:02:13 # version: 1.0 harbor_url=\u0026#34;local.harbor.com\u0026#34; log_file=\u0026#34;/var/log/push-harbor.log\u0026#34; image_id=$(docker images -q | sort -u) ls ${log_file} || touch ${log_file} echo \u0026#34;############# $(date \u0026#34;+%Y-%m-%d %H:%M:%S\u0026#34;) #############\u0026#34; \u0026gt;\u0026gt; ${log_file} get_image_tags () { docker inspect $1 --format=\u0026#39;{{.RepoTags}}\u0026#39; | sed \u0026#39;s/\\[//g\u0026#39; | sed \u0026#39;s/\\]//g\u0026#39; } image_tag_and_push () { docker tag $1 $2 \u0026amp;\u0026amp; echo \u0026#34;docker tag $1 $2\u0026#34; \u0026gt;\u0026gt; ${log_file} docker push $2 \u0026amp;\u0026amp; echo \u0026#34;docker pull $1 $2\u0026#34; \u0026gt;\u0026gt; ${log_file} } for i in ${image_id}; do # åˆ¤æ–­é•œåƒæ˜¯å¦æœ‰harborä»“åº“çš„æ ‡ç­¾ï¼Œæœ‰åˆ™è§†ä¸ºharborä»“åº“ä¸­å·²æœ‰ if [[ $(get_image_tags $i) =~ ${harbor_url} ]]; then echo \u0026#34;å·²æœ‰${harbor_url}ä»“åº“æ ‡ç­¾-----$(get_image_tags $i)\u0026#34; else # é•œåƒçš„ç¬¬ä¸€ä¸ªå®Œæ•´æ ‡ç­¾ image_tag_first=$(echo $(get_image_tags $i) | awk -F\u0026#39; \u0026#39; \u0026#39;{print $1}\u0026#39;) # é•œåƒçš„ç¬¬ä¸€ä¸ªå®Œæ•´æ ‡ç­¾å¹¶å»é™¤ç‰ˆæœ¬ image_tag_first_delete_ver=$(echo ${image_tag_first} | awk -F\u0026#39;:\u0026#39; \u0026#39;{print $1}\u0026#39;) # åˆ¤æ–­æ ‡ç­¾å±äºå“ªç§æ ¼å¼ if [[ ${image_tag_first_delete_ver} =~ \u0026#34;/\u0026#34; ]]; then # é•œåƒçš„ç¬¬ä¸€ä¸ªå®Œæ•´æ ‡ç­¾çš„ç¬¬ä¸€éƒ¨åˆ†ï¼ˆ\u0026#39;/\u0026#39;åˆ†å‰²åçš„$1ï¼‰ image_tag_first_repo=$(echo ${image_tag_first_delete_ver}| awk -F\u0026#39;/\u0026#39; \u0026#39;{print $1}\u0026#39;) if [[ \u0026#34;${image_tag_first_repo}\u0026#34; =~ \u0026#34;.\u0026#34; ]]; then # æ ¼å¼ä¸€ image_tag_harbor=\u0026#34;${harbor_url}/$(echo ${image_tag_first} | awk -F\u0026#39;/\u0026#39; \u0026#39;{print $2}\u0026#39;)/$(echo ${image_tag_first} | awk -F\u0026#39;/\u0026#39; \u0026#39;{print $3}\u0026#39;)\u0026#34; echo \u0026#34;${image_tag_first} \u0026gt;\u0026gt;\u0026gt;\u0026gt;\u0026gt;tag to\u0026gt;\u0026gt;\u0026gt;\u0026gt;\u0026gt; ${image_tag_harbor}\u0026#34; image_tag_and_push $i ${image_tag_harbor} else # æ ¼å¼äºŒ image_tag_harbor=\u0026#34;${harbor_url}/${image_tag_first}\u0026#34; echo \u0026#34;${image_tag_first} \u0026gt;\u0026gt;\u0026gt;\u0026gt;\u0026gt;tag to\u0026gt;\u0026gt;\u0026gt;\u0026gt;\u0026gt; ${image_tag_harbor}\u0026#34; image_tag_and_push $i ${image_tag_harbor} fi else # æ ¼å¼ä¸‰ image_tag_harbor=\u0026#34;${harbor_url}/library/${image_tag_first}\u0026#34; echo \u0026#34;${image_tag_first} \u0026gt;\u0026gt;\u0026gt;\u0026gt;\u0026gt;tag to\u0026gt;\u0026gt;\u0026gt;\u0026gt;\u0026gt; ${image_tag_harbor}\u0026#34; image_tag_and_push $i ${image_tag_harbor} fi fi done è…¾è®¯äº‘æ¬è¿å£°æ˜\næˆ‘çš„åšå®¢å³å°†åŒæ­¥è‡³è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒºï¼Œé‚€è¯·å¤§å®¶ä¸€åŒå…¥é©»ï¼šhttps://cloud.tencent.com/developer/support-plan?invite_code=3ielzwnut2qsg\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/shell-push-harbor/","summary":"æµç¨‹å›¾ ä»£ç ç¤ºä¾‹ ä½¿ç”¨å‰éœ€è¦ç™»å½• harbor ç¡®ä¿é•œåƒçš„é¡¹ç›®ååœ¨ harbor ä¸­å·²å­˜åœ¨ æ ¼å¼ä¸‰ç±»å‹çš„é•œåƒä¼šæ¨é€åˆ° harbor çš„ library é¡¹ç›®ä¸­ #!/bin/bash # author: Amadeus Liu # date: 2022-10-11 17:02:13 # version: 1.0 harbor_url=\u0026#34;local.harbor.com\u0026#34; log_file=\u0026#34;/var/log/push-harbor.log\u0026#34; image_id=$(docker images -q | sort -u) ls ${log_file} || touch ${log_file} echo \u0026#34;############# $(date \u0026#34;+%Y-%m-%d %H:%M:%S\u0026#34;) #############\u0026#34; \u0026gt;\u0026gt; ${log_file} get_image_tags () { docker inspect $1 --format=\u0026#39;{{.RepoTags}}\u0026#39; | sed \u0026#39;s/\\[//g\u0026#39; | sed \u0026#39;s/\\]//g\u0026#39; } image_tag_and_push () { docker tag $1 $2 \u0026amp;\u0026amp; echo \u0026#34;docker tag $1 $2\u0026#34; \u0026gt;\u0026gt; ${log_file} docker push $2 \u0026amp;\u0026amp; echo \u0026#34;docker pull $1 $2\u0026#34; \u0026gt;\u0026gt; ${log_file} } for i in ${image_id}; do # åˆ¤æ–­é•œåƒæ˜¯å¦æœ‰harbor","title":"shell | å°†æœ¬åœ°é•œåƒæ‰¹é‡æ¨é€åˆ° harbor"},{"content":"ä¹‹å‰æœ¬åœ°åšä¸€äº›æµ‹è¯•çš„æ—¶å€™å¤šæ¬¡ä¿®æ”¹è¿‡ hosts æ–‡ä»¶ï¼Œå¯¼è‡´ hosts æ–‡ä»¶å‡ºç°äº†æŸäº›é—®é¢˜ï¼ŒæŒ‰ç…§ç½‘ä¸Šå¾ˆå¤šæ–¹å¼è‡ªå»º hosts æ–‡ä»¶ã€ä¿®æ”¹ç¼–ç æ ¼å¼ã€åŒ…æ‹¬ä½¿ç”¨ä¸€äº›ç¬¬ä¸‰æ–¹å·¥å…·ä¿®å¤éƒ½æ²¡æœ‰ä½œç”¨ï¼Œè®°å½•ä¸€ä¸‹æˆåŠŸä¿®å¤ hosts æ–‡ä»¶çš„æ­¥éª¤\nä½¿ç”¨ç®¡ç†å‘˜æƒé™æ‰“å¼€å‘½ä»¤æç¤ºç¬¦\næ‰§è¡Œå¦‚ä¸‹ä»£ç \nfor /f %P in (\u0026#39;dir %windir%\\WinSxS\\hosts /b /s\u0026#39;) do copy %P %windir%\\System32\\drivers\\etc \u0026amp; echo %P \u0026amp; Notepad %P ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/windows-fix-hosts/","summary":"ä¹‹å‰æœ¬åœ°åšä¸€äº›æµ‹è¯•çš„æ—¶å€™å¤šæ¬¡ä¿®æ”¹è¿‡ hosts æ–‡ä»¶ï¼Œå¯¼è‡´ hosts æ–‡ä»¶å‡ºç°äº†æŸäº›é—®é¢˜ï¼ŒæŒ‰ç…§ç½‘ä¸Šå¾ˆå¤šæ–¹å¼è‡ªå»º hosts æ–‡ä»¶ã€ä¿®æ”¹ç¼–ç æ ¼å¼ã€åŒ…æ‹¬ä½¿ç”¨ä¸€äº›ç¬¬ä¸‰æ–¹å·¥å…·ä¿®å¤éƒ½æ²¡æœ‰ä½œç”¨ï¼Œè®°å½•ä¸€ä¸‹æˆåŠŸä¿®å¤ hosts æ–‡ä»¶çš„æ­¥éª¤ ä½¿ç”¨ç®¡ç†å‘˜æƒé™æ‰“å¼€å‘½ä»¤æç¤ºç¬¦ æ‰§è¡Œå¦‚ä¸‹ä»£ç  for /f %P in (\u0026#39;dir %windir%\\WinSxS\\hosts /b /s\u0026#39;) do copy %P %windir%\\System32\\drivers\\etc \u0026amp; echo %P \u0026amp; Notepad %P ä»¥ä¸Š","title":"windows | hosts æ–‡ä»¶ä¿®å¤"},{"content":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0\n1 ConfigMap åˆ›å»º ConfigMap åï¼Œæ•°æ®å®é™…ä¼šå­˜å‚¨åœ¨ k8s ä¸­çš„ Etcd ä¸­ï¼Œç„¶åé€šè¿‡åˆ›å»º pod æ—¶å¼•ç”¨è¯¥æ•°æ®ã€‚\nåº”ç”¨åœºæ™¯ï¼šåº”ç”¨ç¨‹åºé…ç½®\npod ä½¿ç”¨ ConfigMap æ•°æ®æœ‰ä¸¤ç§æ–¹å¼ï¼š\nå˜é‡æ³¨å…¥ æ•°æ®å·æŒ‚è½½ å¯ä»¥é€šè¿‡è¯»å–ç›®å½•æˆ–è€…æ–‡ä»¶å¿«é€Ÿåˆ›å»º configmap\nkubectl create configmap \u0026lt;configmap-name\u0026gt; \\ --from-file=[key-name]=\u0026lt;path\u0026gt; \\ # key ä¸æŒ‡å®šæ—¶ä½¿ç”¨æ–‡ä»¶åä½œä¸º key æ–‡ä»¶å†…å®¹ä½œä¸º valueï¼Œpath æ—¢å¯ä»¥æ–‡ä»¶ä¹Ÿå¯ä»¥æ˜¯ç›®å½• --from-env-file=\u0026lt;path\u0026gt; \\ # æ–‡ä»¶å†…å®¹åº”æ˜¯ key=value çš„å½¢å¼ï¼Œé€è¡Œè¯»å– --from-literal=\u0026lt;key\u0026gt;=\u0026lt;value\u0026gt; \\ # é€šè¿‡æŒ‡å®šçš„é”®å€¼å¯¹åˆ›å»º configmap yaml ç¤ºä¾‹\napiVersion: v1 kind: ConfigMap metadata: name: configmap-demo data: abc: \u0026#34;123\u0026#34; cde: \u0026#34;456\u0026#34; redis.properties: | port: 6379 host: 1.1.1.4 password: 123456 --- apiVersion: v1 kind: Pod metadata: name: pod-configmap spec: containers: - name: demo image: nginx:1.19 env: - name: ABCD valueFrom: configMapKeyRef: name: configmap-demo key: abc - name: CDEF valueFrom: configMapKeyRef: name: configmap-demo key: cde volumeMounts: - name: config mountPath: \u0026#34;/config\u0026#34; readOnly: true volumes: - name: config configMap: name: configmap-demo items: - key: \u0026#34;redis.properties\u0026#34; path: \u0026#34;redis.properties\u0026#34; # æŒ‚è½½æ–‡ä»¶å å®¹å™¨å†…éªŒè¯\n[root@k8s-node1 ~]# kubectl exec -it pod-configmap -- bash root@pod-configmap:/# echo $ABCD 123 root@pod-configmap:/# echo $CDEF 456 root@pod-configmap:/# cat /config/redis.properties port: 6379 host: 1.1.1.4 password: 123456 2 Secret ä¸ ConfigMap ç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äº Secret ä¸»è¦å­˜å‚¨æ•æ„Ÿæ•°æ®ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½ä¼šç»è¿‡ base64 ç¼–ç ã€‚\nSecret æ”¯æŒä¸‰ç§æ•°æ®ç±»å‹ï¼š\ndocker-registryï¼šå­˜å‚¨é•œåƒä»“åº“è®¤è¯ä¿¡æ¯ genericï¼šä»æ–‡ä»¶ã€ç›®å½•æˆ–è€…å­—ç¬¦ä¸²åˆ›å»ºï¼Œä¾‹å¦‚å­˜å‚¨ç”¨æˆ·åå¯†ç  tlsï¼šå­˜å‚¨è¯ä¹¦ï¼Œä¾‹å¦‚ HTTPS è¯ä¹¦ ç¤ºä¾‹\nå°†ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œç¼–ç \n[root@k8s-node1 ~]# echo -n \u0026#39;admin\u0026#39; | base64 YWRtaW4= [root@k8s-node1 ~]# echo -n \u0026#39;123.com\u0026#39; | base64 MTIzLmNvbQ== secret.yaml\napiVersion: v1 kind: Secret metadata: name: db-pass type: Opaque data: username: YWRtaW4= password: MTIzLmNvbQ== pod-secret.yaml\napiVersion: v1 kind: Pod metadata: name: pod-secret-demo spec: containers: - name: demo image: nginx:1.19 env: - name: USER # å˜é‡å valueFrom: secretKeyRef: name: db-pass key: username - name: PASS # å˜é‡å valueFrom: secretKeyRef: name: db-pass key: password volumeMounts: - name: config mountPath: \u0026#34;/config\u0026#34; readOnly: true volumes: - name: config secret: secretName: db-pass items: - key: password path: my-password # æŒ‚è½½æ–‡ä»¶å éªŒè¯\n[root@k8s-node1 ~]# kubectl apply -f secret.yaml secret/db-pass created [root@k8s-node1 ~]# kubectl apply -f pod-secret.yaml pod/pod-secret-demo created [root@k8s-node1 ~]# kubectl exec -it pod-secret-demo -- bash root@pod-secret-demo:/# echo $USER admin root@pod-secret-demo:/# echo $PASS 123.com root@pod-secret-demo:/# cat /config/my-password 123.com ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-configmap-secret/","summary":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0 1 ConfigMap åˆ›å»º ConfigMap åï¼Œæ•°æ®å®é™…ä¼šå­˜å‚¨åœ¨ k8s ä¸­çš„ Etcd ä¸­ï¼Œç„¶åé€šè¿‡åˆ›å»º pod æ—¶å¼•ç”¨è¯¥æ•°æ®ã€‚ åº”ç”¨åœºæ™¯ï¼šåº”ç”¨ç¨‹åºé…ç½® pod ä½¿ç”¨ ConfigMap æ•°æ®æœ‰ä¸¤ç§æ–¹å¼ï¼š å˜é‡æ³¨å…¥ æ•°æ®å·æŒ‚è½½ å¯ä»¥é€šè¿‡è¯»å–ç›®å½•æˆ–è€…æ–‡ä»¶å¿«é€Ÿåˆ›å»º configmap kubectl create configmap \u0026lt;configmap-name\u0026gt; \\ --from-file=[key-name]=\u0026lt;path\u0026gt;","title":"kubernetes | configmap \u0026 secret"},{"content":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0\n1 kubernetes å®‰å…¨æ¡†æ¶ å®¢æˆ·ç«¯è¦æƒ³è®¿é—® K8s é›†ç¾¤ API Serverï¼Œä¸€èˆ¬éœ€è¦ CA è¯ä¹¦ã€Token æˆ–è€…ç”¨æˆ·å + å¯†ç  å¦‚æœ Pod è®¿é—®ï¼Œéœ€è¦ ServiceAccount K8S å®‰å…¨æ§åˆ¶æ¡†æ¶ä¸»è¦ç”±ä¸‹é¢ 3 ä¸ªé˜¶æ®µè¿›è¡Œæ§åˆ¶ï¼Œæ¯ä¸€ä¸ªé˜¶æ®µéƒ½æ”¯æŒæ’ä»¶æ–¹å¼ï¼Œé€šè¿‡ API Server é…ç½®æ¥å¯ç”¨æ’ä»¶ã€‚\nAuthenticationï¼ˆé‰´æƒï¼‰ Authorizationï¼ˆæˆæƒï¼‰ Admission Controlï¼ˆå‡†å…¥æ§åˆ¶ï¼‰ 1.1 é‰´æƒ (Authentication) ä¸‰ç§å®¢æˆ·ç«¯èº«ä»½è®¤è¯ï¼š\nHTTPS è¯ä¹¦è®¤è¯ï¼šåŸºäº CA è¯ä¹¦ç­¾åçš„æ•°å­—è¯ä¹¦è®¤è¯ HTTP Token è®¤è¯ï¼šé€šè¿‡ä¸€ä¸ª Token æ¥è¯†åˆ«ç”¨æˆ· HTTP Base è®¤è¯ï¼šç”¨æˆ·å + å¯†ç çš„æ–¹å¼è®¤è¯ 1.2 æˆæƒ (Authorization) RBACï¼ˆRole-Based Access Controlï¼ŒåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰ï¼šè´Ÿè´£å®Œæˆæˆæƒï¼ˆAuthorizationï¼‰å·¥ä½œã€‚\nRBAC æ ¹æ® API è¯·æ±‚å±æ€§ï¼Œå†³å®šå…è®¸è¿˜æ˜¯æ‹’ç»ã€‚\næ¯”è¾ƒå¸¸è§çš„æˆæƒç»´åº¦ï¼š\nuserï¼šç”¨æˆ·å groupï¼šç”¨æˆ·åˆ†ç»„ èµ„æºï¼Œä¾‹å¦‚ podã€deployment èµ„æºæ“ä½œæ–¹æ³•ï¼šgetï¼Œlistï¼Œcreateï¼Œupdateï¼Œpatchï¼Œwatchï¼Œdelete å‘½åç©ºé—´ API ç»„ 1.3 å‡†å…¥æ§åˆ¶ (Admission Control) Adminssion Control å®é™…ä¸Šæ˜¯ä¸€ä¸ªå‡†å…¥æ§åˆ¶å™¨æ’ä»¶åˆ—è¡¨ï¼Œå‘é€åˆ° API Server çš„è¯·æ±‚éƒ½éœ€è¦ç»è¿‡è¿™ä¸ªåˆ—è¡¨ä¸­çš„æ¯ä¸ªå‡†å…¥æ§åˆ¶å™¨æ’ä»¶çš„æ£€æŸ¥ï¼Œæ£€æŸ¥ä¸é€šè¿‡ï¼Œåˆ™æ‹’ç»è¯·æ±‚\n2 RBAC https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/\n2.1 åŸºç¡€æ¦‚å¿µ RBACï¼ˆRole-Based Access Controlï¼ŒåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰ï¼Œå…è®¸é€šè¿‡ Kubernetes API åŠ¨æ€é…ç½®ç­–ç•¥ã€‚\nè§’è‰²\nRoleï¼šæˆæƒç‰¹å®šå‘½åç©ºé—´çš„è®¿é—®æƒé™ ClusterRoleï¼šæˆæƒæ‰€æœ‰å‘½åç©ºé—´çš„è®¿é—®æƒé™ è§’è‰²ç»‘å®š\nRoleBindingï¼šå°†è§’è‰²ç»‘å®šåˆ°ä¸»ä½“ï¼ˆå³ subjectï¼‰ ClusterRoleBindingï¼šå°†é›†ç¾¤è§’è‰²ç»‘å®šåˆ°ä¸»ä½“ ä¸»ä½“ï¼ˆsubjectï¼‰\nUserï¼šç”¨æˆ· Groupï¼šç”¨æˆ·ç»„ ServiceAccountï¼šæœåŠ¡è´¦å· 2.2 ç¤ºä¾‹ ä¸º Amadeus ç”¨æˆ·æˆæƒ default å‘½åç©ºé—´ Pod è¯»å–æƒé™\n2.2.1 æ–°å»ºç”¨æˆ· æ–°å»ºä¸€ä¸ª k8s ç”¨æˆ·å¤§æ¦‚å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š\nç­¾å‘ç”¨æˆ·è¯ä¹¦ ç”Ÿæˆç”¨æˆ·çš„è¯ä¹¦ key é€šè¿‡ç”¨æˆ·çš„è¯ä¹¦ keyï¼Œç”Ÿæˆç”¨æˆ·çš„è¯ä¹¦è¯·æ±‚ (csr) é€šè¿‡ k8s api çš„ ca è¯ä¹¦å»ç­¾å‘ç”¨æˆ·çš„è¯ä¹¦è¯·æ±‚ï¼Œç”Ÿæˆç”¨æˆ·çš„è¯ä¹¦ (crt) ç”Ÿæˆ kubeconfig é…ç½®æ–‡ä»¶ kubectl config set-cluster //é›†ç¾¤é…ç½® kubectl config set-credentials //ç”¨æˆ·é…ç½® kubectl config set-context //context é…ç½® kubectl config use-context //ä½¿ç”¨ context ä½¿ç”¨æ–°åˆ›å»ºçš„ç”¨æˆ· kubectl \u0026ndash;kubecofig=path // é€šè¿‡å‚æ•°æŒ‡å®š KUBECONFIG=path kubectl // é€šè¿‡ç¯å¢ƒå˜é‡æŒ‡å®šï¼Œpath å¯ä»¥æŒ‡å®šå¤šä¸ªï¼Œç”¨ : è¿æ¥ï¼Œä»è€Œå°†å¤šä¸ªé…ç½®æ–‡ä»¶åˆå¹¶åœ¨ä¸€èµ·ä½¿ç”¨ 2.2.2 ç­¾å‘ç”¨æˆ·è¯ä¹¦ å¯ä»¥ä½¿ç”¨ openssl æˆ–è€… cfssl è¿›è¡Œç­¾å‘ï¼Œä»»é€‰ä¸€ç§\n[root@k8s-node1 ~]# mkdir -p /etc/kubernetes/users/Amadeus [root@k8s-node1 ~]# cd /etc/kubernetes/users/Amadeus/ openssl\n# åˆ›å»ºç”¨æˆ·è¯ä¹¦ key [root@k8s-node1 Amadeus]# openssl genrsa -out Amadeus.key 2048 # åˆ›å»ºç”¨æˆ·è¯ä¹¦è¯·æ±‚ (csr)ï¼Œ-subj æŒ‡å®šç»„å’Œç”¨æˆ·ï¼Œå…¶ä¸­ O æ˜¯ç»„åï¼ŒCN æ˜¯ç”¨æˆ·å [root@k8s-node1 Amadeus]# openssl req -new -key Amadeus.key -out Amadeus.csr -subj \u0026#34;/O=hello/CN=Amadeus\u0026#34; # ç”Ÿæˆç”¨æˆ·çš„è¯ä¹¦ (crt)ï¼Œä½¿ç”¨ k8s çš„ ca ç­¾å‘ç”¨æˆ·è¯ä¹¦ [root@k8s-node1 Amadeus]# openssl x509 -req -in Amadeus.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out Amadeus.crt -days 3650 [root@k8s-node1 Amadeus]# ls Amadeus.crt Amadeus.csr Amadeus.key cfssl\nä¸‹è½½ cfssl å·¥å…·\nwget --no-check-certificate https://github.com/cloudflare/cfssl/releases/download/1.2.0/cfssl_linux-amd64 wget --no-check-certificate https://github.com/cloudflare/cfssl/releases/download/1.2.0/cfssljson_linux-amd64 wget --no-check-certificate https://github.com/cloudflare/cfssl/releases/download/1.2.0/cfssl-certinfo_linux-amd64 chmod a+x cfssl* mv cfssl_linux-amd64 /usr/bin/cfssl mv cfssljson_linux-amd64 /usr/bin/cfssljson mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo [root@k8s-node1 ~]# cfssl version Version: 1.2.0 Revision: dev Runtime: go1.6 åˆ›å»º ca-config.json è¯ä¹¦æ–‡ä»¶\ncat \u0026gt; ca-config.json \u0026lt;\u0026lt;EOF { \u0026#34;signing\u0026#34;: { \u0026#34;default\u0026#34;: { \u0026#34;expiry\u0026#34;: \u0026#34;87600h\u0026#34; }, \u0026#34;profiles\u0026#34;: { \u0026#34;kubernetes\u0026#34;: { \u0026#34;usages\u0026#34;: [ \u0026#34;signing\u0026#34;, \u0026#34;key encipherment\u0026#34;, \u0026#34;server auth\u0026#34;, \u0026#34;client auth\u0026#34; ], \u0026#34;expiry\u0026#34;: \u0026#34;87600h\u0026#34; } } } } EOF Amadeus-csr.json è¯ä¹¦æ–‡ä»¶\ncat \u0026gt; Amadeus-csr.json \u0026lt;\u0026lt;EOF { \u0026#34;CN\u0026#34;: \u0026#34;Amadeus\u0026#34;, \u0026#34;hosts\u0026#34;: [], \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;CN\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;BeiJing\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;BeiJing\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;k8s\u0026#34;, \u0026#34;OU\u0026#34;: \u0026#34;System\u0026#34; } ] } EOF ç”Ÿæˆè¯ä¹¦\n[root@k8s-node1 ~]# cfssl gencert -ca=/etc/kubernetes/pki/ca.crt -ca-key=/etc/kubernetes/pki/ca.key -config=ca-config.json -profile=kubernetes Amadeus-csr.json | cfssljson -bare Amadeus # ç”Ÿæˆæ—¶ä¼šæœ‰è­¦å‘Šï¼Œå¯ä»¥å¿½ç•¥ï¼Œæ˜¯å› ä¸ºæä¾›çš„ä¿¡æ¯ä¸æ˜¯å¾ˆå…¨ [root@k8s-node1 ~]# ls Amadeus* # ç”Ÿæˆå¦‚ä¸‹ä¸‰ä¸ªæ–‡ä»¶ Amadeus.csr # csr Amadeus-key.pem # key Amadeus.pem # crt é…ç½® kubeconfig é…ç½®æ–‡ä»¶\nç”Ÿæˆ kubeconfig æ–‡ä»¶ï¼Œå¹¶å°† cluster ä¿¡æ¯æ·»åŠ è¿›å»\nkubectl config set-cluster kubernetes \\ --certificate-authority=/etc/kubernetes/pki/ca.crt \\ --embed-certs=true \\ --server=https://1.1.1.1:6443 \\ --kubeconfig=Amadeus.kubeconfig # --embed-certs=true è¡¨ç¤ºå°†è¯ä¹¦å†™å…¥etcd ä¸º kubeconfig é…ç½®æ–‡ä»¶æ·»åŠ ç”¨æˆ·é…ç½®ï¼šè®¾ç½®ç”¨æˆ·è¯ä¹¦ (crt) å’Œè¯ä¹¦ key\nkubectl config set-credentials Amadeus \\ --client-key=Amadeus-key.pem \\ --client-certificate=Amadeus.pem \\ --embed-certs=true \\ --kubeconfig=Amadeus.kubeconfig ä¸º kubeconfig é…ç½®æ–‡ä»¶æ·»åŠ  context\nkubectl config set-context Amadeus@kubernetes \\ --cluster=kubernetes \\ --user=Amadeus \\ --kubeconfig=Amadeus.kubeconfig ä¸º kubeconfig é…ç½®æ–‡ä»¶è®¾ç½®ä½¿ç”¨çš„ context\nkubectl config use-context Amadeus@kubernetes --kubeconfig=Amadeus.kubeconfig æŸ¥çœ‹ç”Ÿæˆçš„é…ç½®æ–‡ä»¶\n# KUBECONFIG=./Amadeus.kubeconfig kubectl config view apiVersion: v1 clusters: - cluster: certificate-authority-data: DATA+OMITTED server: https://1.1.1.1:6443 name: kubernetes contexts: - context: cluster: kubernetes user: Amadeus name: Amadeus@kubernetes current-context: Amadeus@kubernetes kind: Config preferences: {} users: - name: Amadeus user: client-certificate-data: REDACTED client-key-data: REDACTED 2.2.3 åˆ›å»º RBAC æƒé™ç­–ç•¥ ä½¿ Amadeus ç”¨æˆ·æœ‰æƒé™æŸ¥çœ‹ default å‘½åç©ºé—´ä¸‹çš„ pod\napiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: namespace: default name: pod-reader rules: - apiGroups: [\u0026#34;\u0026#34;] # apiç»„ï¼Œç½®ç©ºä¸ºæ ¸å¿ƒç»„ resources: [\u0026#34;pods\u0026#34;] # èµ„æº verbs: [\u0026#34;get\u0026#34;, \u0026#34;watch\u0026#34;, \u0026#34;list\u0026#34;] # å¯¹èµ„æºçš„æ“ä½œ --- apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: read-pods namespace: default subjects: - kind: User name: Amadeus # ç»‘å®šçš„ç”¨æˆ·å apiGroup: rbac.authorization.k8s.io roleRef: kind: Role name: pod-reader apiGroup: rbac.authorization.k8s.io 2.2.4 æµ‹è¯•éªŒè¯ [root@k8s-node1 ~]# kubectl apply -f demo-rbac.yml role.rbac.authorization.k8s.io/pod-reader created rolebinding.rbac.authorization.k8s.io/read-pods created # podå¯ä»¥æ­£å¸¸æŸ¥çœ‹ [root@k8s-node1 ~]# cp /etc/kubernetes/users/Amadeus/Amadeus.kubeconfig /root/ [root@k8s-node1 ~]# KUBECONFIG=/root/Amadeus.kubeconfig kubectl get pods -n default NAME READY STATUS RESTARTS AGE bar-664fbc5498-kz4sr 1/1 Running 0 18h bar-664fbc5498-r74vl 1/1 Running 0 18h bar-664fbc5498-smqxm 1/1 Running 0 18h ...... # å…¶ä»–èµ„æºéƒ½æ²¡æœ‰æƒé™ [root@k8s-node1 ~]# KUBECONFIG=/root/Amadeus.kubeconfig kubectl get nodes Error from server (Forbidden): nodes is forbidden: User \u0026#34;Amadeus\u0026#34; cannot list resource \u0026#34;nodes\u0026#34; in API group \u0026#34;\u0026#34; at the cluster scope [root@k8s-node1 ~]# KUBECONFIG=/root/Amadeus.kubeconfig kubectl get deployments Error from server (Forbidden): deployments.apps is forbidden: User \u0026#34;Amadeus\u0026#34; cannot list resource \u0026#34;deployments\u0026#34; in API group \u0026#34;apps\u0026#34; in the namespace \u0026#34;default\u0026#34; ç»™è¯¥ç”¨æˆ·å¢åŠ æŸ¥çœ‹ã€åˆ›å»ºå’Œåˆ é™¤ deployment çš„æƒé™ï¼Œä½† pod çš„æƒé™ä¾æ—§åªæœ‰æŸ¥çœ‹\n[root@k8s-node1 ~]# vim demo-rbac.yml # åœ¨rbac.yamlä¸­å¢åŠ å¦‚ä¸‹è§„åˆ™ - apiGroups: [\u0026#34;apps\u0026#34;] resources: [\u0026#34;deployments\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;watch\u0026#34;, \u0026#34;list\u0026#34;, \u0026#34;create\u0026#34;, \u0026#34;delete\u0026#34;] [root@k8s-node1 ~]# kubectl apply -f demo-rbac.yml role.rbac.authorization.k8s.io/pod-reader configured rolebinding.rbac.authorization.k8s.io/read-pods unchanged # æ“ä½œ deployment [root@k8s-node1 ~]# KUBECONFIG=/root/Amadeus.kubeconfig kubectl create deployment my-dep --image=nginx:1.22.1 --replicas=3 deployment.apps/my-dep created [root@k8s-node1 ~]# KUBECONFIG=/root/Amadeus.kubeconfig kubectl get pods -l app=my-dep NAME READY STATUS RESTARTS AGE my-dep-bc4cb798-4kbkq 1/1 Running 0 15s my-dep-bc4cb798-jdzq7 1/1 Running 0 15s my-dep-bc4cb798-lhm8p 1/1 Running 0 15s [root@k8s-node1 ~]# KUBECONFIG=/root/Amadeus.kubeconfig kubectl delete deployment my-dep deployment.apps \u0026#34;my-dep\u0026#34; deleted 3 ç½‘ç»œç­–ç•¥ (Network Policy) å®˜æ–¹æ–‡æ¡£\n3.1 åŸºç¡€æ¦‚å¿µ ç½‘ç»œç­–ç•¥ï¼ˆNetwork Policyï¼‰ï¼Œç”¨äºé™åˆ¶ Pod å‡ºå…¥æµé‡ï¼Œæä¾› Pod çº§åˆ«å’Œ Namespace çº§åˆ«ç½‘ç»œè®¿é—®æ§åˆ¶ã€‚\nä¸€äº›åº”ç”¨åœºæ™¯ï¼š\nåº”ç”¨ç¨‹åºé—´çš„è®¿é—®æ§åˆ¶ã€‚ä¾‹å¦‚å¾®æœåŠ¡ A å…è®¸è®¿é—®å¾®æœåŠ¡ Bï¼Œå¾®æœåŠ¡ C ä¸èƒ½è®¿é—®å¾®æœåŠ¡ A å¼€å‘ç¯å¢ƒå‘½åç©ºé—´ä¸èƒ½è®¿é—®æµ‹è¯•ç¯å¢ƒå‘½åç©ºé—´ Pod å½“ Pod æš´éœ²åˆ°å¤–éƒ¨æ—¶ï¼Œéœ€è¦åš Pod ç™½åå• å¤šç§Ÿæˆ·ç½‘ç»œç¯å¢ƒéš”ç¦» Pod ç½‘ç»œå…¥å£æ–¹å‘éš”ç¦»ï¼š\nåŸºäº Pod çº§ç½‘ç»œéš”ç¦»ï¼šåªå…è®¸ç‰¹å®šå¯¹è±¡è®¿é—® Podï¼ˆä½¿ç”¨æ ‡ç­¾å®šä¹‰ï¼‰ï¼Œå…è®¸ç™½åå•ä¸Šçš„ IP åœ°å€æˆ–è€… IP æ®µè®¿é—® Pod åŸºäº Namespace çº§ç½‘ç»œéš”ç¦»ï¼šå¤šä¸ªå‘½åç©ºé—´ï¼ŒA å’Œ B å‘½åç©ºé—´ Pod å®Œå…¨éš”ç¦»ã€‚ Pod ç½‘ç»œå‡ºå£æ–¹å‘éš”ç¦»ï¼š\næ‹’ç»æŸä¸ª Namespace ä¸Šæ‰€æœ‰ Pod è®¿é—®å¤–éƒ¨ åŸºäºç›®çš„ IP çš„ç½‘ç»œéš”ç¦»ï¼šåªå…è®¸ Pod è®¿é—®ç™½åå•ä¸Šçš„ IP åœ°å€æˆ–è€… IP æ®µ åŸºäºç›®æ ‡ç«¯å£çš„ç½‘ç»œéš”ç¦»ï¼šåªå…è®¸ Pod è®¿é—®ç™½åå•ä¸Šçš„ç«¯ 3.2 ç¤ºä¾‹ä¸€ åªå…è®¸ default å‘½åç©ºé—´ä¸­æºå¸¦ run=client1 æ ‡ç­¾çš„ Pod è®¿é—® default å‘½åç©ºé—´æºå¸¦ app=web æ ‡ç­¾çš„ Pod çš„ 80 ç«¯å£ï¼Œæ— æ³• ping é€š\n[root@k8s-node1 ~]# kubectl create deployment web --image=nginx:1.22.1 [root@k8s-node1 ~]# kubectl run client1 --image=busybox:1.28 -- sleep 36000 [root@k8s-node1 ~]# kubectl run client2 --image=busybox:1.28 -- sleep 36000 [root@k8s-node1 ~]# kubectl get pods --show-labels NAME READY STATUS RESTARTS AGE LABELS client1 1/1 Running 0 69s run=client1 client2 1/1 Running 0 62s run=client2 web-bc7cc9f65-5mg9d 1/1 Running 0 2m3s app=web,pod-template-hash=bc7cc9f65 networkpolicy.yaml ç¤ºä¾‹\napiVersion: networking.k8s.io/v1 kind: NetworkPolicy metadata: name: test-network-policy namespace: default spec: podSelector: matchLabels: app: web policyTypes: - Ingress ingress: - from: - namespaceSelector: matchLabels: project: default - podSelector: matchLabels: run: client1 ports: - protocol: TCP port: 80 æµ‹è¯•éªŒè¯\n[root@k8s-node1 ~]# kubectl apply -f networkpolicy.yaml [root@k8s-node1 ~]# kubectl get networkpolicy [root@k8s-node1 ~]# kubectl get pods web-bc7cc9f65-hdhr2 -o jsonpath=\u0026#39;{.metadata.annotations.cni\\.projectcalico\\.org\\/podIP}\u0026#39; 10.244.169.169/32 [root@k8s-node1 ~]# kubectl exec -it client1 -- telnet 10.244.169.169 80 Connected to 10.244.169.169 [root@k8s-node1 ~]# kubectl exec -it client2 -- telnet 10.244.169.169 80 # è¶…æ—¶æ— æ³•è”é€š [root@k8s-node1 ~]# kubectl delete -f networkpolicy.yaml 3.3 ç¤ºä¾‹äºŒ ns1 å‘½åç©ºé—´ä¸‹æ‰€æœ‰ pod å¯ä»¥äº’ç›¸è®¿é—®ï¼Œä¹Ÿå¯ä»¥è®¿é—®å…¶ä»–å‘½åç©ºé—´ Podï¼Œä½†å…¶ä»–å‘½åç©ºé—´ä¸èƒ½è®¿é—® ns1 å‘½åç©ºé—´ Podã€‚\n[root@k8s-node1 ~]# kubectl create ns ns1 [root@k8s-node1 ~]# kubectl run ns1-client1 --image=busybox -n ns1 -- sleep 36000 [root@k8s-node1 ~]# kubectl run ns1-client2 --image=busybox -n ns1 -- sleep 36000 [root@k8s-node1 ~]# kubectl get pods -n ns1 -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES ns1-client1 1/1 Running 0 78s 10.244.169.168 k8s-node2 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; ns1-client2 1/1 Running 0 70s 10.244.107.212 k8s-node3 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; [root@k8s-node1 ~]# kubectl get pods -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES client1 1/1 Running 0 51s 10.244.169.171 k8s-node2 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; client2 1/1 Running 0 26m 10.244.107.238 k8s-node3 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; networkpolicy.yaml\napiVersion: networking.k8s.io/v1 kind: NetworkPolicy metadata: name: deny-from-other-namespaces namespace: ns1 spec: podSelector: {} # ç½®ç©ºè¡¨ç¤ºé»˜è®¤æ‰€æœ‰Pod policyTypes: - Ingress ingress: - from: - podSelector: {} # ç½®ç©ºè¡¨ç¤ºæ‹’ç»æ‰€æœ‰ éªŒè¯\n[root@k8s-node1 ~]# kubectl apply -f networkpolicy.yaml [root@k8s-node1 ~]# kubectl get networkpolicy -n ns1 # ns1å‘½åç©ºé—´å†…podå¯ä»¥äº’é€š [root@k8s-node1 ~]# kubectl exec -it ns1-client1 -n ns1 -- ping 10.244.107.212 # ns1-client2 PING 10.244.107.212 (10.244.107.212): 56 data bytes 64 bytes from 10.244.107.212: seq=0 ttl=62 time=0.900 ms 64 bytes from 10.244.107.212: seq=1 ttl=62 time=0.651 ms # defaultå‘½åç©ºé—´çš„podæ— æ³•è®¿é—®ns1å‘½åç©ºé—´çš„pod [root@k8s-node1 ~]# kubectl exec -it client1 -- ping 10.244.107.212 # ns1-client2 # ns1å‘½åç©ºé—´çš„podå¯ä»¥æ­£å¸¸è®¿é—®defaultå‘½åç©ºé—´çš„pod [root@k8s-node1 ~]# kubectl exec -it ns1-client1 -n ns1 -- ping 10.244.169.171 # client1 PING 10.244.169.171 (10.244.169.171): 56 data bytes 64 bytes from 10.244.169.171: seq=0 ttl=63 time=0.119 ms 64 bytes from 10.244.169.171: seq=1 ttl=63 time=0.067 ms [root@k8s-node1 ~]# kubectl delete -f networkpolicy.yaml ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-rbac-networkpolicy/","summary":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0 1 kubernetes å®‰å…¨æ¡†æ¶ å®¢æˆ·ç«¯è¦æƒ³è®¿é—® K8s é›†ç¾¤ API Serverï¼Œä¸€èˆ¬éœ€è¦ CA è¯ä¹¦ã€Token æˆ–è€…ç”¨æˆ·å + å¯†ç  å¦‚æœ Pod è®¿é—®ï¼Œéœ€è¦ ServiceAccount K8S å®‰å…¨æ§åˆ¶æ¡†æ¶ä¸»è¦ç”±ä¸‹é¢ 3 ä¸ªé˜¶æ®µè¿›è¡Œæ§åˆ¶ï¼Œæ¯ä¸€ä¸ªé˜¶æ®µéƒ½æ”¯æŒæ’ä»¶æ–¹å¼ï¼Œé€šè¿‡","title":"kubernetes | RBAC é‰´æƒå’Œ NetworkPolicy"},{"content":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0\n1 service 1.1 åŸºæœ¬æ¦‚å¿µ service å­˜åœ¨çš„æ„ä¹‰\næœåŠ¡å‘ç°ï¼šé˜²æ­¢ Pod å¤±è” è´Ÿè½½å‡è¡¡ï¼šå®šä¹‰ä¸€ç»„ Pod çš„è®¿é—®ç­–ç•¥ service é€šè¿‡ label-selector å…³è” pod\nservice çš„ä¸‰ç§ç±»å‹\nClusterIPï¼šé›†ç¾¤å†…éƒ¨ä½¿ç”¨\né»˜è®¤ï¼Œåˆ†é…ä¸€ä¸ªç¨³å®šçš„ IP åœ°å€ï¼Œå³ VIPï¼Œåªèƒ½åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®ï¼ˆåŒ Namespace å†…çš„ Podï¼‰ NodePortï¼šå¯¹å¤–æš´éœ²åº”ç”¨\nåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šå¯ç”¨ä¸€ä¸ªç«¯å£ (30000-32767) æ¥æš´éœ²æœåŠ¡ï¼Œå¯ä»¥åœ¨é›†ç¾¤å¤–éƒ¨è®¿é—®ã€‚ä¹Ÿä¼šåˆ†é…ä¸€ä¸ªç¨³å®šå†…éƒ¨é›†ç¾¤ IP åœ°å€ã€‚ LoadBalancerï¼šå¯¹å¤–æš´éœ²åº”ç”¨ï¼Œé€‚ç”¨å…¬æœ‰äº‘\nä¸ NodePort ç±»ä¼¼ï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šå¯ç”¨ä¸€ä¸ªç«¯å£æ¥æš´éœ²æœåŠ¡ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒKubernetes ä¼šè¯·æ±‚åº•å±‚äº‘å¹³å°ä¸Šçš„è´Ÿè½½å‡è¡¡å™¨ï¼Œå°†æ¯ä¸ª Nodeï¼ˆ[NodeIP]:[NodePort]ï¼‰ä½œä¸ºåç«¯æ·»åŠ è¿›å»ã€‚\nç¤ºä¾‹\napiVersion: v1 kind: Service metadata: name: nginx labels: app: nginx spec: selector: app: nginx type: NodePort ports: - protocol: TCP port: 80 # serviceç«¯å£ï¼Œå†…éƒ¨è®¿é—®ç«¯å£ targetPort: 80 # åç«¯ä¸šåŠ¡é•œåƒå®é™…æš´éœ²çš„ç«¯å£ nodePort: 30002 # å†…éƒ¨è®¿é—®ç«¯å£æ˜ å°„åˆ°èŠ‚ç‚¹ç«¯å£ --- apiVersion: apps/v1 kind: Deployment metadata: name: nginx labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.22.1 ports: - containerPort: 80 1.2 ä»£ç†æ¨¡å¼ Iptablesï¼š\nçµæ´»ï¼ŒåŠŸèƒ½å¼ºå¤§ è§„åˆ™éå†åŒ¹é…å’Œæ›´æ–°ï¼Œå‘ˆçº¿æ€§æ—¶å»¶ IPVSï¼š\nå·¥ä½œåœ¨å†…æ ¸æ€ï¼Œæœ‰æ›´å¥½çš„æ€§èƒ½ è°ƒåº¦ç®—æ³•ä¸°å¯Œï¼šrrï¼Œwrrï¼Œlcï¼Œwlcï¼Œip hashâ€¦ 1.2.1 iptables æ¨¡å¼ ä½¿ç”¨ iptables æ¨¡å¼æ—¶ï¼Œæ ¹æ® iptables çš„ --mode random --probability æ¥åŒ¹é…æ¯ä¸€æ¡è¯·æ±‚ï¼Œæ¯ä¸ª pod æ”¶åˆ°çš„æµé‡è¶‹è¿‘äºå¹³è¡¡ï¼Œä¸æ˜¯å®Œå…¨çš„è½®è¯¢\nè¿™ç§æ¨¡å¼ï¼Œkube-proxy ä¼šç›‘å¬ Kubernetes å¯¹ Service å¯¹è±¡å’Œ Endpoints å¯¹è±¡çš„æ·»åŠ å’Œç§»é™¤ã€‚å¯¹æ¯ä¸ª Serviceï¼Œå®ƒä¼šå®‰è£… iptables è§„åˆ™ï¼Œä»è€Œæ•è·åˆ°è¾¾è¯¥ Service çš„ clusterIP å’Œç«¯å£çš„è¯·æ±‚ï¼Œè¿›è€Œå°†è¯·æ±‚é‡å®šå‘åˆ° Service ä»»æ„ä¸€ç»„ backend pod ä¸­ã€‚å¯¹äºæ¯ä¸ª Endpoints å¯¹è±¡ï¼Œå®ƒä¹Ÿä¼šå®‰è£… iptables è§„åˆ™ï¼Œè¿™ä¸ªè§„åˆ™ä¼šé€‰æ‹©ä¸€ä¸ª backend pod ç»„åˆã€‚\nk8s é»˜è®¤é‡‡ç”¨çš„ä»£ç†æ¨¡å¼æ˜¯ iptablesï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹ kube-proxy ç»„ä»¶çš„æ—¥å¿—å¯å¾—\n[root@k8s-node1 ~]# kubectl logs kube-proxy-8mf2l -n kube-system | grep Using I0412 02:02:29.634610 1 server_others.go:212] Using iptables Proxier. åˆ›å»ºä¸€ä¸ªä¸Šè¿°ç¤ºä¾‹ä¸­çš„ yaml ï¼ŒæŸ¥çœ‹ iptables è§„åˆ™\n[root@k8s-node1 ~]# kubectl get svc nginx NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE nginx NodePort 10.105.220.154 \u0026lt;none\u0026gt; 80:30002/TCP 4m40s # SVCå½“å‰å…±å…³è”ä¸‰ä¸ªPOD [root@k8s-node1 ~]# kubectl get pod -o wide -l app=nginx NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES nginx-55f4d8c85-l29wx 1/1 Running 0 4m57s 10.244.169.133 k8s-node2 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; nginx-55f4d8c85-lf5dj 1/1 Running 0 4m57s 10.244.107.205 k8s-node3 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; nginx-55f4d8c85-q4gsx 1/1 Running 0 4m57s 10.244.107.203 k8s-node3 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; [root@k8s-node1 ~]# iptables-save |grep -i nodeport |grep 30002 # NODEPORTS æ ¹æ®ç«¯å£å°†æµé‡è½¬å‘åˆ° SVC é“¾ -A KUBE-NODEPORTS -p tcp -m comment --comment \u0026#34;default/nginx\u0026#34; -m tcp --dport 30002 -j KUBE-SVC-2CMXP7HKUVJN7L6M [root@k8s-node1 ~]# iptables-save |grep KUBE-SVC-2CMXP7HKUVJN7L6M # ClusterIP ç›¸å…³ -A KUBE-SERVICES -d 10.109.98.33/32 -p tcp -m comment --comment \u0026#34;default/nginx cluster IP\u0026#34; -m tcp --dport 80 -j KUBE-SVC-2CMXP7HKUVJN7L6M # è½¬å‘åˆ°å…·ä½“ POD é“¾ï¼Œæ¯æ¡ POD é“¾éƒ½æœ‰ä¸€æ ·çš„æ¦‚ç‡è·å–åˆ°æµé‡ -A KUBE-SVC-2CMXP7HKUVJN7L6M -m comment --comment \u0026#34;default/nginx\u0026#34; -m statistic --mode random --probability 0.33333333349 -j KUBE-SEP-ONLOYCYPTBL5FQH5 -A KUBE-SVC-2CMXP7HKUVJN7L6M -m comment --comment \u0026#34;default/nginx\u0026#34; -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-JABTJNSPARJARZOW -A KUBE-SVC-2CMXP7HKUVJN7L6M -m comment --comment \u0026#34;default/nginx\u0026#34; -j KUBE-SEP-TZBGLRHUI2CFM5CU # PODé“¾ä¸­å®šä¹‰äº†è½¬å‘åˆ°å…·ä½“çš„PODåœ°å€ï¼Œ [root@k8s-node1 ~]# iptables-save |grep KUBE-SEP-ONLOYCYPTBL5FQH5 -A KUBE-SEP-ONLOYCYPTBL5FQH5 -s 10.244.107.252/32 -m comment --comment \u0026#34;default/nginx\u0026#34; -j KUBE-MARK-MASQ -A KUBE-SEP-ONLOYCYPTBL5FQH5 -p tcp -m comment --comment \u0026#34;default/nginx\u0026#34; -m tcp -j DNAT --to-destination 10.244.107.252:80 [root@k8s-node1 ~]# iptables-save |grep KUBE-SEP-JABTJNSPARJARZOW -A KUBE-SEP-JABTJNSPARJARZOW -s 10.244.169.135/32 -m comment --comment \u0026#34;default/nginx\u0026#34; -j KUBE-MARK-MASQ -A KUBE-SEP-JABTJNSPARJARZOW -p tcp -m comment --comment \u0026#34;default/nginx\u0026#34; -m tcp -j DNAT --to-destination 10.244.169.135:80 [root@k8s-node1 ~]# iptables-save |grep KUBE-SEP-TZBGLRHUI2CFM5CU -A KUBE-SEP-TZBGLRHUI2CFM5CU -s 10.244.169.136/32 -m comment --comment \u0026#34;default/nginx\u0026#34; -j KUBE-MARK-MASQ -A KUBE-SEP-TZBGLRHUI2CFM5CU -p tcp -m comment --comment \u0026#34;default/nginx\u0026#34; -m tcp -j DNAT --to-destination 10.244.169.136:80 1.2.2 ipvs æ¨¡å¼ ipvsadm å®‰è£…é…ç½® (æ‰€æœ‰èŠ‚ç‚¹éƒ½è¦é…ç½®)\n[root@k8s-node1 ~]# yum install ipvsadm [root@k8s-node1 ~]# cat \u0026gt; /etc/sysconfig/modules/ipvs.modules \u0026lt;\u0026lt; EOF #!/bin/bash modprobe -- ip_vs modprobe -- ip_vs_rr modprobe -- ip_vs_wrr modprobe -- ip_vs_sh modprobe -- nf_conntrack_ipv4 EOF [root@k8s-node1 ~]# chmod 755 /etc/sysconfig/modules/ipvs.modules [root@k8s-node1 ~]# source /etc/sysconfig/modules/ipvs.modules ä¿®æ”¹ service ä½¿ç”¨çš„ä»£ç†æ¨¡å¼ä¸º ipvs\n[root@k8s-node1 ~]# kubectl edit configmap kube-proxy -n kube-system mode: \u0026#34;ipvs\u0026#34; ipvs: scheduler: \u0026#34;rr\u0026#34; #rr, wrr, lc, wlc, ip hashç­‰ # åˆ é™¤æ‰€æœ‰ kube-proxyï¼Œk8s ä¼šé‡æ–°åˆ›å»º [root@k8s-node1 ~]# kubectl delete pod -n kube-system -l k8s-app=kube-proxy [root@k8s-node1 ~]# kubectl logs kube-proxy-8z86w -n kube-system | grep Using I0412 08:30:21.169231 1 server_others.go:274] Using ipvs Proxier. æŸ¥çœ‹ ipvs è§„åˆ™\n[root@k8s-node1 ~]# ipvsadm -L -n IP Virtual Server version 1.2.1 (size=4096) Prot LocalAddress:Port Scheduler Flags -\u0026gt; RemoteAddress:Port Forward Weight ActiveConn InActConn TCP 172.17.0.1:30002 rr -\u0026gt; 10.244.107.252:80 Masq 1 0 0 -\u0026gt; 10.244.169.135:80 Masq 1 0 0 -\u0026gt; 10.244.169.136:80 Masq 1 0 0 TCP 1.1.1.1:30002 rr -\u0026gt; 10.244.107.252:80 Masq 1 0 0 -\u0026gt; 10.244.169.135:80 Masq 1 0 0 -\u0026gt; 10.244.169.136:80 Masq 1 0 0 TCP 10.244.36.64:30002 rr -\u0026gt; 10.244.107.252:80 Masq 1 0 0 -\u0026gt; 10.244.169.135:80 Masq 1 0 0 -\u0026gt; 10.244.169.136:80 Masq 1 0 0 TCP 10.109.98.33:80 rr -\u0026gt; 10.244.107.252:80 Masq 1 0 0 -\u0026gt; 10.244.169.135:80 Masq 1 0 0 -\u0026gt; 10.244.169.136:80 Masq 1 0 0 2 Headless Service Headless Service ç›¸æ¯”æ™®é€š Service åªæ˜¯å°† spec.clusterIP å®šä¹‰ä¸º None\nHeadless Service å‡ å¤§ç‰¹ç‚¹ï¼š\nä¸åˆ†é… clusterIP\næ²¡æœ‰è´Ÿè½½å‡è¡¡çš„åŠŸèƒ½ (kube-proxy ä¸ä¼šå®‰è£… iptables è§„åˆ™)\nå¯ä»¥é€šè¿‡è§£æ service çš„ DNSï¼Œè¿”å›æ‰€æœ‰ Pod çš„ IP å’Œ DNS (statefulSet éƒ¨ç½²çš„ Pod æ‰æœ‰ DNS)\n[root@k8s-node1 ~]# kubectl run -it --rm --restart=Never --image busybox:1.28 dns-test -- nslookup statefulset-nginx.default.svc.cluster.local Server: 10.96.0.10 Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local Name: statefulset-nginx.default.svc.cluster.local Address 1: 10.244.107.200 statefulset-nginx-1.statefulset-nginx.default.svc.cluster.local Address 2: 10.244.169.188 statefulset-nginx-0.statefulset-nginx.default.svc.cluster.local pod \u0026#34;dns-test\u0026#34; deleted Headless Services åº”ç”¨åœºæ™¯\nè‡ªä¸»é€‰æ‹©æƒï¼Œclient å¯ä»¥é€šè¿‡æŸ¥è¯¢ DNS æ¥è·å– Real Server çš„ä¿¡æ¯ï¼Œè‡ªå·±æ¥å†³å®šä½¿ç”¨å“ªä¸ª Real Server Headless Service çš„å¯¹åº”çš„æ¯ä¸€ä¸ª Endpointsï¼Œå³æ¯ä¸€ä¸ª Podï¼Œéƒ½ä¼šæœ‰å¯¹åº”çš„ DNSåŸŸåï¼Œè¿™æ · Pod ä¹‹é—´å°±å¯ä»¥äº’ç›¸è®¿é—® DNS è§£æåç§°ï¼š\npodï¼š\u0026lt;pod-name\u0026gt;.\u0026lt;service-name\u0026gt;.\u0026lt;namespace\u0026gt;.svc.cluster.local service: \u0026lt;service-name\u0026gt;.\u0026lt;namespace\u0026gt;.svc.cluster.local 3 Ingress 3.1 åŸºæœ¬æ¦‚å¿µ NodePort çš„ä¸è¶³\nä¸€ä¸ªç«¯å£åªèƒ½ä¸€ä¸ªæœåŠ¡ä½¿ç”¨ï¼Œç«¯å£éœ€æå‰è§„åˆ’ åªæ”¯æŒ 4 å±‚è´Ÿè½½å‡è¡¡ Ingress æ˜¯ä»€ä¹ˆï¼Ÿ\nIngress å…¬å¼€äº†ä»é›†ç¾¤å¤–éƒ¨åˆ°é›†ç¾¤å†…æœåŠ¡çš„ HTTP å’Œ HTTPS è·¯ç”±ã€‚æµé‡è·¯ç”±ç”± Ingress èµ„æºä¸Šå®šä¹‰çš„è§„åˆ™æ§åˆ¶ã€‚\nä¸‹é¢æ˜¯ä¸€ä¸ªå°†æ‰€æœ‰æµé‡éƒ½å‘é€åˆ°åŒä¸€ Service çš„ç®€å• Ingress ç¤ºä¾‹ï¼š\nIngress Controller\nIngress ç®¡ç†çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œä¸ºé›†ç¾¤æä¾›å…¨å±€çš„è´Ÿè½½å‡è¡¡èƒ½åŠ›ã€‚\nIngress Contronler æ€ä¹ˆå·¥ä½œçš„ï¼Ÿ\nIngress Contronler é€šè¿‡ä¸ Kubernetes API äº¤äº’ï¼ŒåŠ¨æ€çš„å»æ„ŸçŸ¥é›†ç¾¤ä¸­ Ingress è§„åˆ™å˜åŒ–ï¼Œç„¶åè¯»å–å®ƒï¼ŒæŒ‰ç…§è‡ªå®šä¹‰çš„è§„åˆ™ï¼Œè§„åˆ™å°±æ˜¯å†™æ˜äº†å“ªä¸ªåŸŸåå¯¹åº”å“ªä¸ª serviceï¼Œç”Ÿæˆä¸€æ®µ Nginx é…ç½®ï¼Œåº”ç”¨åˆ°ç®¡ç†çš„ Nginx æœåŠ¡ï¼Œç„¶åçƒ­åŠ è½½ç”Ÿæ•ˆã€‚\nä»¥æ­¤æ¥è¾¾åˆ° Nginx è´Ÿè½½å‡è¡¡å™¨é…ç½®åŠåŠ¨æ€æ›´æ–°çš„é—®é¢˜\nä½¿ç”¨æµç¨‹ï¼š\néƒ¨ç½² Ingress Controller åˆ›å»º Ingress è§„åˆ™ Ingress Contorller ä¸»æµæ§åˆ¶å™¨ï¼š\ningress-nginx-controller: nginx å®˜æ–¹ç»´æŠ¤çš„æ§åˆ¶å™¨ Traefikï¼š HTTP åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡å·¥å…· Istioï¼šæœåŠ¡æ²»ç†ï¼Œæ§åˆ¶å…¥å£æµé‡ è¿™é‡Œä½¿ç”¨ Nginx å®˜æ–¹ç»´æŠ¤çš„ï¼Œé¡¹ç›®åœ°å€\n3.2 å®‰è£…éƒ¨ç½² ä¸‹è½½ yaml æ–‡ä»¶\nwget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.3.0/deploy/static/provider/baremetal/1.22/deploy.yaml --no-check-certificate ä¿®æ”¹\n# ä¿®æ”¹kind, å°†åŸå…ˆçš„Deploymentä¿®æ”¹ä¸ºDaemontSetï¼Œå®ç°æ‰€æœ‰ç‰©ç†èŠ‚ç‚¹è®¿é—® kind: DaemonSet spec: template: spec: # æ–°å¢ hostNetwork, å°†ingress-nginx-controllerçš„ç«¯å£ç›´æ¥æš´éœ²åœ¨å®¿ä¸»æœºä¸Š hostNetwork: true containers: # ä¿®æ”¹ image ä¸ºå›½å†…åœ°å€ image: registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v1.3.0 # æ–°å¢æ±¡ç‚¹å®¹å¿ï¼Œå…è®¸åœ¨ master èŠ‚ç‚¹åˆ›å»ºpod tolerations: - key: \u0026#34;node-role.kubernetes.io/master\u0026#34; operator: \u0026#34;Exists\u0026#34; effect: \u0026#34;NoSchedule\u0026#34; --- kind: Job spec: template: spec: containers: # ä¿®æ”¹ image ä¸ºå›½å†…åœ°å€ image: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-webhook-certgen:v1.1.1 --- kind: Job spec: template: spec: containers: # ä¿®æ”¹ image ä¸ºå›½å†…åœ°å€ image: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-webhook-certgen:v1.1.1 éƒ¨ç½²\n[root@k8s-node1 ~]# kubectl apply -f deploy.yaml [root@k8s-node1 opt]# kubectl get pods -n ingress-nginx -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES ingress-nginx-admission-create--1-zfwrz 0/1 Completed 0 12m 10.244.169.135 k8s-node2 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; ingress-nginx-admission-patch--1-8rhjr 0/1 Completed 0 12m 10.244.169.134 k8s-node2 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; ingress-nginx-controller-bb2kd 1/1 Running 0 12m 1.1.1.3 k8s-node3 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; ingress-nginx-controller-bp588 1/1 Running 0 12m 1.1.1.2 k8s-node2 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; ingress-nginx-controller-z2782 1/1 Running 0 12m 1.1.1.1 k8s-node1 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; # å¦‚æœå‡ºç°å†…éƒ¨è®¿é—®æŠ¥é”™ï¼šfailed calling webhook \u0026#34;validate.nginx.ingress.kubernetes.io\u0026#34; [root@k8s-node1 ~]# kubectl get ValidatingWebhookConfiguration [root@k8s-node1 ~]# kubectl delete -A ValidatingWebhookConfiguration ingress-nginx-admission 3.3 æµ‹è¯• æµ‹è¯• url è·³è½¬ï¼Œåˆ›å»ºä¸‰å¥— nginx åº”ç”¨ : test | foo | bar\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»£ç†è·¯å¾„å‡å¦‚æ˜¯ /foo çš„è¯ï¼Œåç«¯çœŸå®è·¯å¾„ä¹Ÿæ˜¯ /foo\ntest åº”ç”¨ç¤ºä¾‹ï¼Œfoo å’Œ bar çš„è‡ªè¡Œä¿®æ”¹\napiVersion: apps/v1 kind: Deployment metadata: name: test labels: app: test spec: replicas: 3 selector: matchLabels: app: test template: metadata: labels: app: test spec: terminationGracePeriodSeconds: 5 containers: - name: test image: nginx:1.22.1 imagePullPolicy: IfNotPresent ports: - containerPort: 80 volumeMounts: - name: www mountPath: /usr/share/nginx/html/ volumes: - name: www persistentVolumeClaim: claimName: pvc-test --- apiVersion: v1 kind: PersistentVolumeClaim metadata: name: pvc-test spec: storageClassName: \u0026#34;nfs\u0026#34; accessModes: - ReadWriteOnce resources: requests: storage: 2Gi --- apiVersion: v1 kind: Service metadata: name: test labels: app: test spec: selector: app: test ports: - protocol: TCP port: 80 targetPort: 80 åˆ›å»º ingress\napiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: demo-nginx annotations: kubernetes.io/ingress.class: nginx spec: rules: - host: test.com http: paths: - path: / pathType: Prefix backend: service: name: test port: number: 80 - path: /foo pathType: Prefix backend: service: name: foo port: number: 80 - path: /bar pathType: Prefix backend: service: name: bar port: number: 80 æŸ¥çœ‹åˆ›å»ºçš„ ingress\n[root@k8s-node1 ~]# kubectl describe ingress demo-nginx Name: demo-nginx Namespace: default Address: 1.1.1.1,1.1.1.2,1.1.1.3 Default backend: default-http-backend:80 (\u0026lt;error: endpoints \u0026#34;default-http-backend\u0026#34; not found\u0026gt;) Rules: Host Path Backends ---- ---- -------- test.com / test:80 (10.244.107.209:80,10.244.107.212:80,10.244.169.140:80) /foo foo:80 (10.244.107.210:80,10.244.169.138:80,10.244.169.144:80) /bar bar:80 (10.244.107.211:80,10.244.169.131:80,10.244.169.143:80) Annotations: kubernetes.io/ingress.class: nginx Events: \u0026lt;none\u0026gt; ä¿®æ”¹ index.html\n[root@k8s-node1 ~]# echo \u0026#34;test\u0026#34; \u0026gt; /nfs/default-pvc-test-pvc-93a7df14-90f2-4466-8655-6ef42549b760/index.html [root@k8s-node1 ~]# mkdir /nfs/default-pvc-foo-pvc-75e73500-1a70-4305-8253-d1e7d8c88b49/foo [root@k8s-node1 ~]# echo \u0026#34;foo\u0026#34; \u0026gt; /nfs/default-pvc-foo-pvc-75e73500-1a70-4305-8253-d1e7d8c88b49/foo/index.html [root@k8s-node1 ~]# mkdir /nfs/default-pvc-bar-pvc-73d12b15-7c53-46ee-a1b6-d0cb2c25e7e6/bar/ [root@k8s-node1 ~]# echo \u0026#34;bar\u0026#34; \u0026gt; /nfs/default-pvc-bar-pvc-73d12b15-7c53-46ee-a1b6-d0cb2c25e7e6/bar/index.html è®¿é—®æµ‹è¯•\n[root@k8s-node1 ~]# curl http://1.1.1.1/ -H \u0026#34;Host: test.com\u0026#34; test [root@k8s-node1 ~]# curl http://1.1.1.2/foo/ -H \u0026#34;Host: test.com\u0026#34; foo [root@k8s-node1 ~]# curl http://1.1.1.3/bar/ -H \u0026#34;Host: test.com\u0026#34; bar ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-service-ingress/","summary":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0 1 service 1.1 åŸºæœ¬æ¦‚å¿µ service å­˜åœ¨çš„æ„ä¹‰ æœåŠ¡å‘ç°ï¼šé˜²æ­¢ Pod å¤±è” è´Ÿè½½å‡è¡¡ï¼šå®šä¹‰ä¸€ç»„ Pod çš„è®¿é—®ç­–ç•¥ service é€šè¿‡ label-selector å…³è” pod service çš„ä¸‰ç§ç±»å‹ ClusterIPï¼šé›†ç¾¤å†…éƒ¨ä½¿ç”¨ é»˜è®¤ï¼Œåˆ†é…ä¸€ä¸ªç¨³å®šçš„ IP åœ°å€ï¼Œå³ VIPï¼Œåªèƒ½åœ¨é›†","title":"kubernetes | service \u0026 ingress"},{"content":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0\nä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å·\nå¯åŠ¨æ—¶éœ€è¦çš„åˆå§‹æ•°æ®ï¼Œå½•å…¥é…ç½®æ–‡ä»¶ å¯åŠ¨è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸´æ—¶æ•°æ®ï¼Œè¯¥ä¸´æ—¶æ•°æ®éœ€è¦å¤šä¸ªå®¹å™¨é—´å…±äº« å¯åŠ¨è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æŒä¹…åŒ–æ•°æ®ï¼Œä¾‹å¦‚ mysql çš„ data æ•°æ®å·æ¦‚è¿°\nkubernetes ä¸­çš„ volume æä¾›äº†åœ¨å®¹å™¨ä¸­æŒ‚è½½å¤–éƒ¨å­˜å‚¨çš„èƒ½åŠ› Pod éœ€è¦è®¾ç½®å·æ¥æºï¼ˆspec.volumeï¼‰å’ŒæŒ‚è½½ç‚¹ï¼ˆspec.containers.volumeMountsï¼‰ä¸¤ä¸ªä¿¡æ¯åæ‰å¯ä»¥ä½¿ç”¨ç›¸åº”çš„ Volume å¸¸ç”¨çš„æ•°æ®å·ï¼š\næœ¬åœ°ï¼ˆhostPathï¼ŒemptyDirï¼‰ ç½‘ç»œï¼ˆNFSï¼ŒCephï¼ŒGlusterFSï¼‰ å…¬æœ‰äº‘ï¼ˆAWS EBSï¼‰ K8S èµ„æºï¼ˆconfigmapï¼Œsecretï¼‰ 1 emptyDirï¼ˆä¸´æ—¶å­˜å‚¨å·ï¼‰ emptyDir å·ï¼šæ˜¯ä¸€ä¸ªä¸´æ—¶å­˜å‚¨å·ï¼Œä¸ Pod ç”Ÿå‘½å‘¨æœŸç»‘å®šä¸€èµ·ï¼Œå¦‚æœ Pod åˆ é™¤äº†å·ä¹Ÿä¼šè¢«åˆ é™¤ã€‚\nåº”ç”¨åœºæ™¯ï¼šPod ä¸­å®¹å™¨ä¹‹é—´æ•°æ®å…±äº«\nemptyDir çš„å®é™…å­˜å‚¨è·¯å¾„åœ¨ pod æ‰€åœ¨èŠ‚ç‚¹çš„ /var/lib/kubelet/pods/\u0026lt;pod-id\u0026gt;/volumes/kubernetes.io~empty-dir ç›®å½•ä¸‹\næŸ¥çœ‹ pod çš„ uid\nkubectl get pod \u0026lt;pod-name\u0026gt; -o jsonpath=\u0026#39;{.metadata.uid}\u0026#39; ç¤ºä¾‹å¦‚ä¸‹\napiVersion: v1 kind: Pod metadata: name: demo-emptydir spec: terminationGracePeriodSeconds: 5 containers: - name: write image: busybox imagePullPolicy: IfNotPresent command: [\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;for i in $(seq 100); do echo $i \u0026gt;\u0026gt; /data/hello; sleep 1; done\u0026#34;] volumeMounts: - name: data mountPath: /data - name: read image: busybox imagePullPolicy: IfNotPresent command: [\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;tail -f /data/hello\u0026#34;] volumeMounts: - name: data mountPath: /data volumes: - name: data emptyDir: {} æŸ¥çœ‹æ—¥å¿—\n[root@k8s-node1 ~]# kubectl logs -f demo-emptydir -c read 1 2 3 ... 2 hostPathï¼ˆèŠ‚ç‚¹å­˜å‚¨å·ï¼‰ hostPath å·ï¼šæŒ‚è½½ Node æ–‡ä»¶ç³»ç»Ÿï¼ˆPod æ‰€åœ¨èŠ‚ç‚¹ï¼‰ä¸Šæ–‡ä»¶æˆ–è€…ç›®å½•åˆ° Pod ä¸­çš„å®¹å™¨ã€‚\nåº”ç”¨åœºæ™¯ï¼šPod ä¸­å®¹å™¨éœ€è¦è®¿é—®å®¿ä¸»æœºæ–‡ä»¶\nç¤ºä¾‹ yaml\napiVersion: v1 kind: Pod metadata: name: pod-hostpath spec: terminationGracePeriodSeconds: 5 containers: - name: busybox image: busybox imagePullPolicy: IfNotPresent command: [\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;sleep 36000\u0026#34;] volumeMounts: - name: data mountPath: /data volumes: - name: data hostPath: path: /tmp type: Directory 3 NFSï¼ˆç½‘ç»œå­˜å‚¨å·ï¼‰ NFS å·æä¾›å¯¹ NFS æŒ‚è½½æ”¯æŒï¼Œå¯ä»¥è‡ªåŠ¨å°† NFS å…±äº«è·¯å¾„æŒ‚è½½åˆ° Pod ä¸­\né…ç½® nfs æœåŠ¡ç«¯ï¼Œ\nyum install nfs-utils # nfs-utilsåŒ…æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€å®‰è£… mkdir -p /nfs echo \u0026#34;/nfs 1.1.1.0/24(rw,async,no_root_squash)\u0026#34; \u0026gt;\u0026gt; /etc/exports # æ ¼å¼ï¼šNFSå…±äº«çš„ç›®å½• å®¢æˆ·ç«¯åœ°å€1(å‚æ•°1,å‚æ•°2,...) å®¢æˆ·ç«¯åœ°å€2(å‚æ•°1,å‚æ•°2,...)) systemctl enable --now nfs systemctl enable --now rpcbind å¸¸ç”¨é€‰é¡¹ï¼š roï¼šå®¢æˆ·ç«¯æŒ‚è½½åï¼Œå…¶æƒé™ä¸ºåªè¯»ï¼Œé»˜è®¤é€‰é¡¹ï¼› rw: è¯»å†™æƒé™ï¼› syncï¼šåŒæ—¶å°†æ•°æ®å†™å…¥åˆ°å†…å­˜ä¸ç¡¬ç›˜ä¸­ï¼› asyncï¼šå¼‚æ­¥ï¼Œä¼˜å…ˆå°†æ•°æ®ä¿å­˜åˆ°å†…å­˜ï¼Œç„¶åå†å†™å…¥ç¡¬ç›˜ï¼› Secureï¼šè¦æ±‚è¯·æ±‚æºçš„ç«¯å£å°äº 1024 ç”¨æˆ·æ˜ å°„ï¼š root_squash: å½“ NFS å®¢æˆ·ç«¯ä½¿ç”¨ root ç”¨æˆ·è®¿é—®æ—¶ï¼Œæ˜ å°„åˆ° NFS æœåŠ¡å™¨çš„åŒ¿åç”¨æˆ·ï¼› no_root_squash: å½“ NFS å®¢æˆ·ç«¯ä½¿ç”¨ root ç”¨æˆ·è®¿é—®æ—¶ï¼Œæ˜ å°„åˆ° NFS æœåŠ¡å™¨çš„ root ç”¨æˆ·ï¼› all_squash: å…¨éƒ¨ç”¨æˆ·éƒ½æ˜ å°„ä¸ºæœåŠ¡å™¨ç«¯çš„åŒ¿åç”¨æˆ·ï¼› anonuid=UIDï¼šå°†å®¢æˆ·ç«¯ç™»å½•ç”¨æˆ·æ˜ å°„ä¸ºæ­¤å¤„æŒ‡å®šçš„ç”¨æˆ· uidï¼› anongid=GIDï¼šå°†å®¢æˆ·ç«¯ç™»å½•ç”¨æˆ·æ˜ å°„ä¸ºæ­¤å¤„æŒ‡å®šçš„ç”¨æˆ· gid å®¢æˆ·ç«¯æµ‹è¯•\n[root@k8s-node2 ~]# mount -t nfs k8s-node1:/nfs /mnt/ [root@k8s-node2 ~]# df -hT | grep k8s-node1 k8s-node1:/nfs nfs4 44G 4.0G 41G 9% /mnt ç¤ºä¾‹ yaml\napiVersion: apps/v1 kind: Deployment metadata: name: demo-nfs labels: app: demo-nfs spec: replicas: 3 selector: matchLabels: app: demo-nfs template: metadata: labels: app: demo-nfs spec: terminationGracePeriodSeconds: 5 containers: - name: demo-nfs image: nginx:1.22.1 imagePullPolicy: IfNotPresent ports: - containerPort: 80 volumeMounts: - name: www mountPath: /usr/share/nginx/html/ volumes: - name: www nfs: server: k8s-node1 path: /nfs/ --- apiVersion: v1 kind: Service metadata: name: demo-nfs labels: app: demo-nfs spec: selector: app: demo-nfs ports: - protocol: TCP port: 80 targetPort: 80 nodePort: 30003 type: NodePort éªŒè¯\n[root@k8s-node1 ~]# kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE demo-nfs NodePort 10.97.209.119 \u0026lt;none\u0026gt; 80:30003/TCP 5m41s kubernetes ClusterIP 10.96.0.1 \u0026lt;none\u0026gt; 443/TCP 5d2h [root@k8s-node1 ~]# echo \u0026#34;hello, nfs\u0026#34; \u0026gt; /nfs/index.html [root@k8s-node1 ~]# curl 10.97.209.119 hello, nfs 4 pv å’Œ pvcï¼ˆæŒä¹…å­˜å‚¨å·ï¼‰ 4.1 åŸºç¡€æ¦‚å¿µ PersistentVolumeï¼ˆPVï¼‰ï¼šå­˜å‚¨èµ„æºåˆ›å»ºå’Œä½¿ç”¨æŠ½è±¡åŒ–ï¼Œä½¿å¾—å­˜å‚¨ä½œä¸ºé›†ç¾¤ä¸­çš„èµ„æºç®¡ç† PersistentVolumeClaimï¼ˆPVCï¼‰ï¼šè®©ç”¨æˆ·ä¸éœ€è¦å…³å¿ƒå…·ä½“çš„ Volume å®ç°ç»†èŠ‚ pvc å¦‚ä½•åŒ¹é…åˆ° pv\nå­˜å‚¨ç©ºé—´çš„è¯·æ±‚ åŒ¹é…æœ€æ¥è¿‘çš„ pvï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„ pvï¼Œåˆ™ pod å¤„äº pending çŠ¶æ€ è®¿é—®æ¨¡å¼çš„è®¾ç½® å­˜å‚¨ç©ºé—´å­—æ®µèƒ½å¦é™åˆ¶å®é™…å¯ç”¨å®¹é‡\nä¸èƒ½ï¼Œå­˜å‚¨ç©ºé—´å­—æ®µåªç”¨äºåŒ¹é…åˆ° pvï¼Œå…·ä½“å¯ç”¨å®¹é‡å–å†³äºç½‘ç»œå­˜å‚¨ 4.2 pv ç”Ÿå‘½å‘¨æœŸ AccessModesï¼ˆè®¿é—®æ¨¡å¼ï¼‰ï¼š\nAccessModes æ˜¯ç”¨æ¥å¯¹ PV è¿›è¡Œè®¿é—®æ¨¡å¼çš„è®¾ç½®ï¼Œç”¨äºæè¿°ç”¨æˆ·åº”ç”¨å¯¹å­˜å‚¨èµ„æºçš„è®¿é—®æƒé™ï¼Œè®¿é—®æƒé™åŒ…æ‹¬ä¸‹é¢å‡ ç§æ–¹å¼ï¼š\nReadWriteOnceï¼ˆRWOï¼‰ï¼šå¯è¢«ä¸€ä¸ª node è¯»å†™æŒ‚è½½ ReadOnlyManyï¼ˆROXï¼‰ï¼šå¯è¢«å¤šä¸ª node åªè¯»æŒ‚è½½ ReadWriteManyï¼ˆRWXï¼‰ï¼šå¯è¢«å¤šä¸ª node è¯»å†™æŒ‚è½½ RECLAIM POLICYï¼ˆå›æ”¶ç­–ç•¥ï¼‰ï¼š\nç›®å‰ PV æ”¯æŒçš„ç­–ç•¥æœ‰ä¸‰ç§ï¼š\nRetainï¼ˆä¿ç•™ï¼‰ï¼š ä¿ç•™æ•°æ®ï¼Œéœ€è¦ç®¡ç†å‘˜æ‰‹å·¥æ¸…ç†æ•°æ® Recycleï¼ˆå›æ”¶ï¼‰ï¼šæ¸…é™¤ PV ä¸­çš„æ•°æ®ï¼Œæ•ˆæœç›¸å½“äºæ‰§è¡Œ rm -rf /ifs/kuberneres/* Deleteï¼ˆåˆ é™¤ï¼‰ï¼šä¸ PV ç›¸è¿çš„åç«¯å­˜å‚¨åŒæ—¶åˆ é™¤ STATUSï¼ˆçŠ¶æ€ï¼‰ï¼š\nä¸€ä¸ª PV çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå¯èƒ½ä¼šå¤„äº 4 ä¸­ä¸åŒçš„é˜¶æ®µï¼š\nAvailableï¼ˆå¯ç”¨ï¼‰ï¼šè¡¨ç¤ºå¯ç”¨çŠ¶æ€ï¼Œè¿˜æœªè¢«ä»»ä½• PVC ç»‘å®š Boundï¼ˆå·²ç»‘å®šï¼‰ï¼šè¡¨ç¤º PV å·²ç»è¢« PVC ç»‘å®š Releasedï¼ˆå·²é‡Šæ”¾ï¼‰ï¼šPVC è¢«åˆ é™¤ï¼Œä½†æ˜¯èµ„æºè¿˜æœªè¢«é›†ç¾¤é‡æ–°å£°æ˜ Failedï¼ˆå¤±è´¥ï¼‰ï¼š è¡¨ç¤ºè¯¥ PV çš„è‡ªåŠ¨å›æ”¶å¤±è´¥ pv ç¤ºä¾‹\napiVersion: v1 kind: PersistentVolume metadata: name: demo-pv spec: capacity: storage: 5Gi accessModes: - ReadWriteMany nfs: server: k8s-node1 path: /nfs pvc ç¤ºä¾‹\napiVersion: v1 kind: PersistentVolumeClaim metadata: name: demo-pvc spec: accessModes: - ReadWriteMany resources: requests: storage: 5Gi deployment \u0026amp; service ç¤ºä¾‹\napiVersion: apps/v1 kind: Deployment metadata: name: demo-pvc labels: app: demo-pvc spec: replicas: 3 selector: matchLabels: app: demo-pvc template: metadata: labels: app: demo-pvc spec: terminationGracePeriodSeconds: 5 containers: - name: demo-pvc image: nginx:1.22.1 imagePullPolicy: IfNotPresent ports: - containerPort: 80 volumeMounts: - name: www-pvc mountPath: /usr/share/nginx/html/ volumes: - name: www-pvc persistentVolumeClaim: claimName: demo-pvc --- apiVersion: v1 kind: Service metadata: name: demo-pvc labels: app: demo-pvc spec: selector: app: demo-pvc ports: - protocol: TCP port: 80 targetPort: 80 éªŒè¯\n[root@k8s-node1 ~]# echo \u0026#34;pvc for NFS is successful\u0026#34; \u0026gt; /nfs/index.html [root@k8s-node1 ~]# kubectl get svc -l app=demo-pvc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE demo-pvc ClusterIP 10.97.28.93 \u0026lt;none\u0026gt; 80/TCP 102s [root@k8s-node1 ~]# curl 10.97.28.93 pvc for NFS is successful 4.3 pv åŠ¨æ€ä¾›ç»™ ä¹‹å‰çš„ PV ä½¿ç”¨æ–¹å¼ç§°ä¸ºé™æ€ä¾›ç»™ï¼Œéœ€è¦ K8s è¿ç»´å·¥ç¨‹å¸ˆæå‰åˆ›å»ºä¸€å † PVï¼Œä¾›å¼€å‘è€…ä½¿ç”¨\nå› æ­¤ï¼ŒK8s å¼€å§‹æ”¯æŒ PV åŠ¨æ€ä¾›ç»™ï¼Œä½¿ç”¨ StorageClass å¯¹è±¡å®ç°ã€‚\næŸ¥çœ‹ k8s åŸç”Ÿæ”¯æŒçš„å…±äº«å­˜å‚¨\nåŸºäº NFS å®ç°è‡ªåŠ¨åˆ›å»º pv æ’ä»¶\nè‡ªåŠ¨åˆ›å»ºçš„ pv æŒ‚è½½è·¯å¾„ä¸º \u0026lt;nfs-path\u0026gt;/\u0026lt;namespace\u0026gt;-\u0026lt;pvc-name\u0026gt;-\u0026lt;pv-name\u0026gt;\npvc-nameï¼šé»˜è®¤æƒ…å†µä¸‹ä¸º yaml ä¸­è‡ªå®šä¹‰çš„ pvc-nameï¼Œä½¿ç”¨ statefulset æ§åˆ¶å™¨æ—¶ pvc çš„åå­—ä¸º \u0026lt;volumeClaimTemplates-name\u0026gt;-\u0026lt;pod-name\u0026gt; pv-nameï¼špv çš„åå­—ä¸º pvc-\u0026lt;pvc-uid\u0026gt; k8s-1.20 ç‰ˆæœ¬åé»˜è®¤ç¦æ­¢ä½¿ç”¨ selfLinkï¼Œéœ€è¦æ‰“å¼€ä¸€ä¸‹\nä¿®æ”¹ k8s çš„ apiserver å‚æ•°ï¼Œæ”¹å®Œ apiserver ä¼šè‡ªåŠ¨é‡å¯\n[root@k8s-node1 ~]# vi /etc/kubernetes/manifests/kube-apiserver.yaml apiVersion: v1 Â·Â·Â· - --tls-private-key-file=/etc/kubernetes/pki/apiserver.key - --feature-gates=RemoveSelfLink=false # æ·»åŠ è¿™ä¸ªé…ç½® 4.3.1 éƒ¨ç½² NFS æ’ä»¶ æ­¤ç»„ä»¶æ˜¯å¯¹ nfs-client-provisioner çš„æ‰©å±•ï¼Œnfs-client-provisioner å·²ç»ä¸æä¾›æ›´æ–°ï¼Œä¸” nfs-client-provisioner çš„ Github ä»“åº“å·²ç»è¿ç§»åˆ° NFS-Subdir-External-Provisioner çš„ä»“åº“\nrbac\nåˆ›å»º nfs-rbac.yml\napiVersion: v1 kind: ServiceAccount metadata: name: nfs-client-provisioner namespace: kube-system --- kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1 metadata: name: nfs-client-provisioner-runner rules: - apiGroups: [\u0026#34;\u0026#34;] resources: [\u0026#34;persistentvolumes\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;, \u0026#34;create\u0026#34;, \u0026#34;delete\u0026#34;] - apiGroups: [\u0026#34;\u0026#34;] resources: [\u0026#34;persistentvolumeclaims\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;, \u0026#34;update\u0026#34;] - apiGroups: [\u0026#34;storage.k8s.io\u0026#34;] resources: [\u0026#34;storageclasses\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;] - apiGroups: [\u0026#34;\u0026#34;] resources: [\u0026#34;events\u0026#34;] verbs: [\u0026#34;create\u0026#34;, \u0026#34;update\u0026#34;, \u0026#34;patch\u0026#34;] --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: run-nfs-client-provisioner subjects: - kind: ServiceAccount name: nfs-client-provisioner namespace: kube-system roleRef: kind: ClusterRole name: nfs-client-provisioner-runner apiGroup: rbac.authorization.k8s.io --- kind: Role apiVersion: rbac.authorization.k8s.io/v1 metadata: name: leader-locking-nfs-client-provisioner namespace: kube-system rules: - apiGroups: [\u0026#34;\u0026#34;] resources: [\u0026#34;endpoints\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;, \u0026#34;create\u0026#34;, \u0026#34;update\u0026#34;, \u0026#34;patch\u0026#34;] --- kind: RoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: leader-locking-nfs-client-provisioner namespace: kube-system subjects: - kind: ServiceAccount name: nfs-client-provisioner namespace: kube-system roleRef: kind: Role name: leader-locking-nfs-client-provisioner apiGroup: rbac.authorization.k8s.io nfs-subdir-external-provisioner\nåˆ›å»º nfs-provisioner-deploy.yml\napiVersion: apps/v1 kind: Deployment metadata: name: nfs-client-provisioner namespace: kube-system labels: app: nfs-client-provisioner spec: replicas: 1 strategy: type: Recreate # è®¾ç½®å‡çº§ç­–ç•¥ä¸ºåˆ é™¤å†åˆ›å»º(é»˜è®¤ä¸ºæ»šåŠ¨æ›´æ–°) selector: matchLabels: app: nfs-client-provisioner template: metadata: labels: app: nfs-client-provisioner spec: serviceAccountName: nfs-client-provisioner containers: - name: nfs-client-provisioner #image: gcr.io/k8s-staging-sig-storage/nfs-subdir-external-provisioner:v4.0.0 image: registry.cn-hangzhou.aliyuncs.com/lvbibir/nfs-subdir-external-provisioner:v4.0.2 volumeMounts: - name: nfs-client-root mountPath: /persistentvolumes env: - name: PROVISIONER_NAME # Provisionerçš„åç§°,ä»¥åè®¾ç½®çš„storageclassè¦å’Œè¿™ä¸ªä¿æŒä¸€è‡´ value: nfs-client - name: NFS_SERVER # NFSæœåŠ¡å™¨åœ°å€,éœ€å’Œvalumeså‚æ•°ä¸­é…ç½®çš„ä¿æŒä¸€è‡´ value: 1.1.1.1 - name: NFS_PATH # NFSæœåŠ¡å™¨æ•°æ®å­˜å‚¨ç›®å½•,éœ€å’Œvalumeså‚æ•°ä¸­é…ç½®çš„ä¿æŒä¸€è‡´ value: /nfs/kubernetes volumes: - name: nfs-client-root nfs: server: 1.1.1.1 # NFSæœåŠ¡å™¨åœ°å€ path: /nfs/kubernetes # NFSæœåŠ¡å™¨æ•°æ®å­˜å‚¨ç›®å½• storageClass\nåˆ›å»º nfs-sc.yml\napiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: nfs annotations: storageclass.kubernetes.io/is-default-class: \u0026#34;true\u0026#34; ## æ˜¯å¦è®¾ç½®ä¸ºé»˜è®¤çš„storageclass provisioner: nfs-client ## åŠ¨æ€å·åˆ†é…è€…åç§°ï¼Œå¿…é¡»å’Œdeploymentçš„PROVISIONER_NAMEå˜é‡ä¸­è®¾ç½®çš„Nameä¸€è‡´ parameters: archiveOnDelete: \u0026#34;false\u0026#34; ## è®¾ç½®ä¸º\u0026#34;false\u0026#34;æ—¶åˆ é™¤PVCä¸ä¼šä¿ç•™æ•°æ®,\u0026#34;true\u0026#34;åˆ™ä¿ç•™æ•°æ® mountOptions: - hard ## æŒ‡å®šä¸ºç¡¬æŒ‚è½½æ–¹å¼ - nfsvers=4 ## æŒ‡å®šNFSç‰ˆæœ¬,è¿™ä¸ªéœ€è¦æ ¹æ®NFS Serverç‰ˆæœ¬å·è®¾ç½® åˆ›å»ºä¸Šè¿°èµ„æº\n[root@k8s-node1 nfs]# mkdir /nfs/kubernetes/ [root@k8s-node1 nfs]# kubectl apply -f . deployment.apps/nfs-client-provisioner created serviceaccount/nfs-client-provisioner created clusterrole.rbac.authorization.k8s.io/nfs-client-provisioner-runner created clusterrolebinding.rbac.authorization.k8s.io/run-nfs-client-provisioner created role.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created rolebinding.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created storageclass.storage.k8s.io/nfs created 4.3.2 ç¤ºä¾‹ apiVersion: apps/v1 kind: Deployment metadata: name: demo-auto-pv labels: app: demo-auto-pv spec: replicas: 3 selector: matchLabels: app: demo-auto-pv template: metadata: labels: app: demo-auto-pv spec: terminationGracePeriodSeconds: 5 containers: - name: demo-auto-pv image: nginx:1.22.1 imagePullPolicy: IfNotPresent ports: - containerPort: 80 volumeMounts: - name: www mountPath: /usr/share/nginx/html/ volumes: - name: www persistentVolumeClaim: claimName: pvc-auto --- apiVersion: v1 kind: PersistentVolumeClaim metadata: name: pvc-auto spec: storageClassName: \u0026#34;nfs\u0026#34; accessModes: - ReadWriteOnce resources: requests: storage: 2Gi æµ‹è¯•éªŒè¯\n[root@k8s-node1 ~]# kubectl get pods NAME READY STATUS RESTARTS AGE pod/demo-auto-pv-7c974689b4-4cwr6 1/1 Running 0 47s pod/demo-auto-pv-7c974689b4-bb9v8 1/1 Running 0 47s pod/demo-auto-pv-7c974689b4-p525n 1/1 Running 0 47s pod/nfs-client-provisioner-66d6cb77fd-47hsf 1/1 Running 0 4m15s [root@k8s-node1 ~]# kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE persistentvolumeclaim/pvc-auto Bound pvc-22b65e10-ab97-47eb-aaa1-6c354a749a55 2Gi RWO managed-nfs-storage 47s [root@k8s-node1 ~]# kubectl get pv NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE persistentvolume/pvc-22b65e10-ab97-47eb-aaa1-6c354a749a55 2Gi RWO Delete Bound default/pvc-auto managed-nfs-storage 47s [root@k8s-node1 ~]# ls -l /nfs/ total 4 drwxrwxrwx. 2 root root 6 Apr 11 17:37 default-pvc-auto-pvc-22b65e10-ab97-47eb-aaa1-6c354a749a55 ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-storage/","summary":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0 ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å· å¯åŠ¨æ—¶éœ€è¦çš„åˆå§‹æ•°æ®ï¼Œå½•å…¥é…ç½®æ–‡ä»¶ å¯åŠ¨è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸´æ—¶æ•°æ®ï¼Œè¯¥ä¸´æ—¶æ•°æ®éœ€è¦å¤šä¸ªå®¹å™¨é—´å…±äº« å¯åŠ¨è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æŒä¹…åŒ–æ•°æ®ï¼Œä¾‹å¦‚ mysql çš„ data æ•°æ®å·æ¦‚è¿° kubernetes ä¸­çš„ volume æä¾›äº†åœ¨å®¹å™¨ä¸­æŒ‚è½½å¤–","title":"kubernetes | å­˜å‚¨"},{"content":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0\n1 æ»šåŠ¨å‡çº§ 1.1 å®ç°æœºåˆ¶ æ»šåŠ¨å‡çº§çš„å®ç°æœºåˆ¶\nä¸¤ä¸ª replicaset æ§åˆ¶å™¨åˆ†åˆ«æ§åˆ¶æ—§ç‰ˆæœ¬çš„ pod å’Œæ–°ç‰ˆæœ¬ podï¼Œreplicaset2 å¯åŠ¨ä¸€ä¸ªæ–°ç‰ˆç‰ˆæœ¬ podï¼Œç›¸åº”çš„ replicaset1 åœæ­¢ä¸€ä¸ªæ—§ç‰ˆæœ¬ podï¼Œä»è€Œå®ç°æ»šåŠ¨å‡çº§ã€‚åœ¨è¿™è¿‡ç¨‹ä¸­ï¼Œæ— æ³•ä¿è¯ä¸šåŠ¡æµé‡å®Œå…¨ä¸ä¸¢å¤±ã€‚\n1.2 ç®€å•ç¤ºä¾‹ å‡çº§\nkubectl set image (-f FILENAME | TYPE NAME) CONTAINER_NAME_1=CONTAINER_IMAGE_1 ... CONTAINER_NAME_N=CONTAINER_IMAGE_N [options] # ç¤ºä¾‹ kubectl set image deployment/demo-rollout nginx=nginx:1.15 --record=true # --record=true è¡¨ç¤ºå°†å‡çº§çš„å‘½ä»¤è®°å½•åˆ°å‡çº§è®°å½•ä¸­ å›æ»š\n# ä¸Šæ¬¡å‡çº§çŠ¶æ€ kubectl rollout status deployment demo-rollout # å‡çº§è®°å½• kubectl rollout history deployment demo-rollout # å›æ»šè‡³ä¸Šä¸ªç‰ˆæœ¬ kubectl rollout undo deployment demo-rollout # å›æ»šè‡³æŒ‡å®šç‰ˆæœ¬ kubectl rollout undo deployment demo-rollout --to-revision=2 1.3 å‡çº§ åœ¨æ‰€æœ‰ work èŠ‚ç‚¹å…ˆåˆ›å»ºå‡ ä¸ª busybox é•œåƒçš„ tag ç”¨äºå‡çº§æ¼”ç¤º\n[root@k8s-node3 ~]# for i in {1..3}; do docker tag busybox:latest busybox:v${i}; done [root@k8s-node3 ~]# docker images | grep busybox busybox latest 7cfbbec8963d 3 weeks ago 4.86MB busybox v1 7cfbbec8963d 3 weeks ago 4.86MB busybox v2 7cfbbec8963d 3 weeks ago 4.86MB busybox v3 7cfbbec8963d 3 weeks ago 4.86MB åˆ›å»º v1 ç‰ˆæœ¬çš„ deployment\napiVersion: apps/v1 kind: Deployment metadata: name: demo-rollout labels: app: demo-rollout spec: replicas: 3 selector: matchLabels: app: demo-rollout template: metadata: labels: app: demo-rollout spec: containers: - name: busybox image: busybox:v1 command: [\u0026#39;/bin/sh\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#39;sleep 36000\u0026#39;] ä¹Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤åˆ›å»º\n[root@k8s-node1 ~]# kubectl create deployment demo-rollout --image=busybox:v1 --replicas=3 -- sleep 3600 deployment.apps/demo-rollout created [root@k8s-node1 ~]# kubectl get pods NAME READY STATUS RESTARTS AGE demo-rollout-5d847fd86c-678pr 1/1 Running 0 4s demo-rollout-5d847fd86c-9mj4v 1/1 Running 0 4s demo-rollout-5d847fd86c-xhvf7 1/1 Running 0 4s å‡çº§è‡³ v2 å’Œ v3\n# å‡çº§ [root@k8s-node1 ~]# kubectl set image deployment/demo-rollout busybox=busybox:v2 --record=true [root@k8s-node1 ~]# kubectl set image deployment/demo-rollout busybox=busybox:v3 --record=true # æŸ¥çœ‹å‡çº§çŠ¶æ€ [root@k8s-node1 ~]# kubectl rollout status deployment demo-rollout deployment \u0026#34;demo-rollout\u0026#34; successfully rolled out [root@k8s-node1 ~]# kubectl rollout history deployment demo-rollout deployment.apps/demo-rollout REVISION CHANGE-CAUSE 1 \u0026lt;none\u0026gt; 2 kubectl set image deployment/demo-rollout busybox=busybox:v2 --record=true 3 kubectl set image deployment/demo-rollout busybox=busybox:v3 --record=true # æŸ¥çœ‹å®é™…é•œåƒç‰ˆæœ¬ [root@k8s-node1 ~]# kubectl get deployment demo-rollout -o jsonpath=\u0026#39;{.spec.template.spec.containers}\u0026#39; [root@k8s-node1 ~]# kubectl describe deployment demo-rollout | grep -i image: Image: busybox:v3 1.4 å›æ»š å›æ»šè‡³ v1 ç‰ˆæœ¬\n[root@k8s-node1 ~]# kubectl rollout undo deployment/demo-rollout --to-revision=1 deployment.apps/demo-rollout rolled back [root@k8s-node1 ~]# kubectl describe deployment demo-rollout | grep -i image: Image: busybox:v1 [root@k8s-node1 ~]# kubectl rollout history deployment demo-rollout deployment.apps/demo-rollout REVISION CHANGE-CAUSE 2 kubectl set image deployment/demo-rollout busybox=busybox:v2 --record=true 3 kubectl set image deployment/demo-rollout busybox=busybox:v3 --record=true 4 \u0026lt;none\u0026gt; å¯ä»¥çœ‹åˆ° rollout history åˆ é™¤äº†ç¬¬ä¸€æ¬¡çš„è®°å½•, é‡æ–°è®°å½•åˆ°ç¬¬å››æ¡\næ¢å¤åˆ° v2 ç‰ˆæœ¬\n[root@k8s-node1 ~]# kubectl rollout undo deployment/demo-rollout --to-revision=2 deployment.apps/demo-rollout rolled back [root@k8s-node1 ~]# kubectl describe deployment demo-rollout | grep -i image: Image: busybox:v2 [root@k8s-node1 ~]# kubectl rollout history deployment demo-rollout deployment.apps/demo-rollout REVISION CHANGE-CAUSE 3 kubectl set image deployment/demo-rollout busybox=busybox:v3 --record=true 4 \u0026lt;none\u0026gt; 5 kubectl set image deployment/demo-rollout busybox=busybox:v2 --record=true 2 è‡ªåŠ¨ä¼¸ç¼© æ‰‹åŠ¨æ‰©å®¹\nkubectl scale [--resource-version=version] [--current-replicas=count] --replicas=COUNT (-f FILENAME | TYPE NAME) [options] # ç¤ºä¾‹ kubectl scale deployment demo-rollout --replicas=10 è‡ªåŠ¨æ‰©å®¹\nå®ç°è‡ªåŠ¨æ‰©å®¹éœ€æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š\nè¿è¡Œäº† metric-server pod è®¾ç½®äº† request èµ„æº Horizontal Pod Autoscaling: pod æ°´å¹³æ‰©å®¹ï¼Œk8s ä¸­çš„ä¸€ä¸ª api èµ„æºï¼Œä½¿ç”¨ autoscale æ—¶ä¼šåˆ›å»ºä¸€ä¸ª hpa èµ„æº\nHPA åŸºæœ¬åŸç†:\næŸ¥è¯¢æŒ‡å®šçš„èµ„æºä¸­æ‰€æœ‰ Pod çš„èµ„æºå¹³å‡ä½¿ç”¨ç‡ï¼Œå¹¶ä¸”ä¸åˆ›å»ºæ—¶è®¾å®šçš„å€¼å’ŒæŒ‡æ ‡åšå¯¹æ¯”ï¼Œä»è€Œå®ç°è‡ªåŠ¨ä¼¸ç¼©çš„åŠŸèƒ½. HPA è‡ªåŠ¨ä¼¸ç¼©å‰¯æœ¬æ—¶ä¼šä½¿ POD çš„èµ„æºä½¿ç”¨ç‡è¶‹è¿‘äºé¢„è®¾çš„ target å€¼ æ¯”å¦‚åªæœ‰ä¸€ä¸ª POD æ—¶, èµ„æºä½¿ç”¨ç‡è¾¾åˆ°äº† 180%/70%, HPA ä¼šå°† POD æ•°é‡æ‰©å®¹åˆ° 3 ä¸ª, æ­¤æ—¶èµ„æºä½¿ç”¨ç‡å°†ä¼šæ˜¯ 60%/70%. å½“ pod èµ„æºä½¿ç”¨ç‡å›åˆ°æ­£å¸¸æ°´å¹³, controller-manager ä¼šé»˜è®¤ç­‰å¾… 5 åˆ†é’Ÿçš„æ—¶é—´å†ç¼©å®¹ pod,ä»¥å…å†æ¬¡å‡ºç°çªå‘æµé‡. kubectl autoscale (-f FILENAME | TYPE NAME | TYPE/NAME) [--min=MINPODS] --max=MAXPODS [--cpu-percent=CPU] [options] # åŸºäºcpuæŒ‡æ ‡è¿›è¡Œæ‰©å®¹ kubectl autoscale deployment demo-rollout --min=3 --max=10 --cpu-percent=10 # æŸ¥çœ‹hpa kubectl get hpa # replicasetæ§åˆ¶å™¨è®°å½•äº†podçš„è¯¦ç»†ä¼¸ç¼©è®°å½• kubectl get rs kubectl describe rs demo-rollout-54fdcc5676 2.1 åŸºäº CPU åˆ›å»º deployment èµ„æº\napiVersion: apps/v1 kind: Deployment metadata: name: hpa-demo spec: selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx ports: - containerPort: 80 resources: requests: memory: 50Mi cpu: 50m --- apiVersion: v1 kind: Service metadata: name: hpa-demo labels: app: nginx spec: selector: app: nginx type: NodePort ports: - protocol: TCP port: 80 targetPort: 80 nodePort: 30002 åˆ›å»º hpa èµ„æº\ncpu ä½¿ç”¨ç‡ = å·²ä½¿ç”¨ / request\n--cpu-percent=60 ä»£è¡¨æ‰€æœ‰ pod çš„å¹³å‡ cpu ä½¿ç”¨ç‡è¾¾åˆ°ç™¾åˆ†ä¹‹ 60 æ—¶è§¦å‘æ‰©å®¹\n[root@k8s-node1 ~]# kubectl autoscale deployment hpa-demo --cpu-percent=60 --min=1 --max=10 horizontalpodautoscaler.autoscaling/hpa-demo autoscaled [root@k8s-node1 ~]# kubectl get hpa NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE hpa-demo Deployment/hpa-demo 0%/60% 1 10 1 18s å‹æµ‹\n[root@k8s-node1 ~]# yum install -y httpd-tools [root@k8s-node1 ~]# ab -n 1000000 -c 200 http://1.1.1.1:30002/ hpa è‡ªåŠ¨æ‰©å®¹, pod æ•°é‡å¢åŠ åˆ°äº† 10 ä¸ª\n[root@k8s-node1 ~]# kubectl get hpa NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE hpa-demo Deployment/hpa-demo 160%/10% 1 10 10 50m [root@k8s-node1 ~]# kubectl describe hpa hpa-demo Events: Type Reason Age From Message ---- ------ ---- ---- ------- Warning FailedGetScale 17m (x8 over 19m) horizontal-pod-autoscaler deployments/scale.apps \u0026#34;hpa-demo\u0026#34; not found Normal SuccessfulRescale 11m horizontal-pod-autoscaler New size: 4; reason: cpu resource utilization (percentage of request) above target Normal SuccessfulRescale 11m horizontal-pod-autoscaler New size: 8; reason: cpu resource utilization (percentage of request) above target Normal SuccessfulRescale 10m horizontal-pod-autoscaler New size: 10; reason: [root@k8s-node1 ~]# kubectl describe deployment hpa-demo Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal ScalingReplicaSet 16m deployment-controller Scaled up replica set hpa-demo-6b4467b546 to 1 Normal ScalingReplicaSet 10m deployment-controller Scaled up replica set hpa-demo-6b4467b546 to 4 Normal ScalingReplicaSet 9m53s deployment-controller Scaled up replica set hpa-demo-6b4467b546 to 8 Normal ScalingReplicaSet 9m38s deployment-controller Scaled up replica set hpa-demo-6b4467b546 to 10 å‹æµ‹ç»“æŸåä¹Ÿå¹¶ä¸ä¼šç«‹å³å‡å°‘ pod æ•°é‡ï¼Œä¼šç­‰ä¸€æ®µæ—¶é—´åå‡å°‘ pod æ•°é‡ï¼Œé˜²æ­¢æµé‡å†æ¬¡æ¿€å¢ã€‚é»˜è®¤æ—¶é—´å¤§æ¦‚æ˜¯ 5 åˆ†é’Ÿå·¦å³\n2.2 åŸºäºå†…å­˜ ä½¿ç”¨ busybox å®¹å™¨æµ‹è¯•, å¦æŒ‚è½½ä¸€ä¸ª configMap ç”¨äºå†…å­˜å‹åŠ›æµ‹è¯•, ç”±äºç”¨åˆ°äº† mount å‘½ä»¤, è¿˜éœ€è¦å°† container å£°æ˜ä¸ºç‰¹æƒæ¨¡å¼.\napiVersion: apps/v1 kind: Deployment metadata: name: hpa-mem spec: selector: matchLabels: app: busybox template: metadata: labels: app: busybox spec: containers: - name: busybox image: busybox command: [\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;sleep 36000\u0026#34;] volumeMounts: - name: increase-mem-script mountPath: /opt/ resources: requests: memory: 50Mi cpu: 50m securityContext: privileged: true volumes: - name: increase-mem-script configMap: name: increase-mem-config --- apiVersion: v1 kind: ConfigMap metadata: name: increase-mem-config data: increase-mem.sh: | #!/bin/sh mkdir /tmp/memory mount -t tmpfs -o size=40M tmpfs /tmp/memory dd if=/dev/zero of=/tmp/memory/block sleep 60 rm /tmp/memory/block umount /tmp/memory rmdir /tmp/memory è·å– hpa çš„æ¨¡æ¿ yaml æ–‡ä»¶\n[root@k8s-node1 ~]# kubectl autoscale deployment hpa-mem --min=1 --max=10 --dry-run=client -o yaml \u0026gt; hpa-mem-hpa.yml [root@k8s-node1 ~]# vim hpa-mem-hpa.yml ä½¿ç”¨ yaml åˆ›å»º hpa, é»˜è®¤ä½¿ç”¨çš„æ˜¯ autoscaling/v1 ç‰ˆæœ¬çš„ api, å®ƒä¸æ”¯æŒåŸºäºå†…å­˜çš„è‡ªåŠ¨æ‰©å®¹, éœ€è¦ä¿®æ”¹ä¸º autoscaling/v2beta1\napiVersion: autoscaling/v2beta1 kind: HorizontalPodAutoscaler metadata: name: hpa-mem spec: maxReplicas: 10 minReplicas: 1 scaleTargetRef: apiVersion: apps/v1 kind: Deployment name: hpa-mem metrics: - type: Resource resource: name: memory targetAverageUtilization: 60 æ‰§è¡Œè„šæœ¬è¿›è¡Œå‹æµ‹, éšç€è„šæœ¬æ‰§è¡Œ, hpa è‡ªåŠ¨å°†å‰¯æœ¬æ•°æ‰©å®¹åˆ°äº†ä¸¤ä¸ª\n[root@k8s-node1 ~]# kubectl exec -it hpa-mem-c6c7d4957-fpsfb -- /bin/sh /opt/increase-mem.sh [root@k8s-node1 ~]# kubectl get hpa -w NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE hpa-mem Deployment/hpa-mem 0%/60% 1 10 1 2m55s hpa-mem Deployment/hpa-mem 80%/60% 1 10 1 4m1s hpa-mem Deployment/hpa-mem 80%/60% 1 10 2 4m16s è„šæœ¬æ‰§è¡Œ 60s åä¼šä½¿å†…å­˜ä½¿ç”¨ç‡è‡ªåŠ¨æ¢å¤æ­£å¸¸, å‰¯æœ¬æ•°è¿‡æ®µæ—¶é—´ä¹Ÿä¼šè‡ªåŠ¨æ¢å¤\n2.3 åŸºäºè‡ªå®šä¹‰æŒ‡æ ‡ å¾…ç»­â€¦â€¦\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-auto-scale/","summary":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0 1 æ»šåŠ¨å‡çº§ 1.1 å®ç°æœºåˆ¶ æ»šåŠ¨å‡çº§çš„å®ç°æœºåˆ¶ ä¸¤ä¸ª replicaset æ§åˆ¶å™¨åˆ†åˆ«æ§åˆ¶æ—§ç‰ˆæœ¬çš„ pod å’Œæ–°ç‰ˆæœ¬ podï¼Œreplicaset2 å¯åŠ¨ä¸€ä¸ªæ–°ç‰ˆç‰ˆæœ¬ podï¼Œç›¸åº”çš„ replicaset1 åœæ­¢ä¸€ä¸ªæ—§ç‰ˆæœ¬ podï¼Œä»è€Œå®ç°æ»šåŠ¨å‡çº§ã€‚åœ¨","title":"kubernetes | æ»šåŠ¨å‡çº§å’Œè‡ªåŠ¨ä¼¸ç¼©"},{"content":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0\ncontrollers ä½œç”¨ï¼š\nç®¡ç† pod å¯¹è±¡ ä½¿ç”¨æ ‡ç­¾ä¸ pod å…³è” è´Ÿè´£æ»šåŠ¨æ›´æ–°ã€ä¼¸ç¼©ã€å‰¯æœ¬ç®¡ç†ã€ç»´æŒ pod çŠ¶æ€ç­‰ 1 daemonset 2 ingress 3 statefulset 4 replicaset ReplicaSetï¼šå‰¯æœ¬é›†\nååŠ© Deployment åšäº‹\nPod å‰¯æœ¬æ•°é‡ç®¡ç†ï¼Œä¸æ–­å¯¹æ¯”å½“å‰ Pod æ•°é‡ä¸æœŸæœ› Pod æ•°é‡\nDeployment æ¯æ¬¡å‘å¸ƒéƒ½ä¼šåˆ›å»ºä¸€ä¸ª RS ä½œä¸ºè®°å½•ï¼Œç”¨äºå®ç°å›æ»š\n5 deployment deployment ç”¨äºç½‘ç«™ã€APIã€å¾®æœåŠ¡ç­‰ï¼ŒåŠŸèƒ½ç‰¹æ€§ï¼š\nç®¡ç† pod å’Œ replicaset å…·æœ‰ä¸Šçº¿éƒ¨ç½²ã€å‰¯æœ¬è®¾å®šã€æ»šåŠ¨å‡çº§ã€å›æ»šç­‰åŠŸèƒ½ æä¾›å£°æ˜å¼æ›´æ–°ï¼Œä¾‹å¦‚åªæ›´æ–°ä¸€ä¸ªæ–°çš„ image ç¤ºä¾‹\napiVersion: apps/v1 kind: Deployment metadata: name: nginx labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.19 ports: - containerPort: 80 ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-controllers/","summary":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0 controllers ä½œç”¨ï¼š ç®¡ç† pod å¯¹è±¡ ä½¿ç”¨æ ‡ç­¾ä¸ pod å…³è” è´Ÿè´£æ»šåŠ¨æ›´æ–°ã€ä¼¸ç¼©ã€å‰¯æœ¬ç®¡ç†ã€ç»´æŒ pod çŠ¶æ€ç­‰ 1 daemonset 2 ingress 3 statefulset 4 replicaset ReplicaSetï¼šå‰¯æœ¬é›† ååŠ© Deployment åšäº‹ Pod å‰¯æœ¬æ•°é‡ç®¡ç†ï¼Œä¸æ–­å¯¹æ¯”å½“å‰ Pod æ•°é‡ä¸æœŸæœ› Pod æ•°é‡ Deployment æ¯","title":"kubernetes | æ§åˆ¶å™¨"},{"content":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0\nkubelet logs å‘½ä»¤çš„æµç¨‹\nkubectl logs --è¯·æ±‚--\u0026gt; apiserver --è¯·æ±‚--\u0026gt; kubelet --è¯»å–--\u0026gt; containeræ—¥å¿— k8s æ—¥å¿—åŒ…å«ä¸¤å¤§ç±»ï¼š\nk8s ç³»ç»Ÿçš„ç»„ä»¶æ—¥å¿— k8s é›†ç¾¤ä¸­éƒ¨ç½²çš„åº”ç”¨ç¨‹åºçš„æ—¥å¿— æ ‡å‡†è¾“å‡º æ—¥å¿—æ–‡ä»¶ 1 ç»„ä»¶æ—¥å¿— journalctl -u kubelet kubectl logs kube-proxy -n kube-system /var/log/messages 2 pod æ—¥å¿— 2.1 æ ‡å‡†è¾“å‡º å®æ—¶æŸ¥çœ‹ pod æ ‡å‡†è¾“å‡ºæ—¥å¿—\nkubectl logs [options] \u0026lt;podname\u0026gt; kubectl logs -f \u0026lt;podname\u0026gt; kubectl logs -f \u0026lt;podname\u0026gt; -c \u0026lt;containername\u0026gt; kubectl logs --previous \u0026lt;podname\u0026gt; # æŸ¥çœ‹podä¸Šæ¬¡é‡å¯çš„æ—¥å¿— k8s ä¼šå°†æ¯ä¸ª pod ä¸­æ¯ä¸ª container çš„æ—¥å¿—è®°å½•åˆ° pod æ‰€åœ¨ node çš„ /var/log/pods ç›®å½•ä¸­, æ—¥å¿—æ–‡ä»¶å…¶å®æ˜¯ docker ä¿å­˜çš„æ—¥å¿—æ–‡ä»¶çš„ä¸€ä¸ªè½¯è¿æ¥.\nk8s ä¼šä¸ºæ¯ä¸ª pod çš„æ¯ä¸ª container æ—¥å¿—ä¿ç•™ 2 ä»½, ä¸€ä»½ä¸º container å½“å‰çŠ¶æ€çš„æ—¥å¿—, å¦ä¸€ä»½æ˜¯ container ä¸Šä¸€æ¬¡ç”Ÿå‘½å‘¨æœŸçš„æ—¥å¿—, æ—¥å¿—ä¿ç•™æ•°é‡åº”è¯¥æ˜¯ç”± k8s çš„ gc æœºåˆ¶ç®¡æ§.\n# k8s æ—¥å¿— /var/log/pods/\u0026lt;pod namespace\u0026gt;_\u0026lt;pod name\u0026gt;_\u0026lt;pod uid\u0026gt;/\u0026lt;å®¹å™¨åç§°\u0026gt;/å®¹å™¨é‡å¯æ¬¡æ•°.log # dockeræ—¥å¿— /var/lib/docker/containers/\u0026lt;container-id\u0026gt;/\u0026lt;container-id\u0026gt;-json.log ç¤ºä¾‹\n# å¯ä»¥çœ‹åˆ° calico-kube-controllers è¿™ä¸ª pod é‡å¯äº† 7 æ¬¡ [root@k8s-node1 ~]# kubectl get pods -n kube-system -l k8s-app=calico-kube-controllers NAME READY STATUS RESTARTS AGE calico-kube-controllers-6c76574f75-69flf 1/1 Running 7 (41h ago) 4d1h # k8s åˆ†åˆ«ä¿å­˜äº†ç¼–å· 6 å’Œ 7 ä¸¤ä¸ªæ—¥å¿—æ–‡ä»¶ [root@k8s-node3 ~]# ls -l /var/log/pods/kube-system_calico-kube-controllers-6c76574f75-69flf_066e1042-97a4-4547-8d2d-6580cbad40c5/calico-kube-controllers/ lrwxrwxrwx. 1 root root 165 Apr 20 14:31 6.log -\u0026gt; /var/lib/docker/containers/8ed4865daa5d984d9b7e3412f61251ce1a5e12e295fce1f14ee341c3f79b1afe/8ed4865daa5d984d9b7e3412f61251ce1a5e12e295fce1f14ee341c3f79b1afe-json.log lrwxrwxrwx. 1 root root 165 Apr 23 10:23 7.log -\u0026gt; /var/lib/docker/containers/c30d353ee464efd853968dcd1524933aa214294303e5a7cd7828b0e86f0e94ec/c30d353ee464efd853968dcd1524933aa214294303e5a7cd7828b0e86f0e94ec-json.log # 7 å·æ—¥å¿—æ–‡ä»¶æ˜¯å½“å‰ç”Ÿå‘½å‘¨æœŸçš„æ—¥å¿— [root@k8s-node1 ~]# kubectl logs --tail=1 calico-kube-controllers-6c76574f75-69flf -n kube-system 2023-04-23 03:05:54.256 [INFO][1] resources.go 350: Main client watcher loop [root@k8s-node3 calico-kube-controllers]# tail -n 1 7.log | python -m json.tool { \u0026#34;log\u0026#34;: \u0026#34;2023-04-23 03:05:54.256 [INFO][1] resources.go 350: Main client watcher loop\\n\u0026#34;, \u0026#34;stream\u0026#34;: \u0026#34;stderr\u0026#34;, \u0026#34;time\u0026#34;: \u0026#34;2023-04-23T03:05:54.257447874Z\u0026#34; } # 6 å·æ—¥å¿—æ–‡ä»¶æ˜¯ä¸Šä¸€æ¬¡ç”Ÿå‘½å‘¨æœŸçš„æ—¥å¿— [root@k8s-node1 ~]# kubectl logs --tail=1 --previous calico-kube-controllers-6c76574f75-69flf -n kube-system 2023-04-21 08:57:20.637 [INFO][1] resources.go 350: Main client watcher loop [root@k8s-node3 calico-kube-controllers]# tail -n 1 6.log | python -m json.tool { \u0026#34;log\u0026#34;: \u0026#34;2023-04-21 08:57:20.637 [INFO][1] resources.go 350: Main client watcher loop\\n\u0026#34;, \u0026#34;stream\u0026#34;: \u0026#34;stderr\u0026#34;, \u0026#34;time\u0026#34;: \u0026#34;2023-04-21T08:57:20.637780663Z\u0026#34; } 2.2 æ—¥å¿—æ–‡ä»¶ æ¯”å¦‚ nginx åº”ç”¨çš„æ—¥å¿—ä¸€èˆ¬ä¿å­˜åœ¨ accesss.log å’Œ error.log æ—¥å¿—ä¸­ï¼Œè¿™äº›æ—¥å¿—æ˜¯ä¸ä¼šè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºçš„ï¼Œå¯ä»¥é‡‡ç”¨å¦‚ä¸‹ä¸¤ç§æ–¹å¼è¿›è¡Œé‡‡é›†\n2.2.1 emptyDir æ•°æ®å· åˆ›å»º pod æ—¶æŒ‚è½½ emptyDIr ç±»å‹çš„æ•°æ®å·ï¼Œç”¨ä»¥æŒä¹…åŒ–è‡ªå®šä¹‰çš„æ—¥å¿—æ–‡ä»¶\néœ€è¦å…ˆæ‰¾åˆ° pod åˆ†é…çš„èŠ‚ç‚¹\nKubectl get pods -o wide å†æŸ¥çœ‹ pod çš„ id\ndocker ps | grep pod-name # æˆ–è€… kubectl get pod \u0026lt;podname\u0026gt; -n \u0026lt;namespace\u0026gt; -o jsonpath=\u0026#39;{.metadata.uid}\u0026#39; pod æ—¥å¿—æ–‡ä»¶è·¯å¾„\n/var/lib/kubelet/pods/\u0026lt;pod-id\u0026gt;/volumes/kubernetes.io~empty-dir ç¤ºä¾‹\napiVersion: v1 kind: Pod metadata: name: pod-logs-emptydir spec: containers: - name: web image: nginx volumeMounts: - name: logs mountPath: /var/log/nginx/ volumes: - name: logs emptyDir: {} 2.2.2 sidecar è¾¹è½¦å®¹å™¨ é€šè¿‡åˆ›å»ºè¾¹è½¦å®¹å™¨å®ç°å°†åº”ç”¨åŸæœ¬çš„æ—¥å¿—æ–‡ä»¶è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º\nç¤ºä¾‹ï¼š\napiVersion: v1 kind: Pod metadata: name: nginx labels: app: nginx spec: containers: - name: web image: nginx:1.22.1 volumeMounts: - name: logs mountPath: /var/log/nginx/ - name: accesslog image: busybox:1.28 command: [\u0026#39;/bin/sh\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#39;tail -f /opt/access.log\u0026#39;] volumeMounts: - name: logs mountPath: /opt volumes: - name: logs emptyDir: {} ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-logs/","summary":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0 kubelet logs å‘½ä»¤çš„æµç¨‹ kubectl logs --è¯·æ±‚--\u0026gt; apiserver --è¯·æ±‚--\u0026gt; kubelet --è¯»å–--\u0026gt; containeræ—¥å¿— k8s æ—¥å¿—åŒ…å«ä¸¤å¤§ç±»ï¼š k8s ç³»ç»Ÿçš„ç»„ä»¶æ—¥å¿— k8s é›†ç¾¤ä¸­éƒ¨ç½²çš„åº”ç”¨ç¨‹åºçš„æ—¥å¿— æ ‡å‡†è¾“å‡º æ—¥å¿—æ–‡","title":"kubernetes | æ—¥å¿—"},{"content":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0\n1 åˆ›å»º pod çš„å·¥ä½œæµç¨‹ kubectl run nginx \u0026ndash;image=nginx kubectl å°†åˆ›å»º pod çš„è¯·æ±‚å‘é€åˆ° apiserver apiserver å°†è¯·æ±‚ä¿¡æ¯å†™å…¥ etcd apiserver é€šçŸ¥ schedulerï¼Œæ”¶åˆ°è¯·æ±‚ä¿¡æ¯åæ ¹æ®è°ƒåº¦ç®—æ³•å°† pod åˆ†é…åˆ°åˆé€‚èŠ‚ç‚¹ scheduler ç»™ pod æ ‡è®°è°ƒåº¦ç»“æœï¼Œå¹¶è¿”å›ç»™ apiserver apiserver æ”¶åˆ°åå†™å…¥ etcd å¯¹åº”èŠ‚ç‚¹çš„ kubelet æ”¶åˆ°åˆ›å»º pod çš„äº‹ä»¶ï¼Œä» apiserver è·å–åˆ° pod çš„ç›¸å…³ä¿¡æ¯ kubelet è°ƒç”¨ docker api åˆ›å»º pod æ‰€éœ€çš„å®¹å™¨ åˆ›å»ºå®Œæˆä¹‹åå°† pod çŠ¶æ€æ±‡æŠ¥ç»™ apiserver apiserver å°†æ”¶åˆ°çš„ pod çŠ¶æ€å†™å…¥ apiserver kubectl get pods å³å¯æ”¶åˆ°ç›¸å…³ä¿¡æ¯ 2 èµ„æºé™åˆ¶å¯¹ pod è°ƒåº¦çš„å½±å“ å®¹å™¨èµ„æºé™åˆ¶ï¼š\nresources.limits.cpu resources.limits.memory å®¹å™¨ä½¿ç”¨çš„æœ€å°èµ„æºéœ€æ±‚ï¼Œå¹¶ä¸æ˜¯å®é™…å ç”¨ï¼Œæ˜¯é¢„ç•™èµ„æºï¼š\nresources.requests.cpu resources.requests.memory apiVersion: v1 kind: Pod metadata: name: nginx spec: containers: - name: web image: nginx resources: requests: memory: \u0026#34;64Mi\u0026#34; cpu: \u0026#34;250m\u0026#34; #cpuå•ä½ä¹Ÿå¯ä»¥å†™æµ®ç‚¹æ•°ï¼Œä¾‹å¦‚0.25=250mï¼Œä»£è¡¨å››åˆ†ä¹‹ä¸€æ ¸cpu limits: memory: \u0026#34;128Mi\u0026#34; cpu: \u0026#34;500m\u0026#34; 3 nodeSelector nodeSelector ç”¨äºå°† Pod è°ƒåº¦åˆ°åŒ¹é… Label çš„ Node ä¸Šï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…çš„æ ‡ç­¾ä¼šè°ƒåº¦å¤±è´¥ã€‚\nå…ˆåˆ›å»º pod åæ‰“æ ‡ç­¾ï¼Œèµ·å§‹å‡ºäº pending çŠ¶æ€ï¼Œæ‰“å¥½æ ‡ç­¾åï¼Œpod ä¼šæ­£å¸¸åˆ†é…\nç»™èŠ‚ç‚¹æ‰“æ ‡ç­¾ï¼š\nkubectl label nodes [node] key=value # æ‰“lable, valueå¯ä»¥æ˜¯ç©º kubectl label nodes [node] key- # åˆ é™¤label kubectl get nodes -l key=value # æ ¹æ®labelç­›é€‰ # ç¤ºä¾‹ kubectl label nodes k8s-node1 disktype=ssd kubectl label nodes k8s-node1 disktype- ç¤ºä¾‹\napiVersion: v1 kind: Pod metadata: name: pod-nodeselector spec: containers: - name: nginx image: nginx:1.19 nodeSelector: disktype: \u0026#34;ssd\u0026#34; 4 nodeAffinity èŠ‚ç‚¹äº²å’Œæ€§æ¦‚å¿µä¸Šç±»ä¼¼äº nodeSelectorï¼Œ å®ƒä½¿ä½ å¯ä»¥æ ¹æ®èŠ‚ç‚¹ä¸Šçš„æ ‡ç­¾æ¥çº¦æŸ Pod å¯ä»¥è°ƒåº¦åˆ°å“ªäº›èŠ‚ç‚¹ä¸Šã€‚ èŠ‚ç‚¹äº²å’Œæ€§æœ‰ä¸¤ç§ï¼š\nrequiredDuringSchedulingIgnoredDuringExecutionï¼š è°ƒåº¦å™¨åªæœ‰åœ¨è§„åˆ™è¢«æ»¡è¶³çš„æ—¶å€™æ‰èƒ½æ‰§è¡Œè°ƒåº¦ã€‚æ­¤åŠŸèƒ½ç±»ä¼¼äº nodeSelectorï¼Œ ä½†å…¶è¯­æ³•è¡¨è¾¾èƒ½åŠ›æ›´å¼ºã€‚ preferredDuringSchedulingIgnoredDuringExecutionï¼š è°ƒåº¦å™¨ä¼šå°è¯•å¯»æ‰¾æ»¡è¶³å¯¹åº”è§„åˆ™çš„èŠ‚ç‚¹ã€‚å¦‚æœæ‰¾ä¸åˆ°åŒ¹é…çš„èŠ‚ç‚¹ï¼Œè°ƒåº¦å™¨ä»ç„¶ä¼šè°ƒåº¦è¯¥ Podã€‚ å…ˆåˆ›å»º pod åæ‰“æ ‡ç­¾èµ·å§‹å‡ºäº pending çŠ¶æ€ï¼Œæ‰“å¥½æ ‡ç­¾åï¼Œpod ä¼šæ­£å¸¸åˆ†é…\nIgnoredDuringExecution æ„å‘³ç€å¦‚æœèŠ‚ç‚¹æ ‡ç­¾åœ¨ Kubernetes è°ƒåº¦ Pod åå‘ç”Ÿäº†å˜æ›´ï¼ŒPod ä»å°†ç»§ç»­è¿è¡Œã€‚\næ“ä½œç¬¦ï¼šInã€NotInã€Existsã€DoesNotExistã€Gtã€Lt\nç¤ºä¾‹\napiVersion: v1 kind: Pod metadata: name: with-affinity-anti-affinity spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/os operator: In values: - linux - windows preferredDuringSchedulingIgnoredDuringExecution: - weight: 1 preference: matchExpressions: - key: label-1 operator: In values: - key-1 - weight: 50 preference: matchExpressions: - key: label-2 operator: In values: - key-2 containers: - name: with-node-affinity image: registry.k8s.io/pause:2.0 5 Taint(æ±¡ç‚¹) Taintsï¼šé¿å… Pod è°ƒåº¦åˆ°ç‰¹å®š Node ä¸Š\nåº”ç”¨åœºæ™¯ï¼š\nä¸“ç”¨èŠ‚ç‚¹ï¼Œä¾‹å¦‚é…å¤‡äº†ç‰¹æ®Šç¡¬ä»¶çš„èŠ‚ç‚¹ åŸºäº Taint çš„é©±é€ è®¾ç½®æ±¡ç‚¹ï¼š\nkubectl taint node [node] key=value:[effect] # å…¶ä¸­[effect]å¯å–å€¼ï¼š # - NoSchedule ï¼šä¸€å®šä¸èƒ½è¢«è°ƒåº¦ã€‚ # - PreferNoScheduleï¼šå°½é‡ä¸è¦è°ƒåº¦ã€‚ # - NoExecuteï¼šä¸ä»…ä¸ä¼šè°ƒåº¦ï¼Œè¿˜ä¼šé©±é€Nodeä¸Šå·²æœ‰çš„Podã€‚ å»æ‰æ±¡ç‚¹ï¼š\nkubectl taint node [node] key:[effect]- ç¤ºä¾‹\n[root@k8s-node1 ~]# kubectl label node k8s-node2 disktype=ssd node/k8s-node2 labeled [root@k8s-node1 ~]# kubectl taint node k8s-node2 disktype=ssd:NoSchedule node/k8s-node2 tainted [root@k8s-node1 ~]# kubectl describe node k8s-node2 | grep -i taints Taints: disktype=ssd:NoSchedule Tolerationsï¼ˆæ±¡ç‚¹å®¹å¿ï¼‰\nå…è®¸ Pod è°ƒåº¦åˆ°æŒæœ‰ Taints çš„ Node ä¸Šï¼Œä½†ä¸æ˜¯ç»å¯¹åˆ†é…åˆ°æŒ‡å®šçš„æ ‡ç­¾ï¼Œæ­é… nodeSelector æˆ–è€… nodeAffinity ä½¿ç”¨ï¼Œå®ç°å°† pod åˆ†é…åˆ°ç‰¹å®šæ±¡ç‚¹çš„èŠ‚ç‚¹ä¸Š\ntolerations: #è®¾ç½®å®¹å¿æ‰€æœ‰æ±¡ç‚¹ï¼Œé˜²æ­¢èŠ‚ç‚¹è¢«è®¾ç½®æ±¡ç‚¹ - operator: \u0026#34;Exists\u0026#34; ç¤ºä¾‹\n[root@k8s-node1 ~]# kubectl describe node k8s-node2 | grep -i taints Taint Taints: disktype=ssd:NoSchedule [root@k8s-node1 ~]# kubectl apply -f pod-tolerations.yaml [root@k8s-node1 ~]# kubectl get pods pod-tolerations -o wide pod-tolerations 1/1 Running 0 13s 10.244.169.183 k8s-node2 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; yaml\napiVersion: v1 kind: Pod metadata: name: pod-tolerations spec: containers: - name: nginx image: nginx:1.19 nodeSelector: disktype: \u0026#34;ssd\u0026#34; tolerations: - key: \u0026#34;disktype\u0026#34; operator: \u0026#34;Equal\u0026#34; value: \u0026#34;ssd\u0026#34; effect: \u0026#34;NoSchedule\u0026#34; 6 nodeName æŒ‡å®šèŠ‚ç‚¹åç§°ï¼Œç”¨äºå°† Pod è°ƒåº¦åˆ°æŒ‡å®šçš„ Node ä¸Šï¼Œä¸ç»è¿‡è°ƒåº¦å™¨ schedulerï¼Œæ‰€ä»¥æ— è§†æ±¡ç‚¹\nç¤ºä¾‹\n[root@k8s-node1 ~]# kubectl describe node k8s-node2| grep Taint Taints: disktype=ssd:NoSchedule [root@k8s-node1 ~]# kubectl apply -f pod-nodename.yaml pod/pod-nodename created [root@k8s-node1 ~]# kubectl get pod pod-nodename -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES pod-nodename 1/1 Running 0 27s 10.244.169.184 k8s-node2 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; yaml\napiVersion: v1 kind: Pod metadata: name: pod-nodename spec: containers: - name: nginx image: nginx nodeName: k8s-node2 7 DaemonSet æ§åˆ¶å™¨ DaemonSet åŠŸèƒ½ï¼š\nåœ¨æ¯ä¸€ä¸ª Node ä¸Šè¿è¡Œä¸€ä¸ª Pod æ–°åŠ å…¥çš„ Node ä¹ŸåŒæ ·ä¼šè‡ªåŠ¨è¿è¡Œä¸€ä¸ª Pod åº”ç”¨åœºæ™¯ï¼šç½‘ç»œæ’ä»¶ã€ç›‘æ§ Agentã€æ—¥å¿— Agentï¼Œæ¯”å¦‚ k8s çš„ calico-node å’Œ kube-proxy ç»„ä»¶\nç¤ºä¾‹\n[root@k8s-node1 ~]# kubectl apply -f daemonset-filebeat.yaml [root@k8s-node1 ~]# kubectl get pods -n kube-system -o wide |grep filebeat filebeat-2c6p4 1/1 Running 0 90s 10.244.107.246 k8s-node3 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; filebeat-4ffcx 1/1 Running 0 90s 10.244.36.65 k8s-node1 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; filebeat-h7959 1/1 Running 0 90s 10.244.169.186 k8s-node2 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; yaml\napiVersion: apps/v1 kind: DaemonSet metadata: name: filebeat namespace: kube-system spec: selector: matchLabels: name: filebeat template: metadata: labels: name: filebeat spec: containers: - name: log image: elastic/filebeat:7.3.2 volumeMounts: - mountPath: /log/ name: log volumes: - name: log hostPath: path: /var/lib/docker/containers/ type: Directory tolerations: - key: \u0026#34;node-role.kubernetes.io/master\u0026#34; operator: \u0026#34;Exists\u0026#34; effect: \u0026#34;NoSchedule\u0026#34; ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-scheduler/","summary":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0 1 åˆ›å»º pod çš„å·¥ä½œæµç¨‹ kubectl run nginx \u0026ndash;image=nginx kubectl å°†åˆ›å»º pod çš„è¯·æ±‚å‘é€åˆ° apiserver apiserver å°†è¯·æ±‚ä¿¡æ¯å†™å…¥ etcd apiserver é€šçŸ¥ schedulerï¼Œæ”¶åˆ°è¯·æ±‚ä¿¡æ¯åæ ¹æ®è°ƒåº¦ç®—æ³•å°† pod åˆ†é…åˆ°åˆé€‚èŠ‚ç‚¹ scheduler ç»™ pod æ ‡è®°è°ƒåº¦ç»“æœï¼Œå¹¶è¿”å›ç»™ apiserver apiserver æ”¶åˆ°åå†™å…¥","title":"kubernetes | è°ƒåº¦"},{"content":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0\n1 ç®€ä»‹ åŸºæœ¬æ¦‚å¿µ\næœ€å°éƒ¨ç½²å•å…ƒ ä¸€ç»„å®¹å™¨çš„é›†åˆ ä¸€ä¸ª Pod ä¸­çš„å®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´ Pod æ˜¯çŸ­æš‚çš„ å­˜åœ¨æ„ä¹‰\nPod ä¸ºäº²å¯†æ€§åº”ç”¨è€Œå­˜åœ¨ã€‚\näº²å¯†æ€§åº”ç”¨åœºæ™¯ï¼š\nä¸¤ä¸ªåº”ç”¨ä¹‹é—´å‘ç”Ÿæ–‡ä»¶äº¤äº’ ä¸¤ä¸ªåº”ç”¨éœ€è¦é€šè¿‡ 127.0.0.1 æˆ–è€… socket é€šä¿¡ï¼ˆå…¸å‹ç»„åˆï¼šnginx+phpï¼‰ ä¸¤ä¸ªåº”ç”¨éœ€è¦å‘ç”Ÿé¢‘ç¹çš„è°ƒç”¨ 2 pod ä¸­çš„å®¹å™¨åˆ†ç±» Infrastructure Containerï¼šåŸºç¡€å®¹å™¨ï¼Œç»´æŠ¤æ•´ä¸ª Pod ç½‘ç»œç©ºé—´ InitContainersï¼šåˆå§‹åŒ–å®¹å™¨ï¼Œå…ˆäºä¸šåŠ¡å®¹å™¨å¼€å§‹æ‰§è¡Œ Containersï¼šä¸šåŠ¡å®¹å™¨ï¼Œå¹¶è¡Œå¯åŠ¨ Infrastructure Container\npod ä¸­æ€»ä¼šå¤šä¸€ä¸ª pause å®¹å™¨ï¼Œè¿™ä¸ªå®¹å™¨å°±æ˜¯å®ç°å°† pod ä¸­çš„æ‰€æœ‰å®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´è¿›è¡Œç»Ÿä¸€ï¼Œa å®¹å™¨åœ¨ localhost æˆ–è€… 127.0.0.1 çš„æŸä¸ªç«¯å£æä¾›äº†æœåŠ¡ï¼Œb å®¹å™¨è®¿é—® localhost æˆ–è€… 127.0.0.1 åŠ ç«¯å£ä¹Ÿå¯ä»¥è®¿é—®åˆ°\npause å®¹å™¨ä¸»è¦ä¸ºæ¯ä¸ªä¸šåŠ¡å®¹å™¨æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š\nPID å‘½åç©ºé—´ï¼šPod ä¸­çš„ä¸åŒåº”ç”¨ç¨‹åºå¯ä»¥çœ‹åˆ°å…¶ä»–åº”ç”¨ç¨‹åºçš„è¿›ç¨‹ IDã€‚ ç½‘ç»œå‘½åç©ºé—´ï¼šPod ä¸­çš„å¤šä¸ªå®¹å™¨èƒ½å¤Ÿè®¿é—®åŒä¸€ä¸ª IP å’Œç«¯å£èŒƒå›´ã€‚ IPC å‘½åç©ºé—´ï¼šPod ä¸­çš„å¤šä¸ªå®¹å™¨èƒ½å¤Ÿä½¿ç”¨ SystemV IPC æˆ– POSIX æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œé€šä¿¡ã€‚ UTS å‘½åç©ºé—´ï¼šPod ä¸­çš„å¤šä¸ªå®¹å™¨å…±äº«ä¸€ä¸ªä¸»æœºåï¼›Volumesï¼ˆå…±äº«å­˜å‚¨å·ï¼‰ã€‚ Init containerï¼š\nåŸºæœ¬æ”¯æŒæ‰€æœ‰æ™®é€šå®¹å™¨ç‰¹å¾ ä¼˜å…ˆæ™®é€šå®¹å™¨æ‰§è¡Œ åº”ç”¨åœºæ™¯ï¼š\næ§åˆ¶æ™®é€šå®¹å™¨å¯åŠ¨ï¼Œåˆå§‹å®¹å™¨å®Œæˆåæ‰ä¼šå¯åŠ¨ä¸šåŠ¡å®¹å™¨ åˆå§‹åŒ–é…ç½®ï¼Œä¾‹å¦‚ä¸‹è½½åº”ç”¨é…ç½®æ–‡ä»¶ã€æ³¨å†Œä¿¡æ¯ç­‰ ç¤ºä¾‹\napiVersion: v1 kind: Pod metadata: name: pod-init spec: containers: - name: nginx image: nginx ports: - containerPort: 80 volumeMounts: - name: workdir mountPath: /usr/share/nginx/html initContainers: - name: install image: busybox command: [\u0026#34;wget\u0026#34;, \u0026#34;-O\u0026#34;, \u0026#34;/work-dir/index.html\u0026#34;, \u0026#34;http://www.baidu.com/index.html\u0026#34;] volumeMounts: - name: workdir mountPath: \u0026#34;/work-dir\u0026#34; volumes: - name: workdir emptyDir: {} 3 é™æ€ pod é™æ€ Pod ç‰¹ç‚¹ï¼š\nPod ç”±ç‰¹å®šèŠ‚ç‚¹ä¸Šçš„ kubelet ç®¡ç† ä¸èƒ½ä½¿ç”¨æ§åˆ¶å™¨ Pod åç§°æ ‡è¯†å½“å‰èŠ‚ç‚¹åç§° åœ¨ kubelet é…ç½®æ–‡ä»¶å¯ç”¨é™æ€ Podï¼š\nvi /var/lib/kubelet/config.yaml ... staticPodPath: /etc/kubernetes/manifests ... å°†éƒ¨ç½²çš„ pod yaml æ”¾åˆ°è¯¥ç›®å½•ä¼šç”± kubelet è‡ªåŠ¨åˆ›å»º\n4 é‡å¯ç­–ç•¥ Pod çš„ spec ä¸­åŒ…å«ä¸€ä¸ª restartPolicy å­—æ®µï¼Œå…¶å¯èƒ½å–å€¼åŒ…æ‹¬ Alwaysã€OnFailure å’Œ Neverã€‚é»˜è®¤å€¼æ˜¯ Alwaysã€‚\nrestartPolicy é€‚ç”¨äº Pod ä¸­çš„æ‰€æœ‰å®¹å™¨ã€‚\nAlwaysï¼šå½“å®¹å™¨ç»ˆæ­¢é€€å‡ºåï¼Œæ€»æ˜¯é‡å¯å®¹å™¨ï¼Œé»˜è®¤ç­–ç•¥ã€‚ OnFailureï¼šå½“å®¹å™¨å¼‚å¸¸é€€å‡ºï¼ˆé€€å‡ºçŠ¶æ€ç é 0ï¼‰æ—¶ï¼Œæ‰é‡å¯å®¹å™¨ã€‚ Neverï¼šå½“å®¹å™¨ç»ˆæ­¢é€€å‡ºï¼Œä»ä¸é‡å¯å®¹å™¨ã€‚ 5 å¥åº·æ£€æŸ¥ 5.1 ä¸‰ç§æ¢é’ˆ kubernetes åŒ…å«ä»¥ä¸‹ä¸‰ç§æ¢é’ˆ\nlivenessProbe(å­˜æ´»æ¢é’ˆ): å¦‚æœæ£€æŸ¥å¤±è´¥, æ ¹æ® Pod çš„ restartPolicy æ¥å†³å®šæ˜¯å¦é‡å¯ container. readinessProbe(å°±ç»ªæ¢é’ˆ): å¦‚æœæ£€æŸ¥å¤±è´¥, ä¼šæŠŠ Pod æš‚æ—¶ä» service endpoints ä¸­å‰”é™¤. startupProbe(å¯åŠ¨æ¢é’ˆ): å¦‚æœæ£€æŸ¥å¤±è´¥, æ ¹æ® Pod çš„ restartPolicy æ¥å†³å®šæ˜¯å¦é‡å¯ container. ç”¨äºå¯åŠ¨éå¸¸æ…¢çš„åº”ç”¨. éœ€è¦æ³¨æ„çš„æ˜¯, å¦‚æœå®¹å™¨æœªé…ç½®ä»¥ä¸Šä¸‰ç§æ¢é’ˆ, åˆ™è§†ä¸ºä¸‰ç§æ¢é’ˆçš†ä¸ºæˆåŠŸ, liveness å’Œ readiness æ¢é’ˆçš„ initialDelaySeconds é…ç½®ä»£è¡¨ startup æ¢é’ˆæˆåŠŸåç­‰å¾…å¤šå°‘ç§’å†å»åˆå§‹åŒ– liveness å’Œ readiness æ¢é’ˆ.\n5.1.1 æ£€æŸ¥æ–¹æ³• æ”¯æŒä»¥ä¸‹å››ç§æ£€æŸ¥æ–¹æ³•ï¼š\nhttpGetï¼šå¯¹å®¹å™¨çš„ IP åœ°å€ä¸ŠæŒ‡å®šç«¯å£å’Œè·¯å¾„æ‰§è¡Œ HTTP GET è¯·æ±‚ã€‚å¦‚æœå“åº”çš„çŠ¶æ€ç å¤§äºç­‰äº 200 ä¸”å°äº 400ï¼Œåˆ™è¯Šæ–­è¢«è®¤ä¸ºæ˜¯æˆåŠŸçš„ã€‚ execï¼šåœ¨å®¹å™¨å†…æ‰§è¡ŒæŒ‡å®šå‘½ä»¤ã€‚å¦‚æœå‘½ä»¤é€€å‡ºæ—¶è¿”å›ç ä¸º 0 åˆ™è®¤ä¸ºè¯Šæ–­æˆåŠŸã€‚ tcpSocketï¼šå¯¹å®¹å™¨çš„ IP åœ°å€ä¸Šçš„æŒ‡å®šç«¯å£æ‰§è¡Œ TCP æ£€æŸ¥ã€‚å¦‚æœç«¯å£æ‰“å¼€ï¼Œåˆ™è¯Šæ–­è¢«è®¤ä¸ºæ˜¯æˆåŠŸçš„ã€‚ å¦‚æœè¿œç¨‹ç³»ç»Ÿï¼ˆå®¹å™¨ï¼‰åœ¨æ‰“å¼€è¿æ¥åç«‹å³å°†å…¶å…³é—­ï¼Œè¿™ç®—ä½œæ˜¯å¥åº·çš„ã€‚ gRPCï¼šä½¿ç”¨ gRPC æ‰§è¡Œä¸€ä¸ªè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ã€‚éœ€è¦åº”ç”¨ç¨‹åºæ”¯æŒï¼Œå‚è€ƒ 5.1.2 æ£€æŸ¥ç»“æœ Success(æˆåŠŸ) Failure(å¤±è´¥) Unknown(æœªçŸ¥): ä¸ä¼šæ‰§è¡Œä»»ä½•æ“ä½œ. 5.1.3 æ¢é’ˆé…ç½® initialDelaySeconds: å®¹å™¨å¯åŠ¨å (startup æ¢é’ˆæˆåŠŸ) è¦ç­‰å¾…å¤šå°‘ç§’åå­˜æ´»å’Œå°±ç»ªæ¢æµ‹å™¨æ‰è¢«åˆå§‹åŒ–, é»˜è®¤æ˜¯ 0 ç§’, æœ€å°å€¼æ˜¯ 0. periodSeconds: æ‰§è¡Œæ¢æµ‹çš„æ—¶é—´é—´éš”.é»˜è®¤æ˜¯ 10 ç§’, æœ€å°å€¼æ˜¯ 1. timeoutSeconds: æ¢æµ‹çš„è¶…æ—¶åç­‰å¾…å¤šå°‘ç§’. é»˜è®¤å€¼æ˜¯ 1 ç§’. æœ€å°å€¼æ˜¯ 1. successThreshold: æ¢æµ‹å™¨åœ¨å¤±è´¥å, è¢«è§†ä¸ºæˆåŠŸçš„æœ€å°è¿ç»­æˆåŠŸæ•°. é»˜è®¤å€¼æ˜¯ 1. å­˜æ´»æ¢æµ‹çš„è¿™ä¸ªå€¼å¿…é¡»æ˜¯ 1ã€‚æœ€å°å€¼æ˜¯ 1. failureThreshold: å½“ Pod å¯åŠ¨äº†å¹¶ä¸”æ¢æµ‹åˆ°å¤±è´¥çš„é‡è¯•æ¬¡æ•°. å­˜æ´»æ¢æµ‹æƒ…å†µä¸‹çš„æ”¾å¼ƒå°±æ„å‘³ç€é‡æ–°å¯åŠ¨å®¹å™¨. å°±ç»ªæ¢æµ‹æƒ…å†µä¸‹çš„æ”¾å¼ƒ Pod ä¼šè¢«æ‰“ä¸Šæœªå°±ç»ªçš„æ ‡ç­¾, é»˜è®¤å€¼æ˜¯ 3, æœ€å°å€¼æ˜¯ 1. 5.2 ç¤ºä¾‹ 5.2.1 liveness linveness å®é™…è§¦å‘é‡å¯éœ€è¦çš„æ—¶é—´ = å¤±è´¥æ¬¡æ•° * é—´éš”æ—¶é—´ + ç­‰å¾…å®¹å™¨ä¼˜é›…é€€å‡ºçš„å®½é™æœŸ (é»˜è®¤ 30sï¼Œdocker é»˜è®¤æ˜¯ 10s)\nfailureThreshold * periodSeconds + terminationGracePeriodSeconds\nlivenessProbe ç¤ºä¾‹\napiVersion: v1 kind: Pod metadata: name: pod-livenessprobe namespace: default spec: restartPolicy: OnFailure terminationGracePeriodSeconds: 10 containers: - name: liveness image: busybox imagePullPolicy: IfNotPresent command: [\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;touch /tmp/healthy; sleep 10; rm -rf /tmp/healthy; sleep 600\u0026#34;] livenessProbe: exec: command: [\u0026#34;test\u0026#34;, \u0026#34;-e\u0026#34;, \u0026#34;/tmp/healthy\u0026#34;] initialDelaySeconds: 5 periodSeconds: 5 failureThreshold: 2 è¿è¡Œç»“æœå¯ä»¥çœ‹åˆ°åœ¨ä¸¤åˆ†é’Ÿçš„æ—¶é—´é‡Œé‡å¯äº† 4 æ¬¡ï¼Œæ¯æ¬¡ 30s\n[root@k8s-node1 opt]# kubectl get pods NAME READY STATUS RESTARTS AGE liveness-pod 1/1 Running 4 (2s ago) 2m2s POD è¿è¡Œçš„å‰ 10s æ£€æŸ¥ä¸€ç›´æˆåŠŸ åœ¨ POD å¯åŠ¨çš„ç¬¬ 15s ç¬¬ä¸€æ¬¡æ£€æŸ¥å¤±è´¥ ç¬¬ 20s ç¬¬äºŒæ¬¡æ£€æŸ¥å¤±è´¥ï¼Œç»™å®¹å™¨å‘é€åœæ­¢ä¿¡å· ç­‰å¾… 10s åå¼ºåˆ¶é‡å¯å®¹å™¨ 5.2.2 liveness-with-startup ç¤ºä¾‹:\napiVersion: v1 kind: Pod metadata: name: pod-probes namespace: default spec: terminationGracePeriodSeconds: 10 containers: - name: liveness-with-startup image: busybox imagePullPolicy: IfNotPresent command: [\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;sleep 5; touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600\u0026#34;] startupProbe: exec: command: [\u0026#34;test\u0026#34;, \u0026#34;-e\u0026#34;, \u0026#34;/tmp/healthy\u0026#34;] periodSeconds: 5 failureThreshold: 10 livenessProbe: exec: command: [\u0026#34;test\u0026#34;, \u0026#34;-e\u0026#34;, \u0026#34;/tmp/healthy\u0026#34;] initialDelaySeconds: 15 periodSeconds: 5 failureThreshold: 3 é‡å¯è¿‡ç¨‹:\nPOD å¯åŠ¨æˆåŠŸ,è§¦å‘ startup æ¢é’ˆ ç¬¬ 10 ç§’ startup æ¢é’ˆæˆåŠŸ ç¬¬ 25 ç§’ååˆå§‹åŒ– liveness æ¢é’ˆ ç¬¬ 40 ç§’ liveness æ¢é’ˆç¬¬ä¸€æ¬¡å¤±è´¥ ç¬¬ 50 ç§’ liveness æ¢é’ˆç¬¬ä¸‰æ¬¡å¤±è´¥, è§¦å‘é‡å¯, ç­‰å¾…å®¹å™¨ä¼˜é›…é€€å‡º ç¬¬ 60 ç§’å¼ºåˆ¶é‡å¯ container 6 lifecycle 6.1 postStart å’Œ preStop å¦‚ä¸‹ç¤ºä¾‹\napiVersion: v1 kind: Pod metadata: name: lifecycle-demo-pod namespace: default labels: test: lifecycle spec: containers: - name: lifecycle-demo image: nginx:1.22.1 imagePullPolicy: IfNotPresent lifecycle: postStart: exec: command: [\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;echo \u0026#39;Hello from the postStart handler\u0026#39; \u0026gt;\u0026gt; /var/log/nginx/message\u0026#34;] preStop: exec: command: [\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;echo \u0026#39;Hello from the preStop handler\u0026#39; \u0026gt;\u0026gt; /var/log/nginx/message\u0026#34;] volumeMounts: - name: message-log mountPath: /var/log/nginx/ readOnly: false # è¯»å†™æŒ‚è½½æ–¹å¼ï¼Œé»˜è®¤ä¸ºè¯»å†™æ¨¡å¼false initContainers: - name: init-myservice image: busybox:1.28 command: [\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;echo \u0026#39;Hello initContainers\u0026#39; \u0026gt;\u0026gt; /var/log/nginx/message\u0026#34;] volumeMounts: - name: message-log mountPath: /var/log/nginx/ readOnly: false # è¯»å†™æŒ‚è½½æ–¹å¼ï¼Œé»˜è®¤ä¸ºè¯»å†™æ¨¡å¼false volumes: - name: message-log hostPath: path: /data/volumes/nginx/log/ type: DirectoryOrCreate # è¡¨ç¤ºå¦‚æœå®¿ä¸»æœºæ²¡æœ‰æ­¤ç›®å½•åˆ™ä¼šè‡ªåŠ¨åˆ›å»º æ•ˆæœå¦‚ä¸‹\n[root@k8s-node1 ~]# kubectl delete pod lifecycle-demo-pod [root@k8s-node2 log]# cat message Hello initContainers Hello from the postStart handler Hello from the preStop handler ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-pod/","summary":"0 å‰è¨€ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0 1 ç®€ä»‹ åŸºæœ¬æ¦‚å¿µ æœ€å°éƒ¨ç½²å•å…ƒ ä¸€ç»„å®¹å™¨çš„é›†åˆ ä¸€ä¸ª Pod ä¸­çš„å®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´ Pod æ˜¯çŸ­æš‚çš„ å­˜åœ¨æ„ä¹‰ Pod ä¸ºäº²å¯†æ€§åº”ç”¨è€Œå­˜åœ¨ã€‚ äº²å¯†æ€§åº”ç”¨åœºæ™¯ï¼š ä¸¤ä¸ªåº”ç”¨ä¹‹é—´å‘ç”Ÿæ–‡ä»¶äº¤äº’ ä¸¤ä¸ªåº”ç”¨éœ€è¦é€šè¿‡ 127.0.0.1 æˆ–è€… socket é€šä¿¡ï¼ˆ","title":"kubernetes | pod"},{"content":"1 kubectl å‘½ä»¤çš„è‡ªåŠ¨è¡¥å…¨ yum install bash-completion source /usr/share/bash-completion/bash_completion source \u0026lt;(kubectl completion bash) 2 é•œåƒæ‹‰å–ç­–ç•¥ imagePullPolicy: Always|Never|IfNotPresent 3 ä¿®æ”¹ nodePort èŒƒå›´ vim /etc/kubernetes/manifests/kube-apiserver.yaml # spec.containers.command å¢åŠ  - --service-node-port-range=1-65535 3 command å’Œ args containers.command ç­‰åŒäº Dockerfile ä¸­çš„ ENTRYPOINT\ncontainers.args ç­‰åŒäº Dockerfile ä¸­çš„ CMD\nå¦‚æœ Dockerfile ä¸­é»˜è®¤çš„ ENTRYPOINT è¢«è¦†ç›–ï¼Œåˆ™é»˜è®¤çš„ CMD æŒ‡ä»¤åŒæ—¶ä¹Ÿä¼šè¢«è¦†ç›–\n4 label æ ‡ç­¾é€‰æ‹©è¿ç®—ç¬¦ å®˜æ–¹æ–‡æ¡£\nåŸºäºç­‰å€¼, æœ‰ä¸‰ç§è¿ç®—ç¬¦ = == !=\nå‰ä¸¤ç§æ˜¯ç­‰æ•ˆçš„ï¼Œç¤ºä¾‹\n[root@k8s-node1 ~]# kubectl get nodes -l kubernetes.io/hostname=k8s-node1 NAME STATUS ROLES AGE VERSION k8s-node1 Ready control-plane,master 21d v1.22.3 [root@k8s-node1 ~]# kubectl get nodes -l kubernetes.io/hostname!=k8s-node1 NAME STATUS ROLES AGE VERSION k8s-node2 Ready \u0026lt;none\u0026gt; 21d v1.22.3 k8s-node3 Ready \u0026lt;none\u0026gt; 21d v1.22.3 åŸºäºé›†åˆ, åŒæ ·ä¸‰ç§è¿ç®—ç¬¦ in notin exists\nexists åªç”¨äºåˆ¤æ–­ key æ˜¯å¦å­˜åœ¨\nhello in (foo, bar) # æ‰€æœ‰åŒ…å«äº† hello æ ‡ç­¾ä¸”å€¼ç­‰äº foo æˆ–è€… bar çš„èµ„æº hello notin (foo, bar) # æ‰€æœ‰åŒ…å«äº† hello æ ‡ç­¾ä¸”å€¼ä¸ç­‰äº foo æˆ–è€… bar çš„èµ„æºï¼›ä»¥åŠæ²¡æœ‰ hello æ ‡ç­¾çš„èµ„æº hello # æ‰€æœ‰åŒ…å«äº† hello æ ‡ç­¾çš„èµ„æºï¼›ä¸æ ¡éªŒå€¼ !hello # æ‰€æœ‰æœªåŒ…å« hello æ ‡ç­¾çš„èµ„æºï¼›ä¸æ ¡éªŒå€¼ ç¤ºä¾‹\n[root@k8s-node1 ~]# kubectl get nodes -l \u0026#34;kubernetes.io/hostname in (k8s-node1, k8s-node2)\u0026#34; NAME STATUS ROLES AGE VERSION k8s-node1 Ready control-plane,master 21d v1.22.3 k8s-node2 Ready \u0026lt;none\u0026gt; 21d v1.22.3 [root@k8s-node1 ~]# kubectl get nodes -l \u0026#34;kubernetes.io/hostname notin (k8s-node1, k8s-node2)\u0026#34; NAME STATUS ROLES AGE VERSION k8s-node3 Ready \u0026lt;none\u0026gt; 21d v1.22.3 [root@k8s-node1 ~]# kubectl get nodes -l kubernetes.io/hostname NAME STATUS ROLES AGE VERSION k8s-node1 Ready control-plane,master 21d v1.22.3 k8s-node2 Ready \u0026lt;none\u0026gt; 21d v1.22.3 k8s-node3 Ready \u0026lt;none\u0026gt; 21d v1.22.3 [root@k8s-node1 ~]# kubectl get nodes -l \\!kubernetes.io/hostname No resources found 5 å¸¸è§æŠ¥é”™ 5.1 NodeNotReady 5.1.1 Image garbage collection failed once å‚è€ƒåœ°å€\næŠ¥é”™ï¼š\n# kubectl describe node k8s-node01 Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Starting 11m kubelet Starting kubelet. Normal NodeHasSufficientMemory 11m kubelet Node k8s-node01 status is now: NodeHasSufficientMemory Normal NodeHasNoDiskPressure 11m kubelet Node k8s-node01 status is now: NodeHasNoDiskPressure Normal NodeHasSufficientPID 11m kubelet Node k8s-node01 status is now: NodeHasSufficientPID Normal NodeAllocatableEnforced 11m kubelet Updated Node Allocatable limit across pods # journalctl -u kubelet | grep garbage Mar 06 09:50:33 k8s-node01 kubelet[45471]: E0306 09:50:33.106476 45471 kubelet.go:1343] \u0026#34;Image garbage collection failed once. Stats initialization may not have completed yet\u0026#34; err=\u0026#34;failed to get imageFs info: unable to find data in memory cache\u0026#34; è§£å†³ï¼š\næœªéƒ¨ç½² CNI ç»„ä»¶\ndocker é•œåƒæˆ–å®¹å™¨æœªèƒ½æ­£ç¡®åˆ é™¤å¯¼è‡´çš„\ndocker system prune systemctl stop kubelet systemctl stop docker systemctl start docker systemctl start kubelet 5.2 node æ— æ³• ping é€š pod æ‰€æœ‰ calico çš„ pod è¿è¡Œéƒ½æ˜¯ running çŠ¶æ€, ä½¿ç”¨ calicoctl node status çœ‹åˆ°çš„ç½‘å¡ç»‘å®šä¹Ÿæ˜¯æ²¡é—®é¢˜çš„.\ncalico çš„ pod æœ‰å¦‚ä¸‹æŠ¥é”™\n[root@k8s-node1 ~]# kubectl logs calico-node-l66pn -n kube-system 2023-04-08 04:28:47.660 [INFO][65] felix/int_dataplane.go 1600: Received interface update msg=\u0026amp;intdataplane.ifaceUpdate{Name:\u0026#34;tunl0\u0026#34;, State:\u0026#34;down\u0026#34;, Index:4} bird: Netlink: Network is down bird: Netlink: Network is down bird: Netlink: Network is down bird: Netlink: Network is down æˆ‘è¿™é‡Œæ˜¯é€šè¿‡å…³é—­ NetworkManager è§£å†³çš„.å…³é—­å pod æ—¥å¿—ç«‹å³å°±æ¢å¤æ­£å¸¸äº†\n[root@k8s-node1 ~]# systemctl stop NetworkManager [root@k8s-node1 ~]# systemctl disable NetworkManager 5.3 è™šæ‹ŸæœºæŒ‚èµ·å¯¼è‡´ calico ç½‘ç»œä¸å¯ç”¨ å‡ºç°åœ¨æˆ‘çš„è™šæ‹Ÿæœºæµ‹è¯•é›†ç¾¤ä¸Šï¼ŒæŒ‚èµ·è™šæ‹Ÿæœºè¿‡æ®µæ—¶é—´åé‡æ–°å¯åŠ¨è™šæ‹Ÿæœºï¼Œå‘ç°é›†ç¾¤çŠ¶æ€æ˜¯æ­£å¸¸çš„ (node æ˜¯ ready çŠ¶æ€)ï¼Œç„¶è€Œ calico-kube-controllers metric-server nfs-provisiner ç­‰åŠŸèƒ½ç»„ä»¶é™·å…¥äº† CrashLoopBackOff çŠ¶æ€ï¼ŒæŠ¥é”™åŸºæœ¬ä¸Šéƒ½æ˜¯æ— æ³•è¿æ¥åˆ° api-server\nä½†æ˜¯ calicoctl çœ‹åˆ° calico é›†ç¾¤æ˜¯æ²¡ä»€ä¹ˆé—®é¢˜çš„ï¼Œä¹‹å‰é‡åˆ°å‡ æ¬¡éƒ½æ˜¯æš´èºé‡å¯ docker è§£å†³çš„ï¼Œåé¢å‘ç°é‡å¯ calico ç›¸å…³å®¹å™¨å°±å¯ä»¥äº†ï¼Œå…·ä½“åŸå› è¿˜æ²¡æ‰¾åˆ°ï¼Œä¼°è®¡ä¸ vmware è™šæ‹ŸæœºæŒ‚èµ·æ“ä½œæœ‰å…³ã€‚\nkubectl delete pods -n kube-system -l \u0026#34;k8s-app in (calico-node, calico-kube-controllers)\u0026#34; 6 kubectl å‘½ä»¤ ä¸€äº›å¸¸ç”¨å‘½ä»¤\n# æŸ¥çœ‹æŸä¸ªèµ„æºçš„è¯¦ç»†ä¿¡æ¯ kubectl describe \u0026lt;type\u0026gt; \u0026lt;name\u0026gt; -n \u0026lt;namespace\u0026gt; # æŸ¥çœ‹podçš„æ—¥å¿— kubectl logs \u0026lt;pod\u0026gt; -n \u0026lt;namespace\u0026gt; # æŸ¥çœ‹å½“å‰æ”¯æŒçš„apiç‰ˆæœ¬ kubectl api-versions 6.1 get options:\n-w/--watch: # å®æ—¶æ›´æ–°ï¼Œç±»ä¼¼tailçš„-fé€‰é¡¹ -o wide: # æŸ¥çœ‹æ›´ä¸ºè¯¦ç»†çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ipå’Œåˆ†é…çš„èŠ‚ç‚¹ -o json: # ä»¥jsonæ ¼å¼è¾“å‡º -o jsonpath=\u0026#39;{}\u0026#39; # è¾“å‡ºæŒ‡å®šçš„jsonå†…å®¹ -l key=vaule # æ ¹æ®lableç­›é€‰ --show-lables # æ˜¾ç¤ºèµ„æºçš„æ‰€æœ‰label ç¤ºä¾‹:\n# æŸ¥çœ‹æ‰€æœ‰æ”¯æŒçš„èµ„æº kubectl api-resources # æŸ¥çœ‹serviceæ˜ å°„çš„podçš„ç«¯å£å’Œip kubectl get cp/endpoints # æŸ¥çœ‹pod kubectl get pod \u0026lt;podname\u0026gt; -n \u0026lt;namespace\u0026gt; -o jsonpath=\u0026#39;{.metadata.uid}\u0026#39; # æŸ¥çœ‹podçš„id # æŸ¥çœ‹æŒ‡å®špodçš„äº‹ä»¶ kubectl get events --field-selector involvedObject.name=demo-probes 6.1.1 è·å–æ‰€æœ‰ pod çš„ cpu request å¹¶æ’åº kubectl get pods --all-namespaces -o jsonpath=\u0026#39;{range .items[*]}{.metadata.namespace}{\u0026#34;\\t\u0026#34;}{.metadata.name}{\u0026#34;\\t\u0026#34;}{.spec.containers[*].resources.requests.cpu}{\u0026#34;\\n\u0026#34;}{end}\u0026#39; | awk -F\u0026#39;\\t\u0026#39; \u0026#39;{ sum = 0 split($3, containers, \u0026#34;,\u0026#34;) for (i in containers) { val = containers[i] if (val ~ /m/) { sum += val + 0 } else { sum += val * 1000 } } print $1 \u0026#34;\\t\u0026#34; $2 \u0026#34;\\t\u0026#34; sum }\u0026#39; | sort -k3 -nr | head -n 20 6.2 create kubectl create \u0026lt;resource\u0026gt; [Options] --dry-run=client: ä»…å°è¯•è¿è¡Œï¼Œä¸å®é™…è¿è¡Œ -o, --output=\u0026#39;\u0026#39;: è¾“å‡ºä¸ºæŒ‡å®šçš„æ ¼å¼ å¿«é€Ÿåˆ›å»ºä¸€ç³»åˆ—èµ„æº\n[root@k8s-node1 ~]# kubectl create namespace test namespace/test created [root@k8s-node1 ~]# kubectl create deployment my-dep --image=nginx:1.22. --replicas=3 -n test deployment.apps/my-dep created [root@k8s-node1 ~]# kubectl expose deployment my-dep --port=80 --target-port=8080 --type=NodePort -n test service/my-dep exposed [root@k8s-node1 ~]# kubectl get pods,deployment,svc -n test NAME READY STATUS RESTARTS AGE pod/my-dep-5f8dfc8c78-7w5nz 1/1 Running 0 41s pod/my-dep-5f8dfc8c78-gt65r 1/1 Running 0 41s pod/my-dep-5f8dfc8c78-n4vjd 1/1 Running 0 41s NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/my-dep 3/3 3 3 41s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/my-dep NodePort 10.110.205.138 \u0026lt;none\u0026gt; 80:31890/TCP 17s 6.3 expose kubectl expose deployment my-dep --port=80 --target-port=8080 --type=NodePort -n test # --port è¡¨ç¤ºserviceæš´éœ²çš„ç«¯å£ # --target-port è¡¨ç¤ºåç«¯é•œåƒå®é™…æä¾›æœåŠ¡çš„ç«¯å£ 6.4 label kubectl label nodes [node] key=value # æ‰“lable, valueå¯ä»¥æ˜¯ç©º kubectl label nodes [node] key- # åˆ é™¤label kubectl get nodes -l key=value # æ ¹æ®labelç­›é€‰ kubectl get nodes --show-labesl # æ˜¾ç¤ºèµ„æºçš„æ‰€æœ‰æ ‡ç­¾ 6.5 run kubectl run -it test --image busybox --rm -- ping 10.244.107.207 7 calicoctl ä¸‹è½½åœ°å€\n# æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯ DATASTORE_TYPE=kubernetes KUBECONFIG=~/.kube/config calicoctl get nodes # ä½¿ç”¨é…ç½®æ–‡ä»¶çš„æ–¹å¼ [root@k8s-node1 ~]# mkdir /etc/calico [root@k8s-node1 ~]# cat \u0026gt; /etc/calico/calicoctl.cfg \u0026lt;\u0026lt;EOF \u0026gt; apiVersion: projectcalico.org/v3 \u0026gt; kind: CalicoAPIConfig \u0026gt; metadata: \u0026gt; spec: \u0026gt; datastoreType: \u0026#34;kubernetes\u0026#34; \u0026gt; kubeconfig: \u0026#34;/root/.kube/config\u0026#34; \u0026gt; EOF # æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯ [root@k8s-node1 ~]# calicoctl --allow-version-mismatch get nodes NAME k8s-node1 k8s-node2 k8s-node3 [root@k8s-node1 ~]# calicoctl --allow-version-mismatch node status IPv4 BGP status +--------------+-------------------+-------+----------+-------------+ | PEER ADDRESS | PEER TYPE | STATE | SINCE | INFO | +--------------+-------------------+-------+----------+-------------+ | 1.1.1.2 | node-to-node mesh | up | 03:53:45 | Established | | 1.1.1.3 | node-to-node mesh | up | 03:53:51 | Established | +--------------+-------------------+-------+----------+-------------+ 8 namespace k8s ä¸ docker çš„ namespace ä¸åŒ\ndocker ä¸­çš„ namespace ç”¨äºå®¹å™¨é—´çš„èµ„æºéš”ç¦»\nk8s ä¸­çš„ namespace ç”¨äº\nk8s çš„æŠ½è±¡èµ„æºé—´çš„èµ„æºéš”ç¦»ï¼Œæ¯”å¦‚ podsã€æ§åˆ¶å™¨ã€service ç­‰ èµ„æºéš”ç¦»åï¼Œå¯¹è¿™ä¸€ç»„èµ„æºè¿›è¡Œæƒé™æ§åˆ¶ 9 yaml ç¼–å†™ é€šè¿‡åˆ›å»ºèµ„æºè·å– yaml\nkubectl create deployment web --image=nginx:1.19 --dry-run=client -o yaml \u0026gt; deploy.yaml é€šè¿‡å·²æœ‰èµ„æºè·å– yaml\nkubectl get deployment nginx-deployment -o yaml \u0026gt; deploy2.yaml æŸ¥çœ‹ api ä¸­çš„èµ„æºåŠè§£é‡Š\nkubectl explain pods.spec.container kubectl explain deployment yaml æŠ¥é”™æ’æŸ¥\nerror: error parsing pod-configmap.yaml: error converting YAML to JSON: yaml: line 19: did not find expected \u0026#39;-\u0026#39; indicator è§£å†³\nç”±äº yaml æ–‡ä»¶åˆ—è¡¨å¯¹é½ä¸ç»Ÿä¸€å¯¼è‡´çš„\nyaml æ–‡ä»¶æ ¼å¼è¦å¯¹é½ï¼ŒåŒä¸€çº§åˆ«çš„å¯¹è±¡è¦æ”¾åœ¨åŒä¸€åˆ—ï¼Œå‡ ä¸ªç©ºæ ¼ä¸é‡è¦ï¼Œä¸è¦ç”¨ tab åˆ¶è¡¨ç¬¦\n# æ ¼å¼1 ports: - port: 80 # æ ¼å¼2 ports: - port: 80 ä»¥ä¸Š.\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-notes/","summary":"1 kubectl å‘½ä»¤çš„è‡ªåŠ¨è¡¥å…¨ yum install bash-completion source /usr/share/bash-completion/bash_completion source \u0026lt;(kubectl completion bash) 2 é•œåƒæ‹‰å–ç­–ç•¥ imagePullPolicy: Always|Never|IfNotPresent 3 ä¿®æ”¹ nodePort èŒƒå›´ vim /etc/kubernetes/manifests/kube-apiserver.yaml # spec.containers.command å¢åŠ  - --service-node-port-range=1-65535 3 command å’Œ args containers.command ç­‰åŒäº Dockerfile ä¸­çš„ ENTRYPOINT containers.args ç­‰åŒäº Dockerfile ä¸­çš„ CMD å¦‚æœ Dockerfile ä¸­é»˜è®¤çš„ ENTRYPOINT è¢«è¦†ç›–ï¼Œåˆ™é»˜è®¤çš„ CMD æŒ‡ä»¤åŒæ—¶ä¹Ÿä¼šè¢«è¦†ç›– 4 label æ ‡ç­¾é€‰æ‹©è¿ç®—ç¬¦ å®˜æ–¹æ–‡æ¡£ åŸºäºç­‰å€¼, æœ‰ä¸‰ç§è¿ç®—ç¬¦ = == != å‰ä¸¤ç§æ˜¯ç­‰æ•ˆçš„ï¼Œç¤ºä¾‹ [root@k8s-node1 ~]# kubectl get nodes -l kubernetes.io/hostname=k8s-node1 NAME STATUS ROLES AGE VERSION k8s-node1 Ready control-plane,master 21d","title":"kubernetes | æ‚è®°"},{"content":"Bash æœ‰ä¸€ä¸ªå†…ç½®çš„ set å‘½ä»¤ï¼Œå¯ä»¥ç”¨æ¥æŸ¥çœ‹ã€è®¾ç½®ã€å–æ¶ˆ shell é€‰é¡¹\nset è®¾ç½®çš„é€‰é¡¹æ— æ³•è¢«ç»§æ‰¿ï¼Œä»…å¯¹å½“å‰çš„ bash ç¯å¢ƒæœ‰æ•ˆï¼Œbash å‘½ä»¤ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ set çš„å•å­—ç¬¦é€‰é¡¹æ¥å¼€å¯ä¸€ä¸ªè‡ªå®šä¹‰å‚æ•°çš„å­ bash ç¯å¢ƒï¼Œæ¯”å¦‚æ‰§è¡Œçš„è„šæœ¬\næŸ¥çœ‹ï¼š echo $- å’Œ set -o å’Œ echo ${SHELLOPTS} è®¾ç½®ï¼š set -abefhkmnptuvxBCHP å’Œ set -o options-name å–æ¶ˆï¼š set +abefhkmnptuvxBCHP å’Œ set +o options-name set - å’Œ set + è®¾ç½®å•å­—ç¬¦é€‰é¡¹ï¼Œä½¿ç”¨ echo $- æŸ¥çœ‹å½“å‰ shellå¼€å¯çš„å•å­—ç¬¦é€‰é¡¹\nset -o å’Œ set +o è®¾ç½®å¤šå­—ç¬¦é€‰é¡¹ï¼Œä½¿ç”¨ set -o æŸ¥çœ‹å½“å‰ shell æ‰€æœ‰çš„å¤šå­—ç¬¦é€‰é¡¹çš„çŠ¶æ€ (å¼€å¯æˆ–å…³é—­)\nä½¿ç”¨ echo ${SHELLOPTS} æŸ¥çœ‹å½“å‰ shell å¼€å¯çš„é•¿æ ¼å¼é€‰é¡¹\næ‰€æœ‰çš„çŸ­æ ¼å¼é€‰é¡¹éƒ½å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„é•¿æ ¼å¼é€‰é¡¹ï¼Œé•¿æ ¼å¼é€‰é¡¹å¤šäº† emacsã€historyã€ignoreeofã€nologã€pipefailã€posixã€viã€‚è¯¦è§ set å‘½ä»¤çš„ man æ‰‹å†Œ\nä¾‹å¦‚ set -B å’Œ set -o braceexpand æ˜¯ç­‰æ•ˆçš„ï¼Œæ³¨æ„è¿™é‡Œçš„è®¾ç½®å’Œå–æ¶ˆæœ‰ç‚¹åå¸¸è¯†ï¼šè®¾ç½®ç”¨ -ï¼Œå…³é—­åè€Œæ˜¯ç”¨ +\n[root@lvbibir ~]# echo $- himBH # set + æ–¹å¼å»é™¤Bé€‰é¡¹ï¼Œç›¸åº”çš„ set -o ä¸­çš„ braceexpand é€‰é¡¹ä¹Ÿå…³é—­äº† [root@lvbibir ~]# set +B [root@lvbibir ~]# echo $- himH [root@lvbibir ~]# set -o | grep braceexpand braceexpand off # set -o å¼€å¯ braceexpand é€‰é¡¹ï¼Œç›¸åº”çš„ echo $- ä¸­çš„ B é€‰é¡¹ä¹Ÿå¼€å¯äº† [root@lvbibir ~]# set -o braceexpand [root@lvbibir ~]# echo $- himBH [root@lvbibir ~]# set -o | grep braceexpand braceexpand on ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/linux-command-set/","summary":"Bash æœ‰ä¸€ä¸ªå†…ç½®çš„ set å‘½ä»¤ï¼Œå¯ä»¥ç”¨æ¥æŸ¥çœ‹ã€è®¾ç½®ã€å–æ¶ˆ shell é€‰é¡¹ set è®¾ç½®çš„é€‰é¡¹æ— æ³•è¢«ç»§æ‰¿ï¼Œä»…å¯¹å½“å‰çš„ bash ç¯å¢ƒæœ‰æ•ˆï¼Œbash å‘½ä»¤ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ set çš„å•å­—ç¬¦é€‰é¡¹æ¥å¼€å¯ä¸€ä¸ªè‡ªå®šä¹‰å‚æ•°çš„å­ bash ç¯å¢ƒï¼Œæ¯”å¦‚æ‰§è¡Œçš„è„šæœ¬ æŸ¥çœ‹ï¼š echo $- å’Œ set -o å’Œ echo ${SHELLOPTS} è®¾ç½®ï¼š set -abefhkmnptuvxBCHP å’Œ set -o options-name å–æ¶ˆï¼š set +abefhkmnptuvxBCHP å’Œ set +o options-name set - å’Œ set + è®¾ç½®å•å­—ç¬¦é€‰é¡¹ï¼Œä½¿ç”¨ echo $- æŸ¥çœ‹","title":"linux | set å‘½ä»¤è¯¦è§£"},{"content":"0 å‰è¨€ å®‰è£…è¿‡ç¨‹ä¸­ä¼šæ›¿æ¢ç›¸å½“ä¸€éƒ¨åˆ†ç³»ç»Ÿå†…ç½®çš„è½¯ä»¶åŒ…, ä¸å»ºè®®ç”¨äºç”Ÿäº§ç¯å¢ƒ cephadm ä¾èµ– python3.6, è€Œæ­¤ç‰ˆæœ¬çš„ openeuler å†…ç½®ç‰ˆæœ¬ä¸º 3.7, ä¸”ä¸æ”¯æŒ platform-python, å‚è€ƒ [openeuler çš„ gitee ç¤¾åŒº issue](https: \u0026lt;//gitee.com/src-openeuler/python3/issues/I4J8RK?from=project-issue\u0026gt;)\nåŸºç¡€ç¯å¢ƒ:\nceph: v16.2 (pacific) æ“ä½œç³»ç»Ÿ: openEuler-20.03-LTS-SP3 å†…æ ¸ç‰ˆæœ¬: 4.19.90-2112.8.0.0131.oe1.x86_64 é›†ç¾¤è§’è‰²:\nip ä¸»æœºå è§’è‰² 1.1.1.101 ceph-node1 cephadm, mgr, mon, osd 1.1.1.102 ceph-node2 osd, mgr, mon 1.1.1.103 ceph-node3 osd, mgr, mon 1 åŸºç¡€ç¯å¢ƒé…ç½® (æ‰€æœ‰èŠ‚ç‚¹) 1.1 é˜²ç«å¢™ systemctl stop firewalld systemctl disable firewalld 1.2 ä¿®æ”¹ä¸»æœºå hostnamectl set-hostname ceph-node1 hostnamectl set-hostname ceph-node2 hostnamectl set-hostname ceph-node3 vi /etc/hosts # æ·»åŠ  1.1.1.101 ceph-node1 1.1.1.102 ceph-node2 1.1.1.103 ceph-node3 1.3 é…ç½® yum \u0026amp; epel rpm -e openEuler-release-20.03LTS_SP3-52.oe1.x86_64 wget -O /etc/yum.repos.d/CentOS-Base.repo https: //mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo yum install epel-release rm -f /etc/yum.repos.d/CentOS-Linux-* yum-config-manager --add-repo https: //mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo 1.4 å®‰è£… python3.6 yum install python3-pip-wheel python3-setuptools-wheel wget http: //mirrors.aliyun.com/centos-vault/8.5.2111/BaseOS/x86_64/os/Packages/python3-libs-3.6.8-41.el8.x86_64.rpm wget http: //mirrors.aliyun.com/centos-vault/8.5.2111/BaseOS/x86_64/os/Packages/libffi-3.1-22.el8.x86_64.rpm rpm -ivh libffi-3.1-22.el8.x86_64.rpm --force cp /usr/lib64/libpython3.so /usr/lib64/libpython3.so-3.7.4 rpm -ivh python3-libs-3.6.8-41.el8.x86_64.rpm --force --nodeps mv /lib64/libpython3.so /lib64/python3.so-3.6.8 ln -s /usr/lib64/libpython3.so /lib64/libpython3.so yum install platform-python yum install python3-pip vi /usr/bin/yum # å°† #!/usr/bin/python3 æ”¹æˆ #!/usr/bin/python3.7 yum install python3-prettytable-0.7.2-14.el8 yum install python3-gobject-base-3.28.3-2.el8 rpm -e --nodeps firewalld-doc-0.6.6-4.oe1.noarch yum install firewalld-0.9.3-7.el8 1.5 å®‰è£… docker yum install docker-ce systemctl start docker systemctl status docker systemctl enable docker 1.6 å®‰è£… cephadm \u0026amp; ceph-common curl --silent --remote-name --location https: //github.com/ceph/ceph/raw/pacific/src/cephadm/cephadm chmod +x cephadm ./cephadm add-repo --release pacific yum install cephadm rpm -e --nodeps libicu-62.1-6.oe1.x86_64 yum install ceph-common-16.2.9-0.el8 2 ceph é›†ç¾¤é…ç½® 2.1 é›†ç¾¤åˆå§‹åŒ– cephadm bootstrap --mon-ip 1.1.1.101 å‡ºç°å¦‚ä¸‹æç¤ºè¯´æ˜å®‰è£…æˆåŠŸ\n...... Generating a dashboard self-signed certificate... Creating initial admin user... Fetching dashboard port number... Ceph Dashboard is now available at: URL: https: //ceph-node1:8443/ User: admin Password: dkk08l0czz Enabling client.admin keyring and conf on hosts with \u0026#34;admin\u0026#34; label Enabling autotune for osd_memory_target You can access the Ceph CLI as following in case of multi-cluster or non-default config: sudo /usr/sbin/cephadm shell --fsid aac4d9ba-3be0-11ed-b415-000c29211f5f -c /etc/ceph/ceph.conf -k /etc/ceph/ceph.client.admin.keyring Or, if you are only running a single cluster on this host: sudo /usr/sbin/cephadm shell Please consider enabling telemetry to help improve Ceph: ceph telemetry on For more information see: https: //docs.ceph.com/en/pacific/mgr/telemetry/ Bootstrap complete. è®¿é—®: https://1.1.1.101:8443/\nç¬¬ä¸€æ¬¡è®¿é—® dashboard éœ€è¦ä¿®æ”¹åˆå§‹è´¦å·å¯†ç \n2.2 æ·»åŠ ä¸»æœº ssh-copy-id -f -i /etc/ceph/ceph.pub root@ceph-node2 ssh-copy-id -f -i /etc/ceph/ceph.pub root@ceph-node3 ceph orch host add ceph-node2 1.1.1.102 --labels _admin ceph orch host add ceph-node3 1.1.1.103 --labels _admin 2.3 æ·»åŠ ç£ç›˜ # å•ç›˜æ·»åŠ  ceph orch daemon add osd ceph-node1:/dev/vdb # æŸ¥çœ‹æ‰€æœ‰å¯ç”¨è®¾å¤‡ ceph orch device ls # è‡ªåŠ¨æ·»åŠ æ‰€æœ‰å¯ç”¨è®¾å¤‡ ceph orch apply osd --all-available-devices ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/ceph-v16-cpehadm-openeuler/","summary":"0 å‰è¨€ å®‰è£…è¿‡ç¨‹ä¸­ä¼šæ›¿æ¢ç›¸å½“ä¸€éƒ¨åˆ†ç³»ç»Ÿå†…ç½®çš„è½¯ä»¶åŒ…, ä¸å»ºè®®ç”¨äºç”Ÿäº§ç¯å¢ƒ cephadm ä¾èµ– python3.6, è€Œæ­¤ç‰ˆæœ¬çš„ openeuler å†…ç½®ç‰ˆæœ¬ä¸º 3.7, ä¸”ä¸æ”¯æŒ platform-python, å‚è€ƒ [openeuler çš„ gitee ç¤¾åŒº issue](https: \u0026lt;//gitee.com/src-openeuler/python3/issues/I4J8RK?from=project-issue\u0026gt;) åŸºç¡€ç¯å¢ƒ: ceph: v16.2 (pacific) æ“ä½œç³»ç»Ÿ: openEuler-20.03-LTS-SP3 å†…æ ¸ç‰ˆæœ¬: 4.19.90-2112.8.0.0131.oe1.x86_64 é›†ç¾¤è§’è‰²: ip ä¸»æœºå è§’è‰² 1.1.1.101 ceph-node1 cephadm, mgr, mon, osd 1.1.1.102 ceph-node2 osd, mgr, mon 1.1.1.103 ceph-node3 osd, mgr, mon 1 åŸºç¡€ç¯å¢ƒé…ç½® (æ‰€æœ‰èŠ‚ç‚¹) 1.1 é˜²ç«å¢™ systemctl stop firewalld systemctl disable firewalld 1.2 ä¿®æ”¹ä¸»æœºå","title":"ceph | openeuler éƒ¨ç½² ceph-v16"},{"content":"0 å‰è¨€ é€‚ç”¨äº Centos8/openeuler + docker\nå®‰è£… cephadmã€ceph-common çš„è¿‡ç¨‹å°±ä¸èµ˜è¿°äº†ï¼Œä¸»è¦æ¢è®¨å¦‚ä½•å®ç° cephadm ç¦»çº¿å®‰è£… ceph v16.2.8\n1 ç¦»çº¿åŒ…çš„è·å– ç¦»çº¿åŒ…ä¸»è¦æŒ‡ rpm åŒ…å’Œ ceph çš„ docker é•œåƒ\næ‰¾ä¸€å°æœ‰å¤–ç½‘çš„æµ‹è¯•æœºï¼ˆå°½é‡è·Ÿç”Ÿäº§ç³»ç»Ÿçš„ç¯å¢ƒä¸€è‡´ï¼‰é€šè¿‡ yum å®‰è£… cephadmã€ceph-commonã€docker ç­‰éœ€è¦çš„ rpm åŒ…ï¼Œæ³¨æ„ä½¿ç”¨ downloadonly å‚æ•°å…ˆä¸‹è½½å¥½ rpm åŒ…å’Œå¯¹åº”çš„ä¾èµ–ï¼Œç„¶åå†é€šè¿‡ yum localinstall å®‰è£… ä½¿ç”¨ cephadm bootstrap åˆå§‹åŒ–å•èŠ‚ç‚¹ ceph é›†ç¾¤ï¼Œè¿‡ç¨‹ä¸­ä¼šä¸‹è½½å¥½éœ€è¦çš„ docker é•œåƒ åˆå§‹åŒ–å®Œæˆåå°±å¯ä»¥ä½¿ç”¨ cephadm rm-cluster --force --zap-osds --fsid \u0026lt;fsid\u0026gt; æŠŠç°åœ¨çš„é›†ç¾¤åˆ é™¤äº†ï¼Œæš‚æ—¶ç”¨ä¸åˆ°\n2 ä¿®æ”¹ docker é•œåƒ æˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„é•œåƒåªæœ‰ quay.io/ceph/ceph:v16 è¿™ä¸ªé•œåƒï¼Œé‡‡ç”¨ docker commit çš„æ–¹å¼ä¿®æ”¹\nå…ˆè¿è¡Œä¸€ä¸ªå®¹å™¨ç”¨äºä¿®æ”¹æ–‡ä»¶\n[root@node-128 ~]# docker run -itd --name test quay.io/ceph/ceph:v16 520af9cf98688d1eb1f572c28c4c60db4f231e4dbf6b3594c54c3892494e5d6c [root@node-128 ~]# docker exec -it test /bin/bash # å®¹å™¨æ“ä½œ [root@520af9cf9868 /]# find /usr/ -name serve.py /usr/share/ceph/mgr/cephadm/serve.py /usr/lib/python3.6/site-packages/pecan/commands/serve.py [root@520af9cf9868 /]# vi /usr/share/ceph/mgr/cephadm/serve.py å¦‚ä¸‹ï¼Œæ³¨é‡Šä¸‰è¡Œï¼Œå¤§çº¦ 937 è¡Œ\nå¦‚ä¸‹ï¼Œä¸‰å¤„ä¿®æ”¹å¤§çº¦ä½äº 1342 è¡Œ\næ³¨é‡Š if è¯­å¥ ä¿®æ”¹ cepadm å‘½ä»¤çš„ pull ä¸º inspect-image è·å– container æ•°æ®æ”¹ä¸ºç›´æ¥å†™æ­» è‡³æ­¤ï¼Œå·²ä¿®æ”¹å®Œæ¯•ï¼Œå°†å®¹å™¨æäº¤ä¸ºæ–°çš„é•œåƒ\ndocker commit -m \u0026#34;ä¿®æ”¹ /usr/share/ceph/mgr/cephadm/serve.py æ–‡ä»¶\u0026#34; -a \u0026#34;lvbibir\u0026#34; test ceph:v16 [root@node-128 ~]# docker images REPOSITORY TAG IMAGE ID CREATED SIZE ceph v16 c654e94b4c3f 3 days ago 1.23GB quay.io/ceph/ceph v16 e8311b759ac3 3 months ago 1.23GB quay.io/ceph/ceph-grafana 8.3.5 dad864ee21e9 4 months ago 558MB quay.io/prometheus/prometheus v2.33.4 514e6a882f6e 5 months ago 204MB quay.io/prometheus/node-exporter v1.3.1 1dbe0e931976 8 months ago 20.9MB quay.io/prometheus/alertmanager v0.23.0 ba2b418f427c 11 months ago 57.5MB ç„¶åå°†åŸå…ˆçš„é•œåƒåˆ é™¤ï¼Œå°†ä¿®æ”¹åçš„é•œåƒæ”¹ä¸ºåŸå…ˆçš„é•œåƒ tag\ndocker rmi quay.io/ceph/ceph:v16 docker tag ceph:v16 quay.io/ceph/ceph:v16 docker rmi ceph:v16 [root@ceph-x86-node3 ~]# docker images REPOSITORY TAG IMAGE ID CREATED SIZE quay.io/ceph/ceph v16 c654e94b4c3f 4 days ago 1.23GB quay.io/ceph/ceph-grafana 8.3.5 dad864ee21e9 4 months ago 558MB quay.io/prometheus/prometheus v2.33.4 514e6a882f6e 5 months ago 204MB quay.io/prometheus/node-exporter v1.3.1 1dbe0e931976 8 months ago 20.9MB quay.io/prometheus/alertmanager v0.23.0 ba2b418f427c 11 months ago 57.5MB åœ¨ æœ¬åšå®¢å¦ä¸€ç¯‡æ–‡ç«  æœ‰è„šæœ¬å¯ä»¥æ–¹ä¾¿çš„æ‰¹é‡å¯¼å…¥å¯¼å‡ºé•œåƒ\n3 æµ‹è¯• å°†ä¹‹å‰ä¸‹è½½çš„ rpm åŒ…å’Œå¯¼å‡ºçš„ docker é•œåƒè¿›è¡Œå½’æ¡£å‹ç¼©ï¼Œä¸Šä¼ è‡³æ— æ³•è®¿é—®å¤–ç½‘çš„ç¯å¢ƒï¼Œä¹‹åå°±ä¸åœ¨çº¿éƒ¨ç½² ceph é›†ç¾¤çš„æ­¥éª¤ä¸€æ ·äº†\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/ceph-v16-cpehadm-openuler-offline/","summary":"0 å‰è¨€ é€‚ç”¨äº Centos8/openeuler + docker å®‰è£… cephadmã€ceph-common çš„è¿‡ç¨‹å°±ä¸èµ˜è¿°äº†ï¼Œä¸»è¦æ¢è®¨å¦‚ä½•å®ç° cephadm ç¦»çº¿å®‰è£… ceph v16.2.8 1 ç¦»çº¿åŒ…çš„è·å– ç¦»çº¿åŒ…ä¸»è¦æŒ‡ rpm åŒ…å’Œ ceph çš„ docker é•œåƒ æ‰¾ä¸€å°æœ‰å¤–ç½‘çš„æµ‹è¯•æœºï¼ˆå°½é‡è·Ÿç”Ÿäº§ç³»ç»Ÿçš„ç¯å¢ƒä¸€è‡´ï¼‰é€šè¿‡ yum å®‰è£… cephadmã€ceph-commonã€docker ç­‰éœ€è¦çš„ rpm åŒ…ï¼Œæ³¨æ„ä½¿","title":"ceph | ceph-v16 ç¦»çº¿å®‰è£…è§£å†³æ–¹æ¡ˆ"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\næ­å»º PXE æœåŠ¡å™¨å®‰è£… UEFI å¯åŠ¨çš„ centos7 é…ç½®PXEç¯å¢ƒè‡ªåŠ¨å®‰è£… Linux rfc4578 åœ¨ pxe çš„ä¸€èˆ¬åœºæ™¯ä¸‹ï¼Œé€šå¸¸åœ¨åªéœ€è¦åœ¨ dhcp æœåŠ¡ä¸­é…ç½®ä¸€ä¸ªé€šç”¨çš„ filename æ¥æŒ‡å®šå®¢æˆ·ç«¯åœ¨ tftp æœåŠ¡ç«¯è·å–çš„å¼•å¯¼ç¨‹åºï¼Œä½†æ˜¯åœ¨ç•¥å¾®å¤æ‚çš„åœºæ™¯ä¸­ï¼Œæ¯”å¦‚å¯èƒ½æœ‰äº›æœåŠ¡å™¨é»˜è®¤æ˜¯ legacy æ¨¡å¼ï¼Œè€Œæœ‰äº›æœåŠ¡å™¨æ˜¯ UEFI æ¨¡å¼ï¼Œè¿™ä¸¤ç§æ¨¡å¼ä½¿ç”¨çš„å¼•å¯¼ç¨‹åºæ˜¯ä¸åŒçš„ï¼Œä½†æˆ‘ä»¬åˆä¸æƒ³é¢‘ç¹çš„å»ä¿®æ”¹ dhcp é…ç½®æ–‡ä»¶ã€‚æœ¬æ–‡ä¸»è¦æ¢è®¨çš„å°±æ˜¯è¿™ä¸ªé—®é¢˜ï¼Œå¦‚ä½•é…ç½® dhcp æ¥åº”å¯¹å¤æ‚çš„æœåŠ¡å™¨ç¯å¢ƒ\néš¾ç‚¹ä¸»è¦æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯åŒºåˆ†æŸäº› dhcp å®¢æˆ·ç«¯æ˜¯å¦éœ€è¦ pxe å¼•å¯¼ç¨‹åºï¼Œå¦å¤–ä¸€ä¸ªæ˜¯å¦‚ä½•åŒºåˆ†ä¸åŒçš„æ¨¡å¼å’Œæ¶æ„æ¥å»åˆ†é…å¯¹åº”çš„ pxe å¼•å¯¼ç¨‹åº\n1 RFC Request For Commentsï¼ˆRFCï¼‰ï¼Œæ˜¯ä¸€ç³»åˆ—ä»¥ç¼–å·æ’å®šçš„æ–‡ä»¶ã€‚æ–‡ä»¶æ”¶é›†äº†æœ‰å…³äº’è”ç½‘ç›¸å…³ä¿¡æ¯ï¼Œä»¥åŠ UNIX å’Œ äº’è”ç½‘ ç¤¾åŒºçš„ è½¯ä»¶ æ–‡ä»¶ã€‚RFC æ–‡ä»¶æ˜¯ç”± Internet Societyï¼ˆISOCï¼‰èµåŠ©å‘è¡Œã€‚åŸºæœ¬çš„äº’è”ç½‘é€šä¿¡åè®®éƒ½æœ‰åœ¨ RFC æ–‡ä»¶å†…è¯¦ç»†è¯´æ˜ã€‚RFC æ–‡ä»¶è¿˜é¢å¤–åŠ å…¥è®¸å¤šåœ¨æ ‡å‡†å†…çš„è®ºé¢˜ï¼Œä¾‹å¦‚å¯¹äºäº’è”ç½‘æ–°å¼€å‘çš„åè®®åŠå‘å±•ä¸­æ‰€æœ‰çš„è®°å½•ã€‚å› æ­¤å‡ ä¹æ‰€æœ‰çš„äº’è”ç½‘æ ‡å‡†éƒ½æœ‰æ”¶å½•åœ¨ RFC æ–‡ä»¶ä¹‹ä¸­ã€‚\n2 dhcp option 60 DHCP Option 60 Vendor class identifier ä¸ºå‚å•†ç±»æ ‡è¯†ç¬¦ã€‚è¿™ä¸ªé€‰é¡¹ä½œç”¨äºå®¢æˆ·ç«¯å¯é€‰åœ°è¯†åˆ«å®¢æˆ·ç«¯å‚å•†ç±»å‹å’Œé…ç½®ã€‚è¿™ä¸ªä¿¡æ¯æ˜¯ N ä¸ª 8 ä½ç¼–ç ï¼Œç”± DHCP æœåŠ¡ç«¯è§£æã€‚å‚å•†å¯èƒ½ä¼šä¸ºå®¢æˆ·ç«¯é€‰æ‹©å®šä¹‰ç‰¹æ®Šçš„å‚å•†ç±»æ ‡è¯†ç¬¦ä¿¡æ¯ï¼Œä»¥ä¾¿è¡¨è¾¾ç‰¹æ®Šçš„é…ç½®æˆ–è€…å…¶ä»–å…³äºå®¢æˆ·ç«¯çš„ä¿¡æ¯ã€‚æ¯”å¦‚ï¼šè¿™ä¸ªæ ‡è¯†ç¬¦å¯èƒ½ç¼–ç äº†å®¢æˆ·ç«¯çš„ç¡¬ä»¶é…ç½®ã€‚å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„æœåŠ¡å™¨ä¸èƒ½è§£æçš„ç±»è§„èŒƒä¿¡æ¯å¿…é¡»è¢«å¿½ç•¥ï¼ˆå°½ç®¡å¯èƒ½ä¼šæœ‰æŠ¥å‘Šï¼‰ã€‚\n3 dhcp option 93 dhcp-options çš„ man æ‰‹å†Œä¸­æœ‰æåˆ°å¯¹äºæ¶æ„ç±»å‹åœ¨ RFC 4578 ä¸­æœ‰ä¸€å¥—æ ‡å‡†ï¼Œå¯é€šè¿‡ if è¯­å¥åˆ¤æ–­ dhcp å®¢æˆ·ç«¯çš„ Arch ä»£ç æ¥æä¾›ä¸åŒçš„ PXE å¼•å¯¼ç¨‹åºç»™å®¢æˆ·ç«¯\n# man dhcp-options option pxe-system-type uint16 [, uint16 ... ]; A list of one ore more 16-bit integers which allows a client to specify its pre-boot architecture type(s). This option is included based on RFC 4578. ä¸‹è¿°ä¸º RFC 4578 æ ‡å‡†ä¸­å¯¹ arch ä»£ç åˆ¶å®šçš„æ ‡å‡†ï¼Œname å­—æ®µåŒ…å«å¯åŠ¨æ¨¡å¼å’Œ cpu æ¶æ„ä¿¡æ¯ï¼ˆè‡ªå·±çš„çŒœæµ‹ï¼Œè¿™é‡Œæ²¡æ‰¾åˆ°å¯¹äº name æ›´è¯¦ç»†çš„è§£é‡Šï¼‰\nType Architecture Name ---- ----------------- 0 Intel x86PC 1 NEC/PC98 2 EFI Itanium 3 DEC Alpha 4 Arc x86 5 Intel Lean Client 6 EFI IA32 7 EFI BC 8 EFI Xscale 9 EFI x86-64 4 æŠ“åŒ…è·å– arch ä»£ç  é€šè¿‡å‰æ–‡æè¿°ï¼Œæˆ‘ä»¬å¾—çŸ¥ arch ä»£ç ä¸»è¦æ˜¯ç”±ç¡¬ä»¶å‚å•†å®šä¹‰å¥½çš„ï¼Œé…ç½®å¥½ pxe æœåŠ¡ï¼Œarch ä»£ç çš„è·å–è‡³å…³é‡è¦ï¼Œå»å’¨è¯¢ç¡¬ä»¶å‚å•†æ•ˆç‡å¤ªæ…¢ï¼Œè¿™é‡Œé€šè¿‡æ›´ä¸ºæ–¹ä¾¿çš„æŠ“åŒ…è·å–\næŠ“åŒ…ä¸»è¦è·å–æä¾› dhcp æœåŠ¡çš„ç½‘å¡çš„æ•°æ®åŒ…ï¼Œéœ€æœåŠ¡ç«¯å¼€å¯ dhcp æœåŠ¡ï¼Œå®¢æˆ·ç«¯é€šè¿‡ç½‘å¡å¯åŠ¨\nwindows ç«¯é€šè¿‡ wireshark æ¥å®Œæˆ\nlinux æœåŠ¡ç«¯ä½¿ç”¨ tcpdump -i \u0026lt;interface\u0026gt; -w \u0026lt;file\u0026gt; ç”Ÿæˆåˆ°æ–‡ä»¶ç„¶åç”¨ wireshark åˆ†æ\nä»¥ä¸‹æä¾›å‡ ä¸ª dhcp option 60 å’Œ dhcp option 93 æŠ¥æ–‡ç¤ºä¾‹ï¼š\nAMD Ryzen 7 4800U with Radeon Graphics (x86) vmware workstation v16 å¹³å° UEFI æ¨¡å¼ä¸‹ è¿™é‡Œè·å–åˆ°çš„ arch ä»£ç ä¸º 7\nAMD Ryzen 7 4800U with Radeon Graphics (x86) vmware workstation v16 å¹³å° legacy æ¨¡å¼ä¸‹ è¿™é‡Œè·å–åˆ°çš„ arch ä»£ç ä¸º 0\nkunpeng 920 (aarch64) kvm å¹³å° UEFI æ¨¡å¼ä¸‹ è¿™é‡Œè·å–åˆ°çš„ arch ä»£ç ä¸º 11\nä»¥ä¸ŠæŠ“åŒ…éƒ½æ˜¯åœ¨ç½‘ç»œå¼•å¯¼çš„ç¯å¢ƒä¸‹è¿›è¡Œçš„ï¼Œåœ¨ä½¿ç”¨å·²å®‰è£…æ“ä½œç³»ç»Ÿä¸­çš„ç½‘å¡å»å‘é€ dhcp è¯·æ±‚æ—¶ï¼Œæ•´ä¸ªæ•°æ®åŒ…ä¼ è¾“è¿‡ç¨‹éƒ½æ²¡æœ‰ option 60 å’Œ option 93 è¿™ä¸¤ä¸ªé€‰é¡¹çš„å‚ä¸ï¼Œæˆ‘çŒœæµ‹è¿™ä¸¤ä¸ªé€‰é¡¹åªæœ‰åœ¨ç½‘ç»œå¼•å¯¼çš„ç¯å¢ƒä¸‹æ‰ä¼šå»å‚ä¸\n5 dhcp é…ç½®æ–‡ä»¶ç¤ºä¾‹ åœ¨ä¸Šè¿°è®ºè¯åŸºç¡€ä¹‹ä¸Šï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡é…ç½® dhcp æœåŠ¡æ¥ä½¿ pxe è¶³ä»¥åº”å¯¹å¤æ‚çš„ç½‘ç»œç¯å¢ƒå’Œç¡¬ä»¶ç¯å¢ƒ\nè§£å†³å‰è¨€ä¸­æåˆ°çš„ä¸¤ä¸ªéš¾ç‚¹åˆ†åˆ«é€šè¿‡ option 60 å’Œ option 93 åˆ†åˆ«è§£å†³\n# è¿™é‡Œåº”è¯¥æ˜¯å°† option 93 çš„å€¼æ ¼å¼åŒ–æˆ 16 è¿›åˆ¶ï¼Œç”¨äºä¸‹é¢çš„ if åˆ¤æ–­ï¼ˆçŒœæµ‹ï¼‰ option arch code 93 = unsigned integer 16; class \u0026#34;pxeclients\u0026#34; { # è¿™é‡Œåˆ¤æ–­ option 60 é€‰é¡¹çš„å€¼çš„å‰9ä¸ªå­—ç¬¦æ˜¯å¦æ˜¯ PXEClient match if substring (option vendor-class-identifier, 0, 9) = \u0026#34;PXEClient\u0026#34;; next-server 10.17.25.17; # è¿™é‡Œé€šè¿‡ if åˆ¤æ–­ arch ä»£ç æ¥å†³å®šå¦‚ä½•å»åˆ†é…å¯¹åº”çš„ pxe å¼•å¯¼ç¨‹åº if option arch = 00:07 { filename \u0026#34;/BOOTX64.efi\u0026#34;; } else if option arch = 00:09 { filename \u0026#34;/BOOTX64.efi\u0026#34;; } else { filename \u0026#34;/pxelinux.0\u0026#34;; } } è¾ƒä¸ºè¯¦ç»†çš„é…ç½®æ–‡ä»¶ç¤ºä¾‹ï¼Œåé¢æœ‰ç®€åŒ–ç‰ˆ\n# å¯ç”¨ PXE æ”¯æŒ allow booting; allow bootp; # PXE å®šä¹‰å‘½åç©ºé—´ option space PXE; option PXE.mtftp-ip code 1 = ip-address; option PXE.mtftp-cport code 2 = unsigned integer 16; option PXE.mtftp-sport code 3 = unsigned integer 16; option PXE.mtftp-tmout code 4 = unsigned integer 8; option PXE.mtftp-delay code 5 = unsigned integer 8; option arch code 93 = unsigned integer 16; # RFC4578 authoritative; one-lease-per-client true; # ä¸ä½¿ç”¨DNSåŠ¨æ€æ›´æ–° ddns-update-style none; # å¿½ç•¥å®¢æˆ·ç«¯DNSæ›´æ–° ignore client-updates; # ä¸ä½¿ç”¨ PXE çš„ç½‘ç»œ shared-network main { subnet 10.17.25.0 netmask 255.255.255.0 { option routers 10.17.25.254; option subnet-mask 255.255.255.0; option domain-name \u0026#34;zhijie-liu.com\u0026#34;; # åœ¨æ­¤ç½‘ç»œå…³é—­PXEæ”¯æŒ deny bootp; pool { range 10.17.25.200 10.17.25.210; host nagios-test { hardware ethernet 00:0d:56:66:82:c3; fixed-address 10.17.25.200; } } } } # ä½¿ç”¨ PXE çš„ç½‘ç»œ shared-network pxe { subnet 10.17.15.0 netmask 255.255.255.0 { option routers 10.17.15.254; option subnet-mask 255.255.255.0; option domain-name \u0026#34;xiyang-liu.com\u0026#34;; option domain-name-servers 10.17.26.88, 8.8.8.8; default-lease-time 86400; max-lease-time 172800; pool { range 10.17.15.1 10.17.15.20; class \u0026#34;pxeclient\u0026#34; { match if substring (option vendor-class-identifier, 0, 9) = \u0026#34;PXEClient\u0026#34;; next-server 10.17.25.17; if option arch = 00:07 { filename \u0026#34;/BOOTX64.efi\u0026#34;; } else if option arch = 00:09 { filename \u0026#34;/BOOTX64.efi\u0026#34;; } else { filename \u0026#34;/pxelinux.0\u0026#34;; } } # æ ¹æ® MAC åœ°å€å•ç‹¬åˆ†é…åœ°å€å’ŒæŒ‡å®šçš„ PXE å¼•å¯¼ç¨‹åº host gpxelinux { option host-name \u0026#34;gpxelinux.zhijie-liu.com\u0026#34;; hardware ethernet 00:50:56:24:0B:30; fixed-address 10.17.15.8; filename \u0026#34;/gpxelinux.0\u0026#34; } } } } ç®€åŒ–ç‰ˆï¼ˆä»… kvm å¹³å°æµ‹è¯•é€šè¿‡ï¼‰\noption domain-name \u0026#34;example.org\u0026#34;; option domain-name-servers 8.8.8.8, 114.114.114.114; default-lease-time 84600; max-lease-time 100000; log-facility local7; option arch code 93 = unsigned integer 16; subnet 1.1.1.0 netmask 255.255.255.0 { range 1.1.1.100 1.1.1.200; option routers 1.1.1.253; class \u0026#34;pxeclients\u0026#34; { match if substring (option vendor-class-identifier, 0, 9) = \u0026#34;PXEClient\u0026#34;; next-server 1.1.1.21; if option arch = 00:11 { filename \u0026#34;/grubaa64.efi\u0026#34;; } } } ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/pxe-dhcp-legacy-uefi-archs/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: æ­å»º PXE æœåŠ¡å™¨å®‰è£… UEFI å¯åŠ¨çš„ centos7 é…ç½®PXEç¯å¢ƒè‡ªåŠ¨å®‰è£… Linux rfc4578 åœ¨ pxe çš„ä¸€èˆ¬åœºæ™¯ä¸‹ï¼Œé€šå¸¸åœ¨åªéœ€è¦åœ¨ dhcp æœåŠ¡ä¸­é…ç½®ä¸€ä¸ªé€šç”¨çš„ filename æ¥æŒ‡å®šå®¢æˆ·ç«¯åœ¨ tftp æœåŠ¡ç«¯è·å–çš„å¼•å¯¼ç¨‹åºï¼Œä½†æ˜¯åœ¨ç•¥å¾®å¤æ‚çš„åœºæ™¯ä¸­ï¼Œæ¯”å¦‚å¯èƒ½æœ‰äº›æœåŠ¡å™¨é»˜è®¤æ˜¯ legacy æ¨¡å¼ï¼Œè€Œæœ‰äº›æœåŠ¡å™¨æ˜¯ UEFI æ¨¡å¼ï¼Œè¿™ä¸¤ç§æ¨¡å¼ä½¿ç”¨çš„å¼•å¯¼ç¨‹åºæ˜¯ä¸åŒçš„","title":"pxe å¦‚ä½•åº”å¯¹å¤æ‚çš„æœåŠ¡å™¨ç¡¬ä»¶ç¯å¢ƒ"},{"content":"ç¤ºä¾‹ä»£ç \nimport os # è¾“å…¥æ–‡ä»¶å¤¹åœ°å€ path = \u0026#34;C://Users//lvbibir//Desktop//lvbibir.github.io//content//posts//read//\u0026#34; files = os.listdir(path) # è¾“å‡ºæ‰€æœ‰æ–‡ä»¶åï¼Œåªæ˜¯ä¸ºäº†ç¡®è®¤ä¸€ä¸‹ for file in files: print(file) # è·å–æ—§åå’Œæ–°å i = 0 for file in files: # æ—§åç§°çš„ä¿¡æ¯ old = path + os.sep + files[i] # æ–°åç§°çš„ä¿¡æ¯ new = path + os.sep + file.replace(\u0026#39;_\u0026#39;,\u0026#39;-\u0026#39;) # æ–°æ—§æ›¿æ¢ print(new) os.rename(old,new) i+=1 ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/python-rename-file/","summary":"ç¤ºä¾‹ä»£ç  import os # è¾“å…¥æ–‡ä»¶å¤¹åœ°å€ path = \u0026#34;C://Users//lvbibir//Desktop//lvbibir.github.io//content//posts//read//\u0026#34; files = os.listdir(path) # è¾“å‡ºæ‰€æœ‰æ–‡ä»¶åï¼Œåªæ˜¯ä¸ºäº†ç¡®è®¤ä¸€ä¸‹ for file in files: print(file) # è·å–æ—§åå’Œæ–°å i = 0 for file in files: # æ—§åç§°çš„ä¿¡æ¯ old = path + os.sep + files[i] # æ–°åç§°çš„ä¿¡æ¯ new = path + os.sep + file.replace(\u0026#39;_\u0026#39;,\u0026#39;-\u0026#39;) # æ–°æ—§æ›¿æ¢ print(new) os.rename(old,new) i+=1 ä»¥ä¸Š","title":"python | æ‰¹é‡ä¿®æ”¹ç›®å½•ä¸‹æ–‡ä»¶å"},{"content":"0 å‰è¨€ ä¹¦åã€Šå¾®ä¹ æƒ¯ã€‹ï¼Œä½œè€…æ–¯æèŠ¬Â·ç›–æ–¯ [ç¾]ï¼Œæ±Ÿè¥¿äººæ°‘å‡ºç‰ˆç¤¾ï¼Œè¯‘è€…æ¡‚å›\nå¾®ä¹ æƒ¯æ˜¯ä¸€ç§éå¸¸å¾®å°çš„ç§¯æè¡Œä¸ºï¼Œä½ éœ€è¦æ¯å¤©å¼ºè¿«è‡ªå·±å®Œæˆå®ƒã€‚å¾®ä¹ æƒ¯å¤ªå°ï¼Œå°åˆ°ä¸å¯èƒ½å¤±è´¥ã€‚æ­£æ˜¯å› ä¸ºè¿™ä¸ªç‰¹æ€§ï¼Œå®ƒä¸ä¼šç»™ä½ é€ æˆä»»ä½•è´Ÿæ‹…ï¼Œè€Œä¸”å…·æœ‰è¶…å¼ºçš„â€œæ¬ºéª—æ€§â€ï¼Œå®ƒå› æ­¤æˆäº†æå…·ä¼˜åŠ¿çš„ä¹ æƒ¯å…»æˆç­–ç•¥ã€‚\nå¾®ä¹ æƒ¯ç­–ç•¥çš„ç§‘å­¦åŸç†è¡¨æ˜äº†äººä»¬æ— æ³•é•¿æœŸåšæŒå¤§å¤šæ•°ä¸»æµæˆé•¿ç­–ç•¥çš„åŸå› ï¼Œä¹Ÿè§£é‡Šäº†äººä»¬é•¿æœŸåšæŒå¾®ä¹ æƒ¯ç­–ç•¥çš„å¯èƒ½æ€§ã€‚äººä»¬æ— æ³•è®©æ”¹å˜çš„æ•ˆæœæŒä¹…æ—¶ï¼Œå¾€å¾€è®¤ä¸ºåŸå› åœ¨äºè‡ªå·±ï¼Œä½†å…¶å®æœ‰é—®é¢˜çš„å¹¶ä¸æ˜¯ä»–ä»¬æœ¬èº«ï¼Œè€Œæ˜¯ä»–ä»¬é‡‡ç”¨çš„ç­–ç•¥ã€‚å½“ä½ å¼€å§‹ç”¨å¾®ä¹ æƒ¯ç­–ç•¥æ•™ä½ çš„æ–¹æ³•æŒ‰ç…§å¤§è„‘çš„è§„å¾‹åšäº‹æƒ…æ—¶ï¼ŒæŒä¹…æ”¹å˜å…¶å®å¾ˆå®¹æ˜“ã€‚\nå¾®ä¹ æƒ¯ç­–ç•¥çš„æ‰€æœ‰ç›Šå¤„ã€åŠ›é‡å’Œä¼˜åŠ¿éƒ½å–å†³ä¸ä½ åœ¨çº¸é¢ä¸Šå’Œå¿ƒé‡Œå§‹ç»ˆéƒ½å°†ç›®æ ‡ä¿æŒåœ¨å¾®å°çŠ¶æ€çš„èƒ½åŠ›ã€‚\nå¾®ä¹ æƒ¯ç­–ç•¥çš„æ‰€æœ‰ç›Šå¤„ã€åŠ›é‡å’Œä¼˜åŠ¿éƒ½å–å†³ä¸ä½ åœ¨çº¸é¢ä¸Šå’Œå¿ƒé‡Œå§‹ç»ˆéƒ½å°†ç›®æ ‡ä¿æŒåœ¨å¾®å°çŠ¶æ€çš„èƒ½åŠ›ã€‚\nå¾®ä¹ æƒ¯ç­–ç•¥çš„æ‰€æœ‰ç›Šå¤„ã€åŠ›é‡å’Œä¼˜åŠ¿éƒ½å–å†³ä¸ä½ åœ¨çº¸é¢ä¸Šå’Œå¿ƒé‡Œå§‹ç»ˆéƒ½å°†ç›®æ ‡ä¿æŒåœ¨å¾®å°çŠ¶æ€çš„èƒ½åŠ›ã€‚\n1 å¾®ä¹ æƒ¯æ˜¯ä»€ä¹ˆ åƒé‡Œä¹‹è¡Œï¼Œå§‹äºè¶³ä¸‹ã€‚ â€”â€”è€å­\næ¬¢è¿æ¥åˆ°å¾®ä¹ æƒ¯çš„ä¸–ç•Œï¼Œé¦–å…ˆé™ˆè¿°ä¸¤ä¸ªäº‹å®ï¼š\nå“ªæ€•æ˜¯ä¸€ç‚¹ç‚¹è¡ŒåŠ¨ï¼Œä¹Ÿæ¯”æ¯«ä¸ä½œä¸ºå¼ºæ— æ•°å€ï¼ˆåœ¨æ•°å­¦æ„ä¹‰ä¸Šå¦‚æ­¤ï¼Œå®é™…ç”Ÿæ´»ä¸­ä¹Ÿæ˜¯å¦‚æ­¤ï¼‰ã€‚ ç›¸æ¯”æŸä¸€å¤©åšå¾ˆå¤šäº‹ï¼Œæ¯å¤©åšä¸€ç‚¹äº‹çš„å½±å“åŠ›ä¼šæ›´å¤§ã€‚ å‡ ä¹æ¯ä¸ªäººéƒ½ç»å†è¿‡ç“¶é¢ˆæœŸï¼Œç«­å°½å…¨åŠ›æƒ³æå‡è‡ªå·±å´æœ€ç»ˆå¤±è´¥ï¼Œç„¶åæ— æ•°æ¬¡å°è¯•å¹¶é­é‡å¤±è´¥åå¾ˆä¹…ä¸æ•¢é‡æ–°å¼€å§‹ã€‚\nå¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬æ²¡èƒ½å®æ–½è¡ŒåŠ¨ï¼Œä¹Ÿæ²¡èƒ½å®ç°è®¡åˆ’ï¼Œä½†æœ‰æ²¡æœ‰å¯èƒ½è¿™å¹¶ä¸æ˜¯æˆ‘ä»¬çš„é”™ï¼Œè€Œæ˜¯æˆ‘ä»¬é‡‡ç”¨å¹¶è®¤å¯çš„ç­–ç•¥å‡ºäº†é—®é¢˜å‘¢ï¼Ÿ\nåªä¸ºåŸ¹å…»å¥½ä¹ æƒ¯\nå¾®ä¹ æƒ¯ä¸ä¼šç›´æ¥å¸®ä½ æˆ’çƒŸã€æˆ’é…’æˆ–è€…æ§åˆ¶èµŒç˜¾ï¼Œå¾®ä¹ æƒ¯ç­–ç•¥åªä¼šå¸®ä½ åŸ¹å…»ä½ è®¤å¯çš„å¥½ä¹ æƒ¯ï¼Œç»™ä½ çš„ç”Ÿæ´»å¢æ·»ç§¯æè¡Œä¸ºï¼ŒæŒç»­ä¸°å¯Œä½ çš„ç”Ÿæ´»ã€‚æ¶ˆé™¤åä¹ æƒ¯å’Œå»ºç«‹å¥½ä¹ æƒ¯æœ‰ç€å…±åŒçš„ç›®æ ‡â€”â€”ç”¨æ›´å¥½çš„è¡Œä¸ºæ–¹å¼å–ä»£åŸæœ‰çš„è¡Œä¸ºæ–¹å¼ã€‚\nå¦‚æœä½ æœ‰å¥½ä¹ æƒ¯ï¼Œä½ æ”¹å˜è‡ªå·±çš„ä¸»è¦åŠ¨åŠ›æ˜¯é è¿‘è¿™äº›ç§¯æçš„ä¸œè¥¿ï¼›å¦‚æœä½ æœ‰åä¹ æƒ¯ï¼Œä½ æ”¹å˜è‡ªå·±çš„ä¸»è¦åŠ¨åŠ›æ˜¯è¿œç¦»è¿™äº›æ¶ˆæçš„ä¸œè¥¿ã€‚\nå¾®ä¹ æƒ¯ç®€ä»‹\nå¦‚æœä½ æƒ³åŸ¹å…»ä¸€ä¸ªæ–°ä¹ æƒ¯ï¼Œå¾®ä¹ æƒ¯åŸºæœ¬å°±æ˜¯å®ƒç»è¿‡å¤§å¹…ç¼©å‡çš„ç‰ˆæœ¬â€”â€”æŠŠâ€œæ¯å¤©åš 100 ä¸ªä¿¯å§æ’‘â€ç¼©å‡æˆæ¯å¤© 1 ä¸ªï¼ŒæŠŠâ€œæ¯å¤©å†™ 3000 å­—â€ç¼©å‡æˆæ¯å¤©å†™ 50 å­—ï¼ŒæŠŠâ€œå§‹ç»ˆä¿æŒç§¯ææ€è€ƒâ€ç¼©å‡æˆæ¯å¤©æƒ³ä¸¤ä»¶å¥½äº‹ã€‚\nå¾®ä¹ æƒ¯ä½“ç³»çš„åŸºç¡€åœ¨äºâ€œå¾®æ­¥éª¤â€ï¼Œé‚£äº›â€œå°åˆ°ä¸å¯æ€è®®çš„ä¸€å°æ­¥â€ã€‚\nä¸€å®¶é“¶è¡Œå¯èƒ½å› ä¸ºè§„æ¨¡å¤ªå¤§è€Œä¸è‡³äºå¤±è´¥ï¼Œè€Œå¾®ä¹ æƒ¯æ˜¯å› ä¸ºå¤ªå°è€Œä¸è‡³äºæ— æ³•å®Œæˆï¼Œå› ä¸ºï¼Œä½ ä¸ä¼šæœ‰æœºä¼šä½“éªŒæœªå®Œæˆç›®æ ‡å¯¼è‡´çš„å¸¸è§æ¶ˆææƒ…ç»ªï¼Œæ¯”å¦‚æ„§ç–šå’ŒæŒ«è´¥æ„Ÿã€‚\nä¹ æƒ¯è¿˜ä¸å‹åŠ›æœ‰å…³\nç°åœ¨è¯•æƒ³ä¸€ä¸‹ï¼šå¦‚æœåä¹ æƒ¯è®©ä½ å‹åŠ›è¿‡å¤§ï¼Œä½ ä¼šæ€ä¹ˆåšã€‚å‹åŠ›æ˜¯è´Ÿåé¦ˆå¾ªç¯çš„ç»ä½³å¯¼ç«ç´¢ï¼Œå®ƒä¼šè§¦å‘ä¸€ä¸ªåä¹ æƒ¯ï¼Œåä¹ æƒ¯åˆä¼šè§¦å‘å†…ç–šæ„Ÿã€å†…å¿ƒçš„ç„¦è™‘å’Œæ›´å¤šå‹åŠ›ï¼Œè¿™äº›æ¶ˆæå› ç´ ä¼šå†æ¬¡è§¦å‘è¿™ä¸ªåä¹ æƒ¯ã€‚\nä½†æ˜¯ï¼Œå¦‚æœä¹ æƒ¯æœ¬èº«å°±èƒ½ç¼“è§£å‹åŠ›ä¼šæ€æ ·ï¼Ÿæ‹¿é”»ç‚¼æ¥è¯´ï¼Œä½ çš„å‹åŠ›ä¼šæŠŠä½ æ‹½åˆ°å¥èº«æˆ¿ï¼Œé”»ç‚¼ä¼šå¸®ä½ ç¼“è§£ç„¦è™‘ã€‚\nå…»æˆæ–°ä¹ æƒ¯éœ€è¦å¤šé•¿æ—¶é—´\nä¸æ˜¯ 21 å¤©ï¼Œä¹Ÿä¸æ˜¯ 30 å¤©ã€‚â€œ21 å¤©â€è°¬è®ºå¯èƒ½æºè‡ªæ•´å½¢å¤–ç§‘åŒ»ç”Ÿéº¦å…‹æ–¯éŸ¦å°”Â·é©¬å°”èŒ¨ï¼ˆMaxwell Maltzï¼‰ã€‚æ®è¯´é©¬å°”èŒ¨åŒ»ç”Ÿå‘ç°æ¥å—æˆªè‚¢æ‰‹æœ¯çš„æ‚£è€…éœ€è¦å¤§çº¦ 21 å¤©æ¥é€‚åº”è‚¢ä½“æ®‹ç¼ºçš„äº‹å®ï¼Œå› æ­¤ï¼Œä»–è®¤ä¸º 21 å¤©æ˜¯äººä»¬é€‚åº”ä»»ä½•ç”Ÿæ´»å˜åŒ–æ‰€éœ€è¦çš„æ—¶é—´é•¿åº¦ã€‚\nä¸åŒè¡Œä¸ºæ‰€éœ€è¦çš„æ—¶é—´å·®åˆ«å¾ˆå¤§ï¼Œä» 18 å¤©åˆ° 254 å¤©ä¸ç­‰ï¼Œç”šè‡³åœ¨æŸäº›æ¡ˆä¾‹ä¸­ï¼Œè¿™äº›æ—¶é—´å¯èƒ½æƒŠäººçš„é•¿ã€‚\n2 å¤§è„‘çš„å·¥ä½œåŸç† å¤§è„‘æ˜¯æˆ‘çš„ä¸€åˆ‡ï¼Œåç”Ÿã€‚èº«ä½“åªæ˜¯é™„ä»¶è€Œå·²ã€‚ â€”â€”é˜¿ç‘ŸÂ·æŸ¯å—Â·é“å°”ï¼Œã€Šç¦å°”æ‘©æ–¯æ¢æ¡ˆé›†ã€‹\nå¤§è„‘æ˜¯å˜åŒ–ç¼“æ…¢ä¸”çŠ¶æ€ç¨³å®šçš„\näººç±»å¤§è„‘æœ‰ä¸€å¥—å¯¹å¤–éƒ¨ä¸–ç•Œåšå‡ºååº”çš„å›ºå®šä½“ç³»ã€‚æœ‰æ—¶æˆ‘ä»¬è§‰å¾—ä¸æ˜“æ”¹å˜çš„å¤§è„‘ä»¤äººæ„Ÿåˆ°æ²®ä¸§ï¼Œä½†æ€»ä½“æ¥è¯´ï¼Œå¥½å¤„è¿˜æ˜¯ç›¸å½“å¤šçš„\nä¸€æ—¦æˆåŠŸå…»æˆå¥åº·çš„æ–°ä¹ æƒ¯ï¼Œä¸€åˆ‡éƒ½ä¼šå˜å¾—è½»æ¾èµ·æ¥ã€‚æˆ‘ä»¬æ— éœ€è·Ÿå¤§è„‘æŒä¹…æˆ˜æ–—å°±å¯ä»¥è‡ªç„¶çš„æ‰§è¡Œè¿™äº›ä¹ æƒ¯ã€‚\nå¤§è„‘ä¸­çš„ä¸¤ä¸ªæ ¸å¿ƒè§’è‰²\næ„šè ¢çš„é‡å¤è€…â€”â€”åŸºåº•ç¥ç»èŠ‚ èªæ˜çš„ç®¡ç†è€…â€”â€”å‰é¢çš®å±‚ åŸºåº•ç¥ç»èŠ‚æ˜¯æ„šè ¢çš„ï¼Œä½ æŠ½çƒŸçš„æ—¶å€™ï¼Œå®ƒä¸ä¼šè€ƒè™‘åˆ°è‚ºç™Œçš„å¯èƒ½æ€§ï¼›ä½ é”»ç‚¼çš„æ—¶å€™ï¼Œå®ƒä¹Ÿä¸ä¼šå¹»æƒ³å¥åº·èº«ä½“çš„å¥½å¤„ã€‚ä½†æ˜¯å®ƒå¯ä»¥é«˜æ•ˆç‡åœ°é‡å¤æ¨¡å¼ï¼ŒèŠ‚çœç²¾åŠ›ï¼Œå®ƒçš„å·¥ä½œå‡ ä¹æ— éœ€æˆ‘ä»¬æ¶ˆè€—é¢å¤–çš„æ„å¿—åŠ›æˆ–è€…åŠ¨åŠ›å³å¯å®Œæˆã€‚\nå‰é¢çš®å±‚åˆ™ç›¸å½“èªæ˜ï¼Œæ˜¯ä¸ªå¯ä»¥ç†è§£é•¿è¿œåˆ©ç›Šå’Œç»“æœçš„ç®¡ç†è€…ï¼Œå®ƒæ‹¥æœ‰æŠ‘åˆ¶åŸºåº•ç¥ç»èŠ‚çš„èƒ½åŠ›ï¼ŒåŒæ—¶å®ƒè¿˜è´Ÿè´£å¤„ç†çŸ­æœŸæ€ç»´å’Œå†³ç­–ã€‚\nå‰é¢çš®å±‚çš„åŠŸèƒ½è¿™ä¹ˆå¼ºå¤§ï¼Œæ‰€ä»¥ä¼šæ¶ˆè€—ç›¸å½“çš„ç²¾åŠ›ï¼Œä»è€Œä½¿ä½ æ„Ÿåˆ°ç–²åŠ³ã€‚è¿™ä¸ªæ—¶å€™ï¼ŒæŒç®¡é‡å¤éƒ¨åˆ†çš„åŸºåº•ç¥ç»èŠ‚å°±ä¼šæ¥ç®¡å¤§è„‘ã€‚\nè®©å¤§è„‘çš„å…¶ä»–éƒ¨åˆ†å–œæ¬¢ä¸Šå‰é¢çš®å±‚æƒ³è¦çš„ä¸œè¥¿ï¼Œæ˜¯å»ºç«‹æ–°ä¹ æƒ¯çš„å”¯ä¸€æ–¹å¼\n3 åŠ¨åŠ› v.s. æ„å¿—åŠ› æƒ…ç»ªè¦ä¹ˆé¡ºæœä½ ï¼Œè¦ä¹ˆæ”¯é…ä½ ï¼Œè¿™è¦çœ‹è°è¯´äº†ç®—ã€‚ â€”â€”å‰ç±³Â·ç½—æ©\nå½“åŠ¨åŠ›å¤„äºå³°å€¼æ—¶ï¼Œæ„å¿—åŠ›æ¶ˆè€—é‡ä¸º 0 æˆ–å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œè¿™æ˜¯å› ä¸ºä½ æ— éœ€å¼ºè¿«è‡ªå·±åšä½ æœ¬æ¥å°±æ„¿æ„åšçš„äº‹æƒ…ï¼Œå¯ä»¥å½“åŠ¨åŠ›é™ä¸º 0 æ—¶ï¼Œå¼ºçƒˆçš„å†…å¿ƒæŠµè§¦æ„å‘³ç€æˆ‘ä»¬å¿…é¡»æ¶ˆè€—éå¸¸å¤§çš„æ„å¿—åŠ›\nåšäº‹ç¼ºä¹åŠ¨åŠ›ï¼Œæ„å¿—åŠ›çš„æ¶ˆè€—çŒ›æ¶¨ï¼Œè¿™ç§æ–¹å¼å¾ˆéš¾ç»´æŒä¸€ä¸ªè¡Œä¸ºå¹¶å°†å…¶åŸ¹å…»æˆä¹ æƒ¯\nâ€œæ¿€å‘åŠ¨åŠ›â€ç­–ç•¥çš„è¯¸å¤šé—®é¢˜\næ¿€å‘åŠ¨åŠ›æœ‰æ•ˆæœå—ï¼Ÿç­”æ¡ˆå¹¶ä¸æ˜¯é‚£ä¹ˆç¡®å®šã€‚å¶å°”æˆ‘ä»¬å¯ä»¥æ¿€å‘å¼ºçƒˆçš„åŠ¨åŠ›åšæŸä»¶äº‹ï¼Œæ¯”å¦‚é”»ç‚¼èº«ä½“ï¼Œæ¯”å¦‚é˜…è¯»ï¼Œæ¯”å¦‚å­¦ä¹ æŸé¡¹æŠ€èƒ½ï¼Œä½†æ˜¯æ‰ªå¿ƒè‡ªé—®æˆ‘ä»¬æ— æ³•ç¡®ä¿ä¸‹æ¬¡æ˜¯å¦è¿˜æœ‰å¦‚æ­¤å¼ºçƒˆçš„åŠ¨åŠ›ã€‚\nåŠ¨åŠ›æ˜¯ä¸€ç§èƒ½å¸¦æ¥è¯¸å¤šå¥½å¤„çš„é‡è¦æ„Ÿè§‰ï¼Œä½†æ˜¯å½“å®ƒå‡ºç°æ—¶ï¼Œè¯·æŠŠå®ƒçœ‹ä½œä¸€ä¸ªé¢å¤–çš„å¥–åŠ±ï¼Œä¸€ä»¶ç¾å¥½çš„äº‹ç‰©ã€‚æˆ‘ä»¬å¯ä»¥äº«å—å®ƒå¸¦æ¥çš„å¥½å¤„ï¼Œä½†ä¸è¦å°è¯•å»ä¾èµ–åŠ¨åŠ›ã€‚\nåŠ¨åŠ›å¹¶ä¸å¯é  åŠ¨åŠ›ä¹‹æ‰€ä»¥ä¸å¯é ï¼Œæ˜¯å› ä¸ºå®ƒæ˜¯ä»¥äººçš„æ„Ÿå—ä¸ºåŸºç¡€çš„ï¼Œè€Œäººç±»çš„æ„Ÿå—å®¹æ˜“æ”¹å˜ä¸”æ— æ³•é¢„æµ‹å·²ç»æ˜¯å‡ ç™¾å¹´æ¥å…¬è®¤çš„äº‹å®äº†ã€‚å‡ ä¹æ‰€æœ‰ä¸œè¥¿éƒ½èƒ½æ”¹å˜ä½ çš„æ„Ÿå—ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸è¦æŠŠå¸Œæœ›æ”¾åœ¨å¦‚æ­¤ä¸ç¨³å®šçš„ä¸œè¥¿ä¸Šã€‚ä»»ä½•äº‹ç‰©èƒ½æˆä¸ºåŸºç¡€çš„ç¬¬ä¸€åŸåˆ™å°±æ˜¯å®ƒå¿…é¡»ç‰¢å›ºå¯é ã€‚\næˆ‘ä»¬æ— æ³•åšåˆ°æ¯æ¬¡éƒ½æ„¿æ„æ¿€å‘åŠ¨åŠ› é—®é¢˜åœ¨äºï¼ŒåŠ¨åŠ›æ˜¯å¾ˆéš¾æˆ–è€…è¯´å‡ ä¹ä¸å¯èƒ½æŒ‰éœ€åŸ¹å…»çš„ã€‚æˆ‘ä»¬åªæœ‰åœ¨ç²¾åŠ›å……æ²›ã€æ€ç»´æ¨¡å¼å¥åº·ã€æ²¡æœ‰å—åˆ°å…¶ä»–å¼ºçƒˆè¯±æƒ‘çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‰èƒ½ä¾é åŠ¨åŠ›æˆåŠŸã€‚\nä½ æ ¹æœ¬ä¸æƒ³è®©è‡ªå·±æƒ³è®©è‡ªå·±æƒ³é”»ç‚¼ã€‚å¾ˆå¤šæ—¶å€™ï¼Œä½ ç§¯èšåŠ¨åŠ›åªæ˜¯ä¸ºäº†è®©è‡ªå·±æœ‰åŠ¨åŠ›æ¿€å‘åŠ¨åŠ›è€Œå·²ã€‚ç”Ÿæ´»ä¸­æ€»æœ‰é‚£ä¹ˆå‡ æ¬¡ï¼Œä½ ä¸æ„¿æ„ä¸ºäº†æ¿€å‘åŠ¨åŠ›è€Œæ¿€å‘åŠ¨åŠ›ã€‚\nâ€œçƒ­æƒ…é€’å‡æ³•åˆ™â€ â€œçƒ­æƒ…é€’å‡æ³•åˆ™â€ä¸æ˜¯ä¸€æ¡çœŸæ­£çš„æ³•åˆ™ï¼Œæ˜¯ä½œè€…åˆ›é€ çš„æœ¯è¯­ã€‚å®ƒæ¯”å¯¹åº”çš„â€œè¾¹é™…æ•ˆç”¨é€’å‡æ³•åˆ™â€æ›´å¥½ç†è§£ã€‚è¿™æ¡ç»æµæ³•åˆ™è®¤ä¸ºï¼Œåƒç¬¬äº”å—æŠ«è¨çš„æ—¶å€™æ„‰æ‚¦æ„Ÿç•¥ä½äºåƒç¬¬å››å—çš„æ—¶å€™ï¼Œåƒç¬¬å››å—çš„æ—¶å€™åˆç•¥ä½äºåƒç¬¬ä¸‰å—çš„æ—¶å€™ã€‚å¯èƒ½ä¸‹é¢è¿™ä¸ªä¾‹å­æ›´å½¢è±¡ï¼Œä¸€ç“¶ä¸‰å—é’±çš„å†°å¯ä¹ç¬¬ä¸€å£è‡³å°‘å€¼ä¸¤å—äº”ã€‚ç”šè‡³æˆ‘è§‰å¾—æ„Ÿæƒ…ç”Ÿæ´»ä¸­çš„æ–°é²œæ„ŸåŒæ ·é€‚ç”¨è¿™ä¸ªæ³•åˆ™ï¼Œæ–°é²œæ„Ÿå°±æ˜¯ä¸€ç§åŠ¨åŠ›ï¼Œç„¶è€Œå¤§éƒ¨åˆ†æƒ…ä¾£æ–°é²œæ„Ÿä¹Ÿåªèƒ½ç»´æŒå‡ ä¸ªæœˆè€Œå·²ã€‚\nä¹ æƒ¯æ˜¯ä¸€ä¸ªæˆ‘ä»¬é€‰æ‹©åšä¸€ä»¶äº‹è€Œåšä¸€ä»¶äº‹çš„è¡Œä¸ºï¼Œè¡ŒåŠ¨å¼€å§‹å‰å’Œç»“æŸåä¸ä¼šå‡ºç°å‰§çƒˆæ³¢åŠ¨ã€‚æœ‰çƒ­æƒ…æ˜¯å¥½äº‹ï¼Œä½†æˆ‘ä»¬åº”è¯¥æŠŠè¿™ç§åŠ¨åŠ›çœ‹ä½œä¸€ç§é¢å¤–å¥–åŠ±ï¼Œè€Œä¸æ˜¯å®æ–½è¡ŒåŠ¨çš„ä¿¡å·ã€‚å³è¡¨ç°æ›´ç¨³å®šå’Œè‡ªåŠ¨çš„åŸºåº•ç¥ç»èŠ‚æŒæ¡æ§åˆ¶æƒã€‚\nä¸ºä»€ä¹ˆæ„å¿—åŠ›èƒ½æ‰“è´¥åŠ¨åŠ›ï¼Ÿ\næœ‰å¿…è¦é‡ç”³ä¸€éï¼ŒåŠ¨åŠ›æ˜¯å¥½ä¸œè¥¿ï¼Œåªæ˜¯ä¸å¯é è€Œå·²ã€‚å€ŸåŠ©æ„å¿—åŠ›ï¼ŒåŠ¨åŠ›ä¼šå˜å¾—æ›´åŠ å¯é ï¼›è€Œä¸”å¦‚æœå…ˆé‡‡å–è¡ŒåŠ¨ï¼Œç»§ç»­è¡ŒåŠ¨çš„åŠ¨åŠ›ä¼šè¢«è¿…é€Ÿæ¿€å‘ã€‚\næ„å¿—åŠ›å¾ˆå¯é  æ„å¿—åŠ›å¯ä»¥è¢«å¼ºåŒ– æ„å¿—åŠ›å¯ä»¥é€šè¿‡è®¡åˆ’æ‰§è¡Œ æ„å¿—åŠ›çš„å·¥ä½œåŸç†\nåšå†³å®šä¹Ÿä¼šæ¶ˆè€—æ„å¿—åŠ› åœ¨åŒä¸€å¤©é‡Œåšè¿‡è‰°éš¾å†³å®šçš„äººåœ¨åæ¥é¢å¯¹è¯±æƒ‘æ—¶å±ˆæœçš„å¯èƒ½æ€§æ›´é«˜ï¼Œè¿™ä½“ç°äº†è‡ªæ§åŠ›çš„ä¸‹é™ã€‚é‡å¤§å†³å®šå’Œæ„å¿—åŠ›ä¼¼ä¹éœ€è¦æ¶ˆè€—åŒæ ·çš„èƒ½é‡ã€‚æ¯”å¦‚ä½ ä¸Šåˆå¼ºè¿«è‡ªå·±å­¦ä¹ äº†å‡ ä¸ªå°æ—¶ï¼Œåœ¨åƒæ™šé¥­æ—¶åœ¨ç‚¸é¸¡å’Œæ›´ä¸ºå¥åº·çš„é¥®é£Ÿä¹‹é—´ä¼šéå¸¸åå‘å‰è€…ï¼Œå‰ææ˜¯å­¦ä¹ å’Œæ§åˆ¶é¥®é£Ÿä½ éƒ½æ²¡æœ‰å…»æˆä¹ æƒ¯çš„å‰æä¸‹ã€‚\næ„å¿—åŠ›æŸè€—çš„äº”ä¸ªæœ€é‡è¦çš„å› ç´  å…ƒåˆ†ææ˜¯ä»æŒ‡å®šä¸»é¢˜çš„ç›¸å…³æ–‡çŒ®ä¸­æå–å‡ºé‡è¦ç»“è®ºçš„è¿‡ç¨‹ã€‚\n2010 å¹´çš„ä¸€é¡¹é’ˆå¯¹è‡ªæˆ‘æŸè€—çš„å…ƒåˆ†æä¸­å‘ç°äº†å¼•èµ·è‡ªæˆ‘æŸè€—çš„äº”ä¸ªæœ€é‡è¦çš„å› ç´ ï¼šåŠªåŠ›ç¨‹åº¦ã€æ„ŸçŸ¥éš¾åº¦ã€æ¶ˆææƒ…ç»ªã€ä¸»è§‚ç–²åŠ³å’Œè¡€ç³–æ°´å¹³ã€‚\næ€»ç»“ä¸€ä¸‹ä¸Šè¿°çš„æœ¬ç« å†…å®¹\næˆ‘ä»¬æ˜¯ç”¨åŠ¨åŠ›æˆ–è€…æ„å¿—åŠ›å¼€å¯æ–°çš„è¡Œä¸ºçš„ï¼ˆéä¹ æƒ¯æ€§ï¼‰ã€‚ åŠ¨åŠ›ä¸å¯é ï¼Œæ‰€ä»¥ä¸èƒ½å……å½“å»ºç«‹ä¹ æƒ¯çš„ç­–ç•¥ã€‚ æ„å¿—åŠ›å¯é ï¼Œä½†å‰ææ˜¯ä½ æ²¡æœ‰æŠŠå®ƒè€—å°½ã€‚ å¼•å‘æ„å¿—åŠ›æŸè€—çš„äº”å¤§é‡è¦å› ç´ ï¼šåŠªåŠ›ç¨‹åº¦ã€æ„ŸçŸ¥éš¾åº¦ã€æ¶ˆææƒ…ç»ªã€ä¸»è§‚ç–²åŠ³å’Œè¡€ç³–æ°´å¹³ã€‚ å¦‚æœæˆ‘ä»¬èƒ½å…‹æœè¿™äº”é¡¹éšœç¢ï¼Œæˆ‘ä»¬å°±åº”è¯¥èƒ½èµ°å‘æˆåŠŸã€‚ 4 å¾®ä¹ æƒ¯ç­–ç•¥ å¡‘é€ ä½ ç”Ÿæ´»çš„ä¸æ˜¯ä½ å¶å°”åšçš„ä¸€ä¸¤ä»¶äº‹ï¼Œè€Œæ˜¯ä½ ä¸€è´¯åšæŒåšçš„äº‹ã€‚ â€”â€”å®‰ä¸œå°¼Â·ç½—å®¾\nä»¥å¾®ä¹ æƒ¯æ–¹å¼è¿ç”¨æ„å¿—åŠ›\nå¾®ä¹ æƒ¯æ˜¯æ€æ ·æœ‰æ•ˆæ¶ˆé™¤æ„å¿—åŠ›çš„äº”å¤§å¨èƒçš„\nåŠªåŠ›ç¨‹åº¦ å¾®ä¹ æƒ¯éœ€è¦éå¸¸å°‘çš„å®é™…åŠªåŠ›ï¼Œè‡ªæˆ‘æŸè€—æå°‘ã€‚\næ„ŸçŸ¥éš¾åº¦ å¾®ä¹ æƒ¯çš„æœ¬è´¨å†³å®šå®ƒå‡ ä¹ä¸ä¼šè®©ä½ åœ¨è¿˜æ²¡åšçš„æ—¶å€™å°±æ„Ÿå—åˆ°å›°éš¾ã€‚ä¸€æ—¦ä½ å¼€å§‹åšä¸”èƒ½éšå¿ƒæ‰€æ¬²åœ°ç»§ç»­ä¸‹å»ï¼Œâ€œå·²ç»å¼€å§‹â€å¸¦æ¥çš„å¿ƒç†å½±å“ä¼šè®©æ„ŸçŸ¥éš¾åº¦æ˜æ˜¾é™ä½ã€‚æ­£å¦‚ä»ç‰©ç†å­¦è§’åº¦æ¥çœ‹ï¼Œç‰©ä½“çš„æƒ¯æ€§åœ¨è¿åŠ¨å¼€å§‹æ—¶æœ€å¤§ï¼Œä¸€æ—¦ç‰©ä½“å¤„äºè¿åŠ¨çŠ¶æ€ï¼Œå› ä¸ºå­˜åœ¨åŠ¨é‡ï¼Œä¸€åˆ‡éƒ½ä¼šå˜å¾—ç®€å•ã€‚\nå¾ˆå¤šæ—¶å€™æˆ‘ä»¬æ— æ³•åšæŒåšæŸä»¶äº‹çš„æ—¶å€™éƒ½æ˜¯å› ä¸ºåœ¨ä¸€å¼€å§‹å°±æ„Ÿå—åˆ°äº†å¾ˆå¤§çš„éš¾åº¦ï¼Œæ‰€ä»¥æœ‰äº†è¿™æ ·çš„æƒ³æ³•ï¼šå¦‚æœæœ€ç»ˆåšä¸åˆ°ï¼Œæˆ‘ä»¬å®å¯ä¸å¼€å§‹ã€‚\næ¶ˆææƒ…ç»ª å³ä½¿å¾®ä¹ æƒ¯å ç”¨äº†ä¸€ä»¶æœ¬åº”ä½¿ä½ å¿«ä¹çš„äº‹æƒ…çš„æ—¶é—´ï¼Œä½ è¦åšçš„åŠªåŠ›ä¹Ÿéå¸¸å°‘ï¼Œæ‰€ä»¥å‡ ä¹æ„Ÿå—åˆ°æ¶ˆææƒ…ç»ªã€‚ä½•å†µé€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½ä¼šç”¨æœ‰ç›Šçš„è¡Œä¸ºå–ä»£æµªè´¹æ—¶é—´çš„è¡Œä¸ºï¼Œè¿™ä¸ªè¿‡ç¨‹æœ¬èº«å°±ä¼šå¸¦æ¥ç§¯ææƒ…ç»ªã€‚\nä¸»è§‚ç–²åŠ³ è¿™ä¸ªå› ç´ å¾ˆæœ‰æ„æ€ï¼Œä¸æ˜¯â€œç–²åŠ³â€ï¼Œè€Œæ˜¯â€œä¸»è§‚ç–²åŠ³â€ï¼Œå°±æ˜¯è¯´æˆ‘ä»¬åœ¨è¯„ä¼°è‡ªå·±çš„ç–²åŠ³ç¨‹åº¦æ—¶å¹¶ä¸æ˜¯å®Œå…¨å®¢è§‚çš„ã€‚é€šå¸¸æ›´éš¾çš„ä»»åŠ¡åœ¨å¼€å§‹å‰å°±ä¼šæ„Ÿå—åˆ°å¾ˆå¤§çš„å‹è¿«æ„Ÿã€‚\né‡‡ç”¨å¾®ä¹ æƒ¯ç­–ç•¥çš„ç»“æœï¼šä¸»ç®¡ç–²åŠ³æ— æ³•å½»åº•æ¶ˆé™¤ï¼Œä½†æ˜¯å¾®ä¹ æƒ¯å¯ä»¥æœ‰æ•ˆç¼“è§£ä¸»è§‚ç–²åŠ³ã€‚\nè¡€ç³–æ°´å¹³ è‘¡è„ç³–æ˜¯äººä½“é¦–è¦çš„èƒ½é‡æ¥æºã€‚å¦‚æœè¡€æ¶²ä¸­è‘¡è„ç³–çš„å«é‡å˜ä½ï¼Œä½ ä¼šæ„Ÿè§‰ç–²æƒ«ã€‚\né‡‡ç”¨å¾®ä¹ æƒ¯ç­–ç•¥ï¼Œä½ æ— éœ€åŠ¨ç”¨å‰é¢çš®å±‚å»åšä¸€äº›é‡å¤§å†³å®šï¼Œæˆ–è€…æ¶ˆè€—å¾ˆå¤šæ„å¿—åŠ›ï¼Œè¿™æœ‰åŠ©äºä¿æŒæˆ‘ä»¬çš„è¡€ç³–æ°´å¹³ã€‚\nå¾®ä¹ æƒ¯å¦‚ä½•æ‹“å®½ä½ çš„èˆ’é€‚åŒº\nä½ ç°åœ¨æœ‰ä¸€ä¸ªå¿ƒç†èˆ’é€‚åŒºï¼ˆcomfort zoneï¼‰ï¼ŒæŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªåœ†åœˆã€‚åœ†åœˆå†…æ˜¯å½“ä¸‹çš„æˆ‘ä»¬ï¼Œåœ†åœˆå¤–åˆ™æ˜¯æˆ‘ä»¬æƒ³è¦è¾¾åˆ°çš„ç›®æ ‡ï¼Œä¹Ÿè®¸æ˜¯èº«æå˜å¥½ï¼Œè¯»å®Œäº†å‡ æœ¬ä¹¦ï¼Œå­¦ä¼šäº†æŸé¡¹æŠ€èƒ½ã€‚ä½†æ˜¯è¿™äº›ç›®æ ‡éƒ½è¦ç»å†ä¸€äº›ä¸å¤ªèˆ’é€‚çš„è¿‡ç¨‹æ‰èƒ½å®ç°ï¼ˆå› ä¸ºè„±ç¦»äº†åŸºåº•ç¥ç»èŠ‚ç›®å‰çš„æ¨¡å¼ï¼‰ã€‚\né€šå¸¸æˆ‘ä»¬é‡‡å–â€œåªè¦èƒ½æˆåŠŸæ€ä¹ˆåšéƒ½è¡Œâ€ï¼Œç„¶åå¼€å§‹å¤§é‡è¡ŒåŠ¨ï¼Œæˆ‘ä»¬å…¨åŠ›å†²åˆºåˆ°èˆ’é€‚åŒºå¤–è¾¹ï¼Œæ‹¼å‘½æŒ£æ‰æƒ³è¦ç•™åœ¨é‚£é‡Œï¼Œæ­¤æ—¶æˆ‘ä»¬çš„æ½œæ„è¯†ï¼šâ€œæœ‰æ„æ€ï¼Œä½†æ˜¯è¿™ä¹ˆå‰§çƒˆçš„å˜åŒ–è®©æˆ‘å¾ˆä¸èˆ’æœâ€ï¼Œå½“æˆ‘ä»¬çš„åŠ¨åŠ›å’Œæ„å¿—åŠ›ä¸è¶³ä»¥æ”¯æ’‘æ—¶ï¼Œæˆ‘ä»¬ä¼šè¢«æ‹½å›åˆ°èˆ’é€‚åœˆå†…ã€‚\nè€Œå¾®ä¹ æƒ¯å°±åƒæ˜¯èµ°åˆ°åœ†åœˆçš„è¾¹ç¼˜ï¼Œè½»è½»å¾€å¤–èµ°ä¸€å°æ­¥ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥èµ°ä¸€å°æ­¥åé€€å›åˆ°èˆ’é€‚åœˆï¼Œæ½œæ„è¯†ä¸ä¼šå¯¹è¿™ä¹ˆå¾®å°çš„æ”¹å˜çš„åšå‡ºå¤ªå¤§ååº”ï¼Œä½†æ˜¯é•¿æ­¤ä»¥å¾€ï¼Œèˆ’é€‚åœˆå°±ä¼šè¢«æˆ‘ä»¬æ‰©å¤§ã€‚\næˆ‘ä»¬å¶å°”ä¼šè¶…é¢å®Œæˆç›®æ ‡ï¼Œå¯ä»¥ç”¨åŸºç¡€ç‰©ç†å­¦çŸ¥è¯†æ¥è§£é‡Šã€‚ç‰›é¡¿ç¬¬ä¸€è¿åŠ¨å®šå¾‹çš„å†…å®¹åŒ…æ‹¬ï¼š\né™¤éå—åˆ°å¤–åŠ›ä½œç”¨ï¼Œå¦åˆ™é™æ­¢çš„ç‰©ä½“æ€»ä¿æŒé™æ­¢çŠ¶æ€ é™¤éå—åˆ°å¤–åŠ›ä½œç”¨ã€‚å¦åˆ™å‡ºäºè¿åŠ¨çŠ¶æ€ä¸­çš„ç‰©ä½“çš„é€Ÿåº¦ä¸ä¼šæ”¹å˜ã€‚ æˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªæ–°ç­‰å¼ï¼šä¸€å°æ­¥ + æƒ³åšçš„äº‹ = è¾ƒé«˜çš„è¿›ä¸€æ­¥è¡ŒåŠ¨çš„å¯èƒ½æ€§\n5 å¾®ä¹ æƒ¯çš„ç‹¬ç‰¹ä¹‹å¤„ æ˜¯æ•…èƒœå…µå…ˆèƒœè€Œåæ±‚æˆ˜ï¼Œè´¥å…µå…ˆæˆ˜è€Œåæ±‚èƒœã€‚ â€”â€”å­™å­ï¼Œã€Šå­™å­å…µæ³•ã€‹\nå¾®ä¹ æƒ¯èƒ½ä¸ç°æœ‰ä¹ æƒ¯ä¸€è¾ƒé«˜ä¸‹\nåŸ¹å…»ä¸€ä¸ªæ–°ä¹ æƒ¯ä¹Ÿæ˜¯å¯¹ä¹‹å‰æˆ‘ä»¬å…»æˆçš„ä¸€äº›ä¹ æƒ¯çš„æŒ‘æˆ˜ï¼Œæˆ‘ä»¬éœ€è¦æ‘’å¼ƒä¸€äº›æ›¾ç»ä¸å¥½çš„ä¹ æƒ¯ï¼Œä»¥è®©æ›´å¥½çš„è¡Œä¸ºä»£æ›¿å®ƒã€‚å¤§è„‘ä¼šæŠ—æ‹’å¤§å¹…åº¦çš„æ”¹å˜ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä»¥æå…¶å¾®å°çš„è¡Œä¸ºåšå‡ºä¸€ç‚¹ç‚¹æ”¹å˜ï¼Œæ½œç§»é»˜åŒ–çš„å½±å“æˆ‘ä»¬çš„å¤§è„‘ï¼Œè®©æ–°çš„è¡Œä¸ºæˆä¸ºåŸºåº•ç¥ç»èŠ‚çš„ä¸€ç§æ¨¡å¼ã€‚\nå¾®ä¹ æƒ¯æ²¡æœ‰æˆªæ­¢æ—¶é—´\nå¾ˆå¤šå°†å¿ƒç†å­¦ã€è¡Œä¸ºå­¦æˆ–è€…å…¶ä»–å°è¯•å¸®åŠ©ä½ å…»æˆå¥½ä¹ æƒ¯çš„ä¹¦ç±éƒ½æ˜¯åŸºäºâ€œä¹ æƒ¯æ˜¯ 21 å¤©æˆ–è€… 30 å¤©å…»æˆçš„â€è¿™ä¸ªç†è®ºï¼Œè€Œå¾®ä¹ æƒ¯æ²¡æœ‰æ˜ç¡®çš„æˆªæ­¢æ—¶é—´ï¼Œå®ƒè¦æ±‚å°½å¯èƒ½ä¸€å¤©éƒ½ä¸èƒ½è½ä¸‹ï¼Œé•¿ä¹…åœ°åšæŒã€‚ä½†æ˜¯ä¸åƒå…¶ä»–æ–¹æ³•è¦æ±‚ä½ æ¯å¤©å¥èº«ä¸€å°æ—¶æˆ–è€…è¯»ä¸€ä¸ªå°æ—¶çš„ä¹¦ï¼Œæˆ‘ä»¬è¦åšçš„åªæ˜¯å¾ˆå°å¾ˆå°çš„ä¸€éƒ¨åˆ†ï¼Œä¾‹å¦‚è¯» 2 é¡µä¹¦å°±å¥½ï¼Œåªæ˜¯è¿™æ ·ã€‚\nå¾®ä¹ æƒ¯å¯ä»¥æå‡è‡ªæˆ‘æ•ˆèƒ½æ„Ÿ\nå¤§å¤šæ•°äººéƒ½æˆå°è¯•è¿‡æŠŠä¸€ä¸ªè‰¯å¥½çš„è¡Œä¸ºå…»æˆä¹ æƒ¯ï¼Œç„¶åç”±äºå„ç§å„æ ·çš„åŸå› æ²¡æœ‰åšæŒä¸‹æ¥ï¼Œè¿™ä¼šä½¿æˆ‘ä»¬ç¼ºä¹åŸºæœ¬çš„è‡ªæˆ‘æ•ˆèƒ½æ„Ÿã€‚\nå¾®ä¹ æƒ¯æ­£æ˜¯é‡æ–°å¼€å§‹çš„å®Œç¾æ–¹æ³•ã€‚ä½ ä¸ä¼šå†è¢«å·¨å¤§çš„ç›®æ ‡æ‰“å®ï¼Œä¹Ÿä¸ä¼šå› ä¸ºç›®æ ‡æœªå®ç°å¸¦æ¥çš„å†…ç–šæ„Ÿæ„Ÿåˆ°ç„¦è™‘ç…ç†¬ã€‚è¿™ä¸€æ¬¡ï¼Œä½ æ¯å¤©éƒ½èƒ½æˆåŠŸã€‚è¿™äº›èƒœåˆ©ä¹Ÿè®¸å¾®ä¸è¶³é“ï¼Œä½†æ˜¯å¯¹äºä¸€é¢—å¿ƒç°æ„å†·çš„å¿ƒæ¥è¯´æ˜¯è‡³å…³é‡è¦çš„ã€‚\nå¾®ä¹ æƒ¯å¸®ä½ åŸ¹å…»æ­£å¿µå’Œæ„å¿—åŠ›\næ­£å¿µæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æŠ€èƒ½ï¼Œå®ƒæŒ‡çš„æ˜¯æˆ‘ä»¬å¯¹äºè‡ªå·±çš„æ€ç»´å’Œè¡ŒåŠ¨æœ‰æ¸…é†’çš„è®¤çŸ¥ã€‚æ­£å¿µæ˜¯ç›®æ ‡æ¸…æ™°åœ°æ´»ç€å’Œæ•·è¡æ´»ç€ä¹‹é—´çš„åŒºåˆ«ã€‚å¦‚æœä½ çš„å¾®ä¹ æƒ¯æ˜¯æ¯å¤©èµ·åºŠåå–ä¸€æ¯æ°´ï¼Œé‚£ä¹ˆä½ å°±ä¼šå¯¹è‡ªå·±æ€»å…±å–äº†å¤šå°‘æ°´æœ‰æ‰€è®¤çŸ¥ï¼Œå¦‚æœæ˜¯æ¯å¤©çœ‹ä¸¤é¡µä¹¦ï¼Œé‚£ä¹ˆä½ å°±ä¼šæ—¶å¸¸æƒ³è‡ªå·±å·²ç»çœ‹å®Œäº†å¤šå°‘ä¹¦ã€‚\nå‰æ–‡æè¿‡æ„å¿—åŠ›æ˜¯ä¸€é¡¹éå¸¸å®è´µçš„èµ„æºï¼Œè€Œå¾®ä¹ æƒ¯æ˜¯ä¸€é¡¹é¢‘ç¹é‡å¤å°ä»»åŠ¡çš„è¡Œä¸ºï¼Œè¿™æ˜¯é”»ç‚¼æ„å¿—åŠ›çš„ä¸€ä¸ªç»ä½³æ–¹æ³•ã€‚\n6 å½»åº•æ”¹å˜åªéœ€è¦å…«æ­¥ ä¸€ä¸ªå¾—ä¸åˆ°æ‰§è¡Œçš„å¿µå¤´åªä¼šæ¶ˆäº¡ â€”â€”ç½—æ°Â·å†¯Â·æ¬§å…‹\nç¬¬ä¸€æ­¥ï¼šé€‰æ‹©é€‚åˆè‡ªå·±çš„å¾®ä¹ æƒ¯å’Œè®¡åˆ’\né€‰æ‹©é€‚åˆè‡ªå·±çš„å¾®ä¹ æƒ¯\nå¯ä»¥æ˜¯ä¸€ä¸ªæ¯å¤©éƒ½è¦åšçš„äº‹æƒ…ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ—¶é—´æ®µçš„å¼¹æ€§è®¡åˆ’ï¼Œæ¯”å¦‚ä¸€å‘¨è·‘æ­¥ä¸‰æ¬¡\næŠŠä¹ æƒ¯å˜æˆä¸€ä¸ªå°åˆ°ä¸å¯æ€è®®çš„ä¸€æ­¥\næ¯”å¦‚æŠŠæ¯å¤©åš 20 ä¸ªä¿¯å§æ’‘æ”¹æˆ 1 ä¸ª\nç¬¬äºŒæ­¥ï¼šæŒ–æ˜æ¯ä¸ªå¾®ä¹ æƒ¯çš„å†…åœ¨ä»·å€¼\næˆ‘ä»¬å¾ˆå¤šæ—¶å€™æ— æ³•å…»æˆä¹ æƒ¯çš„åŸå› åœ¨äºæˆ‘ä»¬æƒ³åšä¸€ä»¶äº‹ï¼Œä½†ä¸ºè¦ä¸è¦åšè¿™ä»¶äº‹è€Œè‹¦æ¼ã€‚å¯ä»¥åæ€ä¸€ä¸‹æˆ‘ä»¬åœ¨ç¬¬ä¸€æ­¥åˆ¶å®šçš„ä¹ æƒ¯ï¼Œä¸€èˆ¬éƒ½æ˜¯æˆ‘ä»¬é•¿æœŸä»¥æ¥æ½œæ„è¯†é‡Œè§‰å¾—æ­£ç¡®çš„äº‹æƒ…ï¼Œå´ä¸€ç›´ç¼ºä¹åŠ¨åŠ›æˆ–è€…ä¸é‚£ä¹ˆç†è§£è¿™é¡¹è¡Œä¸ºèƒ½ç»™æˆ‘ä»¬å¸¦æ¥ä»€ä¹ˆã€‚\nç”¨â€œä¸ºä»€ä¹ˆé’»å¤´â€æ¥æŒ–æ˜ä¸€ä¸‹ï¼š\næˆ‘æƒ³æ¯å¤©è¯»ä¸¤é¡µä¹¦ã€‚ä¸ºä»€ä¹ˆï¼Ÿ å› ä¸ºè¯»ä¹¦å‡ ä¹ä¸€ç›´ä»¥æ¥éƒ½æ˜¯æˆåŠŸäººå£«çš„æ ‡é…ã€‚ä¸ºä»€ä¹ˆï¼Ÿ å› ä¸ºè¯»ä¹¦æ˜¯äººä»¬æ±²å–çŸ¥è¯†ã€æ‹“å®½è§†é‡æå¥½çš„é€”å¾„ã€‚ä¸ºä»€ä¹ˆï¼Ÿ å› ä¸ºè¯»ä¹¦å¯ä»¥ç»ƒå°±è…¹æœ‰è¯—ä¹¦æ°”è‡ªåå’Œæ²‰ç¨³çš„æ°”è´¨ï¼Œè€Œè¿™ä¸¤ç‚¹æ­£æ˜¯ç›®å‰çš„æˆ‘æå…¶æ¸´æ±‚çš„ã€‚ ç¬¬ä¸‰æ­¥ï¼šæ˜ç¡®ä¹ æƒ¯ä¾æ®ï¼Œå°†å…¶çº³å…¥æ—¥ç¨‹\nåŸ¹å…»ä¹ æƒ¯çš„å¸¸è§ä¾æ®æœ‰ä¸¤ä¸ªï¼šæ—¶é—´å’Œè¡Œä¸ºæ–¹å¼ã€‚å¯¹äºæœä¹æ™šäº”æ—¶é—´æ¯”è¾ƒè§„å¾‹çš„äººç¾¤ï¼Œæ›´æ¨èæ ¹æ®æ—¶é—´æ–¹å¼ä½œä¸ºä¾æ®ï¼Œæ—¥ç¨‹æ¯”è¾ƒçµæ´»çš„å¯ä»¥ä½¿ç”¨è¡Œä¸ºæ–¹å¼ä½œä¸ºä¾æ®ã€‚\næ—¶é—´ï¼šæ¯å‘¨ä¸€ä¸‰äº”çš„ä¸‹åˆ 3 ç‚¹é”»ç‚¼ è¡Œä¸ºæ–¹å¼ï¼šåƒå®Œæ™šé¥­ååŠä¸ªå°æ—¶å¼€å§‹è¯»ä¹¦ ä¹Ÿæœ‰ç¬¬ä¸‰ç§è‡ªç”±åº¦æ›´é«˜çš„æ–¹å¼ï¼Œæˆ‘ä»¬åœ¨å½“å¤©ä»»æ„æ—¶é—´å®Œæˆéƒ½å¯ä»¥ï¼Œæœ€ä½é™åº¦æ˜¯ç¡è§‰å‰ã€‚\nç¬¬å››æ­¥ï¼šå»ºç«‹å›æŠ¥æœºåˆ¶ï¼Œä»¥å¥–åŠ±æå‡æˆå°±æ„Ÿ\nä¸€ä¸ªæœ‰è¶£çš„ç°è±¡ï¼šä¸€ä¸ªç”³è¯·å‡é‡Šçš„çŠ¯äººï¼Œå‡é‡Šå¬è¯ä¼šçš„æœ€ä½³æ—¶é—´æ˜¯åœ¨å‡é‡Šå®˜åƒå®Œä¸œè¥¿ã€ç»“æŸä¼‘æ¯ä¹‹åï¼Œå› ä¸ºç ”ç©¶å‘ç°å‡é‡Šå®˜åœ¨åƒé¥±ç¡å¥½ä¹‹ååšå‡ºçš„åˆ¤å†³å¯¹è¢«å‘Šæ›´æœ‰åˆ©ï¼ˆå¤§æ¦‚æ˜¯å› ä¸ºä»–ä»¬æ›´æ„¿æ„å€¾å¬ï¼‰ã€‚\næ‹¿é”»ç‚¼æ¥ä¸¾ä¾‹ï¼Œé”»ç‚¼å¯ä»¥è®©ä½ è·å¾—å¥åº·çš„ä½“é­„ï¼Œè‰¯å¥½çš„èº«æã€‚ä½†æ˜¯ä½ åˆšå¼€å§‹é”»ç‚¼çš„æ—¶å€™ï¼Œé”»ç‚¼ç»“æŸåå›åˆ°å®¶é‡Œä½ æ”¶è·åˆ°çš„å›æŠ¥æ˜¯ä»€ä¹ˆï¼Ÿæ±—æ°´ï¼Ÿäºæ­¤åŒæ—¶ï¼Œä½ çš„å¤§è„‘å´ç°åœ¨å°±æƒ³åƒç‚¸é¸¡ï¼Œå› ä¸ºç³–ä¼šåˆºæ¿€å‘³è•¾å¹¶æ¿€æ´»å¤§è„‘çš„å›æŠ¥ä¸­å¿ƒï¼Œæ‰€ä»¥ç‚¸é¸¡æ˜¯ä¸€ç§æ„Ÿå®˜ï¼ˆé¦–è¦ï¼‰å›æŠ¥ï¼Œè€Œé”»ç‚¼å¸¦æ¥çš„æ˜¯æŠ½è±¡ï¼ˆæ¬¡è¦ï¼‰å›æŠ¥ï¼Œæ¯”å¦‚æ‹¥æœ‰å¥½èº«æåœ¨æ²™æ»©ä¸Šæ¼«æ­¥ã€å¯¹ä»˜å‡ºçš„åŠªåŠ›æ„Ÿåˆ°æ»¡æ„ã€‚æ¬¡çº§å›æŠ¥éœ€è¦æ›´é•¿çš„æ—¶é—´æ‰èƒ½åœ¨å¤§è„‘ç«™ç¨³è„šè·Ÿã€‚\nåœ¨ä¸€å¼€å§‹é”»ç‚¼äº§ç”Ÿçš„å†…å•¡è‚½å’ŒæœŸæœ›äº§ç”Ÿçš„å›æŠ¥å·®è·è¿‡å¤§æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç»™è‡ªå·±ä¸€äº›å¥–åŠ±ç­–ç•¥ï¼Œæ¯”å¦‚æŒ‘é€‰ä¸€ä¸ªæƒ³ä¹°çš„ä¸œè¥¿åŠ å…¥è´­ç‰©è½¦ï¼Œåœ¨è·‘æ­¥ä¸€ä¸ªæœˆåæŠŠå®ƒä¹°ä¸‹æ¥ã€å¦‚æœèƒ½åšæŒåˆ°ä¸¤ä¸ªæœˆå°±ç»™è‡ªå·±ä¹°ä¸€å—ä¸“ä¸šçš„è¿åŠ¨æ‰‹è¡¨ï¼ˆæ¯”å¦‚æˆ‘ç»™è‡ªå·±ä¹°çš„é«˜é©° pace2ï¼‰ã€‚\nè¿™åƒæ˜¯æ•™å°å­©éª‘è‡ªè¡Œè½¦ï¼Œä¸€å¼€å§‹æˆ‘ä»¬éœ€è¦å‘å­©å­ä¿è¯ä¼šæ‰¶ç€è‡ªè¡Œè½¦ï¼Œå¯æ˜¯åœ¨æŸä¸ªæ—¶å€™æˆ‘ä»¬æŠŠæ‰‹æ¾å¼€åï¼Œå­©å­ä¸éœ€è¦æ‰¶æŒä¹Ÿèƒ½ç»§ç»­éª‘è½¦äº†\nç¬¬äº”æ­¥ï¼šè®°å½•ä¸è¿½è¸ªæƒ…å†µ\né—å¿˜æ˜¯äººç±»çš„å¤©æ€§ã€‚åœ¨ä¸€é¡¹ä¹ æƒ¯çš„å‰æœŸé˜¶æ®µï¼Œé—å¿˜ä¹Ÿæ˜¯ä¸€ä¸ªé˜»åŠ›ï¼Œæˆ‘ä»¬å¶å°”ä¼šå¿˜è®°æˆ‘ä»¬ç»™è‡ªå·±åˆ¶å®šçš„è®¡åˆ’ã€‚æ‰€ä»¥é‡‡å–ä¸€äº›ç­–ç•¥æ¥æé†’æˆ‘ä»¬è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚\næ–¹å¼ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯å¯ä»¥æœ‰æ•ˆåœ°æé†’æˆ‘ä»¬ã€‚å¦‚æœä½ æœ‰çœ‹æ—¥å†çš„ä¹ æƒ¯ï¼Œå°±æŠŠè¦åšçš„äº‹æƒ…å†™åˆ°ä¾¿ç­¾ä¸Šæ”¾åˆ°æ—¥å†æ—è¾¹ï¼›å¦‚æœä½ æ¯å¤©éƒ½ä½¿ç”¨ç”µè„‘ï¼Œå¯ä»¥æŠŠä¾¿ç­¾ç²˜åˆ°æ˜¾ç¤ºå™¨ä¸‹é¢ã€‚æ‰‹æœºé—¹é’Ÿã€ä¸€äº›å¸¦æœ‰æé†’åŠŸèƒ½çš„ APP ç­‰ç­‰éƒ½å¯ä»¥ã€‚\nç¬¬å…­æ­¥ï¼šå¾®é‡å¼€å§‹ï¼Œè¶…é¢å®Œæˆ\næˆ‘ä»¬åœ¨å®Œæˆå¾®ä¹ æƒ¯æ—¶æ¶ˆè€—çš„æ˜¯æ„å¿—åŠ›ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨è¾¾æˆç›®æ ‡åç»§ç»­åŠªåŠ›æ—¶åŠ¨åŠ›å°±ä¼šå¼€å§‹èµ·ä½œç”¨äº†ã€‚\nå½“ä½ ä¸€æ—¦å¼€å§‹ï¼Œå°±ä¼šå¸Œæœ›å¤šå®Œæˆä¸€äº›ã€‚åˆ°é‚£ä¸ªæ—¶å€™ï¼Œç»§ç»­åšå’Œåœä¸‹æ¥ä¸€æ ·å®¹æ˜“ã€‚\nç¬¬ä¸ƒæ­¥ï¼šæœä»è®¡åˆ’å®‰æ’ï¼Œæ‹œæ‰˜é«˜æœŸå¾…å€¼\nåœ¨ç¬¬ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬å·²ç»æŠŠä¹ æƒ¯çš„éš¾åº¦å®šçš„éå¸¸ä½äº†ï¼Œæ‰€ä»¥è¶…é¢å®Œæˆæ˜¯å¾ˆå¹³å¸¸çš„äº‹æƒ…ï¼Œæ­£å¦‚ä¹‹å‰è¯´åˆ°çš„ï¼Œè¯·æŠŠå®ƒä½œä¸ºä¸€ä¸ªå¥–åŠ±ï¼Œä¸è¦æŠŠè¶…é¢å®Œæˆçš„éƒ¨åˆ†ä½œä¸ºä½ ä»Šåæ¯å¤©çš„ç›®æ ‡ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå±é™©çš„è¡Œä¸ºã€‚è¯»å®Œä¸¤é¡µä¹¦å°±æ˜¯æˆåŠŸï¼Œå¥å·ï¼\nä¸¾ä¸ªä¾‹å­ï¼šä½ è¿ç»­åŠä¸ªæœˆæ¯å¤©éƒ½è¯»äº† 30 é¡µä¹¦ï¼Œè€Œä¸æ˜¯ 2 é¡µä¹¦ï¼Œäºæ˜¯ç†æ‰€å½“ç„¶çš„æŠŠå¾®ä¹ æƒ¯æ”¹ä¸ºäº†æ¯å¤©è¯» 30 é¡µä¹¦ï¼Œä½†æ˜¯ä¸€æ—¦æŸå¤©çŠ¶æ€ä¸ä½³æˆ–è€…å› ä¸ºä¸€äº›å…¶ä»–å› ç´ å¯¼è‡´æ²¡æœ‰å®Œæˆ 30 é¡µä¹¦çš„ç›®æ ‡ï¼Œä½ å»ºç«‹èµ·æ¥çš„è‡ªä¿¡ä¼šå—æŒ«ã€‚ä¸è¦å˜´ä¸Šè¯´ç€è¯» 2 é¡µä¹¦å°±å¥½ï¼Œå¿ƒé‡Œå´æŠŠ 30 é¡µä¹¦ä½œä¸ºç›®æ ‡ã€‚ä¸è¦å¿˜è®°ä½ æ˜¯å¦‚ä½•åšåˆ°è¯» 30 é¡µä¹¦çš„ï¼ˆæ˜¯ä»æ¯å¤© 2 é¡µä¹¦å¼€å§‹çš„ï¼‰ã€‚\nåšæŒåšä¸€ä»¶å°äº‹ï¼Œæ¯”å¶å°”åšä¸€ä»¶å¤§äº‹èƒ½ä»æ ¹æœ¬ä¸Šæ”¹å˜æ›´å¤šã€‚\nå¾®ä¹ æƒ¯ç­–ç•¥çš„æ‰€æœ‰ç›Šå¤„ã€åŠ›é‡å’Œä¼˜åŠ¿éƒ½å–å†³ä¸ä½ åœ¨çº¸é¢ä¸Šå’Œå¿ƒé‡Œå§‹ç»ˆéƒ½å°†ç›®æ ‡ä¿æŒåœ¨å¾®å°çŠ¶æ€çš„èƒ½åŠ›ã€‚\nå¾®ä¹ æƒ¯ç­–ç•¥çš„æ‰€æœ‰ç›Šå¤„ã€åŠ›é‡å’Œä¼˜åŠ¿éƒ½å–å†³ä¸ä½ åœ¨çº¸é¢ä¸Šå’Œå¿ƒé‡Œå§‹ç»ˆéƒ½å°†ç›®æ ‡ä¿æŒåœ¨å¾®å°çŠ¶æ€çš„èƒ½åŠ›ã€‚\nå¾®ä¹ æƒ¯ç­–ç•¥çš„æ‰€æœ‰ç›Šå¤„ã€åŠ›é‡å’Œä¼˜åŠ¿éƒ½å–å†³ä¸ä½ åœ¨çº¸é¢ä¸Šå’Œå¿ƒé‡Œå§‹ç»ˆéƒ½å°†ç›®æ ‡ä¿æŒåœ¨å¾®å°çŠ¶æ€çš„èƒ½åŠ›ã€‚\nç¬¬å…«æ­¥ï¼šä¹ æƒ¯å…»æˆçš„æ ‡å¿—\nä»£è¡¨è¡Œä¸ºå·²ç»æˆä¸ºä¹ æƒ¯çš„ä¿¡å·ï¼š\næ²¡æœ‰æŠµè§¦æƒ…ç»ªï¼šè¯¥è¡Œä¸ºä¼¼ä¹åšèµ·æ¥å®¹æ˜“ï¼Œä¸åšåè€Œæ›´éš¾ èº«ä»½ï¼šä½ æ‰“å¿ƒåº•è®¤åŒè¯¥è¡Œä¸ºï¼Œå¯ä»¥ä¿¡å¿ƒåè¶³åœ°è¯´â€œæˆ‘æ˜¯ä¸ªè·‘è€…â€ è¡ŒåŠ¨æ—¶æ— éœ€è€ƒè™‘ï¼šä¸éœ€è¦åšä»»ä½•å†³å®šï¼Œè‡ªç„¶è€Œç„¶åœ°å»åšã€‚ ä½ ä¸å†æ‹…å¿ƒï¼šä½ çŸ¥é“ä½ ä¼šä¸€ç›´åšè¿™ä»¶äº‹ã€‚ å¸¸æ€åŒ–ï¼šä¹ æƒ¯æ˜¯éæƒ…ç»ªåŒ–çš„ã€‚ä½ å¼€å§‹ä½ çš„å¾®ä¹ æƒ¯æ—¶æ²¡æœ‰ä»»ä½•æƒ…ç»ªæ³¢åŠ¨ï¼Œè€Œä¸ä¼šå› ä¸ºä½ æ­£åœ¨åšè¿™ä»¶äº‹è€Œâ€œæ¿€åŠ¨ä¸å·²â€ å®ƒå¾ˆæ— èŠï¼šå¥½çš„ä¹ æƒ¯å¹¶ä¸ä¼šè®©äººå¾ˆå…´å¥‹ï¼Œå®ƒåªæ˜¯å¯¹ä½ æœ‰å¥½å¤„è€Œå·²ã€‚ä½ ä¼šå› ä¸ºå®ƒä»¬å¯¹ç”Ÿæ´»æ›´æœ‰æ¿€æƒ…ï¼Œä½†ä¸æ˜¯å¯¹è¡Œä¸ºæœ¬èº«ã€‚ 7 å¾®ä¹ æƒ¯ç­–ç•¥çš„å…«å¤§è§„åˆ™ 1. ç»å¯¹ä¸è¦è‡ªæ¬ºæ¬ºäºº\næ¯”å¦‚è§‰å¾—æŸé¡¹å¾®ä¹ æƒ¯å¤ªå°ï¼Œè§‰å¾—å¶å°”ä¸€å¤©ä¸åšä¹Ÿæ²¡ä»€ä¹ˆï¼›æˆ–è€…ç»™è‡ªå·±åˆ¶å®šçš„å¾®ä¹ æƒ¯æ˜¯æ¯å¤©ä¸€ä¸ªä¿¯å§æ’‘ï¼Œå´åœ¨å¿ƒé‡Œå·å·è¦æ±‚è‡ªå·±å®Œæˆæ›´å¤šã€‚\n2. æ»¡æ„æ¯ä¸€ä¸ªè¿›æ­¥\nå¯¹å°å°çš„è¿›æ­¥æ„Ÿåˆ°æ»¡æ„å’Œæ ‡å‡†ä½ä¸æ˜¯ä¸€å›äº‹ã€‚æå°é¾™æœ‰ä¸€å¥åè¨€å¯ä»¥å¾ˆå¥½åœ°æ€»ç»“è¿™ä¸€ç‚¹ï¼šâ€œè¦æ»¡æ„ï¼Œä½†åˆ«æ»¡è¶³â€ã€‚\nå¾®ä¹ æƒ¯ç­–ç•¥çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„å¤§è„‘é”™è§‰ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ç§é‡è§†å¼€å§‹çš„ç”Ÿæ´»å“²ç†ï¼Œä¸€ç§è®¤ä¸ºè¡ŒåŠ¨ä¼˜äºåŠ¨åŠ›çš„ç”Ÿæ´»å“²ç†ï¼Œä¸€ç§ç›¸ä¿¡å°†æ¯ä¸€å°æ­¥ç§¯ç´¯èµ·æ¥ä¾¿èƒ½è®©é‡å˜è½¬ä¸ºè´¨å˜çš„ç”Ÿæ´»å“²ç†ã€‚\n3. ç»å¸¸å›æŠ¥è‡ªå·±ï¼Œå°¤å…¶åœ¨å®Œæˆå¾®ä¹ æƒ¯ä¹‹å\nå“ªæ€•åœ¨å®Œæˆå¾®ä¹ æƒ¯ä¹‹åå¯¹è‡ªå·±è¯´â€œä½ å¾ˆæ£’â€è¿™ä¸€ç‚¹å°å°çš„æ¿€åŠ±ï¼Œæœ€ç»ˆéƒ½ä¼šå»ºç«‹ä¸€ä¸ªæ­£åé¦ˆå¾ªç¯ã€‚\n4. ä¿æŒå¤´è„‘æ¸…é†’\nå¯èƒ½åšæŒå‡ ä¸ªæœˆçš„å¾®ä¹ æƒ¯åä½ èƒ½çœ‹åˆ°æ¯”è¾ƒå¤§çš„å˜åŒ–ï¼Œè¿›è€Œè¿‡åº¦å…´å¥‹ï¼Œä½†åˆ«è®©è¿™ç§å…´å¥‹æˆä¸ºä½ å®æ–½è¡ŒåŠ¨çš„åŸåŠ¨åŠ›ã€‚å˜å¾—ä¾èµ–åŠ¨åŠ›æˆ–æƒ…ç»ªæ­£æ˜¯å¯¼è‡´å¾ˆå¤šä¹ æƒ¯æ²¡æœ‰å…»æˆçš„åŸå› ã€‚\nåœ¨å®Œæˆç›®æ ‡çš„è¿‡ç¨‹ä¸­ï¼Œæ— èŠæ‰æ˜¯å¸¸æ€ã€‚ä½¿ç”¨å†·é™çš„å¤´è„‘åˆ†æä½ çš„è¡Œä¸ºã€‚\n5. æ„Ÿåˆ°å¼ºçƒˆæŠµè§¦æ—¶ï¼Œåé€€å¹¶ç¼©å°ç›®æ ‡\nå¸¸è¯†å‘Šè¯‰æˆ‘ä»¬ï¼Œçªç ´æ‰èƒ½è·å¾—è¿›æ­¥ï¼Œç„¶è€Œè¿™åªé€‚ç”¨äºçŸ­æœŸç›®æ ‡ï¼Œæ¯”å¦‚é¡¹ç›®çš„ deadlineï¼Œä½ éœ€è¦é€¼ä¸€é€¼è‡ªå·±æ‰èƒ½å®Œæˆã€‚ä½†æ˜¯å¯¹äºå…»æˆä¸€ä¸ªä¹ æƒ¯æ¥è¯´ï¼Œä¿è¯æˆ‘ä»¬å¯ä»¥é•¿æ—¶é—´çš„åšæŒæ‰æ˜¯æœ€é‡è¦çš„ã€‚\nå¦‚æœä½ ç»™è‡ªå·±åˆ¶å®šçš„è®¡åˆ’è®©ä½ æ„Ÿåˆ°å¾ˆç—›è‹¦ï¼Œä½ éœ€è¦è€ƒè™‘æ˜¯è¿™é¡¹è¡Œä¸ºæœ¬èº«çš„é—®é¢˜è¿˜æ˜¯ç›®æ ‡è®¾ç«‹çš„å¤ªå¤§äº†ã€‚å…»æˆä¹ æƒ¯è¿‡ç¨‹ä¸­æœ‰æŠµè§¦æƒ…ç»ªæ˜¯æ­£å¸¸çš„ï¼Œä½†é‡‡ç”¨å¾®ä¹ æƒ¯ç­–ç•¥æ—¶å‡å¦‚ä½ èƒ½æ„Ÿå—åˆ°æ˜æ˜¾çš„æŠµè§¦æƒ…ç»ªï¼Œé‚£ä¸€å®šè¦ç¼©å°ç›®æ ‡ã€‚\n6. æé†’è‡ªå·±è¿™ä»¶äº‹å¾ˆè½»æ¾\nåœ¨å¾®ä¹ æƒ¯ç­–ç•¥ä¸­ï¼Œä½ å¯¹å®æ–½è¡ŒåŠ¨çš„æŠµè§¦è¡Œä¸ºå¾ˆå¤šæ—¶å€™éƒ½æ˜¯å› ä¸ºè€ƒè™‘çš„å¤ªå®½æ³›ï¼Œæ¯”å¦‚å¥èº«ï¼Œè¿™æ˜¯ä¸€ä¸ªå¬èµ·æ¥å°±æ¯”è¾ƒæœ‰å‹åŠ›çš„è¡Œä¸ºã€‚ä½†æ˜¯ä½ æƒ³æƒ³ä½ ä»Šå¤©è¦åšçš„ä»…ä»…æ˜¯åšä¸€ä¸ªä¿¯å§æ’‘ï¼Œè‡ªç„¶è€Œç„¶ä¼šæ„Ÿå—åˆ°è½»æ¾ã€‚\n7. ç»ä¸è¦å°çœ‹å¾®æ­¥éª¤\næ¯ä¸€ä¸ªå¤§çš„å·¥ç¨‹éƒ½æ˜¯ç”±æ— æ•°ä¸ªå°æ­¥éª¤åšæˆçš„ã€‚æŒç»­åšä¸€ä»¶å¾ˆå°çš„å°äº‹ï¼ŒåšæŒä¸€æ®µæ—¶é—´ï¼Œåæ­£åˆèŠ±ä¸äº†ä½ å¤šé•¿æ—¶é—´ï¼Œå¤§éƒ¨åˆ†å¾®ä¹ æƒ¯ä¸¤åˆ†é’Ÿä¹‹å†…å°±èƒ½å®Œæˆï¼Œä½ ä¼šæ…¢æ…¢çœ‹åˆ°æ•ˆæœçš„ã€‚\n8. ç”¨å¤šä½™ç²¾åŠ›è¶…é¢å®Œæˆä»»åŠ¡ï¼Œè€Œä¸æ˜¯åˆ¶å®šæ›´å¤§çš„ç›®æ ‡\nå¤§ç›®æ ‡åœ¨çº¸é¢ä¸Šçœ‹ç€æ¼‚äº®ï¼Œä½†åªæœ‰è¡ŒåŠ¨æ‰ç®—æ•°ã€‚\nç›®æ ‡æ¸ºå°ã€ç»“æœä¸°æ»¡ã€‚ä½ æ˜¯æƒ³è¦è¿™æ ·çš„ç»“æœï¼Œè¿˜æ˜¯åè¿‡æ¥ï¼Ÿ\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/read/wei-xi-guan/","summary":"0 å‰è¨€ ä¹¦åã€Šå¾®ä¹ æƒ¯ã€‹ï¼Œä½œè€…æ–¯æèŠ¬Â·ç›–æ–¯ [ç¾]ï¼Œæ±Ÿè¥¿äººæ°‘å‡ºç‰ˆç¤¾ï¼Œè¯‘è€…æ¡‚å› å¾®ä¹ æƒ¯æ˜¯ä¸€ç§éå¸¸å¾®å°çš„ç§¯æè¡Œä¸ºï¼Œä½ éœ€è¦æ¯å¤©å¼ºè¿«è‡ªå·±å®Œæˆå®ƒã€‚å¾®ä¹ æƒ¯å¤ªå°ï¼Œå°åˆ°ä¸å¯èƒ½å¤±è´¥ã€‚æ­£æ˜¯å› ä¸ºè¿™ä¸ªç‰¹æ€§ï¼Œå®ƒä¸ä¼šç»™ä½ é€ æˆä»»ä½•è´Ÿæ‹…ï¼Œè€Œä¸”å…·æœ‰è¶…å¼ºçš„â€œæ¬ºéª—æ€§â€ï¼Œå®ƒå› æ­¤æˆäº†æå…·ä¼˜åŠ¿çš„ä¹ æƒ¯å…»æˆç­–ç•¥ã€‚ å¾®ä¹ æƒ¯ç­–ç•¥çš„ç§‘å­¦åŸç†è¡¨","title":"ã€Šå¾®ä¹ æƒ¯ã€‹"},{"content":"0 å‰è¨€ å®‰è£…è¿‡ç¨‹ä¸­ä¼šæ›¿æ¢ç›¸å½“ä¸€éƒ¨åˆ†ç³»ç»Ÿå†…ç½®çš„è½¯ä»¶åŒ…, ä¸å»ºè®®ç”¨äºç”Ÿäº§ç¯å¢ƒ cephadm ä¾èµ– python3.6, è€Œæ­¤ç‰ˆæœ¬çš„ openeuler å†…ç½®ç‰ˆæœ¬ä¸º 3.7, ä¸”ä¸æ”¯æŒ platform-python, å‚è€ƒ: [openeuler çš„ gitee ç¤¾åŒº issue](https: \u0026lt;//gitee.com/src-openeuler/python3/issues/I4J8RK?from=project-issue\u0026gt;)\nåŸºç¡€ç¯å¢ƒ:\nceph: v16.2ï¼ˆpacificï¼‰ æ“ä½œç³»ç»Ÿ: icloudos_v1.0_aarch64ï¼ˆopenEuler-20.03-LTS-aarch64ï¼‰ å†…æ ¸ç‰ˆæœ¬: 4.19.90-2003.4.0.0037.aarch64 é›†ç¾¤è§’è‰²:\nip ä¸»æœºå è§’è‰² 192.168.47.133 ceph-aarch64-node1 cephadm, mgr, mon, osd 192.168.47.135 ceph-aarch64-node2 osd 192.168.47.130 ceph-aarch64-node3 osd 1 åŸºç¡€ç¯å¢ƒé…ç½® (æ‰€æœ‰èŠ‚ç‚¹) 1.1 å…³é—­ node_exporter systemctl stop node_exporter systemctl disable node_exporter 1.2 ä¿®æ”¹ä¸»æœºå hostnamectl set-hostname ceph-aarch64-node1 hostnamectl set-hostname ceph-aarch64-node2 hostnamectl set-hostname ceph-aarch64-node3 vi /etc/hosts # æ·»åŠ  192.168.47.133 ceph-aarch64-node1 192.168.47.135 ceph-aarch64-node2 192.168.47.130 ceph-aarch64-node3 1.3 æ·»åŠ  yum æº wget -O /etc/yum.repos.d/CentOS-Base.repo https: //mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo yum-config-manager --add-repo https: //mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo sed -i \u0026#39;s/$releasever/8/g\u0026#39; /etc/yum.repos.d/docker-ce.repo 1.4 æ·»åŠ  epel æº yum install epel-release # ä¿®æ”¹ $releasever sed -i \u0026#39;s/$releasever/8/g\u0026#39; /etc/yum.repos.d/epel-modular.repo sed -i \u0026#39;s/$releasever/8/g\u0026#39; /etc/yum.repos.d/epel-playground.repo sed -i \u0026#39;s/$releasever/8/g\u0026#39; /etc/yum.repos.d/epel.repo sed -i \u0026#39;s/$releasever/8/g\u0026#39; /etc/yum.repos.d/epel-testing-modular.repo sed -i \u0026#39;s/$releasever/8/g\u0026#39; /etc/yum.repos.d/epel-testing.repo 1.5 ä¿®æ”¹ /etc/os-release sed -i \u0026#39;s/ID=\u0026#34;isoft\u0026#34;/ID=\u0026#34;centos\u0026#34;/g\u0026#39; /etc/os-release sed -i \u0026#39;s/VERSION_ID=\u0026#34;1.0\u0026#34;/VERSION_ID=\u0026#34;8.0\u0026#34;/g\u0026#39; /etc/os-release 1.6 å®‰è£… python3.6 yum install python3-pip-wheel python3-setuptools-wheel wget http: //mirrors.aliyun.com/centos-vault/8.5.2111/BaseOS/aarch64/os/Packages/python3-libs-3.6.8-41.el8.aarch64.rpm wget http: //mirrors.aliyun.com/centos-vault/8.5.2111/BaseOS/aarch64/os/Packages/libffi-3.1-22.el8.aarch64.rpm rpm -ivh libffi-3.1-22.el8.aarch64.rpm --force cp /usr/lib64/libpython3.so /usr/lib64/libpython3.so-3.7.4 rpm -ivh python3-libs-3.6.8-41.el8.aarch64.rpm --force --nodeps mv /lib64/libpython3.so /lib64/python3.so-3.6.8 ln -s /usr/lib64/libpython3.so /lib64/libpython3.so yum install platform-python yum install python3-pip-9.0.3-20.el8.noarch vim /usr/bin/yum # å°† #!/usr/bin/python3 æ”¹æˆ #!/usr/bin/python3.7 yum install python3-prettytable-0.7.2-14.el8 yum install python3-gobject-base-3.28.3-2.el8.aarch64 yum install firewalld-0.9.3-7.el8 1.7 å®‰è£… docker yum install docker-ce systemctl start docker systemctl status docker systemctl enable docker 1.8 å®‰è£… cephadm \u0026amp; ceph-common curl --silent --remote-name --location https://github.com/ceph/ceph/raw/pacific/src/cephadm/cephadm chmod +x cephadm ./cephadm add-repo --release pacific yum install cephadm yum install ceph-common-16.2.9-0.el8 2 ceph é›†ç¾¤é…ç½® 2.1 é›†ç¾¤åˆå§‹åŒ– cephadm bootstrap --mon-ip 192.168.47.133 è®¿é—®: https://192.168.47.133:8443/\nç¬¬ä¸€æ¬¡è®¿é—® dashboard éœ€è¦ä¿®æ”¹åˆå§‹è´¦å·å¯†ç \n2.2 æ·»åŠ ä¸»æœº ssh-copy-id -f -i /etc/ceph/ceph.pub root@ceph-aarch64-node2 ssh-copy-id -f -i /etc/ceph/ceph.pub root@ceph-aarch64-node3 ceph orch host add ceph-aarch64-node2 192.168.47.135 --labels _admin ceph orch host add ceph-aarch64-node3 192.168.47.130 --labels _admin 2.3 æ·»åŠ ç£ç›˜ # å•ç›˜æ·»åŠ  ceph orch daemon add osd ceph-aarch64-node1: /dev/vdb # æŸ¥çœ‹æ‰€æœ‰å¯ç”¨è®¾å¤‡ ceph orch device ls # è‡ªåŠ¨æ·»åŠ æ‰€æœ‰å¯ç”¨è®¾å¤‡ ceph orch apply osd --all-available-devices 3 å…¶ä»– 3.1 æ¸…é™¤ ceph é›†ç¾¤ # æš‚åœé›†ç¾¤, é¿å…éƒ¨ç½²æ–°çš„ ceph å®ˆæŠ¤è¿›ç¨‹ ceph orch pause # éªŒè¯é›†ç¾¤ fsid ceph fsid # æ¸…é™¤é›†ç¾¤æ‰€æœ‰ä¸»æœºçš„ ceph å®ˆæŠ¤è¿›ç¨‹ cephadm rm-cluster --force --zap-osds --fsid \u0026lt;fsid\u0026gt; 3.2 no active mgr cephadm ls cephadm run --name mgr.ceph-aarch64-node3.ipgtzj --fsid 17136806-0735-11ed-9c4f-52546f3387f3 ceph orch apply mgr label: _admin 3.3 osd è¯¯åˆ é™¤ https://blog.csdn.net/cjfcxf010101/article/details/100411984\n3.4 cephadm_failed_daemon [åˆ é™¤ osd åå¼•èµ·çš„ cephadm_failed_daemon é”™è¯¯](https: \u0026lt;//www.cnblogs.com/st2021/p/15026526.html\u0026gt;)\n3.5 ç¦ç”¨è‡ªåŠ¨æ·»åŠ  osd ceph orch apply osd --all-available-devices --unmanaged=true ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/ceph-v16-cpehadm-openeuler-aarch64/","summary":"0 å‰è¨€ å®‰è£…è¿‡ç¨‹ä¸­ä¼šæ›¿æ¢ç›¸å½“ä¸€éƒ¨åˆ†ç³»ç»Ÿå†…ç½®çš„è½¯ä»¶åŒ…, ä¸å»ºè®®ç”¨äºç”Ÿäº§ç¯å¢ƒ cephadm ä¾èµ– python3.6, è€Œæ­¤ç‰ˆæœ¬çš„ openeuler å†…ç½®ç‰ˆæœ¬ä¸º 3.7, ä¸”ä¸æ”¯æŒ platform-python, å‚è€ƒ: [openeuler çš„ gitee ç¤¾åŒº issue](https: \u0026lt;//gitee.com/src-openeuler/python3/issues/I4J8RK?from=project-issue\u0026gt;) åŸºç¡€ç¯å¢ƒ: ceph: v16.2ï¼ˆpacificï¼‰ æ“ä½œç³»ç»Ÿ: icloudos_v1.0_aarch64ï¼ˆopenEuler-20.03-LTS-aarch64ï¼‰","title":"ceph | openeuler (aarch64) éƒ¨ç½² ceph-v16"},{"content":"1 èµ·å›  åœ¨ä½¿ç”¨ cephadm å®‰è£… ceph v16.2 æ—¶å‡çº§äº† pythonï¼Œç³»ç»Ÿé»˜è®¤ç‰ˆæœ¬æ˜¯ 3.7.4 ï¼Œå‡çº§åç‰ˆæœ¬æ˜¯ 3.8.5ï¼Œglibc ä½œä¸ºä¾èµ–åŒæ—¶è¿›è¡Œäº†å‡çº§ï¼Œç³»ç»Ÿé»˜è®¤ç‰ˆæœ¬æ˜¯ 2.28 ï¼Œå‡çº§åç‰ˆæœ¬æ˜¯ 2.31ï¼Œå¹¸å¥½è®°å½•åŠæ—¶ï¼Œæˆªå›¾ç•™å­˜äº†è½¯ä»¶åŒ…å‡çº§ä¿¡æ¯ï¼Œå¦‚ä¸‹\nåœ¨æ²¡æœ‰ååˆ†æŠŠæ¡çš„æƒ…å†µä¸‹ä¸è¦ç”¨ yum install -yï¼Œä½¿ç”¨ yum install å…ˆåˆ¤æ–­å¥½ä¾èµ–å®‰è£…å¸¦æ¥çš„å½±å“\nå‡çº§è¿‡ç¨‹æœªå‡ºä»»ä½•é—®é¢˜ï¼Œä¾¿æ²¡åœ¨æ„ï¼Œå¯æ˜¯åç»­ openssh ç”±äº glibc çš„å‡çº§å¯¼è‡´è¿æ¥å¤±è´¥ï¼Œä¸€ç•ª baidu åŠ  google æœªè§£å†³ openssh è¿æ¥é—®é¢˜ï¼Œäºæ˜¯ä¾¿ç€æ‰‹å¼€å§‹é™çº§ glibc è‡³ç³»ç»Ÿé»˜è®¤ç‰ˆæœ¬ï¼Œä»ç³»ç»Ÿé•œåƒä¸­æ‰¾åˆ° glibc ç›¸å…³çš„ä¸‰ä¸ªè½¯ä»¶åŒ…\nç”±äºæ˜¯ç‰ˆæœ¬é™çº§ï¼Œè„‘å­ä¸€çƒ­ä¾¿é‡‡ç”¨ rpm -Uvh --nodeps glibc* æ–¹å¼å¼ºåˆ¶å®‰è£…ï¼Œè‡³æ­¤ï¼Œç³»ç»Ÿå´©æºƒ\nç³»ç»Ÿå‡ ä¹æ‰€æœ‰å‘½ä»¤éƒ½æ— æ³•ä½¿ç”¨ï¼ŒæŠ¥é”™å¦‚ä¸‹\nå‡ºç°è¿™ä¸ªé—®é¢˜çš„åŸå› å¤§è‡´æ˜¯å› ä¸ºå¼ºåˆ¶å®‰è£…å¹¶æœªå®Œå…¨æˆåŠŸï¼Œlib64 ä¸€äº›ç›¸å…³çš„åº“æ–‡ä»¶è½¯é“¾æ¥ä¸¢å¤±\n[root@localhost ~]# ls -l /lib64/libc.so.6 lrwxrwxrwx 1 root root 12 7æœˆ 14 14:43 /lib64/libc.so.6 -\u0026gt; libc-2.28.so # æ¢å¤å‰è¿™é‡Œæ˜¯ libc-2.31.so åœ¨å¼ºåˆ¶å®‰è£… glibc-2.28 æ—¶ï¼Œ libc-2.31.so å·²ç»è¢«æ›¿æ¢æˆäº† libc-2.28.so ï¼Œç”±äºå®‰è£…å¤±è´¥ libc.so.6 é“¾æ¥åˆ°çš„è¿˜æ˜¯ libc-2.31.soï¼Œè‡ªç„¶ä¼šæŠ¥é”™ no such file\n2 æ¢å¤ ç³»ç»Ÿç»å¤§éƒ¨åˆ†å‘½ä»¤éƒ½æ˜¯ä¾èµ– libc.so.6 çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ export LD_PRELOAD=\u0026quot;åº“æ–‡ä»¶è·¯å¾„\u0026quot; è®¾ç½®ä¼˜å…ˆä½¿ç”¨çš„åº“\nexport LD_PRELOAD=/lib64/libc-2.28.so æ­¤æ—¶ ls ã€cdã€mv ç­‰åŸºç¡€å‘½ä»¤ä»¥åŠæœ€é‡è¦çš„ ln é“¾æ¥å‘½ä»¤å·²ç»å¯ä»¥ä½¿ç”¨äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ¢å¤è½¯é“¾æ¥\nrm -f /lib64/libc.so.6 ln -s /lib64/libc-2.28.so /lib64/libc.so.6 ä½†æ˜¯ yum å‘½ä»¤ä¾èµ–çš„å‡ ä¸ªåº“è½¯é“¾æ¥è¿˜æ²¡æœ‰æ¢å¤ï¼ŒæŒ‰ç…§æŠ¥é”™æç¤ºè·Ÿä¸Šè¿°æ­¥éª¤ä¸€æ ·ï¼Œå…ˆåˆ é™¤æ‰ä¾èµ–çš„åº“æ–‡ä»¶ï¼Œå†é‡æ–°è½¯é“¾æ¥è¿‡å»\nä¹‹åå°±æ˜¯é‡æ–° yum localinstall å®‰è£…ä¸€ä¸‹æœªå®‰è£…æˆåŠŸçš„ glic ï¼Œä¹‹å‰å¼ºåˆ¶å®‰è£…æ—¶å·²ç»å°†é«˜ç‰ˆæœ¬çš„ glibc æ¸…ç†æ‰äº†ï¼Œè¿™é‡Œé‡æ–°å®‰è£…å¾ˆé¡ºåˆ©\nä¹Ÿè®¸ä¹‹å‰ä½¿ç”¨ yum localinstall å®‰è£…å¯èƒ½å°±ä¸ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜äº†ï¼Œrpm \u0026ndash;nodeps ä¹Ÿè¦å°‘ç”¨~\nyum localinstall glibc* è½¯ä»¶åŒ…å®‰è£…è¿‡ç¨‹ä¸­æ²¡æœ‰æŠ¥é”™ï¼Œç»æµ‹è¯•ç³»ç»Ÿä¸€åˆ‡æ­£å¸¸ï¼Œopenssh ä¹Ÿå¯ä»¥æ­£å¸¸è¿æ¥äº†\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/troubleshooting-glibc-wu-sheng-ji/","summary":"1 èµ·å›  åœ¨ä½¿ç”¨ cephadm å®‰è£… ceph v16.2 æ—¶å‡çº§äº† pythonï¼Œç³»ç»Ÿé»˜è®¤ç‰ˆæœ¬æ˜¯ 3.7.4 ï¼Œå‡çº§åç‰ˆæœ¬æ˜¯ 3.8.5ï¼Œglibc ä½œä¸ºä¾èµ–åŒæ—¶è¿›è¡Œäº†å‡çº§ï¼Œç³»ç»Ÿé»˜è®¤ç‰ˆæœ¬æ˜¯ 2.28 ï¼Œå‡çº§åç‰ˆæœ¬æ˜¯ 2.31ï¼Œå¹¸å¥½è®°å½•åŠæ—¶ï¼Œæˆªå›¾ç•™å­˜äº†è½¯ä»¶åŒ…å‡çº§ä¿¡æ¯ï¼Œå¦‚ä¸‹ åœ¨æ²¡æœ‰ååˆ†æŠŠæ¡çš„æƒ…å†µä¸‹ä¸è¦ç”¨ yum install -yï¼Œä½¿ç”¨ yum install å…ˆåˆ¤æ–­å¥½ä¾èµ–å®‰è£…å¸¦æ¥çš„å½±å“ å‡çº§","title":"troubleshooting | glibc è¯¯å‡çº§åä¿®å¤"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥\nopenEuler å®˜æ–¹æ–‡æ¡£ PXE è‡ªåŠ¨åŒ–å®‰è£… CentOS 8 PXE ç½‘ç»œå¼•å¯¼ç³»ç»Ÿä¹‹æœåŠ¡å™¨ arm64 æµ‹è¯•ç¯å¢ƒï¼š\nx86_64ï¼ˆamd ryzen 7 4800uï¼‰ï¼švmware workstation V16.1.2\naarch64ï¼ˆkunpeng 920ï¼‰ï¼š kvm-2.12\næ³¨æ„æµ‹è¯•çš„ç½‘ç»œç¯å¢ƒä¸­ä¸è¦å­˜åœ¨å…¶ä»–çš„ dhcp æœåŠ¡\næ³¨æ„æµ‹è¯•è™šæ‹Ÿæœºå†…å­˜å°½é‡å¤§äº 4Gï¼Œå¦åˆ™ä¼šæŠ¥é”™ no space left æˆ–è€…æµ‹è¯•æœºç›´æ¥é»‘å±\næ³¨æ„ ks.cfg å°½é‡åœ¨å½“å‰ç¯å¢ƒå…ˆæ‰‹åŠ¨å®‰è£…ä¸€å°æ¨¡æ¿æœºï¼Œä½¿ç”¨æ¨¡æ¿æœºç”Ÿæˆçš„ ks æ–‡ä»¶æ¥è¿›è¡Œä¿®æ”¹ï¼Œå¦åˆ™å¯èƒ½ä¼šæœ‰ä¸€äº›æ¸…ç†ç£ç›˜åˆ†åŒºçš„ç ´åæ€§æ“ä½œï¼ŒåŸºæœ¬åªéœ€è¦å°†å®‰è£…æ–¹å¼ä» cdrom ä¿®æ”¹æˆ install å’Œ url --url=http://â€¦â€¦\n1 æœåŠ¡ç«¯é…ç½® 1.1 åŸºç¡€ç¯å¢ƒ ç³»ç»Ÿç‰ˆæœ¬ï¼šiSoft-ServerOS-V6.0-rc1\nip åœ°å€ï¼š1.1.1.21\nç½‘å¡é€‰æ‹© nat æ¨¡å¼ï¼Œæ³¨æ„å…³é—­ä¸€ä¸‹ workstation è‡ªå¸¦çš„ dhcpï¼Œä¹Ÿå¯ä½¿ç”¨è‡ªå®šä¹‰çš„ lanåŒºæ®µ\n1.2 å…³é—­é˜²ç«å¢™åŠ selinux iptables -F systemctl stop firewalld systemctl disable firewalld setenforce 0 sed -i \u0026#39;/SELINUX/s/enforcing/disabled/\u0026#39; /etc/selinux/config 1.3 å®‰è£…ç›¸å…³çš„è½¯ä»¶åŒ… è¿™é‡Œç”±äº HW è¡ŒåŠ¨çš„åŸå› ï¼Œå¤–ç½‘ yum æºæš‚ä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ° yum æºå®‰è£…ç›¸å…³è½¯ä»¶åŒ…\nmount -o loop /root/iSoft-Taiji-Server-OS-6.0-x86_64-rc1-202112311623.iso /mnt mkdir /etc/yum.repos.d/bak mv /etc/yum.repos.d/isoft* /etc/yum.repos.d/bak/ cat \u0026gt; /etc/yum.repos.d/local.repo \u0026lt;\u0026lt;EOF [local] name=local baseurl=file:///mnt gpgcheck=0 enabled=1 EOF dnf clean all dnf makecache cenots8 å®‰è£… syslinux æ—¶éœ€è¦åŠ  \u0026ndash;nonlinux åç¼€ï¼Œcentos7 åˆ™ä¸éœ€è¦\ndnf install dhcp-server tftp-server httpd syslinux-nonlinux 1.4 http æœåŠ¡é…ç½® mkdir /var/www/html/ks/ chmod 755 -R /var/www/html/ systemctl start httpd systemctl enable httpd èƒ½è®¿é—®åˆ° httpd å³å¯\n1.5 tftp æœåŠ¡é…ç½® systemctl start tftp systemctl enable tftp 1.6 dhcp æœåŠ¡é…ç½® x86_64 æ¶æ„å’Œ aarch64 æ¶æ„çš„ dhcp çš„é…ç½®ç•¥æœ‰ä¸åŒï¼ŒæŒ‰ç…§ä¸‹æ–‡åˆ†åˆ«é…ç½®\nsystemctl enable dhcpd 2 x86_64 2.1 æœåŠ¡ç«¯é…ç½® 2.1.1 dhcp æœåŠ¡é…ç½® vim /etc/dhcp/dhcpd.conf\noption domain-name \u0026#34;example.org\u0026#34;; option domain-name-servers 8.8.8.8, 114.114.114.114; default-lease-time 84600; max-lease-time 100000; log-facility local7; subnet 1.1.1.0 netmask 255.255.255.0 { range 1.1.1.100 1.1.1.200; option routers 1.1.1.253; next-server 1.1.1.21; # æœ¬æœºipï¼ˆtftpserverçš„ipï¼‰ filename \u0026#34;pxelinux.0\u0026#34;; } systemctl restart dhcpd 2.2 isoft_4.2_x86 2.2.1 http æœåŠ¡é…ç½® åˆ›å»ºç›®å½•\n# åˆ›å»ºç›®å½• mkdir -p /var/www/html/isoft_4.2/isos/x86_64/ # æŒ‚è½½é•œåƒæ–‡ä»¶ mount -o loop /root/iSoft-Server-OS-4.2-x86_64-201907051149.iso /var/www/html/isoft_4.2/isos/x86_64/ # åˆ›å»ºks.cfgåº”ç­”æ–‡ä»¶ vim /var/www/html/ks/ks-isoft-4.2-x86.cfg chmod -R 755 /var/www/html ks.cfg æ–‡ä»¶å†…å®¹\n#version=DEVEL # System authorization information auth --enableshadow --passalgo=sha512 # Use CDROM installation media install url --url=http://1.1.1.21/isoft_4.2/isos/x86_64/ # Use graphical install graphical # Run the Setup Agent on first boot firstboot --enable ignoredisk --only-use=sda # Keyboard layouts keyboard --vckeymap=cn --xlayouts=\u0026#39;cn\u0026#39; # System language lang zh_CN.UTF-8 # Network information network --bootproto=dhcp --device=ens32 --onboot=off --ipv6=auto --no-activate network --hostname=localhost.localdomain # Root password rootpw --iscrypted $6$9yXT2.jd8oofY89W$q1nVQ4rRfAE937KeG5bHCAP3iI3GgyVJJF/MN5Ipe9omdXIEjelaTQSPplr9E9aFOGG17F3GkzIzNnifvjdO20 # System services services --enabled=\u0026#34;chronyd\u0026#34; # System timezone timezone Asia/Shanghai --isUtc # X Window System configuration information xconfig --startxonboot # System bootloader configuration bootloader --append=\u0026#34; crashkernel=auto\u0026#34; --location=mbr --boot-drive=sda autopart --type=lvm # Partition clearing information clearpart --all --initlabel %packages @^gnome-desktop-environment @base @core @desktop-debugging @dial-up @directory-client @fonts @gnome-desktop @guest-agents @guest-desktop-agents @input-methods @internet-browser @java-platform @multimedia @network-file-system-client @networkmanager-submodules @print-client @x11 chrony kexec-tools %end %addon com_redhat_kdump --enable --reserve-mb=\u0026#39;auto\u0026#39; %end %anaconda pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty %end reboot 2.2.2 tftp æœåŠ¡é…ç½® rm -rf /var/lib/tftpboot/* rm -rf /root/usr mkdir /var/lib/tftpboot/pxelinux.cfg # æå– menu.c32 å’Œ pxelinux.0 cp /var/www/html/icloud_1.0/isos/x86_64/Packages/syslinux-nonlinux-6.04-4.el8.isoft.noarch.rpm /root/ rpm2cpio syslinux-4.05-15.el7.isoft.x86_64.rpm | cpio -idv ./usr/share/syslinux/menu.c32 rpm2cpio syslinux-4.05-15.el7.isoft.x86_64.rpm | cpio -idv ./usr/share/syslinux/pxelinux.0 cp /root/usr/share/syslinux/menu.c32 /var/lib/tftpboot/ cp /root/usr/share/syslinux/pxelinux.0 /var/lib/tftpboot/ # æ‹·è´å†…æ ¸å¯åŠ¨æ–‡ä»¶ cp /var/www/html/isoft_4.2/isos/x86_64/isolinux/vmlinuz /var/lib/tftpboot/ cp /var/www/html/isoft_4.2/isos/x86_64/isolinux/initrd.img /var/lib/tftpboot/ cp /var/www/html/isoft_4.2/isos/x86_64/isolinux/vesamenu.c32 /var/lib/tftpboot/ # æ‹·è´èœå•é…ç½®æ–‡ä»¶ cp /var/www/html/isoft_4.2/isos/x86_64/isolinux/isolinux.cfg /var/lib/tftpboot/pxelinux.cfg/default chmod -R 755 /var/lib/tftpboot/* systemctl restart tftp vim /var/lib/tftpboot/pxelinux.cfg/default\ndefault vesamenu.c32 timeout 30 menu title iSoft-Taiji Server OS 6.0 label linux menu label ^Install iSoft-Taiji Server OS 6.0 menu default kernel vmlinuz append initrd=initrd.img ks=http://1.1.1.21/ks/ks-isoft-6.0-x86.cfg 2.3 isoft_6.0-rc1_x86 2.3.1 http æœåŠ¡é…ç½® åˆ›å»ºç›®å½•\n# åˆ›å»ºç›®å½• mkdir -p /var/www/html/isoft_6.0/isos/x86_64/ # æŒ‚è½½é•œåƒæ–‡ä»¶ mount -o loop /root/iSoft-Taiji-Server-OS-6.0-x86_64-rc1-202112311623.iso /var/www/html/isoft_6.0/isos/x86_64/ # åˆ›å»ºks.cfgåº”ç­”æ–‡ä»¶ vim /var/www/html/ks/ks-isoft-6.0-x86.cfg chmod -R 755 /var/www/html ks.cfg æ–‡ä»¶å†…å®¹\n# Use graphical install graphical install url --url=http://1.1.1.21/isoft_6.0/isos/x86_64/ %packages @^graphical-server-environment %end # Keyboard layouts keyboard --xlayouts=\u0026#39;cn\u0026#39; # System language lang zh_CN.UTF-8 # Network information network --bootproto=static --device=ens33 --bootproto=dhcp --ipv6=auto --activate network --hostname=localhost.localdomain # Run the Setup Agent on first boot firstboot --enable ignoredisk --only-use=sda autopart --type=lvm # Partition clearing information clearpart --all --initlabel # System timezone timezone Asia/Shanghai --isUtc # Root password rootpw --iscrypted $6$w6X5WYQDyMeAizfs$TFKls9Kuj4Jv6PNKcMZ2BmB1Z/dvRCRkGD9uzm0n8te2UwDgdPCPGkUxCPvExKGenCMINTMcjSH55bCWYDiHx. %addon com_redhat_kdump --disable --reserve-mb=\u0026#39;128\u0026#39; %end %anaconda pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty %end reboot 2.3.2 tftp æœåŠ¡é…ç½® rm -rf /var/lib/tftpboot/* rm -rf /root/usr mkdir /var/lib/tftpboot/pxelinux.cfg # æå– menu.c32 å’Œ pxelinux.0 cp /var/www/html/isoft_6.0/isos/x86_64/Packages/syslinux-nonlinux-6.04-7.oe1.isoft.noarch /root/ rpm2cpio syslinux-nonlinux-6.04-7.oe1.isoft.noarch | cpio -idv ./usr/share/syslinux/menu.c32 rpm2cpio syslinux-nonlinux-6.04-7.oe1.isoft.noarch | cpio -idv ./usr/share/syslinux/pxelinux.0 cp /root/usr/share/syslinux/menu.c32 /var/lib/tftpboot/ cp /root/usr/share/syslinux/pxelinux.0 /var/lib/tftpboot/ # æ‹·è´å†…æ ¸å¯åŠ¨æ–‡ä»¶ cp /var/www/html/isoft_6.0/isos/x86_64/isolinux/vmlinuz /var/lib/tftpboot/ cp /var/www/html/isoft_6.0/isos/x86_64/isolinux/initrd.img /var/lib/tftpboot/ cp /var/www/html/isoft_6.0/isos/x86_64/isolinux/vesamenu.c32 /var/lib/tftpboot/ # æ‹·è´èœå•é…ç½®æ–‡ä»¶ cp /var/www/html/isoft_6.0/isos/x86_64/isolinux/isolinux.cfg /var/lib/tftpboot/pxelinux.cfg/default cp /var/www/html/isoft_6.0/isos/x86_64/isolinux/ldlinux.c32 /var/lib/tftpboot/ cp /var/www/html/isoft_6.0/isos/x86_64/isolinux/libutil.c32 /var/lib/tftpboot/ cp /var/www/html/isoft_6.0/isos/x86_64/isolinux/libcom32.c32 /var/lib/tftpboot/ chmod -R 755 /var/lib/tftpboot/* systemctl restart tftp vim /var/lib/tftpboot/pxelinux.cfg/default\ndefault vesamenu.c32 timeout 30 menu title iSoft-Taiji Server OS 6.0 label linux menu label ^Install iSoft-Taiji Server OS 6.0 menu default kernel vmlinuz append initrd=initrd.img ks=http://1.1.1.21/ks/ks-isoft-6.0-x86.cfg 2.4 icloud_1.0_x86 2.4.1 http æœåŠ¡é…ç½® mkdir -p /var/www/html/icloud_1.0/isos/x86_64/ # æŒ‚è½½é•œåƒ mount -o loop /root/i-CloudOS-1.0-x86_64-202108131137.iso /var/www/html/icloud_1.0/isos/x86_64/ # åˆ›å»ºks.cfgåº”ç­”æ–‡ä»¶ vim /var/www/html/ks/ks-icloud-1.0-x86.cfg chmod -R 755 /var/www/html ks-icloud-1.0-x86.cfg æ–‡ä»¶å†…å®¹\n#version=RHEL8 ignoredisk --only-use=sda autopart --type=lvm # Partition clearing information clearpart --all --initlabel # Use graphical install graphical # Use CDROM installation media install url --url=http://1.1.1.21/icloud_1.0/isos/x86_64/ # Keyboard layouts keyboard --vckeymap=us --xlayouts=\u0026#39;\u0026#39; # System language lang zh_CN.UTF-8 # Root password rootpw --iscrypted 123.com # Run the Setup Agent on first boot firstboot --enable # Do not configure the X Window System skipx # System services services --enabled=\u0026#34;chronyd\u0026#34; # System timezone timezone Asia/Shanghai --isUtc %packages @^vmserver-compute-node %end %anaconda pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty %end reboot 2.4.2 tftp æœåŠ¡é…ç½® rm -rf /var/lib/tftpboot/* rm -rf /root/usr mkdir /var/lib/tftpboot/pxelinux.cfg # æå– menu.c32 å’Œ pxelinux.0 cp /var/www/html/icloud_1.0/isos/x86_64/Packages/syslinux-nonlinux-6.04-4.el8.isoft.noarch.rpm /root/ rpm2cpio syslinux-nonlinux-6.04-4.el8.isoft.noarch.rpm | cpio -idv ./usr/share/syslinux/menu.c32 rpm2cpio syslinux-nonlinux-6.04-4.el8.isoft.noarch.rpm | cpio -idv ./usr/share/syslinux/pxelinux.0 cp /root/usr/share/syslinux/menu.c32 /var/lib/tftpboot/ cp /root/usr/share/syslinux/pxelinux.0 /var/lib/tftpboot/ # æ‹·è´å†…æ ¸å¯åŠ¨æ–‡ä»¶ cp /var/www/html/icloud_1.0/isos/x86_64/isolinux/vmlinuz /var/lib/tftpboot/ cp /var/www/html/icloud_1.0/isos/x86_64/isolinux/initrd.img /var/lib/tftpboot/ cp /var/www/html/icloud_1.0/isos/x86_64/isolinux/vesamenu.c32 /var/lib/tftpboot/ # æ‹·è´èœå•é…ç½®æ–‡ä»¶ cp /var/www/html/icloud_1.0/isos/x86_64/isolinux/isolinux.cfg /var/lib/tftpboot/pxelinux.cfg/default # ä¸‹é¢è¿™ä¸‰ä¸ªæ–‡ä»¶centos7å¯ä»¥ä¸è¦ï¼Œcentos8å¯¹äºè¿™ä¸‰ä¸ªæ–‡ä»¶æœ‰ä¸€å®šä¾èµ–æ€§ cp /var/www/html/icloud_1.0/isos/x86_64/isolinux/ldlinux.c32 /var/lib/tftpboot/ cp /var/www/html/icloud_1.0/isos/x86_64/isolinux/libutil.c32 /var/lib/tftpboot/ cp /var/www/html/icloud_1.0/isos/x86_64/isolinux/libcom32.c32 /var/lib/tftpboot/ chmod -R 755 /var/lib/tftpboot/* systemctl restart tftp vim /var/lib/tftpboot/pxelinux.cfg/default\ndefault menu.c32 timeout 30 menu title i-CloudOS 1.0 label linux menu label ^Install i-CloudOS 1.0 menu default kernel vmlinuz append initrd=initrd.img ks=http://1.1.1.21/icloud_1.0/isos/x86_64/ks-icloud-1.0-x86.cfg 2.5 openeuler_20.03-LTS-SP1_x86 2.5.1 http æœåŠ¡é…ç½® åˆ›å»ºç›®å½•\n# åˆ›å»ºç›®å½• mkdir -p /var/www/html/openeuler_20.03-LTS-SP1/isos/x86_64/ # æŒ‚è½½é•œåƒæ–‡ä»¶ mount -o loop /root/iSoft-Taiji-Server-OS-6.0-x86_64-rc1-202112311623.iso /var/www/html/isoft_6.0/isos/x86_64/ # åˆ›å»ºks.cfgåº”ç­”æ–‡ä»¶ vim /var/www/html/ks/ks-openeuler-20.03-LTS-x86.cfg chmod -R 755 /var/www/html /var/www/html/ks/ks-openeuler-20.03-LTS-x86.cfg æ–‡ä»¶å†…å®¹\n# Use graphical install graphical install url --url=http://1.1.1.21/openeuler_20.03-LTS-SP1/isos/x86_64/ %packages @^minimal-environment %end # Keyboard layouts keyboard --xlayouts=\u0026#39;cn\u0026#39; # System language lang zh_CN.UTF-8 # Network information network --bootproto=static --device=ens33 --bootproto=dhcp --ipv6=auto --activate network --hostname=localhost.localdomain # Run the Setup Agent on first boot firstboot --enable ignoredisk --only-use=sda autopart --type=lvm # Partition clearing information clearpart --all --initlabel # System timezone timezone Asia/Shanghai --isUtc # Root password rootpw --iscrypted $6$w6X5WYQDyMeAizfs$TFKls9Kuj4Jv6PNKcMZ2BmB1Z/dvRCRkGD9uzm0n8te2UwDgdPCPGkUxCPvExKGenCMINTMcjSH55bCWYDiHx. %addon com_redhat_kdump --disable --reserve-mb=\u0026#39;128\u0026#39; %end %anaconda pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty %end reboot 2.5.2 tftp æœåŠ¡é…ç½® rm -rf /var/lib/tftpboot/* rm -rf /root/usr mkdir /var/lib/tftpboot/pxelinux.cfg # æå– menu.c32 å’Œ pxelinux.0 cp /var/www/html/openeuler_20.03-LTS-SP1/isos/x86_64/Packages/syslinux-nonlinux-6.04-5.oe1.noarch.rpm /root/ rpm2cpio syslinux-nonlinux-6.04-5.oe1.noarch.rpm | cpio -idv ./usr/share/syslinux/menu.c32 rpm2cpio syslinux-nonlinux-6.04-5.oe1.noarch.rpm | cpio -idv ./usr/share/syslinux/pxelinux.0 cp /root/usr/share/syslinux/menu.c32 /var/lib/tftpboot/ cp /root/usr/share/syslinux/pxelinux.0 /var/lib/tftpboot/ # æ‹·è´å†…æ ¸å¯åŠ¨æ–‡ä»¶ cp /var/www/html/openeuler_20.03-LTS-SP1/isos/x86_64/isolinux/vmlinuz /var/lib/tftpboot/ cp /var/www/html/openeuler_20.03-LTS-SP1/isos/x86_64/isolinux/initrd.img /var/lib/tftpboot/ cp /var/www/html/openeuler_20.03-LTS-SP1/isos/x86_64/isolinux/vesamenu.c32 /var/lib/tftpboot/ # æ‹·è´èœå•é…ç½®æ–‡ä»¶ cp /var/www/html/openeuler_20.03-LTS-SP1/isos/x86_64/isolinux/isolinux.cfg /var/lib/tftpboot/pxelinux.cfg/default cp /var/www/html/openeuler_20.03-LTS-SP1/isos/x86_64/isolinux/ldlinux.c32 /var/lib/tftpboot/ cp /var/www/html/openeuler_20.03-LTS-SP1/isos/x86_64/isolinux/libutil.c32 /var/lib/tftpboot/ cp /var/www/html/openeuler_20.03-LTS-SP1/isos/x86_64/isolinux/libcom32.c32 /var/lib/tftpboot/ chmod -R 755 /var/lib/tftpboot/* systemctl restart tftp vim /var/lib/tftpboot/pxelinux.cfg/default\ndefault vesamenu.c32 timeout 30 menu title iSoft-Taiji Server OS 6.0 label linux menu label ^Install iSoft-Taiji Server OS 6.0 menu default kernel vmlinuz append initrd=initrd.img ks=http://1.1.1.21/ks/ks-isoft-6.0-x86.cfg 3 aarch64 3.1 æœåŠ¡ç«¯é…ç½® 3.1.1 dhcp æœåŠ¡é…ç½® vim /etc/dhcp/dhcpd.conf\noption domain-name \u0026#34;example.org\u0026#34;; option domain-name-servers 8.8.8.8, 114.114.114.114; default-lease-time 84600; max-lease-time 100000; log-facility local7; subnet 1.1.1.0 netmask 255.255.255.0 { range 1.1.1.100 1.1.1.200; option routers 1.1.1.253; next-server 1.1.1.21; # æœ¬æœºipï¼ˆtftpserverçš„ipï¼‰ filename \u0026#34;grubaa64.efi\u0026#34;; } systemctl restart dhcpd 3.2 isoft_6.0_aarch64 3.2.1 http æœåŠ¡é…ç½® åˆ›å»ºç›®å½•\n# åˆ›å»ºç›®å½• mkdir -p /var/www/html/isoft_6.0/isos/aarch64/ # æŒ‚è½½é•œåƒæ–‡ä»¶ mount -o loop /root/iSoft-Taiji-Server-OS-6.0-aarch64-202201240952.iso /var/www/html/isoft_6.0/isos/aarch64/ # åˆ›å»ºks.cfgåº”ç­”æ–‡ä»¶ vim /var/www/html/ks/ks-isoft-6.0-aarch64.cfg chmod -R 755 /var/www/html ks-isoft-6.0-aarch64.cfg æ–‡ä»¶å†…å®¹\n#version=DEVEL ignoredisk --only-use=vda autopart --type=lvm # Partition clearing information clearpart --all --initlabel # Use graphical install graphical # Use CDROM installation media install url --url=http://1.1.1.21/isoft_6.0/isos/aarch64 # Keyboard layouts keyboard --vckeymap=cn --xlayouts=\u0026#39;cn\u0026#39; # System language lang zh_CN.UTF-8 # Network information network --bootproto=static --device=enp3s0 --bootproto=dhcp --ipv6=auto --activate network --hostname=localhost.localdomain # Root password rootpw --iscrypted $6$x94MGsfCoFdE/G4O$MEakgOwtq0O5i4pRIVzXntKQuMJVh9CJ3anhZKl8YZhZDtSXhzuMk5mpDr3wu..rDareWgy5tjsepCaGiPK3g/ # X Window System configuration information xconfig --startxonboot # Run the Setup Agent on first boot firstboot --enable # System services services --enabled=\u0026#34;chronyd\u0026#34; # System timezone timezone Asia/Shanghai --isUtc %packages @^mate-desktop-environment %end %anaconda pwpolicy root --minlen=8 --minquality=1 --notstrict --nochanges --notempty pwpolicy user --minlen=8 --minquality=1 --notstrict --nochanges --emptyok pwpolicy luks --minlen=8 --minquality=1 --notstrict --nochanges --notempty %end reboot 3.2.2 tftp æœåŠ¡é…ç½® rm -rf /var/lib/tftpboot/* cp /var/www/html/isoft_6.0/isos/aarch64/EFI/BOOT/grub.cfg /var/lib/tftpboot/ cp /var/www/html/isoft_6.0/isos/aarch64/EFI/BOOT/grubaa64.efi /var/lib/tftpboot/ cp /var/www/html/isoft_6.0/isos/aarch64/images/pxeboot/vmlinuz /var/lib/tftpboot/ cp /var/www/html/isoft_6.0/isos/aarch64/images/pxeboot/initrd.img /var/lib/tftpboot/ chmod -R 755 /var/lib/tftpboot/* systemctl restart tftp vim /var/lib/tftpboot/grub.cfg\nset default=\u0026#34;1\u0026#34; function load_video { if [ x$feature_all_video_module = xy ]; then insmod all_video else insmod efi_gop insmod efi_uga insmod ieee1275_fb insmod vbe insmod vga insmod video_bochs insmod video_cirrus fi } load_video set gfxpayload=keep insmod gzio insmod part_gpt insmod ext2 set timeout=6 ### END /etc/grub.d/00_header ### search --no-floppy --set=root -l \u0026#39;iSoft-Taiji-Server-OS-6.0\u0026#39; ### BEGIN /etc/grub.d/10_linux ### menuentry \u0026#39;Install iSoft-Taiji-Server-OS 6.0 with GUI mode\u0026#39; --class red --class gnu-linux --class gnu --class os { set root=(tftp,1.1.1.21) linux /vmlinuz ro inst.geoloc=0 console=ttyAMA0 console=tty0 rd.iscsi.waitnet=0 inst.repo=http://1.1.1.21/isoft_6.0/isos/aarch64/ inst.ks=http://1.1.1.21/ks/ks-isoft-6.0-aarch64.cfg initrd /initrd.img } } 3.3 icloud_1.0_aarch64 è¿™é‡Œ iso æ²¡æœ‰ç›´æ¥æŒ‚è½½åˆ° apache ç›®å½•ï¼Œæ˜¯å› ä¸ºè¯¥ iso æ–‡ä»¶ Packages ç›®å½•ä¸­æœ‰ä¸ªåˆ«è½¯ä»¶åŒ…æ²¡æœ‰è¯»å–æƒé™ï¼Œç›´æ¥æŒ‚è½½æ— æ³•ä¿®æ”¹æƒé™\n3.3.1 http æœåŠ¡é…ç½® åˆ›å»ºç›®å½•\n# åˆ›å»ºç›®å½• mkdir -p /var/www/html/icloud_1.0/isos/aarch64/ # æŒ‚è½½é•œåƒæ–‡ä»¶ mount -o loop /root/iCloudOS-1.0-aarch64-2021-0805-1423-test-1.iso /mnt/ cp -r /mnt/* /var/www/html/icloud_1.0/isos/aarch64/ # ä¸Šä¼  ks.cfg åº”ç­”æ–‡ä»¶ vim /var/www/html/ks/ks-icloud-1.0-aarch64.cfg chmod -R 755 /var/www/html ks-icloud-1.0-aarch64.cfg æ–‡ä»¶å†…å®¹\n#version=RHEL8 ignoredisk --only-use=vda autopart --type=lvm # Partition clearing information clearpart --all --initlabel # Use graphical install graphical # Use CDROM installation media install url --url=http://1.1.1.21/icloud_1.0/isos/aarch64/ # Keyboard layouts keyboard --vckeymap=us --xlayouts=\u0026#39;\u0026#39; # System language lang zh_CN.UTF-8 # Root password rootpw --iscrypted 123.com # Run the Setup Agent on first boot firstboot --enable # Do not configure the X Window System skipx # System services services --enabled=\u0026#34;chronyd\u0026#34; # System timezone timezone Asia/Shanghai --isUtc %packages @^vmserver-compute-node %end %anaconda pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty %end reboot 3.3.2 tftp æœåŠ¡é…ç½® rm -rf /var/lib/tftpboot/* cp /var/www/html/icloud_1.0/isos/aarch64/EFI/BOOT/grub.cfg /var/lib/tftpboot/ cp /var/www/html/icloud_1.0/isos/aarch64/EFI/BOOT/grubaa64.efi /var/lib/tftpboot/ cp /var/www/html/icloud_1.0/isos/aarch64/images/pxeboot/vmlinuz /var/lib/tftpboot/ cp /var/www/html/icloud_1.0/isos/aarch64/images/pxeboot/initrd.img /var/lib/tftpboot/ chmod -R 755 /var/lib/tftpboot/* systemctl restart tftp vim /var/lib/tftpboot/grub.cfg\nset default=\u0026#34;1\u0026#34; function load_video { if [ x$feature_all_video_module = xy ]; then insmod all_video else insmod efi_gop insmod efi_uga insmod ieee1275_fb insmod vbe insmod vga insmod video_bochs insmod video_cirrus fi } load_video set gfxpayload=keep insmod gzio insmod part_gpt insmod ext2 set timeout=6 ### END /etc/grub.d/00_header ### search --no-floppy --set=root -l \u0026#39;iCloudOS-1.0-aarch64\u0026#39; ### BEGIN /etc/grub.d/10_linux ### menuentry \u0026#39;Install iCloudOS 1.0 with GUI mode\u0026#39; --class red --class gnu-linux --class gnu --class os { set root=(tftp,1.1.1.21) linux /vmlinuz ro inst.geoloc=0 console=ttyAMA0 console=tty0 rd.iscsi.waitnet=0 inst.repo=http://1.1.1.21/icloud_1.0/isos/aarch64 inst.ks=http://1.1.1.21/ks/ks-icloud-1.0-aarch64.cfg initrd /initrd.img } 3.4 openeuler_20.03-LTS_aarch64 3.4.1 http æœåŠ¡é…ç½® åˆ›å»ºç›®å½•\n# åˆ›å»ºç›®å½• mkdir -p /var/www/html/openeuler_20.03-LTS/isos/aarch64/ # æŒ‚è½½é•œåƒæ–‡ä»¶ mount -o loop /root/openEuler-20.03-LTS-aarch64-dvd.iso /var/www/html/openeuler_20.03-LTS/isos/aarch64/ # åˆ›å»ºks.cfgåº”ç­”æ–‡ä»¶ vim /var/www/html/ks/ks-openeuler-20.03-LTS-aarch64.cfg chmod -R 755 /var/www/html ks-openeuler-20.03-LTS-aarch64.cfg æ–‡ä»¶å†…å®¹\n#version=DEVEL ignoredisk --only-use=vda autopart --type=lvm # Partition clearing information clearpart --all --initlabel # Use graphical install graphical # Use CDROM installation media install url --url=http://1.1.1.21/openeuler_20.03-LTS/isos/aarch64 # Keyboard layouts keyboard --vckeymap=cn --xlayouts=\u0026#39;cn\u0026#39; # System language lang zh_CN.UTF-8 # Network information network --bootproto=static --device=enp3s0 --bootproto=dhcp --ipv6=auto --activate network --hostname=localhost.localdomain # Root password rootpw --iscrypted $6$x94MGsfCoFdE/G4O$MEakgOwtq0O5i4pRIVzXntKQuMJVh9CJ3anhZKl8YZhZDtSXhzuMk5mpDr3wu..rDareWgy5tjsepCaGiPK3g/ # X Window System configuration information xconfig --startxonboot # Run the Setup Agent on first boot firstboot --enable # System services services --enabled=\u0026#34;chronyd\u0026#34; # System timezone timezone Asia/Shanghai --isUtc %packages @^minimal-environment %end %anaconda pwpolicy root --minlen=8 --minquality=1 --notstrict --nochanges --notempty pwpolicy user --minlen=8 --minquality=1 --notstrict --nochanges --emptyok pwpolicy luks --minlen=8 --minquality=1 --notstrict --nochanges --notempty %end reboot 3.4.2 tftp æœåŠ¡é…ç½® rm -rf /var/lib/tftpboot/* cp /var/www/html/openeuler_20.03-LTS/isos/aarch64/EFI/BOOT/grub.cfg /var/lib/tftpboot/ cp /var/www/html/openeuler_20.03-LTS/isos/aarch64/EFI/BOOT/grubaa64.efi /var/lib/tftpboot/ cp /var/www/html/openeuler_20.03-LTS/isos/aarch64/images/pxeboot/vmlinuz /var/lib/tftpboot/ cp /var/www/html/openeuler_20.03-LTS/isos/aarch64/images/pxeboot/initrd.img /var/lib/tftpboot/ chmod -R 755 /var/lib/tftpboot/* systemctl restart tftp vim /var/lib/tftpboot/grub.cfg\nset default=\u0026#34;1\u0026#34; function load_video { if [ x$feature_all_video_module = xy ]; then insmod all_video else insmod efi_gop insmod efi_uga insmod ieee1275_fb insmod vbe insmod vga insmod video_bochs insmod video_cirrus fi } load_video set gfxpayload=keep insmod gzio insmod part_gpt insmod ext2 set timeout=60 ### END /etc/grub.d/00_header ### search --no-floppy --set=root -l \u0026#39;openEuler-20.03-LTS-aarch64\u0026#39; ### BEGIN /etc/grub.d/10_linux ### menuentry \u0026#39;Install openEuler 20.03 LTS\u0026#39; --class red --class gnu-linux --class gnu --class os { set root=(tftp,1.1.1.21) linux /vmlinuz ro inst.geoloc=0 console=ttyAMA0 console=tty0 rd.iscsi.waitnet=0 inst.repo=http://1.1.1.21/openeuler_20.03-LTS/isos/aarch64/ inst.ks=http://1.1.1.21/ks/ks-openeuler-20.03-LTS-aarch64.cfg initrd /initrd.img } } ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/pxe-install-scripts/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥ openEuler å®˜æ–¹æ–‡æ¡£ PXE è‡ªåŠ¨åŒ–å®‰è£… CentOS 8 PXE ç½‘ç»œå¼•å¯¼ç³»ç»Ÿä¹‹æœåŠ¡å™¨ arm64 æµ‹è¯•ç¯å¢ƒï¼š x86_64ï¼ˆamd ryzen 7 4800uï¼‰ï¼švmware workstation V16.1.2 aarch64ï¼ˆkunpeng 920ï¼‰ï¼š kvm-2.12 æ³¨æ„æµ‹è¯•çš„ç½‘ç»œç¯å¢ƒä¸­ä¸è¦å­˜åœ¨å…¶ä»–çš„ dhcp æœåŠ¡ æ³¨æ„æµ‹è¯•è™šæ‹Ÿæœºå†…å­˜å°½é‡å¤§äº 4Gï¼Œå¦åˆ™ä¼šæŠ¥é”™ no space left æˆ–è€…æµ‹è¯•æœºç›´æ¥","title":"pxe å®‰è£…é…ç½®å¤§å…¨"},{"content":"0 å‰è¨€ ä¹¦åã€Šäººé—´å¤±æ ¼ã€‹ï¼ŒåŒ—äº¬ç‡•å±±å‡ºç‰ˆç¤¾ï¼Œè¯‘è€…é«˜è‰³\n1 è¯­å¥æ‘˜å½• äººæ˜¯ä¸å¯èƒ½ä¸€è¾¹ç¬‘è¿˜ä¸€è¾¹ç´§ç´§æ”¥ç€æ‹³å¤´çš„ï¼Œåªæœ‰çŒ´å­æ‰ä¼šè¿™æ ·\nå¥³äººå¦‚æœçªç„¶å“­èµ·æ¥ï¼Œåªè¦è®©å¥¹ä»¬åƒäº›å¥½åƒçš„ä¸œè¥¿ï¼Œå¥¹ä»¬å°±ä¼šç«‹åˆ»å¥½è½¬\nè¶Šæ˜¯å¯¹äººæ„Ÿåˆ°ææƒ§çš„äººï¼Œåå€’è¶Šå¸Œæœ›äº²çœ¼çœ‹åˆ°ç‹°ç‹ææ€–çš„æ€ªç‰©ï¼›è¶Šæ˜¯èƒ†å°æ€¯æ‡¦ã€ç¥ç»å…®å…®çš„äººï¼Œè¶Šæ˜¯æœŸç›¼æš´é£é›¨æ¥çš„æ›´çŒ›çƒˆä¸€äº›\nä¸–ä¸Šæ‰€æœ‰äººçš„è¯´è¯æ–¹å¼ï¼Œéƒ½å–œæ¬¢è¿™æ ·ç»•åœˆå­ï¼Œä¸æ˜è¯´ï¼Œä¹Ÿä¸è¯´ç ´ï¼Œå¸¦ç€æƒ³é€ƒé¿è´£ä»»çš„å¿ƒç†ï¼Œå¤æ‚åˆå¾®å¦™\næˆ‘å¯¹æ­»å€’æ˜¯ä¸åœ¨ä¹ï¼Œä½†å¦‚æœå› å—ä¼¤å˜æˆæ®‹ç–¾äººï¼Œæˆ‘æ˜¯æ¥å—ä¸äº†çš„\nâ€œä½ å–å¤ªå¤šé…’äº†ã€‚â€\nâ€œä¸å–äº†ï¼ä»æ˜å¤©èµ·ï¼Œæˆ‘æ»´é…’ä¸æ²¾äº†ï¼â€\nâ€œçœŸçš„ï¼Ÿâ€\nâ€œçœŸçš„ï¼Œæˆ‘ä¸€å®šæˆ’ã€‚å‡å¦‚æˆ‘æˆ’äº†ï¼Œè‰¯å­è‚¯å«ç»™æˆ‘å—ï¼Ÿâ€ è¯´è¦å¨¶å¥¹çš„äº‹ï¼Œå…¶å®æ˜¯ä¸€å¥ç©ç¬‘è¯ã€‚\nâ€œå½“ç„¶äº†ã€‚â€\nâ€œå¥½ï¼Œé‚£æˆ‘ä»¬å°±ä¸€è¨€ä¸ºå®šã€‚æˆ‘è‚¯å®šæˆ’é…’â€\nå¯ç¬¬äºŒå¤©ï¼Œæˆ‘åˆç…§æ ·ä»ä¸­åˆèµ·ä¾¿æèµ·é…’ç›…æ¥ã€‚å‚æ™šæ—¶åˆ†ï¼Œæˆ‘æ‘‡æ‘‡æ™ƒæ™ƒèµ°å‡ºé…’é¦†ï¼Œç«™åœ¨ç”±å­å®¶çš„é“ºå­å‰ã€‚\nâ€œè‰¯å­ï¼Œå¯¹ä¸èµ·ï¼Œæˆ‘åˆå–é…’äº†ã€‚â€\nâ€œå“å‘€ï¼ŒçœŸè®¨åŒï¼Œæ•…æ„è£…æˆä¸€å‰¯å–é†‰çš„æ ·å­ã€‚â€\næˆ‘è¢«å¥¹çš„è¯å“äº†ä¸€è·³ï¼Œé…’ä¸€ä¸‹å­é†’äº†è®¸å¤šã€‚\nâ€œä¸ï¼Œæ˜¯çœŸçš„ã€‚æˆ‘çœŸå–é…’äº†ï¼Œä¸æ˜¯æ•…æ„è£…æˆå–é†‰çš„æ ·å­ã€‚â€\nâ€œåˆ«æ‰å¼„æˆ‘ï¼Œä½ çœŸåã€‚â€ å¥¹å¯¹æˆ‘ä¸æ¯«æ²¡æœ‰ç–‘å¿ƒã€‚\nâ€œä½ ä¸€çœ‹ä¸å°±æ˜ç™½äº†ï¼Ÿæˆ‘ä»Šå¤©åˆä»ä¸­åˆå¼€å§‹å–é…’äº†ã€‚åŸè°…æˆ‘ï¼â€\nâ€œä½ æ¼”æˆæ¼”å¾—çœŸåƒã€‚â€\nâ€œä¸æ˜¯æ¼”æˆï¼Œä½ è¿™ä¸ªå‚»ä¸«å¤´ï¼å½“å¿ƒæˆ‘äº²ä½ å“¦ã€‚â€\nâ€œäº²å‘€ï¼â€\nâ€œä¸ï¼Œæˆ‘æ²¡æœ‰èµ„æ ¼äº²ä½ ã€‚è¦ä½ å«ç»™æˆ‘çš„äº‹ï¼Œå°±æ­¤ä½œç½¢å§ã€‚ä½ çœ‹æˆ‘çš„è„¸ï¼Œé€šçº¢é€šçº¢çš„æ˜¯å§ï¼Ÿæˆ‘ç¡®å®å–äº†ã€‚â€\nâ€œé‚£æ˜¯å› ä¸ºå¤•é˜³ç…§åœ¨è„¸ä¸Šçš„ç¼˜æ•…ï¼Œä½ éª—æˆ‘ä¹Ÿæ²¡ç”¨çš„ã€‚å› ä¸ºæˆ‘ä»¬æ˜¨å¤©è¯´å®šäº†ï¼Œä½ ä¸å¯èƒ½å»å–é…’çš„ï¼Œä½ æ‰¿è¯ºè¿‡æˆ‘ï¼Œä½ å´è¯´è‡ªå·±å–é…’äº†ï¼Œè‚¯å®šæ˜¯åœ¨éª—äººã€éª—äººã€éª—äººï¼â€\n","permalink":"https://www.lvbibir.cn/posts/read/ren-jian-shi-ge/","summary":"0 å‰è¨€ ä¹¦åã€Šäººé—´å¤±æ ¼ã€‹ï¼ŒåŒ—äº¬ç‡•å±±å‡ºç‰ˆç¤¾ï¼Œè¯‘è€…é«˜è‰³ 1 è¯­å¥æ‘˜å½• äººæ˜¯ä¸å¯èƒ½ä¸€è¾¹ç¬‘è¿˜ä¸€è¾¹ç´§ç´§æ”¥ç€æ‹³å¤´çš„ï¼Œåªæœ‰çŒ´å­æ‰ä¼šè¿™æ · å¥³äººå¦‚æœçªç„¶å“­èµ·æ¥ï¼Œåªè¦è®©å¥¹ä»¬åƒäº›å¥½åƒçš„ä¸œè¥¿ï¼Œå¥¹ä»¬å°±ä¼šç«‹åˆ»å¥½è½¬ è¶Šæ˜¯å¯¹äººæ„Ÿåˆ°ææƒ§çš„äººï¼Œåå€’è¶Šå¸Œæœ›äº²çœ¼çœ‹åˆ°ç‹°ç‹ææ€–çš„æ€ªç‰©ï¼›è¶Šæ˜¯èƒ†å°æ€¯æ‡¦ã€ç¥ç»å…®å…®çš„äººï¼Œè¶Šæ˜¯æœŸç›¼æš´é£é›¨æ¥çš„æ›´çŒ›","title":"ã€Šäººé—´å¤±æ ¼ã€‹"},{"content":" æ ‡é¢˜è¯´æ˜: æœˆä»½ _ å½“æœˆè·‘æ­¥æ¬¡æ•° _ å½“æœˆè·‘æ­¥è·ç¦»\n2025 11_09_105 10_09_78 09_15_154 08_11_111 07_15_135 06_13_116 05_07_48 04_07_70 03_12_91 02_07_47 01_08_72 2024 12_13_117 11_12_103 10_10_82 09_07_66 08_09_89 07_16_200 06_08_73 05_10_101 04_08_65 03_10_55 02_04_20 01_05_25 2023 12_05_40 11_05_40 10_06_62 09_18_140 08_05_25 01-07_15_64 2022 12_01_5 11_08_51 10_16_100 09_13_123 0917 ç¬¬ä¸€æ¬¡åŠé©¬ 08_15_124 0827 ç¬¬ä¸€æ¬¡ 15km 07_15_78 0728 ç¬¬ä¸€æ¬¡ 10km 0706 ç¬¬ä¸€æ¬¡ 5km 06_10_26 ","permalink":"https://www.lvbibir.cn/posts/life/running/","summary":"æ ‡é¢˜è¯´æ˜: æœˆä»½ _ å½“æœˆè·‘æ­¥æ¬¡æ•° _ å½“æœˆè·‘æ­¥è·ç¦» 2025 11_09_105 10_09_78 09_15_154 08_11_111 07_15_135 06_13_116 05_07_48 04_07_70 03_12_91 02_07_47 01_08_72 2024 12_13_117 11_12_103 10_10_82 09_07_66 08_09_89 07_16_200 06_08_73 05_10_101 04_08_65 03_10_55 02_04_20 01_05_25 2023 12_05_40 11_05_40 10_06_62 09_18_140 08_05_25 01-07_15_64 2022 12_01_5 11_08_51 10_16_100 09_13_123 0917 ç¬¬ä¸€æ¬¡åŠé©¬ 08_15_124 0827 ç¬¬ä¸€æ¬¡ 15km 07_15_78 0728 ç¬¬ä¸€æ¬¡ 10km 0706 ç¬¬ä¸€æ¬¡ 5km 06_10_26","title":"è·‘æ­¥æ—¥å¸¸"},{"content":"0 å‰è¨€ cve å®˜ç½‘æˆ–è€…å·¥ä¿¡éƒ¨ä¼šå‘å¸ƒä¸€äº› cve æ¼æ´ï¼Œå¯ä»¥çœ‹åˆ°è¯¥æ¼æ´åœ¨æŸæ¬¡ commit æäº¤ä»£ç åä¿®å¤çš„ã€‚\nå¯ä»¥é€šè¿‡æ£€ç´¢ kernel.org ä¸­æ‰€æœ‰å†…æ ¸ç‰ˆæœ¬çš„ ChangeLog æ–‡ä»¶ä¸­æ˜¯å¦åŒ…å«è¯¥ commit æ¥åˆ¤æ–­æ¼æ´å½±å“çš„å†…æ ¸ç‰ˆæœ¬ï¼ˆä»…é’ˆå¯¹ linux çš„ kernel ç›¸å…³çš„æ¼æ´ï¼‰\n1 è„šæœ¬ #!/bin/bash # author: lvbibir # date: 2022-06-23 # æ£€ç´¢ kernel.org ä¸‹çš„æ‰€æœ‰ ChangeLog æ–‡ä»¶ï¼Œæ˜¯å¦åŒ…å«æŸé¡¹ç‰¹å®šçš„ commit å· commit=\u0026#39;520778042ccca019f3ffa136dd0ca565c486cedd\u0026#39; version=4 number=0 curl -ks https://cdn.kernel.org/pub/linux/kernel/v$version\\.x/ \u0026gt; list_$version cat list_$version | grep Change | grep -v sign | awk -F\\\u0026#34; \u0026#39;{print $2}\u0026#39; \u0026gt; list_$version\\_cut total=`wc -l list_$version\\_cut | awk \u0026#39;{print $1}\u0026#39;` while read line; do let \u0026#39;number+=1\u0026#39; url=\u0026#34;https://cdn.kernel.org/pub/linux/kernel/v$version.x/$line\u0026#34; echo -e \u0026#34;\\033[31m---------------------æ­£åœ¨æ£€ç´¢$url----------------ç¬¬$number ä¸ªæ–‡ä»¶ï¼Œå…±$total ä¸ªæ–‡ä»¶\\033[0m\u0026#34; curl -ks $url | grep $commit if [ $? -eq 0 ]; then echo $url \u0026gt;\u0026gt; ./result_$version fi done \u0026lt; ./list_$version\\_cut echo -e \u0026#34;\\033[32mè„šæœ¬æ‰§è¡Œå®Œæˆï¼Œç»“æœå·²ä¿å­˜è‡³å½“å‰ç›®å½•çš„ result_$version \\033[0m\u0026#34; ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/shell-search-url-files/","summary":"0 å‰è¨€ cve å®˜ç½‘æˆ–è€…å·¥ä¿¡éƒ¨ä¼šå‘å¸ƒä¸€äº› cve æ¼æ´ï¼Œå¯ä»¥çœ‹åˆ°è¯¥æ¼æ´åœ¨æŸæ¬¡ commit æäº¤ä»£ç åä¿®å¤çš„ã€‚ å¯ä»¥é€šè¿‡æ£€ç´¢ kernel.org ä¸­æ‰€æœ‰å†…æ ¸ç‰ˆæœ¬çš„ ChangeLog æ–‡ä»¶ä¸­æ˜¯å¦åŒ…å«è¯¥ commit æ¥åˆ¤æ–­æ¼æ´å½±å“çš„å†…æ ¸ç‰ˆæœ¬ï¼ˆä»…é’ˆå¯¹ linux çš„ kernel ç›¸å…³çš„æ¼æ´ï¼‰ 1 è„šæœ¬ #!/bin/bash # author: lvbibir # date: 2022-06-23 # æ£€ç´¢ kernel.org ä¸‹çš„æ‰€æœ‰ ChangeLog æ–‡ä»¶ï¼Œæ˜¯å¦åŒ…å«æŸé¡¹ç‰¹å®šçš„ commit å· commit=\u0026#39;520778042ccca019f3ffa136dd0ca565c486cedd\u0026#39; version=4 number=0 curl -ks https://cdn.kernel.org/pub/linux/kernel/v$version\\.x/ \u0026gt; list_$version cat list_$version | grep Change | grep -v sign","title":"shell | æ£€ç´¢æŸ url ä¸­æ‰€æœ‰æ–‡ä»¶çš„å†…å®¹"},{"content":"1 git 1.1 submodule å½“ clone ä¸€ä¸ªå«æœ‰å­æ¨¡å—çš„ git ä»“åº“æ—¶å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£…æ‰€æœ‰å­æ¨¡å—\ngit submodule init git submodule update 1.2 branch ç®¡ç† æŸ¥çœ‹åˆ†æ”¯\ngit branch -a åˆ›å»ºåˆ†æ”¯\n# ä»¥å½“å‰åˆ†æ”¯ä¸ºæ¨¡æ¿åˆ›å»ºå¹¶åˆ‡æ¢åˆ†æ”¯ git checkout -b dev # ä»¥ master ä¸ºæ¨¡æ¿åˆ›å»ºå¹¶åˆ‡æ¢åˆ†æ”¯, master å¯ä»¥æ˜¯å“ˆå¸Œå€¼æˆ–è€… origin/master è¿™ç§è¿œç¨‹åœ°å€ git checkout -b dev master # æ¨é€åˆ†æ”¯, å¦‚è¿œç«¯ä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»º git checkout dev git push origin dev åˆ é™¤åˆ†æ”¯\n# æœ¬åœ°åˆ é™¤ git checkout master git branch -d dev # å¦‚æœåˆ†æ”¯åŒ…å«æœªåˆå¹¶çš„æ›´æ”¹ï¼Œä½¿ç”¨ `-D` å¼ºåˆ¶åˆ é™¤ git branch -D dev # è¿œç«¯åˆ é™¤ git push origin --delete dev # æˆ– git push origin :dev 2 git é…ç½® æŸ¥çœ‹ git è®¾ç½®\n# å½“å‰ä»“åº“ git config --list # å…¨å±€é…ç½® git config --global --list 2.1 è®¾ç½®ä»£ç† è®¾ç½®å…¨å±€ä»£ç†ï¼Œä½¿ç”¨ http ä»£ç†\ngit config --global https.proxy http://127.0.0.1:1080 git config --global https.proxy https://127.0.0.1:1080 å–æ¶ˆ github.com ä»£ç†\ngit config --global --unset http.https://github.com.proxy git config --global --unset https.https://github.com.proxy è®¾ç½®å…¨å±€ä»£ç†ï¼Œä½¿ç”¨ socks5 ä»£ç†\ngit config --global http.proxy socks5://127.0.0.1:1080 git config --global https.proxy socks5://127.0.0.1:1080 å–æ¶ˆå…¨å±€ä»£ç†\ngit config --global --unset http.proxy git config --global --unset https.proxy åªå¯¹ github.com ä½¿ç”¨ä»£ç†\ngit config --global http.https://github.com.proxy http://127.0.0.1:7890 git config --global https.https://github.com.proxy http://127.0.0.1:7890 2.2 CRLF å’Œ LF # æäº¤æ—¶è½¬æ¢ä¸ºLFï¼Œæ£€å‡ºæ—¶è½¬æ¢ä¸ºCRLF git config --global core.autocrlf true # æäº¤æ—¶è½¬æ¢ä¸ºLFï¼Œæ£€å‡ºæ—¶ä¸è½¬æ¢ git config --global core.autocrlf input # æäº¤æ£€å‡ºå‡ä¸è½¬æ¢ git config --global core.autocrlf false # æ‹’ç»æäº¤åŒ…å«æ··åˆæ¢è¡Œç¬¦çš„æ–‡ä»¶ git config --global core.safecrlf true # å…è®¸æäº¤åŒ…å«æ··åˆæ¢è¡Œç¬¦çš„æ–‡ä»¶ git config --global core.safecrlf false # æäº¤åŒ…å«æ··åˆæ¢è¡Œç¬¦çš„æ–‡ä»¶æ—¶ç»™å‡ºè­¦å‘Š git config --global core.safecrlf warn 3 å¸¸è§é—®é¢˜ 3.1 git clone æŠ¥é”™ fatal: early EOF\nfatal: fetch-pack: invalid index-pack output\nè§£å†³\ngit config --global http.sslVerify \u0026#34;false\u0026#34; git config --global core.compression -1 ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/git/","summary":"1 git 1.1 submodule å½“ clone ä¸€ä¸ªå«æœ‰å­æ¨¡å—çš„ git ä»“åº“æ—¶å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£…æ‰€æœ‰å­æ¨¡å— git submodule init git submodule update 1.2 branch ç®¡ç† æŸ¥çœ‹åˆ†æ”¯ git branch -a åˆ›å»ºåˆ†æ”¯ # ä»¥å½“å‰åˆ†æ”¯ä¸ºæ¨¡æ¿åˆ›å»ºå¹¶åˆ‡æ¢åˆ†æ”¯ git checkout -b dev # ä»¥ master ä¸ºæ¨¡æ¿åˆ›å»ºå¹¶åˆ‡æ¢åˆ†æ”¯, master å¯ä»¥æ˜¯å“ˆå¸Œå€¼æˆ–è€… origin/master è¿™ç§è¿œç¨‹åœ°å€ git checkout -b dev master # æ¨é€åˆ†æ”¯, å¦‚è¿œç«¯ä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»º git checkout dev git push origin dev åˆ é™¤åˆ†æ”¯ # æœ¬åœ°","title":"git"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\nè¯¦è§£ shell ä¸­ sourceã€shã€bashã€./ æ‰§è¡Œè„šæœ¬çš„åŒºåˆ« 1 ä¸åŒçš„æ‰§è¡Œæ–¹å¼ shell è„šæœ¬é€šå¸¸æœ‰ sh filenameã€bash filenameã€./filenameã€source filename è¿™å››ç§æ‰§è¡Œæ–¹å¼\nsource filename å¯ä»¥ä½¿ç”¨ . filename ä»£æ›¿ï¼Œåœ¨å½“å‰çš„ bash ç¯å¢ƒä¸‹è¯»å–å¹¶æ‰§è¡Œè„šæœ¬æ–‡ä»¶ä¸­çš„å‘½ä»¤ï¼Œä¸”è„šæœ¬æ–‡ä»¶çš„å˜é‡ï¼Œåœ¨è„šæœ¬æ‰§è¡Œå®Œæˆåä¼šä¿å­˜ä¸‹æ¥ ./filename å’Œ sh filename æˆ–è€… bash filename æ˜¯ç­‰æ•ˆçš„ï¼Œéƒ½æ˜¯å¼€å¯ä¸€ä¸ªå­ shell æ¥è¿è¡Œè„šæœ¬æ–‡ä»¶ï¼Œè„šæœ¬ä¸­è®¾ç½®çš„å˜é‡æ‰§è¡Œå®Œæ¯•åä¸ä¼šä¿å­˜ é™¤ ./filename å¤–ï¼Œsource filename ã€. filename ã€sh filename ã€bash filename éƒ½æ˜¯ä¸éœ€è¦æ‰§è¡Œæƒé™çš„\nå˜é‡å’Œæƒé™é—®é¢˜ç¤ºä¾‹\n# è®¾ç½®ä¸´æ—¶å˜é‡ï¼Œä»…åœ¨å½“å‰ bash ç¯å¢ƒç”Ÿæ•ˆ [root@lvbibir ~]# name=lvbibir [root@lvbibir ~]# echo $name lvbibir [root@lvbibir ~]# [root@lvbibir ~]# cat test.sh #!/bin/bash echo $name # source æˆ–è€… . å¯ä»¥è·å–åˆ°çˆ¶ bash ç¯å¢ƒçš„å˜é‡ [root@lvbibir ~]# source test.sh lvbibir [root@lvbibir ~]# . test.sh lvbibir # shã€bashã€./ä¸‰ç§æ–¹å¼éƒ½ä½¿ç”¨äº†å­ bash ç¯å¢ƒï¼Œæ‰€ä»¥æ— æ³•è·å–çˆ¶ bash ç¯å¢ƒçš„å˜é‡ # ./ æ–¹å¼éœ€è¦è„šæœ¬æœ‰æ‰§è¡Œæƒé™ [root@lvbibir ~]# sh test.sh [root@lvbibir ~]# bash test.sh [root@lvbibir ~]# ./test.sh -bash: ./test.sh: Permission denied [root@lvbibir ~]# chmod a+x test.sh [root@lvbibir ~]# ./test.sh åŒç†ï¼Œä½¿ç”¨ source æˆ–è€… . ä¹Ÿå¯ä»¥åœ¨ bash ç¯å¢ƒä¸­è·å–åˆ°è„šæœ¬ä¸­è®¾ç½®çš„å˜é‡\n[root@lvbibir ~]# cat \u0026gt; test.sh \u0026lt;\u0026lt; EOF \u0026gt; #!/bin/bash \u0026gt; number=22 \u0026gt; \u0026gt; EOF [root@lvbibir ~]# echo $number # sh bash ./ ä¸‰ç§æ–¹å¼æ— æ³•è·å–è„šæœ¬ä¸­çš„å˜é‡ [root@lvbibir ~]# [root@lvbibir ~]# sh test.sh [root@lvbibir ~]# echo $number [root@lvbibir ~]# bash test.sh [root@lvbibir ~]# echo $number [root@lvbibir ~]# ./test.sh [root@lvbibir ~]# echo $number # source æ–¹å¼å¯ä»¥è·å–è„šæœ¬ä¸­çš„å˜é‡ [root@lvbibir ~]# source test.sh [root@lvbibir ~]# echo $number 22 [root@lvbibir ~]# 2 å…¶ä»–é—®é¢˜ å…³äºæ˜¯å¦åœ¨å­ bash ç¯å¢ƒè¿è¡Œçš„åŒºåˆ«å‡ºäº†å˜é‡é—®é¢˜è¿˜ä¼šå­˜åœ¨ä¸€äº›å…¶ä»–å½±å“ï¼Œå¦‚ä¸‹æµ‹è¯•\nå·²çŸ¥ç›®å‰å­˜åœ¨ä¸€ä¸ª mysqld è¿›ç¨‹ï¼Œå…¶ pid ä¸º 29426 ï¼Œå†™ä¸€ä¸ªç›‘æ§ pid çš„è„šæœ¬\n[root@lvbibir ~]# cat test.sh #!/bin/bash process=$1 pid=$(ps -elf | grep $process | grep -v grep | awk \u0026#39;{print $4}\u0026#39;) echo $pid ä¸¤ç§æ–¹å¼åˆ†åˆ«è¿è¡Œä¸€ä¸‹\n[root@lvbibir ~]# sh test.sh mysqld 27038 27039 29426 [root@lvbibir ~]# bash test.sh mysqld 27047 27048 29426 [root@lvbibir ~]# ./test.sh mysqld 27056 27057 29426 [root@lvbibir ~]# [root@lvbibir ~]# source test.sh mysqld 29426 [root@lvbibir ~]# . test.sh mysqld 29426 [root@lvbibir ~]# é—®é¢˜å‡ºç°äº†ï¼Œç”±äºæŸç§åŸå› å¯¼è‡´å­ bash ç¯å¢ƒä¸­æ‰§è¡Œçš„è„šæœ¬ç›‘æ§åˆ°å¤šä¸ª pid ï¼Œç»™è„šæœ¬æ·»åŠ ä¸ª sleep æ¥çœ‹ä¸‹\n[root@lvbibir ~]# cat test.sh #!/bin/bash process=$1 pid=$(ps -elf | grep $process | grep -v grep | awk \u0026#39;{print $4}\u0026#39;) echo $pid sleep 30 [root@lvbibir ~]# ./test.sh mysqld 27396 27397 29426 æ–°å¼€ä¸€ä¸ªç»ˆç«¯ï¼ŒæŸ¥çœ‹è¿›ç¨‹\nç¬¬ä¸€ä¸ª pid æ˜¯åœ¨å­ shell ä¸­æ‰§è¡Œç›‘æ§è„šæœ¬çš„è¿›ç¨‹å· ç¬¬äºŒä¸ª pid ä¸å¤ªæ¸…æ¥šå“ªé‡Œæ¥çš„ï¼Œä¹Ÿ grep ä¸åˆ°è¿™ä¸ªè¿›ç¨‹å·ï¼Œåº”è¯¥æ˜¯è„šæœ¬æ‰§è¡Œä¸€ç¬é—´å°±é‡Šæ”¾æ‰äº† ç¬¬ä¸‰ä¸ª pid æ˜¯ mysql å®é™…è¿è¡Œä¸­çš„è¿›ç¨‹å· å®é™…ä¸­è„šæœ¬çš„ pid å’Œ mysqld çš„ pid é¡ºåºä¸å¤ªä¸€æ ·ï¼Œå–å†³äº pid çš„å¤§å°\nåœ¨è„šæœ¬å†æ·»åŠ ä¸ª grep è¿‡æ»¤æ‰è„šæœ¬æœ¬èº«çš„è¿›ç¨‹æ¥è§„é¿è¿™ä¸ªé—®é¢˜\n[root@lvbibir ~]# cat test.sh #!/bin/bash process=$1 pid=$(ps -elf | grep $process | grep -v grep | grep -v bash | awk \u0026#39;{print $4}\u0026#39;) echo $pid [root@lvbibir ~]# ./test.sh mysqld 29426 ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/shell-different-execution-mode/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: è¯¦è§£ shell ä¸­ sourceã€shã€bashã€./ æ‰§è¡Œè„šæœ¬çš„åŒºåˆ« 1 ä¸åŒçš„æ‰§è¡Œæ–¹å¼ shell è„šæœ¬é€šå¸¸æœ‰ sh filenameã€bash filenameã€./filenameã€source filename è¿™å››ç§æ‰§è¡Œæ–¹å¼ source filename å¯ä»¥ä½¿ç”¨ . filename ä»£æ›¿ï¼Œåœ¨å½“å‰çš„ bash ç¯å¢ƒä¸‹è¯»å–å¹¶æ‰§è¡Œè„šæœ¬æ–‡ä»¶ä¸­çš„å‘½ä»¤ï¼Œä¸”è„šæœ¬æ–‡ä»¶","title":"shell | ä¸åŒæ‰§è¡Œæ–¹å¼çš„åŒºåˆ«"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\nBash è„šæœ¬ä¸­çš„ set -euxo pipefail shell è„šæœ¬æ˜¯æ²¡æœ‰ debug æ¨¡å¼çš„ï¼Œä¸è¿‡å¯ä»¥é€šè¿‡ set æŒ‡ä»¤å®ç°ç®€å•çš„ debug åŠŸèƒ½\nshell è„šæœ¬ä¸­é»˜è®¤æ¯æ¡æŒ‡ä»¤éƒ½ä¼šä»ä¸Šåˆ°ä¸‹ä¾æ¬¡æ‰§è¡Œï¼Œä½†æ˜¯å½“æŸè¡ŒæŒ‡ä»¤æŠ¥é”™æ—¶ï¼Œæˆ‘ä»¬å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯ä¸å¸Œæœ›ç»§ç»­æ‰§è¡Œåç»­æŒ‡ä»¤çš„\nè¿™æ—¶å¯ä»¥ä½¿ç”¨ shell è„šæœ¬ä¸­ set æŒ‡ä»¤çš„å››ä¸ªå‚æ•°ï¼š-eã€-uã€-xã€-o pipefail\nå‘½ä»¤æŠ¥é”™å³è¿”å›å€¼ï¼ˆ$?ï¼‰ä¸ä¸º 0\n1 set -e set -e é€‰é¡¹å¯ä»¥åœ¨è„šæœ¬å‡ºç°å¼‚å¸¸çš„æ—¶å€™ç«‹å³é€€å‡ºï¼Œåç»­å‘½ä»¤ä¸å†æ‰§è¡Œï¼Œç›¸å½“äºæ‰“ä¸Šäº†ä¸€ä¸ªæ–­ç‚¹\nif åˆ¤æ–­æ¡ä»¶é‡Œå‡ºç°å¼‚å¸¸ä¹Ÿä¼šç›´æ¥é€€å‡ºï¼Œå¦‚æœä¸å¸Œæœ›é€€å‡ºå¯ä»¥åœ¨åˆ¤æ–­è¯­å¥åé¢åŠ ä¸Š || true æ¥é˜»æ­¢é€€å‡º\n1.1 before è„šæœ¬å†…å®¹\nfoo æ˜¯ä¸€ä¸ªä¸å­˜åœ¨çš„å‘½ä»¤ï¼Œç”¨äºæ¨¡æ‹Ÿå‘½ä»¤æŠ¥é”™\n#!/bin/bash foo echo \u0026#34;hello\u0026#34; æ‰§è¡Œç»“æœ\n./test.sh: line 3: foo: command not found hello 1.2 after è„šæœ¬å†…å®¹\n#!/bin/bash set -e foo echo \u0026#34;hello\u0026#34; æ‰§è¡Œç»“æœ\n./test.sh: line 5: foo: command not found 1.3 é˜»æ­¢ç«‹å³é€€å‡ºçš„ä¾‹å­ #!/bin/bash set -e foo || true echo \u0026#34;hello\u0026#34; ./test.sh: line 5: foo: command not found hello 2 set -o pipefail é»˜è®¤æƒ…å†µä¸‹ bash åªä¼šæ£€æŸ¥ç®¡é“ï¼ˆpipelieï¼‰æ“ä½œçš„æœ€åä¸€ä¸ªå‘½ä»¤çš„è¿”å›å€¼ï¼Œå³æœ€åä¸€ä¸ªå‘½ä»¤è¿”å›å€¼ä¸º 0 åˆ™åˆ¤æ–­æ•´æ¡ç®¡é“è¯­å¥æ˜¯æ­£ç¡®çš„\nå¦‚ä¸‹\nset -o pipefail çš„ä½œç”¨å°±æ˜¯ç®¡é“ä¸­åªè¦æœ‰ä¸€ä¸ªå‘½ä»¤å¤±è´¥ï¼Œåˆ™æ•´ä¸ªç®¡é“è§†ä¸ºå¤±è´¥\n2.1 before #!/bin/bash set -e foo | echo \u0026#34;a\u0026#34; echo \u0026#34;hello\u0026#34; ./test.sh: line 5: foo: command not found a hello 2.2 after #!/bin/bash set -eo pipefail foo | echo \u0026#34;a\u0026#34; echo \u0026#34;hello\u0026#34; ./test.sh: line 5: foo: command not found a 3 set -u set -u çš„ä½œç”¨æ˜¯å°†æ‰€æœ‰æœªå®šä¹‰çš„å˜é‡è§†ä¸ºé”™è¯¯ï¼Œé»˜è®¤æƒ…å†µä¸‹ bash ä¼šå°†æœªå®šä¹‰çš„å˜é‡è§†ä¸ºç©º\n3.1 before #!/bin/bash set -eo pipefail echo $a echo \u0026#34;hello\u0026#34; hello 3.2 after #!/bin/bash set -euo pipefail echo $a echo \u0026#34;hello\u0026#34; ./test.sh: line 5: a: unbound variable 4 set -x set -x å¯ä»¥è®© bash æŠŠæ¯ä¸ªå‘½ä»¤åœ¨æ‰§è¡Œå‰å…ˆæ‰“å°å‡ºæ¥ï¼Œå¥½å¤„æ˜¾è€Œæ˜“è§ï¼Œå¯ä»¥å¿«é€Ÿæ–¹ä¾¿çš„æ‰¾åˆ°å‡ºé—®é¢˜çš„è„šæœ¬ä½ç½®ï¼Œåå¤„å°±æ˜¯ bash çš„ log ä¼šæ ¼å¤–çš„ä¹±\nå¦å¤–ï¼Œå®ƒåœ¨æ‰“å°çš„æ—¶å€™ä¼šå…ˆæŠŠå˜é‡è§£æå‡ºæ¥\nçºµç„¶ log å¯èƒ½ä¼šä¹±ä¸€äº›ï¼Œä½†ä¹Ÿæ¯” debug çš„æ—¶å€™æ‰å¤´å‘å¼º\n#!/bin/bash set -euox pipefail a=2 echo $a echo \u0026#34;hello\u0026#34; + a=2 + echo 2 # è¿™é‡Œå·²ç»å°†å˜é‡ a è§£æä¸º 2 äº† 2 + echo hello hello ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/shell-enable-debug-mode/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: Bash è„šæœ¬ä¸­çš„ set -euxo pipefail shell è„šæœ¬æ˜¯æ²¡æœ‰ debug æ¨¡å¼çš„ï¼Œä¸è¿‡å¯ä»¥é€šè¿‡ set æŒ‡ä»¤å®ç°ç®€å•çš„ debug åŠŸèƒ½ shell è„šæœ¬ä¸­é»˜è®¤æ¯æ¡æŒ‡ä»¤éƒ½ä¼šä»ä¸Šåˆ°ä¸‹ä¾æ¬¡æ‰§è¡Œï¼Œä½†æ˜¯å½“æŸè¡ŒæŒ‡ä»¤æŠ¥é”™æ—¶ï¼Œæˆ‘ä»¬å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯ä¸å¸Œæœ›ç»§ç»­æ‰§è¡Œåç»­æŒ‡ä»¤çš„ è¿™æ—¶å¯ä»¥ä½¿ç”¨ shell è„šæœ¬ä¸­ set æŒ‡ä»¤çš„å››ä¸ªå‚æ•°ï¼š-eã€-uã€-xã€-o pipefail å‘½ä»¤æŠ¥é”™å³è¿”å›å€¼","title":"shell | å¼€å¯ debug æ¨¡å¼"},{"content":"1 remote ssh ä½¿ç”¨å¯†é’¥ remote ssh è¿œç¨‹æœåŠ¡å™¨æ—¶æ¯æ¬¡éƒ½è¦æ±‚è¾“å…¥å¯†ç , å¯ä»¥é€šè¿‡å¯†é’¥å®ç°å…å¯†ç™»å½•\nä¿®æ”¹ ssh é…ç½®æ–‡ä»¶, ä¸€èˆ¬åœ¨ C:\\Users\\\u0026lt;username\u0026gt;\\.ssh\\config, é…ç½®æ–‡ä»¶çš„è·¯å¾„å–å†³äº remote ssh ä½¿ç”¨çš„é…ç½®æ–‡ä»¶, åœ¨æ–‡ä»¶å†…æ·»åŠ ç§é’¥çš„è·¯å¾„å³å¯, å¦‚ä¸‹\nHost lvbibir.cn HostName lvbibir.cn User root IdentityFile C:\\Users\\lvbibir\\.ssh\\id_rsa 2 å³é”®èœå•é—®é¢˜ å‰ç«¯æ—¶é—´çªç„¶å‘ç°æ–‡ä»¶å’Œç›®å½•çš„å³é”®èœå•ä¸­çš„ åœ¨ vscode ä¸­æ‰“å¼€ æ¶ˆå¤±, å¯ä»¥å°†ä¸‹è¿°ä»£ç ä¿å­˜ä¸º .reg æ–‡ä»¶å¹¶ä»¥ç®¡ç†å‘˜è¿è¡Œ, ==è®°å¾—å°†ç›®å½•ä¿®æ”¹ä¸ºæ­£ç¡®çš„ vscode å®‰è£…è·¯å¾„==\nWindows Registry Editor Version 5.00 [HKEY_CLASSES_ROOT\\*\\shell\\VSCode] @=\u0026#34;Open with Code\u0026#34; \u0026#34;Icon\u0026#34;=\u0026#34;D:\\\\software\\\\Vscode\\\\Code.exe\u0026#34; [HKEY_CLASSES_ROOT\\*\\shell\\VSCode\\command] @=\u0026#34;\\\u0026#34;D:\\\\software\\\\Vscode\\\\Code.exe\\\u0026#34; \\\u0026#34;%1\\\u0026#34;\u0026#34; Windows Registry Editor Version 5.00 [HKEY_CLASSES_ROOT\\Directory\\shell\\VSCode] @=\u0026#34;Open with Code\u0026#34; \u0026#34;Icon\u0026#34;=\u0026#34;D:\\\\software\\\\Vscode\\\\Code.exe\u0026#34; [HKEY_CLASSES_ROOT\\Directory\\shell\\VSCode\\command] @=\u0026#34;\\\u0026#34;D:\\\\software\\\\Vscode\\\\Code.exe\\\u0026#34; \\\u0026#34;%V\\\u0026#34;\u0026#34; Windows Registry Editor Version 5.00 [HKEY_CLASSES_ROOT\\Directory\\Background\\shell\\VSCode] @=\u0026#34;Open with Code\u0026#34; \u0026#34;Icon\u0026#34;=\u0026#34;D:\\\\software\\\\Vscode\\\\Code.exe\u0026#34; [HKEY_CLASSES_ROOT\\Directory\\Background\\shell\\VSCode\\command] @=\u0026#34;\\\u0026#34;D:\\\\software\\\\Vscode\\\\Code.exe\\\u0026#34; \\\u0026#34;%V\\\u0026#34;\u0026#34; ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/vscode-common-problems/","summary":"1 remote ssh ä½¿ç”¨å¯†é’¥ remote ssh è¿œç¨‹æœåŠ¡å™¨æ—¶æ¯æ¬¡éƒ½è¦æ±‚è¾“å…¥å¯†ç , å¯ä»¥é€šè¿‡å¯†é’¥å®ç°å…å¯†ç™»å½• ä¿®æ”¹ ssh é…ç½®æ–‡ä»¶, ä¸€èˆ¬åœ¨ C:\\Users\\\u0026lt;username\u0026gt;\\.ssh\\config, é…ç½®æ–‡ä»¶çš„è·¯å¾„å–å†³äº remote ssh ä½¿ç”¨çš„é…ç½®æ–‡ä»¶, åœ¨æ–‡ä»¶å†…æ·»åŠ ç§é’¥çš„è·¯å¾„å³å¯, å¦‚ä¸‹ Host lvbibir.cn HostName lvbibir.cn User root IdentityFile C:\\Users\\lvbibir\\.ssh\\id_rsa 2 å³é”®èœå•é—®é¢˜ å‰ç«¯æ—¶é—´çªç„¶å‘ç°æ–‡ä»¶å’Œç›®å½•çš„å³é”®èœå•ä¸­çš„ åœ¨ vscode ä¸­æ‰“å¼€ æ¶ˆå¤±, å¯ä»¥å°†ä¸‹è¿°ä»£ç ä¿å­˜ä¸º .reg æ–‡","title":"vscode | å¸¸è§é—®é¢˜"},{"content":"0 å‰è¨€ åœ¨å·¥ä½œä¸­éœ€è¦è¿æ¥å…¬å¸å†…ç½‘ï¼ˆæœ‰çº¿ï¼Œä¸å¯è”ç½‘ï¼‰ï¼Œè®¿é—®å¤–ç½‘æ—¶éœ€è¦è¿æ¥æ— çº¿\nåŒæ—¶æ¥å…¥è¿™ä¸¤ä¸ªç½‘ç»œæ—¶ï¼Œå†…ç½‘è®¿é—®æ­£å¸¸ï¼Œå¤–ç½‘æ— æ³•è®¿é—®ã€‚\næ­¤æ—¶å¯ä»¥é€šè¿‡è°ƒæ•´ç½‘ç»œä¼˜å…ˆçº§åŠé…ç½®è·¯ç”±å®ç°å†…å¤–ç½‘åŒæ—¶è®¿é—®\nä¸€èˆ¬æ¥è¯´ï¼Œå†…ç½‘çš„ç½‘æ®µæ•°é‡è¾ƒå°‘ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®ä½¿é»˜è®¤è·¯ç”±èµ°å¤–ç½‘ï¼Œèµ°å†…ç½‘æ—¶é€šè¿‡é…ç½®çš„é™æ€è·¯ç”±\n1 centos8 åœ¨ linux ç³»ç»Ÿä¸­ç½‘ç»œä¼˜å…ˆçº§æ˜¯é€šè¿‡ metric æ§åˆ¶çš„ï¼Œå€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œé€šè¿‡ route -n æŸ¥çœ‹è·¯ç”±\nå¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶å®ç°ï¼Œåœ¨ç½‘å¡é…ç½®æ–‡ä»¶ä¸­æ·»åŠ æˆ–è€…ä¿®æ”¹ IPV4_ROUTE_METRIC=100 å‚æ•°å®ç°ï¼Œä¹‹åé‡å¯ç½‘ç»œæœåŠ¡\n# network systemctl restart network # NetworkManager nmcli c reload nmcli c down enp3s0 nmcli c up enp3s0 route -n 1.1 æ·»åŠ è·¯ç”± ä¸´æ—¶æ·»åŠ é™æ€è·¯ç”±å‘½ä»¤å¦‚ä¸‹ï¼ˆé‡å¯æœåŠ¡å™¨æˆ–è€…é‡å¯ç½‘ç»œæœåŠ¡åæ¶ˆå¤±ï¼‰\nroute add -net 192.168.45.0 netmask 255.255.255.0 dev enp4s0 metric 3 æ°¸ä¹…æ·»åŠ é™æ€è·¯ç”±\nå‚ç…§ /etc/init.d/network ä¸­å¯¹ /etc/sysconfig/static-routes æ˜¯å¦‚ä½•å¤„ç†çš„\n/etc/sysconfig/static-routes æ–‡ä»¶ä¸å­˜åœ¨çš„è¯ï¼Œåˆ›å»ºä¸€ä¸ªå³å¯\n# Add non interface-specific static-routes. if [ -f /etc/sysconfig/static-routes ]; then if [ -x /sbin/route ]; then grep \u0026#34;^any\u0026#34; /etc/sysconfig/static-routes | while read ignore args ; do /sbin/route add -$args done else net_log $\u0026#34;Legacy static-route support not available: /sbin/route not found\u0026#34; fi fi åˆ™ï¼Œå¦‚æœæ·»åŠ ä¸€æ¡é™æ€è·¯ç”±çš„è·¯ç”±å¦‚ä¸‹\nroute add -net 192.168.45.0 netmask 255.255.255.0 dev enp4s0 metric 3 é‚£ä¹ˆï¼Œåœ¨ /etc/sysconfig/static-routes ä¸­å¯¹åº”çš„åˆ™åº”è¯¥å†™ä¸º\nany -net 192.168.45.0 netmask 255.255.255.0 dev enp4s0 metric 3 2 win10 2.1 è°ƒæ•´ç½‘ç»œä¼˜å…ˆçº§ æŸ¥çœ‹é»˜è®¤è·¯ç”±\nroute print 0.0.0.0 è¿™ä¸¤ä¸ªè·¯ç”±åˆ†åˆ«æ˜¯å†…ç½‘å’Œå¤–ç½‘çš„é»˜è®¤è·¯ç”±ï¼Œç»å¤§éƒ¨åˆ†æƒ…å†µç½‘ç»œéƒ½æ˜¯èµ°çš„é»˜è®¤è·¯ç”±ï¼Œä½†è¿™é‡Œæœ‰ä¸¤æ¡é»˜è®¤è·¯ç”±ï¼Œé»˜è®¤è·¯ç”±çš„ä¼˜å…ˆçº§æ˜¯æŒ‰ç…§è·ƒç‚¹æ•°çš„å¤šå°‘å†³å®šçš„ï¼Œè·ƒç‚¹æ•°è¶Šå°‘ï¼Œä¼˜å…ˆçº§è¶Šé«˜\nå°†å¤–ç½‘æ— çº¿çš„è·ƒç‚¹æ•°è°ƒå°\nroute print å¯ä»¥çœ‹åˆ°è·ƒç‚¹æ•°ä¿®æ”¹æˆåŠŸäº†ï¼Œæ­¤æ—¶å¤–ç½‘æ— çº¿çš„è·ƒç‚¹æ•°æ›´å°ï¼Œä¼˜å…ˆçº§æ›´é«˜\n2.2 é…ç½®è·¯ç”± é…ç½®è·¯ç”±éœ€è¦ä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œ powershell æˆ–è€… cmd\né…ç½®è·¯ç”±åï¼Œå†…ç½‘è®¿é—®ä¹Ÿæ²¡æœ‰é—®é¢˜äº†\nroute add 172.16.2.0 mask 255.255.255.0 172.30.4.254 metric 3 route add 172.16.3.0 mask 255.255.255.0 172.30.4.254 metric 3 route add 172.16.4.0 mask 255.255.255.0 172.30.4.254 metric 3 è¿™é‡Œé…ç½®çš„è·¯ç”±é‡å¯ç³»ç»Ÿåä¼šæ¶ˆå¤±ï¼ŒåŠ  -p é€‰é¡¹è®¾ç½®ä¸ºæ°¸ä¹…è·¯ç”±\nroute add -p 172.16.2.0 mask 255.255.255.0 172.30.4.254 metric 3 ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/network-priority/","summary":"0 å‰è¨€ åœ¨å·¥ä½œä¸­éœ€è¦è¿æ¥å…¬å¸å†…ç½‘ï¼ˆæœ‰çº¿ï¼Œä¸å¯è”ç½‘ï¼‰ï¼Œè®¿é—®å¤–ç½‘æ—¶éœ€è¦è¿æ¥æ— çº¿ åŒæ—¶æ¥å…¥è¿™ä¸¤ä¸ªç½‘ç»œæ—¶ï¼Œå†…ç½‘è®¿é—®æ­£å¸¸ï¼Œå¤–ç½‘æ— æ³•è®¿é—®ã€‚ æ­¤æ—¶å¯ä»¥é€šè¿‡è°ƒæ•´ç½‘ç»œä¼˜å…ˆçº§åŠé…ç½®è·¯ç”±å®ç°å†…å¤–ç½‘åŒæ—¶è®¿é—® ä¸€èˆ¬æ¥è¯´ï¼Œå†…ç½‘çš„ç½‘æ®µæ•°é‡è¾ƒå°‘ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®ä½¿é»˜è®¤è·¯ç”±èµ°å¤–ç½‘ï¼Œèµ°å†…ç½‘æ—¶é€šè¿‡é…ç½®çš„é™æ€è·¯ç”± 1 centos8 åœ¨ linux ç³»ç»Ÿä¸­ç½‘ç»œ","title":"windows \u0026 linux å¤šç½‘å¡æ—¶è®¾ç½®é»˜è®¤è·¯ç”±ä»¥åŠæ·»åŠ é™æ€è·¯ç”±"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\nã€MySQLã€‘ä¸»ä»å¤åˆ¶å®ç°åŸç†è¯¦è§£ åŸºäº centos-7.9 mysql-5.7.42\nmysql å®‰è£…å‚è€ƒ mysql ç³»åˆ—æ–‡ç« \n1 ä¸»ä»å¤åˆ¶åŸç† ä¸»ä»å¤åˆ¶æ¶‰åŠåˆ° 3 ä¸ªçº¿ç¨‹, 4 ä¸ªæ–‡ä»¶\n1.1 çº¿ç¨‹ master:\nlog dump : å½“ slave è¿æ¥ master æ—¶, ä¸»èŠ‚ç‚¹ä¼šä¸ºå…¶åˆ›å»ºä¸€ä¸ª log dump çº¿ç¨‹, ç”¨äºå‘é€å’Œè¯»å– binlog çš„å†…å®¹. åœ¨è¯»å– binlog ä¸­çš„æ“ä½œæ—¶, log dump çº¿ç¨‹ä¼šå¯¹ä¸»èŠ‚ç‚¹ä¸Šçš„ binlog åŠ é”, å½“è¯»å–å®Œæˆ, åœ¨å‘é€ç»™ä»èŠ‚ç‚¹ä¹‹å‰, é”ä¼šè¢«é‡Šæ”¾.\nä¸»èŠ‚ç‚¹ä¼šä¸ºè‡ªå·±çš„æ¯ä¸€ä¸ªä»èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ª log dump çº¿ç¨‹ .\nslave:\nIO : æ¥å— master å‘é€çš„ binlog æ–‡ä»¶ä½ç½®çš„å‰¯æœ¬. ç„¶åå°†æ•°æ®çš„æ›´æ–°è®°å½•åˆ° relaylog ä¸­. SQL : è´Ÿè´£è¯»å– relaylog ä¸­çš„å†…å®¹, è§£ææˆå…·ä½“çš„æ“ä½œå¹¶æ‰§è¡Œ, æœ€ç»ˆä¿è¯ä¸»ä»æ•°æ®çš„ä¸€è‡´æ€§ 1.2 æ–‡ä»¶ master:\nbinlog : äºŒè¿›åˆ¶æ–‡ä»¶, è®°å½•åº“ä¸­çš„ä¿¡æ¯ slave:\nrelaylog : ä¸­ç»§æ—¥å¿—, ç”¨æ¥åŒæ­¥ master çš„ binlog relaylog.info : è®°å½•æ–‡ä»¶å¤åˆ¶çš„è¿›åº¦. master.info : å­˜æ”¾ master ä¿¡æ¯, ä»¥åŠä¸Šæ¬¡è¯»å–åˆ°çš„ master åŒæ­¥è¿‡æ¥çš„ binlog çš„ä½ç½® 1.3 è¯¦ç»†æ­¥éª¤ slave æ‰§è¡Œ change master to å‘½ä»¤ ( master çš„è¿æ¥ä¿¡æ¯ + å¤åˆ¶çš„èµ·ç‚¹), å°†ä»¥ä¸Šä¿¡æ¯è®°å½•åˆ° master.info æ–‡ä»¶ slave æ‰§è¡Œ start slave å‘½ä»¤,å¼€å¯ IO çº¿ç¨‹å’Œ SQL çº¿ç¨‹ slave çš„ IO çº¿ç¨‹è¯»å– master.info æ–‡ä»¶ä¸­çš„ä¿¡æ¯, è·å–åˆ° IP, PORT, User, Pass, binlog çš„ä½ç½®ä¿¡æ¯ slave çš„ IO çº¿ç¨‹è¯·æ±‚è¿æ¥ master, master æä¾›ä¸€ä¸ª log dump çº¿ç¨‹, è´Ÿè´£å’Œ IO çº¿ç¨‹äº¤äº’ IO çº¿ç¨‹æ ¹æ® binlog çš„ä½ç½®ä¿¡æ¯ (mysql-bin.000004 , 444), è¯·æ±‚ master æ–°çš„ binlog master é€šè¿‡ log dump çº¿ç¨‹å°†æœ€æ–°çš„ binlog ä¼ è¾“ç»™ slave çš„ IO çº¿ç¨‹ IO çº¿ç¨‹æ¥æ”¶åˆ°æ–°çš„ binlog æ—¥å¿—, å­˜å‚¨åˆ° TCP/IP ç¼“å­˜, ç«‹å³è¿”å› ACK ç»™ master , å¹¶æ›´æ–° master.info IO çº¿ç¨‹å°† TCP/IP ç¼“å­˜ä¸­çš„æ•°æ®, è½¬å‚¨åˆ°ç£ç›˜ relaylog ä¸­ SQL çº¿ç¨‹è¯»å– relaylog.info ä¸­çš„ä¿¡æ¯, è·å–åˆ°ä¸Šæ¬¡å·²ç»åº”ç”¨è¿‡çš„ relaylog çš„ä½ç½®ä¿¡æ¯ SQL çº¿ç¨‹ä¼šæŒ‰ç…§ä¸Šæ¬¡çš„ä½ç½®ç‚¹å›æ”¾æœ€æ–°çš„ relaylog, å†æ¬¡æ›´æ–° relaylog.info ä¿¡æ¯ slave ä¼šè‡ªåŠ¨ purge åº”ç”¨è¿‡çš„ relaylog è¿›è¡Œå®šæœŸæ¸…ç† 2 ä¸»ä»å¤åˆ¶æ¨¡å¼ mysql é»˜è®¤ä¸€èˆ¬ä¸ºå¼‚æ­¥åŒæ­¥æ•°æ®\n2.1 å…¨åŒæ­¥ å½“ mster æ‰§è¡Œå®Œä¸€ä¸ªäº‹åŠ¡, ç„¶åæ‰€æœ‰çš„ slave éƒ½å¤åˆ¶äº†è¯¥äº‹åŠ¡å¹¶æˆåŠŸæ‰§è¡Œå®Œæ‰è¿”å›æˆåŠŸä¿¡æ¯ç»™å®¢æˆ·ç«¯. å› ä¸ºéœ€è¦ç­‰å¾…æ‰€æœ‰ slave æ‰§è¡Œå®Œè¯¥äº‹åŠ¡æ‰èƒ½è¿”å›æˆåŠŸä¿¡æ¯, æ‰€ä»¥å…¨åŒæ­¥å¤åˆ¶çš„æ€§èƒ½å¿…ç„¶ä¼šæ”¶åˆ°ä¸¥é‡çš„å½±å“.\n2.2 åŠåŒæ­¥ ä»‹äºå¼‚æ­¥å¤åˆ¶å’Œå…¨åŒæ­¥å¤åˆ¶ä¹‹é—´, master åœ¨æ‰§è¡Œå®Œå®¢æˆ·ç«¯æäº¤çš„äº‹åŠ¡åä¸æ˜¯ç«‹åˆ»è¿”å›ç»™å®¢æˆ·ç«¯, è€Œæ˜¯ç­‰å¾…è‡³å°‘ä¸€ä¸ª slave æ¥æ”¶åˆ°å¹¶å†™åˆ° relaylog ä¸­æ‰è¿”å›æˆåŠŸä¿¡æ¯ç»™å®¢æˆ·ç«¯ (åªèƒ½ä¿è¯ master çš„ binlog è‡³å°‘ä¼ è¾“åˆ°äº†ä¸€ä¸ª slave ä¸Š, ä½†å¹¶ä¸èƒ½ä¿è¯ slave å°†æ­¤äº‹åŠ¡æ‰§è¡Œæ›´æ–°åˆ° db ä¸­), å¦åˆ™éœ€è¦ç­‰å¾…ç›´åˆ°è¶…æ—¶æ—¶é—´ç„¶ååˆ‡æ¢æˆå¼‚æ­¥æ¨¡å¼å†æäº¤. ç›¸å¯¹äºå¼‚æ­¥å¤åˆ¶, åŠåŒæ­¥å¤åˆ¶æé«˜äº†æ•°æ®çš„å®‰å…¨æ€§, ä¸€å®šç¨‹åº¦çš„ä¿è¯äº†æ•°æ®èƒ½æˆåŠŸå¤‡ä»½åˆ° slave, åŒæ—¶å®ƒä¹Ÿé€ æˆäº†ä¸€å®šç¨‹åº¦çš„å»¶è¿Ÿ, ä½†æ˜¯æ¯”å…¨åŒæ­¥æ¨¡å¼å»¶è¿Ÿè¦ä½, è¿™ä¸ªå»¶è¿Ÿæœ€å°‘æ˜¯ä¸€ä¸ª TCP/IP å¾€è¿”çš„æ—¶é—´. æ‰€ä»¥, åŠåŒæ­¥å¤åˆ¶æœ€å¥½åœ¨ä½å»¶æ—¶çš„ç½‘ç»œä¸­ä½¿ç”¨.\n2.3 å¼‚æ­¥ master ä¸ä¼šä¸»åŠ¨æ¨é€ binlog åˆ° slave, master åœ¨æ‰§è¡Œå®Œå®¢æˆ·ç«¯æäº¤çš„äº‹åŠ¡åä¼šç«‹å³å°†ç»“æœè¿”ç»™ç»™å®¢æˆ·ç«¯, å¹¶ä¸å…³å¿ƒ slave æ˜¯å¦å·²ç»æ¥æ”¶å¹¶å¤„ç†, è¿™æ ·å°±ä¼šæœ‰ä¸€ä¸ªé—®é¢˜, master å¦‚æœå´©æºƒæ‰äº†, æ­¤æ—¶ master ä¸Šå·²ç»æäº¤çš„äº‹åŠ¡å¯èƒ½å¹¶æ²¡æœ‰ä¼ åˆ° slave ä¸Š, å¦‚æœæ­¤æ—¶, å¼ºè¡Œå°† slave æå‡ä¸º master, å¯èƒ½å¯¼è‡´æ–° master èŠ‚ç‚¹ä¸Šçš„æ•°æ®ä¸å®Œæ•´.\n3 ä¸»ä»å¤åˆ¶æ–¹å¼ MySQL ä¸»ä»å¤åˆ¶æœ‰ä¸‰ç§æ–¹å¼: åŸºäº SQL è¯­å¥çš„å¤åˆ¶ (statement-based replication, SBR), åŸºäºè¡Œçš„å¤åˆ¶ (row-based replication, RBR), æ··åˆæ¨¡å¼å¤åˆ¶ (mixed-based replication, MBR). å¯¹åº”çš„ bin-log æ–‡ä»¶çš„æ ¼å¼ä¹Ÿæœ‰ä¸‰ç§: STATEMENT, ROW, MIXED\nå¯é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ binlog æ ¼å¼\nSHOW VARIABLES LIKE \u0026#34;binlog_format\u0026#34;; 3.1 SBR å°±æ˜¯è®°å½• sql è¯­å¥åœ¨ bin-log ä¸­, Mysql 5.1.4 åŠä¹‹å‰çš„ç‰ˆæœ¬éƒ½æ˜¯ä½¿ç”¨çš„è¿™ç§å¤åˆ¶æ ¼å¼. ä¼˜ç‚¹æ˜¯åªéœ€è¦è®°å½•ä¼šä¿®æ”¹æ•°æ®çš„ sql è¯­å¥åˆ° bin-log ä¸­, å‡å°‘äº† bin-log æ—¥è´¨é‡, èŠ‚çº¦ I/O, æé«˜æ€§èƒ½. ç¼ºç‚¹æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹, ä¼šå¯¼è‡´ä¸»ä»èŠ‚ç‚¹ä¸­æ•°æ®ä¸ä¸€è‡´ (æ¯”å¦‚ sleep(), now() ç­‰).\n3.2 RBR mysql master å°† SQL è¯­å¥åˆ†è§£ä¸ºåŸºäº Row æ›´æ”¹çš„è¯­å¥å¹¶è®°å½•åœ¨ bin-log ä¸­, ä¹Ÿå°±æ˜¯åªè®°å½•å“ªæ¡æ•°æ®è¢«ä¿®æ”¹äº†, ä¿®æ”¹æˆä»€ä¹ˆæ ·. ä¼˜ç‚¹æ˜¯ä¸ä¼šå‡ºç°æŸäº›ç‰¹å®šæƒ…å†µä¸‹çš„å­˜å‚¨è¿‡ç¨‹ã€æˆ–è€…å‡½æ•°ã€æˆ–è€… trigger çš„è°ƒç”¨æˆ–è€…è§¦å‘æ— æ³•è¢«æ­£ç¡®å¤åˆ¶çš„é—®é¢˜. ç¼ºç‚¹æ˜¯ä¼šäº§ç”Ÿå¤§é‡çš„æ—¥å¿—, å°¤å…¶æ˜¯ä¿®æ”¹ table çš„æ—¶å€™ä¼šè®©æ—¥å¿—æš´å¢,åŒæ—¶å¢åŠ  bin-log åŒæ­¥æ—¶é—´. ä¹Ÿä¸èƒ½é€šè¿‡ bin-log è§£æè·å–æ‰§è¡Œè¿‡çš„ sql è¯­å¥, åªèƒ½çœ‹åˆ°å‘ç”Ÿçš„ data å˜æ›´.\n3.3 MBR MySQL NDB cluster 7.3 å’Œ 7.4 ä½¿ç”¨çš„ MBR. æ˜¯ä»¥ä¸Šä¸¤ç§æ¨¡å¼çš„æ··åˆ, å¯¹äºä¸€èˆ¬çš„å¤åˆ¶ä½¿ç”¨ STATEMENT æ¨¡å¼ä¿å­˜åˆ° bin-log, å¯¹äº STATEMENT æ¨¡å¼æ— æ³•å¤åˆ¶çš„æ“ä½œåˆ™ä½¿ç”¨ ROW æ¨¡å¼æ¥ä¿å­˜, MySQL ä¼šæ ¹æ®æ‰§è¡Œçš„ SQL è¯­å¥é€‰æ‹©æ—¥å¿—ä¿å­˜æ–¹å¼.\n4 GTID å¤åˆ¶ åœ¨åŸæ¥åŸºäºæ—¥å¿—çš„å¤åˆ¶ä¸­, slave éœ€è¦å‘ŠçŸ¥ master è¦ä»å“ªä¸ªåç§»é‡è¿›è¡Œå¢é‡åŒæ­¥, å¦‚æœæŒ‡å®šé”™è¯¯ä¼šé€ æˆæ•°æ®çš„é—æ¼, ä»è€Œé€ æˆæ•°æ®çš„ä¸ä¸€è‡´.\nè€ŒåŸºäº GTID çš„å¤åˆ¶ä¸­, slave ä¼šå‘ŠçŸ¥ master å·²ç»æ‰§è¡Œçš„äº‹åŠ¡çš„ GTID çš„å€¼, ç„¶å master ä¼šå°†æ‰€æœ‰æœªæ‰§è¡Œçš„äº‹åŠ¡çš„ GTID çš„åˆ—è¡¨è¿”å›ç»™ slave. å¹¶ä¸”å¯ä»¥ä¿è¯åŒä¸€ä¸ªäº‹åŠ¡åªåœ¨æŒ‡å®šçš„ slave æ‰§è¡Œä¸€æ¬¡. é€šè¿‡å…¨å±€çš„äº‹åŠ¡ ID ç¡®å®š slave è¦æ‰§è¡Œçš„äº‹åŠ¡çš„æ–¹å¼ä»£æ›¿äº†ä»¥å‰éœ€è¦ç”¨ binlog å’Œ pos ç‚¹ç¡®å®š slave è¦æ‰§è¡Œçš„äº‹åŠ¡çš„æ–¹å¼.\nGTID æ˜¯ç”± server_uuid å’Œäº‹ç‰© id ç»„æˆ, æ ¼å¼ä¸º: GTID=server_uuid:transaction_id. server_uuid æ˜¯åœ¨æ•°æ®åº“å¯åŠ¨è¿‡ç¨‹ä¸­è‡ªåŠ¨ç”Ÿæˆ, æ¯å°æœºå™¨çš„ server-uuid ä¸ä¸€æ ·. uuid å­˜æ”¾åœ¨æ•°æ®ç›®å½•çš„ auto.cnf æ–‡ä»¶ä¸­ï¼Œè€Œ transaction_id å°±æ˜¯äº‹åŠ¡æäº¤æ—¶ç³»ç»Ÿé¡ºåºåˆ†é…çš„ä¸€ä¸ªä¸ä¼šé‡å¤çš„åºåˆ—å·\nmaster æ›´æ–°æ•°æ®æ—¶, ä¼šåœ¨äº‹åŠ¡å‰äº§ç”Ÿ GTID, ä¸€èµ·è®°å½•åˆ° binlog æ—¥å¿—ä¸­. slave çš„ IO çº¿ç¨‹å°†å˜æ›´çš„ binlog å†™å…¥åˆ°æœ¬åœ°çš„ relaylog ä¸­. SQL çº¿ç¨‹ä» relaylog ä¸­è·å– GTID, ç„¶åå¯¹æ¯”æœ¬åœ° binlog æ˜¯å¦æœ‰è®°å½• (æ‰€ä»¥ slave å¿…é¡»è¦å¼€å¯ binlog, å¹¶ä¸”å°† log_slave_updates è®¾ç½®ä¸º ON). å¦‚æœæœ‰è®°å½•ï¼Œè¯´æ˜è¯¥ GTID çš„äº‹åŠ¡å·²ç»æ‰§è¡Œ, slave ä¼šå¿½ç•¥. å¦‚æœæ²¡æœ‰è®°å½•, slave å°±ä¼šä» relaylog ä¸­æ‰§è¡Œè¯¥ GTID çš„äº‹åŠ¡, å¹¶è®°å½•åˆ° binlog. åœ¨è§£æè¿‡ç¨‹ä¸­ä¼šåˆ¤æ–­æ˜¯å¦æœ‰ä¸»é”®, å¦‚æœæ²¡æœ‰å°±ç”¨äºŒçº§ç´¢å¼•, å¦‚æœæœ‰å°±ç”¨å…¨éƒ¨æ‰«æ.\n5 å¹¶è¡Œå¤åˆ¶ master å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯å¤šçº¿ç¨‹å¤šå®¢æˆ·ç«¯å»å†™, è€Œ slave åªæœ‰ä¸€ä¸ª SQL çº¿ç¨‹è¿›è¡Œå†™, æ— æ³•é¿å…åœ°ä¼šå‡ºç°ä¸»ä»å¤åˆ¶çš„å»¶è¿Ÿé—®é¢˜, å¹¶è¡Œå¤åˆ¶å¯ä»¥æŒ‡å®šçº¿ç¨‹æ•°é‡, ä»è€Œæé«˜ slave å†™çš„é€Ÿåº¦.\nåœ¨ mysql 5.6 ç‰ˆæœ¬ä¹‹åå¼•å…¥äº†å¹¶è¡Œå¤åˆ¶çš„æ¦‚å¿µ\né€šè¿‡ä¸Šå›¾æˆ‘ä»¬å¯ä»¥å‘ç°å…¶å®æ‰€è°“çš„å¹¶è¡Œå¤åˆ¶, å°±æ˜¯åœ¨ä¸­é—´æ·»åŠ äº†ä¸€ä¸ªåˆ†å‘çš„ç¯èŠ‚, ä¹Ÿå°±æ˜¯è¯´åŸæ¥çš„ SQL çº¿ç¨‹å˜æˆäº†ç°åœ¨çš„ coordinator ç»„ä»¶, å½“ relaylog æ—¥å¿—æ›´æ–°å, coordinator è´Ÿè´£è¯»å–æ—¥å¿—ä¿¡æ¯ä»¥åŠåˆ†å‘äº‹åŠ¡, çœŸæ­£çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯æ”¾åœ¨äº† worker çº¿ç¨‹ä¸Š, ç”±å¤šä¸ªçº¿ç¨‹å¹¶è¡Œçš„å»æ‰§è¡Œ.\n# æŸ¥çœ‹å¹¶è¡Œçš„slaveçš„çº¿ç¨‹çš„ä¸ªæ•°ï¼Œé»˜è®¤æ˜¯0.è¡¨ç¤ºå•çº¿ç¨‹ show global variables like \u0026#39;slave_parallel_workers\u0026#39;; # æ ¹æ®å®é™…æƒ…å†µä¿è¯å¼€å¯å¤šå°‘çº¿ç¨‹ set global slave_parallel_workers = 4; # è®¾ç½®å¹¶å‘å¤åˆ¶çš„æ–¹å¼ï¼Œé»˜è®¤æ˜¯ä¸€ä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ªåº“ï¼Œå€¼ä¸ºdatabase show global variables like \u0026#39;%slave_parallel_type%\u0026#39;; # åœæ­¢slave stop slave; # è®¾ç½®å±æ€§å€¼ set global slave_parallel_type=\u0026#39;logical_check\u0026#39;; # å¼€å¯slave start slave # æŸ¥çœ‹çº¿ç¨‹æ•° show full processlist; ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/mysql-2-master-slave/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: ã€MySQLã€‘ä¸»ä»å¤åˆ¶å®ç°åŸç†è¯¦è§£ åŸºäº centos-7.9 mysql-5.7.42 mysql å®‰è£…å‚è€ƒ mysql ç³»åˆ—æ–‡ç«  1 ä¸»ä»å¤åˆ¶åŸç† ä¸»ä»å¤åˆ¶æ¶‰åŠåˆ° 3 ä¸ªçº¿ç¨‹, 4 ä¸ªæ–‡ä»¶ 1.1 çº¿ç¨‹ master: log dump : å½“ slave è¿æ¥ master æ—¶, ä¸»èŠ‚ç‚¹ä¼šä¸ºå…¶åˆ›å»ºä¸€ä¸ª log dump çº¿ç¨‹, ç”¨äºå‘é€å’Œè¯»å– binlog çš„å†…å®¹. åœ¨è¯»å– binlog ä¸­çš„æ“ä½œæ—¶, log dump çº¿ç¨‹ä¼šå¯¹ä¸»èŠ‚ç‚¹ä¸Šçš„ binlog åŠ é”, å½“è¯»å–å®Œæˆ, åœ¨å‘","title":"mysql (äºŒ) ä¸»ä»å¤åˆ¶åŸç† GTID å¹¶è¡Œå¤åˆ¶"},{"content":"0 å‰è¨€ åŸºäº centos-7.9 mysql-5.7.42\n1 åŸºç¡€ç¯å¢ƒ é…ç½® hostname\nhostnamectl set-hostname master bash å…³é—­é˜²ç«å¢™åŠ selinux\niptables -F systemctl disable firewalld systemctl stop firewalld sed -i \u0026#39;/SELINUX/s/enforcing/disabled/\u0026#39; /etc/sysconfig/selinux setenforce 0 é…ç½® yum æº\nmkdir /etc/yum.repos.d/bak || true mv /etc/yum.repos.d/*.repo /etc/yum.repos.d/bak/ || true curl http://mirrors.aliyun.com/repo/Centos-7.repo -o /etc/yum.repos.d/Centos-Base.repo sed -i \u0026#39;/aliyuncs.com/d\u0026#39; /etc/yum.repos.d/Centos-Base.repo # curl http://mirrors.aliyun.com/repo/epel-7.repo -o /etc/yum.repos.d/epel.repo yum clean all yum makecache fast yum install -y wget net-tools vim bash-completion ntpdate timedatectl set-timezone Asia/Shanghai ntpdate time.windows.com å¸è½½è‡ªå¸¦çš„ mariadb\nyum remove -y $(rpm -qa | grep mariadb) 2 é…ç½® yum æº æä¾›æ¸…åæºå’Œå®˜æ–¹æºä¸¤ç§æ–¹å¼, ä»»é€‰å…¶ä¸€, å‰è€…é€Ÿåº¦ç¨å¿«ä¸€äº›\n2.1 æ¸…åæº è¿™é‡Œä½¿ç”¨çš„æ˜¯æ¸…åçš„æº\ncat \u0026gt; /etc/yum.repos.d/mysql-community.repo \u0026lt;\u0026lt; EOF [mysql-connectors-community] name=MySQL Connectors Community baseurl=https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql-connectors-community-el7-\\$basearch/ enabled=1 gpgcheck=1 gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql [mysql-tools-community] name=MySQL Tools Community baseurl=https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql-tools-community-el7-\\$basearch/ enabled=1 gpgcheck=1 gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql [mysql-5.7-community] name=MySQL 5.7 Community Server baseurl=https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql-5.7-community-el7-\\$basearch/ enabled=1 gpgcheck=1 gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql EOF 2.2 å®˜æ–¹æº wget http://dev.mysql.com/get/mysql57-community-release-el7-8.noarch.rpm yum localinstall mysql57-community-release-el7-8.noarch.rpm 3 å®‰è£… mysql æ‰§è¡Œå®‰è£…\nrpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2022 yum install mysql-community-server å¯åŠ¨æœåŠ¡\nsystemctl enable --now mysqld è·å–é»˜è®¤å¯†ç \n# grep \u0026#34;password\u0026#34; /var/log/mysqld.log 2023-05-07T02:31:54.375626Z 1 [Note] A temporary password is generated for root@localhost: QZFuIayXk0:l å¦‚æœæ²¡æœ‰è¿”å›ï¼Œæ‰¾ä¸åˆ° root å¯†ç ï¼Œè§£å†³æ–¹æ¡ˆå¦‚ä¸‹\n# åˆ é™¤åŸæ¥å®‰è£…è¿‡çš„mysqlæ®‹ç•™çš„æ•°æ® rm -rf /var/lib/mysql # é‡å¯ mysqld æœåŠ¡, ä¼šé‡æ–°åˆå§‹åŒ–æ•°æ® systemctl restart mysqld # å†å»æ‰¾ä¸´æ—¶å¯†ç  grep \u0026#39;temporary password\u0026#39; /var/log/mysqld.log ç™»å½•å¹¶ä¿®æ”¹å¯†ç \nmysql -uroot -p # è¾“å…¥é»˜è®¤å¯†ç  ALTER USER \u0026#39;root\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;\u0026lt;pass\u0026gt;\u0026#39;; # ä¿®æ”¹å¯†ç , éœ€è¦æœ‰å¤§å°å†™å’Œç‰¹æ®Šç¬¦å· exit; ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/mysql-1-deploy/","summary":"0 å‰è¨€ åŸºäº centos-7.9 mysql-5.7.42 1 åŸºç¡€ç¯å¢ƒ é…ç½® hostname hostnamectl set-hostname master bash å…³é—­é˜²ç«å¢™åŠ selinux iptables -F systemctl disable firewalld systemctl stop firewalld sed -i \u0026#39;/SELINUX/s/enforcing/disabled/\u0026#39; /etc/sysconfig/selinux setenforce 0 é…ç½® yum æº mkdir /etc/yum.repos.d/bak || true mv /etc/yum.repos.d/*.repo /etc/yum.repos.d/bak/ || true curl http://mirrors.aliyun.com/repo/Centos-7.repo -o /etc/yum.repos.d/Centos-Base.repo sed -i \u0026#39;/aliyuncs.com/d\u0026#39; /etc/yum.repos.d/Centos-Base.repo # curl http://mirrors.aliyun.com/repo/epel-7.repo -o /etc/yum.repos.d/epel.repo yum clean all yum makecache fast yum install -y wget net-tools vim bash-completion ntpdate timedatectl set-timezone Asia/Shanghai ntpdate time.windows.com å¸è½½è‡ªå¸¦çš„ mariadb yum remove -y $(rpm -qa | grep mariadb) 2 é…ç½® yum æº æä¾›æ¸…åæºå’Œå®˜æ–¹æºä¸¤ç§æ–¹å¼, ä»»é€‰å…¶ä¸€, å‰è€…é€Ÿåº¦ç¨å¿«ä¸€äº› 2.1 æ¸…åæº è¿™é‡Œä½¿ç”¨çš„","title":"mysql (ä¸€) éƒ¨ç½²"},{"content":"0 ä¸‹è½½åœ°å€ https://dev.mysql.com/downloads/mysql/\n1 å¸¸ç”¨ Sql 1.1 æŸ¥çœ‹ç”¨æˆ·æƒé™ SELECT u.user, u.host, d.db, u.select_priv, u.insert_priv, u.update_priv, u.delete_priv, u.create_priv, u.drop_priv, u.grant_priv FROM mysql.user u LEFT JOIN mysql.db d ON u.user = d.user ORDER BY u.user, u.host, d.db; 1.2 æŸ¥çœ‹æ‰€æœ‰åº“çš„è¡¨æ•°é‡ SELECT table_schema, COUNT(*) AS table_count FROM information_schema.tables WHERE table_type = \u0026#39;BASE TABLE\u0026#39; GROUP BY table_schema; 1.3 åŠ è½½çš„é…ç½®æ–‡ä»¶é¡ºåº mysql --help |grep -i \u0026#34;my.cnf\u0026#34; /etc/mysql/my.cnf /etc/my.cnf ~/.my.cnf 1.4 æŸ¥çœ‹åº“çš„è¡¨æ•°é‡åŠå ç”¨ç©ºé—´ select table_schema as \u0026#39;æ•°æ®åº“\u0026#39;, table_name as \u0026#39;è¡¨å\u0026#39;, table_rows as \u0026#39;è®°å½•æ•°\u0026#39;, truncate(data_length/1024/1024, 2) as \u0026#39;æ•°æ®å®¹é‡(MB)\u0026#39;, truncate(index_length/1024/1024, 2) as \u0026#39;ç´¢å¼•å®¹é‡(MB)\u0026#39; from information_schema.tables where table_schema=\u0026#39;xxxxxxxxxx\u0026#39; order by data_length desc, index_length desc; 2 ä¿®æ”¹ binlog ä¿å­˜æ—¶é—´ åœ¨ /etc/my.cnf çš„ [mysqld] ä¸‹æ·»åŠ  expire_logs_days = 30\nshow variables like \u0026#39;%expire%\u0026#39;; set global expire_logs_days = 30; # åˆ é™¤ 30 å¤©å‰çš„ binlog PURGE MASTER LOGS BEFORE DATE_SUB(CURRENT_DATE, INTERVAL 30 DAY); ä»¥ä¸Š.\n","permalink":"https://www.lvbibir.cn/posts/tech/mysql-0-notes/","summary":"0 ä¸‹è½½åœ°å€ https://dev.mysql.com/downloads/mysql/ 1 å¸¸ç”¨ Sql 1.1 æŸ¥çœ‹ç”¨æˆ·æƒé™ SELECT u.user, u.host, d.db, u.select_priv, u.insert_priv, u.update_priv, u.delete_priv, u.create_priv, u.drop_priv, u.grant_priv FROM mysql.user u LEFT JOIN mysql.db d ON u.user = d.user ORDER BY u.user, u.host, d.db; 1.2 æŸ¥çœ‹æ‰€æœ‰åº“çš„è¡¨æ•°é‡ SELECT table_schema, COUNT(*) AS table_count FROM information_schema.tables WHERE table_type = \u0026#39;BASE TABLE\u0026#39; GROUP BY table_schema; 1.3 åŠ è½½çš„é…ç½®æ–‡ä»¶é¡ºåº mysql --help |grep -i \u0026#34;my.cnf\u0026#34; /etc/mysql/my.cnf /etc/my.cnf ~/.my.cnf 1.4 æŸ¥çœ‹åº“çš„è¡¨æ•°é‡åŠå ç”¨ç©ºé—´ select table_schema as \u0026#39;æ•°æ®åº“\u0026#39;, table_name as \u0026#39;è¡¨å\u0026#39;, table_rows as \u0026#39;è®°","title":"mysql | æ‚è®°"},{"content":"0 å‰è¨€ åŸºç¡€ç¯å¢ƒ\nç³»ç»Ÿï¼šCentos 7.9.2009 minimal é…ç½®ï¼š4 cpus / 24G mem / 50G disk ç½‘å¡ï¼š1.1.1.4/24 æˆ‘è¿™é‡Œé‡‡ç”¨çš„æ˜¯ all-in-one çš„é…ç½®ï¼Œå³æ‰€æœ‰æ“ä½œéƒ½åœ¨ä¸€å°ä¸»æœºä¸Šï¼Œå¦‚èµ„æºå……è¶³å¯ä»¥å°† jenkins å’Œ gitlab ä¸åç»­é¡¹ç›®å®¹å™¨åˆ†å¼€éƒ¨ç½²\n1 ç³»ç»Ÿé…ç½® é˜²ç«å¢™ã€selinuxã€yum\nsed -i \u0026#39;/SELINUX/s/enforcing/disabled/\u0026#39; /etc/sysconfig/selinux setenforce 0 iptables -F systemctl disable firewalld systemctl stop firewalld mkdir /etc/yum.repos.d/bak mv /etc/yum.repos.d/*.repo /etc/yum.repos.d/bak/ curl http://mirrors.aliyun.com/repo/Centos-7.repo -o /etc/yum.repos.d/Centos-Base.repo sed -i \u0026#39;/aliyuncs.com/d\u0026#39; /etc/yum.repos.d/Centos-Base.repo yum clean all yum makecache fast yum install -y wget net-tools vim bash-completion unzip mkdir /mydata 2 docker å…ˆå®‰è£… docker-compose\nwget https://github.com/docker/compose/releases/download/v2.16.0/docker-compose-linux-x86_64 -O /usr/local/bin/docker-compose chmod a+x /usr/local/bin/docker-compose ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose docker-compose version å®‰è£… docker\nwget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo yum -y install docker-ce mkdir -p /etc/docker # é•œåƒåŠ é€Ÿå™¨ tee /etc/docker/daemon.json \u0026lt;\u0026lt;-\u0026#39;EOF\u0026#39; { \u0026#34;registry-mirrors\u0026#34;: [\u0026#34;https://jc0srqak.mirror.aliyuncs.com\u0026#34;] } EOF å…è®¸ docker å®ˆæŠ¤è¿›ç¨‹çš„ tcp è®¿é—®ï¼Œä¸ºäº†åç»­ jenkins æ„å»ºæ—¶è°ƒç”¨ï¼Œä»¥ç”Ÿæˆ docker é•œåƒ\n[root@localhost ~]# vim /usr/lib/systemd/system/docker.service # ä¿®æ”¹å¦‚ä¸‹å†…å®¹ # ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix://var/run/docker.sock systemctl daemon-reload systemctl restart docker \u0026amp;\u0026amp; systemctl enable docker æŸ¥çœ‹ç«¯å£ï¼Œç¡®ä¿ä¿®æ”¹æ­£ç¡®\n[root@localhost ~]# ss -tnlp | grep 2375 LISTEN 0 128 [::]:2375 [::]:* users:((\u0026#34;dockerd\u0026#34;,pid=1124,fd=4)) å®‰è£…ä¸€ç³»åˆ—åç»­éœ€è¦çš„é•œåƒï¼Œé•œåƒæ–‡ä»¶æ¯”è¾ƒå¤§ï¼Œè¿™æ­¥æ¯”è¾ƒè€—æ—¶\ndocker pull jenkins/jenkins:lts docker pull gitlab/gitlab-ce:latest docker pull mysql:5.7 docker pull redis:7 docker pull nginx:1.22 docker pull rabbitmq:3.9-management docker pull elasticsearch:7.17.3 docker pull logstash:7.17.3 docker pull kibana:7.17.3 docker pull mongo:4 docker pull nacos/nacos-server:v2.1.0 3 jenkins 3.1 å¯åŠ¨å®¹å™¨ docker run -d --restart=always \\ -p 8080:8080 -p 50000:5000 \\ --name jenkins -u root \\ -v /mydata/jenkins_home:/var/jenkins_home \\ jenkins/jenkins:lts # è·å–åˆå§‹ç®¡ç†å‘˜å¯†ç  [root@localhost ~]# cat /mydata/jenkins_home/secrets/initialAdminPassword bd5b64c7c8c8467985a0faa6fbe1848f 3.2 è·³è¿‡åœ¨çº¿éªŒè¯ å¯åŠ¨æˆåŠŸè®¿é—® http://1.1.1.4:8080 ï¼Œç­‰å‡ºç°å¯†ç ç•Œé¢åè¾“å…¥å¯†ç åº”è¯¥ä¼šè¿›å…¥ä¸€ä¸ªç¦»çº¿é¡µé¢ï¼Œå¦‚ä¸‹\nâ— è¿™ä¸ªç•Œé¢ä¸è¦å…³ï¼Œæ–°å¼€ä¸€ä¸ªçª—å£è®¿é—® http://1.1.1.4:8080/pluginManager/advanced\nå°† update site çš„ url ä¿®æ”¹ä¸º http://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.jsonï¼Œè¿™æ­¥æ˜¯ä¸ºäº†åŠ é€Ÿæ’ä»¶å®‰è£…\næ¥ä¸‹æ¥è·³è¿‡ jenkins çš„åœ¨çº¿éªŒè¯ï¼Œåœ¨ç»ˆç«¯å†æ‰§è¡Œ\ndocker exec -it jenkins /bin/sh -c \u0026#34;echo 127.0.0.1 www.google.com \u0026gt;\u0026gt; /etc/hosts\u0026#34; docker exec -it jenkins cat /etc/hosts ç„¶åå›åˆ°ç¬¬ä¸€ä¸ªç¦»çº¿é¡µé¢åˆ·æ–°ä¸€ä¸‹ï¼Œåº”è¯¥å¯ä»¥çœ‹åˆ°ç¦»çº¿çŠ¶æ€æ¶ˆé™¤äº†ï¼Œè¿™é‡Œæ˜¯å› ä¸º jenkins åœ¨ /mydata/jenkins_home/updates/default.json ä¸­å®šä¹‰äº†é€šè¿‡è®¿é—® google æ¥åˆ¤æ–­ jenkins èŠ‚ç‚¹æ˜¯å¦æ˜¯åœ¨çº¿çŠ¶æ€\nä¹‹åé€‰æ‹©å®‰è£…æ¨èçš„æ’ä»¶ï¼Œè¿›å…¥æ’ä»¶å®‰è£…ç•Œé¢ï¼Œè¿™ä¸ªè¿‡ç¨‹è€—æ—¶ä¼šæ¯”è¾ƒé•¿ï¼Œå¦‚æœæœ‰æ’ä»¶å®‰è£…å¤±è´¥å¯ä»¥é‡è¯•\nä¹‹ååˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·ï¼Œä¸€è·¯ç¡®å®šååˆ°ä¸»é¡µ\n3.3 æ’ä»¶é…ç½® dashboard -\u0026gt; ç³»ç»Ÿç®¡ç† -\u0026gt; æ’ä»¶ç®¡ç†ä¸­å®‰è£… ssh æ’ä»¶å’Œ Role-based Authorization Strategy æ’ä»¶ï¼Œå®‰è£…å®Œæˆåé‡å¯ jenkins\næ–°å¢ ssh å‡­æ®\næ–°å¢ ssh é…ç½®ï¼Œé…ç½®å¥½ä¹‹åå³ä¸‹è§’æµ‹è¯•ä¸€ä¸‹ï¼Œè¿æ¥æ­£å¸¸åä¿å­˜\næ–°å¢ maven é…ç½®\n3.4 æƒé™é…ç½® æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Jenkins çš„è§’è‰²ç®¡ç†æ’ä»¶æ¥ç®¡ç† Jenkins çš„ç”¨æˆ·ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥ç»™ç®¡ç†å‘˜èµ‹äºˆæ‰€æœ‰æƒé™ï¼Œè¿ç»´äººå‘˜èµ‹äºˆæ‰§è¡Œä»»åŠ¡çš„ç›¸å…³æƒé™ï¼Œå…¶ä»–äººå‘˜åªèµ‹äºˆæŸ¥çœ‹æƒé™ã€‚\nåœ¨ç³»ç»Ÿç®¡ç† -\u0026gt; å…¨å±€å®‰å…¨é…ç½®ä¸­å¯ç”¨åŸºäºè§’è‰²çš„æƒé™ç®¡ç†ï¼š\nå…³é—­ä»£ç†ï¼Œä¿å­˜\nåˆ†é…ç®¡ç†å‘˜ã€è¿ç»´å’Œ other ä¸‰ä¸ªè§’è‰²ï¼Œåˆ†åˆ«é…ç½®å¯¹åº”æƒé™\nå°†ç”¨æˆ·å’Œè§’è‰²ç»‘å®š\n4 gitlab 4.1 å¯åŠ¨å®¹å™¨ docker run --detach --restart=always\\ -p 10443:443 -p 1080:80 -p 1022:22 \\ --name gitlab \\ --restart always \\ --volume /mydata/gitlab/config:/etc/gitlab \\ --volume /mydata/gitlab/logs:/var/log/gitlab \\ --volume /mydata/gitlab/data:/var/opt/gitlab \\ gitlab/gitlab-ce:latest # è·å–å¯†ç  docker exec -it gitlab grep \u0026#39;Password:\u0026#39; /etc/gitlab/initial_root_password è®¿é—® http://1.1.1.4:1080/, é»˜è®¤ç”¨æˆ·ä¸º root\n4.2 é…ç½® é…ç½®ä¸­æ–‡ï¼Œä¿®æ”¹å®Œååˆ·æ–°ç½‘é¡µå³å¯\nä¿®æ”¹é»˜è®¤å¯†ç \n4.3 ä¸Šä¼ é¡¹ç›® æ–°å»ºç©ºç™½é¡¹ç›®\næ–°å»º mall-swarm é¡¹ç›®\nclone github ä¸Šçš„åŸé¡¹ç›®ï¼Œæˆ‘æ˜¯ windows ç³»ç»Ÿï¼Œæ‰€ä»¥è¿™é‡Œç”¨çš„æ˜¯ git-bash\ngit clone https://github.com/macrozheng/mall-swarm.git cd mall-swarm # é‡å‘½ågithubè¿œç«¯ä»“åº“ git remote rename origin github # æ·»åŠ gitlabä»“åº“ git remote add gitlab http://1.1.1.4:1080/root/mall-swarm.git git remote -v ä¿®æ”¹ä¸€ä¸‹ docker.host å˜é‡\næ–°å»º commit å¹¶æäº¤åˆ° gitlab ä»“åº“ï¼Œåˆæ¬¡æäº¤éœ€è¦è¾“å…¥ gitlab çš„ç”¨æˆ·åå¯†ç \ngit add . git commit -m \u0026#34;change docker.host -\u0026gt; 1.1.1.4\u0026#34; git push gitlab master é»˜è®¤é…ç½®ä¸åˆç†ï¼Œä¿®æ”¹ docker-compose-env.yml ä¸­ nginx çš„é…ç½®æ–‡ä»¶æŒ‚è½½\n- /data/nginx/nginx.conf:/etc/nginx/nginx.conf #é…ç½®æ–‡ä»¶æŒ‚è½½ ä¸Šä¼ åˆ° gitlab\ngit add . git commit -m \u0026#34;update nginx volume config in document/docker/docker-compose.env.yml\u0026#34; git push gitlab master 5 ä¾èµ–æœåŠ¡éƒ¨ç½² éœ€è¦ä¸Šä¼ åˆ°æœåŠ¡å™¨çš„é…ç½®æ–‡ä»¶å‡†å¤‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸ºäº†æ–¹ä¾¿å¯ä»¥å°†æ•´ä¸ª document ç›®å½•ä¼ åˆ°æœåŠ¡å™¨\n5.1 å‰æœŸé…ç½® Elasticsearch\nè®¾ç½®å†…æ ¸å‚æ•°ï¼Œå¦åˆ™ä¼šå› ä¸ºå†…å­˜ä¸è¶³æ— æ³•å¯åŠ¨ sysctl -w vm.max_map_count=262144 sysctl -p åˆ›å»ºæ•°æ®ç›®å½•å¹¶è®¾ç½®æƒé™ï¼Œå¦åˆ™ä¼šæŠ¥æƒé™é”™è¯¯ mkdir -p /mydata/elasticsearch/data/ chmod 777 /mydata/elasticsearch/data/ Nginx\nåˆ›å»ºç›®å½•ï¼Œä¸Šä¼ é…ç½®æ–‡ä»¶ mkdir -p /mydata/nginx/conf/ cp /mydata/document/docker/nginx.conf /mydata/nginx/conf/ Logstash\nåˆ›å»ºç›®å½•ä¸Šä¼ é…ç½®æ–‡ä»¶ mkdir /mydata/logstash cp /mydata/document/elk/logstash.conf /mydata/logstash/ 5.2 å¯åŠ¨æœåŠ¡ docker-compose -f /mydata/document/docker/docker-compose-env.yml up -d docker-compose ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª docker_default ç½‘ç»œï¼Œæ‰€æœ‰å®¹å™¨éƒ½åœ¨è¿™ä¸ªç½‘ç»œä¸‹\nå¯åŠ¨å®Œæˆå rabbitmq ç”±äºæƒé™é—®é¢˜æœªèƒ½æ­£å¸¸å¯åŠ¨ï¼Œç»™ log ç›®å½•è®¾ç½®æƒé™ï¼Œå†æ‰§è¡Œ docker-compose å¯åŠ¨å¼‚å¸¸çš„å®¹å™¨\nchmod 777 /mydata/rabbitmq/log/ docker-compose -f /mydata/document/docker/docker-compose-env.yml up -d ç¡®ä¿æ‰€æœ‰å®¹å™¨æ­£å¸¸å¯åŠ¨\ndocker ps | grep -v \u0026#34;Up\u0026#34; 5.3 æœåŠ¡é…ç½® mysql\néœ€è¦åˆ›å»º mall æ•°æ®åº“å¹¶æˆæƒç»™ reader ç”¨æˆ·\nå°† sql æ–‡ä»¶æ‹·è´åˆ°å®¹å™¨ docker cp /mydata/document/sql/mall.sql mysql:/ è¿›å…¥ mysql å®¹å™¨æ‰§è¡Œå¦‚ä¸‹æ“ä½œ # è¿›å…¥mysqlå®¹å™¨ docker exec -it mysql /bin/bash # è¿æ¥åˆ°mysqlæœåŠ¡ mysql -uroot -proot --default-character-set=utf8 # åˆ›å»ºè¿œç¨‹è®¿é—®ç”¨æˆ· grant all privileges on *.* to \u0026#39;reader\u0026#39; @\u0026#39;%\u0026#39; identified by \u0026#39;123456\u0026#39;; # åˆ›å»ºmallæ•°æ®åº“ create database mall character set utf8; # ä½¿ç”¨mallæ•°æ®åº“ use mall; # å¯¼å…¥mall.sqlè„šæœ¬ source /mall.sql; # é€€å‡ºæ•°æ®åº“ exit # é€€å‡ºå®¹å™¨ ctrl + d Elasticsearch\néœ€è¦å®‰è£…ä¸­æ–‡åˆ†è¯å™¨ IKAnalyzer ä¸‹è½½åœ°å€ æ³¨æ„ç‰ˆæœ¬éœ€è¦ä¸ elasticsearch çš„ç‰ˆæœ¬ä¸€è‡´\nä¸Šä¼ åˆ°æœåŠ¡å™¨å¹¶è§£å‹åˆ° plugins ç›®å½• mkdir /mydata/elasticsearch/plugins/analysis-ik unzip /mydata/elasticsearch-analysis-ik-7.17.3.zip -d /mydata/elasticsearch/plugins/analysis-ik/ é‡å¯å®¹å™¨ docker restart elasticsearch Logstash\nå®‰è£… json_lines æ’ä»¶å¹¶é‡å¯ docker exec -it logstash /bin/bash logstash-plugin install logstash-codec-json_lines docker restart logstash rabbitmq\néœ€è¦åˆ›å»ºä¸€ä¸ª mall ç”¨æˆ·å¹¶è®¾ç½®è™šæ‹Ÿ host ä¸º/mall\nè®¿é—®ç®¡ç†é¡µé¢: http://1.1.1.4:15672/ é»˜è®¤è´¦æˆ·å¯†ç : guest / guest åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·: mall / mall åˆ›å»ºä¸€ä¸ªæ–°çš„è™šæ‹Ÿ host ä¸º /mall ç‚¹å‡» mall ç”¨æˆ·è¿›å…¥ç”¨æˆ·é…ç½®ç•Œé¢ ç»™ mall è´¦æˆ·é…ç½®è™šæ‹Ÿ host /mall çš„æƒé™ nacos\nç”±äºæˆ‘ä»¬ä½¿ç”¨ Nacos ä½œä¸ºé…ç½®ä¸­å¿ƒï¼Œç»Ÿä¸€ç®¡ç†é…ç½®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†é¡¹ç›® config ç›®å½•ä¸‹çš„æ‰€æœ‰é…ç½®éƒ½æ·»åŠ åˆ° Nacos ä¸­ Nacos è®¿é—®åœ°å€ï¼šhttp://1.1.1.4:8848/nacos/ è´¦å·å¯†ç ï¼šnacos / nacos\néœ€è¦ä¸Šä¼ çš„é…ç½®\nä¸Šä¼ é…ç½® å…¨éƒ¨ä¸Šä¼ å®Œæˆ 6 jenkins æ‰‹åŠ¨å‘å¸ƒé¡¹ç›® 6.1 è„šæœ¬é…ç½® Jenkins è‡ªåŠ¨åŒ–éƒ¨ç½²æ˜¯éœ€è¦ä¾èµ– Linux æ‰§è¡Œè„šæœ¬çš„\næ·»åŠ æ‰§è¡Œæƒé™\nchmod a+x /mydata/document/sh/*.sh ä¹‹å‰ä½¿ç”¨çš„æ˜¯ Docker Compose å¯åŠ¨æ‰€æœ‰ä¾èµ–æœåŠ¡ï¼Œä¼šé»˜è®¤åˆ›å»ºä¸€ä¸ªç½‘ç»œï¼Œæ‰€æœ‰çš„ä¾èµ–æœåŠ¡éƒ½ä¼šåœ¨æ­¤ç½‘ç»œä¹‹ä¸­ï¼Œä¸åŒç½‘ç»œå†…çš„æœåŠ¡æ— æ³•äº’ç›¸è®¿é—®ã€‚æ‰€ä»¥éœ€è¦æŒ‡å®š sh è„šæœ¬ä¸­æœåŠ¡è¿è¡Œçš„çš„ç½‘ç»œï¼Œå¦åˆ™å¯åŠ¨çš„åº”ç”¨æœåŠ¡ä¼šæ— æ³•è¿æ¥åˆ°ä¾èµ–æœåŠ¡ã€‚\nä¿®æ”¹è„šæœ¬å†…å®¹ï¼Œä¸ºæ¯ä¸ªè„šæœ¬æ·»åŠ  --network docker_default \\\nsed -i \u0026#39;/^docker run/ a\\--network docker_default \\\\\u0026#39; /mydata/document/sh/*.sh ç¡®è®¤ä¿®æ”¹æ˜¯å¦æˆåŠŸ\n6.2 jenkins é…ç½® 6.2.1 mall-admin å·¥ç¨‹é…ç½® ç”±äºå„ä¸ªæ¨¡å—æ‰§è¡Œä»»åŠ¡çš„åˆ›å»ºéƒ½å¤§åŒå°å¼‚ï¼Œä¸‹é¢å°†è¯¦ç»†è®²è§£ mall-admin æ¨¡å—ä»»åŠ¡çš„åˆ›å»ºï¼Œå…¶ä»–æ¨¡å—å°†ç®€ç•¥è®²è§£ã€‚\næºç ç®¡ç†\nåˆ›å»ºä¸€ä¸ªæ„å»ºï¼Œæ„å»º mall-swarm é¡¹ç›®ä¸­çš„ä¾èµ–æ¨¡å—ï¼Œå¦åˆ™å½“æ„å»ºå¯è¿è¡Œçš„æœåŠ¡æ¨¡å—æ—¶ä¼šå› ä¸ºæ— æ³•æ‰¾åˆ°è¿™äº›æ¨¡å—è€Œæ„å»ºå¤±è´¥\n# åªinstall mall-common,mall-mbgä¸¤ä¸ªæ¨¡å— clean install -pl mall-common,mall-mbg -am åˆ›å»ºä¸€ä¸ªæ„å»ºï¼Œå•ç‹¬æ„å»ºå¹¶æ‰“åŒ… mall-admin æ¨¡å—\nclean package ${WORKSPACE}/mall-admin/pom.xml å†åˆ›å»ºä¸€ä¸ªæ„å»ºï¼Œé€šè¿‡ SSH å»æ‰§è¡Œ sh è„šæœ¬ï¼Œè¿™é‡Œæ‰§è¡Œçš„æ˜¯ mall-admin çš„è¿è¡Œè„šæœ¬ï¼š\n6.2.2 å…¶ä»–æ¨¡å—å·¥ç¨‹é…ç½® ä»¥ mall-gateway ä¸ºä¾‹\nè¾“å…¥ä»»åŠ¡åç§°ï¼Œç›´æ¥å¤åˆ¶ mall-admin å·¥ç¨‹é…ç½®\nä¿®æ”¹ç¬¬äºŒæ­¥æ„å»ºä¸­çš„ pom æ–‡ä»¶ä½ç½®å’Œç¬¬ä¸‰æ­¥æ„å»ºä¸­çš„ sh æ–‡ä»¶ä½ç½®\n6.3 å¼€å§‹æ„å»º å•å‡»å¼€å§‹æ„å»ºå³å¯å¼€å§‹æ„å»ºä»»åŠ¡ï¼Œå¯ä»¥å®æ—¶çœ‹åˆ°ä»»åŠ¡çš„æ§åˆ¶å°è¾“å‡º\nç”±äºä½œä¸ºæ³¨å†Œä¸­å¿ƒå’Œé…ç½®ä¸­å¿ƒçš„ Nacos å·²ç»å¯åŠ¨äº†ï¼Œå…¶ä»–æ¨¡å—åŸºæœ¬æ²¡æœ‰å¯åŠ¨é¡ºåºçš„é™åˆ¶ï¼Œä½†æ˜¯æœ€å¥½è¿˜æ˜¯æŒ‰ç…§ä¸‹é¢çš„é¡ºåºå¯åŠ¨ã€‚\næ¨èå¯åŠ¨é¡ºåºï¼š\nmall-auth mall-gateway mall-monitor mall-admin mall-portal mall-search ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/cicd-mall-swarm/","summary":"0 å‰è¨€ åŸºç¡€ç¯å¢ƒ ç³»ç»Ÿï¼šCentos 7.9.2009 minimal é…ç½®ï¼š4 cpus / 24G mem / 50G disk ç½‘å¡ï¼š1.1.1.4/24 æˆ‘è¿™é‡Œé‡‡ç”¨çš„æ˜¯ all-in-one çš„é…ç½®ï¼Œå³æ‰€æœ‰æ“ä½œéƒ½åœ¨ä¸€å°ä¸»æœºä¸Šï¼Œå¦‚èµ„æºå……è¶³å¯ä»¥å°† jenkins å’Œ gitlab ä¸åç»­é¡¹ç›®å®¹å™¨åˆ†å¼€éƒ¨ç½² 1 ç³»ç»Ÿé…ç½® é˜²ç«å¢™ã€selinuxã€yum sed -i \u0026#39;/SELINUX/s/enforcing/disabled/\u0026#39; /etc/sysconfig/selinux setenforce 0 iptables -F systemctl disable firewalld systemctl stop firewalld mkdir /etc/yum.repos.d/bak mv /etc/yum.repos.d/*.repo /etc/yum.repos.d/bak/ curl http://mirrors.aliyun.com/repo/Centos-7.repo -o /etc/yum.repos.d/Centos-Base.repo sed -i \u0026#39;/aliyuncs.com/d\u0026#39; /etc/yum.repos.d/Centos-Base.repo yum clean all yum","title":"cicd | jenkins éƒ¨ç½² mall-swarm é¡¹ç›®"},{"content":"ç³»ç»Ÿç‰ˆæœ¬ï¼šisoft-serveros-v4.2ï¼ˆcentos7ï¼‰\næºç ä¸‹è½½é“¾æ¥ï¼š\nhttps://dlcdn.apache.org//apr/apr-1.7.0.tar.bz2 https://dlcdn.apache.org//apr/apr-util-1.6.1.tar.bz2 https://dlcdn.apache.org//httpd/httpd-2.4.52.tar.bz2 å®‰è£…ä¾èµ–\nyum install -y wget gcc rpm-build yum install -y autoconf zlib-devel libselinux-devel libuuid-devel apr-devel apr-util-devel pcre-devel openldap-devel lua-devel libxml2-devel openssl-devel yum install -y libtool doxygen yum install -y postgresql-devel mysql-devel sqlite-devel unixODBC-devel nss-devel libdb4-devel ä¾èµ–éœ€è¦ä½¿ç”¨ epel æºå®‰è£…ï¼Œè¿™é‡Œä½¿ç”¨é˜¿é‡Œçš„ epel æº\n# æ·»åŠ é˜¿é‡Œyumæº wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo # æ‰‹åŠ¨ä¿®æ”¹repoæ–‡ä»¶ä¸­çš„ç³»ç»Ÿç‰ˆæœ¬ï¼Œå› ä¸ºæœ¬ç³»ç»Ÿæ£€æµ‹åˆ°çš„ç‰ˆæœ¬å·æ˜¯4 sed -i \u0026#39;s/$releasever/7/g\u0026#39; /etc/yum.repos.d/CentOS-Base.repo # å®‰è£…epelæº yum install -y epel-release # å®‰è£…libdb4-devel yum install -y libdb4-devel ç¼–è¯‘å‡†å¤‡\n[root@localhost ~]# mkdir -p /root/rpmbuild/{SPECS,SOURCES} [root@localhost ~]# cd /root/rpmbuild/SOURCES/ [root@localhost SOURCES]# wget --no-check-certificate https://dlcdn.apache.org//apr/apr-util-1.6.1.tar.bz2 [root@localhost SOURCES]# tar jxf apr-1.7.0.tar.bz2 [root@localhost SOURCES]# tar jxf apr-util-1.6.1.tar.bz2 [root@localhost SOURCES]# tar jxf httpd-2.4.52.tar.bz2 [root@localhost SOURCES]# cp apr-1.7.0/apr.spec ../SPECS/ [root@localhost SOURCES]# cp apr-util-1.6.1/apr-util.spec ../SPECS/ [root@localhost SOURCES]# cp httpd-2.4.52/httpd.spec ../SPECS/ å¼€å§‹ç¼–è¯‘\n[root@localhost SOURCES]# cd ../SPECS/ # ä¿®æ”¹specæ–‡ä»¶ [root@localhost SPECS]# vim apr.spec Release: 1%dist [root@localhost SPECS]# vim apr-util.spec Release: 1%dist [root@localhost SPECS]# vim httpd.spec Release: 1%dist [root@localhost SPECS]# rpmbuild -ba apr.spec [root@localhost SPECS]# rpm -Uvh /root/rpmbuild/RPMS/x86_64/apr-* [root@localhost SPECS]# rpmbuild -ba apr-util.spec [root@localhost SPECS]# rpm -Uvh /root/rpmbuild/RPMS/x86_64/apr-util-* [root@localhost SPECS]# rpmbuild -ba httpd.spec [root@localhost SPECS]# rpm -Uvh /root/rpmbuild/RPMS/x86_64/httpd-* [root@localhost SPECS]# rpm -Uvh /root/rpmbuild/RPMS/x86_64/mod_* # æ‰“åŒ…æ‰€æœ‰çš„è½¯ä»¶åŒ… [root@localhost ~]# tar zcf httpd-2.4.25.tar.gz x86_64/ è¿™é‡Œä¿®æ”¹%dist æ˜¯ä¸ºäº†ä¿®æ”¹ç¼–è¯‘åç”Ÿæˆçš„è½¯ä»¶åŒ…çš„åå­—ï¼Œdist å…·ä½“ä»£è¡¨ä»€ä¹ˆå¯ä»¥åœ¨/etc/rpm/macros.dist æ–‡ä»¶ä¸­çœ‹åˆ°\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/rpm-build-httpd/","summary":"ç³»ç»Ÿç‰ˆæœ¬ï¼šisoft-serveros-v4.2ï¼ˆcentos7ï¼‰ æºç ä¸‹è½½é“¾æ¥ï¼š https://dlcdn.apache.org//apr/apr-1.7.0.tar.bz2 https://dlcdn.apache.org//apr/apr-util-1.6.1.tar.bz2 https://dlcdn.apache.org//httpd/httpd-2.4.52.tar.bz2 å®‰è£…ä¾èµ– yum install -y wget gcc rpm-build yum install -y autoconf zlib-devel libselinux-devel libuuid-devel apr-devel apr-util-devel pcre-devel openldap-devel lua-devel libxml2-devel openssl-devel yum install -y libtool doxygen yum install -y postgresql-devel mysql-devel sqlite-devel unixODBC-devel nss-devel libdb4-devel ä¾èµ–éœ€è¦ä½¿ç”¨ epel æºå®‰è£…ï¼Œè¿™é‡Œä½¿ç”¨é˜¿é‡Œçš„ epel æº # æ·»åŠ é˜¿é‡Œyumæº wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo # æ‰‹åŠ¨ä¿®æ”¹repoæ–‡ä»¶ä¸­çš„ç³»ç»Ÿç‰ˆæœ¬ï¼Œå› ä¸ºæœ¬ç³»ç»Ÿæ£€æµ‹åˆ°","title":"httpd æºç æ‰“åŒ…ç¼–è¯‘æˆ rpm åŒ…"},{"content":"1 ç¯å¢ƒ iSoftserver-v4.2(Centos-7)\nopenssl versionï¼š1.0.2k\n2 ç¼–è¯‘ ä» github ä¸Šçœ‹åˆ°çš„ç¼–è¯‘è„šæœ¬ï¼Œæœ¬åœ°ä¿®æ”¹åï¼š\n#!/bin/bash set -e set -v mkdir ~/openssl \u0026amp;\u0026amp; cd ~/openssl yum -y install \\ curl \\ which \\ make \\ gcc \\ perl \\ perl-WWW-Curl \\ rpm-build # Get openssl tarball cp /root/openssl-1.1.1m.tar.gz ./ # SPEC file cat \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; \u0026gt; ~/openssl/openssl.spec Summary: OpenSSL 1.1.1m for Centos Name: openssl Version: %{?version}%{!?version:1.1.1m} Release: 1%{?dist} Obsoletes: %{name} \u0026lt;= %{version} Provides: %{name} = %{version} URL: https://www.openssl.org/ License: GPLv2+ Source: https://www.openssl.org/source/%{name}-%{version}.tar.gz BuildRequires: make gcc perl perl-WWW-Curl BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root %global openssldir /usr/openssl %description OpenSSL RPM for version 1.1.1m on Centos %package devel Summary: Development files for programs which will use the openssl library Group: Development/Libraries Requires: %{name} = %{version}-%{release} %description devel OpenSSL RPM for version 1.1.1m on Centos (development package) %prep %setup -q %build ./config --prefix=%{openssldir} --openssldir=%{openssldir} make %install [ \u0026#34;%{buildroot}\u0026#34; != \u0026#34;/\u0026#34; ] \u0026amp;\u0026amp; %{__rm} -rf %{buildroot} %make_install mkdir -p %{buildroot}%{_bindir} mkdir -p %{buildroot}%{_libdir} ln -sf %{openssldir}/lib/libssl.so.1.1 %{buildroot}%{_libdir} ln -sf %{openssldir}/lib/libcrypto.so.1.1 %{buildroot}%{_libdir} ln -sf %{openssldir}/bin/openssl %{buildroot}%{_bindir} %clean [ \u0026#34;%{buildroot}\u0026#34; != \u0026#34;/\u0026#34; ] \u0026amp;\u0026amp; %{__rm} -rf %{buildroot} %files %{openssldir} %defattr(-,root,root) /usr/bin/openssl /usr/lib64/libcrypto.so.1.1 /usr/lib64/libssl.so.1.1 %files devel %{openssldir}/include/* %defattr(-,root,root) %post -p /sbin/ldconfig %postun -p /sbin/ldconfig EOF mkdir -p /root/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS} cp ~/openssl/openssl.spec /root/rpmbuild/SPECS/openssl.spec mv openssl-1.1.1m.tar.gz /root/rpmbuild/SOURCES cd /root/rpmbuild/SPECS \u0026amp;\u0026amp; \\ rpmbuild \\ -D \u0026#34;version 1.1.1m\u0026#34; \\ -ba openssl.spec # Before Uninstall Openssl : rpm -qa openssl # Uninstall Current Openssl Vesion : yum -y remove openssl # For install: rpm -ivvh /root/rpmbuild/RPMS/x86_64/openssl-1.1.1m-1.el7.x86_64.rpm --nodeps # Verify install: rpm -qa openssl # openssl version è¿è¡Œè„šæœ¬\nchmod 755 install_openssl-1.1.1m.sh ./isntall_openssl-1.1.1m.sh tree rpmbuild/*RPMS 3 å‡çº§ rpm -e openssl --nodeps rpm -ivh openssl-1.1.1m-1.el7.isoft.x86_64.rpm --nodeps openssl version ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/rpm-build-openssl/","summary":"1 ç¯å¢ƒ iSoftserver-v4.2(Centos-7) openssl versionï¼š1.0.2k 2 ç¼–è¯‘ ä» github ä¸Šçœ‹åˆ°çš„ç¼–è¯‘è„šæœ¬ï¼Œæœ¬åœ°ä¿®æ”¹åï¼š #!/bin/bash set -e set -v mkdir ~/openssl \u0026amp;\u0026amp; cd ~/openssl yum -y install \\ curl \\ which \\ make \\ gcc \\ perl \\ perl-WWW-Curl \\ rpm-build # Get openssl tarball cp /root/openssl-1.1.1m.tar.gz ./ # SPEC file cat \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; \u0026gt; ~/openssl/openssl.spec Summary: OpenSSL 1.1.1m for Centos Name: openssl Version: %{?version}%{!?version:1.1.1m} Release: 1%{?dist} Obsoletes: %{name} \u0026lt;= %{version} Provides: %{name} = %{version} URL: https://www.openssl.org/ License: GPLv2+ Source: https://www.openssl.org/source/%{name}-%{version}.tar.gz BuildRequires: make gcc perl perl-WWW-Curl BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root %global openssldir /usr/openssl %description OpenSSL RPM for version 1.1.1m on Centos %package devel Summary: Development files for programs which will use the openssl library Group: Development/Libraries Requires:","title":"openssl æºç æ‰“åŒ…ç¼–è¯‘æˆ rpm åŒ…"},{"content":"0 å‰è¨€ åœ¨ä½¿ç”¨ kolla-ansible éƒ¨ç½²å¤šèŠ‚ç‚¹ openstack æ—¶ï¼Œæ‰€æœ‰èŠ‚ç‚¹çš„å¤–ç½‘ç½‘å¡åç§°å’Œç®¡ç†ç½‘å¡åç§°éœ€è¦ä¸€æ ·ï¼Œå…¶ä¸­ä¸¤å°æ˜¯å‹å·ç›¸åŒçš„ç‰©ç†æœºï¼Œç½‘å¡åæ— éœ€å˜åŠ¨ï¼Œç¬¬ä¸‰å°æ˜¯è™šæ‹Ÿæœºï¼Œé»˜è®¤æ˜¯ ens* å½¢å¼çš„ç½‘å¡ï¼Œéœ€è¦æ”¹æˆ enp*s*f* çš„æ ¼å¼\næœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\nHow to change a network interface name on CentOS 7 1 ä¿®æ”¹é…ç½®æ–‡ä»¶ vim /etc/sysconfig/network-scripts/ifcfg-ens32 3 é…ç½®ç½‘ç»œè§„åˆ™å‘½åæ–‡ä»¶ vim /etc/udev/rules.d/70-persistent-ipoib.rules # æ·»åŠ å¦‚ä¸‹è¡Œï¼Œmac åœ°å€è‡ªè¡Œä¿®æ”¹ SUBSYSTEM==\u0026#34;net\u0026#34;, ACTION==\u0026#34;add\u0026#34;, DRIVERS==\u0026#34;?*\u0026#34;, ATTR{address}==\u0026#34;00:0c:29:bc:1e:01\u0026#34;, ATTR{type}==\u0026#34;1\u0026#34;, KERNEL==\u0026#34;eth*\u0026#34;, NAME=\u0026#34;enp11s0f0\u0026#34; 4 é…ç½® grub å¹¶é‡å¯ vim /etc/default/grub # ä¿®æ”¹å¦‚ä¸‹è¡Œ GRUB_CMDLINE_LINUX=\u0026#34;crashkernel=auto rd.lvm.lv=centos/root net.ifnames=0 rd.lvm.lv=centos/swap rhgb quiet\u0026#34; grub2-mkconfig -o /boot/grub2/grub.cfg ä¹‹åç›´æ¥ reboot é‡å¯ç³»ç»Ÿ\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/centos7-change-network-card-name/","summary":"0 å‰è¨€ åœ¨ä½¿ç”¨ kolla-ansible éƒ¨ç½²å¤šèŠ‚ç‚¹ openstack æ—¶ï¼Œæ‰€æœ‰èŠ‚ç‚¹çš„å¤–ç½‘ç½‘å¡åç§°å’Œç®¡ç†ç½‘å¡åç§°éœ€è¦ä¸€æ ·ï¼Œå…¶ä¸­ä¸¤å°æ˜¯å‹å·ç›¸åŒçš„ç‰©ç†æœºï¼Œç½‘å¡åæ— éœ€å˜åŠ¨ï¼Œç¬¬ä¸‰å°æ˜¯è™šæ‹Ÿæœºï¼Œé»˜è®¤æ˜¯ ens* å½¢å¼çš„ç½‘å¡ï¼Œéœ€è¦æ”¹æˆ enp*s*f* çš„æ ¼å¼ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: How to change a network interface name on CentOS 7 1 ä¿®æ”¹é…ç½®æ–‡ä»¶ vim /etc/sysconfig/network-scripts/ifcfg-ens32 3 é…ç½®ç½‘ç»œè§„åˆ™å‘½åæ–‡ä»¶ vim /etc/udev/rules.d/70-persistent-ipoib.rules # æ·»åŠ å¦‚ä¸‹è¡Œï¼Œmac åœ°å€è‡ª","title":"centos7 | ä¿®æ”¹ç½‘å¡åç§°"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥\nCeph å­˜å‚¨æ±  pg_num é…ç½®è¯¦è§£ 1 pg_num ç”¨æ­¤å‘½ä»¤åˆ›å»ºå­˜å‚¨æ± æ—¶ï¼š\nceph osd pool create {pool-name} pg_num ç¡®å®š pg_num å–å€¼æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œå› ä¸ºä¸èƒ½è‡ªåŠ¨è®¡ç®—ã€‚å¸¸ç”¨çš„è¾ƒä¸ºé€šç”¨çš„å–å€¼ï¼š\nå°‘äº 5 ä¸ª osdï¼Œpg_num è®¾ç½®ä¸º 128 osd æ•°é‡åœ¨ 5 åˆ° 10 ä¸ªæ—¶ï¼Œpg_num è®¾ç½®ä¸º 512 osd æ•°é‡åœ¨ 10 åˆ° 50 ä¸ªæ—¶ï¼Œpg_num = 4096 osd æ•°é‡å¤§äº 50 æ˜¯ï¼Œéœ€è¦ç†è§£ ceph çš„æƒè¡¡ç®—æ³•ï¼Œè‡ªå·±è®¡ç®— pg_num å–å€¼ è‡ªè¡Œè®¡ç®— pg_num å–å€¼æ—¶å¯ä½¿ç”¨ ceph é…å¥—çš„ pg_num å–å€¼å·¥å…· pgcalc ","permalink":"https://www.lvbibir.cn/posts/tech/ceph-pg-num-config-create-pool/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥ Ceph å­˜å‚¨æ±  pg_num é…ç½®è¯¦è§£ 1 pg_num ç”¨æ­¤å‘½ä»¤åˆ›å»ºå­˜å‚¨æ± æ—¶ï¼š ceph osd pool create {pool-name} pg_num ç¡®å®š pg_num å–å€¼æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œå› ä¸ºä¸èƒ½è‡ªåŠ¨è®¡ç®—ã€‚å¸¸ç”¨çš„è¾ƒä¸ºé€šç”¨çš„å–å€¼ï¼š å°‘äº 5 ä¸ª osdï¼Œpg_num è®¾ç½®ä¸º 128 osd æ•°é‡åœ¨ 5 åˆ° 10 ä¸ªæ—¶ï¼Œpg_num è®¾ç½®ä¸º 512 osd æ•°é‡åœ¨ 10 åˆ° 50 ä¸ªæ—¶ï¼Œpg_num = 4096 osd æ•°é‡å¤§äº 50 æ˜¯ï¼Œéœ€è¦ç†è§£ ceph çš„","title":"ceph | pool pg_num é…ç½®"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\nå°å·¥å…·: æ‰¹é‡å¯¼å…¥å¯¼å‡ºä¸»æœºä¸Šçš„ docker é•œåƒ 1 python æ‰¹é‡å¯¼å‡ºï¼Œè¿è¡Œåæ‰€æœ‰ tar åŒ…éƒ½åœ¨å½“å‰ç›®å½•ä¸‹\n# encoding: utf-8 import re import os import subprocess if __name__ == \u0026#34;__main__\u0026#34;: p = subprocess.Popen(\u0026#39;docker images\u0026#39;, shell=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT) for line in p.stdout.readlines(): # æ­¤å¤„çš„æ­£åˆ™è¡¨è¾¾å¼æ˜¯ä¸ºäº†åŒ¹é…é•œåƒåä»¥kollaä¸ºå¼€å¤´çš„é•œåƒ # å®é™…ä½¿ç”¨ä¸­æ ¹æ®éœ€è¦è‡ªè¡Œè°ƒæ•´ m = re.match(r\u0026#39;(^kolla[^\\s]*\\s*)\\s([^\\s]*\\s)\u0026#39;, line) if not m: continue # é•œåƒå iname = m.group(1).strip() # tag itag = m.group(2).strip() # taråŒ…çš„åå­— if iname.find(\u0026#39;/\u0026#39;): tarname = iname.split(\u0026#39;/\u0026#39;)[0] + \u0026#39;_\u0026#39; + iname.split(\u0026#39;/\u0026#39;)[-1] + \u0026#39;_\u0026#39; + itag + \u0026#39;.tar\u0026#39; else: tarname = iname + \u0026#39;_\u0026#39; + itag + \u0026#39;.tar\u0026#39; print tarname ifull = iname + \u0026#39;:\u0026#39; + itag #save cmd = \u0026#39;docker save -o \u0026#39; + tarname + \u0026#39; \u0026#39; + ifull print os.system(cmd) retval = p.wait() æ‰¹é‡å¯¼å…¥ï¼ŒåŒç†å¯¼å…¥å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰çš„ tar åŒ…\nimport os images = os.listdir(os.getcwd()) for imagename in images: if imagename.endswith(\u0026#39;.tar\u0026#39;): print(imagename) os.system(\u0026#39;docker load -i %s\u0026#39;%imagename) 2 bash 2.1 å¯¼å‡º #!/bin/bash docker images \u0026gt; images.txt awk \u0026#39;{print $1}\u0026#39; images.txt \u0026gt; images_cut.txt sed -i \u0026#39;1d\u0026#39; images_cut.txt while read LINE do docker save $LINE \u0026gt; ${LINE//\\//_}.train.tar echo ok done \u0026lt; images_cut.txt echo finish 2.2 å¯¼å…¥ #!/bin/bash while read LINE do docker load -i $LINE echo ok done \u0026lt; tarname.txt echo finish ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/docker-import-export-image/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: å°å·¥å…·: æ‰¹é‡å¯¼å…¥å¯¼å‡ºä¸»æœºä¸Šçš„ docker é•œåƒ 1 python æ‰¹é‡å¯¼å‡ºï¼Œè¿è¡Œåæ‰€æœ‰ tar åŒ…éƒ½åœ¨å½“å‰ç›®å½•ä¸‹ # encoding: utf-8 import re import os import subprocess if __name__ == \u0026#34;__main__\u0026#34;: p = subprocess.Popen(\u0026#39;docker images\u0026#39;, shell=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT) for line in p.stdout.readlines(): # æ­¤å¤„çš„æ­£åˆ™è¡¨è¾¾å¼æ˜¯ä¸ºäº†åŒ¹é…é•œåƒåä»¥kollaä¸ºå¼€å¤´çš„é•œåƒ # å®é™…ä½¿ç”¨ä¸­æ ¹æ®éœ€è¦è‡ªè¡Œè°ƒæ•´ m = re.match(r\u0026#39;(^kolla[^\\s]*\\s*)\\s([^\\s]*\\s)\u0026#39;, line) if not m: continue # é•œåƒå iname = m.group(1).strip() # tag itag = m.group(2).strip() # ta","title":"docker | è„šæœ¬æ–¹å¼æ‰¹é‡å¯¼å‡º/å¯¼å…¥é•œåƒ"},{"content":"pam æ¨¡å—\npamï¼šPluggable Authentication Modules å¯æ’æ‹”çš„è®¤è¯æ¨¡å—ï¼Œlinux ä¸­çš„è®¤è¯æ–¹å¼ï¼Œâ€œå¯æ’æ‹”çš„â€è¯´æ˜å¯ä»¥æŒ‰éœ€å¯¹è®¤è¯å†…å®¹è¿›è¡Œå˜æ›´ã€‚ä¸ nsswitch ä¸€æ ·ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªé€šç”¨æ¡†æ¶ã€‚åªä¸è¿‡æ˜¯æä¾›è®¤è¯åŠŸèƒ½çš„ã€‚\næŸ¥çœ‹å¯†ç å¤±è´¥æ¬¡æ•°\npam_tally2 -u root # æˆ–è€… faillock --user root é‡ç½®å¯†ç å¤±è´¥æ¬¡æ•°\npam_tally2 -r -u root # æˆ–è€… faillock --user root --reset å…·ä½“å–å†³äºåœ¨è§„åˆ™æ–‡ä»¶ä¸­ä½¿ç”¨çš„æ˜¯ pam_faillock.so æ¨¡å—è¿˜æ˜¯ pam_tally2.so æ¨¡å—\nä¾‹ï¼š\ncat /etc/pam.d/system-auth ","permalink":"https://www.lvbibir.cn/posts/tech/centos-too-many-password-attempts/","summary":"pam æ¨¡å— pamï¼šPluggable Authentication Modules å¯æ’æ‹”çš„è®¤è¯æ¨¡å—ï¼Œlinux ä¸­çš„è®¤è¯æ–¹å¼ï¼Œâ€œå¯æ’æ‹”çš„â€è¯´æ˜å¯ä»¥æŒ‰éœ€å¯¹è®¤è¯å†…å®¹è¿›è¡Œå˜æ›´ã€‚ä¸ nsswitch ä¸€æ ·ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªé€šç”¨æ¡†æ¶ã€‚åªä¸è¿‡æ˜¯æä¾›è®¤è¯åŠŸèƒ½çš„ã€‚ æŸ¥çœ‹å¯†ç å¤±è´¥æ¬¡æ•° pam_tally2 -u root # æˆ–è€… faillock --user root é‡ç½®å¯†ç å¤±è´¥æ¬¡æ•° pam_tally2 -r -u root # æˆ–è€… faillock --user root --reset å…·ä½“å–å†³äºåœ¨è§„åˆ™æ–‡ä»¶ä¸­ä½¿ç”¨çš„æ˜¯ pam_faillock.so æ¨¡","title":"centos å¯†ç å°è¯•æ¬¡æ•°è¿‡å¤šé—®é¢˜å¤„ç†"},{"content":"0 å‰è¨€ å†…æ ¸ç‰ˆæœ¬ä»‹ç»ï¼š\nlt longterm çš„ç¼©å†™ é•¿æœŸç»´æŠ¤ç‰ˆ ml mainline çš„ç¼©å†™ æœ€æ–°ç¨³å®šç‰ˆ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\nLinux ç¦»çº¿å‡çº§å†…æ ¸ elrepo kernel rpm packge directory 1 å‡çº§å†…æ ¸ æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬\n[dpl@test1 ~]$ cat /etc/redhat-release Red Hat Enterprise Linux Server release 7.5 (Maipo) ä½¿ç”¨ wget å‘½ä»¤ä¸‹è½½å†…æ ¸ RPM åŒ…\n[dpl@test1 ~]# wget https://dl.lamp.sh/kernel/el7/kernel-ml-5.10.81-1.el7.x86_64.rpm [dpl@test1 ~]# wget https://dl.lamp.sh/kernel/el7/kernel-ml-devel-5.10.81-1.el7.x86_64.rpm å®‰è£…å†…æ ¸\nyum localinstall -y kernel-ml-5.10.81-1.el7.x86_64.rpm kernel-ml-devel-5.10.81-1.el7.x86_64.rpm æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å†…æ ¸å¯åŠ¨é¡¹\n[dpl@test1 ~] awk -F\\\u0026#39; \u0026#39;$1==\u0026#34;menuentry \u0026#34; {print i++ \u0026#34; : \u0026#34; $2}\u0026#39; /etc/grub2.cfg 0 : CentOS Linux (5.10.81-1.el7.x86_64) 7 (Core) 1 : CentOS Linux (3.10.0-1160.21.1.el7.x86_64) 7 (Core) 2 : CentOS Linux (3.10.0-957.el7.x86_64) 7 (Core) 3 : CentOS Linux (0-rescue-9a4efd5deb094f5d8a9a259066ff4f3d) 7 (Core) è®°ä¸‹ 5.10.81 å†…æ ¸å‰é¢çš„åºå·ï¼Œä¿®æ”¹å¯åŠ¨é¡¹éœ€è¦\nä¿®æ”¹é»˜è®¤å¯åŠ¨é¡¹\né»˜è®¤å¯åŠ¨é¡¹ç”± /etc/default/grub ä¸­çš„ GRUB_DEFAULT æ§åˆ¶ï¼Œå¦‚æœ GRUB_DEFAULT=savedï¼Œåˆ™è¯¥å‚æ•°å°†å­˜åœ¨ /boot/grub2/grubenv\nè¾“å…¥ grub2-editenv list å‘½ä»¤æŸ¥çœ‹é»˜è®¤å¯åŠ¨é¡¹\n[root@localhost ~]# grub2-editenv list saved_entry=CentOS Linux (3.10.0-1060.el7.x86_64) 7 (Core) è¾“å…¥ grub2-set-default å‘½ä»¤ä¿®æ”¹é»˜è®¤å¯åŠ¨é¡¹ï¼Œ0 è¡¨ç¤º 5.10.81 å†…æ ¸çš„åºå·\n[dpl@test1 ~]# grub2-set-default 0 å†æ¬¡æŸ¥çœ‹é»˜è®¤å¯åŠ¨é¡¹ï¼Œå‘ç°é»˜è®¤å¯åŠ¨é¡¹å·²ç»æ”¹æˆäº† 0\n[dpl@test1 ~]# grub2-editenv list saved_entry=0 é‡å¯åå†æ¬¡æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬\n[dpl@test1 ~]# uname -r 5.10.81-1.el7.elrepo.x86_64 ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/centos7-update-kernel-to-5.10/","summary":"0 å‰è¨€ å†…æ ¸ç‰ˆæœ¬ä»‹ç»ï¼š lt longterm çš„ç¼©å†™ é•¿æœŸç»´æŠ¤ç‰ˆ ml mainline çš„ç¼©å†™ æœ€æ–°ç¨³å®šç‰ˆ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: Linux ç¦»çº¿å‡çº§å†…æ ¸ elrepo kernel rpm packge directory 1 å‡çº§å†…æ ¸ æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬ [dpl@test1 ~]$ cat /etc/redhat-release Red Hat Enterprise Linux Server release 7.5 (Maipo) ä½¿ç”¨ wget å‘½ä»¤ä¸‹è½½å†…æ ¸ RPM åŒ… [dpl@test1 ~]# wget https://dl.lamp.sh/kernel/el7/kernel-ml-5.10.81-1.el7.x86_64.rpm [dpl@test1 ~]# wget https://dl.lamp.sh/kernel/el7/kernel-ml-devel-5.10.81-1.el7.x86_64.rpm å®‰è£…å†…æ ¸ yum localinstall -y kernel-ml-5.10.81-1.el7.x86_64.rpm kernel-ml-devel-5.10.81-1.el7.x86_64.rpm æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å†…æ ¸å¯åŠ¨é¡¹ [dpl@test1 ~] awk -F\\\u0026#39; \u0026#39;$1==\u0026#34;menuentry \u0026#34; {print i++ \u0026#34; : \u0026#34; $2}\u0026#39; /etc/grub2.cfg 0 : CentOS Linux (5.10.81-1.el7.x86_64) 7 (Core) 1 : CentOS Linux (3.10.0-1160.21.1.el7.x86_64) 7 (Core)","title":"centos7 | å‡çº§å†…æ ¸è‡³ 5.10"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\nBug 1647621 - Xorg listening on port 6000 by default in 7.6 åŸºäº CVE-1999-0526 æ¼æ´çš„æŠ«éœ²ï¼Œå¯¹ç³»ç»Ÿ X æœåŠ¡çš„ 6000 ç«¯å£è¿›è¡Œå…³é—­\næœ‰ä¸‰ç§æ–¹å¼ï¼š\nä¿®æ”¹ç³»ç»Ÿ/usr/bin/X å†…å®¹ï¼Œå¢åŠ  nolisten å‚æ•° å¼€å¯ç³»ç»Ÿé˜²ç«å¢™ï¼Œå…³é—­ 6000 ç«¯å£çš„å¯¹å¤–è®¿é—® ç¦ç”¨æ¡Œé¢ (runlevel-5)ï¼Œå¼€æœºè¿›å…¥å­—ç¬¦ç•Œé¢ (runlevel-3) 1 ä¿®æ”¹ /usr/bin/X è„šæœ¬ 1.1 å…³é—­ rm -f /usr/bin/X vim /usr/bin/X ################### æ·»åŠ å¦‚ä¸‹å†…å®¹ #!/bin/bash exec /usr/bin/Xorg \u0026#34;$@\u0026#34; -nolisten tcp exit 0 #################### chmod 777 /usr/bin/X kill -9 è¿›ç¨‹å· # ps -elf |grep X æ˜¾ç¤ºçš„è¿›ç¨‹å· 1.2 æ¢å¤ rm -f /usr/bin/X ln -s /usr/bin/Xorg /usr/bin/X kill -9 è¿›ç¨‹å· # pe -elf | grep Xorg æ˜¾ç¤ºçš„è¿›ç¨‹å· åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°è¿‡æ€æ­» X æœåŠ¡è¿›ç¨‹åæ²¡æœ‰è‡ªå¯çš„æƒ…å†µï¼Œå¯å°è¯•ä½¿ç”¨ init 3 \u0026amp;\u0026amp; init 5 å°è¯•é‡æ–°å¯åŠ¨ X æœåŠ¡\n2 ä¿®æ”¹é˜²ç«å¢™æ–¹å¼ # å¼€å¯é™¤6000ç«¯å£ä»¥å¤–çš„æ‰€æœ‰ç«¯å£(6000ç«¯å£æ— æ³•è®¿é—®) systemctl start firewalld firewall-cmd --permanent --zone=public --add-port=1-65535/udp firewall-cmd --permanent --zone=public --add-port=1-5999/tcp firewall-cmd --permanent --zone=public --add-port=6001-65535/tcp firewall-cmd --reload firewall-cmd --list-all # æ¢å¤ï¼ˆ6000ç«¯å£å¯ä»¥è®¿é—®ï¼‰ firewall-cmd --permanent --zone=public --add-port=6000/tcp firewall-cmd --reload firewall-cmd --list-all ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/cve-1999-0526/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: Bug 1647621 - Xorg listening on port 6000 by default in 7.6 åŸºäº CVE-1999-0526 æ¼æ´çš„æŠ«éœ²ï¼Œå¯¹ç³»ç»Ÿ X æœåŠ¡çš„ 6000 ç«¯å£è¿›è¡Œå…³é—­ æœ‰ä¸‰ç§æ–¹å¼ï¼š ä¿®æ”¹ç³»ç»Ÿ/usr/bin/X å†…å®¹ï¼Œå¢åŠ  nolisten å‚æ•° å¼€å¯ç³»ç»Ÿé˜²ç«å¢™ï¼Œå…³é—­ 6000 ç«¯å£çš„å¯¹å¤–è®¿é—® ç¦ç”¨æ¡Œé¢ (runlevel-5)ï¼Œå¼€æœºè¿›å…¥å­—ç¬¦ç•Œé¢ (runlevel-3) 1 ä¿®æ”¹ /usr/bin/X è„šæœ¬ 1.1 å…³é—­ rm -f /usr/bin/X vim /usr/bin/X ################### æ·»åŠ å¦‚ä¸‹å†…å®¹","title":"CVE-1999-0526"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\nCeph-deploy å¿«é€Ÿéƒ¨ç½² Ceph åˆ†å¸ƒå¼å­˜å‚¨ centos 7 ä¸‹ Ceph é…ç½®å®‰è£… ceph luminous æ–°åŠŸèƒ½ä¹‹å†…ç½® dashboard ä¹‹ mgr åŠŸèƒ½æ¨¡å—é…ç½® ceph dashboard rgw ç®¡ç†åŠŸèƒ½çš„å¼€å¯ 1 åŸºæœ¬ç¯å¢ƒ ç‰©ç†ç¯å¢ƒï¼šVmware Workstaion ç³»ç»Ÿç‰ˆæœ¬ï¼šCentos-7.9-Minimal ä¸¤ä¸ª osd èŠ‚ç‚¹æ·»åŠ ä¸€å—è™šæ‹Ÿç£ç›˜ï¼Œå»ºè®®ä¸å°äº 20G ip hostname services 192.168.150.101 ceph-admin(ceph-deploy) mds1ã€mon1ã€mon_mgrã€ntp-server 192.168.150.102 ceph-node1 osd1 192.168.150.103 ceph-node2 osd2 2 å‰æœŸé…ç½® ä»¥ä¸‹æ“ä½œæ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€æ‰§è¡Œ\nä¿®æ”¹ä¸»æœºå\nhostnamectl set-hostname ceph-admin bash hostnamectl set-hostname ceph-node1 bash hostnamectl set-hostname ceph-node2 bash ä¿®æ”¹ hosts æ–‡ä»¶\nvim /etc/hosts 192.168.150.101 ceph-admin 192.168.150.102 ceph-node1 192.168.150.103 ceph-node2 å…³é—­é˜²ç«å¢™å’Œ selinuxã€ä¿®æ”¹ yum æºåŠå®‰è£…ä¸€äº›å¸¸ç”¨å·¥å…·\nè¿™é‡Œæä¾›äº†ä¸€ä¸ªç®€å•çš„ç³»ç»Ÿåˆå§‹åŒ–è„šæœ¬ç”¨æ¥åšä¸Šè¿°æ“ä½œï¼Œé€‚ç”¨äº Centos7\nchmod 777 init.sh ./init.sh init.sh æ–‡ä»¶å†…å®¹\n#!/bin/bash echo \u0026#34;========start=============\u0026#34; sed -i \u0026#39;/SELINUX/s/enforcing/disabled/\u0026#39; /etc/sysconfig/selinux setenforce 0 iptables -F systemctl disable firewalld systemctl stop firewalld echo \u0026#34;====dowload wget=========\u0026#34; yum install -y wget echo \u0026#34;====backup repo===========\u0026#34; mkdir /etc/yum.repos.d/bak mv /etc/yum.repos.d/*.repo /etc/yum.repos.d/bak/ echo \u0026#34;====dowload aliyum-repo====\u0026#34; wget http://mirrors.aliyun.com/repo/Centos-7.repo -O /etc/yum.repos.d/Centos-Base.repo wget http://mirrors.aliyun.com/repo/epel-7.repo -O /etc/yum.repos.d/epel.repo echo \u0026#34;====upgrade yum============\u0026#34; yum clean all yum makecache fast echo \u0026#34;====dowload tools=========\u0026#34; yum install -y net-tools vim bash-completion echo \u0026#34;=========finish============\u0026#34; æ¯ä¸ªèŠ‚ç‚¹å®‰è£…å’Œé…ç½® NTP (å®˜æ–¹æ¨èçš„æ˜¯é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹å…¨éƒ¨å®‰è£…å¹¶é…ç½® NTPï¼Œéœ€è¦ä¿è¯å„èŠ‚ç‚¹çš„ç³»ç»Ÿæ—¶é—´ä¸€è‡´ã€‚æ²¡æœ‰è‡ªå·±éƒ¨ç½² ntp æœåŠ¡å™¨ï¼Œå°±åœ¨çº¿åŒæ­¥ NTP)\nyum install chrony -y systemctl start chronyd systemctl enable chronyd ceph-admin\nvim /etc/chrony.conf systemctl restart chronyd chronyc sources è¿™é‡Œä½¿ç”¨é˜¿é‡Œäº‘çš„ ntp æœåŠ¡å™¨\nceph-node1ã€ceph-node2\nvim /etc/chrony.conf systemctl restart chronyd chronyc sources è¿™é‡ŒæŒ‡å®š ceph-admin èŠ‚ç‚¹çš„ ip å³å¯\næ·»åŠ  ceph æº\nyum -y install epel-release rpm --import http://mirrors.163.com/ceph/keys/release.asc rpm -Uvh --replacepkgs http://mirrors.163.com/ceph/rpm-nautilus/el7/noarch/ceph-release-1-1.el7.noarch.rpm å®‰è£…å®Œååº”æœ‰å¦‚ä¸‹å†…å®¹çš„ repo æ–‡ä»¶\n[Ceph] name=Ceph packages for $basearch baseurl=http://download.ceph.com/rpm-nautilus/el7/$basearch enabled=1 gpgcheck=1 type=rpm-md gpgkey=https://download.ceph.com/keys/release.asc [Ceph-noarch] name=Ceph noarch packages baseurl=http://download.ceph.com/rpm-nautilus/el7/noarch enabled=1 gpgcheck=1 type=rpm-md gpgkey=https://download.ceph.com/keys/release.asc [ceph-source] name=Ceph source packages baseurl=http://download.ceph.com/rpm-nautilus/el7/SRPMS enabled=1 gpgcheck=1 type=rpm-md gpgkey=https://download.ceph.com/keys/release.asc 3 ç£ç›˜å‡†å¤‡ ä»¥ä¸‹æ“ä½œåœ¨ osd èŠ‚ç‚¹ï¼ˆceph-node1ã€ceph-node2ï¼‰æ‰§è¡Œ\n# æ£€æŸ¥ç£ç›˜ [root@ceph-node1 ~]# fdisk -l /dev/sdb # æ ¼å¼åŒ–ç£ç›˜ [root@ceph-node1 ~]# parted -s /dev/sdb mklabel gpt mkpart primary xfs 0% 100% [root@ceph-node1 ~]# mkfs.xfs /dev/sdb -f # æŸ¥çœ‹ç£ç›˜æ ¼å¼ [root@ceph-node1 ~]# blkid -o value -s TYPE /dev/sdb xfs 4 å®‰è£… ceph é›†ç¾¤ é…ç½® ssh å…å¯†\n[root@ceph-admin ~]# ssh-keygen # ä¸€è·¯å›è½¦ [root@ceph-admin ~]# ssh-copy-id root@ceph-node1 [root@ceph-admin ~]# ssh-copy-id root@ceph-node2 å®‰è£… ceph-deploy\n[root@ceph-admin ~]# yum install -y python2-pip [root@ceph-admin ~]# yum install -y ceph-deploy åˆ›å»ºæ–‡ä»¶å¤¹ç”¨æˆ·å­˜æ”¾é›†ç¾¤æ–‡ä»¶\n[root@ceph-admin ~]# mkdir /root/my-ceph [root@ceph-admin ~]# cd /root/my-ceph/ åˆ›å»ºé›†ç¾¤, åé¢å¡«å†™ monit èŠ‚ç‚¹çš„ä¸»æœºåï¼Œè¿™é‡Œ monit èŠ‚ç‚¹å’Œç®¡ç†èŠ‚ç‚¹æ˜¯åŒä¸€å°æœºå™¨ï¼Œå³ ceph-admin\n[root@ceph-admin my-ceph]# ceph-deploy new ceph-admin [ceph_deploy.conf][DEBUG ] found configuration file at: /root/.cephdeploy.conf [ceph_deploy.cli][INFO ] Invoked (2.0.1): /usr/bin/ceph-deploy new ceph-admin [ceph_deploy.cli][INFO ] ceph-deploy options: [ceph_deploy.cli][INFO ] username : None [ceph_deploy.cli][INFO ] func : \u0026lt;function new at 0x7f2217df3de8\u0026gt; [ceph_deploy.cli][INFO ] verbose : False [ceph_deploy.cli][INFO ] overwrite_conf : False [ceph_deploy.cli][INFO ] quiet : False [ceph_deploy.cli][INFO ] cd_conf : \u0026lt;ceph_deploy.conf.cephdeploy.Conf instance at 0x7f221756e4d0\u0026gt; [ceph_deploy.cli][INFO ] cluster : ceph [ceph_deploy.cli][INFO ] ssh_copykey : True [ceph_deploy.cli][INFO ] mon : [\u0026#39;ceph-admin\u0026#39;] [ceph_deploy.cli][INFO ] public_network : None [ceph_deploy.cli][INFO ] ceph_conf : None [ceph_deploy.cli][INFO ] cluster_network : None [ceph_deploy.cli][INFO ] default_release : False [ceph_deploy.cli][INFO ] fsid : None [ceph_deploy.new][DEBUG ] Creating new cluster named ceph [ceph_deploy.new][INFO ] making sure passwordless SSH succeeds [ceph-admin][DEBUG ] connected to host: ceph-admin [ceph-admin][DEBUG ] detect platform information from remote host [ceph-admin][DEBUG ] detect machine type [ceph-admin][DEBUG ] find the location of an executable [ceph-admin][INFO ] Running command: /usr/sbin/ip link show [ceph-admin][INFO ] Running command: /usr/sbin/ip addr show [ceph-admin][DEBUG ] IP addresses found: [u\u0026#39;192.168.150.101\u0026#39;] [ceph_deploy.new][DEBUG ] Resolving host ceph-admin [ceph_deploy.new][DEBUG ] Monitor ceph-admin at 192.168.150.101 [ceph_deploy.new][DEBUG ] Monitor initial members are [\u0026#39;ceph-admin\u0026#39;] [ceph_deploy.new][DEBUG ] Monitor addrs are [\u0026#39;192.168.150.101\u0026#39;] [ceph_deploy.new][DEBUG ] Creating a random mon key... [ceph_deploy.new][DEBUG ] Writing monitor keyring to ceph.mon.keyring... [ceph_deploy.new][DEBUG ] Writing initial config to ceph.conf... ä¿®æ”¹é›†ç¾¤é…ç½®æ–‡ä»¶\næ³¨æ„ï¼šmon_host å¿…é¡»å’Œ public network ç½‘ç»œæ˜¯åŒç½‘æ®µå†…\n[root@ceph-admin my-ceph]# vim ceph.conf # æ·»åŠ å¦‚ä¸‹ä¸¤è¡Œå†…å®¹ ...... public_network = 192.168.150.0/24 osd_pool_default_size = 2 å¼€å§‹å®‰è£…\n[root@ceph-admin my-ceph]# ceph-deploy install --release nautilus ceph-admin ceph-node1 ceph-node2 # å‡ºç°ä»¥ä¸‹æç¤ºè¯´æ˜å®‰è£…æˆåŠŸ [ceph-node2][DEBUG ] Complete! [ceph-node2][INFO ] Running command: ceph --version [ceph-node2][DEBUG ] ceph version 12.2.13 (584a20eb0237c657dc0567da126be145106aa47e) nautilus (stable) åˆå§‹åŒ– monit ç›‘æ§èŠ‚ç‚¹ï¼Œå¹¶æ”¶é›†æ‰€æœ‰å¯†é’¥\n[root@ceph-admin my-ceph]# ceph-deploy mon create-initial [root@ceph-admin my-ceph]# ceph-deploy gatherkeys ceph-admin æ£€æŸ¥ OSD èŠ‚ç‚¹ä¸Šæ‰€æœ‰å¯ç”¨çš„ç£ç›˜\n[root@ceph-admin my-ceph]# ceph-deploy disk list ceph-node1 ceph-node2 åˆ é™¤æ‰€æœ‰ osd èŠ‚ç‚¹ä¸Šçš„åˆ†åŒºã€å‡†å¤‡ osd åŠæ¿€æ´» osd\nä¸»æœºä¸Šæœ‰å¤šå—ç£ç›˜è¦ä½œä¸º osd æ—¶æ–°å¢ --data å³å¯, æ¯ä¸ª --data åè·Ÿä¸€å—ç£ç›˜\n[root@ceph-admin my-ceph]# ceph-deploy osd create ceph-node1 --data /dev/sdb [root@ceph-admin my-ceph]# ceph-deploy osd create ceph-node2 --data /dev/sdb åœ¨ä¸¤ä¸ª osd èŠ‚ç‚¹ä¸Šé€šè¿‡å‘½ä»¤å·²æ˜¾ç¤ºç£ç›˜å·²æˆåŠŸ mount\n[root@ceph-node1 ~]# lsblk æŸ¥çœ‹ osd\n[root@ceph-admin my-ceph]# ceph-deploy disk list ceph-node1 ceph-node2 ...... ...... [ceph-node1][INFO ] Disk /dev/mapper/ceph--2bb0ec8d--547c--42c2--9858--08ccfd043bd4-osd--block--33e8dba4--6dfc--4753--b9ba--0d0c54166f0c: 21.5 GB, 21470642176 bytes, 41934848 sectors ...... ...... [ceph-node2][INFO ] Disk /dev/mapper/ceph--f9a95e6c--fc7b--46b4--a835--dd997c0d6335-osd--block--db903124--4c01--40d7--8a58--b26e17c1db29: 21.5 GB, 21470642176 bytes, 41934848 sectors åŒæ­¥é›†ç¾¤æ–‡ä»¶ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ ceph å‘½ä»¤äº†\n[root@ceph-admin my-ceph]# ceph-deploy admin ceph-admin ceph-node1 ceph-node2 åœ¨å…¶ä»–èŠ‚ç‚¹æŸ¥çœ‹ osd çš„ç›®å½•æ ‘\n[root@ceph-node1 ~]# ceph osd tree ID CLASS WEIGHT TYPE NAME STATUS REWEIGHT PRI-AFF -1 0.03897 root default -3 0.01949 host ceph-node1 0 hdd 0.01949 osd.0 up 1.00000 1.00000 -5 0.01949 host ceph-node2 1 hdd 0.01949 osd.1 up 1.00000 1.00000 é…ç½® mgr\n[root@ceph-admin my-ceph]# ceph-deploy mgr create ceph-admin æŸ¥çœ‹é›†ç¾¤çŠ¶æ€å’Œé›†ç¾¤ service çŠ¶æ€\næ­¤æ—¶æ˜¯ HEALTH_WARN çŠ¶æ€ï¼Œæ˜¯ç”±äºå¯ç”¨äº†ä¸å®‰å…¨æ¨¡å¼\n[root@ceph-admin my-ceph]# ceph health HEALTH_WARN mon is allowing insecure global_id reclaim [root@ceph-admin my-ceph]# ceph -s cluster: id: fd816347-598c-4ed6-b356-591a618a0bdc health: HEALTH_WARN mon is allowing insecure global_id reclaim services: mon: 1 daemons, quorum ceph-admin (age 3h) mgr: mon_mgr(active, since 17s) osd: 2 osds: 2 up (since 3m), 2 in (since 3m) data: pools: 0 pools, 0 pgs objects: 0 objects, 0 B usage: 2.0 GiB used, 38 GiB / 40 GiB avail pgs: ç¦ç”¨ä¸å®‰å…¨æ¨¡å¼\n[root@ceph-admin my-ceph]# ceph config set mon auth_allow_insecure_global_id_reclaim false [root@ceph-admin my-ceph]# ceph health HEALTH_OK 5 å¼€å¯ dashboard [root@ceph-admin my-ceph]# yum install -y ceph-mgr-dashboard [root@ceph-admin my-ceph]# ceph mgr module enable dashboard # åˆ›å»ºè‡ªç­¾è¯ä¹¦ [root@ceph-admin my-ceph]# ceph dashboard create-self-signed-cert # åˆ›å»ºå¯†ç æ–‡ä»¶ [root@ceph-admin my-ceph]# echo abc123 \u0026gt; ./dashboard_user_pw # åˆ›å»ºdashboardçš„ç™»å½•ç”¨æˆ· [root@ceph-admin my-ceph]# ceph dashboard ac-user-create admin -i ./dashboard_user_pw administrator {\u0026#34;username\u0026#34;: \u0026#34;admin\u0026#34;, \u0026#34;lastUpdate\u0026#34;: 1646037503, \u0026#34;name\u0026#34;: null, \u0026#34;roles\u0026#34;: [\u0026#34;administrator\u0026#34;], \u0026#34;password\u0026#34;: \u0026#34;$2b$12$jGsvau8jFMb4pDwLU/t8KO1sKvmBMcNUYycbXusmgkvTQzlzrMyKi\u0026#34;, \u0026#34;email\u0026#34;: null} [root@ceph-admin my-ceph]# ceph mgr services { \u0026#34;dashboard\u0026#34;: \u0026#34;https://ceph-admin:8443/\u0026#34; } æµ‹è¯•è®¿é—®\nä¸Šå›¾ä¸­æµ‹è¯•ç¯å¢ƒæ˜¯ win10+chromeï¼ŒåŒäº‹ååº” mac+chrome ä¼šå‡ºç°æ— æ³•è®¿é—®çš„æƒ…å†µï¼ŒåŸå› æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„è‡ªç­¾è¯ä¹¦ï¼Œæµè§ˆå™¨å¹¶ä¸ä¿¡ä»»æ­¤è¯ä¹¦ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼è§£å†³\nå…³é—­ dashboard çš„ ssl è®¿é—® ä¸‹è½½è¯ä¹¦é…ç½®æµè§ˆå™¨ä¿¡ä»»è¯ä¹¦ 5.1 å…³é—­ ssl [root@ceph-admin my-ceph]# ceph config set mgr mgr/dashboard/ssl false [root@ceph-admin my-ceph]# ceph mgr module disable dashboard [root@ceph-admin my-ceph]# ceph mgr module enable dashboard [root@ceph-admin my-ceph]# ceph mgr services { \u0026#34;dashboard\u0026#34;: \u0026#34;http://ceph-admin:8080/\u0026#34; } å¦‚æœå‡ºç° Module 'dashboard' has failed: IOError(\u0026quot;Port 8443 not free on '::'\u0026quot;,) è¿™ç§æŠ¥é”™ï¼Œéœ€è¦é‡å¯ä¸‹ mgrï¼šsystemctl restart ceph-mgr@ceph-admin\næµ‹è¯•è®¿é—®\n5.2 å¼€å¯ rgw é»˜è®¤ object gateway åŠŸèƒ½æ²¡æœ‰å¼€å¯\nåˆ›å»º rgw å®ä¾‹\nceph-deploy rgw create ceph-admin é»˜è®¤è¿è¡Œç«¯å£æ˜¯ 7480\nåˆ›å»º rgw ç”¨æˆ·\n[root@ceph-admin my-ceph]# radosgw-admin user create --uid=rgw --display-name=rgw --system æä¾› dashboard è¯ä¹¦\n[root@ceph-admin my-ceph]# echo UI2T50HNZUCVVYYZNDHP \u0026gt; rgw_user_access_key [root@ceph-admin my-ceph]# echo 11rg0WbXuh2Svexck3vJKs19u1UQINixDWIpN5Dq \u0026gt; rgw_user_secret_key [root@ceph-admin my-ceph]# ceph dashboard set-rgw-api-access-key -i rgw_user_access_key Option RGW_API_ACCESS_KEY updated [root@ceph-admin my-ceph]# ceph dashboard set-rgw-api-secret-key -i rgw_user_secret_key Option RGW_API_SECRET_KEY updated ç¦ç”¨ ssl\n[root@ceph-admin my-ceph]# ceph dashboard set-rgw-api-ssl-verify False Option RGW_API_SSL_VERIFY updated å¯ç”¨ rgw\n[root@ceph-admin my-ceph]# ceph dashboard set-rgw-api-host 192.168.150.101 Option RGW_API_HOST updated [root@ceph-admin my-ceph]# ceph dashboard set-rgw-api-port 7480 Option RGW_API_PORT updated [root@ceph-admin my-ceph]# ceph dashboard set-rgw-api-scheme http Option RGW_API_SCHEME updated [root@ceph-admin my-ceph]# ceph dashboard set-rgw-api-user-id rgw Option RGW_API_USER_ID updated [root@ceph-admin my-ceph]# systemctl restart ceph-radosgw.target éªŒè¯\nç›®å‰ object gateway åŠŸèƒ½å·²æˆåŠŸå¼€å¯\n6 å…¶ä»– 6.1 æ¸…é™¤ ceph é›†ç¾¤ æ¸…é™¤å®‰è£…åŒ…\n[root@ceph-admin ~]# ceph-deploy purge ceph-admin ceph-node1 ceph-node2 æ¸…é™¤é…ç½®ä¿¡æ¯\n[root@ceph-admin ~]# ceph-deploy purgedata ceph-admin ceph-node1 ceph-node2 [root@ceph-admin ~]# ceph-deploy forgetkeys æ¯ä¸ªèŠ‚ç‚¹åˆ é™¤æ®‹ç•™çš„é…ç½®æ–‡ä»¶\nrm -rf /var/lib/ceph/osd/* rm -rf /var/lib/ceph/mon/* rm -rf /var/lib/ceph/mds/* rm -rf /var/lib/ceph/bootstrap-mds/* rm -rf /var/lib/ceph/bootstrap-osd/* rm -rf /var/lib/ceph/bootstrap-mon/* rm -rf /var/lib/ceph/tmp/* rm -rf /etc/ceph/* rm -rf /var/run/ceph/* æ¸…ç†ç£ç›˜è®¾å¤‡ (/dev/mapper/ceph*)\nls /dev/mapper/ceph-* | xargs -I% -- dmsetup remove % 6.2 dashboard æ— æ³•è®¿é—®çš„é—®é¢˜ åœ¨å…³é—­ dashboard çš„ https åï¼Œå‡ºç°äº†ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„é—®é¢˜ï¼Œä½¿ç”¨ chrome æµè§ˆå™¨æ— æ³•è®¿é—® dashboard äº†ï¼Œedge æˆ–è€…ä½¿ç”¨ chrome æ— ç—•æ¨¡å¼å¯ä»¥æ­£å¸¸è®¿é—®ï¼ŒæœŸé—´å°è¯•äº†å„ç§æ–¹æ³•åŒ…æ‹¬é‡æ–°é…ç½® dashboard å’Œæ¸…ç† chrome æµè§ˆå™¨çš„ç¼“å­˜å’Œ cookie ç­‰æ–¹å¼éƒ½æ²¡æœ‰è§£å†³é—®é¢˜ï¼Œç»“æœç¬¬äºŒå¤©èµ·æ¥æ‰“å¼€ç¯å¢ƒä¸€çœ‹è‡ªå·±å¥½äº† ï¼ï¹ï¼œ\né—®é¢˜æƒ…å†µè§ä¸‹å›¾\næ—¥å¿—æŠ¥é”™ï¼š\n6.3 åŒæ­¥é…ç½®æ–‡ä»¶ ceph-deploy --overwrite-conf config push ceph-node{1,2,3,4} 6.4 æ·»åŠ  mon èŠ‚ç‚¹å’Œ mgr èŠ‚ç‚¹ ceph-deploy mon create ceph-node{1,2,3,4} ceph-deploy mgr create ceph-node{1,2,3,4} è®°å¾—ä¿®æ”¹é…ç½®æ–‡ä»¶\nä¹‹ååŒæ­¥é…ç½®æ–‡ä»¶\nceph-deploy --overwrite-conf config push ceph-node{1,2,3,4} ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/ceph-v12-nautilus-cephdeploy/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: Ceph-deploy å¿«é€Ÿéƒ¨ç½² Ceph åˆ†å¸ƒå¼å­˜å‚¨ centos 7 ä¸‹ Ceph é…ç½®å®‰è£… ceph luminous æ–°åŠŸèƒ½ä¹‹å†…ç½® dashboard ä¹‹ mgr åŠŸèƒ½æ¨¡å—é…ç½® ceph dashboard rgw ç®¡ç†åŠŸèƒ½çš„å¼€å¯ 1 åŸºæœ¬ç¯å¢ƒ ç‰©ç†ç¯å¢ƒï¼šVmware Workstaion ç³»ç»Ÿç‰ˆæœ¬ï¼šCentos-7.9-Minimal ä¸¤ä¸ª osd èŠ‚ç‚¹æ·»åŠ ä¸€å—è™šæ‹Ÿç£ç›˜ï¼Œå»ºè®®ä¸å°äº 20G ip hostname services 192.168.150.101 ceph-admin(ceph-deploy) mds1ã€mon1ã€mon_mgr","title":"ceph | centos7 éƒ¨ç½² ceph-v12"},{"content":"1 æ¸…å• åœ°å€ ä¸­å›½ç§‘å­¦æŠ€æœ¯å¤§å­¦ https://pypi.mirrors.ustc.edu.cn/simple æ¸…å https://pypi.tuna.tsinghua.edu.cn/simple è±†ç“£ http://pypi.douban.com/simple åä¸­ç†å·¥å¤§å­¦ http://pypi.hustunique.com/simple å±±ä¸œç†å·¥å¤§å­¦ http://pypi.sdutlinux.org/simple é˜¿é‡Œäº‘ https://mirrors.aliyun.com/pypi/simple/ 2 linux ç¯å¢ƒ mkdir ~/.pip cat \u0026gt; ~/.pip/pip.conf \u0026lt;\u0026lt; EOF [global] trusted-host=mirrors.aliyun.com index-url=https://mirrors.aliyun.com/pypi/simple/ EOF 3 windows ç¯å¢ƒ æ‰“å¼€ cmd ä½¿ç”¨ dos å‘½ä»¤ set æ‰¾åˆ° userprofile è·¯å¾„ï¼Œåœ¨è¯¥è·¯å¾„ä¸‹åˆ›å»º pip æ–‡ä»¶å¤¹ï¼Œåœ¨ pip æ–‡ä»¶å¤¹ä¸‹åˆ›å»º pip.ini\npip.ini å…·ä½“é…ç½®\n[global] timeout = 6000 index-url = https://pypi.tuna.tsinghua.edu.cn/simple trusted-host = pypi.tuna.tsinghua.edu.cn ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/python-change-pip-repo/","summary":"1 æ¸…å• åœ°å€ ä¸­å›½ç§‘å­¦æŠ€æœ¯å¤§å­¦ https://pypi.mirrors.ustc.edu.cn/simple æ¸…å https://pypi.tuna.tsinghua.edu.cn/simple è±†ç“£ http://pypi.douban.com/simple åä¸­ç†å·¥å¤§å­¦ http://pypi.hustunique.com/simple å±±ä¸œç†å·¥å¤§å­¦ http://pypi.sdutlinux.org/simple é˜¿é‡Œäº‘ https://mirrors.aliyun.com/pypi/simple/ 2 linux ç¯å¢ƒ mkdir ~/.pip cat \u0026gt; ~/.pip/pip.conf \u0026lt;\u0026lt; EOF [global] trusted-host=mirrors.aliyun.com index-url=https://mirrors.aliyun.com/pypi/simple/ EOF 3 windows ç¯å¢ƒ æ‰“å¼€ cmd ä½¿ç”¨ dos å‘½ä»¤ set æ‰¾åˆ° userprofile è·¯å¾„ï¼Œåœ¨è¯¥è·¯å¾„ä¸‹åˆ›å»º pip æ–‡ä»¶å¤¹ï¼Œåœ¨ pip æ–‡ä»¶å¤¹ä¸‹åˆ›å»º pip.ini pip.ini å…·ä½“é…ç½® [global] timeout = 6000 index-url = https://pypi.tuna.tsinghua.edu.cn/simple trusted-host = pypi.tuna.tsinghua.edu.cn ä»¥ä¸Š","title":"python | ä¿®æ”¹ pip æº"},{"content":"0 å‰è¨€ åœ¨ openEuler20.03 (LTS-SP1) ç³»ç»Ÿä¸Šè¿›è¡Œä¸€äº›æµ‹è¯•ï¼Œå‘ç°æŸä¸ªä¸œè¥¿ä¼šè‡ªåŠ¨ä¿®æ”¹ ssh é…ç½®æ–‡ä»¶å¯¼è‡´ç³»ç»Ÿæ— æ³•é€šè¿‡å¯†ç ç™»å½•ï¼Œæœ€åæ’æŸ¥æ˜¯ç”±äºå®‰è£…äº† cloud-init å¯¼è‡´çš„ã€‚\næ’æŸ¥æ€è·¯ å‡ºç°è¿™ä¸ªé—®é¢˜å‰åšçš„æ“ä½œæ˜¯å®‰è£…äº†ä¸€äº›é¡¹ç›®ç»„åŒäº‹æŒ‡å®šçš„åŒ…ï¼Œé—®é¢˜å°±åº”è¯¥å‡ºåœ¨è¿™äº›åŒ…ä¸Š\nyum install -y telnet rsync ntpdate zip unzip libaio dos2unix sos vim vim-enhanced net-tools man ftp lrzsz psmisc gzip network-scripts cloud-init cloud-utils-growpart tar libnsl authselect-compat å¤§è‡´çœ‹äº†ä¸‹ï¼Œé™¤äº† cloud-Init å’Œ cloud-utils-growpart è¿™ä¸¤ä¸ªåŒ…å…¶ä»–åŒ…åŸºæœ¬ä¸å¯èƒ½å»ä¿®æ”¹ ssh çš„é…ç½®\nç›´æ¥æ£€ç´¢è¿™ä¸¤ä¸ªåŒ…çš„æ‰€æœ‰æ–‡ä»¶ä¸­çš„é…ç½®ï¼Œæ˜¯å¦ä¸ PasswordAuthentication æœ‰å…³\n[root@localhost ~]# grep -nr PasswordAuthentication `rpm -ql cloud-utils-growpart` [root@localhost ~]# grep -nr PasswordAuthentication `rpm -ql cloud-init` æ‰¾åˆ°äº†ä¿®æ”¹è¿™ä¸ªå‚æ•°ä»£ç çš„å…·ä½“å®ç°\næŸ¥çœ‹è¯¥æ–‡ä»¶\n[root@localhost ~]# vim +98 /usr/lib/python3.7/site-packages/cloudinit/config/cc_set_passwords.py å…·ä½“çš„åˆ¤æ–­æ“ä½œå’Œä¿®æ”¹æ“ä½œ\nä¿®æ”¹æ“ä½œå°±ä¸å»æ·±ç©¶äº†ï¼Œä¸»è¦çœ‹ä¸‹åˆ¤æ–­æ“ä½œï¼Œå¯ä»¥çœ‹åˆ°åˆ¤æ–­æ“ä½œæ˜¯ä½¿ç”¨äº† util.is_true() ï¼Œè¯¥ util æ¨¡å—ä¹Ÿåœ¨è¯¥æ–‡ä»¶ä¸­å¼•ç”¨äº†\nå†å»æ‰¾è¿™ä¸ª util æ¨¡å—çš„å…·ä½“å®ç°\npython å¼•ç”¨çš„æ¨¡å—è·¯å¾„å¦‚ä¸‹ï¼Œå¦åˆ™ä¼šæŠ›å‡ºé”™è¯¯\næ–‡ä»¶çš„åŒçº§è·¯å¾„ä¸‹ sys.path è·¯å¾„ä¸‹ å¹¶æ²¡æœ‰åœ¨åŒçº§ç›®å½•ä¸‹\n[root@localhost ~]# ll /usr/lib/python3.7/site-packages/cloudinit/config/ | grep cloudinit sys.path è·¯å¾„ä¸çŸ¥é“å¯ä»¥ç”¨ python ç»ˆç«¯è¾“å‡ºä¸‹\nåœ¨/usr/lib/python3.7/site-packages è·¯å¾„ä¸‹æ‰¾åˆ°äº† cloudinit æ¨¡å—çš„ util å­æ¨¡å—\næŸ¥çœ‹ util.is_true å’Œ util.is_false å…·ä½“çš„å‡½æ•°å®ç°\né€»è¾‘å¾ˆç®€å•ï¼Œåˆ¤æ–­ val å‚æ•°æ˜¯å¦ä¸º bool å€¼ï¼Œå¦åˆ™å¯¹ val å‚æ•°çš„å€¼è¿›è¡Œå¤„ç†åå†æŸ¥çœ‹æ˜¯å¦åœ¨ check_set ä¸­\nå†å›å¤´çœ‹ä¹‹å‰çš„ /usr/lib/python3.7/site-packages/cloudinit/config/cc_set_passwords.py æ–‡ä»¶æ˜¯æ€æ ·å¯¹ util.is_true å’Œ util.is_false ä¼ å‚çš„\nå¯ä»¥çœ‹åˆ°æ˜¯ç”± handle_ssh_pwauth() å‡½æ•°ä¼ è¿›æ¥çš„\nå†ç»§ç»­æ‰¾å“ªä¸ªæ–‡ä»¶è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°\nè¿˜æ˜¯è¿™ä¸ªæ–‡ä»¶ï¼Œç¬¬ 230 è¡Œ\nè¿™é‡Œå‚æ•° pw_auth ä¼ çš„å€¼æ˜¯ cfg.get(\u0026lsquo;ssh_pwauth\u0026rsquo;)\ncfg.get() è¿™ä¸ªå‡½æ•° get çš„ä¸œè¥¿æ˜¯ /etc/cloud/cloud.cfg é…ç½®æ–‡ä»¶ä¸‹çš„ ssh_pwauth çš„å€¼\nåˆ°è¿™é‡Œï¼Œå°±å¯ä»¥å›å¤´å†çœ‹æ•´ä¸ªé€»è¾‘äº†\nè°ƒç”¨ handle_ssh_pwauth() å‡½æ•°ï¼Œä¼ äº†ä¸€ä¸ªå‚æ•° pw_auth=0 è°ƒç”¨ util.is_true() å’Œ util.is_false å‡½æ•°ï¼Œä¼ äº†åŒä¸€ä¸ªå‚æ•° val=0 ä¸Šè¿°ä¸¤ä¸ªå‡½æ•°æ‰§è¡Œå®Œå cfg_val çš„å€¼æœ€ç»ˆä¸º no è°ƒç”¨ update_ssh_config({cfg_name: cfg_val}) å‡½æ•°ï¼Œcfg_name=PasswordAuthenticationï¼Œcfg_val=no å³å°† sshd çš„é…ç½®æ–‡ä»¶çš„ PasswordAuthentication å€¼æ”¹ä¸º no ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/troubleshooting-cloud-init-change-ssh-config/","summary":"0 å‰è¨€ åœ¨ openEuler20.03 (LTS-SP1) ç³»ç»Ÿä¸Šè¿›è¡Œä¸€äº›æµ‹è¯•ï¼Œå‘ç°æŸä¸ªä¸œè¥¿ä¼šè‡ªåŠ¨ä¿®æ”¹ ssh é…ç½®æ–‡ä»¶å¯¼è‡´ç³»ç»Ÿæ— æ³•é€šè¿‡å¯†ç ç™»å½•ï¼Œæœ€åæ’æŸ¥æ˜¯ç”±äºå®‰è£…äº† cloud-init å¯¼è‡´çš„ã€‚ æ’æŸ¥æ€è·¯ å‡ºç°è¿™ä¸ªé—®é¢˜å‰åšçš„æ“ä½œæ˜¯å®‰è£…äº†ä¸€äº›é¡¹ç›®ç»„åŒäº‹æŒ‡å®šçš„åŒ…ï¼Œé—®é¢˜å°±åº”è¯¥å‡ºåœ¨è¿™äº›åŒ…ä¸Š yum install -y telnet rsync ntpdate zip unzip libaio dos2unix sos vim vim-enhanced net-tools man ftp lrzsz psmisc gzip network-scripts cloud-init cloud-utils-growpart tar libnsl authselect-compat å¤§è‡´çœ‹äº†ä¸‹ï¼Œé™¤äº† cloud-Init å’Œ cloud-utils-growpart è¿™ä¸¤","title":"troubleshooting | å®‰è£… cloud-init åå¯¼è‡´ ssh è¿æ¥å¤±è´¥"},{"content":"0 å‰è¨€ åŸºäº autohotkey v1 ç‰ˆæœ¬\nä½¿ç”¨æ–¹æ³•: å®‰è£… autohotkey å, å°†ä¸‹è¿°ä»£ç ä¿å­˜ä¸º .ahk æ–‡ä»¶, åŒå‡»æ‰§è¡Œå³å¯\nå¦‚éœ€å¼€æœºè‡ªå¯, åœ¨ è¿è¡Œ ä¸­æ‰§è¡Œ shell:startup, å°† .ahk æ–‡ä»¶æ”¾åˆ°è‡ªå¯åŠ¨ç›®å½•å³å¯\n1 prtsc æ”¹ä¸º shift insert æˆ‘çš„æœºæ¢°é”®ç›˜æ˜¯ 80 é…åˆ—, æ²¡æœ‰ insert, shift+insert å‡ ä¹æ˜¯æ‰€æœ‰è½¯ä»¶éƒ½æ”¯æŒçš„ç²˜è´´æ–¹å¼, é‚å°†å¾ˆä¸å¸¸ç”¨çš„ prtsc é”®æ”¹ä¸º shfit+insert çš„ç»„åˆé”®\nPrintScreen::+Insert 2 typora å¿«æ·ä¿®æ”¹å­—ä½“é¢œè‰² å®ç° alt + æ•°å­—é”®å¿«é€Ÿå°†å…‰æ ‡é€‰ä¸­çš„æ–‡æœ¬æ”¹ä¸ºå¯¹åº”çš„é¢œè‰²\n; åˆ†å·ä»¥åŠåˆ†å·åçš„å†…å®¹ä»£è¡¨æ³¨é‡Šï¼Œä»¥ä¸‹ä¸ºä»£ç è§£é‡Š #IfWinActive ahk_exe Typora.exe { ; alt+0 é»‘è‰² !0::addFontColor(\u0026#34;black\u0026#34;) ; alt+1 çŠç‘šè‰² !1::addFontColor(\u0026#34;coral\u0026#34;) ; alt+2 çº¢è‰² !2::addFontColor(\u0026#34;red\u0026#34;) ; alt+3 é»„è‰² !3::addFontColor(\u0026#34;yellow\u0026#34;) ; alt+4 ç»¿è‰² !4::addFontColor(\u0026#34;green\u0026#34;) ; alt+5 æµ…è“è‰² !5::addFontColor(\u0026#34;cornflowerblue\u0026#34;) ; alt+6 é’è‰² !6::addFontColor(\u0026#34;cyan\u0026#34;) ; alt+7 ç´«è‰² !7::addFontColor(\u0026#34;purple\u0026#34;) } ; å¿«æ·å¢åŠ å­—ä½“é¢œè‰² addFontColor(color){ clipboard := \u0026#34;\u0026#34; ; æ¸…ç©ºå‰ªåˆ‡æ¿ Send {ctrl down}c{ctrl up} ; å¤åˆ¶ ; SendInput {Text} ; è§£å†³ä¸­æ–‡è¾“å…¥æ³•é—®é¢˜ SendInput {TEXT}\u0026lt;font color=\u0026#39;%color%\u0026#39;\u0026gt; SendInput {ctrl down}v{ctrl up} ; ç²˜è´´ If(clipboard = \u0026#34;\u0026#34;){ SendInput {TEXT}\u0026lt;/font\u0026gt; ; Typora åœ¨è¿™ä¸ä¼šè‡ªåŠ¨è¡¥å…… }else{ SendInput {TEXT}\u0026lt;/ ; Typoraä¸­è‡ªåŠ¨è¡¥å…¨æ ‡ç­¾ } } ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/windows-autohotkey-scripts/","summary":"0 å‰è¨€ åŸºäº autohotkey v1 ç‰ˆæœ¬ ä½¿ç”¨æ–¹æ³•: å®‰è£… autohotkey å, å°†ä¸‹è¿°ä»£ç ä¿å­˜ä¸º .ahk æ–‡ä»¶, åŒå‡»æ‰§è¡Œå³å¯ å¦‚éœ€å¼€æœºè‡ªå¯, åœ¨ è¿è¡Œ ä¸­æ‰§è¡Œ shell:startup, å°† .ahk æ–‡ä»¶æ”¾åˆ°è‡ªå¯åŠ¨ç›®å½•å³å¯ 1 prtsc æ”¹ä¸º shift insert æˆ‘çš„æœºæ¢°é”®ç›˜æ˜¯ 80 é…åˆ—, æ²¡æœ‰ insert, shift+insert å‡ ä¹æ˜¯æ‰€æœ‰è½¯ä»¶éƒ½æ”¯æŒçš„ç²˜è´´æ–¹å¼, é‚å°†å¾ˆä¸å¸¸ç”¨çš„ prtsc é”®æ”¹ä¸º shfit+insert çš„ç»„åˆé”® PrintScreen::+Insert 2 typora å¿«æ·ä¿®æ”¹å­—ä½“é¢œè‰² å®ç° alt + æ•°å­—é”®å¿«é€Ÿå°†å…‰æ ‡","title":"windows | autohotkey å¸¸ç”¨è„šæœ¬"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\nä¿®æ”¹ rpm ä¸­çš„æ–‡ä»¶é‡æ–°æ‰“åŒ… è¦ä¿®æ”¹ rpm åŒ…ä¸­çš„æ–‡ä»¶ï¼Œå¯¹äºè‡ªå·±ç¼–è¯‘çš„ rpm åŒ…ï¼Œåªéœ€è¦åœ¨æºç ä¸­ä¿®æ”¹å¥½ç„¶åé‡æ–°ç¼–è¯‘å³å¯ã€‚è€Œå¯¹äºå¹¶ä¸æ˜¯è‡ªå·±ç¼–è¯‘çš„ rpm åŒ…ï¼Œä¸”ä¸ç†Ÿæ‚‰ç¼–è¯‘ç¯å¢ƒçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ rpm-build å’Œ rpm-rebuild å·¥å…·åç¼–è¯‘æ¥ä¿®æ”¹ rpm ä¸­çš„æ–‡ä»¶\nè¿™é‡Œä½¿ç”¨ ceph-mgr è½¯ä»¶åŒ…è¿›è¡Œæ¼”ç¤º\n1 å®‰è£… rpm-build\u0026amp;rpmrebuild rpmrebuild å®˜ç½‘ rpmrebuild ä¸‹è½½åœ°å€\nè§£å‹ rpmrebuild\n[root@localhost ~]# mkdir -p /data/rpmbuild [root@localhost ~]# tar zxf rpmrebuild-2.15.tar.gz -C /data/rpmbuild/ [root@localhost ~]# ll /opt/rpmrebuild/ rpm-build ç›´æ¥ä½¿ç”¨ yum å®‰è£…å³å¯\n[root@localhost ~]# yum install -y rpm-build 2 åç¼–è¯‘\u0026amp;ä¿®æ”¹\u0026amp;é‡æ–°ç¼–è¯‘ å®‰è£…å‡†å¤‡é‡æ–°æ‰“åŒ…çš„ rpm\n[root@localhost ~]# rpm -ivh ceph-mgr-12.2.13-0.el7.x86_64.rpm æŸ¥çœ‹ rpm çš„å®‰è£…åç§°\n[root@localhost ~]# rpm -qa |grep mgr ceph-mgr-12.2.13-0.el7.x86_64 é…ç½® rpm ç¼–è¯‘ç›®å½•\nvim ~/.rpmmacros %_topdir /data/rpmbuild åˆ›å»ºç›®å½•\nmkdir /data/rpmbuild/BUILDROOT mkdir /data/rpmbuild/SPECS æ‰§è¡Œè„šæœ¬\n[root@localhost ~]# cd /data/rpmbuild/ [root@localhost rpmbuild]# ./rpmrebuild.sh -s SPECS/abc.spec ceph-mgr [root@localhost rpmbuild]# cd è§£å‹åŸç‰ˆ RPM åŒ…\n[root@localhost ~]# rpm2cpio ceph-mgr-12.2.13-0.el7.x86_64.rpm |cpio -idv è¿™é‡Œè½¯ä»¶åŒ…è§£å‹åæ˜¯ä¸¤ä¸ªç›®å½•\næ ¹æ®éœ€æ±‚æ›¿æ¢ä¿®æ”¹è§£å‹åçš„æ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘æ›¿æ¢ä¸¤ä¸ªæ–‡ä»¶ /root/usr/lib64/ceph/mgr/dashboard/static/Ceph_Logo_Standard_RGB_White_120411_fa.png å’Œ /root/usr/lib64/ceph/mgr/dashboard/static/logo-mini.pngï¼Œå¹¶ç»™åŸå…ˆçš„æ–‡ä»¶åšä¸€ä¸ªå¤‡ä»½\n[root@localhost static]# mv logo-mini.png logo-mini.png.bak [root@localhost static]# mv Ceph_Logo_Standard_RGB_White_120411_fa.png Ceph_Logo_Standard_RGB_White_120411_fa.png.bak [root@localhost static]# cp kubernetes-logo.svg logo-mini.png [root@localhost static]# cp kubernetes-logo.svg Ceph_Logo_Standard_RGB_White_120411_fa.png ä¿®æ”¹ abc.spec æ–‡ä»¶\næ‰¾åˆ°åŸæ–‡ä»¶æ‰€åœ¨çš„è¡Œï¼Œæ·»åŠ å¤‡ä»½æ–‡ä»¶\n[root@localhost ~]# vim /data/rpmbuild/SPECS/abc.spec è¿™é‡Œåˆ›å»ºçš„ bbb ç›®å½•æ˜¯ä¸´æ—¶ä½¿ç”¨ï¼Œç¼–è¯‘è¿‡ç¨‹è‚¯å®šä¼šæŠ¥é”™ï¼Œå› ä¸ºè·¯å¾„ä¸å¯¹ï¼Œæ ¹æ®æŠ¥é”™ä¿®æ”¹è·¯å¾„\n[root@localhost ~]# mkdir -p /data/rpmbuild/BUILDROOT/bbb/ [root@localhost ~]# mv ./usr/ /data/rpmbuild/BUILDROOT/bbb/ [root@localhost ~]# mv ./var/ /data/rpmbuild/BUILDROOT/bbb/ [root@localhost ~]# rpmbuild -ba /data/rpmbuild/SPECS/abc.spec è¿™é‡Œå¯ä»¥çœ‹åˆ°ä»–è¯·æ±‚çš„è·¯å¾„\nä¿®æ”¹ç›®å½•å\n[root@localhost ~]# mv /data/rpmbuild/BUILDROOT/bbb/ /data/rpmbuild/BUILDROOT/ceph-mgr-12.2.13-0.el7.x86_64 å†æ¬¡ç¼–è¯‘\n[root@localhost ~]# rpmbuild -ba /data/rpmbuild/SPECS/abc.spec ç”Ÿæˆçš„ rpm ä½ç½®åœ¨/data/rpmbuild/RPMS/\næŸ¥çœ‹åŸ rpm åŒ…çš„æ–‡ä»¶\n[root@localhost ~]# cd /usr/lib64/ceph/mgr/dashboard/static [root@localhost static]# ll total 16 drwxr-xr-x 5 root root 117 Dec 6 03:11 AdminLTE-2.3.7 -rw-r--r-- 1 root root 4801 Jan 30 2020 Ceph_Logo_Standard_RGB_White_120411_fa.png -rw-r--r-- 1 root root 1150 Jan 30 2020 favicon.ico drwxr-xr-x 7 root root 94 Dec 6 03:11 libs -rw-r--r-- 1 root root 1811 Jan 30 2020 logo-mini.png å®‰è£…æ–° rpm åŒ…ï¼ŒæŸ¥çœ‹æ–‡ä»¶\n[root@localhost ~]# cd /data/rpmbuild/RPMS/x86_64 [root@localhost x86_64]# rpm -e --nodeps ceph-mgr [root@localhost x86_64]# rpm -ivh ceph-mgr-12.2.13-0.el7.x86_64.rpm [root@localhost x86_64]# cd /usr/lib64/ceph/mgr/dashboard/static [root@localhost static]# ll total 24 drwxr-xr-x 5 root root 117 Dec 6 03:53 AdminLTE-2.3.7 -rw-r--r-- 1 root root 1877 Dec 6 03:44 Ceph_Logo_Standard_RGB_White_120411_fa.png -rw-r--r-- 1 root root 4801 Dec 6 03:41 Ceph_Logo_Standard_RGB_White_120411_fa.png.bak -rw-r--r-- 1 root root 1150 Dec 6 03:41 favicon.ico drwxr-xr-x 7 root root 94 Dec 6 03:53 libs -rw-r--r-- 1 root root 1877 Dec 6 03:44 logo-mini.png -rw-r--r-- 1 root root 1811 Dec 6 03:41 logo-mini.png.bak è‡³æ­¤ï¼Œrpm åŒ…ä¸­çš„æ–‡ä»¶ä¿®æ”¹ä»¥åŠé‡æ–°æ‰“åŒ…çš„æ‰€æœ‰æ­¥éª¤éƒ½å·²å®Œæˆ\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/rpm-change-file/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: ä¿®æ”¹ rpm ä¸­çš„æ–‡ä»¶é‡æ–°æ‰“åŒ… è¦ä¿®æ”¹ rpm åŒ…ä¸­çš„æ–‡ä»¶ï¼Œå¯¹äºè‡ªå·±ç¼–è¯‘çš„ rpm åŒ…ï¼Œåªéœ€è¦åœ¨æºç ä¸­ä¿®æ”¹å¥½ç„¶åé‡æ–°ç¼–è¯‘å³å¯ã€‚è€Œå¯¹äºå¹¶ä¸æ˜¯è‡ªå·±ç¼–è¯‘çš„ rpm åŒ…ï¼Œä¸”ä¸ç†Ÿæ‚‰ç¼–è¯‘ç¯å¢ƒçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ rpm-build å’Œ rpm-rebuild å·¥å…·åç¼–è¯‘æ¥ä¿®æ”¹ rpm ä¸­çš„æ–‡ä»¶ è¿™é‡Œä½¿ç”¨ ceph-mgr è½¯ä»¶åŒ…è¿›è¡Œæ¼”ç¤º 1 å®‰è£… rpm-build\u0026amp;rpmrebuild rpmrebuild å®˜ç½‘ rpmrebuild ä¸‹è½½åœ°å€ è§£å‹ rpmrebuild [root@localhost ~]# mkdir -p","title":"é€šè¿‡åç¼–è¯‘ä¿®æ”¹ rpm åŒ…å†…çš„æ–‡ä»¶"},{"content":"0 å‰è¨€ åŸºäº isoft-serveros-v4.2\næœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\nå®‰è£…Ambari 2.7.5 + HDP3.1.5ï¼ˆé™„å®‰è£…åŒ…ï¼‰ 1 å‰æœŸå‡†å¤‡ 1.1 å®‰è£…åŒ…å‡†å¤‡ Ambari-2.7.5 HDP-3.1.5 libtirpc-devel:\né“¾æ¥ï¼šhttps://pan.baidu.com/s/1eteZ2jGkSq4Pz5YFfHyJgQ\næå–ç ï¼š6hq3\n1.2 æœåŠ¡å™¨é…ç½® ä¸»æœºå cpu å†…å­˜ ç¡¬ç›˜ ç³»ç»Ÿç‰ˆæœ¬ ip åœ°å€ node001 4c 10g 50g isoft-serveros-4.2 192.168.150.106 node002 2c 4g 20g isoft-serveros-4.2 192.168.150.107 1.3 ä¿®æ”¹ç³»ç»Ÿç‰ˆæœ¬æ–‡ä»¶ (allnode) sed -i \u0026#39;s/4/7/g\u0026#39; /etc/redhat-release sed -i \u0026#39;s/4/7/g\u0026#39; /etc/os-release 1.4 é…ç½®ä¸»æœºå (allnode) 2 å°æœåŠ¡å™¨çš„ hosts éƒ½éœ€è¦åšå¦‚ä¸‹ä¿®æ”¹\nä¿®æ”¹ä¸»æœºå hostnamectl set-hostname node001 bash ä¿®æ”¹ hosts æ–‡ä»¶ vim /etc/hosts 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6 192.168.150.106 node001 192.168.150.107 node002 1.5 å…³é—­é˜²ç«å¢™åŠ selinux (allnode) 2 å°æœåŠ¡å™¨ä¸Šåˆ†åˆ«æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼Œå…³é—­é˜²ç«å¢™å¹¶é…ç½®å¼€æœºä¸è‡ªåŠ¨å¯åŠ¨\nsystemctl stop firewalld systemctl disable firewalld setenforce 0 ä¸ºäº†é‡å¯åä¾ç„¶å…³é—­ï¼Œé…ç½®å¦‚ä¸‹æ–‡ä»¶\nvim /etc/sysconfig/selinux # ä¿®æ”¹ SELINUX=disabled 1.6 é…ç½® ssh äº’ä¿¡ (allnode) æ–¹æ³•ä¸€\nåœ¨æ¯å°æœåŠ¡å™¨ä¸Šæ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼Œä¸€ç›´å›è½¦å³å¯\nssh-keygen -t rsa ssh-copy-id -i /root/.ssh/id_rsa.pub node001 ssh-copy-id -i /root/.ssh/id_rsa.pub node002 æ–¹æ³•äºŒ\nåœ¨æ¯å°æœåŠ¡å™¨ä¸Šæ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼Œä¸€ç›´å›è½¦å³å¯\nssh-keygen -t rsa åœ¨æœåŠ¡å™¨ 1 ä¸Šå°†å…¬é’¥ï¼ˆåä¸º id_rsa.pub æ–‡ä»¶ï¼‰è¿½åŠ åˆ°è®¤è¯æ–‡ä»¶ï¼ˆåä¸º authorized_keys æ–‡ä»¶ï¼‰ä¸­:\ncat ~/.ssh/id_rsa.pub \u0026gt;\u0026gt; ~/.ssh/authorized_keys å»å…¶ä»–æœåŠ¡å™¨èŠ‚ç‚¹å°† ~/.ssh/id_rsa.pub ä¸­çš„å†…å®¹æ‹·è´åˆ°æœåŠ¡å™¨ 1 çš„ ~/.ssh/authorized_keys ä¸­,æŸ¥çœ‹æ–‡ä»¶ä¸­çš„å†…å®¹\ncat ~/.ssh/authorized_keys ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/eA09X4s5RIYvuYNxVvtOo6unY1mgipsFyoz/hy/Gwk0onfZvBi/Sl3TVRZO5aqcHccAGlLF7OPTKH1qUuKVtnUOQik0TouL5VKsOBDMHHRT9D5UwqaIE8tYDC8V6uwieFgscZcBjhrsJ/Iramo9ce7N9RTO3otRMRQxOs+Wd1F/ZOmpRtMGU2N4RH4i2quRU6m2lt/eJKpNupSHKoztTQRsEanilHVASnikAXH8JpG70iO7RXR/hLz+/Of3ISUrOMSO4/ZIIu4xnYN3jvsXOdK/qIhP/PI2s+uF22IvVE6xZYVadQFa4zAuhQmCBWkE7vMyI1UJkxP7OQYj72LUH root@node001 ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCnz8wHoytR2Xlnl04rQq4I2vgUVWbkKjv30pj+Toz4719ah4cY9pvZj0JsfhVzaaCsR14BLFVLkqKUhCWK3K6muT4iHb+N0WirpbwfJkztmQeco7Ha9xrPQ8v/I4xZujFoMVA0tkb/32zRTxOkPv9AUgB8V6Lin6LnB/AcnhnmoIs5PdbAdh/kBGpQGKIZkbyCUOYz9/PZuGJoJBblqfWiqzxYYLN9+cYMkmPnB1HdDewAepIsIC18U3ujE+1Su2UlmISPvvr1zG4XR4ZZoKQsOOJq3XRMGVkDvmFhl03JHZpd6BW0796CeYVZ41UomWXTOduQql+tYWUbegzGLmRZ root@node002 ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC8AFoGJHp2M45xLYNzXUHLWzRwHsgRPHjeErStq0tEy9bQv4OkN41j0FrxVAYJiGHdHGturriVgUEtL59RjcrJH6bAvhP54nM5YiQlNnWnSUR27Zuaodz4nhYUFq/Co5eDN6lTfL8pgYiEdpBOvE5t1w3bisdblP7YGQ2lF1zzCEGfQ79QbntEbyGNoR9sGHm11x9fOH+fape8TjQJrEAO4d1tAhMqVygQKwqwAPKeqhEum6BaLli83TsXzd7gyz9H7AAc1m04NaLB26xfynW6MVuk1j94awXKlGXjrbNTC/Kg6M8bd5PT/k3DOkx4b+nEs8xZ5x1j4D2OaO1X6rZx root@node003 è®¾ç½®è®¤è¯æ–‡ä»¶çš„æƒé™ï¼š\nchmod 600 ~/.ssh/authorized_keys å°† ~/.ssh/authorized_keys åŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹\nscp ~/.ssh/authorized_keys node002:~/.ssh/authorized_keys æ³¨æ„ï¼šè¿™é‡Œç¬¬ä¸€æ¬¡ä½¿ç”¨åŒæ­¥è¿˜éœ€è¦å¯†ç ï¼Œä¹‹åå°±ä¸éœ€è¦äº†\néªŒè¯å…å¯†æ˜¯å¦é…ç½®æˆåŠŸ\nssh åˆ°ä¸åŒæœåŠ¡å™¨\nssh node002 1.7 é…ç½® ntp æ—¶é’ŸåŒæ­¥ é€‰æ‹©ä¸€å°æœåŠ¡å™¨ä½œä¸º NTP Serverï¼Œè¿™é‡Œé€‰æ‹© node001\nå°†å¦‚ä¸‹é…ç½® vim /etc/ntp.conf\n# Use public servers from the pool.ntp.org project. # Please consider joining the pool (http://www.pool.ntp.org/join.html). server 0.centos.pool.ntp.org iburst server 1.centos.pool.ntp.org iburst server 2.centos.pool.ntp.org iburst server 3.centos.pool.ntp.org iburst ä¿®æ”¹ä¸º\n# Use public servers from the pool.ntp.org project. # Please consider joining the pool (http://www.pool.ntp.org/join.html). #server 0.centos.pool.ntp.org iburst #server 1.centos.pool.ntp.org iburst #server 2.centos.pool.ntp.org iburst #server 3.centos.pool.ntp.org iburst server 127.127.1.0 fudge 127.127.1.0 stratum 10 node002 èŠ‚ç‚¹åšå¦‚ä¸‹é…ç½®\nvim /etc/ntp.conf å°†\n# Use public servers from the pool.ntp.org project. # Please consider joining the pool (http://www.pool.ntp.org/join.html). server 0.centos.pool.ntp.org iburst server 1.centos.pool.ntp.org iburst server 2.centos.pool.ntp.org iburst server 3.centos.pool.ntp.org iburst ä¿®æ”¹ä¸º\n# Use public servers from the pool.ntp.org project. # Please consider joining the pool (http://www.pool.ntp.org/join.html). #server 0.centos.pool.ntp.org iburst #server 1.centos.pool.ntp.org iburst #server 2.centos.pool.ntp.org iburst #server 3.centos.pool.ntp.org iburst server 192.168.150.106 åœ¨æ¯å°æœåŠ¡å™¨ä¸Šå¯åŠ¨ ntpd æœåŠ¡ï¼Œå¹¶é…ç½®æœåŠ¡å¼€æœºè‡ªå¯åŠ¨\nsystemctl restart ntpd systemctl enable ntpd 1.8 è®¾ç½® swap(allnode) echo vm.swappiness = 1 \u0026gt;\u0026gt; /etc/sysctl.conf sysctl vm.swappiness=1 sysctl -p 1.9 å…³é—­é€æ˜å¤§é¡µé¢ (allnode) ç”±äºé€æ˜è¶…å¤§é¡µé¢å·²çŸ¥ä¼šå¯¼è‡´æ„å¤–çš„èŠ‚ç‚¹é‡æ–°å¯åŠ¨å¹¶å¯¼è‡´ RAC å‡ºç°æ€§èƒ½é—®é¢˜ï¼Œå› æ­¤ Oracle å¼ºçƒˆå»ºè®®ç¦ç”¨\necho never \u0026gt; /sys/kernel/mm/transparent_hugepage/defrag echo never \u0026gt; /sys/kernel/mm/transparent_hugepage/enabled 1.10 å®‰è£… http æœåŠ¡ (node001) å®‰è£… apache çš„ httpd æœåŠ¡ä¸»è¦ç”¨äºæ­å»º OS. Ambari å’Œ hdp çš„ yum æºã€‚åœ¨é›†ç¾¤æœåŠ¡å™¨ä¸­é€‰æ‹©ä¸€å°æœåŠ¡å™¨æ¥å®‰è£… httpd æœåŠ¡ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š\nyum -y install httpd systemctl start httpd systemctl enable httpd.service éªŒè¯ï¼Œåœ¨æµè§ˆå™¨è¾“å…¥http://192.168.150.106çœ‹åˆ°å¦‚ä¸‹æˆªå›¾åˆ™è¯´æ˜å¯åŠ¨æˆåŠŸã€‚\n1.11 å®‰è£… Java(allnode) ä¸‹è½½åœ°å€ï¼šhttps://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html\ntar -zxvf jdk-8u271-linux-x64.tar.gz mkdir /usr/local/java mv jdk1.8.0_271/* /usr/local/java é…ç½®ç¯å¢ƒå˜é‡\nvim /root/.bashrc æ·»åŠ å¦‚ä¸‹é…ç½®\nexport JAVA_HOME=/usr/local/java export PATH=$PATH:$JAVA_HOME/bin export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar export JRE_HOME=$JAVA_HOME/jre æ¿€æ´»é…ç½®\nsource /root/.bashrc java -version 1.12 å®‰è£… maven3.6(node001) ä¸‹è½½è§£å‹\ntar -zxvf apache-maven-3.6.3-bin.tar.gz mkdir -p /opt/src/maven mv apache-maven-3.6.3/* /opt/src/maven é…ç½® maven ç¯å¢ƒå˜é‡\nvim /root/.bashrc # set maven home export PATH=$PATH:/opt/src/maven/bin æ¿€æ´»\nsource /root/.bashrc 2 å®‰è£… Ambari \u0026amp; HDP 2.1 é…ç½®æœ¬åœ°æº è§£å‹\ntar -zxvf ambari-2.7.5.0-centos7.tar.gz -C /var/www/html/ tar -zxvf HDP-3.1.5.0-centos7-rpm.tar.gz -C /var/www/html/ tar -zxvf HDP-GPL-3.1.5.0-centos7-gpl.tar.gz -C /var/www/html/ tar -zxvf HDP-UTILS-1.1.0.22-centos7.tar.gz -C /var/www/html/ ll /var/www/html/ æ€»ç”¨é‡ 0 drwxr-xr-x. 3 root root 21 11æœˆ 23 22:31 ambari drwxr-xr-x. 3 1001 users 21 12æœˆ 18 2019 HDP drwxr-xr-x. 3 1001 users 21 12æœˆ 18 2019 HDP-GPL drwxr-xr-x. 3 1001 users 21 8æœˆ 13 2018 HDP-UTILS è®¾ç½®è®¾ç½®ç”¨æˆ·ç»„å’Œæˆæƒ\nchown -R root:root /var/www/html/HDP chown -R root:root /var/www/html/HDP-GPL chown -R root:root /var/www/html/HDP-UTILS chmod -R 755 /var/www/html/HDP chmod -R 755 /var/www/html/HDP-GPL chmod -R 755 /var/www/html/HDP-UTILS åˆ›å»º libtirpc-devel æœ¬åœ°æº\nmkdir /var/www/html/libtirpc mv /root/libtirpc-* /var/www/html/libtirpc/ cd /var/www/html/libtirpc createrepo . åˆ¶ä½œæœ¬åœ°æº\né…ç½® ambari.repo\nvim /etc/yum.repos.d/ambari.repo [Ambari-2.7.5.0] name=Ambari-2.7.5.0 baseurl=http://192.168.150.106/ambari/centos7/2.7.5.0-72/ gpgcheck=0 enabled=1 priority=1 é…ç½® HDP å’Œ HDP-TILS\nvim /etc/yum.repos.d/HDP.repo [HDP-3.1.5.0] name=HDP Version - HDP-3.1.5.0 baseurl=http://192.168.150.106/HDP/centos7/3.1.5.0-152/ gpgcheck=0 enabled=1 priority=1 [HDP-UTILS-1.1.0.22] name=HDP-UTILS Version - HDP-UTILS-1.1.0.22 baseurl=http://192.168.150.106/HDP-UTILS/centos7/1.1.0.22/ gpgcheck=0 enabled=1 priority=1 [HDP-GPL-3.1.5.0] name=HDP-GPL Version - HDP-GPL-3.1.5.0 baseurl=http://192.168.150.106/HDP-GPL/centos7/3.1.5.0-152 gpgcheck=0 enabled=1 priority=1 é…ç½® libtirpc.repo\nvim /etc/yum.repos.d/libtirpc.repo [libtirpc_repo] name=libtirpc-0.2.4-0.16 baseurl=http://192.168.150.106/libtirpc/ gpgcheck=0 enabled=1 priority=1 æ‹·è´åˆ°å…¶ä»–èŠ‚ç‚¹\nscp /etc/yum.repos.d/* node002:/etc/yum.repos.d/ æŸ¥çœ‹æº\nyum clean all yum repolist 2.2 å®‰è£… mariadb(node001) å®‰è£… MariaDB æœåŠ¡å™¨\nyum install mariadb-server -y å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨\nsystemctl enable mariadb systemctl start mariadb åˆå§‹åŒ–\n/usr/bin/mysql_secure_installation [...] Enter current password for root (enter for none): OK, successfully used password, moving on... [...] Set root password? [Y/n] Y New password:123456 Re-enter new password:123456 [...] Remove anonymous users? [Y/n] Y [...] Disallow root login remotely? [Y/n] N [...] Remove test database and access to it [Y/n] Y [...] Reload privilege tables now? [Y/n] Y [...] All done! If you\u0026#39;ve completed all of the above steps, your MariaDB 18 installation should now be secure. Thanks for using MariaDB! ä¸º MariaDB å®‰è£… MySQL JDBC é©±åŠ¨ç¨‹åº\ntar zxf mysql-connector-java-5.1.40.tar.gz mv mysql-connector-java-5.1.40/mysql-connector-java-5.1.40-bin.jar /usr/share/java/mysql-connector-java.jar åˆ›å»ºéœ€è¦çš„æ•°æ®åº“\nå¦‚æœéœ€è¦ rangerï¼Œç¼–è¾‘ä»¥ä¸‹â½‚ä»¶ï¼š vim /etc/my.cnf å¹¶æ·»åŠ ä»¥ä¸‹â¾ï¼š\nlog_bin_trust_function_creators = 1 é‡å¯æ•°æ®åº“å¹¶ç™»å½•\nsystemctl restart mariadb mysql -u root -p123456 2.3 å®‰è£…å’Œé…ç½® ambari-server (node001) å®‰è£… ambari-server\nyum -y install ambari-server å¤åˆ¶ mysql jdbc é©±åŠ¨åˆ° /var/lib/ambari-server/resources/\ncp /usr/share/java/mysql-connector-java.jar /var/lib/ambari-server/resources/ é…ç½® /etc/ambari-server/conf/ambari.propertiesï¼Œæ·»åŠ å¦‚ä¸‹è¡Œ\nvim /etc/ambari-server/conf/ambari.properties server.jdbc.driver.path=/usr/share/java/mysql-connector-java.jar æ‰§è¡Œ\nambari-server setup --jdbc-db=mysql --jdbc-driver=/usr/share/java/mysql-connector-java.jar åˆå§‹åŒ– ambari-server\nambari-server setup 1ï¼‰ æç¤ºæ˜¯å¦è‡ªå®šä¹‰è®¾ç½®ã€‚è¾“å…¥ï¼šy Customize user account for ambari-server daemon [y/n] (n)? y ï¼ˆ2ï¼‰ambari-server è´¦å·ã€‚ Enter user account for ambari-server daemon (root): å¦‚æœç›´æ¥å›è½¦å°±æ˜¯é»˜è®¤é€‰æ‹©rootç”¨æˆ· å¦‚æœè¾“å…¥å·²ç»åˆ›å»ºçš„ç”¨æˆ·å°±ä¼šæ˜¾ç¤ºï¼š Enter user account for ambari-server daemon (root):ambari Adjusting ambari-server permissions and ownership... ï¼ˆ3ï¼‰è®¾ç½®JDKã€‚è¾“å…¥ï¼š2 Checking JDK... Do you want to change Oracle JDK [y/n] (n)? y [1] Oracle JDK 1.8 + Java Cryptography Extension (JCE) Policy Files 8 [2] Custom JDK ============================================================================== Enter choice (1): 2 å¦‚æœä¸Šé¢é€‰æ‹©3è‡ªå®šä¹‰JDK,åˆ™éœ€è¦è®¾ç½®JAVA_HOMEã€‚è¾“å…¥ï¼š/usr/local/java WARNING: JDK must be installed on all hosts and JAVA_HOME must be valid on all hosts. WARNING: JCE Policy files are required for configuring Kerberos security. If you plan to use Kerberos,please make sure JCE Unlimited Strength Jurisdiction Policy Files are valid on all hosts. Path to JAVA_HOME: /usr/local/java Validating JDK on Ambari Server...done. Completing setup... ï¼ˆ4ï¼‰å®‰è£…GPLï¼Œé€‰æ‹©ï¼šy Checking GPL software agreement... GPL License for LZO: https://www.gnu.org/licenses/old-licenses/gpl-2.0.en.html Enable Ambari Server to download and install GPL Licensed LZO packages [y/n] (n)? y ï¼ˆ5ï¼‰æ•°æ®åº“é…ç½®ã€‚é€‰æ‹©ï¼šy Configuring database... Enter advanced database configuration [y/n] (n)? y ï¼ˆ6ï¼‰é€‰æ‹©æ•°æ®åº“ç±»å‹ã€‚è¾“å…¥ï¼š3 Configuring database... ============================================================================== Choose one of the following options: [1] - PostgreSQL (Embedded) [2] - Oracle [3] - MySQL/ MariaDB [4] - PostgreSQL [5] - Microsoft SQL Server (Tech Preview) [6] - SQL Anywhere ============================================================================== Enter choice (3): 3 ï¼ˆ7ï¼‰è®¾ç½®æ•°æ®åº“çš„å…·ä½“é…ç½®ä¿¡æ¯ï¼Œæ ¹æ®å®é™…æƒ…å†µè¾“å…¥ï¼Œå¦‚æœå’Œæ‹¬å·å†…ç›¸åŒï¼Œåˆ™å¯ä»¥ç›´æ¥å›è½¦ã€‚å¦‚æœæƒ³é‡å‘½åï¼Œå°±è¾“å…¥ã€‚ Hostname (localhost):node001 Port (3306): 3306 Database name (ambari): ambari Username (ambari): ambari Enter Database Password (bigdata):ambari123 Re-Enter password: ambari123 ï¼ˆ8ï¼‰å°†Ambariæ•°æ®åº“è„šæœ¬å¯¼å…¥åˆ°æ•°æ®åº“ WARNING: Before starting Ambari Server, you must run the following DDL against the database to create the schema: /var/lib/ambari-server/resources/Ambari-DDL-MySQL-CREATE.sql è¿™ä¸ªsqlåé¢ä¼šç”¨åˆ°ï¼Œå¯¼å…¥æ•°æ®åº“ Proceed with configuring remote database connection properties [y/n] (y)? y ç™»å½• mariadb åˆ›å»º ambari å®‰è£…æ‰€éœ€è¦çš„åº“\nè®¾ç½®çš„è´¦å·åé¢é…ç½® ambari-server çš„æ—¶å€™ä¼šç”¨åˆ°\nmysql -uroot -p123456 CREATE DATABASE ambari; use ambari; CREATE USER \u0026#39;ambari\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;ambari123\u0026#39;; GRANT ALL PRIVILEGES ON *.* TO \u0026#39;ambari\u0026#39;@\u0026#39;%\u0026#39;; CREATE USER \u0026#39;ambari\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;ambari123\u0026#39;; GRANT ALL PRIVILEGES ON *.* TO \u0026#39;ambari\u0026#39;@\u0026#39;localhost\u0026#39;; CREATE USER \u0026#39;ambari\u0026#39;@\u0026#39;node001\u0026#39; IDENTIFIED BY \u0026#39;ambari123\u0026#39;; GRANT ALL PRIVILEGES ON *.* TO \u0026#39;ambari\u0026#39;@\u0026#39;node001\u0026#39;; source /var/lib/ambari-server/resources/Ambari-DDL-MySQL-CREATE.sql show tables; use mysql; select host,user from user where user=\u0026#39;ambari\u0026#39;; CREATE DATABASE hive; use hive; CREATE USER \u0026#39;hive\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;hive\u0026#39;; GRANT ALL PRIVILEGES ON *.* TO \u0026#39;hive\u0026#39;@\u0026#39;%\u0026#39;; CREATE USER \u0026#39;hive\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;hive\u0026#39;; GRANT ALL PRIVILEGES ON *.* TO \u0026#39;hive\u0026#39;@\u0026#39;localhost\u0026#39;; CREATE USER \u0026#39;hive\u0026#39;@\u0026#39;node001\u0026#39; IDENTIFIED BY \u0026#39;hive\u0026#39;; GRANT ALL PRIVILEGES ON *.* TO \u0026#39;hive\u0026#39;@\u0026#39;node001\u0026#39;; CREATE DATABASE oozie; use oozie; CREATE USER \u0026#39;oozie\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;oozie\u0026#39;; GRANT ALL PRIVILEGES ON *.* TO \u0026#39;oozie\u0026#39;@\u0026#39;%\u0026#39;; CREATE USER \u0026#39;oozie\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;oozie\u0026#39;; GRANT ALL PRIVILEGES ON *.* TO \u0026#39;oozie\u0026#39;@\u0026#39;localhost\u0026#39;; CREATE USER \u0026#39;oozie\u0026#39;@\u0026#39;node001\u0026#39; IDENTIFIED BY \u0026#39;oozie\u0026#39;; GRANT ALL PRIVILEGES ON *.* TO \u0026#39;oozie\u0026#39;@\u0026#39;node001\u0026#39;; FLUSH PRIVILEGES; 2.4 å®‰è£… ambari-agent(allnode) pssh -h /node.list -i \u0026#39;yum -y install ambari-agent\u0026#39; pssh -h /node.list -i \u0026#39;systemctl start ambari-agent\u0026#39; 2.5 å®‰è£… libtirpc-devel(allnode) pssh -h /node.list -i \u0026#39;yum -y install libtirpc-devel\u0026#39; 2.6 å¯åŠ¨ ambari æœåŠ¡ ambari-server start 3 éƒ¨ç½²é›†ç¾¤ 3.1 ç™»å½•ç•Œé¢ http://192.168.150.106:8080\né»˜è®¤ç®¡ç†å‘˜è´¦æˆ·ç™»å½•ï¼Œ è´¦æˆ·ï¼šadmin å¯†ç ï¼šadmin\n3.2 é€‰æ‹©ç‰ˆæœ¬ï¼Œé…ç½® yum æº 1ï¼‰é€‰æ‹© Launch Install Wizard\n2ï¼‰é…ç½®é›†ç¾¤åç§°\n3ï¼‰é€‰æ‹©ç‰ˆæœ¬å¹¶ä¿®æ”¹æœ¬åœ°æºåœ°å€\né€‰ HDP-3.1(Default Version Definition);\né€‰ Use Local Repository;\né€‰ redhat7:\nHDP-3.1ï¼šhttp://node001/HDP/centos7/3.1.5.0-152/\nHDP-3.1-GPL: http://node001/HDP-GPL/centos7/3.1.5.0-152/\nHDP-UTILS-1.1.0.22: http://node001/HDP-UTILS/centos7/1.1.0.22/\n3.3 é…ç½®èŠ‚ç‚¹å’Œå¯†é’¥ ä¸‹è½½ä¸»èŠ‚ç‚¹çš„ /root/.ssh/id_rsaï¼Œå¹¶ä¸Šä¼ ï¼ç‚¹å‡»ä¸‹ä¸€æ­¥ï¼Œè¿›å…¥ç¡®è®¤ä¸»æœºç•Œé¢\nä¹Ÿå¯ç›´æ¥ cat /root/.ssh/id_rsa ç²˜è´´å³å¯\néªŒè¯é€šè¿‡\n3.4 å‹¾é€‰éœ€è¦å®‰è£…çš„æœåŠ¡ ç”±äºèµ„æºæœ‰é™ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰é€‰æ‹©æ‰€æœ‰æœåŠ¡\n3.5 åˆ†é…æœåŠ¡ master 3.6 åˆ†é…æœåŠ¡ slaves è®¾ç½®ç›¸å…³æœåŠ¡çš„å¯†ç \nGrafana Admin: 123456\nHive Database: hive\nActivity Explorerâ€™s Admin: admin\n3.7 è¿æ¥æ•°æ®åº“ 3.8 ç¼–è¾‘é…ç½®ï¼Œé»˜è®¤å³å¯ 3.9 å¼€å§‹éƒ¨ç½² 3.10 å®‰è£…æˆåŠŸ å³ä¸Šè§’ä¸¤ä¸ªè­¦å‘Šæ˜¯ç£ç›˜ä½¿ç”¨ç‡è­¦å‘Šï¼Œè™šæœºåˆ†é…çš„ç£ç›˜è¾ƒå°\n4 å…¶ä»– 4.1 æ·»åŠ å…¶ä»–ç³»ç»Ÿæ”¯æŒ HDP é»˜è®¤ä¸æ”¯æŒå®‰è£…åˆ° isoft-serverosv4.2ï¼Œéœ€æ‰‹åŠ¨æ·»åŠ æ”¯æŒ\nvim /usr/lib/ambari-server/lib/ambari_commons/resources/os_family.json æ·»åŠ å¦‚ä¸‹ä¸¤è¡Œï¼Œæ³¨æ„ç¼©è¿›å’Œé€—å·\n4.2 YARN Registry DNS æœåŠ¡å¯åŠ¨å¤±è´¥ lsof -i:53 kill -9 4.3 è®¾ç½®åˆå§‹æ£€æµ‹çš„ç³»ç»Ÿç‰ˆæœ¬ vim /etc/ambari-server/conf/ambari.properties server.os_family=redhat7 server.os_type=redhat7 ","permalink":"https://www.lvbibir.cn/posts/tech/centos-deploy-ambari-2.7.5-and-hdp-3.1.5/","summary":"0 å‰è¨€ åŸºäº isoft-serveros-v4.2 æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: å®‰è£…Ambari 2.7.5 + HDP3.1.5ï¼ˆé™„å®‰è£…åŒ…ï¼‰ 1 å‰æœŸå‡†å¤‡ 1.1 å®‰è£…åŒ…å‡†å¤‡ Ambari-2.7.5 HDP-3.1.5 libtirpc-devel: é“¾æ¥ï¼šhttps://pan.baidu.com/s/1eteZ2jGkSq4Pz5YFfHyJgQ æå–ç ï¼š6hq3 1.2 æœåŠ¡å™¨é…ç½® ä¸»æœºå cpu å†…å­˜ ç¡¬ç›˜ ç³»ç»Ÿç‰ˆæœ¬ ip åœ°å€ node001 4c 10g 50g isoft-serveros-4.2 192.168.150.106 node002 2c","title":"éƒ¨ç½² Ambari 2.7.5 + HDP 3.1.5"},{"content":"\nğŸ¡ å…³äºæœ¬ç«™ æœ¬åšå®¢ä¸»è¦è®°å½•ä¸€äº›å­¦ä¹ ç”Ÿæ´»ï¼Œå’Œä¸€äº›ä¸ªäººè§‰å¾—å€¼å¾—è®°å½•çš„é—®é¢˜åŠå…¶è§£å†³åŠæ³•ã€‚å¦‚æœæœ¬åšå®¢èƒ½æœ‰å“ªäº›å†…å®¹å¸®åŠ©åˆ°äº†ä½ ï¼Œé‚£ä¹Ÿæ˜¯æå¥½çš„ã€‚\nğŸ‘¦ğŸ» åšä¸»æ˜¯è° ç½‘ç»œæ—¶ä»£çš„ç´ è´¨æ•™è‚²æ¼ç½‘ä¹‹é±¼ | æ™šç¡åä¼šå¸¸ä»»ç†äº‹ | å›½å®¶çº§æŠ¬æ è¿åŠ¨å‘˜ | ä¸­å›½é©°åçªé‡Œæ¨ª | å›½å®çº§è€æ±¡é¾Ÿ | è¶…æ°´å¹³æ€¼äººå¤§å¸ˆ | ä¸€ç§’å…¥æˆå‡†å½±å¸\nç²¾é€šCSSã€JavaScriptã€PHPã€Cã€Cï¼‹ï¼‹ã€C#ã€javaã€Rubyã€Perlã€Lispã€pythonç­‰å•è¯çš„æ‹¼å†™ï¼›\nç†Ÿæ‚‰windowsã€Linuxã€Macã€Androidã€IOSç­‰ç³»ç»Ÿçš„å¼€å…³æœºï¼›\nğŸ¹ å…´è¶£çˆ±å¥½ ğŸƒâ€â™‚ï¸ è·‘æ­¥ | ğŸ®ï¸ æ¸¸æˆ | ğŸ§ éŸ³ä¹ | ğŸ“º åŠ¨æ¼« | ğŸ›Œ æ‘†çƒ‚\nğŸ“ˆ åšå®¢å˜æ›´è®°å½• 2022å¹´9æœˆ8æ—¥ æœ¬åšå®¢æ­£å¼åŠ å…¥ åå¹´ä¹‹çº¦\nä»Šå¤•ä½•å¤•ï¼Œäººç”Ÿèƒ½æœ‰å‡ ä¸ªåå¹´\n2022å¹´7æœˆ16æ—¥ è¿ç§»ä¹‹å‰å‘å¸ƒåœ¨ csdn çš„æ–‡ç« ï¼Œå°†å›¾ç‰‡å¤–é“¾å…¨éƒ¨è½¬ä¸ºä¸ƒç‰›å›¾åºŠ\n2022å¹´7æœˆ4æ—¥ hugo ç«™ç‚¹è¯•è¿è¡Œï¼ŒåŸŸåï¼šhttps://www.lvbibir.cn\n2021å¹´8æœˆ15æ—¥ å°†é˜¿é‡Œäº‘è½»é‡æœåŠ¡å™¨è‡ªå¸¦çš„ wordpress åº”ç”¨æ”¹ä¸º docker åº”ç”¨ï¼Œwordpress ç«™ç‚¹æ”¹ä¸º docker-compose éƒ¨ç½²\n2021å¹´7æœˆ13æ—¥ wordpress åšå®¢ç«™ç‚¹å¼€å§‹è¿è¡Œï¼ŒåŸŸåï¼šhttps://lvbibir.cn\n","permalink":"https://www.lvbibir.cn/about/","summary":"ğŸ¡ å…³äºæœ¬ç«™ æœ¬åšå®¢ä¸»è¦è®°å½•ä¸€äº›å­¦ä¹ ç”Ÿæ´»ï¼Œå’Œä¸€äº›ä¸ªäººè§‰å¾—å€¼å¾—è®°å½•çš„é—®é¢˜åŠå…¶è§£å†³åŠæ³•ã€‚å¦‚æœæœ¬åšå®¢èƒ½æœ‰å“ªäº›å†…å®¹å¸®åŠ©åˆ°äº†ä½ ï¼Œé‚£ä¹Ÿæ˜¯æå¥½çš„ã€‚ ğŸ‘¦ğŸ» åšä¸»æ˜¯è° ç½‘ç»œæ—¶ä»£çš„ç´ è´¨æ•™è‚²æ¼ç½‘ä¹‹é±¼ | æ™šç¡åä¼šå¸¸ä»»ç†äº‹ | å›½å®¶çº§æŠ¬æ è¿åŠ¨å‘˜ | ä¸­å›½é©°åçªé‡Œæ¨ª | å›½å®çº§è€æ±¡é¾Ÿ | è¶…æ°´å¹³æ€¼äººå¤§å¸ˆ | ä¸€ç§’å…¥æˆå‡†å½±å¸ ç²¾é€šCSSã€Ja","title":"ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº"},{"content":"ğŸ‘‰å‹é“¾ä¸ºéšæœºé¡ºåº cuikx\u0026#39;s blog cuikx\u0026#39;s blog Sulv\u0026#39;s Blog ä¸€ä¸ªè®°å½•æŠ€æœ¯ã€é˜…è¯»ã€ç”Ÿæ´»çš„åšå®¢ é™ˆæ¡‚æ—åšå®¢ æˆåŠŸæœ€æœ‰æ•ˆçš„æ–¹æ³•å°±æ˜¯å‘æœ‰ç»éªŒçš„äººå­¦ä¹ ï¼ é»„å¿ å¾·çš„åšå®¢ DevOps,SRE,Python,Golangç¨‹åºå‘˜,å¼€æºçˆ±å¥½è€… é˜¿è™šåŒå­¦çš„å‚¨ç‰©é—´ æ”¶é›†äº†å¾ˆå¤šå®ç”¨ç½‘ç«™ è€ç”Ÿæ‚è°ˆçš„ IT äºº è€ç”Ÿæ‚è°ˆï¼Œåç»§æœ‰äººã€‚ Yunyiâ€™s Blog Little squirrel Hopping around Yuinâ€™s blog The world is your oyster ğŸ‘‰å‹é“¾æ ¼å¼ åç§°: lvbibir's Blog\nç½‘å€: https://www.lvbibir.cn\nå›¾æ ‡: https://www.lvbibir.cn/https://image.lvbibir.cn/blog/avatar.webp\næè¿°: life is a fucking movie\nğŸ‘‰å‹é“¾ç”³è¯·è¦æ±‚ ç§‰æ‰¿äº’æ¢å‹é“¾åŸåˆ™ã€æ–‡ç« å®šæœŸæ›´æ–°ã€ä¸èƒ½æœ‰å¤ªå¤šå¹¿å‘Š\n","permalink":"https://www.lvbibir.cn/links/","summary":"ğŸ‘‰å‹é“¾ä¸ºéšæœºé¡ºåº cuikx\u0026#39;s blog cuikx\u0026#39;s blog Sulv\u0026#39;s Blog ä¸€ä¸ªè®°å½•æŠ€æœ¯ã€é˜…è¯»ã€ç”Ÿæ´»çš„åšå®¢ é™ˆæ¡‚æ—åšå®¢ æˆåŠŸæœ€æœ‰æ•ˆçš„æ–¹æ³•å°±æ˜¯å‘æœ‰ç»éªŒçš„äººå­¦ä¹ ï¼ é»„å¿ å¾·çš„åšå®¢ DevOps,SRE,Python,Golangç¨‹åºå‘˜,å¼€æºçˆ±å¥½è€… é˜¿è™šåŒå­¦çš„å‚¨ç‰©é—´ æ”¶é›†äº†å¾ˆå¤šå®ç”¨ç½‘ç«™ è€ç”Ÿæ‚è°ˆçš„ IT äºº è€ç”Ÿæ‚è°ˆï¼Œåç»§æœ‰äººã€‚ Yunyiâ€™s Blog Little squirrel Hopping around Yu","title":"ğŸ¤ å‹é“¾"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\nå®˜æ–¹æ–‡æ¡£ kolla-ansible éƒ¨ç½² all-in-one å•èŠ‚ç‚¹ openstack kolla-ansible æ·»åŠ æ–°èŠ‚ç‚¹ (nova å’Œ cinder æœåŠ¡) kolla ansible éƒ¨ç½² openstack é«˜å¯ç”¨é›†ç¾¤ 1 kolla ansible ç®€ä»‹ kolla çš„ä½¿å‘½æ˜¯ä¸º openstack äº‘å¹³å°æä¾›ç”Ÿäº§çº§åˆ«çš„ã€å¼€ç®±å³ç”¨çš„äº¤ä»˜èƒ½åŠ›ã€‚kolla çš„åŸºæœ¬æ€æƒ³æ˜¯ä¸€åˆ‡çš†å®¹å™¨ï¼Œå°†æ‰€æœ‰æœåŠ¡åŸºäº Docker è¿è¡Œï¼Œå¹¶ä¸”ä¿è¯ä¸€ä¸ªå®¹å™¨åªè·‘ä¸€ä¸ªæœåŠ¡ï¼ˆè¿›ç¨‹ï¼‰ï¼Œåšåˆ°æœ€å°ç²’åº¦çš„è¿è¡Œ dockerã€‚\nkolla è¦å®ç° openetack éƒ¨ç½²æ€»ä½“ä¸Šåˆ†ä¸ºä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥æ˜¯åˆ¶ä½œ docker é•œåƒï¼Œç¬¬äºŒæ­¥æ˜¯ç¼–æ’éƒ¨ç½²ã€‚å› æ­¤ï¼Œkolla é¡¹ç›®åˆè¢«åˆ†ä¸ºä¸¤ä¸ªå°é¡¹ç›®ï¼škollaã€kolla-ansible ã€‚\nkolla-ansible é¡¹ç›® kolla é¡¹ç›® dockerhub é•œåƒåœ°å€\n2 éƒ¨ç½² openstack é›†ç¾¤ 2.1 å®‰è£…ç¯å¢ƒå‡†å¤‡ å®˜æ–¹éƒ¨ç½²æ–‡æ¡£\næœ¬æ¬¡éƒ¨ç½² train ç‰ˆ all-in-one å•èŠ‚ç‚¹ï¼Œä½¿ç”¨ä¸€å° centos7.8 minimal èŠ‚ç‚¹è¿›è¡Œéƒ¨ç½²ï¼Œè¯¥èŠ‚ç‚¹åŒæ—¶ä½œä¸ºæ§åˆ¶èŠ‚ç‚¹ã€è®¡ç®—èŠ‚ç‚¹ã€ç½‘ç»œèŠ‚ç‚¹å’Œ cinder å­˜å‚¨èŠ‚ç‚¹ä½¿ç”¨ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ kolla ansible çš„éƒ¨ç½²èŠ‚ç‚¹ã€‚\nkolla å®‰è£…èŠ‚ç‚¹è¦æ±‚ï¼š\n2 network interfaces 8GB main memory 40GB disk space\nå¦‚æœæ˜¯ vmware workstation ç¯å¢ƒï¼Œå‹¾é€‰å¤„ç†å™¨é€‰é¡¹çš„è™šæ‹ŸåŒ–å¼•æ“ç›¸å…³åŠŸèƒ½ï¼Œå¦åˆ™åé¢éœ€è¦é…ç½® nova_compute_virt_type=qemu å‚æ•°ï¼Œè¿™é‡Œé€‰æ‹©å‹¾é€‰ï¼Œè·³è¿‡ä»¥ä¸‹æ­¥éª¤ã€‚\ncat /etc/kolla/globals.yml nova_compute_virt_type: \u0026#34;qemu\u0026#34; #æˆ–è€…éƒ¨ç½²å®Œæˆåæ‰‹åŠ¨è°ƒæ•´ [root@kolla ~]# cat /etc/kolla/nova-compute/nova.conf |grep virt_type #virt_type = kvm virt_type = qemu [root@kolla ~]# docker restart nova_compute kolla çš„å®‰è£…è¦æ±‚ç›®æ ‡æœºå™¨è‡³å°‘ä¸¤å—ç½‘å¡ï¼Œæœ¬æ¬¡å®‰è£…ä½¿ç”¨ 2 å—ç½‘å¡å¯¹åº”ç®¡ç†ç½‘ç»œå’Œå¤–éƒ¨ç½‘ç»œä¸¤ä¸ªç½‘ç»œå¹³é¢ï¼Œåœ¨ vmware workstation è™šæ‹Ÿæœºæ–°å¢ä¸€å—ç½‘å¡ ens34ï¼š\nens32ï¼ŒNAT æ¨¡å¼ï¼Œç®¡ç†ç½‘ç»œï¼Œæ­£å¸¸é…ç½®é™æ€ IP å³å¯ã€‚ç§Ÿæˆ·ç½‘ç»œä¸è¯¥ç½‘ç»œå¤ç”¨ï¼Œç§Ÿæˆ· vm ç½‘ç»œä¸å•ç‹¬åˆ›å»ºç½‘å¡ ens34ï¼Œæ¡¥æ¥æ¨¡å¼ï¼Œå¤–éƒ¨ç½‘ç»œï¼Œæ— éœ€é…ç½® IP åœ°å€ï¼Œè¿™ä¸ªå…¶å®æ˜¯è®© neutron çš„ br-ex ç»‘å®šä½¿ç”¨ï¼Œè™šæ‹Ÿæœºé€šè¿‡è¿™å—ç½‘å¡è®¿é—®å¤–ç½‘ã€‚\nens34 ç½‘å¡ é…ç½®å‚è€ƒ\ncat \u0026gt; /etc/sysconfig/network-scripts/ifcfg-ens34 \u0026lt;\u0026lt;EOF NAME=ens34 DEVICE=ens34 TYPE=Ethernet ONBOOT=\u0026#34;yes\u0026#34; BOOTPROTO=\u0026#34;none\u0026#34; EOF #é‡æ–°åŠ è½½ens34ç½‘å¡è®¾å¤‡ nmcli con reload \u0026amp;\u0026amp; nmcli con up ens34 å¦‚æœå¯ç”¨ cinder è¿˜éœ€è¦é¢å¤–æ·»åŠ ç£ç›˜ï¼Œè¿™é‡Œä»¥æ·»åŠ ä¸€å—/dev/sdb ç£ç›˜ä¸ºä¾‹ï¼Œåˆ›å»ºä¸ºç‰©ç†å·å¹¶åŠ å…¥å·ç»„ã€‚\npvcreate /dev/sdb vgcreate cinder-volumes /dev/sdb æ³¨æ„å·ç»„åç§°ä¸º cinder-volumesï¼Œé»˜è®¤ä¸åé¢çš„ globals.yml ä¸­å®šä¹‰ä¸€è‡´ã€‚\n[root@kolla ~]# cat /etc/kolla/globals.yml | grep cinder_volume_group #cinder_volume_group: \u0026#34;cinder-volumes\u0026#34; 2.2 éƒ¨ç½² kolla ansible é…ç½®ä¸»æœºå,kolla é¢„æ£€æŸ¥æ—¶ rabbitmq å¯èƒ½éœ€è¦èƒ½å¤Ÿè¿›è¡Œä¸»æœºåè§£æ\nhostnamectl set-hostname kolla å®‰è£…ä¾èµ–\nyum install -y python-devel libffi-devel gcc openssl-devel libselinux-python python2-pip python-pbr epel-release ansible é…ç½®é˜¿é‡Œäº‘ pip æºï¼Œå¦åˆ™ pip å®‰è£…æ—¶ä¼šå¾ˆæ…¢\nmkdir ~/.pip cat \u0026gt; ~/.pip/pip.conf \u0026lt;\u0026lt; EOF [global] trusted-host=mirrors.aliyun.com index-url=https://mirrors.aliyun.com/pypi/simple/ EOF å®‰è£… kolla-ansible\nkolla ç‰ˆæœ¬ä¸ openstack ç‰ˆæœ¬å¯¹åº”å…³ç³»\npip install setuptools==22.0.5 pip install pip==20.3.4 pip install wheel pip install kolla-ansible==9.1.0 --ignore-installed PyYAML å¤åˆ¶ kolla-ansible é…ç½®æ–‡ä»¶åˆ°å½“å‰ç¯å¢ƒ\nmkdir -p /etc/kolla chown $USER:$USER /etc/kolla cp -r /usr/share/kolla-ansible/etc_examples/kolla/* /etc/kolla cp /usr/share/kolla-ansible/ansible/inventory/* . ä¿®æ”¹ ansible é…ç½®æ–‡ä»¶\ncat \u0026lt;\u0026lt; EOF | sed -i \u0026#39;/^\\[defaults\\]$/ r /dev/stdin\u0026#39; /etc/ansible/ansible.cfg host_key_checking=False pipelining=True forks=100 EOF é»˜è®¤æœ‰ all-in-one å’Œ multinode ä¸¤ä¸ª inventory æ–‡ä»¶ï¼Œè¿™é‡Œä½¿ç”¨ all-in-oneï¼Œæ¥è§„åˆ’é›†ç¾¤è§’è‰²ï¼Œé…ç½®é»˜è®¤å³å¯\n[root@kolla ~]# cat all-in-one | more æ£€æŸ¥ inventory é…ç½®æ˜¯å¦æ­£ç¡®ï¼Œæ‰§è¡Œï¼š\nansible -i all-in-one all -m ping ç”Ÿæˆ openstack ç»„ä»¶ç”¨åˆ°çš„å¯†ç ï¼Œè¯¥æ“ä½œä¼šå¡«å……/etc/kolla/passwords.ymlï¼Œè¯¥æ–‡ä»¶ä¸­é»˜è®¤å‚æ•°ä¸ºç©ºã€‚\nkolla-genpwd ä¿®æ”¹ keystone_admin_passwordï¼Œå¯ä»¥ä¿®æ”¹ä¸ºè‡ªå®šä¹‰çš„å¯†ç æ–¹ä¾¿åç»­ horizon ç™»å½•ï¼Œè¿™é‡Œæ”¹ä¸º kollaã€‚\n$ sed -i \u0026#39;s#keystone_admin_password:.*#keystone_admin_password: kolla#g\u0026#39; /etc/kolla/passwords.yml $ cat /etc/kolla/passwords.yml | grep keystone_admin_password keystone_admin_password: kolla ä¿®æ”¹å…¨å±€é…ç½®æ–‡ä»¶ globals.ymlï¼Œè¯¥æ–‡ä»¶ç”¨æ¥æ§åˆ¶å®‰è£…å“ªäº›ç»„ä»¶ï¼Œä»¥åŠå¦‚ä½•é…ç½®ç»„ä»¶ï¼Œç”±äºå…¨éƒ¨æ˜¯æ³¨é‡Šï¼Œè¿™é‡Œç›´æ¥è¿½åŠ è¿›å»ï¼Œä¹Ÿå¯ä»¥é€ä¸ªæ‰¾åˆ°å¯¹åº”é¡¹è¿›è¡Œä¿®æ”¹ã€‚\ncp /etc/kolla/globals.yml{,.bak} cat \u0026gt;\u0026gt; /etc/kolla/globals.yml \u0026lt;\u0026lt;EOF # Kolla options kolla_base_distro: \u0026#34;centos\u0026#34; kolla_install_type: \u0026#34;binary\u0026#34; openstack_release: \u0026#34;train\u0026#34; kolla_internal_vip_address: \u0026#34;192.168.150.155\u0026#34; # Docker options # docker_registry: \u0026#34;registry.cn-beijing.aliyuncs.com\u0026#34; # docker_namespace: \u0026#34;kollaimage\u0026#34; # Neutron - Networking Options network_interface: \u0026#34;ens32\u0026#34; neutron_external_interface: \u0026#34;ens34\u0026#34; neutron_plugin_agent: \u0026#34;openvswitch\u0026#34; enable_neutron_provider_networks: \u0026#34;yes\u0026#34; # OpenStack services enable_cinder: \u0026#34;yes\u0026#34; enable_cinder_backend_lvm: \u0026#34;yes\u0026#34; EOF å‚æ•°è¯´æ˜ï¼š\nkolla_base_distro: kolla é•œåƒåŸºäºä¸åŒ linux å‘å‹ç‰ˆæ„å»ºï¼Œä¸»æœºä½¿ç”¨ centos è¿™é‡Œå¯¹åº”ä½¿ç”¨ centos ç±»å‹çš„ docker é•œåƒå³å¯ã€‚ kolla_install_type: kolla é•œåƒåŸºäº binary äºŒè¿›åˆ¶å’Œ source æºç ä¸¤ç§ç±»å‹æ„å»ºï¼Œå®é™…éƒ¨ç½²ä½¿ç”¨ binary å³å¯ã€‚ openstack_release: openstack ç‰ˆæœ¬å¯è‡ªå®šä¹‰ï¼Œä¼šä» dockerhub æ‹‰å–å¯¹åº”ç‰ˆæœ¬çš„é•œåƒ kolla_internal_vip_address: å•èŠ‚ç‚¹éƒ¨ç½² kolla ä¹Ÿä¼šå¯ç”¨ haproxy å’Œ keepalivedï¼Œæ–¹ä¾¿åç»­æ‰©å®¹ä¸ºé«˜å¯ç”¨é›†ç¾¤ï¼Œè¯¥åœ°å€æ˜¯ ens32 ç½‘å¡ç½‘ç»œä¸­çš„ä¸€ä¸ªå¯ç”¨ IPã€‚ docker_registry: é»˜è®¤ä» dockerhub æ‹‰å–é•œåƒï¼Œä¹Ÿå¯ä»¥æœ¬åœ°æ­å»ºä»“åº“ï¼Œæå‰æ¨é€é•œåƒä¸Šå»ã€‚ docker_namespace: é˜¿é‡Œäº‘ kolla é•œåƒä»“åº“æ‰€åœ¨çš„å‘½åç©ºé—´ï¼Œdockerhub å®˜ç½‘é»˜è®¤æ˜¯ kollaã€‚ network_interface: ç®¡ç†ç½‘ç»œçš„ç½‘å¡ neutron_external_interface: å¤–éƒ¨ç½‘ç»œçš„ç½‘å¡ neutron_plugin_agent: é»˜è®¤å¯ç”¨ openvswitch enable_neutron_provider_networks: å¯ç”¨å¤–éƒ¨ç½‘ç»œ enable_cinder: å¯ç”¨ cinder enable_cinder_backend_lvm: æŒ‡å®š cinder åç«¯å­˜å‚¨ä¸º lvm 2.3 éƒ¨ç½² openstack ç»„ä»¶ éƒ¨ç½² openstack\n# é¢„é…ç½®ï¼Œå®‰è£…dockerã€docker sdkã€å…³é—­é˜²ç«å¢™ã€é…ç½®æ—¶é—´åŒæ­¥ç­‰ kolla-ansible -i ./all-in-one bootstrap-servers # éƒ¨ç½²å‰ç¯å¢ƒæ£€æŸ¥ï¼Œå¯èƒ½ä¼šæŠ¥dockerç‰ˆæœ¬çš„é”™ï¼Œå¯ä»¥å¿½ç•¥ kolla-ansible -i ./all-in-one prechecks # æ‹‰å–é•œåƒï¼Œä¹Ÿå¯çœç•¥è¯¥æ­¥éª¤ï¼Œé»˜è®¤ä¼šè‡ªåŠ¨æ‹‰å– kolla-ansible -i ./all-in-one pull # æ‰§è¡Œå®é™…éƒ¨ç½²ï¼Œæ‹‰å–é•œåƒï¼Œè¿è¡Œå¯¹åº”ç»„ä»¶å®¹å™¨ kolla-ansible -i ./all-in-one deploy # ç”Ÿæˆopenrcæ–‡ä»¶ kolla-ansible post-deploy ä»¥ä¸Šéƒ¨ç½²æ²¡æœ‰æŠ¥é”™ä¸­æ–­è¯´æ˜éƒ¨ç½²æˆåŠŸï¼Œæ‰€æœ‰ openstack ç»„ä»¶ä»¥å®¹å™¨æ–¹å¼è¿è¡Œï¼ŒæŸ¥çœ‹å®¹å™¨\n[root@kolla ~]# docker ps -a ç¡®è®¤æ²¡æœ‰ Exited ç­‰å¼‚å¸¸çŠ¶æ€çš„å®¹å™¨\n[root@kolla ~]# docker ps -a | grep -v Up æœ¬æ¬¡éƒ¨ç½²è¿è¡Œäº† 38 ä¸ªå®¹å™¨\n[root@localhost kolla-env]# docker ps -a | wc -l 39 æŸ¥çœ‹æ‹‰å–çš„é•œåƒ\n[root@kolla ~]# docker images | wc -l 39 [root@kolla ~]# docker images REPOSITORY TAG IMAGE ID CREATED SIZE kolla/centos-binary-heat-api train b97df3444b35 10 months ago 1.11GB kolla/centos-binary-heat-engine train e19de6feec32 10 months ago 1.11GB ...... æŸ¥çœ‹ cinder ä½¿ç”¨çš„å·ï¼Œè‡ªåŠ¨åˆ›å»ºäº† lvm\n[root@kolla ~]# lsblk | grep cinder â”œâ”€cinder--volumes-cinder--volumes--pool_tmeta 253:3 0 20M 0 lvm â”‚ â””â”€cinder--volumes-cinder--volumes--pool 253:5 0 19G 0 lvm â””â”€cinder--volumes-cinder--volumes--pool_tdata 253:4 0 19G 0 lvm â””â”€cinder--volumes-cinder--volumes--pool 253:5 0 19G 0 lvm [root@kolla ~]# lvs | grep cinder cinder-volumes-pool cinder-volumes twi-a-tz-- 19.00g 0.00 10.55 å¦å¤–éœ€è¦æ³¨æ„ï¼Œä¸è¦åœ¨è¯¥èŠ‚ç‚¹å®‰è£… libvirt ç­‰å·¥å…·ï¼Œè¿™äº›å·¥å…·å®‰è£…åå¯èƒ½ä¼šå¯ç”¨ libvirtd å’Œ iscsid.sock ç­‰æœåŠ¡ï¼Œkolla å·²ç»åœ¨å®¹å™¨ä¸­è¿è¡Œäº†è¿™äº›æœåŠ¡ï¼Œè¿™äº›æœåŠ¡ä¼šè°ƒç”¨èŠ‚ç‚¹ä¸Šçš„ sock æ–‡ä»¶ï¼Œå¦‚æœèŠ‚ç‚¹ä¸Šä¹Ÿå¯ç”¨è¿™äº›æœåŠ¡å»æŠ¢å è¿™äº›æ–‡ä»¶ï¼Œä¼šå¯¼è‡´å®¹å™¨å¼‚å¸¸ã€‚é»˜è®¤ kolla åœ¨é¢„é…ç½®æ—¶ä¹Ÿä¼šä¸»åŠ¨ç¦ç”¨èŠ‚ç‚¹ä¸Šçš„ç›¸å…³æœåŠ¡ã€‚\n2.4 å®‰è£… openStack å®¢æˆ·ç«¯ å¯ä»¥ç›´æ¥å®‰è£…åˆ°æœåŠ¡å™¨ä¸Šæˆ–è€…ä½¿ç”¨ docker å®‰è£…å®¹å™¨\næ¨èä½¿ç”¨ docker å®¹å™¨æ–¹å¼è¿è¡Œå®¢æˆ·ç«¯\nä½¿ç”¨ docker å®¹å™¨ä½œä¸ºå®¢æˆ·ç«¯\ndocker run -d --name client \\ --restart always \\ -v /etc/kolla/admin-openrc.sh:/admin-openrc.sh:ro \\ -v /usr/share/kolla-ansible/init-runonce:/init-runonce:rw \\ kolla/centos-binary-openstack-base:train sleep infinity docker exec -it client bash source /admin-openrc.sh openstack service list yum å®‰è£… openstack å®¢æˆ·ç«¯\n#å¯ç”¨openstackå­˜å‚¨åº“ yum install -y centos-release-openstack-train #å®‰è£…openstackå®¢æˆ·ç«¯ yum install -y python-openstackclient #å¯ç”¨selinux,å®‰è£…openstack-selinuxè½¯ä»¶åŒ…ä»¥è‡ªåŠ¨ç®¡ç†OpenStackæœåŠ¡çš„å®‰å…¨ç­–ç•¥ yum install -y openstack-selinux #æŠ¥é”™å¤„ç† pip uninstall urllib3 yum install -y python2-urllib3 2.5 è¿è¡Œ cirros å®ä¾‹ kolla ansible æä¾›äº†ä¸€ä¸ªå¿«é€Ÿåˆ›å»º cirros demo å®ä¾‹çš„è„šæœ¬/usr/share/kolla-ansible/init-runonceã€‚\nè„šæœ¬éœ€è¦ cirros é•œåƒï¼Œå¦‚æœç½‘ç»œè¾ƒæ…¢å¯ä»¥ä½¿ç”¨æµè§ˆå™¨ä¸‹è½½æ”¾åœ¨/opt/cache/files ç›®å½•ä¸‹ï¼š\nwget https://github.com/cirros-dev/cirros/releases/download/0.4.0/cirros-0.4.0-x86_64-disk.img mkdir -p /opt/cache/files/ mv cirros-0.4.0-x86_64-disk.img /opt/cache/files/ å®šä¹‰ init-runonce ç¤ºä¾‹è„šæœ¬å¤–éƒ¨ç½‘ç»œé…ç½®ï¼š\n#å®šä¹‰init-runonceç¤ºä¾‹è„šæœ¬å¤–éƒ¨ç½‘ç»œé…ç½® vim /usr/share/kolla-ansible/init-runonce EXT_NET_CIDR=${EXT_NET_CIDR:-\u0026#39;192.168.35/24\u0026#39;} EXT_NET_RANGE=${EXT_NET_RANGE:-\u0026#39;start=192.168.35.150,end=192.168.35.188\u0026#39;} EXT_NET_GATEWAY=${EXT_NET_GATEWAY:-\u0026#39;192.168.35.1\u0026#39;} #æ‰§è¡Œè„šæœ¬ï¼Œä¸Šä¼ é•œåƒåˆ°glanceï¼Œåˆ›å»ºå†…éƒ¨ç½‘ç»œã€å¤–éƒ¨ç½‘ç»œã€flavorã€ssh keyï¼Œå¹¶è¿è¡Œä¸€ä¸ªå®ä¾‹ source /etc/kolla/admin-openrc.sh /usr/share/kolla-ansible/init-runonce å‚æ•°è¯´æ˜ï¼š\nEXT_NET_CIDR æŒ‡å®šå¤–éƒ¨ç½‘ç»œï¼Œç”±äºä½¿ç”¨æ¡¥æ¥æ¨¡å¼ï¼Œç›´æ¥æ¡¥æ¥åˆ°äº†ç”µè„‘çš„æ— çº¿ç½‘å¡ï¼Œæ‰€ä»¥è¿™é‡Œç½‘ç»œå°±æ˜¯æ— çº¿ç½‘å¡çš„ç½‘æ®µã€‚ EXT_NET_RANGE æŒ‡å®šä»å¤–éƒ¨ç½‘ç»œå–å‡ºä¸€ä¸ªåœ°å€èŒƒå›´ï¼Œä½œä¸ºå¤–éƒ¨ç½‘ç»œçš„åœ°å€æ±  EXT_NET_GATEWAY å¤–éƒ¨ç½‘ç»œç½‘å…³ï¼Œè¿™é‡Œä¸ wifi ç½‘ç»œä½¿ç”¨çš„ç½‘å…³ä¸€è‡´\næ ¹æ®æœ€ç»ˆæç¤ºè¿è¡Œå®ä¾‹\nopenstack server create \\ --image cirros \\ --flavor m1.tiny \\ --key-name mykey \\ --network demo-net \\ demo1 2.6 è®¿é—® openstack horizon è®¿é—® openstack horizon éœ€è¦ä½¿ç”¨ vip åœ°å€ï¼ŒèŠ‚ç‚¹ä¸Šå¯ä»¥çœ‹åˆ°ç”± keepalived å®¹å™¨ç”Ÿæˆçš„ vip\n[root@kolla ~]# ip a |grep ens32 2: ens32: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 inet 192.168.150.101/24 brd 192.168.150.255 scope global noprefixroute dynamic ens32 inet 192.168.150.155/32 scope global ens32 æµè§ˆå™¨ç›´æ¥è®¿é—®è¯¥åœ°å€å³å¯ç™»å½•åˆ° horizon\nhttp://192.168.150.155\næˆ‘è¿™é‡Œçš„ç”¨æˆ·åå¯†ç ä¸º admin/kollaï¼Œä¿¡æ¯å¯ä»¥ä» admin-openrc.sh ä¸­è·å–\n[root@kolla ~]# cat /etc/kolla/admin-openrc.sh # Clear any old environment that may conflict. for key in $( set | awk \u0026#39;{FS=\u0026#34;=\u0026#34;} /^OS_/ {print $1}\u0026#39; ); do unset $key ; done export OS_PROJECT_DOMAIN_NAME=Default export OS_USER_DOMAIN_NAME=Default export OS_PROJECT_NAME=admin export OS_TENANT_NAME=admin export OS_USERNAME=admin export OS_PASSWORD=kolla export OS_AUTH_URL=http://192.168.150.155:35357/v3 export OS_INTERFACE=internal export OS_ENDPOINT_TYPE=internalURL export OS_IDENTITY_API_VERSION=3 export OS_REGION_NAME=RegionOne export OS_AUTH_PLUGIN=password é»˜è®¤ç™»å½•åå¦‚ä¸‹\nåœ¨ horizion æŸ¥çœ‹åˆ›å»ºçš„ç½‘ç»œå’Œå®ä¾‹\nç™»å½•å®ä¾‹æ§åˆ¶å°ï¼ŒéªŒè¯å®ä¾‹ä¸å¤–ç½‘çš„è¿é€šæ€§ï¼Œcirros ç”¨æˆ·å¯†ç åœ¨åˆæ¬¡ç™»å½•æ—¶æœ‰æç¤ºï¼š\nä¸ºå®ä¾‹ç»‘å®šæµ®åŠ¨ IP åœ°å€ï¼Œæ–¹ä¾¿ä»å¤–éƒ¨ ssh è¿œç¨‹è¿æ¥åˆ°å®ä¾‹\nç‚¹å‡» + éšæœºåˆ†é…ä¸€ä¸ªæµ®åŠ¨ IP\nåœ¨å®ä¾‹ç•Œé¢å¯ä»¥çœ‹åˆ°ç»‘å®šçš„æµ®åŠ¨ ip\nåœ¨ kolla èŠ‚ç‚¹ä¸Šæˆ–è€…åœ¨é›†ç¾¤å¤–éƒ¨ä½¿ç”¨ SecureCRT ç­‰ ssh å·¥å…·è¿æ¥åˆ°å®ä¾‹ã€‚cirros é•œåƒé»˜è®¤ç”¨æˆ·å¯†ç ä¸º cirros/gocubsgoï¼Œè¯¥é•œåƒä¿¡æ¯å®˜ç½‘æœ‰ ä»‹ç»\n[root@kolla ~]# ssh cirros@192.168.35.183 cirros@192.168.35.183\u0026#39;s password: 2.7 è¿è¡Œ centos å®ä¾‹ centos å®˜æ–¹ç»´æŠ¤æœ‰ç›¸å…³ cloud imageï¼Œå¦‚æœä¸éœ€è¦è¿›è¡Œå®šåˆ¶ï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½æ¥è¿è¡Œå®ä¾‹ å‚è€ƒ\nCentOS å®˜æ–¹ç»´æŠ¤çš„é•œåƒ ä¸‹è½½åœ°å€\nä¹Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤ç›´æ¥ä¸‹è½½é•œåƒï¼Œä½†æ˜¯ä¸‹è½½å¯èƒ½è¾ƒæ…¢ï¼Œå»ºè®®ä¸‹è½½å¥½åœ¨è¿›è¡Œä¸Šä¼ ã€‚ä»¥ centos7.8 ä¸ºä¾‹ï¼š\nwget http://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud-2003.qcow2c ä¸‹è½½å®Œæˆåä¸Šä¼ é•œåƒåˆ° openstackï¼Œç›´æ¥åœ¨ horizon ä¸Šä¼ å³å¯ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤ä¸Šä¼ ã€‚\næ³¨æ„ï¼šé»˜è®¤è¯¥é•œåƒè¿è¡Œçš„å®ä¾‹åªèƒ½ä½¿ç”¨ ssh key ä»¥ centos ç”¨æˆ·èº«ä»½ç™»å½•ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨ root è¿œç¨‹ ssh è¿æ¥åˆ°å®ä¾‹éœ€è¦åœ¨ä¸Šä¼ å‰ä¸ºé•œåƒé…ç½® root å…å¯†å¹¶å¼€å¯ ssh è®¿é—®, å‚è€ƒ\nå¦å¤–æˆ‘ä»¬çš„å‘½ä»¤å®¢æˆ·ç«¯åœ¨å®¹å™¨ä¸­ï¼Œæ‰€æœ‰è¿™é‡Œæœ‰äº›ä¸æ–¹ä¾¿ï¼Œé¦–å…ˆè¦å°†é•œåƒå¤åˆ¶åˆ°å®¹å™¨ä¸­ï¼Œç„¶åä½¿ç”¨ openstack å‘½ä»¤ä¸Šä¼ ã€‚\nè¿™é‡Œå¤åˆ¶åˆ° client å®¹å™¨çš„æ ¹ç›®å½•ä¸‹ã€‚\n[root@kolla ~]# docker cp CentOS-7-x86_64-GenericCloud-2003.qcow2c client:/ [root@kolla ~]# docker exec -it client bash ()[root@f11a103c5ade /]# ()[root@f11a103c5ade /]# source /admin-openrc.sh ()[root@f11a103c5ade /]# ls | grep CentOS CentOS-7-x86_64-GenericCloud-2003.qcow2c æ‰§è¡Œä»¥ä¸‹ openstack å‘½ä»¤ä¸Šä¼ é•œåƒ\nopenstack image create \u0026#34;CentOS78-image\u0026#34; \\ --file CentOS-7-x86_64-GenericCloud-2003.qcow2c \\ --disk-format qcow2 --container-format bare \\ --public åˆ›å»ºå®ä¾‹\nopenstack server create \\ --image CentOS78-image \\ --flavor m1.small \\ --key-name mykey \\ --network demo-net \\ demo-centos åˆ›å»ºå®Œæˆåä¸ºå®ä¾‹ç»‘å®šæµ®åŠ¨ IPã€‚\nå¦‚æœå®ä¾‹åˆ›å»ºå¤±è´¥å¯ä»¥æŸ¥çœ‹ç›¸å…³ç»„ä»¶æŠ¥é”™æ—¥å¿—\n[root@kolla ~]# tail -100f /var/log/kolla/nova/nova-compute.log å¦‚æœæ²¡æœ‰æå‰å®šåˆ¶é•œåƒä¿®æ”¹ root å¯†ç ï¼Œåªèƒ½ä½¿ç”¨ centos ç”¨æˆ·åŠ sshkey ç™»å½•ï¼Œç”±äºæ˜¯åœ¨å®¹å™¨ä¸­è¿è¡Œçš„ demo ç¤ºä¾‹ï¼Œssh ç§é’¥ä¹Ÿä¿å­˜åœ¨å®¹å™¨çš„é»˜è®¤ç›®å½•ä¸‹ï¼Œåœ¨å®¹å™¨ä¸­è¿æ¥å®ä¾‹æµ®åŠ¨ IP æµ‹è¯•\n[root@kolla ~]# docker exec -it client bash ()[root@b86f87f7f101 ~]# ssh -i /root/.ssh/id_rsa centos@192.168.35.186 Last login: Fri Oct 29 08:10:42 2021 from 192.168.35.188 [centos@demo-centos ~]$ sudo -i [root@demo-centos ~]# 2.8 è¿è¡Œ ubuntu å®ä¾‹ ä¸‹è½½é•œåƒ\nwget https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img docker cp bionic-server-cloudimg-amd64.img client:/ ä¸Šä¼ é•œåƒ\nopenstack image create \u0026#34;Ubuntu1804\u0026#34; \\ --file bionic-server-cloudimg-amd64.img \\ --disk-format qcow2 --container-format bare \\ --public åˆ›å»ºå®ä¾‹\nopenstack server create \\ --image Ubuntu1804 \\ --flavor m1.small \\ --key-name mykey \\ --network demo-net \\ demo-ubuntu ç»‘å®šæµ®åŠ¨ ip\nubuntu é•œåƒé»˜è®¤ç”¨æˆ·ä¸º ubuntuï¼Œé¦–æ¬¡ç™»é™†ä½¿ç”¨ sshkey æ–¹å¼\n3 è°ƒæ•´é›†ç¾¤é…ç½® 3.1 æ–°å¢ magnum \u0026amp; ironic ç»„ä»¶ magnum å’Œ ironic é»˜è®¤çŠ¶æ€ä¸‹æ˜¯æ²¡æœ‰å®‰è£…çš„ï¼Œåœ¨ /etc/kolla/globals.yml å¯ä»¥çœ‹åˆ°é»˜è®¤é…ç½®\n#enable_magnum: \u0026#34;no\u0026#34; #enable_ironic: \u0026#34;no\u0026#34; åœ¨ /etc/kolla/globals.yml ä¹‹å‰çš„é…ç½®ä¸‹é¢æ–°å¢å¦‚ä¸‹ï¼Œå‚æ•°çš„å…·ä½“å«ä¹‰æŸ¥çœ‹ å®˜æ–¹æ–‡æ¡£\n# ironic enable_ironic: true ironic_dnsmasq_interface: \u0026#34;enp11s0f1\u0026#34; ironic_dnsmasq_dhcp_range: \u0026#34;192.168.45.200,192.168.45.210\u0026#34; ironic_dnsmasq_default_gateway: 192.168.45.1 ironic_cleaning_network: \u0026#34;public1\u0026#34; ironic_dnsmasq_boot_file: pxelinux.0 # magnum enable_magnum: true ironic ç»„ä»¶è¿˜éœ€è¦ä¸€äº›å…¶ä»–æ“ä½œ\nmkdir -p /etc/kolla/config/ironic/ curl https://tarballs.openstack.org/ironic-python-agent/dib/files/ipa-centos7-master.kernel -o /etc/kolla/config/ironic/ironic-agent.kernel curl https://tarballs.openstack.org/ironic-python-agent/dib/files/ipa-centos7-master.initramfs -o /etc/kolla/config/ironic/ironic-agent.initramfs åœ¨ç°æœ‰é›†ç¾¤ä¸­æ–°å¢ç»„ä»¶\nkolla-ansible -i all-in-one deploy --tags horizon,magnum,ironic 3.2 ä¿®æ”¹ç»„ä»¶é…ç½® é›†ç¾¤éƒ¨ç½²å®Œæˆåéœ€è¦å¼€å¯æ–°çš„ç»„ä»¶æˆ–è€…æ‰©å®¹ï¼Œå¯ä»¥ä¿®æ”¹/etc/kolla/global.yml è°ƒæ•´å‚æ•°ã€‚\næˆ–è€…åœ¨/etc/kolla/config ç›®å½•ä¸‹åˆ›å»ºè‡ªå®šä¹‰é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚\n# mkdir -p /etc/kolla/config/nova # vim /etc/kolla/config/nova/nova.conf [DEFAULT] block_device_allocate_retries = 300 block_device_allocate_retries_interval = 3 é‡æ–°é…ç½® openstackï¼Œkolla ä¼šè‡ªåŠ¨é‡å»ºé…ç½®å˜åŠ¨çš„å®¹å™¨ç»„ä»¶ã€‚\nkolla-ansible -i all-in-one reconfigure -t nova 3.3 kolla é…ç½®å’Œæ—¥å¿—æ–‡ä»¶ å„ä¸ªç»„ä»¶é…ç½®æ–‡ä»¶ç›®å½•ï¼š /etc/kolla/ å„ä¸ªç»„ä»¶æ—¥å¿—æ–‡ä»¶ç›®å½•ï¼š/var/log/kolla/ 3.4 æ¸…ç† kolla ansilbe é›†ç¾¤ kolla-ansible destroy --include-images --yes-i-really-really-mean-it # æˆ–è€… [root@kolla ~]# cd /usr/share/kolla-ansible/tools/ [root@all tools]# ./cleanup-containers [root@all tools]# ./cleanup-host #é‡ç½®cinderå·ï¼Œè°¨æ…æ“ä½œ vgremove cinder-volumes 3.5 é‡æ–°éƒ¨ç½² kolla ansible é›†ç¾¤ ## æ¸…é™¤æ“ä½œ å…ˆå…³é—­æ‰€æœ‰è¿è¡Œçš„å®ä¾‹ï¼Œå†è¿›è¡Œä¸‹é¢æ“ä½œ [root@kolla ~]# cd /usr/share/kolla-ansible/tools/ [root@all tools]# ./cleanup-containers vgremove cinder-volumes ## é‡å»ºæ“ä½œ pvcreate /dev/sdb vgcreate cinder-volumes /dev/sdb kolla-ansible -i ./all-in-one deploy kolla-ansible post-deploy 4 å¯èƒ½é‡åˆ°çš„é—®é¢˜ 4.1 è™šæ‹Ÿ ip åˆ†é…å¤±è´¥ è¿™ç§æƒ…å†µå¤šåŠæ˜¯ç”±äºè™šæ‹Ÿ ip æ²¡æœ‰åˆ†é…åˆ°ï¼Œå¹¶ä¸æ˜¯ç«¯å£é—®é¢˜\nè§£å†³æ–¹æ³• 1 åœ¨å…¨å±€çš„é…ç½®ä¸­æ·»åŠ /ä¿®æ”¹è¿™ä¸ª id å€¼ï¼Œå¿…é¡»æ˜¯ 0-255 ä¹‹é—´çš„æ•°å­—ï¼Œå¹¶ä¸”ç¡®ä¿åœ¨æ•´ä¸ªäºŒå±‚ç½‘ç»œä¸­æ˜¯å”¯ä¸€çš„\nvim /etc/kolla/globals.yml keepalived_virtual_router_id: \u0026#34;199\u0026#34; è§£å†³æ–¹æ³• 2 ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/openstack-kolla-ansible-allinone-train/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: å®˜æ–¹æ–‡æ¡£ kolla-ansible éƒ¨ç½² all-in-one å•èŠ‚ç‚¹ openstack kolla-ansible æ·»åŠ æ–°èŠ‚ç‚¹ (nova å’Œ cinder æœåŠ¡) kolla ansible éƒ¨ç½² openstack é«˜å¯ç”¨é›†ç¾¤ 1 kolla ansible ç®€ä»‹ kolla çš„ä½¿å‘½æ˜¯ä¸º openstack äº‘å¹³å°æä¾›ç”Ÿäº§çº§åˆ«çš„ã€å¼€ç®±å³ç”¨çš„äº¤ä»˜èƒ½åŠ›ã€‚kolla çš„åŸºæœ¬æ€æƒ³æ˜¯ä¸€åˆ‡çš†å®¹å™¨ï¼Œå°†æ‰€æœ‰æœåŠ¡åŸºäº Docker è¿è¡Œï¼Œå¹¶ä¸”ä¿è¯ä¸€ä¸ªå®¹å™¨åªè·‘ä¸€ä¸ªæœåŠ¡ï¼ˆè¿›ç¨‹ï¼‰ï¼Œåšåˆ°æœ€å°ç²’åº¦çš„è¿è¡Œ docke","title":"kolla-ansible éƒ¨ç½² openstack (Train) (all-in-one)"},{"content":"1 Kubernetes æ¦‚è¿° kubernetes æ˜¯ä»€ä¹ˆ\nkubernetes æ˜¯ Google åœ¨ 2014 å¹´å¼€æºçš„ä¸€ä¸ªå®¹å™¨é›†ç¾¤ç®¡ç†å¹³å°ï¼Œkubernetes ç®€ç§° k8s k8s ç”¨äºå®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ï¼Œæ‰©å±•å’Œç®¡ç†ã€‚ k8s æä¾›äº†å®¹å™¨çš„ç¼–æ’ï¼Œèµ„æºè°ƒåº¦ï¼Œå¼¹æ€§ä¼¸ç¼©ï¼Œéƒ¨ç½²ç®¡ç†ï¼ŒæœåŠ¡å‘ç°ç­‰ä¸€ç³»åˆ—åŠŸèƒ½ kubernetes ç›®æ ‡æ˜¯è®©éƒ¨ç½²å®¹å™¨åŒ–åº”ç”¨ç®€å•é«˜æ•ˆ Kubernetes ç‰¹æ€§\nè‡ªæˆ‘ä¿®å¤ åœ¨èŠ‚ç‚¹æ•…éšœæ—¶é‡æ–°å¯åŠ¨å¤±è´¥çš„å®¹å™¨ï¼Œæ›¿æ¢å’Œé‡æ–°éƒ¨ç½²ï¼Œä¿è¯é¢„æœŸçš„å‰¯æœ¬æ•°é‡ï¼›æ€æ­»å¥åº·æ£€æŸ¥å¤±è´¥çš„å®¹å™¨ï¼Œå¹¶ä¸”åœ¨æœªå‡†å¤‡å¥½ä¹‹å‰ä¸ä¼šå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œç¡®ä¿çº¿ä¸ŠæœåŠ¡ä¸ä¸­æ–­ã€‚ ä¼¸ç¼©æ€§ ä½¿ç”¨å‘½ä»¤ã€UI æˆ–è€…åŸºäº CPU ä½¿ç”¨æƒ…å†µè‡ªåŠ¨å¿«é€Ÿæ‰©å®¹å’Œç¼©å®¹åº”ç”¨ç¨‹åºå®ä¾‹ï¼Œä¿è¯åº”ç”¨ä¸šåŠ¡é«˜å³°å¹¶å‘æ—¶çš„é«˜å¯ç”¨æ€§ï¼›ä¸šåŠ¡ä½å³°æ—¶å›æ”¶èµ„æºï¼Œä»¥æœ€å°æˆæœ¬è¿è¡ŒæœåŠ¡ã€‚ è‡ªåŠ¨éƒ¨ç½²å’Œå›æ»š K8S é‡‡ç”¨æ»šåŠ¨æ›´æ–°ç­–ç•¥æ›´æ–°åº”ç”¨ï¼Œä¸€æ¬¡æ›´æ–°ä¸€ä¸ª Podï¼Œè€Œä¸æ˜¯åŒæ—¶åˆ é™¤æ‰€æœ‰ Podï¼Œå¦‚æœæ›´æ–°è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œå°†å›æ»šæ›´æ”¹ï¼Œç¡®ä¿å‡çº§ä¸å—å½±å“ä¸šåŠ¡ã€‚ æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ K8S ä¸ºå¤šä¸ªå®¹å™¨æä¾›ä¸€ä¸ªç»Ÿä¸€è®¿é—®å…¥å£ï¼ˆå†…éƒ¨ IP åœ°å€å’Œä¸€ä¸ª DNS åç§°ï¼‰ï¼Œå¹¶ä¸”è´Ÿè½½å‡è¡¡å…³è”çš„æ‰€æœ‰å®¹å™¨ï¼Œä½¿å¾—ç”¨æˆ·æ— éœ€è€ƒè™‘å®¹å™¨ IP é—®é¢˜ã€‚ æœºå¯†å’Œé…ç½®ç®¡ç† ç®¡ç†æœºå¯†æ•°æ®å’Œåº”ç”¨ç¨‹åºé…ç½®ï¼Œè€Œä¸éœ€è¦æŠŠæ•æ„Ÿæ•°æ®æš´éœ²åœ¨é•œåƒé‡Œï¼Œæé«˜æ•æ„Ÿæ•°æ®å®‰å…¨æ€§ã€‚å¹¶å¯ä»¥å°†ä¸€äº›å¸¸ç”¨çš„é…ç½®å­˜å‚¨åœ¨ K8S ä¸­ï¼Œæ–¹ä¾¿åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚ å­˜å‚¨ç¼–æ’ æŒ‚è½½å¤–éƒ¨å­˜å‚¨ç³»ç»Ÿï¼Œæ— è®ºæ˜¯æ¥è‡ªæœ¬åœ°å­˜å‚¨ï¼Œå…¬æœ‰äº‘ï¼ˆå¦‚ AWSï¼‰ï¼Œè¿˜æ˜¯ç½‘ç»œå­˜å‚¨ï¼ˆå¦‚ NFSã€GlusterFSã€Cephï¼‰éƒ½ä½œä¸ºé›†ç¾¤èµ„æºçš„ä¸€éƒ¨åˆ†ä½¿ç”¨ï¼Œæå¤§æé«˜å­˜å‚¨ä½¿ç”¨çµæ´»æ€§ã€‚ æ‰¹å¤„ç† æä¾›ä¸€æ¬¡æ€§ä»»åŠ¡ï¼Œå®šæ—¶ä»»åŠ¡ï¼›æ»¡è¶³æ‰¹é‡æ•°æ®å¤„ç†å’Œåˆ†æçš„åœºæ™¯ã€‚ Kubeadm æ¦‚è¿°\nkubeadm æ˜¯ Kubernetes é¡¹ç›®è‡ªå¸¦çš„åŠé›†ç¾¤æ„å»ºå·¥å…·ï¼Œè´Ÿè´£æ‰§è¡Œæ„å»ºä¸€ä¸ªæœ€å°åŒ–çš„å¯ç”¨é›†ç¾¤ä»¥åŠå°†å…¶å¯åŠ¨ç­‰çš„å¿…è¦åŸºæœ¬æ­¥éª¤ï¼Œkubeadm æ˜¯ Kubernetes é›†ç¾¤å…¨ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†å·¥å…·ï¼Œå¯ç”¨äºå®ç°é›†ç¾¤çš„éƒ¨ç½²ã€å‡çº§ã€é™çº§åŠæ‹†é™¤ã€‚kubeadm éƒ¨ç½² Kubernetes é›†ç¾¤æ˜¯å°†å¤§éƒ¨åˆ†èµ„æºä»¥ pod çš„æ–¹å¼è¿è¡Œï¼Œä¾‹å¦‚ï¼ˆkube-proxyã€kube-controller-managerã€kube-schedulerã€kube-apiserverã€flannel) éƒ½æ˜¯ä»¥ pod æ–¹å¼è¿è¡Œã€‚ Kubeadm ä»…å…³å¿ƒå¦‚ä½•åˆå§‹åŒ–å¹¶å¯åŠ¨é›†ç¾¤ï¼Œä½™ä¸‹çš„å…¶ä»–æ“ä½œï¼Œä¾‹å¦‚å®‰è£… Kubernetes Dashboardã€ç›‘æ§ç³»ç»Ÿã€æ—¥å¿—ç³»ç»Ÿç­‰å¿…è¦çš„é™„åŠ ç»„ä»¶åˆ™ä¸åœ¨å…¶è€ƒè™‘èŒƒå›´ä¹‹å†…ï¼Œéœ€è¦ç®¡ç†å‘˜è‡ªè¡Œéƒ¨ç½²ã€‚ Kubeadm é›†æˆäº† Kubeadm init å’Œ kubeadm join ç­‰å·¥å…·ç¨‹åºï¼Œå…¶ä¸­ kubeadm init ç”¨äºé›†ç¾¤çš„å¿«é€Ÿåˆå§‹åŒ–ï¼Œå…¶æ ¸å¿ƒåŠŸèƒ½æ˜¯éƒ¨ç½² Master èŠ‚ç‚¹çš„å„ä¸ªç»„ä»¶ï¼Œè€Œ kubeadm join åˆ™ç”¨äºå°†èŠ‚ç‚¹å¿«é€ŸåŠ å…¥åˆ°æŒ‡å®šé›†ç¾¤ä¸­ï¼Œå®ƒä»¬æ˜¯åˆ›å»º Kubernetes é›†ç¾¤æœ€ä½³å®è·µçš„â€œå¿«é€Ÿè·¯å¾„â€ã€‚å¦å¤–ï¼Œkubeadm token å¯äºé›†ç¾¤æ„å»ºåç®¡ç†ç”¨äºåŠ å…¥é›†ç¾¤æ—¶ä½¿ç”¨çš„è®¤è¯ä»¤ç‰Œï¼ˆtoken)ï¼Œè€Œ kubeadm reset å‘½ä»¤çš„åŠŸèƒ½åˆ™æ˜¯åˆ é™¤é›†ç¾¤æ„å»ºè¿‡ç¨‹ä¸­ç”Ÿæˆçš„æ–‡ä»¶ä»¥é‡ç½®å›åˆå§‹çŠ¶æ€ã€‚ 2 ç¯å¢ƒå‡†å¤‡ åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0\néƒ¨ç½² Kubernetes é›†ç¾¤éœ€è¦æ»¡è¶³æ¯ä¸ªèŠ‚ç‚¹è‡³å°‘æ»¡è¶³ 2 æ ¸ CPUã€2G å†…å­˜å’Œ 30GB ç¡¬ç›˜ä¸”éƒ½å¯ä»¥è®¿é—®å¤–ç½‘\nè§’è‰² IP k8s-node1 1.1.1.1 k8s-node2 1.1.1.2 k8s-node3 1.1.1.3 2.1 åŸºç¡€é…ç½® # å…³é—­é˜²ç«å¢™ systemctl stop firewalld systemctl disable firewalld # å…³é—­selinux sed -i \u0026#39;s/enforcing/disabled/\u0026#39; /etc/selinux/config # æ°¸ä¹… setenforce 0 # ä¸´æ—¶ # å…³é—­swap swapoff -a # ä¸´æ—¶ vim /etc/fstab # æ°¸ä¹…, æ³¨é‡Šæ‰swapåˆ†åŒºç›¸å…³è¡Œ # è®¾ç½®ä¸»æœºå hostnamectl set-hostname \u0026lt;hostname\u0026gt; # æ·»åŠ hosts cat \u0026gt;\u0026gt; /etc/hosts \u0026lt;\u0026lt; EOF 1.1.1.1 k8s-node1 1.1.1.2 k8s-node2 1.1.1.3 k8s-node3 EOF # å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾ cat \u0026gt; /etc/sysctl.d/k8s.conf \u0026lt;\u0026lt; EOF net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 EOF sysctl --system # ç”Ÿæ•ˆ # æ—¶é—´åŒæ­¥ timedatectl set-timezone Asia/Shanghai yum install ntpdate -y ntpdate time.windows.com 2.2 å®‰è£… Docker Kubernetes é»˜è®¤ CRIï¼ˆå®¹å™¨è¿è¡Œæ—¶ï¼‰ä¸º Dockerï¼Œå› æ­¤å…ˆå®‰è£… Dockerã€‚\nwget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo yum list docker-ce --show-duplicates yum install docker-ce-20.10.23-3.el7.x86_64 é…ç½®é•œåƒä¸‹è½½åŠ é€Ÿå™¨ï¼ŒåŒæ—¶ä¿®æ”¹ docker çš„ cgroupdriver ä¸º systemd\nmkdir /etc/docker cat \u0026gt; /etc/docker/daemon.json \u0026lt;\u0026lt; EOF { \u0026#34;registry-mirrors\u0026#34;: [ \u0026#34;http://hub-mirror.c.163.com\u0026#34;, \u0026#34;https://docker.mirrors.ustc.edu.cn\u0026#34;, \u0026#34;https://jc0srqak.mirror.aliyuncs.com\u0026#34; ], \u0026#34;exec-opts\u0026#34;: [\u0026#34;native.cgroupdriver=systemd\u0026#34;] } EOF systemctl daemon-reload systemctl enable docker \u0026amp;\u0026amp; systemctl start docker docker info 2.3 kubeadm/kubelet/kubectl æ·»åŠ é˜¿é‡Œäº‘ YUM è½¯ä»¶æº\ncat \u0026gt; /etc/yum.repos.d/kubernetes.repo \u0026lt;\u0026lt; EOF [kubernetes] name=Kubernetes baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64 enabled=1 gpgcheck=0 repo_gpgcheck=0 gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg EOF è¿™é‡ŒæŒ‡å®šç‰ˆæœ¬å·éƒ¨ç½²\nyum install -y kubelet-1.22.3 kubeadm-1.22.3 kubectl-1.22.3 systemctl enable kubelet systemctl start kubelet 3 éƒ¨ç½² Kubernetes Master å®˜æ–¹æ–‡æ¡£ 1 å®˜æ–¹æ–‡æ¡£ 2\nåœ¨ 1.1.1.1ï¼ˆMasterï¼‰æ‰§è¡Œ\nkubeadm init \\ --apiserver-advertise-address=1.1.1.1 \\ --kubernetes-version v1.22.3 \\ --service-cidr=10.96.0.0/12 \\ --pod-network-cidr=10.244.0.0/16 \\ --ignore-preflight-errors=all \\ --image-repository registry.aliyuncs.com/google_containers \u0026ndash;apiserver-advertise-address é›†ç¾¤é€šå‘Šåœ°å€ \u0026ndash;kubernetes-version K8s ç‰ˆæœ¬ï¼Œä¸ä¸Šé¢å®‰è£…çš„ä¸€è‡´ \u0026ndash;service-cidr é›†ç¾¤å†…éƒ¨è™šæ‹Ÿç½‘ç»œï¼ŒPod ç»Ÿä¸€è®¿é—®å…¥å£ \u0026ndash;pod-network-cidr Pod ç½‘ç»œï¼Œä¸ä¸‹é¢éƒ¨ç½²çš„ CNI ç½‘ç»œç»„ä»¶ yaml ä¸­ä¿æŒä¸€è‡´ \u0026ndash;ignore-preflight-errors=allï¼Œè·³è¿‡ä¸€äº›é”™è¯¯ \u0026ndash;image-repository ç”±äºé»˜è®¤æ‹‰å–é•œåƒåœ°å€ k8s.gcr.io å›½å†…æ— æ³•è®¿é—®ï¼Œè¿™é‡ŒæŒ‡å®šé˜¿é‡Œäº‘é•œåƒä»“åº“åœ°å€ æˆ–è€…ä½¿ç”¨é…ç½®æ–‡ä»¶å¼•å¯¼ï¼š\ncat \u0026gt; kubeadm.conf \u0026lt;\u0026lt; EOF apiVersion: kubeadm.k8s.io/v1beta2 kind: ClusterConfiguration kubernetesVersion: v1.22.3 imageRepository: registry.aliyuncs.com/google_containers networking: podSubnet: 10.244.0.0/16 serviceSubnet: 10.96.0.0/12 EOF kubeadm init --config kubeadm.conf --ignore-preflight-errors=all æ‹·è´ kubectl ä½¿ç”¨çš„è¿æ¥ k8s è®¤è¯æ–‡ä»¶åˆ°é»˜è®¤è·¯å¾„ï¼š\nmkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config æŸ¥çœ‹ k8s é›†ç¾¤çŠ¶æ€\nkubectl get cs NAME STATUS MESSAGE ERROR scheduler Unhealthy Get \u0026#34;http://127.0.0.1:10251/healthz\u0026#34;: dial tcp 127.0.0.1:10251: connect: connection refused controller-manager Healthy ok etcd-0 Healthy {\u0026#34;health\u0026#34;:\u0026#34;true\u0026#34;,\u0026#34;reason\u0026#34;:\u0026#34;\u0026#34;} vim /etc/kubernetes/manifests/kube-scheduler.yaml # æ³¨é‡Šæ‰ --port=0 ï¼Œschedulerä¼šè‡ªåŠ¨é‡å¯ï¼Œç¨ç­‰ä¸€å°ä¼šçŠ¶æ€å˜ä¸ºæ­£å¸¸ kubectl get cs NAME STATUS MESSAGE ERROR scheduler Healthy ok controller-manager Healthy ok etcd-0 Healthy {\u0026#34;health\u0026#34;:\u0026#34;true\u0026#34;,\u0026#34;reason\u0026#34;:\u0026#34;\u0026#34;} 4 åŠ å…¥ Kubernetes Node å®˜æ–¹æ–‡æ¡£\nåœ¨ 192.168.150.102/103ï¼ˆNodeï¼‰æ‰§è¡Œã€‚\nå‘é›†ç¾¤æ·»åŠ æ–°èŠ‚ç‚¹ï¼Œæ‰§è¡Œåœ¨ kubeadm init è¾“å‡ºçš„ kubeadm join å‘½ä»¤ï¼š\nkubeadm join 1.1.1.1:6443 --token esce21.q6hetwm8si29qxwn \\ --discovery-token-ca-cert-hash sha256:00603a05805807501d7181c3d60b478788408cfe6cedefedb1f97569708be9c5 é»˜è®¤ token æœ‰æ•ˆæœŸä¸º 24 å°æ—¶ï¼Œå½“è¿‡æœŸä¹‹åï¼Œè¯¥ token å°±ä¸å¯ç”¨äº†ã€‚è¿™æ—¶å°±éœ€è¦é‡æ–°åˆ›å»º tokenï¼Œæ“ä½œå¦‚ä¸‹ï¼š\nkubeadm token create kubeadm token list openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2\u0026gt;/dev/null | openssl dgst -sha256 -hex | sed \u0026#39;s/^.* //\u0026#39; 63bca849e0e01691ae14eab449570284f0c3ddeea590f8da988c07fe2729e924 kubeadm join 1.1.1.1:6443 --token nuja6n.o3jrhsffiqs9swnu --discovery-token-ca-cert-hash sha256:63bca849e0e01691ae14eab449570284f0c3ddeea590f8da988c07fe2729e924 æˆ–è€…ç›´æ¥å‘½ä»¤å¿«æ·ç”Ÿæˆ: kubeadm token create --print-join-command\n5 éƒ¨ç½²å®¹å™¨ç½‘ç»œ (cni) Calico æ˜¯ä¸€ä¸ªçº¯ä¸‰å±‚çš„æ•°æ®ä¸­å¿ƒç½‘ç»œæ–¹æ¡ˆï¼ŒCalico æ”¯æŒå¹¿æ³›çš„å¹³å°ï¼ŒåŒ…æ‹¬ Kubernetesã€OpenStack ç­‰ã€‚\nCalico åœ¨æ¯ä¸€ä¸ªè®¡ç®—èŠ‚ç‚¹åˆ©ç”¨ Linux Kernel å®ç°äº†ä¸€ä¸ªé«˜æ•ˆçš„è™šæ‹Ÿè·¯ç”±å™¨ï¼ˆ vRouterï¼‰ æ¥è´Ÿè´£æ•°æ®è½¬å‘ï¼Œè€Œæ¯ä¸ª vRouter é€šè¿‡ BGP åè®®è´Ÿè´£æŠŠè‡ªå·±ä¸Šè¿è¡Œçš„ workload çš„è·¯ç”±ä¿¡æ¯å‘æ•´ä¸ª Calico ç½‘ç»œå†…ä¼ æ’­ã€‚\næ­¤å¤–ï¼ŒCalico é¡¹ç›®è¿˜å®ç°äº† Kubernetes ç½‘ç»œç­–ç•¥ï¼Œæä¾› ACL åŠŸèƒ½ã€‚\nquickstart\nç‰ˆæœ¬å¯¹ç…§è¡¨ï¼Œåœ¨æ­¤é¡µé¢å¯ä»¥çœ‹åˆ° calico æ¯ä¸ªç‰ˆæœ¬æ”¯æŒçš„ kubernetes çš„ç‰ˆæœ¬\nå®‰è£… calico\nwget --no-check-certificate https://docs.tigera.io/archive/v3.23/manifests/calico.yaml ä¿®æ”¹ Pod ç½‘ç»œå’Œç½‘å¡è¯†åˆ«å‚æ•°ï¼ŒPod ç½‘ç»œä¸å‰é¢ kubeadm init æŒ‡å®šçš„ä¸€æ ·\n[root@k8s-node1 ~]# vim calico.yaml # ä¿®æ”¹ä½ç½®ï¼šDaemonSet.spec.template.spec.containers.env # æ–°å¢å¦‚ä¸‹å››è¡Œ - name: CALICO_IPV4POOL_CIDR value: \u0026#34;10.244.0.0/16\u0026#34; - name: IP_AUTODETECTION_METHOD value: interface=bond*,ens* #ç½‘å¡åæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ kubectl apply -f calico.yaml kubectl get pods -n kube-system # æ‰€æœ‰Podèµ·æ¥åï¼ŒèŠ‚ç‚¹çŠ¶æ€åº”è¯¥éƒ½æ˜¯ReadyçŠ¶æ€äº† [root@k8s-node1 ~]# kubectl get nodes NAME STATUS ROLES AGE VERSION k8s-node1 Ready control-plane,master 153m v1.22.3 k8s-node2 Ready \u0026lt;none\u0026gt; 151m v1.22.3 k8s-node3 Ready \u0026lt;none\u0026gt; 151m v1.22.3 6 metric-server cadvisor è´Ÿè´£æä¾›æ•°æ®ï¼Œå·²é›†æˆåˆ° k8s ä¸­\nMetrics-server è´Ÿè´£æ•°æ®æ±‡æ€»ï¼Œéœ€é¢å¤–å®‰è£…\nä¸‹è½½ yaml\nwget --no-check-certificate https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.6.0/components.yaml mv components.yaml metrics-server.yaml ä¿®æ”¹ yaml\ncontainers: - args: - --cert-dir=/tmp - --secure-port=4443 - --kubelet-preferred-address-types=InternalIP # ç¬¬ä¸€å¤„ä¿®æ”¹ - --kubelet-use-node-status-port - --metric-resolution=15s - --kubelet-insecure-tls # ç¬¬äºŒå¤„ä¿®æ”¹ image: registry.aliyuncs.com/google_containers/metrics-server:v0.6.0 # ç¬¬ä¸‰å¤„ä¿®æ”¹ imagePullPolicy: IfNotPresent --kubelet-insecure-tls ä¸éªŒè¯ kubelet è‡ªç­¾çš„è¯ä¹¦ `\u0026ndash;kubelet-preferred-address-types=InternalIP Metrics-server è¿æ¥ cadvisor é»˜è®¤é€šè¿‡ä¸»æœºåå³ node çš„åç§°è¿›è¡Œè¿æ¥ï¼Œè€Œ Metric-server ä½œä¸º pod è¿è¡Œåœ¨é›†ç¾¤ä¸­é»˜è®¤æ˜¯æ— æ³•è§£æçš„ï¼Œæ‰€ä»¥è¿™é‡Œä¿®æ”¹æˆé€šè¿‡èŠ‚ç‚¹ ip è¿æ¥ éƒ¨ç½² metrics-server\n[root@k8s-node1 ~]# kubectl apply -f metrics-server.yaml [root@k8s-node1 ~]# kubectl get pods -n kube-system -l k8s-app=metrics-server NAME READY STATUS RESTARTS AGE metrics-server-7f66b69ff6-bkfqg 1/1 Running 0 59s [root@k8s-node1 ~]# kubectl top nodes NAME CPU(cores) CPU% MEMORY(bytes) MEMORY% k8s-node1 226m 11% 2004Mi 54% k8s-node2 97m 4% 1047Mi 28% k8s-node3 98m 4% 1096Mi 29% 7 æµ‹è¯• kubernetes é›†ç¾¤ éªŒè¯ Pod å·¥ä½œ éªŒè¯ Pod ç½‘ç»œé€šä¿¡ éªŒè¯ DNS è§£æ åœ¨ Kubernetes é›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ª podï¼ŒéªŒè¯æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š\nkubectl create deployment nginx --image=nginx kubectl expose deployment nginx --type=NodePort --port=80 --target-port=80 [root@k8s-node1 ~]# kubectl get pod,deploy,svc NAME READY STATUS RESTARTS AGE pod/nginx-6799fc88d8-57bqd 1/1 Running 0 10m NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/nginx 1/1 1 1 10m NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/kubernetes ClusterIP 10.96.0.1 \u0026lt;none\u0026gt; 443/TCP 170m service/nginx NodePort 10.102.188.108 \u0026lt;none\u0026gt; 80:30954/TCP 2m31s è®¿é—®åœ°å€ï¼šhttp://1.1.1.1:30954ï¼Œç«¯å£æ˜¯å›ºå®šçš„ï¼Œip å¯ä»¥æ˜¯é›†ç¾¤å†…ä»»ä¸€èŠ‚ç‚¹çš„ ip\n8 éƒ¨ç½² Dashboard wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.4.0/aio/deploy/recommended.yaml é»˜è®¤ Dashboard åªèƒ½é›†ç¾¤å†…éƒ¨è®¿é—®ï¼Œä¿®æ”¹ Service ä¸º NodePort ç±»å‹ï¼Œæš´éœ²åˆ°å¤–éƒ¨ï¼š\nvi recommended.yaml ... kind: Service apiVersion: v1 metadata: labels: k8s-app: kubernetes-dashboard name: kubernetes-dashboard namespace: kubernetes-dashboard spec: ports: - port: 443 targetPort: 8443 nodePort: 30001 selector: k8s-app: kubernetes-dashboard type: NodePort ... kubectl apply -f recommended.yaml kubectl get pods -n kubernetes-dashboard NAME READY STATUS RESTARTS AGE dashboard-metrics-scraper-6b4884c9d5-gl8nr 1/1 Running 0 13m kubernetes-dashboard-7f99b75bf4-89cds 1/1 Running 0 13m è®¿é—®åœ°å€ï¼šhttps://NodeIP:30001\nåˆ›å»º service account å¹¶ç»‘å®šé»˜è®¤ cluster-admin ç®¡ç†å‘˜é›†ç¾¤è§’è‰²ï¼š\n# åˆ›å»ºç”¨æˆ· kubectl create serviceaccount dashboard-admin -n kube-system # ç”¨æˆ·æˆæƒ kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin # è·å–ç”¨æˆ·Token kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk \u0026#39;/dashboard-admin/{print $1}\u0026#39;) ä½¿ç”¨è¾“å‡ºçš„ token ç™»å½• Dashboardã€‚\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/kubernetes-deploy-v1.22.3/","summary":"1 Kubernetes æ¦‚è¿° kubernetes æ˜¯ä»€ä¹ˆ kubernetes æ˜¯ Google åœ¨ 2014 å¹´å¼€æºçš„ä¸€ä¸ªå®¹å™¨é›†ç¾¤ç®¡ç†å¹³å°ï¼Œkubernetes ç®€ç§° k8s k8s ç”¨äºå®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ï¼Œæ‰©å±•å’Œç®¡ç†ã€‚ k8s æä¾›äº†å®¹å™¨çš„ç¼–æ’ï¼Œèµ„æºè°ƒåº¦ï¼Œå¼¹æ€§ä¼¸ç¼©ï¼Œéƒ¨ç½²ç®¡ç†ï¼ŒæœåŠ¡å‘ç°ç­‰ä¸€ç³»åˆ—åŠŸèƒ½ kubernetes ç›®æ ‡æ˜¯è®©éƒ¨ç½²å®¹å™¨åŒ–åº”ç”¨ç®€å•é«˜æ•ˆ Kubernetes ç‰¹æ€§ è‡ªæˆ‘ä¿®å¤ åœ¨èŠ‚ç‚¹æ•…éšœæ—¶é‡æ–°å¯åŠ¨å¤±è´¥çš„å®¹å™¨ï¼Œæ›¿æ¢å’Œé‡æ–°","title":"kubernetes | kubeadm æ­å»º K8s é›†ç¾¤ v1.22.3"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\nsystemd å’Œ sysv çš„æœåŠ¡ç®¡ç† systemd-sysv-generator ä¸­æ–‡æ‰‹å†Œ openssh ç¼–è¯‘ rpm 1 openssh-9.5p1 1.1 ç¼–è¯‘ç¯å¢ƒ ç¼–è¯‘å¹³å°: åä¸ºç§æœ‰äº‘ ç³»ç»Ÿç‰ˆæœ¬: éº’éºŸ v7.4 ç³»ç»Ÿå†…æ ¸: 3.10.0-693.43.1.el7.x86_64 è½¯ä»¶ç‰ˆæœ¬:\nopenssh-9.5p1.tar.gz openssl-3.0.11.tar.gz x11-ssh-askpass-1.2.4.1.tar.gz ç¼–è¯‘è„šæœ¬é¡¹ç›®åœ°å€\n1.2 ç¼–è¯‘æ­¥éª¤ æ·»åŠ  yum æºç•¥, äº‘å¹³å°è‡ªå¸¦ yum æº\nåˆ›å»ºå·¥ä½œç›®å½•\nmkdir -p /opt/openssh-9.5/openssh-9.5p1-update-script/resource ä¸‹è½½ ç¼–è¯‘è„šæœ¬, ä¸Šä¼ è‡³æœåŠ¡å™¨ /opt/openssh-9.5 ç›®å½•å¹¶è§£å‹\ncd /opt/openssh-9.5; unzip openssh-rpms-main.zip yum å®‰è£…ä¾èµ–å·¥å…·\nyum clean all; yum makecache yum install wget vim gdb imake libXt-devel gtk2-devel rpm-build zlib-devel openssl-devel gcc perl perl-IPC-Cmd perl-devel pam-devel unzip krb5-devel libX11-devel initscripts é»˜è®¤ openssh æºç ä¸­æ˜¯æ²¡æœ‰ ssh-copy-id ç›¸å…³å‚æ•°çš„ï¼Œå¦‚æœç›´æ¥ç¼–è¯‘å®‰è£…ï¼Œä¼šå‘ç°å®‰è£…åæ²¡æœ‰ ssh-copy-id å‘½ä»¤ï¼Œå› æ­¤å¦‚æœéœ€è¦ç”¨åˆ°è¯¥å‘½ä»¤ï¼Œéœ€è¦ä¿®æ”¹ç¼–è¯‘å‚æ•°æ§åˆ¶æ–‡ä»¶ openssh.spec, æœ¬æ¬¡å®‰è£…ä½¿ç”¨çš„æ“ä½œç³»ç»Ÿæ˜¯ el7 ç³»åˆ—çš„\nvim /opt/openssh-9.5/openssh-rpms-main/el7/SPECS/openssh.spec å¦‚ä¸‹ä½ç½®æ·»åŠ ä¸€è¡Œ\ninstall -m755 contrib/ssh-copy-id $RPM_BUILD_ROOT/usr/bin/ssh-copy-id ç¬¬äºŒå¤„æ·»åŠ \n%attr(0755,root,root) %{_bindir}/ssh-copy-id ä¸‹è½½å„æºç åŒ…ä¸Šä¼ è‡³æœåŠ¡å™¨ /opt/openssh-9.5/openssh-rpms-main/downloads\nopenssh openssl x11-ssh-askpass æ‰§è¡Œç¼–è¯‘æ‰“åŒ…è„šæœ¬\ncd /opt/openssh-9.5/openssh-rpms-main/ # ä¿®æ”¹ version.env æ–‡ä»¶, ä½¿ç‰ˆæœ¬å·å¯¹åº” cat version.env bash compile.sh è„šæœ¬åº”æ­£å¸¸è¿è¡Œ, æŸ¥çœ‹ç¼–è¯‘åçš„ rpm åŒ…\ncd /opt/openssh-9.5/openssh-rpms-main/el7/RPMS/x86_64/; ls 1.3 å‡çº§è„šæœ¬ æ‹·è´ç¼–è¯‘åçš„åŒ…åˆ° resource ç›®å½•\ncp /opt/openssh-9.5/openssh-rpms-main/el7/RPMS/x86_64/*.rpm /opt/openssh-9.5/openssh-9.5p1-update-script/resource/ ç¼–å†™å‡çº§è„šæœ¬\ncat \u0026gt; /opt/openssh-9.5/openssh-9.5p1-update-script/run.sh \u0026lt;\u0026lt;EOF #!/bin/bash # # Author : lvbibir # Email : lvbibir@gmail.com # Version : V1.0 # Time : 2023-11-14 16:48:30 # Desc : A script for update ssh set -e ssh -V /bin/cp /etc/pam.d/sshd /etc/pam.d/sshd_bak /bin/cp /etc/ssh/sshd_config /etc/ssh/sshd_config_bak # å¦‚æœ‰ yum æºæ¨èä½¿ç”¨ yum æ–¹å¼ # yum localinstall -y resource/openssh-*.rpm rpm -Uvh resource/openssh-*.rpm /bin/cp /etc/pam.d/sshd_bak /etc/pam.d/sshd /bin/cp /etc/ssh/sshd_config_bak /etc/ssh/sshd_config rm -rf /etc/ssh/ssh*key systemctl daemon-reload systemctl restart sshd ssh -V EOF chmod 755 /opt/openssh-9.5/openssh-9.5p1-update-script/run.sh æ‰“åŒ…\ncd /opt/openssh-9.5/ tar zcf openssh-9.5p1-update-script.tar.gz openssh-9.5p1-update-script ä¸Šä¼ å‹ç¼©åŒ…è‡³æœåŠ¡å™¨ /opt/ ç›®å½•\ncd /opt; tar zxf openssh-9.5p1-update-script.tar.gz cd /opt/openssh-9.5p1-update-script/; sh run.sh ä»¥ä¸Š.\n","permalink":"https://www.lvbibir.cn/posts/tech/rpm-build-openssh/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: systemd å’Œ sysv çš„æœåŠ¡ç®¡ç† systemd-sysv-generator ä¸­æ–‡æ‰‹å†Œ openssh ç¼–è¯‘ rpm 1 openssh-9.5p1 1.1 ç¼–è¯‘ç¯å¢ƒ ç¼–è¯‘å¹³å°: åä¸ºç§æœ‰äº‘ ç³»ç»Ÿç‰ˆæœ¬: éº’éºŸ v7.4 ç³»ç»Ÿå†…æ ¸: 3.10.0-693.43.1.el7.x86_64 è½¯ä»¶ç‰ˆæœ¬: openssh-9.5p1.tar.gz openssl-3.0.11.tar.gz x11-ssh-askpass-1.2.4.1.tar.gz ç¼–è¯‘è„šæœ¬é¡¹ç›®åœ°å€ 1.2 ç¼–è¯‘æ­¥éª¤ æ·»åŠ  yum æºç•¥, äº‘å¹³å°è‡ªå¸¦ yum æº åˆ›å»ºå·¥ä½œç›®å½• mkdir -p /opt/openssh-9.5/openssh-9.5p1-update-script/resource ä¸‹è½½ ç¼–è¯‘è„šæœ¬, ä¸Šä¼ è‡³æœåŠ¡å™¨ /opt/openssh-9.5 ç›®å½•å¹¶è§£å‹ cd /opt/openssh-9.5; unzip openssh-rpms-main.zip yum å®‰è£…ä¾èµ–å·¥å…· yum clean all; yum makecache yum install","title":"openssh æºç æ‰“åŒ…ç¼–è¯‘æˆ rpm åŒ…"},{"content":"ä»£ç å¦‚ä¸‹\n#!/bin/bash #å‚æ•°å®šä¹‰ date=`date +\u0026#34;%Y-%m-%d-%H:%M:%S\u0026#34;` centosVersion=$(awk \u0026#39;{print $(NF-1)}\u0026#39; /etc/redhat-release) VERSION=`date +%F` #æ—¥å¿—ç›¸å…³ LOGPATH=\u0026#34;/tmp/awr\u0026#34; [ -e $LOGPATH ] || mkdir -p $LOGPATH RESULTFILE=\u0026#34;$LOGPATH/HostCheck-`hostname`-`date +%Y%m%d`.txt\u0026#34; #è°ƒç”¨å‡½æ•°åº“ [ -f /etc/init.d/functions ] \u0026amp;\u0026amp; source /etc/init.d/functions export PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin source /etc/profile #rootç”¨æˆ·æ‰§è¡Œè„šæœ¬ [ $(id -u) -gt 0 ] \u0026amp;\u0026amp; echo \u0026#34;è¯·ç”¨rootç”¨æˆ·æ‰§è¡Œæ­¤è„šæœ¬ï¼\u0026#34; \u0026amp;\u0026amp; exit 1 function version(){ echo \u0026#34;\u0026#34; echo \u0026#34;\u0026#34; echo \u0026#34;[${date}] \u0026gt;\u0026gt;\u0026gt; `hostname -s` ä¸»æœºå·¡æ£€\u0026#34; } function getSystemStatus(){ echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m****************************************************ç³»ç»Ÿæ£€æŸ¥****************************************************\\033[0m\u0026#34; if [ -e /etc/sysconfig/i18n ];then default_LANG=\u0026#34;$(grep \u0026#34;LANG=\u0026#34; /etc/sysconfig/i18n | grep -v \u0026#34;^#\u0026#34; | awk -F \u0026#39;\u0026#34;\u0026#39; \u0026#39;{print $2}\u0026#39;)\u0026#34; else default_LANG=$LANG fi export LANG=\u0026#34;en_US.UTF-8\u0026#34; Release=$(cat /etc/redhat-release 2\u0026gt;/dev/null) Kernel=$(uname -r) OS=$(uname -o) Hostname=$(uname -n) SELinux=$(/usr/sbin/sestatus | grep \u0026#34;SELinux status: \u0026#34; | awk \u0026#39;{print $3}\u0026#39;) LastReboot=$(who -b | awk \u0026#39;{print $3,$4}\u0026#39;) uptime=$(uptime | sed \u0026#39;s/.*up \\([^,]*\\), .*/\\1/\u0026#39;) echo \u0026#34; ç³»ç»Ÿï¼š$OS\u0026#34; echo \u0026#34; å‘è¡Œç‰ˆæœ¬ï¼š$Release\u0026#34; echo \u0026#34; å†…æ ¸ï¼š$Kernel\u0026#34; echo \u0026#34; ä¸»æœºåï¼š$Hostname\u0026#34; echo \u0026#34; SELinuxï¼š$SELinux\u0026#34; echo \u0026#34;è¯­è¨€/ç¼–ç ï¼š$default_LANG\u0026#34; echo \u0026#34; å½“å‰æ—¶é—´ï¼š$(date +\u0026#39;%F %T\u0026#39;)\u0026#34; echo \u0026#34; æœ€åå¯åŠ¨ï¼š$LastReboot\u0026#34; echo \u0026#34; è¿è¡Œæ—¶é—´ï¼š$uptime\u0026#34; export LANG=\u0026#34;$default_LANG\u0026#34; } function getCpuStatus(){ echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m****************************************************CPUæ£€æŸ¥*****************************************************\\033[0m\u0026#34; Physical_CPUs=$(grep \u0026#34;physical id\u0026#34; /proc/cpuinfo| sort | uniq | wc -l) Virt_CPUs=$(grep \u0026#34;processor\u0026#34; /proc/cpuinfo | wc -l) CPU_Kernels=$(grep \u0026#34;cores\u0026#34; /proc/cpuinfo|uniq| awk -F \u0026#39;: \u0026#39; \u0026#39;{print $2}\u0026#39;) CPU_Type=$(grep \u0026#34;model name\u0026#34; /proc/cpuinfo | awk -F \u0026#39;: \u0026#39; \u0026#39;{print $2}\u0026#39; | sort | uniq) CPU_Arch=$(uname -m) echo \u0026#34;ç‰©ç†CPUä¸ªæ•°:$Physical_CPUs\u0026#34; echo \u0026#34;é€»è¾‘CPUä¸ªæ•°:$Virt_CPUs\u0026#34; echo \u0026#34;æ¯CPUæ ¸å¿ƒæ•°:$CPU_Kernels\u0026#34; echo \u0026#34; CPUå‹å·:$CPU_Type\u0026#34; echo \u0026#34; CPUæ¶æ„:$CPU_Arch\u0026#34; } function getMemStatus(){ echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m**************************************************å†…å­˜æ£€æŸ¥*****************************************************\\033[0m\u0026#34; if [[ $centosVersion \u0026lt; 7 ]];then free -mo else free -h fi #æŠ¥è¡¨ä¿¡æ¯ MemTotal=$(grep MemTotal /proc/meminfo| awk \u0026#39;{print $2}\u0026#39;) #KB MemFree=$(grep MemFree /proc/meminfo| awk \u0026#39;{print $2}\u0026#39;) #KB let MemUsed=MemTotal-MemFree MemPercent=$(awk \u0026#34;BEGIN {if($MemTotal==0){printf 100}else{printf \\\u0026#34;%.2f\\\u0026#34;,$MemUsed*100/$MemTotal}}\u0026#34;) } function getDiskStatus(){ echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m**************************************************ç£ç›˜æ£€æŸ¥******************************************************\\033[0m\u0026#34; df -hiP | sed \u0026#39;s/Mounted on/Mounted/\u0026#39;\u0026gt; /tmp/inode df -hTP | sed \u0026#39;s/Mounted on/Mounted/\u0026#39;\u0026gt; /tmp/disk join /tmp/disk /tmp/inode | awk \u0026#39;{print $1,$2,\u0026#34;|\u0026#34;,$3,$4,$5,$6,\u0026#34;|\u0026#34;,$8,$9,$10,$11,\u0026#34;|\u0026#34;,$12}\u0026#39;| column -t #æŠ¥è¡¨ä¿¡æ¯ diskdata=$(df -TP | sed \u0026#39;1d\u0026#39; | awk \u0026#39;$2!=\u0026#34;tmpfs\u0026#34;{print}\u0026#39;) #KB disktotal=$(echo \u0026#34;$diskdata\u0026#34; | awk \u0026#39;{total+=$3}END{print total}\u0026#39;) #KB diskused=$(echo \u0026#34;$diskdata\u0026#34; | awk \u0026#39;{total+=$4}END{print total}\u0026#39;) #KB diskfree=$((disktotal-diskused)) #KB diskusedpercent=$(echo $disktotal $diskused | awk \u0026#39;{if($1==0){printf 100}else{printf \u0026#34;%.2f\u0026#34;,$2*100/$1}}\u0026#39;) inodedata=$(df -iTP | sed \u0026#39;1d\u0026#39; | awk \u0026#39;$2!=\u0026#34;tmpfs\u0026#34;{print}\u0026#39;) inodetotal=$(echo \u0026#34;$inodedata\u0026#34; | awk \u0026#39;{total+=$3}END{print total}\u0026#39;) inodeused=$(echo \u0026#34;$inodedata\u0026#34; | awk \u0026#39;{total+=$4}END{print total}\u0026#39;) inodefree=$((inodetotal-inodeused)) inodeusedpercent=$(echo $inodetotal $inodeused | awk \u0026#39;{if($1==0){printf 100}else{printf \u0026#34;%.2f\u0026#34;,$2*100/$1}}\u0026#39;) } function get_resource(){ echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m**************************************************èµ„æºæ¶ˆè€—ç»Ÿè®¡**************************************************\\033[0m\u0026#34; echo -e \u0026#34;\\033[36m*************å¸¦å®½èµ„æºæ¶ˆè€—ç»Ÿè®¡*************\\033[0m\u0026#34; #ç”¨æ•°ç»„å­˜æ”¾ç½‘å¡å nic=(`ifconfig | grep ^[a-z] | grep -vE \u0026#39;lo|docker0\u0026#39;| awk -F: \u0026#39;{print $1}\u0026#39;`) time=`date \u0026#34;+%Y-%m-%d %k:%M\u0026#34;` num=0 for ((i=0;i\u0026lt;${#nic[@]};i++)) do #å¾ªç¯äº”æ¬¡ï¼Œé¿å…çœ‹åˆ°çš„æ˜¯å¶ç„¶çš„æ•°æ® while (( $num\u0026lt;5 )) do rx_before=$(cat /proc/net/dev | grep \u0026#39;${nic[$i]}\u0026#39; | tr : \u0026#34; \u0026#34; | awk \u0026#39;{print $2}\u0026#39;) tx_before=$(cat /proc/net/dev | grep \u0026#39;${nic[$i]}\u0026#39; | tr : \u0026#34; \u0026#34; | awk \u0026#39;{print $10}\u0026#39;) sleep 2 #ç”¨sedå…ˆè·å–ç¬¬7åˆ—,å†ç”¨awkè·å–ç¬¬2åˆ—ï¼Œå†cutåˆ‡å‰²,ä»ç¬¬7ä¸ªåˆ°æœ€åï¼Œå³åªåˆ‡å‰²ç½‘å¡æµé‡æ•°å­—éƒ¨åˆ† rx_after=$(cat /proc/net/dev | grep \u0026#39;${nic[$i]}\u0026#39; | tr : \u0026#34; \u0026#34; | awk \u0026#39;{print $2}\u0026#39;) tx_after=$(cat /proc/net/dev | grep \u0026#39;${nic[$i]}\u0026#39; | tr : \u0026#34; \u0026#34; | awk \u0026#39;{print $10}\u0026#39;) #æ³¨æ„ä¸‹é¢æˆªå–çš„ç›¸å·®2ç§’çš„ä¸¤ä¸ªæ—¶åˆ»çš„ç´¯è®¡å’Œå‘é€çš„bytes(å³ç´¯è®¡ä¼ é€å’Œæ¥æ”¶çš„ä½) rx_result=$[(rx_after-rx_before)/1024/1024/2*8] tx_result=$[(tx_after-tx_before)/1024/1024/2*8] echo \u0026#34;$time Now_In_Speed: $rx_result Mbps Now_OUt_Speed: $tx_result Mbps\u0026#34; \u0026gt;\u0026gt; /tmp/network.txt let \u0026#34;num++\u0026#34; done #æ³¨æ„ä¸‹é¢grepåé¢çš„$timeå˜é‡è¦ç”¨åŒå¼•å·æ‹¬èµ·æ¥ rx_result=$(cat /tmp/network.txt|grep \u0026#34;$time\u0026#34;|awk \u0026#39;{In+=$4}END{print In}\u0026#39;) tx_result=$(cat /tmp/network.txt|grep \u0026#34;$time\u0026#34;|awk \u0026#39;{Out+=$7}END{print Out}\u0026#39;) In_Speed=$(echo \u0026#34;scale=2;$rx_result/5\u0026#34;|bc) Out_Speed=$(echo \u0026#34;scale=2;$tx_result/5\u0026#34;|bc) echo -e \u0026#34;\\033[32m In_Speed_average: $In_Speed Mbps Out_Speed_average: $Out_Speed Mbps! \\033[0m\u0026#34; done echo -e \u0026#34;\\033[36m*************CPUèµ„æºæ¶ˆè€—ç»Ÿè®¡*************\\033[0m\u0026#34; #ä½¿ç”¨vmstat 1 5å‘½ä»¤ç»Ÿè®¡5ç§’å†…çš„ä½¿ç”¨æƒ…å†µï¼Œå†è®¡ç®—æ¯ç§’ä½¿ç”¨æƒ…å†µ total=`vmstat 1 5|awk \u0026#39;{x+=$13;y+=$14}END{print x+y}\u0026#39;` cpu_average=$(echo \u0026#34;scale=2;$total/5\u0026#34;|bc) #åˆ¤æ–­CPUä½¿ç”¨ç‡ï¼ˆæµ®ç‚¹æ•°ä¸æ•´æ•°æ¯”è¾ƒï¼‰ if [ `echo \u0026#34;${cpu_average} \u0026gt; 70\u0026#34; | bc` -eq 1 ];then echo -e \u0026#34;\\033[31m Total CPU is already use: ${cpu_average}%,è¯·åŠæ—¶å¤„ç†ï¼\\033[0m\u0026#34; else echo -e \u0026#34;\\033[32m Total CPU is already use: ${cpu_average}%! \\033[0m\u0026#34; fi echo -e \u0026#34;\\033[36m*************ç£ç›˜èµ„æºæ¶ˆè€—ç»Ÿè®¡*************\\033[0m\u0026#34; #ç£ç›˜ä½¿ç”¨æƒ…å†µ(æ³¨æ„ï¼šéœ€è¦ç”¨sedå…ˆè¿›è¡Œæ ¼å¼åŒ–æ‰èƒ½è¿›è¡Œç´¯åŠ å¤„ç†) disk_used=$(df -m | sed \u0026#39;1d;/ /!N;s/\\n//;s/ \\+/ /;\u0026#39; | awk \u0026#39;{used+=$3} END{print used}\u0026#39;) disk_totalSpace=$(df -m | sed \u0026#39;1d;/ /!N;s/\\n//;s/ \\+/ /;\u0026#39; | awk \u0026#39;{totalSpace+=$2} END{print totalSpace}\u0026#39;) disk_all=$(echo \u0026#34;scale=4;$disk_used/$disk_totalSpace\u0026#34; | bc) disk_percent1=$(echo $disk_all | cut -c 2-3) disk_percent2=$(echo $disk_all | cut -c 4-5) disk_warning=`df -m | sed \u0026#39;1d;/ /!N;s/\\n//;s/ \\+/ /;\u0026#39; | awk \u0026#39;{if ($5\u0026gt;85) print $6 \u0026#34;ç›®å½•ä½¿ç”¨ç‡ï¼š\u0026#34; $5;} \u0026#39;` echo -e \u0026#34;\\033[32m Total disk has used: $disk_percent1.$disk_percent2% \\033[0m\u0026#34; #echo -e \u0026#34;\\t\\t..\u0026#34; è¡¨ç¤ºæ¢è¡Œ if [ -n \u0026#34;$disk_warning\u0026#34; ];then echo -e \u0026#34;\\033[31m${disk_warning} \\n [Error]ä»¥ä¸Šç›®å½•ä½¿ç”¨ç‡è¶…è¿‡85%ï¼Œè¯·åŠæ—¶å¤„ç†ï¼\\033[0m\u0026#34; fi echo -e \u0026#34;\\033[36m*************å†…å­˜èµ„æºæ¶ˆè€—ç»Ÿè®¡*************\\033[0m\u0026#34; #è·å¾—ç³»ç»Ÿæ€»å†…å­˜ memery_all=$(free -m | awk \u0026#39;NR==2\u0026#39; | awk \u0026#39;{print $2}\u0026#39;) #è·å¾—å ç”¨å†…å­˜ï¼ˆæ“ä½œç³»ç»Ÿ è§’åº¦ï¼‰ system_memery_used=$(free -m | awk \u0026#39;NR==2\u0026#39; | awk \u0026#39;{print $3}\u0026#39;) #è·å¾—bufferã€cacheå ç”¨å†…å­˜ï¼Œå½“å†…å­˜ä¸å¤Ÿæ—¶ä¼šåŠæ—¶å›æ”¶ï¼Œæ‰€ä»¥è¿™ä¸¤éƒ¨åˆ†å¯ç”¨äºå¯ç”¨å†…å­˜çš„è®¡ç®— buffer_used=$(free -m | awk \u0026#39;NR==2\u0026#39; | awk \u0026#39;{print $6}\u0026#39;) cache_used=$(free -m | awk \u0026#39;NR==2\u0026#39; | awk \u0026#39;{print $7}\u0026#39;) #è·å¾—è¢«ä½¿ç”¨å†…å­˜ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†å¯ç”¨äºå¯ç”¨å†…å­˜çš„è®¡ç®—ï¼Œæ³¨æ„è®¡ç®—æ–¹æ³• actual_used_all=$[memery_all-(free+buffer_used+cache_used)] #è·å¾—å®é™…å ç”¨çš„å†…å­˜ actual_used_all=`expr $memery_all - $free + $buffer_used + $cache_used ` memery_percent=$(echo \u0026#34;scale=4;$system_memery_used / $memery_all\u0026#34; | bc) memery_percent2=$(echo \u0026#34;scale=4; $actual_used_all / $memery_all\u0026#34; | bc) percent_part1=$(echo $memery_percent | cut -c 2-3) percent_part2=$(echo $memery_percent | cut -c 4-5) percent_part11=$(echo $memery_percent2 | cut -c 2-3) percent_part22=$(echo $memery_percent2 | cut -c 4-5) #è·å¾—å ç”¨å†…å­˜ï¼ˆæ“ä½œç³»ç»Ÿè§’åº¦ï¼‰ echo -e \u0026#34;\\033[32m system memery is already use: $percent_part1.$percent_part2% \\033[0m\u0026#34; #è·å¾—å®é™…å†…å­˜å ç”¨ç‡ echo -e \u0026#34;\\033[32m actual memery is already use: $percent_part11.$percent_part22% \\033[0m\u0026#34; echo -e \u0026#34;\\033[32m buffer is already used : $buffer_used M \\033[0m\u0026#34; echo -e \u0026#34;\\033[32m cache is already used : $cache_used M \\033[0m\u0026#34; } function getServiceStatus(){ echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m*************************************************æœåŠ¡æ£€æŸ¥*******************************************************\\033[0m\u0026#34; echo \u0026#34;\u0026#34; if [[ $centosVersion \u0026gt; 7 ]];then conf=$(systemctl list-unit-files --type=service --state=enabled --no-pager | grep \u0026#34;enabled\u0026#34;) process=$(systemctl list-units --type=service --state=running --no-pager | grep \u0026#34;.service\u0026#34;) else conf=$(/sbin/chkconfig | grep -E \u0026#34;:on|:å¯ç”¨\u0026#34;) process=$(/sbin/service --status-all 2\u0026gt;/dev/null | grep -E \u0026#34;is running|æ­£åœ¨è¿è¡Œ\u0026#34;) fi echo -e \u0026#34;\\033[36m******************æœåŠ¡é…ç½®******************\\033[0m\u0026#34; echo \u0026#34;$conf\u0026#34; | column -t echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[36m**************æ­£åœ¨è¿è¡Œçš„æœåŠ¡****************\\033[0m\u0026#34; echo \u0026#34;$process\u0026#34; } function getAutoStartStatus(){ echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m***********************************************è‡ªå¯åŠ¨æ£€æŸ¥*******************************************************\\033[0m\u0026#34; echo -e \u0026#34;\\033[36m****************è‡ªå¯åŠ¨å‘½ä»¤*****************\\033[0m\u0026#34; conf=$(grep -v \u0026#34;^#\u0026#34; /etc/rc.d/rc.local| sed \u0026#39;/^$/d\u0026#39;) echo \u0026#34;$conf\u0026#34; } function getLoginStatus(){ echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m************************************************ç™»å½•æ£€æŸ¥********************************************************\\033[0m\u0026#34; last | head } function getNetworkStatus(){ echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m************************************************ç½‘ç»œæ£€æŸ¥********************************************************\\033[0m\u0026#34; if [[ $centosVersion \u0026lt; 7 ]];then /sbin/ifconfig -a | grep -v packets | grep -v collisions | grep -v i net6 else #ip a for i in $(ip link | grep BROADCAST | awk -F: \u0026#39;{print $2}\u0026#39;);do ip add show $i | grep -E \u0026#34;BROADCAST|global\u0026#34;| awk \u0026#39;{print $2}\u0026#39; | tr \u0026#39;\\n\u0026#39; \u0026#39; \u0026#39; ;echo \u0026#34;\u0026#34; ;done fi GATEWAY=$(ip route | grep default | awk \u0026#39;{print $3}\u0026#39;) DNS=$(grep nameserver /etc/resolv.conf| grep -v \u0026#34;#\u0026#34; | awk \u0026#39;{print $2}\u0026#39; | tr \u0026#39;\\n\u0026#39; \u0026#39;,\u0026#39; | sed \u0026#39;s/,$//\u0026#39;) echo \u0026#34;\u0026#34; echo \u0026#34;ç½‘å…³ï¼š$GATEWAY \u0026#34; echo \u0026#34;DNSï¼š$DNS\u0026#34; #æŠ¥è¡¨ä¿¡æ¯ IP=$(ip -f inet addr | grep -v 127.0.0.1 | grep inet | awk \u0026#39;{print $NF,$2}\u0026#39; | tr \u0026#39;\\n\u0026#39; \u0026#39;,\u0026#39; | sed \u0026#39;s/,$//\u0026#39;) MAC=$(ip link | grep -v \u0026#34;LOOPBACK\\|loopback\u0026#34; | awk \u0026#39;{print $2}\u0026#39; | sed \u0026#39;N;s/\\n//\u0026#39; | tr \u0026#39;\\n\u0026#39; \u0026#39;,\u0026#39; | sed \u0026#39;s/,$//\u0026#39;) echo \u0026#34;\u0026#34; ping -c 4 www.baidu.com \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 if [ $? -eq 0 ];then echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[32mç½‘ç»œè¿æ¥ï¼šæ­£å¸¸ï¼\\033[0m\u0026#34; else echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[31mç½‘ç»œè¿æ¥ï¼šå¼‚å¸¸ï¼\\033[0m\u0026#34; fi } function getListenStatus(){ echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m***********************************************ç›‘å¬æ£€æŸ¥********************************************************\\033[0m\u0026#34; TCPListen=$(ss -ntul | column -t) echo \u0026#34;$TCPListen\u0026#34; } function getCronStatus(){ echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m**********************************************è®¡åˆ’ä»»åŠ¡æ£€æŸ¥******************************************************\\033[0m\u0026#34; Crontab=0 for shell in $(grep -v \u0026#34;/sbin/nologin\u0026#34; /etc/shells);do for user in $(grep \u0026#34;$shell\u0026#34; /etc/passwd| awk -F: \u0026#39;{print $1}\u0026#39;);do crontab -l -u $user \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 status=$? if [ $status -eq 0 ];then echo -e \u0026#34;\\033[36m************$userç”¨æˆ·çš„å®šæ—¶ä»»åŠ¡**************\\033[0m\u0026#34; crontab -l -u $user let Crontab=Crontab+$(crontab -l -u $user | wc -l) echo \u0026#34;\u0026#34; fi done done #è®¡åˆ’ä»»åŠ¡ #find /etc/cron* -type f | xargs -i ls -l {} | column -t #let Crontab=Crontab+$(find /etc/cron* -type f | wc -l) } function getHowLongAgo(){ # è®¡ç®—ä¸€ä¸ªæ—¶é—´æˆ³ç¦»ç°åœ¨æœ‰å¤šä¹…äº† datetime=\u0026#34;$*\u0026#34; [ -z \u0026#34;$datetime\u0026#34; ] \u0026amp;\u0026amp; echo `stat /etc/passwd|awk \u0026#34;NR==6\u0026#34;` Timestamp=$(date +%s -d \u0026#34;$datetime\u0026#34;) Now_Timestamp=$(date +%s) Difference_Timestamp=$(($Now_Timestamp-$Timestamp)) days=0;hours=0;minutes=0; sec_in_day=$((60*60*24)); sec_in_hour=$((60*60)); sec_in_minute=60 while (( $(($Difference_Timestamp-$sec_in_day)) \u0026gt; 1 )) do let Difference_Timestamp=Difference_Timestamp-sec_in_day let days++ done while (( $(($Difference_Timestamp-$sec_in_hour)) \u0026gt; 1 )) do let Difference_Timestamp=Difference_Timestamp-sec_in_hour let hours++ done echo \u0026#34;$days å¤© $hours å°æ—¶å‰\u0026#34; } function getUserLastLogin(){ # è·å–ç”¨æˆ·æœ€è¿‘ä¸€æ¬¡ç™»å½•çš„æ—¶é—´ï¼Œå«å¹´ä»½ # å¾ˆé—æ†¾lastå‘½ä»¤ä¸æ”¯æŒæ˜¾ç¤ºå¹´ä»½ï¼Œåªæœ‰\u0026#34;last -t YYYYMMDDHHMMSS\u0026#34;è¡¨ç¤ºæŸä¸ªæ—¶é—´ä¹‹é—´çš„ç™»å½•ï¼Œæˆ‘ # ä»¬åªèƒ½ç”¨æœ€ç¬¨çš„æ–¹æ³•äº†ï¼Œå¯¹æ¯”ä»Šå¤©ä¹‹å‰å’Œä»Šå¹´å…ƒæ—¦ä¹‹å‰ï¼ˆæˆ–è€…å»å¹´ä¹‹å‰å’Œå‰å¹´ä¹‹å‰â€¦â€¦ï¼‰æŸä¸ªç”¨æˆ· # ç™»å½•æ¬¡æ•°ï¼Œå¦‚æœç™»å½•ç»Ÿè®¡æ¬¡æ•°æœ‰å˜åŒ–ï¼Œåˆ™è¯´æ˜æœ€è¿‘ä¸€æ¬¡ç™»å½•æ˜¯ä»Šå¹´ã€‚ username=$1 : ${username:=\u0026#34;`whoami`\u0026#34;} thisYear=$(date +%Y) oldesYear=$(last | tail -n1 | awk \u0026#39;{print $NF}\u0026#39;) while(( $thisYear \u0026gt;= $oldesYear));do loginBeforeToday=$(last $username | grep $username | wc -l) loginBeforeNewYearsDayOfThisYear=$(last $username -t $thisYear\u0026#34;0101000000\u0026#34; | grep $username | wc -l) if [ $loginBeforeToday -eq 0 ];then echo \u0026#34;ä»æœªç™»å½•è¿‡\u0026#34; break elif [ $loginBeforeToday -gt $loginBeforeNewYearsDayOfThisYear ];then lastDateTime=$(last -i $username | head -n1 | awk \u0026#39;{for(i=4;i\u0026lt;(NF-2);i++)printf\u0026#34;%s \u0026#34;,$i}\u0026#39;)\u0026#34; $thisYear\u0026#34; lastDateTime=$(date \u0026#34;+%Y-%m-%d %H:%M:%S\u0026#34; -d \u0026#34;$lastDateTime\u0026#34;) echo \u0026#34;$lastDateTime\u0026#34; break else thisYear=$((thisYear-1)) fi done } function getUserStatus(){ echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m*************************************************ç”¨æˆ·æ£€æŸ¥*******************************************************\\033[0m\u0026#34; #/etc/passwd æœ€åä¿®æ”¹æ—¶é—´ pwdfile=\u0026#34;$(cat /etc/passwd)\u0026#34; Modify=$(stat /etc/passwd | grep Modify | tr \u0026#39;.\u0026#39; \u0026#39; \u0026#39; | awk \u0026#39;{print $2,$3}\u0026#39;) echo \u0026#34;/etc/passwd: $Modify ($(getHowLongAgo $Modify))\u0026#34; echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[36m******************ç‰¹æƒç”¨æˆ·******************\\033[0m\u0026#34; RootUser=\u0026#34;\u0026#34; for user in $(echo \u0026#34;$pwdfile\u0026#34; | awk -F: \u0026#39;{print $1}\u0026#39;);do if [ $(id -u $user) -eq 0 ];then echo \u0026#34;$user\u0026#34; RootUser=\u0026#34;$RootUser,$user\u0026#34; fi done echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[36m******************ç”¨æˆ·åˆ—è¡¨******************\\033[0m\u0026#34; USERs=0 echo \u0026#34;$( echo \u0026#34;ç”¨æˆ·å UID GID HOME SHELL æœ€åä¸€æ¬¡ç™»å½•\u0026#34; for shell in $(grep -v \u0026#34;/sbin/nologin\u0026#34; /etc/shells);do for username in $(grep \u0026#34;$shell\u0026#34; /etc/passwd| awk -F: \u0026#39;{print $1}\u0026#39;);do userLastLogin=\u0026#34;$(getUserLastLogin $username)\u0026#34; echo \u0026#34;$pwdfile\u0026#34; | grep -w \u0026#34;$username\u0026#34; |grep -w \u0026#34;$shell\u0026#34;| awk -F: -v lastlogin=\u0026#34;$(echo \u0026#34;$userLastLogin\u0026#34; | tr \u0026#39; \u0026#39; \u0026#39;_\u0026#39;)\u0026#34; \u0026#39;{print $1,$3,$4,$6,$7,lastlogin}\u0026#39; done let USERs=USERs+$(echo \u0026#34;$pwdfile\u0026#34; | grep \u0026#34;$shell\u0026#34;| wc -l) done )\u0026#34; | column -t echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[36m******************ç©ºå¯†ç ç”¨æˆ·****************\\033[0m\u0026#34; USEREmptyPassword=\u0026#34;\u0026#34; for shell in $(grep -v \u0026#34;/sbin/nologin\u0026#34; /etc/shells);do for user in $(echo \u0026#34;$pwdfile\u0026#34; | grep \u0026#34;$shell\u0026#34; | cut -d: -f1);do r=$(awk -F: \u0026#39;$2==\u0026#34;!!\u0026#34;{print $1}\u0026#39; /etc/shadow | grep -w $user) if [ ! -z $r ];then echo $r USEREmptyPassword=\u0026#34;$USEREmptyPassword,\u0026#34;$r fi done done echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[36m*****************ç›¸åŒIDç”¨æˆ·*****************\\033[0m\u0026#34; USERTheSameUID=\u0026#34;\u0026#34; UIDs=$(cut -d: -f3 /etc/passwd | sort | uniq -c | awk \u0026#39;$1\u0026gt;1{print $2}\u0026#39;) for uid in $UIDs;do echo -n \u0026#34;$uid\u0026#34;; USERTheSameUID=\u0026#34;$uid\u0026#34; r=$(awk -F: \u0026#39;ORS=\u0026#34;\u0026#34;;$3==\u0026#39;\u0026#34;$uid\u0026#34;\u0026#39;{print \u0026#34;:\u0026#34;,$1}\u0026#39; /etc/passwd) echo \u0026#34;$r\u0026#34; echo \u0026#34;\u0026#34; USERTheSameUID=\u0026#34;$USERTheSameUID $r,\u0026#34; done } function getPasswordStatus { echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m*************************************************å¯†ç æ£€æŸ¥*******************************************************\\033[0m\u0026#34; pwdfile=\u0026#34;$(cat /etc/passwd)\u0026#34; echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[36m****************å¯†ç è¿‡æœŸæ£€æŸ¥****************\\033[0m\u0026#34; result=\u0026#34;\u0026#34; for shell in $(grep -v \u0026#34;/sbin/nologin\u0026#34; /etc/shells);do for user in $(echo \u0026#34;$pwdfile\u0026#34; | grep \u0026#34;$shell\u0026#34; | cut -d: -f1);do get_expiry_date=$(/usr/bin/chage -l $user | grep \u0026#39;Password expires\u0026#39; | cut -d: -f2) if [[ $get_expiry_date = \u0026#39; never\u0026#39; || $get_expiry_date = \u0026#39;never\u0026#39; ]];then printf \u0026#34;%-15s æ°¸ä¸è¿‡æœŸ\\n\u0026#34; $user result=\u0026#34;$result,$user:never\u0026#34; else password_expiry_date=$(date -d \u0026#34;$get_expiry_date\u0026#34; \u0026#34;+%s\u0026#34;) current_date=$(date \u0026#34;+%s\u0026#34;) diff=$(($password_expiry_date-$current_date)) let DAYS=$(($diff/(60*60*24))) printf \u0026#34;%-15s %så¤©åè¿‡æœŸ\\n\u0026#34; $user $DAYS result=\u0026#34;$result,$user:$DAYS days\u0026#34; fi done done report_PasswordExpiry=$(echo $result | sed \u0026#39;s/^,//\u0026#39;) echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[36m****************å¯†ç ç­–ç•¥æ£€æŸ¥****************\\033[0m\u0026#34; grep -v \u0026#34;#\u0026#34; /etc/login.defs | grep -E \u0026#34;PASS_MAX_DAYS|PASS_MIN_DAYS|PASS_MIN_LEN|PASS_WARN_AGE\u0026#34; } function getSudoersStatus(){ echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m**********************************************Sudoersæ£€æŸ¥*******************************************************\\033[0m\u0026#34; conf=$(grep -v \u0026#34;^#\u0026#34; /etc/sudoers| grep -v \u0026#34;^Defaults\u0026#34; | sed \u0026#39;/^$/d\u0026#39;) echo \u0026#34;$conf\u0026#34; echo \u0026#34;\u0026#34; } function getInstalledStatus(){ echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m*************************************************è½¯ä»¶æ£€æŸ¥*******************************************************\\033[0m\u0026#34; rpm -qa --last | head | column -t } function getProcessStatus(){ echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m*************************************************è¿›ç¨‹æ£€æŸ¥*******************************************************\\033[0m\u0026#34; if [ $(ps -ef | grep defunct | grep -v grep | wc -l) -ge 1 ];then echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[36m***************åƒµå°¸è¿›ç¨‹***************\\033[0m\u0026#34; ps -ef | head -n1 ps -ef | grep defunct | grep -v grep fi echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[36m************CPUå ç”¨TOP 10è¿›ç¨‹*************\\033[0m\u0026#34; echo -e \u0026#34;ç”¨æˆ· è¿›ç¨‹ID %CPU å‘½ä»¤ $(ps aux | awk \u0026#39;{print $1, $2, $3, $11}\u0026#39; | sort -k3rn | head -n 10 )\u0026#34;| column -t echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[36m************å†…å­˜å ç”¨TOP 10è¿›ç¨‹*************\\033[0m\u0026#34; echo -e \u0026#34;ç”¨æˆ· è¿›ç¨‹ID %MEM è™šæ‹Ÿå†…å­˜ å¸¸é©»å†…å­˜ å‘½ä»¤ $(ps aux | awk \u0026#39;{print $1, $2, $4, $5, $6, $11}\u0026#39; | sort -k3rn | head -n 10 )\u0026#34;| column -t #echo \u0026#34;\u0026#34; #echo -e \u0026#34;\\033[36m************SWAPå ç”¨TOP 10è¿›ç¨‹*************\\033[0m\u0026#34; #awk: fatal: cannot open file `/proc/18713/smaps\u0026#39; for reading (No such file or directory) #for i in `cd /proc;ls |grep \u0026#34;^[0-9]\u0026#34;|awk \u0026#39; $0 \u0026gt;100\u0026#39;`;do awk \u0026#39;{if (-f /proc/$i/smaps) print \u0026#34;$i file is not exist\u0026#34;; else print \u0026#34;$i\u0026#34;}\u0026#39;;done # for i in `cd /proc;ls |grep \u0026#34;^[0-9]\u0026#34;|awk \u0026#39; $0 \u0026gt;100\u0026#39;` ;do awk \u0026#39;/Swap:/{a=a+$2}END{print \u0026#39;\u0026#34;$i\u0026#34;\u0026#39;,a/1024\u0026#34;M\u0026#34;}\u0026#39; /proc/$i/smaps ;done |sort -k2nr \u0026gt; /tmp/swap.txt #echo -e \u0026#34;è¿›ç¨‹ID SWAPä½¿ç”¨ $(cat /tmp/swap.txt|grep -v awk | head -n 10)\u0026#34;| column -t } function getSyslogStatus(){ echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m***********************************************syslogæ£€æŸ¥*******************************************************\\033[0m\u0026#34; echo \u0026#34;SYSLOGæœåŠ¡çŠ¶æ€ï¼š$(getState rsyslog)\u0026#34; echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[36m***************rsyslogé…ç½®******************\\033[0m\u0026#34; cat /etc/rsyslog.conf 2\u0026gt;/dev/null | grep -v \u0026#34;^#\u0026#34; | grep -v \u0026#34;^\\\\$\u0026#34; | sed \u0026#39;/^$/d\u0026#39; | column -t } function getFirewallStatus(){ echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m***********************************************é˜²ç«å¢™æ£€æŸ¥*******************************************************\\033[0m\u0026#34; echo -e \u0026#34;\\033[36m****************é˜²ç«å¢™çŠ¶æ€******************\\033[0m\u0026#34; if [[ $centosVersion = 7 ]];then systemctl status firewalld \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 status=$? if [ $status -eq 0 ];then s=\u0026#34;active\u0026#34; elif [ $status -eq 3 ];then s=\u0026#34;inactive\u0026#34; elif [ $status -eq 4 ];then s=\u0026#34;permission denied\u0026#34; else s=\u0026#34;unknown\u0026#34; fi else s=\u0026#34;$(getState iptables)\u0026#34; fi echo \u0026#34;firewalld: $s\u0026#34; echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[36m****************é˜²ç«å¢™é…ç½®******************\\033[0m\u0026#34; cat /etc/sysconfig/firewalld 2\u0026gt;/dev/null } function getSNMPStatus(){ #SNMPæœåŠ¡çŠ¶æ€ï¼Œé…ç½®ç­‰ echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m***********************************************SNMPæ£€æŸ¥*********************************************************\\033[0m\u0026#34; status=\u0026#34;$(getState snmpd)\u0026#34; echo \u0026#34;SNMPæœåŠ¡çŠ¶æ€ï¼š$status\u0026#34; echo \u0026#34;\u0026#34; if [ -e /etc/snmp/snmpd.conf ];then echo \u0026#34;/etc/snmp/snmpd.conf\u0026#34; echo \u0026#34;--------------------\u0026#34; cat /etc/snmp/snmpd.conf 2\u0026gt;/dev/null | grep -v \u0026#34;^#\u0026#34; | sed \u0026#39;/^$/d\u0026#39; fi } function getState(){ if [[ $centosVersion \u0026lt; 7 ]];then if [ -e \u0026#34;/etc/init.d/$1\u0026#34; ];then if [ `/etc/init.d/$1 status 2\u0026gt;/dev/null | grep -E \u0026#34;is running|æ­£åœ¨è¿è¡Œ\u0026#34; | wc -l` -ge 1 ];then r=\u0026#34;active\u0026#34; else r=\u0026#34;inactive\u0026#34; fi else r=\u0026#34;unknown\u0026#34; fi else #CentOS 7+ r=\u0026#34;$(systemctl is-active $1 2\u0026gt;\u0026amp;1)\u0026#34; fi echo \u0026#34;$r\u0026#34; } function getSSHStatus(){ #SSHDæœåŠ¡çŠ¶æ€ï¼Œé…ç½®,å—ä¿¡ä»»ä¸»æœºç­‰ echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m************************************************SSHæ£€æŸ¥*********************************************************\\033[0m\u0026#34; #æ£€æŸ¥å—ä¿¡ä»»ä¸»æœº pwdfile=\u0026#34;$(cat /etc/passwd)\u0026#34; echo \u0026#34;SSHæœåŠ¡çŠ¶æ€ï¼š$(getState sshd)\u0026#34; Protocol_Version=$(cat /etc/ssh/sshd_config | grep Protocol | awk \u0026#39;{print $2}\u0026#39;) echo \u0026#34;SSHåè®®ç‰ˆæœ¬ï¼š$Protocol_Version\u0026#34; echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[36m****************ä¿¡ä»»ä¸»æœº******************\\033[0m\u0026#34; authorized=0 for user in $(echo \u0026#34;$pwdfile\u0026#34; | grep /bin/bash | awk -F: \u0026#39;{print $1}\u0026#39;);do authorize_file=$(echo \u0026#34;$pwdfile\u0026#34; | grep -w $user | awk -F: \u0026#39;{printf $6\u0026#34;/.ssh/authorized_keys\u0026#34;}\u0026#39;) authorized_host=$(cat $authorize_file 2\u0026gt;/dev/null | awk \u0026#39;{print $3}\u0026#39; | tr \u0026#39;\\n\u0026#39; \u0026#39;,\u0026#39; | sed \u0026#39;s/,$//\u0026#39;) if [ ! -z $authorized_host ];then echo \u0026#34;$user æˆæƒ \\\u0026#34;$authorized_host\\\u0026#34; æ— å¯†ç è®¿é—®\u0026#34; fi let authorized=authorized+$(cat $authorize_file 2\u0026gt;/dev/null | awk \u0026#39;{print $3}\u0026#39;|wc -l) done echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[36m*******æ˜¯å¦å…è®¸ROOTè¿œç¨‹ç™»å½•***************\\033[0m\u0026#34; config=$(cat /etc/ssh/sshd_config | grep PermitRootLogin) firstChar=${config:0:1} if [ $firstChar == \u0026#34;#\u0026#34; ];then PermitRootLogin=\u0026#34;yes\u0026#34; else PermitRootLogin=$(echo $config | awk \u0026#39;{print $2}\u0026#39;) fi echo \u0026#34;PermitRootLogin $PermitRootLogin\u0026#34; echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[36m*************sshæœåŠ¡é…ç½®******************\\033[0m\u0026#34; cat /etc/ssh/sshd_config | grep -v \u0026#34;^#\u0026#34; | sed \u0026#39;/^$/d\u0026#39; } function getNTPStatus(){ #NTPæœåŠ¡çŠ¶æ€ï¼Œå½“å‰æ—¶é—´ï¼Œé…ç½®ç­‰ echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m***********************************************NTPæ£€æŸ¥**********************************************************\\033[0m\u0026#34; if [ -e /etc/ntp.conf ];then echo \u0026#34;NTPæœåŠ¡çŠ¶æ€ï¼š$(getState ntpd)\u0026#34; echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[36m*************NTPæœåŠ¡é…ç½®******************\\033[0m\u0026#34; cat /etc/ntp.conf 2\u0026gt;/dev/null | grep -v \u0026#34;^#\u0026#34; | sed \u0026#39;/^$/d\u0026#39; fi } function check(){ version getSystemStatus get_resource getCpuStatus getMemStatus getDiskStatus getNetworkStatus getListenStatus getProcessStatus getServiceStatus getAutoStartStatus getLoginStatus getCronStatus getUserStatus getPasswordStatus getSudoersStatus getFirewallStatus getSSHStatus getSyslogStatus getSNMPStatus getNTPStatus getInstalledStatus } #æ‰§è¡Œæ£€æŸ¥å¹¶ä¿å­˜æ£€æŸ¥ç»“æœ check \u0026gt; $RESULTFILE echo -e \u0026#34;\\033[44;37m ä¸»æœºå·¡æ£€ç»“æœå­˜æ”¾åœ¨ï¼š$RESULTFILE \\033[0m\u0026#34; #ä¸Šä¼ æ£€æŸ¥ç»“æœçš„æ–‡ä»¶ #curl -F \u0026#34;filename=@$RESULTFILE\u0026#34; \u0026#34;$uploadHostDailyCheckApi\u0026#34; 2\u0026gt;/dev/null cat $RESULTFILE ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/shell-server-inspection/","summary":"ä»£ç å¦‚ä¸‹ #!/bin/bash #å‚æ•°å®šä¹‰ date=`date +\u0026#34;%Y-%m-%d-%H:%M:%S\u0026#34;` centosVersion=$(awk \u0026#39;{print $(NF-1)}\u0026#39; /etc/redhat-release) VERSION=`date +%F` #æ—¥å¿—ç›¸å…³ LOGPATH=\u0026#34;/tmp/awr\u0026#34; [ -e $LOGPATH ] || mkdir -p $LOGPATH RESULTFILE=\u0026#34;$LOGPATH/HostCheck-`hostname`-`date +%Y%m%d`.txt\u0026#34; #è°ƒç”¨å‡½æ•°åº“ [ -f /etc/init.d/functions ] \u0026amp;\u0026amp; source /etc/init.d/functions export PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin source /etc/profile #rootç”¨æˆ·æ‰§è¡Œè„šæœ¬ [ $(id -u) -gt 0 ] \u0026amp;\u0026amp; echo \u0026#34;è¯·ç”¨rootç”¨æˆ·æ‰§è¡Œæ­¤è„šæœ¬ï¼\u0026#34; \u0026amp;\u0026amp; exit 1 function version(){ echo \u0026#34;\u0026#34; echo \u0026#34;\u0026#34; echo \u0026#34;[${date}] \u0026gt;\u0026gt;\u0026gt; `hostname -s` ä¸»æœºå·¡æ£€\u0026#34; } function getSystemStatus(){ echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m***","title":"shell | æœåŠ¡å™¨å·¡æ£€è„šæœ¬"},{"content":"0 å‰è¨€ æœ‰éœ€æ±‚éœ€è¦åœ¨ openeuler çš„æ“ä½œç³»ç»Ÿä¸Šæµ‹è¯•ä¸€ä¸ª C ç¨‹åºï¼Œåšäº†ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ç¨‹åºï¼Œç¨‹åºå¾ˆç®€å•ï¼Œå¾ªç¯è¯»å–ä¸€ä¸ªæ–‡ä»¶å¹¶æ‰“å°æ–‡ä»¶å†…å®¹ï¼Œåœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­ä½¿ç”¨ echo æ‰‹åŠ¨å‘æ–‡ä»¶ä¸­è¿½åŠ å†…å®¹ï¼Œç¨‹åºè¦èƒ½è¯»å–åˆ°ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š\næµ‹è¯•ç¨‹åºä»£ç å¦‚ä¸‹ï¼š\n#include\u0026lt;stdlib.h\u0026gt; #include\u0026lt;stdio.h\u0026gt; #include\u0026lt;unistd.h\u0026gt; int main(int argc, char **argv) { FILE *f = fopen(\u0026#34;./Syslog.log\u0026#34;, \u0026#34;rb\u0026#34;); if (f == NULL) return 1; char buffer[1024] = {0}; size_t len = 0; while(1) { len = fread(buffer, 1, sizeof(buffer), f); if (len \u0026gt; 0) { buffer[len] = \u0026#39;\\0\u0026#39;; printf(\u0026#34;read:%s\\n\u0026#34;,buffer); } else { printf(\u0026#34;noread\\n\u0026#34;); } sleep(2); } return 0; } åœ¨ Rhel-7.5 ä¸Šæµ‹è¯•ä¸€åˆ‡æ­£å¸¸ï¼Œå¼€å§‹åœ¨ openeuler ä¸Šè¿›è¡Œæµ‹è¯•ï¼Œç»“æœå‘ç°åç»­è¿½åŠ çš„å†…å®¹æ²¡æœ‰è¾“å‡ºï¼š\n1 æ•…éšœæ’æŸ¥ è€ƒè™‘åˆ°å½±å“ç¨‹åºæ‰§è¡Œç»“æœçš„å‡ ä¸ªå› ç´ ï¼šç¨‹åºæœ¬èº«ï¼Œå†…æ ¸ç‰ˆæœ¬ï¼Œgcc ç‰ˆæœ¬ï¼Œglibc ç‰ˆæœ¬ã€‚\nç¨‹åºæœ¬èº«åº”è¯¥æ˜¯æ²¡é—®é¢˜çš„ï¼Œå†…æ ¸ç‰ˆæœ¬ä¸€èˆ¬å¯¹ C è¯­è¨€ç¨‹åºçš„å½±å“ä¹Ÿä¸ä¼šå¾ˆå¤§ï¼Œè¿˜æ˜¯ä¼˜å…ˆçœ‹ gcc ç‰ˆæœ¬å’Œ glibc ç‰ˆæœ¬ã€‚\næŒ‰ç…§æ€è·¯è¿›è¡Œäº†ä¸€äº›æµ‹è¯•ï¼Œæµ‹è¯•ç»“æœï¼š\nå¯è¡Œï¼š centos7.5ï¼ˆgcc-4.8.5ï¼Œkernel-3.10ï¼Œglibc\u0026lt;=2.28ï¼‰ centos7.5ï¼ˆgcc-7.3.0ï¼Œkernel-3.10ï¼Œglibc\u0026lt;=2.28ï¼‰ centos7.5ï¼ˆgcc-7.3.0ï¼Œkernel-5.12ï¼Œglibc\u0026lt;=2.28ï¼‰ ä¸å¯è¡Œï¼š isoft-server-6.0ï¼ˆgcc-7.3.0ï¼Œ4.19.90ï¼Œglibc\u0026gt;=2.28ï¼‰ centos8ï¼ˆgcc-8.4.0ï¼Œkernel-4.18.0ï¼Œglibc\u0026gt;=2.28ï¼‰ openeuler-20.03-LTS-SP1ï¼ˆgcc-7.3.0ï¼Œkernel-4.19.90ï¼Œglibc\u0026gt;=2.28ï¼‰ æŒ‰ç…§æµ‹è¯•ç»“æœï¼Œä¼¼ä¹ gcc ç‰ˆæœ¬å’Œå†…æ ¸ç‰ˆæœ¬å¯¹ç¨‹åºæ²¡ä»€ä¹ˆå½±å“ï¼Œå¤§æ¦‚ç‡åº”è¯¥æ˜¯ glibc ç‰ˆæœ¬å¯¼è‡´çš„ã€‚ç”±äºç¨‹åºå¾ˆç®€å•ï¼Œåªæ˜¯ä»¥ rb æ–¹å¼ fopen æ‰“å¼€æ–‡ä»¶å¾ªç¯è¯»å–æ–‡ä»¶å†…å®¹ï¼Œæ±‚è¯ (google) èµ·æ¥ä¹Ÿæ¯”è¾ƒè½»æ¾ï¼Œå¾ˆå¿«å°±æ‰¾åˆ°äº†é—®é¢˜åœ¨å“ªï¼šglibc 2.28 ä¿®å¤äº† fread çš„è¡Œä¸º\nè¿™ä¸ª glibc çš„ bug æ˜¯ 05 å¹´æçš„ï¼Œåˆ° 18 å¹´æ‰ä¿®å¤ï¼Œä¹Ÿæ˜¯æ‹…å¿ƒ break ä¹‹å‰å¤§é‡çš„ä»£ç ã€‚https://sourceware.org/bugzilla/show_bug.cgi?id=1190\nç°åœ¨å†ä¿®æ”¹ä¸€ä¸‹ä»£ç ï¼š\n#include\u0026lt;stdlib.h\u0026gt; #include\u0026lt;stdio.h\u0026gt; #include\u0026lt;unistd.h\u0026gt; int main(int argc, char **argv) { FILE *f = fopen(\u0026#34;./Syslog.log\u0026#34;, \u0026#34;rb\u0026#34;); if (f == NULL) return 1; char buffer[1024] = {0}; size_t len = 0; while(1) { len = fread(buffer, 1, sizeof(buffer), f); if (len \u0026gt; 0) { buffer[len] = \u0026#39;\\0\u0026#39;; printf(\u0026#34;read:%s\\n\u0026#34;,buffer); } else { if (feof (f)) { printf(\u0026#34;Read error, clear error flag to retry...\\n\u0026#34;); clearerr (f); } } sleep(2); } return 0; } æ·»åŠ äº†ä¸€å—æ¸…é™¤æ ‡è®°çš„ç‰‡æ®µï¼Œåœ¨ glibc\u0026gt;=2.28 çš„ç³»ç»Ÿä¸Šç¨‹åºä¹Ÿå¯ä»¥æ­£å¸¸è¿è¡Œäº†\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/troubleshooting-glibc-fread/","summary":"0 å‰è¨€ æœ‰éœ€æ±‚éœ€è¦åœ¨ openeuler çš„æ“ä½œç³»ç»Ÿä¸Šæµ‹è¯•ä¸€ä¸ª C ç¨‹åºï¼Œåšäº†ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ç¨‹åºï¼Œç¨‹åºå¾ˆç®€å•ï¼Œå¾ªç¯è¯»å–ä¸€ä¸ªæ–‡ä»¶å¹¶æ‰“å°æ–‡ä»¶å†…å®¹ï¼Œåœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­ä½¿ç”¨ echo æ‰‹åŠ¨å‘æ–‡ä»¶ä¸­è¿½åŠ å†…å®¹ï¼Œç¨‹åºè¦èƒ½è¯»å–åˆ°ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š æµ‹è¯•ç¨‹åºä»£ç å¦‚ä¸‹ï¼š #include\u0026lt;stdlib.h\u0026gt; #include\u0026lt;stdio.h\u0026gt; #include\u0026lt;unistd.h\u0026gt; int main(int argc, char **argv) { FILE *f = fopen(\u0026#34;./Syslog.log\u0026#34;, \u0026#34;rb\u0026#34;); if (f == NULL) return 1; char buffer[1024] = {0}; size_t len = 0; while(1) { len = fread(buffer, 1, sizeof(buffer), f); if (len \u0026gt;","title":"troubleshooting | glibc çš„ fread é—®é¢˜"},{"content":" ","permalink":"https://www.lvbibir.cn/talk/","summary":"","title":"ğŸ’¬ è¯´è¯´"},{"content":"0 å‰è¨€ BBR ç®€ä»‹ï¼šï¼ˆBottleneck Bandwidth and RTTï¼‰æ˜¯ä¸€ç§æ–°çš„æ‹¥å¡æ§åˆ¶ç®—æ³•ï¼Œç”± Google å¼€å‘ã€‚æœ‰äº† BBRï¼ŒLinux æœåŠ¡å™¨å¯ä»¥æ˜¾ç€æé«˜ååé‡å¹¶å‡å°‘è¿æ¥å»¶è¿Ÿ\næœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\nä»‹ç»åœ¨ CentOS7 ä¸Šéƒ¨ç½² BBR çš„è¯¦ç»†è¿‡ç¨‹ 1 æ›´æ–°å†…æ ¸ æŸ¥çœ‹å½“å‰å†…æ ¸ç‰ˆæœ¬\nuname -r æ˜¾ç¤ºå½“å‰å†…æ ¸ä¸º 3.10.0ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ›´æ–°å†…æ ¸\nä½¿ç”¨ ELRepo RPM ä»“åº“å‡çº§å†…æ ¸\nrpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org //æ— è¿”å›å†…å®¹ rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm ä½¿ç”¨ ELRepo repo æ›´æ–°å®‰è£… 5.12.3 å†…æ ¸\nyum --enablerepo=elrepo-kernel install kernel-ml -y æ›´æ–°å®Œæˆåï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œç¡®è®¤æ›´æ–°ç»“æœ\nrpm -qa | grep kernel # kernel-ml-5.12.3-1.el7.elrepo.x86_64 é€šè¿‡è®¾ç½®é»˜è®¤å¼•å¯¼ä¸º grub2 ï¼Œæ¥å¯ç”¨ 5.12.3 å†…æ ¸\negrep ^menuentry /etc/grub2.cfg | cut -f 2 -d \u0026#39;\\\u0026#39; æ ¹æ®æ˜¾ç¤ºç»“æœå¾—çŸ¥ 5.12.3 å†…æ ¸å¤„äºè¡Œé¦–ï¼Œå¯¹åº”è¡Œå·ä¸º 0 æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å°†å…¶è®¾ç½®ä¸ºé»˜è®¤å¼•å¯¼é¡¹\ngrub2-set-default 0 é‡å¯ç³»ç»Ÿå¹¶ç¡®è®¤å†…æ ¸ç‰ˆæœ¬\nreboot uname -r è‡³æ­¤å®Œæˆå†…æ ¸æ›´æ–°ä¸é»˜è®¤å¼•å¯¼è®¾ç½®\n2 å¯ç”¨ BBR æ‰§è¡Œå‘½ä»¤æŸ¥çœ‹å½“å‰æ‹¥å¡æ§åˆ¶ç®—æ³•\nsysctl -n net.ipv4.tcp_congestion_control å¯ç”¨ BBR ç®—æ³•ï¼Œéœ€è¦å¯¹ sysctl.conf é…ç½®æ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼Œä¾æ¬¡æ‰§è¡Œä»¥ä¸‹æ¯è¡Œå‘½ä»¤\necho \u0026#39;net.core.default_qdisc=fq\u0026#39; | tee -a /etc/sysctl.conf echo \u0026#39;net.ipv4.tcp_congestion_control=bbr\u0026#39; | tee -a /etc/sysctl.conf sysctl -p è¿›è¡Œ BBR çš„å¯ç”¨éªŒè¯\nsysctl net.ipv4.tcp_available_congestion_control sysctl -n net.ipv4.tcp_congestion_control æœ€åæ£€æŸ¥ BBR æ¨¡å—æ˜¯å¦å·²ç»åŠ è½½\nlsmod | grep bbr ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/centos7-open-bbr/","summary":"0 å‰è¨€ BBR ç®€ä»‹ï¼šï¼ˆBottleneck Bandwidth and RTTï¼‰æ˜¯ä¸€ç§æ–°çš„æ‹¥å¡æ§åˆ¶ç®—æ³•ï¼Œç”± Google å¼€å‘ã€‚æœ‰äº† BBRï¼ŒLinux æœåŠ¡å™¨å¯ä»¥æ˜¾ç€æé«˜ååé‡å¹¶å‡å°‘è¿æ¥å»¶è¿Ÿ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: ä»‹ç»åœ¨ CentOS7 ä¸Šéƒ¨ç½² BBR çš„è¯¦ç»†è¿‡ç¨‹ 1 æ›´æ–°å†…æ ¸ æŸ¥çœ‹å½“å‰å†…æ ¸ç‰ˆæœ¬ uname -r æ˜¾ç¤ºå½“å‰å†…æ ¸ä¸º 3.10.0ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ›´æ–°å†…æ ¸ ä½¿ç”¨ ELRepo RPM ä»“åº“å‡çº§","title":"centos7 | å¼€å¯ bbr ç®—æ³•"},{"content":" è¿›å…¥ bios ä¿®æ”¹å¯åŠ¨æ¨¡å¼ï¼Œå°† UEFI æ”¹ä¸º Legacy bios é‡å¯æœåŠ¡å™¨ï¼Œctrl + r è¿›å…¥ lsi é˜µåˆ—å¡ç®¡ç† é€‰æ‹©å¯¹åº”é˜µåˆ—å¡ é…ç½®é€»è¾‘ç›˜ é…ç½®å®Œé€»è¾‘ç›˜åå¯ä»¥é€‰æ‹©ä»æŸä¸€å—é€»è¾‘ç›˜å¯åŠ¨ Ctrl-P è¿›å…¥åˆ° ctrl mgmt. -\u0026gt; TAB åˆ‡æ¢åˆ° boot device\nå›è½¦åå¯ä»¥çœ‹åˆ°å½“å‰çš„é€»è¾‘ç›˜ï¼Œä¸Šä¸‹é€‰æ‹©è¦å¼•å¯¼çš„é€»è¾‘ç›˜å³å¯ã€‚\nApply ä¿å­˜é€€å‡ºå®Œæˆã€‚\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/h3c-server-config-raid/","summary":"è¿›å…¥ bios ä¿®æ”¹å¯åŠ¨æ¨¡å¼ï¼Œå°† UEFI æ”¹ä¸º Legacy bios é‡å¯æœåŠ¡å™¨ï¼Œctrl + r è¿›å…¥ lsi é˜µåˆ—å¡ç®¡ç† é€‰æ‹©å¯¹åº”é˜µåˆ—å¡ é…ç½®é€»è¾‘ç›˜ é…ç½®å®Œé€»è¾‘ç›˜åå¯ä»¥é€‰æ‹©ä»æŸä¸€å—é€»è¾‘ç›˜å¯åŠ¨ Ctrl-P è¿›å…¥åˆ° ctrl mgmt. -\u0026gt; TAB åˆ‡æ¢åˆ° boot device å›è½¦åå¯ä»¥çœ‹åˆ°å½“å‰çš„é€»è¾‘ç›˜ï¼Œä¸Šä¸‹é€‰æ‹©è¦å¼•å¯¼çš„é€»è¾‘ç›˜å³å¯ã€‚ Apply ä¿å­˜é€€å‡ºå®Œæˆã€‚ ä»¥ä¸Š","title":"H3C æœåŠ¡å™¨é…ç½® raid"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\nCentOS ä¸Š free å‘½ä»¤è¯¦è§£ 1 CentOS6 åœ¨ CentOS6 åŠä»¥å‰çš„ç‰ˆæœ¬ä¸­ï¼Œfree å‘½ä»¤è¾“å‡ºæ˜¯è¿™æ ·çš„ï¼š\n[root@wordpress ~]# free -m total used free shared buffers cached Mem: 1002 769 233 0 62 421 -/+ buffers/cache: 286 716 Swap: 1153 0 1153 ç¬¬ä¸€è¡Œï¼š\nç³»ç»Ÿå†…å­˜ä¸»è¦åˆ†ä¸ºäº”éƒ¨åˆ†ï¼štotal(ç³»ç»Ÿå†…å­˜æ€»é‡)ï¼Œused(ç¨‹åºå·²ä½¿ç”¨å†…å­˜)ï¼Œfree(ç©ºé—²å†…å­˜)ï¼Œbuffers(buffer cache)ï¼Œcached(Page cache)ã€‚ ç³»ç»Ÿæ€»å†…å­˜ total = used + freeï¼› buffers å’Œ cached è¢«ç®—åœ¨ used é‡Œï¼Œå› æ­¤ç¬¬ä¸€è¡Œç³»ç»Ÿå·²ä½¿ç”¨å†…å­˜ used = buffers + cached + ç¬¬äºŒè¡Œç³»ç»Ÿå·²ä½¿ç”¨å†…å­˜ used ç”±äº buffers å’Œ cached åœ¨ç³»ç»Ÿéœ€è¦æ—¶å¯ä»¥è¢«å›æ”¶ä½¿ç”¨ï¼Œå› æ­¤ç³»ç»Ÿå¯ç”¨å†…å­˜ = free + buffers + cachedï¼› shared ä¸ºç¨‹åºå…±äº«çš„å†…å­˜ç©ºé—´ï¼Œå¾€å¾€ä¸º 0ã€‚ ç¬¬äºŒè¡Œï¼š\næ­£å› ä¸º buffers å’Œ cached ä¸­çš„ä¸€éƒ¨åˆ†å†…å­˜å®¹é‡åœ¨ç³»ç»Ÿéœ€è¦æ—¶å¯ä»¥è¢«å›æ”¶ä½¿ç”¨ï¼Œå› æ­¤ buffer å’Œ cached ä¸­æœ‰éƒ¨åˆ†å†…å­˜å…¶å®å¯ä»¥ç®—ä½œå¯ç”¨å†…å­˜ï¼Œå› æ­¤ï¼š ç³»ç»Ÿå·²ä½¿ç”¨å†…å­˜ï¼Œå³ç¬¬äºŒè¡Œçš„ used = total - ç¬¬äºŒè¡Œ free ç³»ç»Ÿå¯ç”¨å†…å­˜ï¼Œå³ç¬¬äºŒè¡Œçš„ free = ç¬¬ä¸€è¡Œçš„ free + buffers + cached ç¬¬ä¸‰è¡Œï¼š\n- swap å†…å­˜äº¤æ¢ç©ºé—´ä½¿ç”¨æƒ…å†µ\n2 CentOS7 CentOS7 åŠä»¥å free å‘½ä»¤çš„è¾“å‡ºå¦‚ä¸‹ï¼š\n[root@wordpress ~]# free -m total used free shared buff/cache available Mem: 1839 866 74 97 897 695 Swap: 0 0 0 buffer å’Œ cached è¢«åˆæˆä¸€ç»„ï¼ŒåŠ å…¥äº†ä¸€ä¸ª availableï¼Œå…³äºæ­¤ availableï¼Œæ–‡æ¡£ä¸Šçš„è¯´æ˜å¦‚ä¸‹ï¼š\nMemAvailable: An estimate of how much memory is available for starting new applications, without swapping.\nå³ç³»ç»Ÿå¯ç”¨å†…å­˜ï¼Œä¹‹å‰è¯´è¿‡ç”±äº buffer å’Œ cache å¯ä»¥åœ¨éœ€è¦æ—¶è¢«é‡Šæ”¾å›æ”¶ï¼Œç³»ç»Ÿå¯ç”¨å†…å­˜å³ free + buffer + cacheï¼Œåœ¨ CentOS7 ä¹‹åè¿™ç§è¯´æ³•å¹¶ä¸å‡†ç¡®ï¼Œå› ä¸ºå¹¶ä¸æ˜¯æ‰€æœ‰çš„ buffer/cache ç©ºé—´éƒ½å¯ä»¥è¢«å›æ”¶ã€‚\nå³ available = free + buffer/cache - ä¸å¯è¢«å›æ”¶å†…å­˜ (å…±äº«å†…å­˜æ®µã€tmpfsã€ramfs ç­‰)ã€‚\nå› æ­¤åœ¨ CentOS7 ä¹‹åï¼Œç”¨æˆ·ä¸éœ€è¦å»è®¡ç®— buffer/cacheï¼Œå³å¯ä»¥çœ‹åˆ°è¿˜æœ‰å¤šå°‘å†…å­˜å¯ç”¨ï¼Œæ›´åŠ ç®€å•ç›´è§‚ã€‚\n3 ç›¸å…³ä»‹ç» 3.1 buffer/cache buffer å’Œ cache æ˜¯ä¸¤ä¸ªåœ¨è®¡ç®—æœºæŠ€æœ¯ä¸­è¢«ç”¨æ»¥çš„åè¯ï¼Œæ”¾åœ¨ä¸é€šè¯­å¢ƒä¸‹ä¼šæœ‰ä¸åŒçš„æ„ä¹‰ã€‚åœ¨ Linux çš„å†…å­˜ç®¡ç†ä¸­ï¼Œè¿™é‡Œçš„ buffer æŒ‡ Linux å†…å­˜çš„ï¼š Buffer cache ã€‚è¿™é‡Œçš„ cache æŒ‡ Linux å†…å­˜ä¸­çš„ï¼š Page cache ã€‚ç¿»è¯‘æˆä¸­æ–‡å¯ä»¥å«åšç¼“å†²åŒºç¼“å­˜å’Œé¡µé¢ç¼“å­˜ã€‚åœ¨å†å²ä¸Šï¼Œå®ƒä»¬ä¸€ä¸ªï¼ˆ buffer ï¼‰è¢«ç”¨æ¥å½“æˆå¯¹ io è®¾å¤‡å†™çš„ç¼“å­˜ï¼Œè€Œå¦ä¸€ä¸ªï¼ˆ cache ï¼‰è¢«ç”¨æ¥å½“ä½œå¯¹ io è®¾å¤‡çš„è¯»ç¼“å­˜ï¼Œè¿™é‡Œçš„ io è®¾å¤‡ï¼Œä¸»è¦æŒ‡çš„æ˜¯å—è®¾å¤‡æ–‡ä»¶å’Œæ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ™®é€šæ–‡ä»¶ã€‚ä½†æ˜¯ç°åœ¨ï¼Œå®ƒä»¬çš„æ„ä¹‰å·²ç»ä¸ä¸€æ ·äº†ã€‚åœ¨å½“å‰çš„å†…æ ¸ä¸­ï¼Œ page cache é¡¾åæ€ä¹‰å°±æ˜¯é’ˆå¯¹å†…å­˜é¡µçš„ç¼“å­˜ï¼Œè¯´ç™½äº†å°±æ˜¯ï¼Œå¦‚æœæœ‰å†…å­˜æ˜¯ä»¥ page è¿›è¡Œåˆ†é…ç®¡ç†çš„ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ page cache ä½œä¸ºå…¶ç¼“å­˜æ¥ç®¡ç†ä½¿ç”¨ã€‚å½“ç„¶ï¼Œä¸æ˜¯æ‰€æœ‰çš„å†…å­˜éƒ½æ˜¯ä»¥é¡µï¼ˆ page ï¼‰è¿›è¡Œç®¡ç†çš„ï¼Œä¹Ÿæœ‰å¾ˆå¤šæ˜¯é’ˆå¯¹å—ï¼ˆ block ï¼‰è¿›è¡Œç®¡ç†çš„ï¼Œè¿™éƒ¨åˆ†å†…å­˜ä½¿ç”¨å¦‚æœè¦ç”¨åˆ° cache åŠŸèƒ½ï¼Œåˆ™éƒ½é›†ä¸­åˆ° buffer cache ä¸­æ¥ä½¿ç”¨ã€‚ï¼ˆä»è¿™ä¸ªè§’åº¦å‡ºå‘ï¼Œæ˜¯ä¸æ˜¯ buffer cache æ”¹åå«åš block cache æ›´å¥½ï¼Ÿï¼‰ç„¶è€Œï¼Œä¹Ÿä¸æ˜¯æ‰€æœ‰å—ï¼ˆ block ï¼‰éƒ½æœ‰å›ºå®šé•¿åº¦ï¼Œç³»ç»Ÿä¸Šå—çš„é•¿åº¦ä¸»è¦æ˜¯æ ¹æ®æ‰€ä½¿ç”¨çš„å—è®¾å¤‡å†³å®šçš„ï¼Œè€Œé¡µé•¿åº¦åœ¨ X86 ä¸Šæ— è®ºæ˜¯ 32 ä½è¿˜æ˜¯ 64 ä½éƒ½æ˜¯ 4k ã€‚\næ˜ç™½äº†è¿™ä¸¤å¥—ç¼“å­˜ç³»ç»Ÿçš„åŒºåˆ«ï¼Œå°±å¯ä»¥ç†è§£å®ƒä»¬ç©¶ç«Ÿéƒ½å¯ä»¥ç”¨æ¥åšä»€ä¹ˆäº†ã€‚\n3.2 page cache Page cache ä¸»è¦ç”¨æ¥ä½œä¸ºæ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ–‡ä»¶æ•°æ®çš„ç¼“å­˜æ¥ç”¨ï¼Œå°¤å…¶æ˜¯é’ˆå¯¹å½“è¿›ç¨‹å¯¹æ–‡ä»¶æœ‰ read ï¼ write æ“ä½œçš„æ—¶å€™ã€‚å¦‚æœä½ ä»”ç»†æƒ³æƒ³çš„è¯ï¼Œä½œä¸ºå¯ä»¥æ˜ å°„æ–‡ä»¶åˆ°å†…å­˜çš„ç³»ç»Ÿè°ƒç”¨ï¼š mmap æ˜¯ä¸æ˜¯å¾ˆè‡ªç„¶çš„ä¹Ÿåº”è¯¥ç”¨åˆ° page cache ï¼Ÿåœ¨å½“å‰çš„ç³»ç»Ÿå®ç°é‡Œï¼Œ page cache ä¹Ÿè¢«ä½œä¸ºå…¶å®ƒæ–‡ä»¶ç±»å‹çš„ç¼“å­˜è®¾å¤‡æ¥ç”¨ï¼Œæ‰€ä»¥äº‹å®ä¸Š page cache ä¹Ÿè´Ÿè´£äº†å¤§éƒ¨åˆ†çš„å—è®¾å¤‡æ–‡ä»¶çš„ç¼“å­˜å·¥ä½œã€‚\n3.3 buffer cache Buffer cache åˆ™ä¸»è¦æ˜¯è®¾è®¡ç”¨æ¥åœ¨ç³»ç»Ÿå¯¹å—è®¾å¤‡è¿›è¡Œè¯»å†™çš„æ—¶å€™ï¼Œå¯¹å—è¿›è¡Œæ•°æ®ç¼“å­˜çš„ç³»ç»Ÿæ¥ä½¿ç”¨ã€‚è¿™æ„å‘³ç€æŸäº›å¯¹å—çš„æ“ä½œä¼šä½¿ç”¨ buffer cache è¿›è¡Œç¼“å­˜ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨æ ¼å¼åŒ–æ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ä¸¤ä¸ªç¼“å­˜ç³»ç»Ÿæ˜¯ä¸€èµ·é…åˆä½¿ç”¨çš„ï¼Œæ¯”å¦‚å½“æˆ‘ä»¬å¯¹ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œå†™æ“ä½œçš„æ—¶å€™ï¼Œ page cache çš„å†…å®¹ä¼šè¢«æ”¹å˜ï¼Œè€Œ buffer cache åˆ™å¯ä»¥ç”¨æ¥å°† page æ ‡è®°ä¸ºä¸åŒçš„ç¼“å†²åŒºï¼Œå¹¶è®°å½•æ˜¯å“ªä¸€ä¸ªç¼“å†²åŒºè¢«ä¿®æ”¹äº†ã€‚è¿™æ ·ï¼Œå†…æ ¸åœ¨åç»­æ‰§è¡Œè„æ•°æ®çš„å›å†™ï¼ˆ writeback ï¼‰æ—¶ï¼Œå°±ä¸ç”¨å°†æ•´ä¸ª page å†™å›ï¼Œè€Œåªéœ€è¦å†™å›ä¿®æ”¹çš„éƒ¨åˆ†å³å¯ã€‚\n3.4 å›æ”¶ cache Linux å†…æ ¸ä¼šåœ¨å†…å­˜å°†è¦è€—å°½çš„æ—¶å€™ï¼Œè§¦å‘å†…å­˜å›æ”¶çš„å·¥ä½œï¼Œä»¥ä¾¿é‡Šæ”¾å‡ºå†…å­˜ç»™æ€¥éœ€å†…å­˜çš„è¿›ç¨‹ä½¿ç”¨ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ“ä½œä¸­ä¸»è¦çš„å†…å­˜é‡Šæ”¾éƒ½æ¥è‡ªäºå¯¹ buffer ï¼ cache çš„é‡Šæ”¾ã€‚å°¤å…¶æ˜¯è¢«ä½¿ç”¨æ›´å¤šçš„ cache ç©ºé—´ã€‚æ—¢ç„¶å®ƒä¸»è¦ç”¨æ¥åšç¼“å­˜ï¼Œåªæ˜¯åœ¨å†…å­˜å¤Ÿç”¨çš„æ—¶å€™åŠ å¿«è¿›ç¨‹å¯¹æ–‡ä»¶çš„è¯»å†™é€Ÿåº¦ï¼Œé‚£ä¹ˆåœ¨å†…å­˜å‹åŠ›è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼Œå½“ç„¶æœ‰å¿…è¦æ¸…ç©ºé‡Šæ”¾ cache ï¼Œä½œä¸º free ç©ºé—´åˆ†ç»™ç›¸å…³è¿›ç¨‹ä½¿ç”¨ã€‚æ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è®¤ä¸º buffer/cache ç©ºé—´å¯ä»¥è¢«é‡Šæ”¾ï¼Œè¿™ä¸ªç†è§£æ˜¯æ­£ç¡®çš„ã€‚\nä½†æ˜¯è¿™ç§æ¸…ç¼“å­˜çš„å·¥ä½œä¹Ÿå¹¶ä¸æ˜¯æ²¡æœ‰æˆæœ¬ã€‚ç†è§£ cache æ˜¯å¹²ä»€ä¹ˆçš„å°±å¯ä»¥æ˜ç™½æ¸…ç¼“å­˜å¿…é¡»ä¿è¯ cache ä¸­çš„æ•°æ®è·Ÿå¯¹åº”æ–‡ä»¶ä¸­çš„æ•°æ®ä¸€è‡´ï¼Œæ‰èƒ½å¯¹ cache è¿›è¡Œé‡Šæ”¾ã€‚æ‰€ä»¥ä¼´éšç€ cache æ¸…é™¤çš„è¡Œä¸ºçš„ï¼Œä¸€èˆ¬éƒ½æ˜¯ç³»ç»Ÿ IO é£™é«˜ã€‚å› ä¸ºå†…æ ¸è¦å¯¹æ¯” cache ä¸­çš„æ•°æ®å’Œå¯¹åº”ç¡¬ç›˜æ–‡ä»¶ä¸Šçš„æ•°æ®æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´éœ€è¦å†™å›ï¼Œä¹‹åæ‰èƒ½å›æ”¶ã€‚\nåœ¨ç³»ç»Ÿä¸­é™¤äº†å†…å­˜å°†è¢«è€—å°½çš„æ—¶å€™å¯ä»¥æ¸…ç¼“å­˜ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ä¸‹é¢è¿™ä¸ªæ–‡ä»¶æ¥äººå·¥è§¦å‘ç¼“å­˜æ¸…é™¤çš„æ“ä½œ\n[root@tencent64 ~]# cat /proc/sys/vm/drop_caches æ–¹æ³•æ˜¯ï¼š\necho 3 \u0026gt; /proc/sys/vm/drop_caches å½“ç„¶ï¼Œè¿™ä¸ªæ–‡ä»¶å¯ä»¥è®¾ç½®çš„å€¼åˆ†åˆ«ä¸º 1 ã€ 2 ã€ 3 ã€‚å®ƒä»¬æ‰€è¡¨ç¤ºçš„å«ä¹‰ä¸ºï¼š\nè¡¨ç¤ºæ¸…é™¤ pagecache echo 1 \u0026gt; /proc/sys/vm/drop_caches è¡¨ç¤ºæ¸…é™¤å›æ”¶ slab åˆ†é…å™¨ä¸­çš„å¯¹è±¡ï¼ˆåŒ…æ‹¬ç›®å½•é¡¹ç¼“å­˜å’Œ inode ç¼“å­˜ï¼‰ã€‚ slab åˆ†é…å™¨æ˜¯å†…æ ¸ä¸­ç®¡ç†å†…å­˜çš„ä¸€ç§æœºåˆ¶ï¼Œå…¶ä¸­å¾ˆå¤šç¼“å­˜æ•°æ®å®ç°éƒ½æ˜¯ç”¨çš„ pagecache echo 2 \u0026gt; /proc/sys/vm/drop_caches è¡¨ç¤ºæ¸…é™¤ pagecache å’Œ slab åˆ†é…å™¨ä¸­çš„ç¼“å­˜å¯¹è±¡ã€‚ echo 3 \u0026gt; /proc/sys/vm/drop_caches ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/linux-command-free/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: CentOS ä¸Š free å‘½ä»¤è¯¦è§£ 1 CentOS6 åœ¨ CentOS6 åŠä»¥å‰çš„ç‰ˆæœ¬ä¸­ï¼Œfree å‘½ä»¤è¾“å‡ºæ˜¯è¿™æ ·çš„ï¼š [root@wordpress ~]# free -m total used free shared buffers cached Mem: 1002 769 233 0 62 421 -/+ buffers/cache: 286 716 Swap: 1153 0 1153 ç¬¬ä¸€è¡Œï¼š ç³»ç»Ÿå†…å­˜ä¸»è¦åˆ†ä¸ºäº”éƒ¨åˆ†ï¼štotal(ç³»ç»Ÿå†…å­˜æ€»é‡)ï¼Œused(ç¨‹åºå·²ä½¿ç”¨å†…å­˜)ï¼Œfree(ç©ºé—²å†…å­˜)ï¼Œbuffers(buffer ca","title":"linux | free å‘½ä»¤è¯¦è§£"},{"content":"1 pxe ç¯å¢ƒ dhcp+tftp+http\npxe-serverï¼šisoft-serveros-v4.2ï¼ˆ3.10.0-957.el7.isoft.x86_64ï¼‰\nå¼•å¯¼çš„ isoï¼šisoft-serveros-aarch64-oe1-v5.1ï¼ˆ4.19.90-2003.4.0.0036.oe1.aarch64ï¼‰\nç‰©ç†æœåŠ¡å™¨ï¼šæµªæ½® Inspur\n2 dhcpd.conf é…ç½® [root@localhost isoft-5.1-arm]# vim /etc/dhcp/dhcpd.conf default-lease-time 43200; max-lease-time 345600; option space PXE; option arch code 93 = unsigned integer 16; option routers 192.168.1.1; option subnet-mask 255.255.255.0; option broadcast-address 192.168.1.255; option time-offset -18000; ddns-update-style none; allow client-updates; allow booting; allow bootp; next-server 192.168.1.1; if option arch = 00:07 or arch = 00:09 { filename \u0026#34;x86/bootx64.efi\u0026#34;; } else { filename \u0026#34;arm/grubaa64.efi\u0026#34;; } shared-network works { subnet 192.168.1.0 netmask 255.255.255.0 { range dynamic-bootp 192.168.1.221 192.168.1.253; } } 3 grub.cfg é…ç½® [root@localhost tftpboot]# vim arm/grub.cfg set default=\u0026#34;0\u0026#34; function load_video { if [ x$feature_all_video_module = xy ]; then insmod all_video else insmod efi_gop insmod efi_uga insmod ieee1275_fb insmod vbe insmod vga insmod video_bochs insmod video_cirrus fi } load_video set gfxpayload=keep insmod gzio insmod part_gpt insmod ext2 set timeout=60 ### END /etc/grub.d/00_header ### search --no-floppy --set=root -l \u0026#39;iSoftServerOS-5.1-aarch64\u0026#39; ### BEGIN /etc/grub.d/10_linux ### menuentry \u0026#39;Install iSoftServerOS 5.1 with GUI mode\u0026#39; --class red --class gnu-linux --class gnu --class os { # linux /images/pxeboot/vmlinuz inst.stage2=hd:LABEL=iSoftServerOS-5.1-aarch64 ro inst.geoloc=0 selinux=0 # initrd /images/pxeboot/initrd.img linux /arm51/vmlinuz ip=dhcp method=http://192.168.1.1/isoft-5.1-arm ks=http://192.168.1.1/isoft-5.1-arm/anaconda-ks.cfg initrd /arm51/initrd.img } #menuentry \u0026#39;Install iSoftServerOS 5.1 for ZF with GUI mode\u0026#39; --class red --class gnu-linux --class gnu --class os { # linux /arm51-zf/vmlinuz ip=dhcp method=http://192.168.1.1/isoft-5.1-zfarm # initrd /arm51-zf/initrd.img #} 4 ks.cfg é…ç½® [root@localhost isoft-5.1-arm]# vim anaconda-ks.cfg lang zh_CN.UTF-8 # Network information network --bootproto=dhcp --device=eno1 --ipv6=auto --no-activate network --bootproto=dhcp --device=eno2 --ipv6=auto network --bootproto=dhcp --device=eno3 --ipv6=auto network --bootproto=dhcp --device=eno4 --ipv6=auto network --bootproto=dhcp --device=enp22s0f0 --ipv6=auto network --bootproto=dhcp --device=enp22s0f1 --ipv6=auto network --bootproto=dhcp --device=enp22s0f2 --ipv6=auto network --bootproto=dhcp --device=enp22s0f3 --ipv6=auto network --hostname=localhost.localdomain # Root password rootpw --iscrypted $6$afv9h6qEnQTq3WSl$GHtOmvLkHrBin8vTWLbRaa2r.Ur9mUQR7XypWRoEWZYCwwJ2MnuMPxpNiNLSG1vSa5qBODHJcqIUUWkHm0IVl. # SELinux configuration selinux --disabled # X Window System configuration information xconfig --startxonboot # Run the Setup Agent on first boot firstboot --enable # System services services --enabled=\u0026#34;chronyd\u0026#34; # System timezone timezone Asia/Shanghai --isUtc user --groups=wheel --name=testuser --password=$6$9SyzoTjQU2syj2Bk$SQ4WZAV/go3KeX6rJN3cieNpY4l7aU2wHxad75yWlbKBh.ithhrU/jfA09JUq7cb10D0QTCwtClmItfg/N47t. --iscrypted --gecos=\u0026#34;testuser\u0026#34; # Disk partitioning information part /boot/efi --fstype=\u0026#34;efi\u0026#34; --ondisk=sda --size=200 --fsoptions=\u0026#34;umask=0077,shortname=winnt\u0026#34; part pv.521 --fstype=\u0026#34;lvmpv\u0026#34; --ondisk=sda --size=913974 part /boot --fstype=\u0026#34;ext4\u0026#34; --ondisk=sda --size=1024 volgroup isoftserveros --pesize=4096 pv.521 logvol /home --fstype=\u0026#34;xfs\u0026#34; --size=756272 --name=home --vgname=isoftserveros logvol swap --fstype=\u0026#34;swap\u0026#34; --size=4096 --name=swap --vgname=isoftserveros logvol / --fstype=\u0026#34;xfs\u0026#34; --size=153600 --name=root --vgname=isoftserveros %packages @^mate-desktop-environment @additional-devel @development @file-server @headless-management @legacy-unix @network-server @network-tools @scientific @security-tools @system-tools @virtual-tools %end %anaconda pwpolicy root --minlen=8 --minquality=1 --notstrict --nochanges --notempty pwpolicy user --minlen=8 --minquality=1 --notstrict --nochanges --emptyok pwpolicy luks --minlen=8 --minquality=1 --notstrict --nochanges --notempty %end reboot ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/pxe-inspur-isoft5.1-aarch64/","summary":"1 pxe ç¯å¢ƒ dhcp+tftp+http pxe-serverï¼šisoft-serveros-v4.2ï¼ˆ3.10.0-957.el7.isoft.x86_64ï¼‰ å¼•å¯¼çš„ isoï¼šisoft-serveros-aarch64-oe1-v5.1ï¼ˆ4.19.90-2003.4.0.0036.oe1.aarch64ï¼‰ ç‰©ç†æœ","title":"pxe å®‰è£… isoft-5.1(aarch64)"},{"content":"å‰ç«¯æ—¶é—´åœ¨å›½å®¶ä¿¡æ¯ä¸­å¿ƒçš„ä¸€ä¸ªé¡¹ç›®ä¸Šéœ€è¦åœ¨ H3C æœåŠ¡å™¨ä¸Šå®‰è£…æ“ä½œç³»ç»Ÿç„¶åé…ç½®ä¸€å¥— spring boot é¡¹ç›®ï¼Œç»“æœåœ¨è£…æ“ä½œç³»ç»Ÿè¿‡ç¨‹ä¸­å°±é‡åˆ°äº†é—®é¢˜ï¼šå®‰è£…å®Œæ“ä½œç³»ç»Ÿåæ— æ³•è‡ªåŠ¨å¼•å¯¼ï¼Œåªèƒ½é€šè¿‡é‡å¯æœåŠ¡å™¨æŒ‰ F7 è¿›å…¥å¼•å¯¼é€‰é¡¹ï¼Œé€‰æ‹©å¯¹åº”çš„é€»è¾‘ç›˜æ‰èƒ½æ­£å¸¸å¼•å¯¼\næœåŠ¡å™¨æœ‰ 7 å—ç‰©ç†ç£ç›˜ï¼Œå‰ä¸¤å—æ˜¯ 600 GB çš„æœºæ¢°ç›˜ï¼Œåäº”å—æ˜¯ 1T çš„æœºæ¢°ç›˜ï¼Œå‰ä¸¤å— 600GB çš„ç›˜åšäº† raid1 ï¼Œå‰©ä¸‹çš„ 5 å—ç›˜ï¼Œé€‰æ‹© n+2 åš raid6 ã€‚\nè§„åˆ’æ˜¯è¿™æ ·çš„ï¼Œæ“ä½œç³»ç»Ÿå®‰è£…åœ¨ raid6 ä¸Šï¼Œraid1 é‚£å—é€»è¾‘ç£ç›˜ç­‰ç³»ç»Ÿå®‰è£…å®Œåå†è¿›è¡ŒæŒ‚è½½ï¼Œç”¨ä½œä¸šåŠ¡çš„æ•°æ®å¤‡ä»½ã€‚\nå®‰è£…å®Œä¹‹åå´å‘ç°æœ‰å¾ˆå¤šå°ç³»ç»Ÿå¼•å¯¼ä¸èµ·æ¥ï¼Œå¿…é¡»æ‰‹åŠ¨å¼•å¯¼ï¼Œåªæœ‰ä¸€å°å¯ä»¥é‡å¯åç›´æ¥è¿›å…¥ç³»ç»Ÿã€‚ä¸ºäº†å¿«é€Ÿè§£å†³é—®é¢˜ï¼Œè¿˜æ˜¯ç¬¬ä¸€æ—¶é—´è”ç³»äº† H3C çš„å”®åå¼€å·¥å•è§£å†³ï¼Œç»“æœä¸è¨€è€Œå–»ï¼Œä¸šåŠ¡æ°´å¹³å ªå¿§ï¼Œå¹¶æ²¡æœ‰è§£å†³ã€‚ä¸è¿‡ä¹Ÿç»™æˆ‘æä¾›äº†ä¸€äº›æ€è·¯ã€‚\næ•´ç†ä¸€ä¸‹æ€è·¯ï¼š\nå‡ºç°é—®é¢˜ä¹‹åæ›´æ¢å®‰è£…ä»‹è´¨é‡æ–°å®‰è£…äº†ä¸¤æ¬¡ï¼Œé—®é¢˜éƒ½æ˜¯ä¸€æ ·çš„ ç³»ç»Ÿå®‰è£…è¿™å—æ“ä½œè‚¯å®šæ²¡é—®é¢˜ï¼Œé‚£é—®é¢˜å°±å‡ºåœ¨ç¡¬ä»¶ä¸Šé¢äº† å¼€å§‹å¯»æ‰¾ç¡¬ä»¶ä¸Šé¢çš„é—®é¢˜ï¼ŒæœåŠ¡å™¨éƒ½æ˜¯å…¨æ–°çš„ï¼Œåªæ˜¯åšäº† raid ã€‚è¯¢é—®äº†ä¸‹åš raid çš„åŒäº‹ï¼Œçœ‹å¯ä»¥æ­£å¸¸å¼•å¯¼çš„æœåŠ¡å™¨å’Œéæ­£å¸¸å¼•å¯¼çš„æœåŠ¡å™¨ä¹‹é—´ raid é…ç½®æœ‰ä½•ä¸åŒ\né—®é¢˜ä¼°è®¡æ‰¾åˆ°äº†ï¼šæ­£å¸¸æœåŠ¡å™¨æ˜¯å…ˆåˆ›å»ºçš„ raid6 ï¼Œå‰©ä¸‹çš„éƒ½æ˜¯å…ˆåˆ›å»ºçš„ raid1ã€‚\nè§£å†³æ–¹æ¡ˆï¼š\nç³»ç»Ÿéœ€è¦é‡è£…ï¼šåˆ é™¤åŸå…ˆå·²ç»åˆ›å»ºå¥½çš„ raidï¼Œå…ˆåˆ›å»ºç³»ç»Ÿä½¿ç”¨çš„ raid6. ç³»ç»Ÿæ— éœ€é‡è£…ï¼šåˆ é™¤æ‰ raid1 ï¼Œä¿å­˜åé‡æ–°åˆ›å»º raid1ã€‚è¿™æ—¶ï¼Œraid6 çš„é¡ºä½ä¼šæ¯” raid1 é«˜ï¼Œç³»ç»Ÿå°±å¯ä»¥æ­£å¸¸å¯åŠ¨äº† æœ€ç»ˆæˆ‘ä»¬è¿™è¾¹é‡‡å–çš„æ˜¯ç¬¬äºŒç§æ–¹æ¡ˆ\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/troubleshooting-h3c-server-can-not-boot-system/","summary":"å‰ç«¯æ—¶é—´åœ¨å›½å®¶ä¿¡æ¯ä¸­å¿ƒçš„ä¸€ä¸ªé¡¹ç›®ä¸Šéœ€è¦åœ¨ H3C æœåŠ¡å™¨ä¸Šå®‰è£…æ“ä½œç³»ç»Ÿç„¶åé…ç½®ä¸€å¥— spring boot é¡¹ç›®ï¼Œç»“æœåœ¨è£…æ“ä½œç³»ç»Ÿè¿‡ç¨‹ä¸­å°±é‡åˆ°äº†é—®é¢˜ï¼šå®‰è£…å®Œæ“ä½œç³»ç»Ÿåæ— æ³•è‡ªåŠ¨å¼•å¯¼ï¼Œåªèƒ½é€šè¿‡é‡å¯æœåŠ¡å™¨æŒ‰ F7 è¿›å…¥å¼•å¯¼é€‰é¡¹ï¼Œé€‰æ‹©å¯¹åº”çš„é€»è¾‘ç›˜æ‰èƒ½æ­£å¸¸å¼•å¯¼ æœåŠ¡å™¨æœ‰ 7 å—ç‰©ç†ç£ç›˜ï¼Œå‰ä¸¤å—æ˜¯ 600 GB çš„æœºæ¢°ç›˜ï¼Œåäº”å—æ˜¯ 1T çš„æœºæ¢°ç›˜ï¼Œå‰","title":"troubleshooting | H3C æœåŠ¡å™¨è£…å®Œç³»ç»Ÿæ— æ³•å¼•å¯¼"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\nä»èƒ½ç”¨åˆ°å¥½ç”¨-å¿«é€Ÿæ­å»ºé«˜æ€§èƒ½WordPressæŒ‡å— å‰æ®µæ—¶é—´ç€æ‰‹å¼€å§‹æ­å»ºè‡ªå·±çš„ wordpress åšå®¢ï¼Œåˆšå¼€å§‹å›¾æ–¹ä¾¿ç›´æ¥ä¹°äº†é˜¿é‡Œäº‘çš„è½»é‡åº”ç”¨æœåŠ¡å™¨ï¼Œå®ƒæ˜¯ä¸€å¥—é¢„å…ˆæ­å»ºå¥½çš„ lamp æ¶æ„ï¼Œå¹¶å·²ç»åšäº†ä¸€äº›åˆå§‹åŒ–é…ç½®ï¼Œç›´æ¥è®¿é—® ip å°±å¯ä»¥è¿›è¡Œ wordpress çš„å®‰è£…å’Œé…ç½®äº†ã€‚\nè¿™å¥— wordpress çš„ä¸€ä¸ªéå¸¸å¥½çš„ä¼˜ç‚¹å°±æ˜¯å¯ä»¥åœ¨é˜¿é‡Œäº‘çš„æ§åˆ¶å°ä¸€é”®é…ç½® https è¯ä¹¦ï¼Œå½“ç„¶ä»…é™åœ¨é˜¿é‡Œäº‘è´­ä¹°çš„ ssl è¯ä¹¦\nåç»­è¿˜æ˜¯å†³å®šå°† wordpress æ•´ä½“è¿ç§»åˆ° docker ä¸­ï¼Œå…¨éƒ¨æœåŠ¡éƒ½ç”¨ docker è·‘ã€‚è¿™æ ·åªè¦æ•°æ®åšå¥½æŒä¹…åŒ–ï¼Œä½¿ç”¨ docker çš„çµæ´»æ€§ä¼šå¥½å¾ˆå¤šï¼Œåšå…¨ç«™å¤‡ä»½å’Œè¿ç§»ä¹Ÿå¾ˆæ–¹ä¾¿ã€‚\n1 å¤‡ä»½\u0026amp;è¿ç§» wordpress è¿ç§»èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„ï¼Œéœ€è¦å¤‡ä»½çš„å†…å®¹å¤§æ¦‚æœ‰è¿™äº›ï¼šæ’ä»¶ã€ä¸»é¢˜ã€uploadsã€æ•°æ®åº“\nå¤‡ä»½æ’ä»¶ï¼šUpdraftPlusï¼Œè¿™æ˜¯ä¸€æ¬¾ä¸ªäººä½¿ç”¨è¿‡ä¸€æ¬¾æ¯”è¾ƒä¼˜ç§€çš„å¤‡ä»½/è¿ç§»æ’ä»¶ï¼Œå…è´¹ç‰ˆçš„åŠŸèƒ½åŸºæœ¬æ»¡è¶³å¤§éƒ¨åˆ†äººéœ€æ±‚ï¼Œæ”¯æŒæ‰‹åŠ¨å¤‡ä»½å’Œå®šæ—¶å¤‡ä»½ã€å¤‡ä»½å’Œæ¢å¤éƒ½æ”¯æŒéƒ¨åˆ†å¤‡ä»½ï¼Œæ¯”å¦‚åªå¤‡ä»½æ•°æ®åº“ï¼Œåªæ¢å¤æ•°æ®åº“çš„æŸä¸€å¼ è¡¨ã€‚\nå…è´¹ç‰ˆçš„å¹¶ä¸æ”¯æŒ wordpress è¿ç§»ï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¼å…¥å¯¼å‡ºå¤‡ä»½æ–‡ä»¶çš„æ–¹å¼å®ç°ç«™ç‚¹è¿ç§»ï¼Œå‰ææ˜¯åšå¥½æµ‹è¯•ã€‚\nå¤‡ä»½æ­¥éª¤ï¼š\nåœ¨å¤‡ä»½æ’ä»¶ä¸­æ‰‹åŠ¨å¤‡ä»½ä¸€æ¬¡ ä¸‹è½½å¤‡ä»½æ–‡ä»¶ è¿ç§»æ­¥éª¤ï¼š\nå‡†å¤‡å¥½ç³»ç»Ÿç¯å¢ƒå’Œ docker ç¯å¢ƒï¼ˆdocker-composeï¼‰ å¯åŠ¨ docker å®¹å™¨ http è®¿é—® wordpress åœ°å€åˆå§‹åŒ–å®‰è£… å®‰è£…å¤‡ä»½æ’ä»¶å’Œ ssl æ’ä»¶ï¼ˆreally simple sslï¼‰ ä¸Šä¼ å¤‡ä»½æ–‡ä»¶å¹¶è¿›è¡Œæ¢å¤æ“ä½œï¼ˆä¸æ¢å¤ wp-options è¡¨ï¼‰ ä¸º nginx åä»£æœåŠ¡å™¨é…ç½® ssl è¯ä¹¦ï¼Œå¼€å¯ https è®¿é—® åœ¨ really simple ssl ä¸­ä¸º wordpress å¯ç”¨ https æ¢å¤ wp-options è¡¨ 1.1 æ‰‹åŠ¨å¤‡ä»½\u0026amp;ä¸‹è½½å¤‡ä»½æ–‡ä»¶ å¤‡ä»½å®Œä¹‹åå¯ä»¥ç›´æ¥ä» web ç«¯ä¸‹è½½ï¼Œä½†æ˜¯å»ºè®®ä» web ç«¯ä¸‹è½½ä¸€ä»½ï¼Œé€šè¿‡ ssh æˆ–è€… ftp ç­‰æ–¹å¼å†ä¸‹è½½ä¸€ä»½ï¼Œé¿å…å¤‡ä»½æ–‡ä»¶å‡ºç°é—®é¢˜\nå¤‡ä»½çš„æ–‡ä»¶åœ¨ wordpressç›®å½•/wp-content/updraft ç›®å½•ä¸­\né€šè¿‡ scp ä¸‹è½½åˆ°æœ¬åœ°\n1.2 å‡†å¤‡ç³»ç»Ÿç¯å¢ƒ å®‰è£…å¥½ docker å’Œ docker-compose å³å¯ï¼Œdocker çš„å®‰è£…å’Œä½¿ç”¨æ•™ç¨‹åœ¨æœ¬åšå®¢ä¸­ docker åˆ†ç±»æœ‰\n1.3 docker-compose ä¸€é”®å¯åŠ¨ wordpress ç¯å¢ƒ è¿™é‡Œæˆ‘æä¾›äº†ä¸€é”®éƒ¨ç½²çš„ docker-compose æ–‡ä»¶å’Œå„æœåŠ¡è¿›è¡Œäº†ä¼˜åŒ–çš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥æ‹¿æ¥ç”¨ ä¸‹è½½é“¾æ¥\næ³¨æ„ï¼š\nä½¿ç”¨å‰å»ºè®®ä¿®æ”¹æ•°æ®åº“ç›¸å…³ä¿¡æ¯\nå»ºè®®ä¸è¦éšæ„æ”¹åŠ¨ ip\næ‰€æœ‰çš„æ•°æ®æ–‡ä»¶å’Œé…ç½®æ–‡ä»¶é»˜è®¤éƒ½åœ¨å½“å‰çš„ç›®å½•ä¸‹\nå¦‚æœå‰é¢ä¸åŠ  nginx åä»£ï¼Œè®°å¾—æŠŠæ³¨é‡Šæ‰çš„ç«¯å£æ˜ å°„æ”¹æˆè‡ªå·±æƒ³è¦çš„\næ‰€æœ‰çš„é…ç½®æ–‡ä»¶éƒ½åœ¨ nginx ç›®å½•ä¸‹ï¼Œå·²ç»é¢„å…ˆå®šä¹‰å¥½ï¼Œå¯ä»¥è‡ªè¡Œè¿›è¡Œä¿®æ”¹\nå†…ç½®çš„ wordpress ç›®å½•æƒé™ç”¨æˆ·å’Œç»„æ˜¯ 33:tape\nversion: \u0026#39;3.1\u0026#39; services: proxy: image: superng6/nginx:debian-stable-1.18.0 container_name: nginx-proxy restart: always networks: wordpress_net: ipv4_address: 172.19.0.6 ports: - 80:80 - 443:443 volumes: - /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro - $PWD/conf/proxy/nginx.conf:/etc/nginx/nginx.conf - $PWD/conf/proxy/default.conf:/etc/nginx/conf.d/default.conf - $PWD/ssl:/etc/nginx/ssl - $PWD/logs/proxy:/var/log/nginx depends_on: - web web: image: superng6/nginx:debian-stable-1.18.0 container_name: wordpress-nginx restart: always networks: wordpress_net: ipv4_address: 172.19.0.5 volumes: - /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro - $PWD/conf/nginx/nginx.conf:/etc/nginx/nginx.conf - $PWD/conf/nginx/default.conf:/etc/nginx/conf.d/default.conf - $PWD/conf/fastcgi.conf:/etc/nginx/fastcgi.conf - /dev/shm/nginx-cache:/var/run/nginx-cache # - $PWD/nginx-cache:/var/run/nginx-cache - $PWD/wordpress:/var/www/html - $PWD/logs/nginx:/var/log/nginx depends_on: - wordpress wordpress: image: wordpress:5-fpm container_name: wordpress-php restart: always networks: wordpress_net: ipv4_address: 172.19.0.4 environment: WORDPRESS_DB_HOST: db WORDPRESS_DB_USER: wordpress WORDPRESS_DB_PASSWORD: wordpress WORDPRESS_DB_NAME: wordpress volumes: - /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro - $PWD/wordpress:/var/www/html - /dev/shm/nginx-cache:/var/run/nginx-cache # - $PWD/nginx-cache:/var/run/nginx-cache - $PWD/conf/uploads.ini:/usr/local/etc/php/php.ini depends_on: - redis - db redis: image: redis:5 container_name: wordpress-redis restart: always networks: wordpress_net: ipv4_address: 172.19.0.3 volumes: - /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro - $PWD/redis-data:/data depends_on: - db db: image: mysql:5.7 container_name: wordpress-mysql restart: always networks: wordpress_net: ipv4_address: 172.19.0.2 environment: MYSQL_DATABASE: wordpress MYSQL_USER: wordpress MYSQL_PASSWORD: wordpress MYSQL_RANDOM_ROOT_PASSWORD: \u0026#39;1\u0026#39; volumes: - /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro - $PWD/mysql-data:/var/lib/mysql - $PWD/conf/mysqld.cnf:/etc/mysql/mysql.conf.d/mysqld.cnf networks: wordpress_net: driver: bridge ipam: config: - subnet: 172.19.0.0/16 è¿›å…¥åˆ° wordpress-blog ç›®å½•ä¸‹ä½¿ç”¨ docker-compose up -d å¯åŠ¨ docker å®¹å™¨\n1.4 é…ç½® nginx åå‘ä»£ç† é…ç½® 80 å’Œ 443 ç«¯å£çš„åä»£\næŠŠåŸŸåã€è¯ä¹¦è·¯å¾„ä»¥åŠåç«¯æœåŠ¡å™¨ç­‰ä¿¡æ¯æ¢æˆè‡ªå·±çš„\nå…è´¹ ssl è¯ä¹¦çš„ç”³è¯·æˆ‘åœ¨ é˜¿é‡Œäº‘wordpressé…ç½®å…è´¹sslè¯ä¹¦ ä¸­ä»‹ç»è¿‡ï¼Œç›´æ¥ä¸‹è½½ nginx ç‰ˆçš„è¯ä¹¦æ”¾åˆ° wordpress-blog/ssl/ç›®å½•ä¸‹å³å¯\n[root@lvbibir ~]# vim wordpress-blog/conf/proxy/default.conf server { listen 80; listen [::]:80; server_name lvbibir.cn; # return 301 https://$host$request_uri; location / { proxy_pass http://172.19.0.5:80; proxy_redirect off; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Real-Port $remote_port; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header HTTP_X_FORWARDED_FOR $remote_addr; proxy_set_header X-Forwarded-Proto $scheme; proxy_set_header Host $host; proxy_set_header X-NginX-Proxy true; } } server { listen 443 ssl http2; listen [::]:443 ssl http2; server_name lvbibir.cn; location / { proxy_pass http://172.19.0.5:80; proxy_redirect off; # ä¿è¯è·å–åˆ°çœŸå®IP proxy_set_header X-Real-IP $remote_addr; # çœŸå®ç«¯å£å· proxy_set_header X-Real-Port $remote_port; # X-Forwarded-For æ˜¯ä¸€ä¸ª HTTP æ‰©å±•å¤´éƒ¨ã€‚ proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # åœ¨å¤šçº§ä»£ç†çš„æƒ…å†µä¸‹ï¼Œè®°å½•æ¯æ¬¡ä»£ç†ä¹‹å‰çš„å®¢æˆ·ç«¯çœŸå®ip proxy_set_header HTTP_X_FORWARDED_FOR $remote_addr; # è·å–åˆ°çœŸå®åè®® proxy_set_header X-Forwarded-Proto $scheme; # çœŸå®ä¸»æœºå proxy_set_header Host $host; # è®¾ç½®å˜é‡ proxy_set_header X-NginX-Proxy true; # å¼€å¯ brotli proxy_set_header Accept-Encoding \u0026#34;gzip\u0026#34;; } # æ—¥å¿— access_log /var/log/nginx/access.log; error_log /var/log/nginx/error.log; # è¯ä¹¦ ssl_certificate /etc/nginx/ssl/lvbibir.cn.pem; ssl_certificate_key /etc/nginx/ssl/lvbibir.cn.key; # curl https://ssl-config.mozilla.org/ffdhe2048.txt \u0026gt; /path/to/dhparam # ssl_dhparam /etc/nginx/ssl/dhparam; # HSTS (ngx_http_headers_module is required) (63072000 seconds) add_header Strict-Transport-Security \u0026#34;max-age=63072000\u0026#34; always; # OCSP stapling ssl_stapling on; ssl_stapling_verify on; # verify chain of trust of OCSP response using Root CA and Intermediate certs # ssl_trusted_certificate /etc/nginx/ssl/all.sleele.com/fullchain.cer; # replace with the IP address of your resolver resolver 223.5.5.5; resolver_timeout 5s; } [root@lvbibir ~]# docker exec -i nginx-proxy nginx -s reload 1.5 å®‰è£… wordpress ç°åœ¨å·²ç»å¯ä»¥é€šè¿‡ http è®¿é—® nginx åä»£çš„ 80 ç«¯å£è®¿é—® wordpress äº†\nå®‰è£…ä¿¡æ¯è·Ÿä¹‹å‰ç«™ç‚¹è®¾ç½®ä¸€æ ·å³å¯\n1.6 æ¢å¤å¤‡ä»½ å®‰è£…å¥½ä¹‹åå¯ç”¨æ’ä»¶ï¼ŒæŠŠå¤‡ä»½æ–‡ä»¶ä¸Šä¼ åˆ°å¤‡ä»½ç›®å½•\nè®°å¾—ä¿®æ”¹æƒé™\n[root@lvbibir ~]# chown -R 33:tape wordpress-blog/wordpress/wp-content/ æ¢å¤å¤‡ä»½\næ³¨ï¼šå¦‚æœç«™ç‚¹ä¹‹å‰å¼€å¯äº† httpsï¼Œåœ¨è¿™æ­¥ä¸è¦æ¢å¤ wp-options è¡¨ï¼Œä¸ç„¶ä¼šå¯¼è‡´åå°è®¿é—®ä¸äº†\nç‚¹å‡»æ¢å¤å³å¯\n1.7 é…ç½® ssl å¯ç”¨ really simple ssl æ’ä»¶ï¼Œå› ä¸ºä¹‹å‰åœ¨ nginx åä»£é…ç½®äº† ssl è¯ä¹¦ï¼Œè™½ç„¶æˆ‘ä»¬æ²¡æœ‰é€šè¿‡ https è®¿é—®ï¼Œä½†æ˜¯è¿™ä¸ªæ’ä»¶å·²ç»æ£€æµ‹åˆ°äº†è¯ä¹¦ï¼Œå¯ä»¥ä¸€é”®ä¸º wordpress é…ç½® ssl\nè¿™é‡Œæˆ‘ä»¬å·²ç»å¯ä»¥é€šè¿‡ https è®¿é—®æˆ‘ä»¬çš„ wordpress äº†\nç«™ç‚¹è·¯å¾„è¯¥æ’ä»¶ä¹Ÿä¼šè‡ªåŠ¨ä¿®æ”¹ï¼Œä¹‹å‰ä¸æ¢å¤ wp-options è¡¨çš„åŸå› å°±åœ¨è¿™ï¼Œåœ¨æˆ‘ä»¬æ²¡æœ‰é…ç½®å¥½ ssl ä¹‹å‰ï¼Œç›´æ¥è¦†ç›– wordpress çš„å„é¡¹è®¾ç½®ä¼šå¯¼è‡´ç«™ç‚¹è®¿é—®ä¸äº†ï¼Œé‡å®šå‘å¾ªç¯ç­‰å„ç§å„æ ·çš„é—®é¢˜ã€‚\n1.8 æ¢å¤ wp-options è¡¨ å¼€å¯äº† ssl ä¹‹åï¼Œé€šè¿‡å¤‡ä»½æ’ä»¶å†æ¢å¤ä¸€æ¬¡ï¼Œå¯ä»¥åªæ¢å¤ä¸€å¼  wp-options è¡¨ï¼Œä¹Ÿå¯ä»¥å†å…¨é‡æ¢å¤ä¸‹æ•°æ®åº“ï¼Œè‡³æ­¤ï¼Œç«™ç‚¹è¿ç§»å·¥ä½œåŸºæœ¬å®Œæˆäº†ã€‚\n2 åç»­ä¼˜åŒ– 2.1 å¼€å¯ https å¼ºåˆ¶è·³è½¬ å¼€å¯ https å¼ºåˆ¶è·³è½¬åï¼Œæ‰€æœ‰ä½¿ç”¨ http è®¿é—®æˆ‘ä»¬ç«™ç‚¹çš„è¯·æ±‚éƒ½ä¼šè½¬åˆ° httpsï¼Œæé«˜ç«™ç‚¹å®‰å…¨æ€§\n[root@lvbibir ~]# vim /etc/nginx/nginx.conf server { listen 80; listen [::]:80; server_name lvbibir.cn; return 301 https://$host$request_uri; } server { listen 443 ssl http2; listen [::]:443 ssl http2; server_name lvbibir.cn; location / { proxy_pass http://172.19.0.5:80; proxy_redirect off; # ä¿è¯è·å–åˆ°çœŸå®IP proxy_set_header X-Real-IP $remote_addr; # çœŸå®ç«¯å£å· proxy_set_header X-Real-Port $remote_port; # X-Forwarded-For æ˜¯ä¸€ä¸ª HTTP æ‰©å±•å¤´éƒ¨ã€‚ proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # åœ¨å¤šçº§ä»£ç†çš„æƒ…å†µä¸‹ï¼Œè®°å½•æ¯æ¬¡ä»£ç†ä¹‹å‰çš„å®¢æˆ·ç«¯çœŸå®ip proxy_set_header HTTP_X_FORWARDED_FOR $remote_addr; # è·å–åˆ°çœŸå®åè®® proxy_set_header X-Forwarded-Proto $scheme; # çœŸå®ä¸»æœºå proxy_set_header Host $host; # è®¾ç½®å˜é‡ proxy_set_header X-NginX-Proxy true; # å¼€å¯ brotli proxy_set_header Accept-Encoding \u0026#34;gzip\u0026#34;; } # æ—¥å¿— access_log /var/log/nginx/access.log; error_log /var/log/nginx/error.log; # è¯ä¹¦ ssl_certificate /etc/nginx/ssl/lvbibir.cn.pem; ssl_certificate_key /etc/nginx/ssl/lvbibir.cn.key; # curl https://ssl-config.mozilla.org/ffdhe2048.txt \u0026gt; /path/to/dhparam # ssl_dhparam /etc/nginx/ssl/dhparam; # HSTS (ngx_http_headers_module is required) (63072000 seconds) add_header Strict-Transport-Security \u0026#34;max-age=63072000\u0026#34; always; # OCSP stapling ssl_stapling on; ssl_stapling_verify on; # verify chain of trust of OCSP response using Root CA and Intermediate certs # ssl_trusted_certificate /etc/nginx/ssl/all.sleele.com/fullchain.cer; # replace with the IP address of your resolver resolver 223.5.5.5; resolver_timeout 5s; } [root@lvbibir ~]# docker exec -i nginx-proxy nginx -s reload 2.2 å¼€å¯ redis ç¼“å­˜ wordpressæ­é…redisåŠ é€Ÿç½‘ç«™è®¿é—®é€Ÿåº¦\n2.3 æ­é… jsdelivr-CDN å®ç°å…¨ç«™ cdn WordPress+jsDelivrå¼€å¯ä¼ªå…¨ç«™CDN\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/blog/wordpress-to-docker/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: ä»èƒ½ç”¨åˆ°å¥½ç”¨-å¿«é€Ÿæ­å»ºé«˜æ€§èƒ½WordPressæŒ‡å— å‰æ®µæ—¶é—´ç€æ‰‹å¼€å§‹æ­å»ºè‡ªå·±çš„ wordpress åšå®¢ï¼Œåˆšå¼€å§‹å›¾æ–¹ä¾¿ç›´æ¥ä¹°äº†é˜¿é‡Œäº‘çš„è½»é‡åº”ç”¨æœåŠ¡å™¨ï¼Œå®ƒæ˜¯ä¸€å¥—é¢„å…ˆæ­å»ºå¥½çš„ lamp æ¶æ„ï¼Œå¹¶å·²ç»åšäº†ä¸€äº›åˆå§‹åŒ–é…ç½®ï¼Œç›´æ¥è®¿é—® ip å°±å¯ä»¥è¿›è¡Œ wordpress çš„å®‰è£…å’Œé…ç½®äº†ã€‚ è¿™å¥— wordpress çš„ä¸€ä¸ªéå¸¸å¥½çš„ä¼˜ç‚¹å°±æ˜¯å¯ä»¥åœ¨é˜¿","title":"wordpress | è¿ç§»åˆ° docker"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥\ncentos6 æºç ç¼–è¯‘ openvpn å¹¶æ‰“åŒ…æˆ rpm openvpn æºç ä¸‹è½½åœ°å€ centos6 æ­å»º openvpn centos6 åšç«¯å£æ˜ å°„/ç«¯å£è½¬å‘ 1 å®éªŒç¯å¢ƒ 3 å° centos6.5ï¼Œ1 å° win10ï¼Œopenvpn-2.4.7ï¼Œeasy-rsa-3.0.5\n2 æ‹“æ‰‘ç»“æ„ Win10 å®‰è£… openvpn-guiï¼Œä¸‰å° centos6.5 ä¸º vmware è™šæ‹Ÿæœºï¼Œåˆ†ä¸º clientã€vpnserverã€proxy\nä¸‰å° centos6.5 çš„ eth0 ç½‘å¡å‡ä¸ºå†…ç½‘ (lan åŒºæ®µ) åœ°å€ 1.1.1.0/24 ç½‘æ®µï¼Œproxy é¢å¤–æ·»åŠ ä¸€å— eth1 ç½‘å¡è®¾ç½® nat æ¨¡å¼æ¨¡æ‹Ÿå¤–ç½‘ ip\n3 å®éªŒç›®çš„ win10 è®¿é—® proxy çš„å¤–ç½‘ ip å¯¹åº”ç«¯å£è¿æ¥åˆ° vpnserverï¼Œåˆ†é…åˆ°å†…ç½‘ ip åå¯ä»¥è®¿é—®åˆ° client\n4 å®éªŒæ€è·¯ proxy é…ç½® ipv4 è½¬å‘ï¼Œå°†è®¿é—®åˆ°æœ¬æœº eth1 ç½‘å¡ç›¸å¯¹åº”çš„ç«¯å£ä¸Šçš„æµé‡è½¬å‘ç»™ vpnserver çš„ vpn æœåŠ¡ç«¯å£\nvpnserver ä¸º win10 åˆ†é… ip å®ç°è®¿é—®å†…ç½‘\n5 å®æ–½æ­¥éª¤ 5.1 åˆå§‹åŒ–ç¯å¢ƒ é…ç½® ip èŠ‚ç‚¹ ip clientï¼š 1.1.1.1/24 vpnserverï¼š 1.1.1.2/24 proxyï¼š 1.1.1.3/24 192.168.150.114/24 win10ï¼š 192.168.150.1/24 ç¯å¢ƒåˆå§‹åŒ–ï¼ˆclient å’Œ vpnserver å…³é—­ iptables å’Œ selinuxï¼Œproxy ä»…å…³é—­ selinuxï¼‰ sed -i \u0026#39;/SELINUX/s/enforcing/disabled/\u0026#39; /etc/selinux/config setenforce 0 5.2 å®‰è£… vpnserver \u0026amp; easy-rsa vpnserver å®‰è£… openvpn ç”±äº centos6 çš„æ‰€æœ‰å®˜æ–¹æºå·²å¤±æ•ˆï¼Œä½¿ç”¨ æ­¤é“¾æ¥ ä¸­çš„æ–¹æ³•å°†æºç ç¼–è¯‘æˆ rpm åŒ…ã€‚\nopenvpn ç‰ˆæœ¬ï¼š2.4.7\nä¸‹è½½ easy-rsa ä¸‹è½½åœ°å€ 5.3 åˆ›å»ºç›®å½•ï¼Œé…ç½® vars è§£å‹ easy-rsa ç›®å½• [root@vpnserver ~]# mkdir openvpn [root@vpnserver ~]# unzip easy-rsa-3.0.5.zip [root@vpnserver ~]# mv easy-rsa-3.0.5 easy-rsa [root@vpnserver ~]# mkdir -p /etc/openvpn [root@vpnserver ~]# cp -a easy-rsa /etc/openvpn é…ç½®/etc/openvpn ç›®å½• [root@vpnserver ~]# cd /etc/openvpn/easy-rsa/easyrsa3/ [root@vpnserver easyrsa3]# cp vars.example vars [root@vpnserver easyrsa3]# vim vars æ·»åŠ å¦‚ä¸‹å˜é‡\nset_var EASYRSA_REQ_COUNTRY \u0026#34;CN\u0026#34; set_var EASYRSA_REQ_PROVINCE \u0026#34;Beijing\u0026#34; set_var EASYRSA_REQ_CITY \u0026#34;Beijing\u0026#34; set_var EASYRSA_REQ_ORG \u0026#34;lvbibir\u0026#34; set_var EASYRSA_REQ_EMAIL \u0026#34;lvbibir@163.com\u0026#34; set_var EASYRSA_REQ_OU \u0026#34;My OpenVPN\u0026#34; 5.4 åˆ›å»ºæœåŠ¡ç«¯è¯ä¹¦åŠ key åˆ›å»ºæœåŠ¡ç«¯è¯ä¹¦åŠ key åˆå§‹åŒ–\n[root@vpnserver ~]# cd /etc/openvpn/easy-rsa/easyrsa3/ [root@vpnserver easyrsa3]# ./easyrsa init-pki åˆ›å»ºæ ¹è¯ä¹¦\n[root@vpnserver easyrsa3]# ./easyrsa build-ca æ³¨æ„ï¼šåœ¨ä¸Šè¿°éƒ¨åˆ†éœ€è¦è¾“å…¥ PEM å¯†ç  PEM pass phraseï¼Œè¾“å…¥ä¸¤æ¬¡ï¼Œæ­¤å¯†ç å¿…é¡»è®°ä½ï¼Œä¸ç„¶ä»¥åä¸èƒ½ä¸ºè¯ä¹¦ç­¾åã€‚è¿˜éœ€è¦è¾“å…¥ common name é€šç”¨åï¼Œè¿™ä¸ªä½ è‡ªå·±éšä¾¿è®¾ç½®ä¸ªç‹¬ä¸€æ— äºŒçš„\nåˆ›å»ºæœåŠ¡å™¨ç«¯è¯ä¹¦\n[root@vpnserver easyrsa3]# ./easyrsa gen-req server nopass è¯¥è¿‡ç¨‹ä¸­éœ€è¦è¾“å…¥ common nameï¼Œéšæ„ä½†æ˜¯ä¸è¦è·Ÿä¹‹å‰çš„æ ¹è¯ä¹¦çš„ä¸€æ ·\nç­¾çº¦æœåŠ¡ç«¯è¯ä¹¦\n[root@vpnserver easyrsa3]# ./easyrsa sign server server éœ€è¦æ‰‹åŠ¨è¾“å…¥ yes ç¡®è®¤ï¼Œè¿˜éœ€è¦æä¾›åˆ›å»º ca è¯ä¹¦æ—¶çš„å¯†ç \nåˆ›å»º Diffie-Hellmanï¼Œç¡®ä¿ key ç©¿è¶Šä¸å®‰å…¨ç½‘ç»œçš„å‘½ä»¤\n[root@vpnserver easyrsa3]# ./easyrsa gen-dh 5.5 åˆ›å»ºå®¢æˆ·ç«¯è¯ä¹¦åŠ key åˆ›å»ºå®¢æˆ·ç«¯è¯ä¹¦ åˆå§‹åŒ–\n[root@vpnserver ~]# mkdir client [root@vpnserver ~]# cd client/easy-rsa/easyrsa3/ [root@vpnserver easyrsa3]# ./easyrsa init-pki éœ€è¾“å…¥ yes ç¡®è®¤\nåˆ›å»ºå®¢æˆ·ç«¯ key åŠç”Ÿæˆè¯ä¹¦\n[root@vpnserver easyrsa3]# ./easyrsa gen-req zhijie.liu åå­—è‡ªå·±è‡ªå®šä¹‰ï¼Œè¯¥å¯†ç æ˜¯ç”¨æˆ·ä½¿ç”¨è¯¥ key ç™»å½•æ—¶è¾“å…¥çš„å¯†ç ï¼Œå¯ä»¥åŠ  nopass å‚æ•°åœ¨å®¢æˆ·ç«¯ç™»å½•æ—¶æ— éœ€è¾“å…¥å¯†ç \nå¯¼å…¥ req è¯ä¹¦\n[root@vpnserver ~]# cd /etc/openvpn/easy-rsa/easyrsa3/ [root@vpnserver easyrsa3]# ./easyrsa import-req /root/client/easy-rsa/easyrsa3/pki/reqs/zhijie.liu.req zhijie.liu ç­¾çº¦è¯ä¹¦\n[root@vpnserver easyrsa3]# ./easyrsa sign client zhijie.liu è¿™é‡Œç”Ÿæˆ clientï¼Œåå­—è¦ä¸ä¹‹å‰å¯¼å…¥åå­—ä¸€è‡´\nç­¾çº¦è¯ä¹¦æœŸé—´éœ€è¦è¾“å…¥ yes ç¡®è®¤ï¼ŒæœŸé—´éœ€è¦è¾“å…¥ CA çš„å¯†ç \n5.6 å½’ç½®è¯ä¹¦ æŠŠæœåŠ¡å™¨ç«¯å¿…è¦æ–‡ä»¶æ”¾åˆ°/etc/openvpn ä¸‹ï¼ˆca è¯ä¹¦ã€æœåŠ¡ç«¯è¯ä¹¦ã€å¯†é’¥ï¼‰ [root@vpnserver ~]# cp /etc/openvpn/easy-rsa/easyrsa3/pki/ca.crt /etc/openvpn/ [root@vpnserver ~]# cp /etc/openvpn/easy-rsa/easyrsa3/pki/private/server.key /etc/openvpn/ [root@vpnserver ~]# cp /etc/openvpn/easy-rsa/easyrsa3/pki/issued/server.crt /etc/openvpn/ [root@vpnserver ~]# cp /etc/openvpn/easy-rsa/easyrsa3/pki/dh.pem /etc/openvpn/ æŠŠå®¢æˆ·ç«¯å¿…è¦æ–‡ä»¶æ”¾åˆ°/root/client ç›®å½•ä¸‹ï¼ˆå®¢æˆ·ç«¯çš„è¯ä¹¦ã€å¯†é’¥ï¼‰ [root@vpnserver ~]# cp /etc/openvpn/easy-rsa/easyrsa3/pki/ca.crt /root/client [root@vpnserver ~]# cp /etc/openvpn/easy-rsa/easyrsa3/pki/issued/zhijie.liu.crt /root/client/ [root@vpnserver ~]# cp /root/client/easy-rsa/easyrsa3/pki/private/zhijie.liu.key /root/client 5.7 server.conf é…ç½® ä¸ºæœåŠ¡å™¨ç«¯ç¼–å†™é…ç½®æ–‡ä»¶ å®‰è£…å¥½é…ç½®æ–‡ä»¶åä»–ä¼šæä¾›ä¸€ä¸ª server é…ç½®çš„æ–‡ä»¶æ¡ˆä¾‹ï¼Œå°†è¯¥æ–‡ä»¶æ”¾åˆ°/etc/openvpn ä¸‹\n[root@vpnserver ~]# rpm -ql openvpn | grep server.conf [root@vpnserver ~]# cp /usr/share/doc/openvpn-2.4.7/sample/sample-config-files/server.conf /etc/openvpn/ ä¿®æ”¹é…ç½®æ–‡ä»¶ [root@vpnserver ~]# vim /etc/openvpn/server.conf [root@vpnserver ~]# grep \u0026#39;^[^#|;]\u0026#39; /etc/openvpn/server.conf local 0.0.0.0 #ç›‘å¬åœ°å€ port 1194 #ç›‘å¬ç«¯å£ proto tcp #ç›‘å¬åè®® dev tun #é‡‡ç”¨è·¯ç”±éš§é“æ¨¡å¼ ca /etc/openvpn/ca.crt #caè¯ä¹¦è·¯å¾„ cert /etc/openvpn/server.crt #æœåŠ¡å™¨è¯ä¹¦ key /etc/openvpn/server.key # This file should be kept secret æœåŠ¡å™¨ç§˜é’¥ dh /etc/openvpn/dh.pem #å¯†é’¥äº¤æ¢åè®®æ–‡ä»¶ server 10.8.0.0 255.255.255.0 #ç»™å®¢æˆ·ç«¯åˆ†é…åœ°å€æ± ï¼Œæ³¨æ„ï¼šä¸èƒ½å’ŒVPNæœåŠ¡å™¨å†…ç½‘ç½‘æ®µæœ‰ç›¸åŒ ifconfig-pool-persist ipp.txt push \u0026#34;route 1.1.1.0 255.255.255.0\u0026#34;\t#æ¨é€å†…ç½‘åœ°å€ client-to-client #å®¢æˆ·ç«¯ä¹‹é—´äº’ç›¸é€šä¿¡ keepalive 10 120 #å­˜æ´»æ—¶é—´ï¼Œ10ç§’pingä¸€æ¬¡,120 å¦‚æœªæ”¶åˆ°å“åº”åˆ™è§†ä¸ºæ–­çº¿ comp-lzo #ä¼ è¾“æ•°æ®å‹ç¼© max-clients 100 #æœ€å¤šå…è®¸ 100 å®¢æˆ·ç«¯è¿æ¥ user openvpn #ç”¨æˆ· group openvpn #ç”¨æˆ·ç»„ persist-key persist-tun status /var/log/openvpn/openvpn-status.log log /var/log/openvpn/openvpn.log verb 3 5.8 å…¶ä»–è®¾ç½® ç”¨æˆ·é…ç½® [root@vpnserver ~]# mkdir /var/log/openvpn/ [root@vpnserver ~]# useradd openvpn -s /sbin/nologin [root@vpnserver ~]# chown -R openvpn.openvpn /var/log/openvpn/ [root@vpnserver ~]# chown -R openvpn.openvpn /etc/openvpn/* iptables è®¾ç½® nat è§„åˆ™å’Œæ‰“å¼€è·¯ç”±è½¬å‘ [root@vpnserver ~]# iptables -A INPUT -p tcp --dport 1194 -j ACCEPT [root@vpnserver ~]# iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE [root@vpnserver ~]# iptables -vnL -t nat Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes) pkts bytes target prot opt in out source destination Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes) pkts bytes target prot opt in out source destination 0 0 MASQUERADE all -- * * 10.8.0.0/24 0.0.0.0/0 Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes) pkts bytes target prot opt in out source destination [root@vpnserver ~]# vim /etc/sysctl.conf net.ipv4.ip_forward = 1 [root@vpnserver ~]# sysctl -p å¼€å¯ openvpn æœåŠ¡ [root@vpnserver ~]# openvpn --daemon --config /etc/openvpn/server.conf [root@vpnserver ~]# netstat -anput | grep 1194 proxy å¼€å¯ç«¯å£è½¬å‘/æ˜ å°„ [root@along ~]# vim /etc/sysctl.conf //æ‰“å¼€è·¯ç”±è½¬å‘ net.ipv4.ip_forward = 1 [root@proxy ~]# sysctl -p [root@proxy ~]# iptables -t nat -A PREROUTING -d 192.168.150.114 -p tcp --dport 1194 -j DNAT --to-destination 1.1.1.2:1194 [root@proxy ~]# iptables -t nat -A POSTROUTING -d 1.1.1.2 -p tcp --dport 1194 -j SNAT --to 1.1.1.3 [root@proxy ~]# iptables -A FORWARD -o eth0 -d 1.1.1.2 -p tcp --dport 1194 -j ACCEPT [root@proxy ~]# iptables -A FORWARD -i eth0 -s 1.1.1.2 -p tcp --sport 1194 -j ACCEPT [root@proxy ~]# iptables -A INPUT -p tcp --dport 1194 -j ACCEPT [root@proxy ~]# service iptables save [root@proxy ~]# service iptables reload [root@proxy ~]# iptables -L -n 6 å®¢æˆ·æ®µè¿æ¥æµ‹è¯• 6.1 client é…ç½®æ–‡ä»¶ [root@vpnserver ~]# rpm -ql openvpn | grep client.ovpn /usr/share/doc/openvpn-2.4.7/sample/sample-plugins/keying-material-exporter-demo/client.ovpn [root@vpnserver ~]# cp /usr/share/doc/openvpn-2.4.7/sample/sample-plugins/keying-material-exporter-demo/client.ovpn /root/client [root@vpnserver ~]# vim /root/client/client.ovpn client dev tun proto tcp remote 192.168.150.114 1194 resolv-retry infinite nobind persist-key persist-tun ca ca.crt cert client.crt key client.key comp-lzo verb 3 6.2 æ‹·è´å®¢æˆ·ç«¯è¯ä¹¦åŠé…ç½®æ–‡ä»¶ vpnserver æ²¡è£… vmtools æ‰€ä»¥å…ˆå°†æ‰€æœ‰æ–‡ä»¶æ”¾åˆ° proxy ä¸Šç„¶åé€šè¿‡ scp ä¸‹è½½\n[root@vpnserver openvpn]# scp /root/client/ca.crt root@1.1.1.3:/root/ [root@vpnserver openvpn]# scp /root/client/zhijie.liu.crt root@1.1.1.3:/root/ [root@vpnserver openvpn]# scp /root/client/zhijie.liu.key root@1.1.1.3:/root/ [root@vpnserver openvpn]# scp /root/client/client.ovpn root@1.1.1.3:/root/ å°†è¿™å››ä¸ªæ–‡ä»¶æ”¾åˆ° win10 çš„ C:\\Users\\lvbibir\\OpenVPN\\config ç›®å½•ä¸‹\nç„¶åç‚¹å‡»è¿æ¥\n6.3 ping æµ‹è¯• ping client çš„å†…ç½‘ ip 1.1.1.1\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/centos6-deploy-openvpn/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥ centos6 æºç ç¼–è¯‘ openvpn å¹¶æ‰“åŒ…æˆ rpm openvpn æºç ä¸‹è½½åœ°å€ centos6 æ­å»º openvpn centos6 åšç«¯å£æ˜ å°„/ç«¯å£è½¬å‘ 1 å®éªŒç¯å¢ƒ 3 å° centos6.5ï¼Œ1 å° win10ï¼Œopenvpn-2.4.7ï¼Œeasy-rsa-3.0.5 2 æ‹“æ‰‘ç»“æ„ Win10 å®‰è£… openvpn-guiï¼Œä¸‰å° centos6.5 ä¸º vmware è™šæ‹Ÿæœºï¼Œåˆ†ä¸º clientã€vpnse","title":"centos6 éƒ¨ç½² openvpn"},{"content":"0 ä»‹ç» é¡¹ç›®åœ°å€\nè¿™ä¸ªé¡¹ç›®å‡†å¤‡æ‰“é€ ä¸€ä¸ªå®‰å…¨åŸºçº¿æ£€æŸ¥å¹³å°ï¼ŒæœŸæœ›èƒ½å¤Ÿä»¥æœ€ç®€å•çš„æ–¹å¼åœ¨éœ€è¦è¿›è¡Œæ£€æŸ¥çš„æœåŠ¡å™¨ä¸Šè¿è¡Œã€‚èƒ½å¤Ÿè¾¾åˆ°è¿™ä¹ˆä¸€ç§æ•ˆæœï¼šåŸºçº¿æ£€æŸ¥è„šæœ¬ (ä»¥åç§°ä¹‹ä¸º agent) å¯ä»¥å•ç‹¬åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œå¹¶å±•ç¤ºå‡ºç›¸åº”ä¸ç¬¦åˆåŸºçº¿çš„åœ°æ–¹ï¼Œå¹¶ä¸”å¯ä»¥å°†æ£€æŸ¥æ—¶æœé›†åˆ°çš„ä¿¡æ¯ä»¥ json ä¸²çš„å½¢å¼ä¸Šä¼ åˆ°åç«¯å¤„ç†æœåŠ¡å™¨ä¸Šï¼Œåç«¯æœåŠ¡å™¨å¯ä»¥è¿›è¡Œç»Ÿè®¡å¹¶è¿›è¡Œå¯è§†åŒ–å±•ç¤ºã€‚\nAgent ç”¨åˆ°çš„æŠ€æœ¯ï¼š\nShell è„šæœ¬ Powershell è„šæœ¬ åç«¯æœåŠ¡å™¨ç”¨åˆ°çš„æŠ€æœ¯ï¼š\npython django bootstrap html å­˜å‚¨æ‰€ç”¨ï¼š\nsqlite3 1 å‰ç«¯é¡µé¢éƒ¨ç½² 1.1 ç¯å¢ƒ ç³»ç»Ÿ centos7.8(æœ€å°åŒ–å®‰è£…) å‰ç«¯ï¼š192.168.150.101 client ç«¯ï¼š192.168.150.102 1.2 å®‰è£… python3.6 æºç åŒ…ä¸‹è½½åœ°å€\nyum install gcc gcc-c++ zlib-devel sqlite-devel mariadb-server mariadb-devel openssl-devel tcl-devel tk-devel tree libffi-devel -y tar -xf Python-3.6.10.tgz ./configure --enable-optimizations make make install python3 -V 1.3 å®‰è£… pip3+django æºç åŒ…ä¸‹è½½åœ°å€\ntar zxvf pip-21.0.1.tar.gz cd pip-21.0.1/ python3 setup.py build python3 setup.py install pip3 install django==2.2.15 1.4 clone é¡¹ç›®åˆ°æœ¬åœ° yum install -y git git clone https://github.com/chroblert/assetmanage.git 1.5 éƒ¨ç½² server ç«¯ cd assetManage # ä½¿ç”¨ python3 å®‰è£…ä¾èµ–åŒ… python3 -m pip install -r requirements.txt python3 manage.py makemigrations python3 manage.py migrate python3 manage.py runserver 0.0.0.0:8888 # å‡å®šè¯¥æœåŠ¡å™¨çš„ IP ä¸º 112.112.112.112 è®¿é—®æµ‹è¯•ï¼šhttp://192.168.150.101:8888/\n2 å®¢æˆ·ç«¯è¿›è¡Œæ£€æŸ¥ å°†é¡¹ç›®ç›®å½•ä¸­çš„ Agent ç›®å½• copy åˆ°éœ€è¦è¿›è¡ŒåŸºçº¿æ£€æŸ¥çš„å®¢æˆ·ç«¯ scp -r assetmanage/Agent/ 192.168.150.102:/root/ cd Agent/ chmod a+x ./*.sh ä¿®æ”¹ linux_baseline_check.sh æ–‡ä»¶çš„æœ€åä¸€è¡Œï¼Œé…ç½®å‰ç«¯ django é¡¹ç›®çš„ ip å’Œç«¯å£ è¿è¡Œè„šæœ¬å³å¯ï¼Œç»ˆç«¯ä¼šæœ‰æ£€æŸ¥ç»“æœçš„è¾“å‡ºï¼Œå‰ç«¯é¡µé¢ç›¸åº”ä¹Ÿä¼šæœ‰æ•°æ® ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/centos7-deploy-benchmark/","summary":"0 ä»‹ç» é¡¹ç›®åœ°å€ è¿™ä¸ªé¡¹ç›®å‡†å¤‡æ‰“é€ ä¸€ä¸ªå®‰å…¨åŸºçº¿æ£€æŸ¥å¹³å°ï¼ŒæœŸæœ›èƒ½å¤Ÿä»¥æœ€ç®€å•çš„æ–¹å¼åœ¨éœ€è¦è¿›è¡Œæ£€æŸ¥çš„æœåŠ¡å™¨ä¸Šè¿è¡Œã€‚èƒ½å¤Ÿè¾¾åˆ°è¿™ä¹ˆä¸€ç§æ•ˆæœï¼šåŸºçº¿æ£€æŸ¥è„šæœ¬ (ä»¥åç§°ä¹‹ä¸º agent) å¯ä»¥å•ç‹¬åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œå¹¶å±•ç¤ºå‡ºç›¸åº”ä¸ç¬¦åˆåŸºçº¿çš„åœ°æ–¹ï¼Œå¹¶ä¸”å¯ä»¥å°†æ£€æŸ¥æ—¶æœé›†åˆ°çš„ä¿¡æ¯ä»¥ json ä¸²çš„å½¢å¼ä¸Šä¼ åˆ°åç«¯å¤„ç†æœåŠ¡å™¨ä¸Šï¼Œåç«¯æœ","title":"centos7 | benchmark å¹³å°éƒ¨ç½²"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\nç½‘å¡çš„ HWADDR å’Œ MACADDR çš„åŒºåˆ« LINUX ç³»ç»Ÿä¸­ HWaddr å’Œ macaddr ä»€ä¹ˆåŒºåˆ« Linux æ°¸ä¹…ç”Ÿæ•ˆ MAC 1 è¯¦è§£ ç¯å¢ƒï¼šcentos7.8\nåœ¨ centos ä¸­å¯ä»¥åœ¨å¦‚ä¸‹æ–‡ä»¶ä¸­æŸ¥çœ‹ä¸€ä¸ª NIC çš„é…ç½® ï¼š /etc/sysconfig/network-scripts/ifcfg-N\nHWADDR=, å…¶ä¸­ ä»¥ AA:BB:CC:DD:EE:FF å½¢å¼çš„ä»¥å¤ªç½‘è®¾å¤‡çš„ç¡¬ä»¶åœ°å€.åœ¨æœ‰å¤šä¸ªç½‘å¡è®¾å¤‡çš„æœºå™¨ä¸Šï¼Œè¿™ä¸ªå­—æ®µæ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œå®ƒä¿è¯è®¾å¤‡æ¥å£è¢«åˆ†é…äº†æ­£ç¡®çš„è®¾å¤‡å ï¼Œè€Œä¸è€ƒè™‘æ¯ä¸ªç½‘å¡æ¨¡å—è¢«é…ç½®çš„åŠ è½½é¡ºåº.è¿™ä¸ªå­—æ®µä¸èƒ½å’Œ MACADDR ä¸€èµ·ä½¿ç”¨.\nMACADDR=, å…¶ä¸­ ä»¥ AA:BB:CC:DD:EE:FF å½¢å¼çš„ä»¥å¤ªç½‘è®¾å¤‡çš„ç¡¬ä»¶åœ°å€.åœ¨æœ‰å¤šä¸ªç½‘å¡è®¾å¤‡çš„æœºå™¨ä¸Š.è¿™ä¸ªå­—æ®µç”¨äºç»™ä¸€ä¸ªæ¥å£åˆ†é…ä¸€ä¸ª MAC åœ°å€ï¼Œè¦†ç›–ç‰©ç†åˆ†é…çš„ MAC åœ°å€ . è¿™ä¸ªå­—æ®µä¸èƒ½å’Œ HWADDR ä¸€èµ·ä½¿ç”¨.\nç®€å•æ€»ç»“ä¸€ä¸‹ï¼š\nMACADDR æ˜¯ç³»ç»Ÿçš„ç½‘å¡ç‰©ç†åœ°å€ï¼Œå› ä¸ºåœ¨æ¥æ”¶æ•°æ®åŒ…æ—¶éœ€è¦æ ¹æ®è¿™ä¸ªå€¼æ¥åšåŒ…è¿‡æ»¤ã€‚ HWADDR æ˜¯ç½‘å¡çš„ç¡¬ä»¶ç‰©ç†åœ°å€ï¼Œåªæœ‰å‚å®¶æ‰èƒ½ä¿®æ”¹ å¯ä»¥ç”¨ MACADDR æ¥è¦†ç›– HWADDRï¼Œä½†è¿™ä¸¤ä¸ªå‚æ•°ä¸èƒ½åŒæ—¶ä½¿ç”¨ ifconfig å’Œ nmcli ç­‰ç½‘ç»œå‘½ä»¤ä¸­æ˜¾ç¤ºçš„ç‰©ç†åœ°å€å…¶å®æ˜¯ MACADDR çš„å€¼ï¼Œè™½ç„¶æ˜¾ç¤ºçš„åç§°å†™çš„æ˜¯ HWADDR(ether)ã€‚ ä¿®æ”¹ç½‘å¡çš„ mac åœ°å€\n#sudo vim /etc/sysconfig/network-scripts/ifcfg-ens32 æ³¨é‡Šå…¶ä¸­çš„\u0026#34;HWADDR=xx:xx:xx:xx:xx:xx\u0026#34; æ·»åŠ æˆ–è€…ä¿®æ”¹\u0026#34;MACADDR=xx:xx:xx:xx:xx:xx\u0026#34; å¦‚æœæ²¡æœ‰åˆ é™¤æˆ–è€…æ³¨é‡Šæ‰HWADDRï¼Œå½“HWADDRä¸MACADDRåœ°åœ°ä¸åŒæ—¶ï¼Œå¯åŠ¨ä¸äº†ç½‘ç»œæœåŠ¡çš„æç¤ºï¼šã€€â€œBringing up interface eth0: Device eth0 has different MAC address than expected,ignoring.â€ æ•…æ­£ç¡®çš„æ“ä½œæ˜¯å°†HWADDRåˆ é™¤æˆ–æ³¨é‡Šæ‰ï¼Œæ”¹æˆMACADDR æŸ¥çœ‹ç³»ç»Ÿåˆå§‹çš„ mac åœ°å€å³ HWADDR æŠŠé…ç½®æ–‡ä»¶ä¸­çš„ MACADDR æ³¨é‡Šæˆ–è€…åˆ é™¤æ‰ï¼Œä¸ç”¨é…ç½® HWADDRï¼Œé‡å¯ç½‘ç»œæœåŠ¡åç”¨å‘½ä»¤æŸ¥çœ‹åˆ°çš„ mac åœ°å€å°±æ˜¯ç½‘å¡çš„ HWADDR\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/linux-hwaddr-macaddr-different/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: ç½‘å¡çš„ HWADDR å’Œ MACADDR çš„åŒºåˆ« LINUX ç³»ç»Ÿä¸­ HWaddr å’Œ macaddr ä»€ä¹ˆåŒºåˆ« Linux æ°¸ä¹…ç”Ÿæ•ˆ MAC 1 è¯¦è§£ ç¯å¢ƒï¼šcentos7.8 åœ¨ centos ä¸­å¯ä»¥åœ¨å¦‚ä¸‹æ–‡ä»¶ä¸­æŸ¥çœ‹ä¸€ä¸ª NIC çš„é…ç½® ï¼š /etc/sysconfig/network-scripts/ifcfg-N HWADDR=, å…¶ä¸­ ä»¥ AA:BB:CC:DD:EE:FF å½¢å¼çš„ä»¥å¤ªç½‘è®¾å¤‡çš„ç¡¬ä»¶åœ°å€.åœ¨æœ‰å¤šä¸ªç½‘å¡è®¾å¤‡çš„æœºå™¨ä¸Šï¼Œè¿™ä¸ªå­—æ®µæ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œå®ƒä¿è¯è®¾å¤‡æ¥å£è¢«åˆ†é…äº†æ­£ç¡®çš„è®¾å¤‡å ï¼Œè€Œä¸è€ƒè™‘æ¯","title":"linux | hwaddr å’Œ macaddr çš„åŒºåˆ«"},{"content":"1 ä¸ƒç‰›äº‘é…ç½® 1.1 æ³¨å†Œä¸ƒç‰›äº‘ï¼Œæ–°å»ºå­˜å‚¨ç©ºé—´ ä¸ƒç‰›äº‘æ–°ç”¨æˆ·æœ‰ 10G çš„å…è´¹ç©ºé—´ï¼Œä½œä¸ºä¸ªäººåšå®¢æ¥è¯´åŸºæœ¬è¶³å¤Ÿäº†\n1.2 ä¸ºå­˜å‚¨ç©ºé—´é…ç½®åŠ é€ŸåŸŸå 1.3 é…ç½® https è¯ä¹¦ 1.3.1 è´­ä¹°å…è´¹è¯ä¹¦ 1.3.2 è¡¥å…¨åŸŸåä¿¡æ¯ 1.3.3 åŸŸåéªŒè¯ æ ¹æ®åœ¨åŸŸåæä¾›å•†å¤„æ–°å»ºè§£æ\ndns é…ç½®å¥½ä¹‹åç­‰å¾… CA æœºæ„å®¡æ ¸åé¢å‘è¯ä¹¦å°±å¯ä»¥äº†\n1.4.4 å¼€å¯ https 2 PicGo é…ç½® 2.1 ä¸‹è½½å®‰è£… ä¸‹è½½é“¾æ¥ï¼šhttps://github.com/Molunerfinn/PicGo/releases/\nå»ºè®®ä¸‹è½½ç¨³å®šç‰ˆ\n2.2 é…ç½®ä¸ƒç‰›äº‘å›¾åºŠ ak å’Œ sk åœ¨ä¸ƒç‰›äº‘â†’ä¸ªäººä¸­å¿ƒâ†’å¯†é’¥ç®¡ç†ä¸­æŸ¥çœ‹\nåœ¨ picgo ç«¯é…ç½®å„é¡¹ä¿¡æ¯ï¼Œæ³¨æ„ç½‘å€è¦æ”¹æˆ https\n3 typora æµ‹è¯•å›¾ç‰‡ä¸Šä¼  ä¸‹è½½åœ°å€ï¼šhttps://www.typora.io/\nåœ¨æ–‡ä»¶â†’åå¥½è®¾ç½®â†’å›¾åƒä¸­é…ç½®å›¾ç‰‡ä¸Šä¼ ï¼Œé€‰æ‹©å®‰è£…å¥½çš„ PicGo çš„åº”ç”¨ç¨‹åº\nç‚¹å‡»éªŒè¯å›¾ç‰‡ä¸Šä¼ \nåˆ°ä¸ƒç‰›äº‘å­˜å‚¨ç©ºé—´çœ‹æ˜¯å¦æœ‰è¿™ä¸¤ä¸ªæ–‡ä»¶\ntypora å¯ä»¥å®ç°è‡ªåŠ¨çš„å›¾ç‰‡ä¸Šä¼ ï¼Œå¹¶å°†æœ¬åœ°è¿æ¥è‡ªåŠ¨è½¬æ¢ä¸ºå¤–é“¾åœ°å€\n4 å¯èƒ½çš„æŠ¥é”™ ä¸€èˆ¬æŠ¥é”™åŸå› éƒ½å¯åœ¨ picgo çš„æ—¥å¿—æ–‡ä»¶æ‰¾åˆ°ï¼Œè·¯å¾„ï¼šC:\\Users\\username\\AppData\\Roaming\\picgo\n4.1 failed to fetch æ—¥å¿—æŠ¥é”™å¦‚ä¸‹\né—®é¢˜åœ¨äºç«¯å£å†²çªï¼Œå¦‚æœä½ æ‰“å¼€äº†å¤šä¸ª picgo ç¨‹åºï¼Œå°±ä¼šç«¯å£å†²çªï¼Œpicgo è‡ªåŠ¨å¸®ä½ æŠŠ 36677 ç«¯å£æ”¹ä¸º 366771 ç«¯å£ï¼Œå¯¼è‡´é”™è¯¯ã€‚\né‡æ–°éªŒè¯\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/blog/typora-picgo-qiniu-upload-image/","summary":"1 ä¸ƒç‰›äº‘é…ç½® 1.1 æ³¨å†Œä¸ƒç‰›äº‘ï¼Œæ–°å»ºå­˜å‚¨ç©ºé—´ ä¸ƒç‰›äº‘æ–°ç”¨æˆ·æœ‰ 10G çš„å…è´¹ç©ºé—´ï¼Œä½œä¸ºä¸ªäººåšå®¢æ¥è¯´åŸºæœ¬è¶³å¤Ÿäº† 1.2 ä¸ºå­˜å‚¨ç©ºé—´é…ç½®åŠ é€ŸåŸŸå 1.3 é…ç½® https è¯ä¹¦ 1.3.1 è´­ä¹°å…è´¹è¯ä¹¦ 1.3.2 è¡¥å…¨åŸŸåä¿¡æ¯ 1.3.3 åŸŸåéªŒè¯ æ ¹æ®åœ¨åŸŸåæä¾›å•†å¤„æ–°å»ºè§£æ dns é…ç½®å¥½ä¹‹åç­‰å¾… CA æœºæ„å®¡æ ¸åé¢å‘è¯ä¹¦å°±å¯ä»¥äº† 1.4.4 å¼€å¯ https 2 PicGo é…ç½® 2.1 ä¸‹è½½å®‰è£… ä¸‹è½½é“¾æ¥ï¼šhttp","title":"markdown å›¾ç‰‡å­˜å‚¨æ–¹æ¡ˆ | typora + picgo + ä¸ƒç‰›äº‘"},{"content":"1 ç°è±¡ åšå®¢åŠ è½½ä¸å‡ºæ¥æˆ‘åœ¨ä¸ƒç‰›äº‘çš„å›¾ç‰‡èµ„æº ä½¿ç”¨æµè§ˆå™¨ç›´æ¥è®¿é—®å›¾ç‰‡ url å´æ˜¯å¯ä»¥æˆåŠŸçš„ æˆ‘å°†ä¹‹å‰ csdn çš„åšå®¢è¿ç§»åˆ°äº† wordpressï¼Œå›¾ç‰‡å¤–é“¾åœ°å€å°±æ˜¯ csdn çš„ï¼Œéƒ½å¯ä»¥æ­£å¸¸åŠ è½½ã€‚ ä½¿ç”¨æµè§ˆå™¨ç›´æ¥è®¿é—®å›¾ç‰‡ url å´æ˜¯å¯ä»¥æˆåŠŸçš„\næˆ‘å°†ä¹‹å‰ csdn çš„åšå®¢è¿ç§»åˆ°äº† wordpressï¼Œå›¾ç‰‡å¤–é“¾åœ°å€å°±æ˜¯ csdn çš„ï¼Œéƒ½å¯ä»¥æ­£å¸¸åŠ è½½ã€‚\n2 æ’æŸ¥ 1ã€ç”±äºæµè§ˆå™¨ç›´æ¥è®¿é—®ä¸ƒç‰›äº‘å›¾åºŠçš„ url åœ°å€æ˜¯å¯ä»¥è®¿é—®çš„ï¼Œè¯æ˜åœ°å€å¹¶æ²¡é”™ï¼Œæœ‰æ²¡æœ‰å¯èƒ½æ˜¯ referer é˜²ç›—é“¾çš„é…ç½®é—®é¢˜\næŸ¥çœ‹é˜²ç›—é“¾é…ç½®ï¼Œå¹¶æ²¡æœ‰å¼€\n2ã€wordpress å¯ä»¥åŠ è½½å‡ºæ¥ csdn çš„å¤–é“¾å›¾ç‰‡ï¼ŒæœŸé—´ä¹Ÿè¯•äº†å…¶ä»–å›¾åºŠéƒ½æ˜¯æ²¡é—®é¢˜çš„ã€‚\n3ã€çœ‹çœ‹ä¸ƒç‰›çš„å›¾ç‰‡å¤–é“¾å’Œ csdn çš„æœ‰ä½•åŒºåˆ«\næ³¨æ„åˆ°ä¸ƒç‰›çš„å›¾ç‰‡å¤–é“¾æ˜¯ httpï¼Œå½“æ—¶å«Œéº»çƒ¦å¹¶æ²¡æœ‰é…ç½® httpsï¼Œçœ‹æ¥é—®é¢˜æ˜¯å‡ºåœ¨è¿™äº†\nå› ä¸ºæˆ‘çš„ç½‘ç«™é…ç½®äº† ssl è¯ä¹¦ï¼Œå¯èƒ½ç”±äºå®‰å…¨é—®é¢˜æµè§ˆå™¨ä¸äºˆåŠ è½½ http é¡¹ç›®ï¼Œç”¨ http è®¿é—®ç«™ç‚¹æµ‹è¯•ä¸‹å›¾ç‰‡æ˜¯å¦å¯ä»¥åŠ è½½\nè®¿é—®æˆåŠŸäº†ï¼\n3 è§£å†³ ç»™å›¾åºŠæœåŠ¡å™¨å®‰è£… ssl è¯ä¹¦ï¼Œå¼€å¯ https è®¿é—®ï¼Œå‚è€ƒï¼štypora-picgo-qiniu-upload-image\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/blog/wordpress-load-image-failed/","summary":"1 ç°è±¡ åšå®¢åŠ è½½ä¸å‡ºæ¥æˆ‘åœ¨ä¸ƒç‰›äº‘çš„å›¾ç‰‡èµ„æº ä½¿ç”¨æµè§ˆå™¨ç›´æ¥è®¿é—®å›¾ç‰‡ url å´æ˜¯å¯ä»¥æˆåŠŸçš„ æˆ‘å°†ä¹‹å‰ csdn çš„åšå®¢è¿ç§»åˆ°äº† wordpressï¼Œå›¾ç‰‡å¤–é“¾åœ°å€å°±æ˜¯ csdn çš„ï¼Œéƒ½å¯ä»¥æ­£å¸¸åŠ è½½ã€‚ ä½¿ç”¨æµè§ˆå™¨ç›´æ¥è®¿é—®å›¾ç‰‡ url å´æ˜¯å¯ä»¥æˆåŠŸçš„ æˆ‘å°†ä¹‹å‰ csdn çš„åšå®¢è¿ç§»åˆ°äº† wordpressï¼Œå›¾ç‰‡å¤–é“¾åœ°å€å°±æ˜¯ csdn çš„ï¼Œéƒ½å¯ä»¥æ­£å¸¸åŠ è½½ã€‚","title":"wordpress | åŠ è½½å›¾ç‰‡å¤±è´¥"},{"content":"é»˜è®¤ä¸»é¢˜ä¸‹åœ¨åå°è®¾ç½®é‡Œä¿®æ”¹å³å¯\ndux ä¸»é¢˜ä¿®æ”¹æ–¹å¼ï¼šåœ¨åå°ç®¡ç†â†’dux ä¸»é¢˜ç¼–è¾‘å™¨â†’ç½‘ç«™åº•éƒ¨ä¿¡æ¯ä¸­æ·»åŠ \n\u0026lt;a href=\u0026#34;http://beian.miit.gov.cn/\u0026#34; rel=\u0026#34;external nofollow\u0026#34; target=\u0026#34;_blank\u0026#34;\u0026gt;äº¬ICPå¤‡2021023168å·-1\u0026lt;/a\u0026gt; é€šç”¨ä¿®æ”¹æ–¹å¼\nåœ¨ä¸»é¢˜ç›®å½•çš„ footer.php æ–‡ä»¶ä¸­çš„ \u0026lt;footer\u0026gt;\u0026lt;/footer\u0026gt; ä¸‹æ·»åŠ ä»£ç \n\u0026lt;a href=\u0026#34;http://beian.miit.gov.cn/\u0026#34; rel=\u0026#34;external nofollow\u0026#34; target=\u0026#34;_blank\u0026#34;\u0026gt;ä½ çš„å¤‡æ¡ˆå·\u0026lt;/a\u0026gt; ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/blog/wordpress-add-icp/","summary":"é»˜è®¤ä¸»é¢˜ä¸‹åœ¨åå°è®¾ç½®é‡Œä¿®æ”¹å³å¯ dux ä¸»é¢˜ä¿®æ”¹æ–¹å¼ï¼šåœ¨åå°ç®¡ç†â†’dux ä¸»é¢˜ç¼–è¾‘å™¨â†’ç½‘ç«™åº•éƒ¨ä¿¡æ¯ä¸­æ·»åŠ  \u0026lt;a href=\u0026#34;http://beian.miit.gov.cn/\u0026#34; rel=\u0026#34;external nofollow\u0026#34; target=\u0026#34;_blank\u0026#34;\u0026gt;äº¬ICPå¤‡2021023168å·-1\u0026lt;/a\u0026gt; é€šç”¨ä¿®æ”¹æ–¹å¼ åœ¨ä¸»é¢˜ç›®å½•çš„ footer.php æ–‡ä»¶ä¸­çš„ \u0026lt;footer\u0026gt;\u0026lt;/footer\u0026gt; ä¸‹æ·»åŠ ä»£ç  \u0026lt;a href=\u0026#34;http://beian.miit.gov.cn/\u0026#34; rel=\u0026#34;external nofollow\u0026#34; target=","title":"wordpress | æ·»åŠ  icp å¤‡æ¡ˆå·"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\nåœ¨ Apache æœåŠ¡å™¨ä¸Šå®‰è£… SSL è¯ä¹¦ WordPress å¼ºåˆ¶è·³è½¬ https æ•™ç¨‹ 1 é…ç½® ssl è¯ä¹¦ 1ã€ç™»å½•é˜¿é‡Œäº‘ï¼Œé€‰æ‹©äº§å“ä¸­çš„ ssl è¯ä¹¦\nå¦‚æœåŸŸåæ˜¯é˜¿é‡Œçš„ä»–ä¼šè‡ªåŠ¨åˆ›å»º dns è§£æï¼Œå¦‚æœæ˜¯å…¶ä»–å‚å•†éœ€è¦æŒ‰ç…§å›¾ç‰‡é…ç½®ï¼Œç­‰å¾…å‡ åˆ†é’Ÿè¿›è¡ŒéªŒè¯\nç‚¹å‡»å®¡æ ¸ï¼Œç­‰å¾…ç­¾å‘\nç­¾å‘åæ ¹æ®éœ€æ±‚ä¸‹è½½æ‰€éœ€è¯ä¹¦\næˆ‘çš„ wordpress æ˜¯ç›´æ¥ä¹°çš„é˜¿é‡Œè½»é‡åº”ç”¨æœåŠ¡å™¨ï¼Œæ‰“å¼€è½»é‡åº”ç”¨æœåŠ¡å™¨çš„æ§åˆ¶å°é…ç½®åŸŸå\né€‰æ‹©åˆšç”³è¯·å¥½çš„ ssl è¯ä¹¦\nåœ¨ wordpress åå°ä¿®æ”¹åœ°å€\nå¤§åŠŸå‘Šæˆ\n2 é…ç½® https å¼ºåˆ¶è·³è½¬ ä¸€èˆ¬ç«™ç‚¹éœ€è¦åœ¨ httpd.conf ä¸­çš„ \u0026lt;VirtualHost *:80\u0026gt; \u0026lt;/VirtualHost\u0026gt; ä¸­é…ç½®é‡å®šå‘\nwordpress ä¸åŒï¼Œéœ€è¦åœ¨ä¼ªé™æ€æ–‡ä»¶ï¼ˆ.htaccessï¼‰ä¸­é…ç½®é‡å®šå‘ï¼Œæ— éœ€åœ¨ httpd.conf ä¸­é…ç½®\n2.1 ä¿®æ”¹ä¼ªé™æ€æ–‡ä»¶ï¼ˆ.htaccessï¼‰ ä¼ªé™æ€æ–‡ä»¶ä¸€èˆ¬åœ¨ç½‘é¡µæ ¹ç›®å½•ï¼Œæ˜¯ä¸€ä¸ªéšè—æ–‡ä»¶\nåœ¨ #END Wordpress å‰æ·»åŠ å¦‚ä¸‹é‡å®šå‘ä»£ç ï¼Œè®°å¾—æŠŠåŸŸåä¿®æ”¹æˆè‡ªå·±çš„\nRewriteEngine On RewriteCond %{HTTPS} !on RewriteRule ^(.*)$ https://lvbibir.cn/%{REQUEST_URI} [L,R=301] å›¾ä¸­ä¸¤æ®µé‡å®šå‘ä»£ç ç•¥æœ‰ä¸åŒ\nç¬¬ä¸€æ®µä»£ç é‡å®šå‘è§¦å‘å™¨ï¼šå½“è®¿é—®çš„ç«¯å£ä¸æ˜¯ 443 æ—¶è¿›è¡Œé‡å®šå‘é‡å®šå‘è§„åˆ™ï¼šé‡å®šå‘åˆ°ï¼šhttps://{åŸåŸŸå}/{åŸ url èµ„æº} ç¬¬äºŒæ®µä»£ç é‡å®šå‘è§¦å‘å™¨ï¼šå½“è®¿é—®çš„åè®®ä¸æ˜¯ TLS/SLLï¼ˆhttpsï¼‰æ—¶è¿›è¡Œé‡å®šå‘é‡å®šå‘è§„åˆ™ï¼šé‡å®šå‘åˆ°ï¼šhttps://lvbibir.cn/{åŸ url èµ„æº} ç¬¬ä¸€æ®µä»£ç ä½¿ç”¨ç«¯å£åˆ¤æ–­ï¼Œç¬¬äºŒæ®µä»£ç é€šè¿‡è®¿é—®æ–¹å¼åˆ¤æ–­ï¼Œå»ºè®®ä½¿ç”¨è®¿é—®æ–¹å¼åˆ¤æ–­ï¼Œè¿™æ ·æœåŠ¡æ”¹äº†ç«¯å£ä¹Ÿå¯ä»¥æ­£å¸¸è·³è½¬ ç¬¬ä¸€æ®µä»£ç é‡å®šå‘çš„åŸå…ˆçš„åŸŸåï¼Œç¬¬äºŒæ®µä»£ç å¯ä»¥æŠŠ ip åœ°å€é‡å®šå‘åˆ°æŒ‡å®šåŸŸå 2.2 æµ‹è¯• curl -I http://lvbibir.cn ä½¿ç”¨ http è®¿é—®ç«™ç‚¹çš„ 80 ç«¯å£æˆåŠŸé€šè¿‡ 301 è·³è½¬åˆ°äº† https\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/blog/wordpress-ssl/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: åœ¨ Apache æœåŠ¡å™¨ä¸Šå®‰è£… SSL è¯ä¹¦ WordPress å¼ºåˆ¶è·³è½¬ https æ•™ç¨‹ 1 é…ç½® ssl è¯ä¹¦ 1ã€ç™»å½•é˜¿é‡Œäº‘ï¼Œé€‰æ‹©äº§å“ä¸­çš„ ssl è¯ä¹¦ å¦‚æœåŸŸåæ˜¯é˜¿é‡Œçš„ä»–ä¼šè‡ªåŠ¨åˆ›å»º dns è§£æï¼Œå¦‚æœæ˜¯å…¶ä»–å‚å•†éœ€è¦æŒ‰ç…§å›¾ç‰‡é…ç½®ï¼Œç­‰å¾…å‡ åˆ†é’Ÿè¿›è¡ŒéªŒè¯ ç‚¹å‡»å®¡æ ¸ï¼Œç­‰å¾…ç­¾å‘ ç­¾å‘åæ ¹æ®éœ€æ±‚ä¸‹è½½æ‰€éœ€è¯ä¹¦ æˆ‘çš„ wordpress æ˜¯ç›´æ¥ä¹°çš„é˜¿é‡Œè½»é‡åº”ç”¨æœåŠ¡å™¨ï¼Œæ‰“å¼€è½»","title":"wordpress | é…ç½®å…è´¹ ssl è¯ä¹¦å’Œ https å¼ºåˆ¶è·³è½¬"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\ndocker ä¸‰å‰‘å®¢ä¹‹ machine 1 Docker Machine ç®€ä»‹ Docker Machine æ˜¯ Docker å®˜æ–¹ç¼–æ’ï¼ˆOrchestrationï¼‰é¡¹ç›®ä¹‹ä¸€ï¼Œè´Ÿè´£åœ¨å¤šç§å¹³å°ä¸Šå¿«é€Ÿå®‰è£… Docker ç¯å¢ƒã€‚\nDocker Machine æ”¯æŒåœ¨å¸¸è§„ Linux æ“ä½œç³»ç»Ÿã€è™šæ‹ŸåŒ–å¹³å°ã€openstackã€å…¬æœ‰äº‘ç­‰ä¸åŒç¯å¢ƒä¸‹å®‰è£…é…ç½® dockerhostã€‚\nDocker Machine é¡¹ç›®åŸºäº Go è¯­è¨€å®ç°ï¼Œç›®å‰åœ¨ Github ä¸Šçš„ ç»´æŠ¤åœ°å€\n2 Docker Machine å®è·µ 2.1 ç¯å¢ƒå‡†å¤‡ ä¸‰å° centos7ï¼Œä¸¤å°æ–°ç³»ç»Ÿï¼Œä¸€å°è£…æœ‰ docker machineï¼š192.168.1.101 host1:192.168.1.127 host2:192.168.1.180 ä¿è¯ä¸‰å° centos7 å¯ä»¥è¿æ¥åˆ°å¤–ç½‘ 2.2 å®‰è£… machine base=https://github.com/docker/machine/releases/download/v0.14.0 \u0026amp;\u0026amp; curl -L $base/docker-machine-$(uname -s)-$(uname -m) \u0026gt;/tmp/docker-machine \u0026amp;\u0026amp; sudo install /tmp/docker-machine /usr/local/bin/docker-machine\tä¸‹è½½å¹¶å®‰è£… doker-machineï¼Œè·¯å¾„åœ¨ /usr/local/bin ä¸‹\n2.3 åˆ›å»º machine machine æŒ‡çš„æ˜¯ docker daemon ä¸»æœºï¼Œå…¶å®å°±æ˜¯åœ¨ host ä¸Šå®‰è£…å’Œéƒ¨ç½² dockerã€‚\nåˆ›å»ºæµç¨‹ï¼š\nå®‰è£… docker è½¯ä»¶åŒ… ssh å…å¯†ç™»é™†è¿œç¨‹ä¸»æœº å¤åˆ¶è¯ä¹¦ é…ç½® docker daemon å¯åŠ¨ docker 2.4 å…å¯†ç™»å½• ssh-keygen ssh-copy-id ç›®æ ‡ip [root@server5 ~]# ssh-keygen [root@server5 ~]# ssh-copy-id 192.168.1.127 [root@server5 ~]# ssh-copy-id 192.168.1.180 æµ‹è¯•ï¼š\nssh 192.168.1.127 ssh 192.168.1.180 2.4.1 åˆ›å»ºä¸»æœº docker-machine create --driver generic --generic-ip-address=192.168.1.127 host1 ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/docker-machine/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: docker ä¸‰å‰‘å®¢ä¹‹ machine 1 Docker Machine ç®€ä»‹ Docker Machine æ˜¯ Docker å®˜æ–¹ç¼–æ’ï¼ˆOrchestrationï¼‰é¡¹ç›®ä¹‹ä¸€ï¼Œè´Ÿè´£åœ¨å¤šç§å¹³å°ä¸Šå¿«é€Ÿå®‰è£… Docker ç¯å¢ƒã€‚ Docker Machine æ”¯æŒåœ¨å¸¸è§„ Linux æ“ä½œç³»ç»Ÿã€è™šæ‹ŸåŒ–å¹³å°ã€openstackã€å…¬æœ‰äº‘ç­‰ä¸åŒç¯å¢ƒä¸‹å®‰è£…é…ç½® dockerhostã€‚ Docker Machine é¡¹ç›®åŸºäº Go è¯­è¨€å®ç°ï¼Œç›®å‰åœ¨ Github ä¸Šçš„ ç»´æŠ¤","title":"docker | ä¸‰å‰‘å®¢ä¹‹ machine"},{"content":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\nDockerä¸‰å‰‘å®¢â€”â€”Swarm docker swarm åˆ é™¤èŠ‚ç‚¹ï¼ˆè§£æ•£é›†ç¾¤ï¼‰ æˆªå–å·²åˆ›å»ºå¥½çš„ swarm é›†ç¾¤çš„ token 1 éƒ¨ç½² 1.1 ç¯å¢ƒå‡†å¤‡ å‡†å¤‡ 3 å° Ubuntu ç³»ç»Ÿä¸»æœº (å³ç”¨äºæ­å»ºé›†ç¾¤çš„ 3 ä¸ª Docker æœºå™¨)ï¼Œæ¯å°æœºå™¨ä¸Šéƒ½éœ€è¦å®‰è£… Docker å¹¶ä¸”å¯ä»¥è¿æ¥ç½‘ç»œï¼ŒåŒæ—¶è¦æ±‚ Docker ç‰ˆæœ¬å¿…é¡»æ˜¯ 1.12 åŠä»¥ä¸Šï¼Œå› ä¸ºè€ç‰ˆæœ¬ä¸æ”¯æŒ Docker Swarm é›†ç¾¤ç®¡ç†èŠ‚ç‚¹ Docker æœºå™¨çš„ IP åœ°å€å¿…é¡»å›ºå®šï¼Œé›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹éƒ½èƒ½å¤Ÿè®¿é—®è¯¥ç®¡ç†èŠ‚ç‚¹ã€‚ é›†ç¾¤èŠ‚ç‚¹ä¹‹é—´å¿…é¡»ä½¿ç”¨ç›¸åº”çš„åè®®å¹¶ä¿è¯å…¶ä»¥ä¸‹ç«¯å£å¯ç”¨ï¼š ç”¨äºé›†ç¾¤ç®¡ç†é€šä¿¡çš„ TCP ç«¯å£ 2377ï¼› TCP å’Œ UDP ç«¯å£ 7946ï¼Œç”¨äºèŠ‚ç‚¹é—´çš„é€šä¿¡ï¼› UDP ç«¯å£ 4789ï¼Œç”¨äºè¦†ç›–ç½‘ç»œæµé‡ ä¸ºäº†è¿›è¡Œæœ¬å®ä¾‹æ¼”ç¤ºï¼Œæ­¤å¤„æŒ‰ç…§è¦æ±‚å®‰è£…äº† 3 å°ä½¿ç”¨ centos7.4 ç³»ç»Ÿçš„æœºå™¨ï¼Œè¿™ä¸‰å°æœºå™¨çš„ä¸»æœºåç§°åˆ†åˆ«ä¸º manager1(ä½œä¸ºç®¡ç†èŠ‚ç‚¹)ï¼Œworker1(ä½œä¸ºå·¥ä½œèŠ‚ç‚¹)ï¼Œworker2(ä½œä¸ºå·¥ä½œèŠ‚ç‚¹),å…¶ IP åœ°å€åˆ†åˆ«å¦‚ä¸‹ï¼š\nä¸»æœºå IP åœ°å€ manager 192.168.0.101 worker-1 192.168.0.102 worker-2 192.168.0.103 1.2 åˆ›å»ºé›†ç¾¤ åœ¨ manager ä¸Šåˆ›å»º swarm é›†ç¾¤\n[root@node-1 ~]# docker swarm init --advertise-addr 192.168.0.101 ä½¿ç”¨ docker node ls æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯\n[root@manager ~]# docker node ls 1.3 æ·»åŠ å·¥ä½œèŠ‚ç‚¹ åœ¨ worker1 å’Œ worker2 ä¸­æ‰§è¡Œï¼ŒåŠ å…¥ swarm é›†ç¾¤\ndocker swarm join --token SWMTKN-1-2zhqxsklcroivbpjzzntn5snsim79o5z7xzj4hzexk9phsz68q-d0seaxjgxpjebk8fdqt6d6yz5 192.168.0.101:2377 åœ¨ç®¡ç†èŠ‚ç‚¹ä¸Šï¼Œä½¿ç”¨ docker node ls æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯\n[root@manager ~]# docker node ls 1.4 éƒ¨ç½²æœåŠ¡ åœ¨å‘ docker swarm é›†ç¾¤ä¸­éƒ¨ç½²æœåŠ¡æ—¶ï¼Œæ—¢å¯ä»¥ä½¿ç”¨ docker hub ä¸Šè‡ªå¸¦çš„é•œåƒæ¥å¯åŠ¨æœåŠ¡ï¼Œä¹Ÿå¯ä»¥è‡ªå·±é€šè¿‡ dockerfile çš„é•œåƒæ¥å¯åŠ¨æœåŠ¡ï¼Œå¦‚æœä½¿ç”¨è‡ªå·±çš„ dockerfile æ„å»ºçš„é•œåƒæ¥å¯åŠ¨æœåŠ¡ï¼Œé‚£ä¹ˆå¿…é¡»å…ˆå°†é•œåƒæ¨é€åˆ° docker hub ä¸­å¿ƒä»“åº“\nè¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ docker hub ä¸Šè‡ªå¸¦çš„ alpine é•œåƒä¸ºä¾‹æ¥éƒ¨ç½²é›†ç¾¤æœåŠ¡\n[root@manager ~]# docker service create --replicas 1 --name helloworld alpine ping docker.com 1.5 æŸ¥çœ‹æœåŠ¡ å½“æœåŠ¡éƒ¨ç½²å®Œæˆåï¼Œåœ¨ç®¡ç†èŠ‚ç‚¹ä¸Šå¯ä»¥é€šè¿‡ docker service ls æŸ¥çœ‹å½“å‰é›†ç¾¤ä¸­çš„æœåŠ¡åˆ—è¡¨ä¿¡æ¯\n[root@manager ~]# docker service ls ä½¿ç”¨ docker service inspect æŸ¥çœ‹éƒ¨ç½²çš„æœåŠ¡å…·ä½“è¯¦æƒ…\n[root@manager ~]# docker service inspect helloworl ä½¿ç”¨ docker service ps æŸ¥çœ‹æŒ‡å®šæœåŠ¡åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸Šçš„åˆ†é…å’Œè¿è¡Œæƒ…å†µ\n[root@manager ~]# docker service ps helloworld 1.6 æ›´æ”¹å‰¯æœ¬æ•°é‡ åœ¨é›†ç¾¤ä¸­éƒ¨ç½²çš„æœåŠ¡ï¼Œå¦‚æœåªè¿è¡Œä¸€ä¸ªå‰¯æœ¬ï¼Œå°±æ— æ³•ä½“ç°å‡ºé›†ç¾¤çš„ä¼˜åŠ¿ï¼Œå¹¶ä¸”ä¸€æ—¦è¯¥æœºå™¨æˆ–å‰¯æœ¬å´©æºƒï¼Œè¯¥æœåŠ¡å°†æ— æ³•è®¿é—®ï¼Œæ‰€ä»¥é€šå¸¸ä¸€ä¸ªæœåŠ¡ä¼šå¯åŠ¨å¤šä¸ªå‰¯æœ¬\n[root@manager ~]# docker service scale helloworld=5 æ›´æ”¹å®Œæˆåï¼Œå°±å¯ä»¥è°ˆè¿‡ docker service ps æŸ¥çœ‹è¿™äº”ä¸ªæœåŠ¡å‰¯æœ¬åœ¨ 3 ä¸ªèŠ‚ç‚¹ä¸Šçš„å…·ä½“åˆ†å¸ƒå’Œè¿è¡Œæƒ…å†µ\n[root@manager ~]# docker service ps helloworld 1.7 åˆ é™¤æœåŠ¡ å¯¹äºä¸éœ€è¦çš„æœåŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œåˆ é™¤\n[root@manager ~]# docker service rm helloworld 1.8 è®¿é—®æœåŠ¡ åœ¨ç®¡ç†èŠ‚ç‚¹ä¸Šï¼Œæ‰§è¡Œ docker network ls æŸ¥çœ‹ç½‘ç»œåˆ—è¡¨\n[root@manager ~]# docker network ls åœ¨ç®¡ç†èŠ‚ç‚¹ä¸Šï¼Œåˆ›å»º overlay ç½‘ç»œ\n[root@manager ~]# docker network create -d overlay ov_net åœ¨ç®¡ç†èŠ‚ç‚¹ä¸Šï¼Œå†æ¬¡éƒ¨ç½²æœåŠ¡\n[root@manager ~]# docker service create --network ov_net --name my-web --publish 8080:80 --replicas 2 nginx è®¿é—® nginx æœåŠ¡\nä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/docker-swarm/","summary":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥: Dockerä¸‰å‰‘å®¢â€”â€”Swarm docker swarm åˆ é™¤èŠ‚ç‚¹ï¼ˆè§£æ•£é›†ç¾¤ï¼‰ æˆªå–å·²åˆ›å»ºå¥½çš„ swarm é›†ç¾¤çš„ token 1 éƒ¨ç½² 1.1 ç¯å¢ƒå‡†å¤‡ å‡†å¤‡ 3 å° Ubuntu ç³»ç»Ÿä¸»æœº (å³ç”¨äºæ­å»ºé›†ç¾¤çš„ 3 ä¸ª Docker æœºå™¨)ï¼Œæ¯å°æœºå™¨ä¸Šéƒ½éœ€è¦å®‰è£… Docker å¹¶ä¸”å¯ä»¥è¿æ¥ç½‘ç»œï¼ŒåŒæ—¶è¦æ±‚ Docker ç‰ˆæœ¬å¿…é¡»æ˜¯ 1.12 åŠä»¥ä¸Šï¼Œå› ä¸ºè€ç‰ˆæœ¬ä¸æ”¯æŒ Docker Swarm é›†ç¾¤ç®¡ç†èŠ‚ç‚¹ Docker æœºå™¨çš„","title":"docker | ä¸‰å‰‘å®¢ä¹‹ swarm"},{"content":"1 ç¯å¢ƒå‡†å¤‡ ä¸»æœºç‰ˆæœ¬ä¸º Centos7.4ï¼Œdocker ç‰ˆæœ¬ä¸º docker-ce-18.09.7-3.el7.x86_64\nnode1: 192.168.0.111 node2: 192.168.0.107 ä¸¤å°å®‰è£… docker çš„ç¯å¢ƒ ä¿è¯ä¸¤å°ä¸»æœºä¸Šçš„ docker çš„ Client API ä¸ Server APi ç‰ˆæœ¬ä¸€è‡´ 2 ä¿®æ”¹é…ç½®æ–‡ä»¶ ä¿®æ”¹ daemon.json é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ  labelï¼Œç”¨äºåŒºåˆ«ä¸¤å° docker ä¸»æœº\nnode1ï¼š\n[root@localhost ~]# vim /etc/docker/daemon.json { \u0026#34;registry-mirrors\u0026#34;: [\u0026#34;http://f1361db2.m.daocloud.io\u0026#34;], \u0026#34;labels\u0026#34;: [\u0026#34;-label nodeName=node1\u0026#34;] #æ·»åŠ label } æŸ¥çœ‹æ•ˆæœ\n[root@localhost ~]# systemctl restart docker [root@localhost ~]# docker info node2:\n3 ä¿®æ”¹å®ˆæŠ¤è¿›ç¨‹çš„é€šä¿¡æ–¹å¼ ä¿®æ”¹é€šä¿¡æ–¹å¼å…±æœ‰ä¸‰ç§æ–¹å¼ï¼š\nä¿®æ”¹ daemon.json æ–‡ä»¶ï¼Œæ·»åŠ  host é”®å€¼å¯¹ æ·»åŠ ï¼š\u0026quot;hosts\u0026quot;: [\u0026quot;tcp://0.0.0.0:2375\u0026quot;] å¼€æ”¾æœ¬æœº ip çš„ 2375 ç«¯å£ï¼Œå¯ä»¥è®©å…¶ä»– docker ä¸»æœºçš„ client è¿›è¡Œè¿æ¥ ä¿®æ”¹ /lib/systemd/system/docker.service æ–‡ä»¶ï¼Œæ·»åŠ  -H å¯åŠ¨å‚æ•° ä¿®æ”¹ï¼šExecStart=/usr/bin/docker -H \u0026lt;tcp://0.0.0.0:2375\u0026gt; ä½¿ç”¨ dokcerd å¯åŠ¨ dockerï¼Œæ·»åŠ  -H å‚æ•° dockerd -H \u0026lt;tcp://0.0.0.0:2375\u0026gt; Centos7 ä¸­/etc/docker/daemon.json ä¼šè¢« docker.service çš„é…ç½®æ–‡ä»¶è¦†ç›–ï¼Œç›´æ¥æ·»åŠ  daemon.json ä¸èµ·ä½œç”¨\næ‰€ä»¥æˆ‘ä½¿ç”¨çš„æ˜¯ç¬¬äºŒç§æ–¹å¼\nnode1ï¼š\n[root@localhost ~]# vim /lib/systemd/system/docker.service ExecStart=/usr/bin/docker -H tcp://0.0.0.0:2375 [root@localhost ~]# systemctl daemon-reload [root@localhost ~]# systemctl restart docker [root@localhost ~]# ps -ef | grep docker root 5775 1 3 23:17 ? 00:00:00 /usr/bin/dockerd -H tcp://0.0.0.0:2375 root 5779 5775 0 23:17 ? 00:00:00 docker-containerd --config /var/run/docker/containerd/containerd.toml root 5879 3919 0 23:17 pts/1 00:00:00 grep --color=auto docker 4 è¿œç¨‹è®¿é—® node2ï¼š\n[root@localhost ~]# curl http://192.168.0.111:2375/info [root@localhost ~]# docker -H tcp://192.168.0.111:2375 info å¦‚æœé¢‘ç¹ä½¿ç”¨ -H é€‰é¡¹æœªå…å¤ªè¿‡äºéº»çƒ¦ï¼Œå¯ä»¥ä¿®æ”¹ DOCKER_HOST è¿™ä¸ªç¯å¢ƒå˜é‡çš„å€¼ï¼Œnode2 å°±å¯ä»¥åƒä½¿ç”¨æœ¬åœ°çš„ docker ä¸€æ ·æ¥è¿œç¨‹è¿æ¥ node1 çš„å®ˆæŠ¤è¿›ç¨‹\n[root@localhost ~]# export DOCKER_HOST=\u0026#34;tcp://192.168.0.111:2375\u0026#34; [root@localhost ~]# docker info å½“æ— éœ€å†è¿œç¨‹è¿æ¥ node1 çš„å®ˆæŠ¤è¿›ç¨‹æ—¶ï¼Œå°† DOCKER_HOST ç¯å¢ƒå˜é‡ç½®ç©ºå³å¯\n[root@localhost ~]# export DOCKER_HOST=\u0026#34;\u0026#34; [root@localhost ~]# docker info node1ï¼š\nå› ä¸º node1 è®¾ç½®äº†ä¿®æ”¹ Client ä¸å®ˆæŠ¤è¿›ç¨‹çš„é€šä¿¡æ–¹å¼ï¼Œæ‰€ä»¥æœ¬åœ°æ— æ³•å†é€šè¿‡é»˜è®¤çš„ socket è¿›è¡Œè¿æ¥ï¼Œå¿…é¡»ä½¿ç”¨ -H é€‰é¡¹é€šè¿‡ tcp æ¥è¿›è¡Œè¿æ¥ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ DOCKER_HOST æ¥ä¿®æ”¹\n[root@localhost ~]# docker info Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running? [root@localhost ~]# docker -H 0.0.0.0:2375 info å¦‚æœæœ¬æœºä¾æ—§å¸Œæœ›ä½¿ç”¨é»˜è®¤çš„ socket è¿›è¡Œè¿æ¥ï¼Œå¯ä»¥åœ¨ docker.service ä¸­å†æ·»åŠ ä¸€ä¸ª -H é€‰é¡¹\n[root@localhost ~]# vim /lib/systemd/system/docker.service ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock [root@localhost ~]# systemctl daemon-reload [root@localhost ~]# systemctl restart docker [root@localhost ~]# ps -ef | grep docker root 6462 1 2 23:40 ? 00:00:00 /usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock root 6467 6462 0 23:40 ? 00:00:00 docker-containerd --config /var/run/docker/containerd/containerd.toml root 6567 3919 0 23:40 pts/1 00:00:00 grep --color=auto docker [root@localhost ~]# docker info ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/docker-remote-call-daemon/","summary":"1 ç¯å¢ƒå‡†å¤‡ ä¸»æœºç‰ˆæœ¬ä¸º Centos7.4ï¼Œdocker ç‰ˆæœ¬ä¸º docker-ce-18.09.7-3.el7.x86_64 node1: 192.168.0.111 node2: 192.168.0.107 ä¸¤å°å®‰è£… docker çš„ç¯å¢ƒ ä¿è¯ä¸¤å°ä¸»æœºä¸Šçš„ docker çš„ Client API ä¸ Server APi ç‰ˆæœ¬ä¸€è‡´ 2 ä¿®æ”¹é…ç½®æ–‡ä»¶ ä¿®æ”¹ daemon.json é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ  labelï¼Œç”¨äºåŒºåˆ«ä¸¤å° docker ä¸»æœº node1ï¼š [root@localhost ~]# vim /etc/docker/daemon.json { \u0026#34;registry-mirrors\u0026#34;: [\u0026#34;http://f1361db2.m.daocloud.io\u0026#34;], \u0026#34;labels\u0026#34;: [\u0026#34;-label nodeName=node1\u0026#34;] #æ·»åŠ label } æŸ¥çœ‹æ•ˆæœ [root@localhost ~]# systemctl restart docker [root@localhost ~]# docker info node2: 3 ä¿®æ”¹å®ˆæŠ¤è¿›ç¨‹çš„","title":"docker | å®ˆæŠ¤è¿›ç¨‹çš„è¿œç¨‹è°ƒç”¨"},{"content":"0 å‰è¨€ å®ç°è·¨ä¸»æœºçš„ docker å®¹å™¨ä¹‹é—´çš„é€šè®¯ï¼š\nä½¿ç”¨ç½‘æ¡¥å®ç°è·¨ä¸»æœºçš„è¿æ¥ docker åŸç”Ÿçš„ç½‘ç»œï¼šoverlayã€macvlan ç¬¬ä¸‰æ–¹ç½‘ç»œï¼šflaanelã€weaveã€calic 1 ç½‘æ¡¥ 2 open vswitch 3 weave 4 macvlan 4.1 ç®€ä»‹ macvlan æ˜¯ Linux æ“ä½œç³»ç»Ÿå†…æ ¸æä¾›çš„ç½‘ç»œè™šæ‹ŸåŒ–æ–¹æ¡ˆä¹‹ä¸€ï¼Œæ›´å‡†ç¡®çš„è¯´æ³•æ˜¯ç½‘å¡è™šæ‹ŸåŒ–æ–¹æ¡ˆã€‚å®ƒå¯ä»¥ä¸ºä¸€å¼ ç‰©ç†ç½‘å¡è®¾ç½®å¤šä¸ª mac åœ°å€ï¼Œç›¸å½“äºç‰©ç†ç½‘å¡æ–½å±•äº†å½±åˆ†èº«ä¹‹æœ¯ï¼Œç”±ä¸€ä¸ªå˜å¤šä¸ªï¼ŒåŒæ—¶è¦æ±‚ç‰©ç†ç½‘å¡æ‰“å¼€æ··æ‚æ¨¡å¼ã€‚é’ˆå¯¹æ¯ä¸ª mac åœ°å€ï¼Œéƒ½å¯ä»¥è®¾ç½® IP åœ°å€ï¼Œæœ¬æ¥æ˜¯ä¸€å—ç‰©ç†ç½‘å¡è¿æ¥åˆ°äº¤æ¢æœºï¼Œç°åœ¨æ˜¯å¤šå—è™šæ‹Ÿç½‘å¡è¿æ¥åˆ°äº¤æ¢æœºã€‚\nå½“å®¹å™¨éœ€è¦ç›´è¿å…¥ç‰©ç†ç½‘ç»œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ Macvlanã€‚Macvlan æœ¬èº«ä¸åˆ›å»ºç½‘ç»œï¼Œæœ¬è´¨ä¸Šé¦–å…ˆä½¿å®¿ä¸»æœºç‰©ç†ç½‘å¡å·¥ä½œåœ¨â€˜æ··æ‚æ¨¡å¼â€™ï¼Œè¿™æ ·ç‰©ç†ç½‘å¡çš„ MAC åœ°å€å°†ä¼šå¤±æ•ˆï¼Œæ‰€æœ‰äºŒå±‚ç½‘ç»œä¸­çš„æµé‡ç‰©ç†ç½‘å¡éƒ½èƒ½æ”¶åˆ°ã€‚æ¥ä¸‹æ¥å°±æ˜¯åœ¨è¿™å¼ ç‰©ç†ç½‘å¡ä¸Šåˆ›å»ºè™šæ‹Ÿç½‘å¡ï¼Œå¹¶ä¸ºè™šæ‹Ÿç½‘å¡æŒ‡å®š MAC åœ°å€ï¼Œå®ç°ä¸€å¡å¤šç”¨ï¼Œåœ¨ç‰©ç†ç½‘ç»œçœ‹æ¥ï¼Œæ¯å¼ è™šæ‹Ÿç½‘å¡éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„æ¥å£ã€‚ä½¿ç”¨ Macvlan æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š\nå®¹å™¨ç›´æ¥è¿æ¥ç‰©ç†ç½‘ç»œï¼Œç”±ç‰©ç†ç½‘ç»œè´Ÿè´£åˆ†é… IP åœ°å€ï¼Œå¯èƒ½çš„ç»“æœæ˜¯ç‰©ç†ç½‘ç»œ IP åœ°å€è¢«è€—å°½ï¼Œå¦ä¸€ä¸ªåæœæ˜¯ç½‘ç»œæ€§èƒ½é—®é¢˜ï¼Œç‰©ç†ç½‘ç»œä¸­æ¥å…¥çš„ä¸»æœºå˜å¤šï¼Œå¹¿æ’­åŒ…å æ¯”å¿«é€Ÿå‡é«˜è€Œå¼•èµ·çš„ç½‘ç»œæ€§èƒ½ä¸‹é™é—®é¢˜ã€‚ å‰è¾¹è¯´è¿‡äº†ï¼Œå®¿ä¸»æœºä¸Šçš„æŸå¼ ç½‘ä¸Šéœ€è¦å·¥ä½œåœ¨â€˜æ··ä¹±æ¨¡å¼â€™ä¸‹ã€‚ ä»é•¿è¿œæ¥çœ‹ bridge ç½‘ç»œä¸ overlay ç½‘ç»œæ˜¯æ›´å¥½çš„é€‰æ‹©ï¼ŒåŸå› å°±æ˜¯è™šæ‹Ÿç½‘ç»œåº”è¯¥ä¸ç‰©ç†ç½‘ç»œéš”ç¦»è€Œä¸æ˜¯å…±äº«ã€‚ ä¼˜ç¼ºç‚¹ï¼š\nä¼˜ç‚¹æ˜¯æ€§èƒ½éå¸¸å¥½ ç¼ºç‚¹æ˜¯åœ°å€éœ€è¦æ‰‹åŠ¨åˆ†é… Macvlan ç½‘ç»œæœ‰ä¸¤ç§æ¨¡å¼ï¼šbridge æ¨¡å¼ä¸ 802.1q trunk bridge æ¨¡å¼ã€‚\nbridge æ¨¡å¼ï¼ŒMacvlan ç½‘ç»œæµé‡ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºç‰©ç†ç½‘å¡ã€‚ 802.1q trunk bridge æ¨¡å¼ï¼ŒMacvlan ç½‘ç»œæµé‡ä½¿ç”¨ Docker åŠ¨æ€åˆ›å»ºçš„ 802.1q å­æ¥å£ï¼Œå¯¹äºè·¯ç”±ä¸è¿‡è™‘ï¼Œè¿™ç§æ¨¡å¼èƒ½å¤Ÿæä¾›æ›´ç»†ç²’åº¦çš„æ§åˆ¶ 4.2 éƒ¨ç½² ç¯å¢ƒå‡†å¤‡ï¼š\nä¸¤å° centos7 docker ç‰ˆæœ¬ï¼š18.03 ipï¼š192.168.0.53ï¼ˆnode-1ï¼‰ 192.168.0.54ï¼ˆnode-2ï¼‰ [root@node-1 ~]# ip link show ens33 [root@node-1 ~]# ip link set ens32 promisc on #å¼€å¯æ··æ‚æ¨¡å¼ï¼Œä¿è¯å¤šä¸ªipå¯ä»¥é€šè¿‡ [root@node-1 ~]# docker network create -d macvlan --subnet 10.0.0.0/24 --gateway=10.0.0.1 -o parent=ens33 mac_net1 [root@node-1 ~]# docker network ls node-1 docker run -itd --name bbox-1 --ip 10.0.0.11 --network mac_net1 busybox node-2 docker run -itd --name bbox-2 --ip 10.0.0.12 --network mac_net1 busybox node-1 [root@node-1 ~]# docker exec bbox-1 ping 10.0.0.12 [root@node-1 ~]# docker exec bbox-1 ping bbox-2 å¯ä»¥ ping é€š ipï¼Œä½†æ˜¯æ— æ³• ping é€šä¸»æœºåï¼Œå› ä¸ºå®ƒæ²¡æœ‰ dns è§£æ\n[root@node-1 ~]# brctl show å› ä¸º macvlan ä¸ä¾èµ–äº bridge ç½‘ç»œï¼Œæ‰€ä»¥æŸ¥çœ‹ä¸åˆ°æ–°çš„æ¡¥æ¥ç½‘ç»œ\n[root@node-1 ~]# docker exec bbox-1 ip link æŸ¥çœ‹åˆ° eth0 è¿æ¥åˆ°äº† if2\n[root@node-1 ~]# ip link show ens33 å¯ä»¥æŸ¥çœ‹åˆ° ens33 çš„ç¼–å·æ˜¯ 2ï¼Œå³ bbox-1 å®¹å™¨çš„ eth0 ç½‘å¡è¿æ¥åˆ°äº† ens33 ç‰©ç†ç½‘å¡\n[root@node-1 ~]# docker network create -d macvlan -o parent=ens33 mac_net2 Error response from daemon: network dm-b34ee1020a96 is already using parent interface ens33 å†åˆ›å»º macvlan ç½‘ç»œæ—¶å‘ç°å·²ç»æ— æ³•å†åˆ›å»ºï¼Œå³ä¸€å—ç½‘å¡åªèƒ½æ·»åŠ ä¸€ä¸ª macvlan çš„åœ°å€\n4.3 ä¸€å—ç½‘å¡ç»‘å®šå¤šä¸ª macvlan åœ°å€ [root@node-1 ~]# modinfo 8021q # æŸ¥çœ‹å†…æ ¸æ˜¯å¦æ”¯æŒ802.1qå°è£… [root@node-1 ~]# modprobe 8021q # å¦‚æœä¸Šæ¡å‘½ä»¤æ‰§è¡Œåæ²¡æœ‰ç»“æœï¼Œä½¿ç”¨è¯¥å‘½ä»¤åŠ è½½è¯¥æ¨¡å— node-1 [root@node-1 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33 BOOTPROTO=manual ä¿®æ”¹ä¸ºä¸éœ€è¦ ip çš„ manual æ¨¡å¼\nnode-2 [root@node-2 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens32 BOOTPROTO=manual node-1 æ·»åŠ ä¸¤å—è™šæ‹Ÿç½‘å¡ï¼Œæ³¨æ„ä¸å®é™…çš„ ens32 ç½‘å¡çš„ç½‘æ®µåŒºåˆ†å¼€\nens32 ä½¿ç”¨çš„æ˜¯ 192.168.0.0/24 ç½‘æ®µï¼Œè™šæ‹Ÿç½‘å¡ä½¿ç”¨çš„æ˜¯ 192.168.1.0/24 å’Œ 192.168.2.0/24\n[root@node-1 ~]# cp -p /etc/sysconfig/network-scripts/ifcfg-ens33 /etc/sysconfig/network-scripts/ifcfg-ens33.10 [root@node-1 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33.10 BOOTPROTO=none NAME=ens33.10 DEVICE=ens33.10 ONBOOT=yes IPADDR=192.168.1.10 PREFIX=24 NETWORK=192.168.1.0 VLAN=yes [root@node-1 ~]# cp -p /etc/sysconfig/network-scripts/ifcfg-ens33.10 /etc/sysconfig/network-scripts/ifcfg-ens33.20 [root@node-1 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33.20 BOOTPROTO=none NAME=ens33.20 DEVICE=ens33.20 ONBOOT=yes IPADDR=192.168.2.10 PREFIX=24 NETWORK=192.168.2.0 VLAN=yes [root@node-1 ~]# ifup ens33.10 [root@node-1 ~]# ifup ens33.20 [root@node-1 ~]# scp /etc/sysconfig/network-scripts/ifcfg-ens33.10 192.168.0.54:/etc/sysconfig/network-scripts/ifcfg-ens32.10 [root@node-1 ~]# scp /etc/sysconfig/network-scripts/ifcfg-ens33.20 192.168.0.54:/etc/sysconfig/network-scripts/ifcfg-ens32.20 node-2 [root@node-2 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens32.10 BOOTPROTO=none NAME=ens32.10 DEVICE=ens32.10 ONBOOT=yes IPADDR=192.168.1.20 PREFIX=24 NETWORK=192.168.1.0 VLAN=yes [root@node-2 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens32.20 BOOTPROTO=none NAME=ens32.20 DEVICE=ens32.20 ONBOOT=yes IPADDR=192.168.2.20 PREFIX=24 NETWORK=192.168.2.0 VLAN=yes [root@node-2 ~]# ifup ens32.10 [root@node-2 ~]# ifup ens32.20 node-1 [root@node-1 ~]# docker network create -d macvlan --subnet 172.16.11.0/24 --gateway 172.16.11.1 -o parent=ens33.10 mac_net11 [root@node-1 ~]# docker network create -d macvlan --subnet 172.16.12.0/24 --gateway 172.16.12.1 -o parent=ens33.20 mac_net12 node-2 [root@node-2 ~]# docker network create -d macvlan --subnet 172.16.11.0/24 --gateway 172.16.11.1 -o parent=ens32.10 mac_net11 [root@node-2 ~]# docker network create -d macvlan --subnet 172.16.12.0/24 --gateway 172.16.12.1 -o parent=ens32.20 mac_net12 node-1 [root@node-2 ~]# docker run -itd --name bbox-11 --ip=172.16.11.11 --network mac_net11 busybox [root@node-2 ~]# docker run -itd --name bbox-12 --ip=172.16.12.11 --network mac_net12 busybox node-2 [root@node-2 ~]# docker run -itd --name bbox-21 --ip=172.16.11.12 --network mac_net11 busybox [root@node-2 ~]# docker run -itd --name bbox-22 --ip=172.16.12.12 --network mac_net12 busybox node-1 [root@node-1 ~]# docker exec bbox-11 ping 172.16.11.12 PING 172.16.11.12 (172.16.11.12): 56 data bytes 64 bytes from 172.16.11.12: seq=0 ttl=64 time=0.867 ms 64 bytes from 172.16.11.12: seq=1 ttl=64 time=1.074 ms 64 bytes from 172.16.11.12: seq=2 ttl=64 time=1.145 ms 64 bytes from 172.16.11.12: seq=3 ttl=64 time=0.938 ms ^C [root@node-1 ~]# docker exec bbox-12 ping 172.16.12.12 PING 172.16.12.12 (172.16.12.12): 56 data bytes 64 bytes from 172.16.12.12: seq=0 ttl=64 time=0.858 ms 64 bytes from 172.16.12.12: seq=1 ttl=64 time=1.140 ms 64 bytes from 172.16.12.12: seq=2 ttl=64 time=0.818 ms 64 bytes from 172.16.12.12: seq=3 ttl=64 time=1.056 ms ^C åœ¨ä¸¤å°ç³»ç»Ÿè¿›è¡Œä¿®æ”¹ï¼Œæ·»åŠ ç½‘å…³ï¼Œä¿®æ”¹é˜²ç«å¢™ç­–ç•¥ node-1 ä¸­è®°å¾—å°† ens32 æ›´æ¢ä¸º ens33 ifconfig ens32.10 172.16.10.1 netmask 255.255.255.0 ifconfig ens32.20 172.16.20.1 netmask 255.255.255.0 iptables -t nat -A POSTROUTING -o ens32.10 -j MASQUERADE iptables -t nat -A POSTROUTING -o ens32 -j MASQUERADE iptables -A FORWARD -i ens32.10 -o ens32 -m state --state RELATE,ESTABLISHED -j ACCEPT iptables -A FORWARD -i ens32 -o ens32.10 -m state --state RELATE,ESTABLISHED -j ACCEPT iptables -A FORWARD -i ens32.10 -o ens32 -j ACCEPT iptables -A FORWARD -i ens32 -o ens32.10 -j ACCEPT 5 overlay 5.1 ç®€ä»‹ 5.2 å‡†å¤‡ overlay ç¯å¢ƒ ä¸ºæ”¯æŒå®¹å™¨çš„è·¨ä¸»æœºé€šä¿¡ï¼ŒDocker æä¾›äº† overlay driverã€‚Docker overlay ç½‘ç»œéœ€è¦ä¸€ä¸ª key-value æ•°æ®åº“ç”¨äºä¿å­˜ç½‘ç»œçŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬ Networkã€Endpointã€IP ç­‰ã€‚Consulã€Etcd å’Œ ZooKeeper éƒ½æ˜¯ Docker æ”¯æŒçš„ key-value è½¯ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Consul\nç¯å¢ƒæè¿° èŠ‚ç‚¹ ç³»ç»Ÿç‰ˆæœ¬ docker ç‰ˆæœ¬ è§’è‰² IP åœ°å€ node-1 centos7.4 docker-18.03.0 consul 192.168.0.101 node-2 centos7.4 docker-18.03.0 host 192.168.0.102 node-3 centos7.4 docker-18.03.0 host 192.168.0.103 åˆ›å»º consul node-1; [root@node-1 ~]# docker run -d -p 8500:8500 -h consul --name consul progrium/consul -server -bootstrap å®¹å™¨å¯åŠ¨åå¯ä»¥é€šè¿‡ 192.168.0.101:8500 è®¿é—®åˆ° consul\nä¿®æ”¹ docker é…ç½®æ–‡ä»¶ ä¿®æ”¹ node-2 å’Œ node-3 çš„ docker daemon çš„é…ç½®æ–‡ä»¶/etc/systemd/system/docker.service\n[root@node-2 ~]# vim /etc/systemd/system/docker.service ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock --cluster-store=consul://192.168.0.101:8500 --cluster-advertise=ens32:2376 [root@node-2 ~]# systemctl daemon-reload [root@node-2 ~]# systemctl restart docker -H ï¼štcpï¼šå…è®¸ tcp è¿æ¥ daemon -Hï¼šunixï¼šé»˜è®¤çš„ socket è¿æ¥æ–¹å¼ï¼Œæ”¯æŒè¿œç¨‹çš„åŒæ—¶ï¼Œæœ¬åœ°ä¹Ÿå¯ä»¥è¿æ¥ \u0026ndash;cluster-store æŒ‡å®š consul çš„åœ°å€ \u0026ndash;cluster-advertise å‘ŠçŸ¥ consul è‡ªå·±çš„è¿æ¥åœ°å€ node-2 å’Œ node-3 ä¼šè‡ªåŠ¨æ³¨å†Œåˆ° consul æ•°æ®åº“ä¸­ã€‚\n5.3 åˆ›å»º overlay ç½‘ç»œ åœ¨ node-2 ä¸­åˆ›å»ºç½‘ç»œ åœ¨ node-2 ä¸­åˆ›å»º overlay ç½‘ç»œ ov_net1\n[root@node-2 ~]# docker network create -d overlay ov_net1 -d overlayï¼šæŒ‡å®š driver ä¸º overlay [root@node-2 ~]# docker network ls node-3 æŸ¥çœ‹åˆ›å»ºçš„ç½‘ç»œ æ³¨æ„åˆ° ov_net1 çš„ SCOPE ä¸º globalï¼Œè€Œå…¶ä»–ç½‘ç»œä¸º local ã€‚åœ¨ node-3 ä¸ŠæŸ¥çœ‹å­˜åœ¨çš„ç½‘ç»œ:\n[root@node-3 ~]# docker network ls node-3 ä¸Šä¹Ÿèƒ½çœ‹åˆ° ov_net1ï¼Œåªæ˜¯å› ä¸ºåˆ›å»º ov_net1 æ—¶å°† overlay ç½‘ç»œä¿¡æ¯å­˜å…¥äº† consulï¼Œnode-3 ä» consul è¯»å–åˆ°äº†æ–°ç½‘ç»œæ•°æ®ã€‚ä¹‹å ov_net1 çš„ä»»ä½•å˜åŒ–éƒ½ä¼šåŒæ­¥åˆ° node-2 å’Œ node-3\næŸ¥çœ‹ ov_net1 è¯¦ç»†ä¿¡æ¯ [root@node-2 ~]# docker network inspect ov_net1 IPAM æ˜¯æŒ‡ IP Address Managementï¼Œdocker è‡ªåŠ¨ä¸º ov_net1 åˆ†é…çš„ IP ç©ºé—´ä¸º 10.0.0.0/24\n5.4 åœ¨ overlay ä¸­è¿è¡Œå®¹å™¨ åˆ›å»ºå®¹å™¨ bbox-1 åœ¨ node-2 ä¸Šè¿è¡Œä¸€ä¸ª busybox å®¹å™¨å¹¶è¿æ¥åˆ° ov_net1.\n[root@node-2 ~]# docker run -itd --name bbox-1 --network ov_net1 busybox æŸ¥çœ‹ bbox-1 ç½‘ç»œé…ç½® [root@node-2 ~]# docker exec bbox-1 ip r default via 172.18.0.1 dev eth1 10.0.0.0/24 dev eth0 scope link src 10.0.0.2 172.18.0.0/16 dev eth1 scope link src 172.18.0.2 bbox-1 æœ‰ä¸¤ä¸ªç½‘ç»œæ¥å£ï¼Œeth0 å’Œ eth1 eth0 IP ä¸º 10.0.0.2ï¼Œè¿æ¥çš„æ˜¯ overlay ç½‘ç»œ ov_net1 eth1 IP ä¸º 172.18.0.2 å®¹å™¨çš„é»˜è®¤è·¯ç”±æ˜¯èµ° eth1ï¼Œå…¶å®ï¼Œdocker ä¼šåˆ›å»ºä¸€ä¸ª bridge ç½‘ç»œ â€œdocker_gwbridgeâ€ï¼Œä¸ºæ‰€æœ‰è¿æ¥åˆ° overlay ç½‘ç»œçš„å®¹å™¨æä¾›è®¿é—®å¤–ç½‘çš„èƒ½åŠ› [root@node-2 ~]# docker network ls [root@node-2 ~]# docker network inspect docker_gwbridge ä» docker network inspect docker_gwbridge è¾“å‡ºå¯ç¡®è®¤ docker_gwbridge çš„ IP åœ°å€èŒƒå›´æ˜¯ 172.18.0.0/16ï¼Œå½“å‰è¿æ¥çš„å®¹å™¨å°±æ˜¯ bbox-1ï¼ˆ172.18.0.2ï¼‰\nè€Œä¸”æ­¤ç½‘ç»œçš„ç½‘å…³å°±æ˜¯ç½‘æ¡¥ docker_gwbridge çš„ IP 172.18.0.1\n[root@node-2 ~]# ifconfig docker_gwbridge docker_gwbridge: flags=4163\u0026lt;UP,BROADCAST,RUNNING,MULTICAST\u0026gt; mtu 1500 inet 172.18.0.1 netmask 255.255.0.0 broadcast 172.18.255.255 inet6 fe80::42:c5ff:fe45:937 prefixlen 64 scopeid 0x20\u0026lt;link\u0026gt; ether 02:42:c5:45:09:37 txqueuelen 0 (Ethernet) RX packets 0 bytes 0 (0.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 0 bytes 0 (0.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 è¿™æ ·å®¹å™¨ bbox-1 å°±å¯ä»¥é€šè¿‡ docker_gwbridge è®¿é—®å¤–ç½‘\n[root@node-2 ~]# docker exec bbox-1 ping -c 4 www.baidu.com PING www.baidu.com (182.61.200.6): 56 data bytes 64 bytes from 182.61.200.6: seq=0 ttl=53 time=6.721 ms 64 bytes from 182.61.200.6: seq=1 ttl=53 time=7.954 ms 64 bytes from 182.61.200.6: seq=2 ttl=53 time=11.723 ms 64 bytes from 182.61.200.6: seq=3 ttl=53 time=15.105 ms --- www.baidu.com ping statistics --- 4 packets transmitted, 4 packets received, 0% packet loss round-trip min/avg/max = 6.721/10.375/15.105 ms 5.5 overlay ç½‘ç»œè¿é€šæ€§ node-3 ä¸­ è¿è¡Œ bbox-2 [root@node-3 ~]# docker run -itd --name bbox-2 --network ov_net1 busybox æŸ¥çœ‹ bbox-2 è·¯ç”±æƒ…å†µ [root@node-3 ~]# docker exec bbox-2 ip r default via 172.18.0.1 dev eth1 10.0.0.0/24 dev eth0 scope link src 10.0.0.3 172.18.0.0/16 dev eth1 scope link src 172.18.0.2 äº’é€šæµ‹è¯• [root@node-3 ~]# docker exec bbox-2 ping -c 4 10.0.0.2 PING 10.0.0.2 (10.0.0.2): 56 data bytes 64 bytes from 10.0.0.2: seq=0 ttl=64 time=2.628 ms 64 bytes from 10.0.0.2: seq=1 ttl=64 time=1.004 ms 64 bytes from 10.0.0.2: seq=2 ttl=64 time=1.277 ms 64 bytes from 10.0.0.2: seq=3 ttl=64 time=1.505 ms --- 10.0.0.2 ping statistics --- 4 packets transmitted, 4 packets received, 0% packet loss round-trip min/avg/max = 1.004/1.603/2.628 ms å¯è§ overlay ç½‘ç»œä¸­çš„å®¹å™¨å¯ä»¥ç›´æ¥é€šä¿¡ï¼ŒåŒæ—¶ docker ä¹Ÿå®ç°äº† DNS æœåŠ¡\nå®ç°åŸç† docker ä¼šä¸ºæ¯ä¸ª overlay ç½‘ç»œåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ network namespaceï¼Œå…¶ä¸­ä¼šæœ‰ä¸€ä¸ª linux bridge br0ï¼Œ veth pair ä¸€ç«¯è¿æ¥åˆ°å®¹å™¨ä¸­ï¼ˆå³ eth0ï¼‰ï¼Œå¦ä¸€ç«¯è¿æ¥åˆ° namespace çš„ br0 ä¸Šã€‚\nbr0 é™¤äº†è¿æ¥æ‰€æœ‰çš„ veth pairï¼Œè¿˜ä¼šè¿æ¥ä¸€ä¸ª vxlan è®¾å¤‡ï¼Œç”¨äºä¸å…¶ä»– host å»ºç«‹ vxlan tunnelã€‚å®¹å™¨ä¹‹é—´çš„æ•°æ®å°±æ˜¯é€šè¿‡è¿™ä¸ª tunnel é€šä¿¡çš„ã€‚é€»è¾‘ç½‘ç»œæ‹“æ‰‘ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼š\n[root@node-2 ~]# brctl show bridge name bridge id STP enabled interfaces docker0 8000.024217edc413 no docker_gwbridge 8000.0242c5450937 no vethc59120e virbr0 8000.525400b76fd4 yes virbr0-nic [root@node-3 ~]# brctl show bridge name bridge id STP enabled interfaces docker0 8000.0242ef3c7df7 no docker_gwbridge 8000.0242c81afaee no vethf4562a9 virbr0 8000.525400c28478 yes virbr0-nic è¦æŸ¥çœ‹ overlay ç½‘ç»œçš„ namespace å¯ä»¥åœ¨ node-2 å’Œ node-3 ä¸Šæ‰§è¡Œ ip netnsï¼ˆè¯·ç¡®ä¿åœ¨æ­¤ä¹‹å‰æ‰§è¡Œè¿‡ ln -s /var/run/docker/netns /var/run/netnsï¼‰ï¼Œå¯ä»¥çœ‹åˆ°ä¸¤ä¸ª node ä¸Šæœ‰ä¸€ä¸ªç›¸åŒçš„ namespace \u0026ldquo;1-dd91de7599\u0026rdquo;\n[root@node-2 ~]# ln -s /var/run/docker/netns /var/run/netns [root@node-2 ~]# ip netns 6889f61efc4b (id: 1) 1-dd91de7599 (id: 0) [root@node-3 ~]# ln -s /var/run/docker/netns /var/run/netns [root@node-3 ~]# ip netns 8e4722847745 (id: 1) 1-dd91de7599 (id: 0) \u0026ldquo;1-dd91de7599\u0026rdquo; è¿™å°±æ˜¯ ov_net1 çš„ namespaceï¼ŒæŸ¥çœ‹ namespace ä¸­çš„ br0 ä¸Šçš„è®¾å¤‡\n[root@node-2 ~]# ip netns exec 1-dd91de7599 brctl show bridge name bridge id STP enabled interfaces br0 8000.0e7576c7c035 no veth0 vxlan0 5.6 overlay ç½‘ç»œéš”ç¦» ä¸åŒçš„ overlay ç½‘ç»œæ˜¯ç›¸äº’éš”ç¦»çš„ã€‚æˆ‘ä»¬åˆ›å»ºç¬¬äºŒä¸ª overlay ç½‘ç»œ ov_net2 å¹¶è¿è¡Œå®¹å™¨ bbox-3\nåˆ›å»ºç½‘ç»œ ov_net2 [root@node-2 ~]# docker network create -d overlay ov_net2 å¯åŠ¨å®¹å™¨ bbox-3 [root@node-2 ~]# docker run -itd --name bbox-3 --network ov_net2 busybox æŸ¥çœ‹ bbox-3 ç½‘ç»œ bbox-3 åˆ†é…åˆ°çš„ IP æ˜¯ 10.0.1.2ï¼Œå°è¯• ping bbox-1ï¼ˆ10.0.0.2ï¼‰\n[root@node-2 ~]# docker exec -it bbox-3 ip r default via 172.18.0.1 dev eth1 10.0.1.0/24 dev eth0 scope link src 10.0.1.2 172.18.0.0/16 dev eth1 scope link src 172.18.0.3 [root@node-2 ~]# docker exec -it bbox-3 ping -c 4 10.0.0.2 PING 10.0.0.2 (10.0.0.2): 56 data bytes --- 10.0.0.2 ping statistics --- 4 packets transmitted, 0 packets received, 100% packet loss [root@node-2 ~]# docker exec -it bbox-3 ping -c 4 172.18.0.2 PING 172.18.0.2 (172.18.0.2): 56 data bytes --- 172.18.0.2 ping statistics --- 4 packets transmitted, 0 packets received, 100% packet loss ping å¤±è´¥ï¼Œå¯è§ä¸åŒ overlay ç½‘ç»œä¹‹é—´æ˜¯éš”ç¦»çš„ï¼Œå³ä½¿é€šè¿‡ docker_gwbridge ä¹Ÿä¸èƒ½é€šä¿¡\nå¦‚æœè¦å®ç° bbox-3 å’Œ bbox-1 é€šä¿¡ï¼Œå¯ä»¥å°† bbox-3 ä¹Ÿè¿æ¥åˆ° ov_net1\nè¿™æ—¶ bbox-3 åŒæ—¶è¿æ¥åˆ°äº† ov_net1 å’Œ ov_net2 ä¸Š\n[root@node-2 ~]# docker network connect ov_net1 bbox-3 [root@node-2 ~]# docker exec bbox-3 ip r default via 172.18.0.1 dev eth1 10.0.0.0/24 dev eth2 scope link src 10.0.0.4 10.0.1.0/24 dev eth0 scope link src 10.0.1.2 172.18.0.0/16 dev eth1 scope link src 172.18.0.3 [root@node-2 ~]# docker exec bbox-3 ping -c 4 10.0.0.2 PING 10.0.0.2 (10.0.0.2): 56 data bytes 64 bytes from 10.0.0.2: seq=0 ttl=64 time=0.184 ms 64 bytes from 10.0.0.2: seq=1 ttl=64 time=0.158 ms 64 bytes from 10.0.0.2: seq=2 ttl=64 time=0.162 ms 64 bytes from 10.0.0.2: seq=3 ttl=64 time=0.093 ms --- 10.0.0.2 ping statistics --- 4 packets transmitted, 4 packets received, 0% packet loss round-trip min/avg/max = 0.093/0.149/0.184 ms docker é»˜è®¤ä¸º overlay ç½‘ç»œåˆ†é… 24 ä½æ©ç çš„å­ç½‘ï¼ˆ10.0.X.0/24ï¼‰ï¼Œæ‰€æœ‰ä¸»æœºå…±äº«è¿™ä¸ª subnetï¼Œå®¹å™¨å¯åŠ¨æ—¶ä¼šé¡ºåºä»æ­¤ç©ºé—´åˆ†é… IPã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ \u0026ndash;subnet æŒ‡å®š IP ç©ºé—´ã€‚\ndocker network create -d overlay --subnet 10.22.1.0/24 ov_net ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/docker-rong-qi-kua-zhu-ji-lian-jie/","summary":"0 å‰è¨€ å®ç°è·¨ä¸»æœºçš„ docker å®¹å™¨ä¹‹é—´çš„é€šè®¯ï¼š ä½¿ç”¨ç½‘æ¡¥å®ç°è·¨ä¸»æœºçš„è¿æ¥ docker åŸç”Ÿçš„ç½‘ç»œï¼šoverlayã€macvlan ç¬¬ä¸‰æ–¹ç½‘ç»œï¼šflaanelã€weaveã€calic 1 ç½‘æ¡¥ 2 open vswitch 3 weave 4 macvlan 4.1 ç®€ä»‹ macvlan æ˜¯ Linux æ“ä½œç³»ç»Ÿå†…æ ¸æä¾›çš„ç½‘ç»œè™šæ‹ŸåŒ–æ–¹æ¡ˆä¹‹ä¸€ï¼Œæ›´å‡†ç¡®çš„è¯´æ³•æ˜¯ç½‘å¡è™šæ‹ŸåŒ–æ–¹æ¡ˆã€‚å®ƒå¯ä»¥ä¸ºä¸€å¼ ç‰©ç†ç½‘å¡è®¾ç½®å¤š","title":"docker | å®¹å™¨çš„è·¨ä¸»æœºè¿æ¥"},{"content":"1 å®¹å™¨æ“ä½œ 1.1 run åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨å¹¶è¿è¡Œä¸€ä¸ªå‘½ä»¤\nè¯­æ³•: docker run [OPTIONS] IMAGE [COMMAND] [ARGâ€¦]\nOPTIONS è¯´æ˜ï¼š\n-a stdin: æŒ‡å®šæ ‡å‡†è¾“å…¥è¾“å‡ºå†…å®¹ç±»å‹ï¼Œå¯é€‰ STDIN/STDOUT/STDERR ä¸‰é¡¹ï¼› -d: åå°è¿è¡Œå®¹å™¨ï¼Œå¹¶è¿”å›å®¹å™¨IDï¼› -i: ä»¥äº¤äº’æ¨¡å¼è¿è¡Œå®¹å™¨ï¼Œé€šå¸¸ä¸ -t åŒæ—¶ä½¿ç”¨ï¼› -P: éšæœºç«¯å£æ˜ å°„ï¼Œå®¹å™¨å†…éƒ¨ç«¯å£éšæœºæ˜ å°„åˆ°ä¸»æœºçš„é«˜ç«¯å£ -p: æŒ‡å®šç«¯å£æ˜ å°„ï¼Œæ ¼å¼ä¸ºï¼šä¸»æœº(å®¿ä¸»)ç«¯å£:å®¹å™¨ç«¯å£ 1. åªæŒ‡å®šå®¹å™¨ç«¯å£ï¼ˆå®¿ä¸»æœºç«¯å£éšæœºæ˜ å°„ï¼‰ docker run -p 80 -it ubuntu /bin/bash 2. ä¸»æœºç«¯å£ï¼šå®¹å™¨ç«¯å£ docker run -p 8080:80 -it ubuntu /bin/bash 3. IPï¼šå®¹å™¨ç«¯å£ docker run -p 0.0.0.0:80 -it ubuntu /bin/bash 4. IPï¼šç«¯å£ï¼šå®¹å™¨ç«¯å£ dokcer run -p 0.0.0.0:8080:80 -it ubuntu /bin/bash -t: ä¸ºå®¹å™¨é‡æ–°åˆ†é…ä¸€ä¸ªä¼ªè¾“å…¥ç»ˆç«¯ï¼Œé€šå¸¸ä¸ -i åŒæ—¶ä½¿ç”¨ï¼› --name=\u0026#34;nginx-lb\u0026#34;: ä¸ºå®¹å™¨æŒ‡å®šä¸€ä¸ªåç§°ï¼› --dns 8.8.8.8: æŒ‡å®šå®¹å™¨ä½¿ç”¨çš„DNSæœåŠ¡å™¨ï¼Œé»˜è®¤å’Œå®¿ä¸»ä¸€è‡´ï¼› --dns-search example.com: æŒ‡å®šå®¹å™¨DNSæœç´¢åŸŸåï¼Œé»˜è®¤å’Œå®¿ä¸»ä¸€è‡´ï¼› -h \u0026#34;mars\u0026#34;: æŒ‡å®šå®¹å™¨çš„hostnameï¼› -e username=\u0026#34;ritchie\u0026#34;: è®¾ç½®ç¯å¢ƒå˜é‡ï¼› -env-file=[]: ä»æŒ‡å®šæ–‡ä»¶è¯»å…¥ç¯å¢ƒå˜é‡ï¼› --cpuset=\u0026#34;0-2\u0026#34; or --cpuset=\u0026#34;0,1,2\u0026#34;: ç»‘å®šå®¹å™¨åˆ°æŒ‡å®šCPUè¿è¡Œï¼› -m :è®¾ç½®å®¹å™¨ä½¿ç”¨å†…å­˜æœ€å¤§å€¼ï¼› --net=\u0026#34;bridge\u0026#34;: æŒ‡å®šå®¹å™¨çš„ç½‘ç»œè¿æ¥ç±»å‹ï¼Œæ”¯æŒ bridge/host/none/container: å››ç§ç±»å‹ï¼› --link=[]: æ·»åŠ é“¾æ¥åˆ°å¦ä¸€ä¸ªå®¹å™¨ï¼› --expose=[]: å¼€æ”¾ä¸€ä¸ªç«¯å£æˆ–ä¸€ç»„ç«¯å£ï¼› --volume , -v: ç»‘å®šä¸€ä¸ªå· -v [hostpath]:containerpath:[ro|wo|rw] å¦‚æœæ²¡æœ‰è®¾ç½® hostpath åˆ™æŒ‚è½½åˆ° /var/lib/docker/volumes/\u0026lt;containerid\u0026gt;/ ç›®å½•ä¸‹ å¦‚æœæ²¡æœ‰è®¾ç½®æƒé™ï¼Œé»˜è®¤ rw(è¯»å†™) å®ä¾‹\nä½¿ç”¨ docker é•œåƒ nginx:latest ä»¥åå°æ¨¡å¼å¯åŠ¨ä¸€ä¸ªå®¹å™¨,å¹¶å°†å®¹å™¨å‘½åä¸º mynginxã€‚\ndocker run --name mynginx -d nginx:latest ä½¿ç”¨é•œåƒ nginx:latest ä»¥åå°æ¨¡å¼å¯åŠ¨ä¸€ä¸ªå®¹å™¨,å¹¶å°†å®¹å™¨çš„ 80 ç«¯å£æ˜ å°„åˆ°ä¸»æœºéšæœºç«¯å£ã€‚\ndocker run -P -d nginx:latest ä½¿ç”¨é•œåƒ nginx:latestï¼Œä»¥åå°æ¨¡å¼å¯åŠ¨ä¸€ä¸ªå®¹å™¨,å°†å®¹å™¨çš„ 80 ç«¯å£æ˜ å°„åˆ°ä¸»æœºçš„ 80 ç«¯å£,ä¸»æœºçš„ç›®å½• /data æ˜ å°„åˆ°å®¹å™¨çš„ /dataã€‚\ndocker run -p 80:80 -v /data:/data -d nginx:latest ç»‘å®šå®¹å™¨çš„ 8080 ç«¯å£ï¼Œå¹¶å°†å…¶æ˜ å°„åˆ°æœ¬åœ°ä¸»æœº 127.0.0.1 çš„ 80 ç«¯å£ä¸Šã€‚\ndocker run -p 127.0.0.1:80:8080/tcp ubuntu bash ä½¿ç”¨é•œåƒ nginx:latest ä»¥äº¤äº’æ¨¡å¼å¯åŠ¨ä¸€ä¸ªå®¹å™¨,åœ¨å®¹å™¨å†…æ‰§è¡Œ/bin/bash å‘½ä»¤ã€‚\nrunoob@runoob:~$ docker run -it nginx:latest /bin/bash root@b8573233d675:/# 1.2 ps åˆ—å‡ºå®¹å™¨\nè¯­æ³•: docker ps [OPTIONS]\nOPTIONS è¯´æ˜ï¼š\n-a: æ˜¾ç¤ºæ‰€æœ‰çš„å®¹å™¨ï¼ŒåŒ…æ‹¬æœªè¿è¡Œçš„ã€‚ -f: æ ¹æ®æ¡ä»¶è¿‡æ»¤æ˜¾ç¤ºçš„å†…å®¹ã€‚ --format: æŒ‡å®šè¿”å›å€¼çš„æ¨¡æ¿æ–‡ä»¶ã€‚ -l: æ˜¾ç¤ºæœ€è¿‘åˆ›å»ºçš„å®¹å™¨ã€‚ -n: åˆ—å‡ºæœ€è¿‘åˆ›å»ºçš„nä¸ªå®¹å™¨ã€‚ --no-trunc: ä¸æˆªæ–­è¾“å‡ºã€‚ -q: é™é»˜æ¨¡å¼ï¼Œåªæ˜¾ç¤ºå®¹å™¨ç¼–å·ã€‚ -s: æ˜¾ç¤ºæ€»çš„æ–‡ä»¶å¤§å°ã€‚ å®ä¾‹\nåˆ—å‡ºæ‰€æœ‰åœ¨è¿è¡Œçš„å®¹å™¨ä¿¡æ¯ã€‚\nrunoob@runoob:~$ docker ps CONTAINER ID IMAGE COMMAND ... PORTS NAMES 09b93464c2f7 nginx:latest \u0026#34;nginx -g \u0026#39;daemon off\u0026#34; ... 80/tcp, 443/tcp myrunoob 96f7f14e99ab mysql:5.6 \u0026#34;docker-entrypoint.sh\u0026#34; ... 0.0.0.0:3306-\u0026gt;3306/tcp mymysql åˆ—å‡ºæœ€è¿‘åˆ›å»ºçš„ 5 ä¸ªå®¹å™¨ä¿¡æ¯ã€‚\nrunoob@runoob:~$ docker ps -n 5 CONTAINER ID IMAGE COMMAND CREATED 09b93464c2f7 nginx:latest \u0026#34;nginx -g \u0026#39;daemon off\u0026#34; 2 days ago ... b8573233d675 nginx:latest \u0026#34;/bin/bash\u0026#34; 2 days ago ... b1a0703e41e7 nginx:latest \u0026#34;nginx -g \u0026#39;daemon off\u0026#34; 2 days ago ... f46fb1dec520 5c6e1090e771 \u0026#34;/bin/sh -c \u0026#39;set -x \\t\u0026#34; 2 days ago ... a63b4a5597de 860c279d2fec \u0026#34;bash\u0026#34; 2 days ago ... åˆ—å‡ºæ‰€æœ‰åˆ›å»ºçš„å®¹å™¨ IDã€‚\nrunoob@runoob:~$ docker ps -a -q 09b93464c2f7 b8573233d675 b1a0703e41e7 f46fb1dec520 a63b4a5597de 6a4aa42e947b de7bb36e7968 43a432b73776 664a8ab1a585 ba52eb632bbd 1.3 inspect docker inspect : è·å–å®¹å™¨/é•œåƒçš„å…ƒæ•°æ®ã€‚\nè¯­æ³•: docker inspect [OPTIONS] NAME|ID [NAME|IDâ€¦]\nOPTIONS è¯´æ˜ï¼š\n-f :æŒ‡å®šè¿”å›å€¼çš„æ¨¡æ¿æ–‡ä»¶ã€‚ -s :æ˜¾ç¤ºæ€»çš„æ–‡ä»¶å¤§å°ã€‚ --type json:ä¸ºæŒ‡å®šç±»å‹è¿”å›JSONã€‚ --format :ä»¥æŒ‡å®šæ ¼å¼è¿”å›æ•°æ® è·å–æ‰€æœ‰å®¹å™¨çš„ ip åœ°å€\ndocker inspect --format=\u0026#39;{{.Name}} - {{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}\u0026#39; $(docker ps -aq) è·å–æŸä¸ªå®¹å™¨çš„æŒ‚è½½ä¿¡æ¯\ndocker inspect --format=\u0026#39;{{json .Mounts}}\u0026#39; demo-volume-2 | python -m json.tool 1.4 start/stop/restart å¯åŠ¨çš„å®¹å™¨; åœæ­¢å®¹å™¨; é‡å¯å®¹å™¨\nè¯­æ³•: docker start|stop|restart [OPTIONS] CONTAINER [CONTAINERâ€¦]\nå®ä¾‹\n# å¯åŠ¨å·²è¢«åœæ­¢çš„å®¹å™¨ myrunoob docker start myrunoob # åœæ­¢è¿è¡Œä¸­çš„å®¹å™¨ myrunoob docker stop myrunoob # é‡å¯å®¹å™¨ myrunoob docker restart myrunoob 1.5 rm åˆ é™¤ä¸€ä¸ªæˆ–å¤šå°‘å®¹å™¨\nè¯­æ³•: docker rm [OPTIONS] CONTAINER [CONTAINERâ€¦]\nOPTIONS è¯´æ˜ï¼š\n-f :é€šè¿‡SIGKILLä¿¡å·å¼ºåˆ¶åˆ é™¤ä¸€ä¸ªè¿è¡Œä¸­çš„å®¹å™¨ -l :ç§»é™¤å®¹å™¨é—´çš„ç½‘ç»œè¿æ¥ï¼Œè€Œéå®¹å™¨æœ¬èº« -v :-v åˆ é™¤ä¸å®¹å™¨å…³è”çš„å· å®ä¾‹\nå¼ºåˆ¶åˆ é™¤å®¹å™¨ db01ã€db02\ndocker rm -f db01 db02 ç§»é™¤å®¹å™¨ nginx01 å¯¹å®¹å™¨ db01 çš„è¿æ¥ï¼Œè¿æ¥å db\ndocker rm -l db åˆ é™¤å®¹å™¨ nginx01,å¹¶åˆ é™¤å®¹å™¨æŒ‚è½½çš„æ•°æ®å·\ndocker rm -v nginx01 1.6 attach è¿æ¥åˆ°æ­£åœ¨è¿è¡Œä¸­çš„å®¹å™¨ã€‚\nè¯­æ³•: docker attach [OPTIONS] CONTAINER\nè¦ attach ä¸Šå»çš„å®¹å™¨å¿…é¡»æ­£åœ¨è¿è¡Œï¼Œå¯ä»¥åŒæ—¶è¿æ¥ä¸ŠåŒä¸€ä¸ª container æ¥å…±äº«å±å¹•ï¼ˆä¸ screen å‘½ä»¤çš„ attach ç±»ä¼¼ï¼‰ã€‚\nå®˜æ–¹æ–‡æ¡£ä¸­è¯´ attach åå¯ä»¥é€šè¿‡ CTRL-C æ¥ detachï¼Œä½†å®é™…ä¸Šç»è¿‡æˆ‘çš„æµ‹è¯•ï¼Œå¦‚æœ container å½“å‰åœ¨è¿è¡Œ bashï¼ŒCTRL-C è‡ªç„¶æ˜¯å½“å‰è¡Œçš„è¾“å…¥ï¼Œæ²¡æœ‰é€€å‡ºï¼›å¦‚æœ container å½“å‰æ­£åœ¨å‰å°è¿è¡Œè¿›ç¨‹ï¼Œå¦‚è¾“å‡º nginx çš„ access.log æ—¥å¿—ï¼ŒCTRL-C ä¸ä»…ä¼šå¯¼è‡´é€€å‡ºå®¹å™¨ï¼Œè€Œä¸”è¿˜ stop äº†ã€‚è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œdetach çš„æ„æ€æŒ‰ç†åº”è¯¥æ˜¯è„±ç¦»å®¹å™¨ç»ˆç«¯ï¼Œä½†å®¹å™¨ä¾ç„¶è¿è¡Œã€‚å¥½åœ¨ attach æ˜¯å¯ä»¥å¸¦ä¸Š \u0026ndash;sig-proxy=false æ¥ç¡®ä¿ CTRL-D æˆ– CTRL-C ä¸ä¼šå…³é—­å®¹å™¨ã€‚\nå®ä¾‹\nå®¹å™¨ mynginx å°†è®¿é—®æ—¥å¿—æŒ‡åˆ°æ ‡å‡†è¾“å‡ºï¼Œè¿æ¥åˆ°å®¹å™¨æŸ¥çœ‹è®¿é—®ä¿¡æ¯ã€‚\nrunoob@runoob:~$ docker attach --sig-proxy=false mynginx 192.168.239.1 - - [10/Jul/2016:16:54:26 +0000] \u0026#34;GET / HTTP/1.1\u0026#34; 304 0 \u0026#34;-\u0026#34; \u0026#34;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.93 Safari/537.36\u0026#34; \u0026#34;-\u0026#34; 1.7 logs docker logs : è·å–å®¹å™¨çš„æ—¥å¿—\nè¯­æ³•: docker logs [OPTIONS] CONTAINER\nOPTIONS è¯´æ˜ï¼š\n-f : è·Ÿè¸ªæ—¥å¿—è¾“å‡ºã€‚ç±»ä¼¼ tail å‘½ä»¤çš„ -f é€‰é¡¹ --since :æ˜¾ç¤ºæŸä¸ªå¼€å§‹æ—¶é—´çš„æ‰€æœ‰æ—¥å¿— -t : æ˜¾ç¤ºæ—¶é—´æˆ³ --tail :ä»…åˆ—å‡ºæœ€æ–°Næ¡å®¹å™¨æ—¥å¿— å®ä¾‹\nè·Ÿè¸ªæŸ¥çœ‹å®¹å™¨ mynginx çš„æ—¥å¿—è¾“å‡ºã€‚\nrunoob@runoob:~$ docker logs -f mynginx 192.168.239.1 - - [10/Jul/2016:16:53:33 +0000] \u0026#34;GET / HTTP/1.1\u0026#34; 200 612 \u0026#34;-\u0026#34; \u0026#34;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.93 Safari/537.36\u0026#34; \u0026#34;-\u0026#34; 2016/07/10 16:53:33 [error] 5#5: *1 open() \u0026#34;/usr/share/nginx/html/favicon.ico\u0026#34; failed (2: No such file or directory), client: 192.168.239.1, server: localhost, request: \u0026#34;GET /favicon.ico HTTP/1.1\u0026#34;, host: \u0026#34;192.168.239.130\u0026#34;, referrer: \u0026#34;http://192.168.239.130/\u0026#34; 192.168.239.1 - - [10/Jul/2016:16:53:33 +0000] \u0026#34;GET /favicon.ico HTTP/1.1\u0026#34; 404 571 \u0026#34;http://192.168.239.130/\u0026#34; \u0026#34;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.93 Safari/537.36\u0026#34; \u0026#34;-\u0026#34; 192.168.239.1 - - [10/Jul/2016:16:53:59 +0000] \u0026#34;GET / HTTP/1.1\u0026#34; 304 0 \u0026#34;-\u0026#34; \u0026#34;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.93 Safari/537.36\u0026#34; \u0026#34;-\u0026#34; ... æŸ¥çœ‹å®¹å™¨ mynginx ä» 2016 å¹´ 7 æœˆ 1 æ—¥åçš„æœ€æ–° 10 æ¡æ—¥å¿—ã€‚\ndocker logs --since=\u0026#34;2016-07-01\u0026#34; --tail=10 mynginx 1.8 top æŸ¥çœ‹å®¹å™¨ä¸­è¿è¡Œçš„è¿›ç¨‹ä¿¡æ¯ï¼Œæ”¯æŒ ps å‘½ä»¤å‚æ•°ã€‚\nè¯­æ³•: docker top [OPTIONS] CONTAINER [ps OPTIONS]\nå®¹å™¨è¿è¡Œæ—¶ä¸ä¸€å®šæœ‰/bin/bash ç»ˆç«¯æ¥äº¤äº’æ‰§è¡Œ top å‘½ä»¤ï¼Œè€Œä¸”å®¹å™¨è¿˜ä¸ä¸€å®šæœ‰ top å‘½ä»¤ï¼Œå¯ä»¥ä½¿ç”¨ docker top æ¥å®ç°æŸ¥çœ‹ container ä¸­æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ã€‚\nå®ä¾‹\næŸ¥çœ‹å®¹å™¨ mymysql çš„è¿›ç¨‹ä¿¡æ¯ã€‚\nrunoob@runoob:~/mysql$ docker top mymysql UID PID PPID C STIME TTY TIME CMD 999 40347 40331 18 00:58 ? 00:00:02 mysqld æŸ¥çœ‹æ‰€æœ‰è¿è¡Œå®¹å™¨çš„è¿›ç¨‹ä¿¡æ¯ã€‚\nfor i in `docker ps |grep Up|awk \u0026#39;{print $1}\u0026#39;`;do echo \\ \u0026amp;\u0026amp;docker top $i; done 1.9 exec åœ¨è¿è¡Œçš„å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤\nè¯­æ³•: docker exec [OPTIONS] CONTAINER COMMAND [ARGâ€¦]\nOPTIONS è¯´æ˜ï¼š\n-d :åˆ†ç¦»æ¨¡å¼: åœ¨åå°è¿è¡Œ -i :å³ä½¿æ²¡æœ‰é™„åŠ ä¹Ÿä¿æŒSTDIN æ‰“å¼€ -t :åˆ†é…ä¸€ä¸ªä¼ªç»ˆç«¯ å®ä¾‹\nåœ¨å®¹å™¨ mynginx ä¸­ä»¥äº¤äº’æ¨¡å¼æ‰§è¡Œå®¹å™¨å†… /root/runoob.sh è„šæœ¬:\nrunoob@runoob:~$ docker exec -it mynginx /bin/sh /root/runoob.sh http://www.runoob.com/ åœ¨å®¹å™¨ mynginx ä¸­å¼€å¯ä¸€ä¸ªäº¤äº’æ¨¡å¼çš„ç»ˆç«¯:\nrunoob@runoob:~$ docker exec -i -t mynginx /bin/bash root@b1a0703e41e7:/# ä¹Ÿå¯ä»¥é€šè¿‡ docker ps -a å‘½ä»¤æŸ¥çœ‹å·²ç»åœ¨è¿è¡Œçš„å®¹å™¨ï¼Œç„¶åä½¿ç”¨å®¹å™¨ ID è¿›å…¥å®¹å™¨ã€‚\næŸ¥çœ‹å·²ç»åœ¨è¿è¡Œçš„å®¹å™¨ IDï¼š\ndocker ps -a ... 9df70f9a0714 openjdk \u0026#34;/usercode/script.shâ€¦\u0026#34; ... ç¬¬ä¸€åˆ—çš„ 9df70f9a0714 å°±æ˜¯å®¹å™¨ IDã€‚\né€šè¿‡ exec å‘½ä»¤å¯¹æŒ‡å®šçš„å®¹å™¨æ‰§è¡Œ bash:\ndocker exec -it 9df70f9a0714 /bin/bash 1.10 kill æ€æ‰ä¸€ä¸ªè¿è¡Œä¸­çš„å®¹å™¨ã€‚\nè¯­æ³•: docker kill [OPTIONS] CONTAINER [CONTAINERâ€¦]\nOPTIONS è¯´æ˜ï¼š\n-s :å‘å®¹å™¨å‘é€ä¸€ä¸ªä¿¡å· å®ä¾‹\næ€æ‰è¿è¡Œä¸­çš„å®¹å™¨ mynginx\nrunoob@runoob:~$ docker kill -s KILL mynginx mynginx 2 é•œåƒæ“ä½œ 2.1 images docker images : åˆ—å‡ºæœ¬åœ°é•œåƒã€‚\nè¯­æ³•: docker images [OPTIONS] [REPOSITORY[:TAG]]\nOPTIONS è¯´æ˜ï¼š\n-a :åˆ—å‡ºæœ¬åœ°æ‰€æœ‰çš„é•œåƒï¼ˆå«ä¸­é—´æ˜ åƒå±‚ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè¿‡æ»¤æ‰ä¸­é—´æ˜ åƒå±‚ï¼‰ï¼› --digests :æ˜¾ç¤ºé•œåƒçš„æ‘˜è¦ä¿¡æ¯ï¼› -f :æ˜¾ç¤ºæ»¡è¶³æ¡ä»¶çš„é•œåƒï¼› --format :æŒ‡å®šè¿”å›å€¼çš„æ¨¡æ¿æ–‡ä»¶ï¼› --no-trunc :æ˜¾ç¤ºå®Œæ•´çš„é•œåƒä¿¡æ¯ï¼› -q :åªæ˜¾ç¤ºé•œåƒIDã€‚ å®ä¾‹\næŸ¥çœ‹æœ¬åœ°é•œåƒåˆ—è¡¨ã€‚\nrunoob@runoob:~$ docker images REPOSITORY TAG IMAGE ID CREATED SIZE mymysql v1 37af1236adef 5 minutes ago 329 MB runoob/ubuntu v4 1c06aa18edee 2 days ago 142.1 MB \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; 5c6e1090e771 2 days ago 165.9 MB httpd latest ed38aaffef30 11 days ago 195.1 MB alpine latest 4e38e38c8ce0 2 weeks ago 4.799 MB mongo 3.2 282fd552add6 3 weeks ago 336.1 MB redis latest 4465e4bcad80 3 weeks ago 185.7 MB php 5.6-fpm 025041cd3aa5 3 weeks ago 456.3 MB python 3.5 045767ddf24a 3 weeks ago 684.1 MB ... åˆ—å‡ºæœ¬åœ°é•œåƒä¸­ REPOSITORY ä¸º ubuntu çš„é•œåƒåˆ—è¡¨ã€‚\nroot@runoob:~# docker images ubuntu REPOSITORY TAG IMAGE ID CREATED SIZE ubuntu 14.04 90d5884b1ee0 9 weeks ago 188 MB ubuntu 15.10 4e3b13c8a266 3 months ago 136.3 MB 2.2 inspect è·å–å®¹å™¨/é•œåƒçš„å…ƒæ•°æ®ã€‚\nè¯­æ³•: docker inspect [OPTIONS] NAME|ID [NAME|IDâ€¦]\nOPTIONS è¯´æ˜ï¼š\n-f :æŒ‡å®šè¿”å›å€¼çš„æ¨¡æ¿æ–‡ä»¶ã€‚ -s :æ˜¾ç¤ºæ€»çš„æ–‡ä»¶å¤§å°ã€‚ --type :ä¸ºæŒ‡å®šç±»å‹è¿”å›JSONã€‚ --format :ä»¥æŒ‡å®šæ ¼å¼è¿”å›æ•°æ® å®ä¾‹\nè·å–é•œåƒ mysql:5.6 çš„å…ƒä¿¡æ¯ã€‚\nrunoob@runoob:~$ docker inspect mysql:5.6 [ { \u0026#34;Id\u0026#34;: \u0026#34;sha256:2c0964ec182ae9a045f866bbc2553087f6e42bfc16074a74fb820af235f070ec\u0026#34;, \u0026#34;RepoTags\u0026#34;: [ \u0026#34;mysql:5.6\u0026#34; ], \u0026#34;RepoDigests\u0026#34;: [], \u0026#34;Parent\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;Comment\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;Created\u0026#34;: \u0026#34;2016-05-24T04:01:41.168371815Z\u0026#34;, \u0026#34;Container\u0026#34;: \u0026#34;e0924bc460ff97787f34610115e9363e6363b30b8efa406e28eb495ab199ca54\u0026#34;, \u0026#34;ContainerConfig\u0026#34;: { \u0026#34;Hostname\u0026#34;: \u0026#34;b0cf605c7757\u0026#34;, \u0026#34;Domainname\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;User\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;AttachStdin\u0026#34;: false, \u0026#34;AttachStdout\u0026#34;: false, \u0026#34;AttachStderr\u0026#34;: false, \u0026#34;ExposedPorts\u0026#34;: { \u0026#34;3306/tcp\u0026#34;: {} }, ... 2.3 rmi åˆ é™¤æœ¬åœ°ä¸€ä¸ªæˆ–å¤šå°‘é•œåƒã€‚\nè¯­æ³•: docker rmi [OPTIONS] IMAGE [IMAGEâ€¦]\nOPTIONS è¯´æ˜ï¼š\n-f :å¼ºåˆ¶åˆ é™¤ï¼› --no-prune :ä¸ç§»é™¤è¯¥é•œåƒçš„è¿‡ç¨‹é•œåƒï¼Œé»˜è®¤ç§»é™¤ï¼› æ³¨ï¼šIMAGE å¯ä»¥ä½¿ç”¨ [ä»“åº“ï¼šæ ‡ç­¾] çš„æ ¼å¼ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é•œåƒ IDï¼Œå¯ä»¥åŒæ—¶åˆ é™¤å¤šä¸ªé•œåƒ\n1ã€ä½¿ç”¨ [ä»“åº“ï¼šæ ‡ç­¾] çš„æ ¼å¼ï¼šåˆ é™¤ä¸€ä¸ªæ ‡ç­¾ã€‚å½“ä¸€ä¸ªé•œåƒæ–‡ä»¶æœ‰å¤šä¸ªæ ‡ç­¾æ—¶ï¼Œåˆ é™¤å®Œæ‰€æœ‰çš„æ ‡ç­¾ï¼Œé•œåƒæ–‡ä»¶ä¹Ÿéšä¹‹åˆ é™¤\n2ã€ä½¿ç”¨é•œåƒ ID çš„æ ¼å¼ï¼šå…ˆå°†è¯¥é•œåƒæ–‡ä»¶çš„æ‰€æœ‰æ ‡ç­¾åˆ é™¤ï¼Œå†åˆ é™¤é•œåƒæ–‡ä»¶\nåˆ é™¤æ‰€æœ‰é•œåƒ\ndocker rmi $(docker images -q) åˆ é™¤æŸä¸ªä»“åº“çš„æ‰€æœ‰é•œåƒ\ndocker rmi $(docker images -q ubuntu) å®ä¾‹\nå¼ºåˆ¶åˆ é™¤æœ¬åœ°é•œåƒ runoob/ubuntu:v4ã€‚\nroot@runoob:~# docker rmi -f runoob/ubuntu:v4 Untagged: runoob/ubuntu:v4 Deleted: sha256:1c06aa18edee44230f93a90a7d88139235de12cd4c089d41eed8419b503072be Deleted: sha256:85feb446e89a28d58ee7d80ea5ce367eebb7cec70f0ec18aa4faa874cbd97c73 2.4 search è¯­æ³•: docker search [OPTIONS] TERM\nOPTIONS è¯´æ˜ï¼š\n--automated :åªåˆ—å‡º automated buildç±»å‹çš„é•œåƒï¼› --no-trunc :æ˜¾ç¤ºå®Œæ•´çš„é•œåƒæè¿°ï¼› -s :åˆ—å‡ºæ”¶è—æ•°ä¸å°äºæŒ‡å®šå€¼çš„é•œåƒã€‚ å®ä¾‹\nä» Docker Hub æŸ¥æ‰¾æ‰€æœ‰é•œåƒååŒ…å« javaï¼Œå¹¶ä¸”æ”¶è—æ•°å¤§äº 10 çš„é•œåƒ\nrunoob@runoob:~$ docker search -s 10 java NAME DESCRIPTION STARS OFFICIAL AUTOMATED java Java is a concurrent, class-based... 1037 [OK] anapsix/alpine-java Oracle Java 8 (and 7) with GLIBC ... 115 [OK] develar/java 46 [OK] isuper/java-oracle This repository contains all java... 38 [OK] lwieske/java-8 Oracle Java 8 Container - Full + ... 27 [OK] nimmis/java-centos This is docker images of CentOS 7... 13 [OK] 2.5 pull docker pull [OPTIONS] NAME[:TAG|@DIGEST]\nOPTIONS è¯´æ˜ï¼š\n-a :æ‹‰å–æ‰€æœ‰ tagged é•œåƒ --disable-content-trust :å¿½ç•¥é•œåƒçš„æ ¡éªŒ,é»˜è®¤å¼€å¯ å®ä¾‹\nä» Docker Hub ä¸‹è½½ java æœ€æ–°ç‰ˆé•œåƒã€‚\ndocker pull java ä» Docker Hub ä¸‹è½½ REPOSITORY ä¸º java çš„æ‰€æœ‰é•œåƒã€‚\ndocker pull -a java 2.6 push å°†æœ¬åœ°çš„é•œåƒä¸Šä¼ åˆ°é•œåƒä»“åº“,è¦å…ˆç™»é™†åˆ°é•œåƒä»“åº“\nè¯­æ³•: docker push [OPTIONS] NAME[:TAG]\nOPTIONS è¯´æ˜ï¼š\n--disable-content-trust :å¿½ç•¥é•œåƒçš„æ ¡éªŒ,é»˜è®¤å¼€å¯ å®ä¾‹\nä¸Šä¼ æœ¬åœ°é•œåƒ myapache:v1 åˆ°é•œåƒä»“åº“ä¸­ã€‚\ndocker push myapache:v1 2.7 commit ä»å®¹å™¨åˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒã€‚\nè¯­æ³•: docker commit [OPTIONS] CONTAINER [REPOSITORY[:TAG]]\nOPTIONS è¯´æ˜ï¼š\n-a :æäº¤çš„é•œåƒä½œè€…ï¼› -c :ä½¿ç”¨DockerfileæŒ‡ä»¤æ¥åˆ›å»ºé•œåƒï¼› -m :æäº¤æ—¶çš„è¯´æ˜æ–‡å­—ï¼› -p :åœ¨commitæ—¶ï¼Œå°†å®¹å™¨æš‚åœã€‚ å®ä¾‹\nå°†å®¹å™¨ a404c6c174a2 ä¿å­˜ä¸ºæ–°çš„é•œåƒ,å¹¶æ·»åŠ æäº¤äººä¿¡æ¯å’Œè¯´æ˜ä¿¡æ¯ã€‚\nrunoob@runoob:~$ docker commit -a \u0026#34;runoob.com\u0026#34; -m \u0026#34;my apache\u0026#34; a404c6c174a2 mymysql:v1 sha256:37af1236adef1544e8886be23010b66577647a40bc02c0885a6600b33ee28057 runoob@runoob:~$ docker images mymysql:v1 REPOSITORY TAG IMAGE ID CREATED SIZE mymysql v1 37af1236adef 15 seconds ago 329 MB 2.8 build ç”¨äºä½¿ç”¨ Dockerfile åˆ›å»ºé•œåƒã€‚\nè¯­æ³•: docker build [OPTIONS] PATH | URL | -\nOPTIONS è¯´æ˜ï¼š\n--build-arg=[] :è®¾ç½®é•œåƒåˆ›å»ºæ—¶çš„å˜é‡ï¼› --cpu-shares :è®¾ç½® cpu ä½¿ç”¨æƒé‡ï¼› --cpu-period :é™åˆ¶ CPU CFSå‘¨æœŸï¼› --cpu-quota :é™åˆ¶ CPU CFSé…é¢ï¼› --cpuset-cpus :æŒ‡å®šä½¿ç”¨çš„CPU idï¼› --cpuset-mems :æŒ‡å®šä½¿ç”¨çš„å†…å­˜ idï¼› --disable-content-trust :å¿½ç•¥æ ¡éªŒï¼Œé»˜è®¤å¼€å¯ï¼› -f :æŒ‡å®šè¦ä½¿ç”¨çš„Dockerfileè·¯å¾„ï¼› --force-rm :è®¾ç½®é•œåƒè¿‡ç¨‹ä¸­åˆ é™¤ä¸­é—´å®¹å™¨ï¼› --isolation :ä½¿ç”¨å®¹å™¨éš”ç¦»æŠ€æœ¯ï¼› --label=[] :è®¾ç½®é•œåƒä½¿ç”¨çš„å…ƒæ•°æ®ï¼› -m :è®¾ç½®å†…å­˜æœ€å¤§å€¼ï¼› --memory-swap :è®¾ç½®Swapçš„æœ€å¤§å€¼ä¸ºå†…å­˜+swapï¼Œ\u0026#34;-1\u0026#34;è¡¨ç¤ºä¸é™swapï¼› --no-cache :åˆ›å»ºé•œåƒçš„è¿‡ç¨‹ä¸ä½¿ç”¨ç¼“å­˜ï¼› --pull :å°è¯•å»æ›´æ–°é•œåƒçš„æ–°ç‰ˆæœ¬ï¼› --quiet, -q :å®‰é™æ¨¡å¼ï¼ŒæˆåŠŸååªè¾“å‡ºé•œåƒ IDï¼› --rm :è®¾ç½®é•œåƒæˆåŠŸååˆ é™¤ä¸­é—´å®¹å™¨ï¼› --shm-size :è®¾ç½®/dev/shmçš„å¤§å°ï¼Œé»˜è®¤å€¼æ˜¯64Mï¼› --ulimit :Ulimité…ç½®ã€‚ --tag, -t: é•œåƒçš„åå­—åŠæ ‡ç­¾ï¼Œé€šå¸¸ name:tag æˆ–è€… name æ ¼å¼ï¼›å¯ä»¥åœ¨ä¸€æ¬¡æ„å»ºä¸­ä¸ºä¸€ä¸ªé•œåƒè®¾ç½®å¤šä¸ªæ ‡ç­¾ã€‚ --network: é»˜è®¤ defaultã€‚åœ¨æ„å»ºæœŸé—´è®¾ç½®RUNæŒ‡ä»¤çš„ç½‘ç»œæ¨¡å¼ å®ä¾‹\nä½¿ç”¨å½“å‰ç›®å½•çš„ Dockerfile åˆ›å»ºé•œåƒï¼Œæ ‡ç­¾ä¸º runoob/ubuntu:v1ã€‚\ndocker build -t runoob/ubuntu:v1 . ä½¿ç”¨ URL github.com/creack/docker-firefox çš„ Dockerfile åˆ›å»ºé•œåƒã€‚\ndocker build github.com/creack/docker-firefox ä¹Ÿå¯ä»¥é€šè¿‡ -f Dockerfile æ–‡ä»¶çš„ä½ç½®ï¼š\n$ docker build -f /path/to/a/Dockerfile . åœ¨ Docker å®ˆæŠ¤è¿›ç¨‹æ‰§è¡Œ Dockerfile ä¸­çš„æŒ‡ä»¤å‰ï¼Œé¦–å…ˆä¼šå¯¹ Dockerfile è¿›è¡Œè¯­æ³•æ£€æŸ¥ï¼Œæœ‰è¯­æ³•é”™è¯¯æ—¶ä¼šè¿”å›ï¼š\n$ docker build -t test/myapp . Sending build context to Docker daemon 2.048 kB Error response from daemon: Unknown instruction: RUNCMD ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/docker-commands/","summary":"1 å®¹å™¨æ“ä½œ 1.1 run åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨å¹¶è¿è¡Œä¸€ä¸ªå‘½ä»¤ è¯­æ³•: docker run [OPTIONS] IMAGE [COMMAND] [ARGâ€¦] OPTIONS è¯´æ˜ï¼š -a stdin: æŒ‡å®šæ ‡å‡†è¾“å…¥è¾“å‡ºå†…å®¹ç±»å‹ï¼Œå¯é€‰ STDIN/STDOUT/STDERR ä¸‰é¡¹ï¼› -d: åå°è¿è¡Œå®¹å™¨ï¼Œå¹¶è¿”å›å®¹å™¨IDï¼› -i: ä»¥äº¤äº’æ¨¡å¼è¿è¡Œå®¹å™¨ï¼Œé€šå¸¸ä¸ -t åŒæ—¶ä½¿ç”¨ï¼› -P: éšæœºç«¯å£æ˜ å°„ï¼Œå®¹å™¨å†…éƒ¨ç«¯å£éšæœºæ˜ å°„åˆ°ä¸»æœºçš„é«˜ç«¯å£ -p: æŒ‡å®šç«¯å£æ˜ å°„ï¼Œæ ¼å¼ä¸ºï¼šä¸»æœº(å®¿ä¸»)","title":"docker | å¸¸è§å‘½ä»¤"},{"content":"0 ä»€ä¹ˆæ˜¯æ•°æ®å· docker çš„ç†å¿µä¹‹ä¸€å°±æ˜¯å°†åº”ç”¨ä¸å…¶è¿è¡Œçš„ç¯å¢ƒæ‰“åŒ…ã€‚é€šå¸¸ docker å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸéƒ½æ˜¯ä¸åœ¨å®¹å™¨ä¸­è¿è¡Œçš„ç¨‹åºç›¸ä¸€è‡´çš„ï¼Œæˆ‘ä»¬å¯¹äºæ•°æ®çš„è¦æ±‚å°±æ˜¯æŒä¹…åŒ–ï¼›å¦ä¸€æ–¹é¢ docker å®¹å™¨ä¹‹é—´ä¹Ÿéœ€è¦ä¸€ä¸ªå…±äº«æ–‡ä»¶çš„æ¸ é“ã€‚\næ•°æ®å·æ˜¯ç»è¿‡ç‰¹æ®Šè®¾è®¡çš„ç›®å½•ï¼Œå¯ä»¥ç»•è¿‡è”åˆæ–‡ä»¶ç³»ç»Ÿï¼ˆUFSï¼‰ï¼Œä¸ºä¸€ä¸ªæˆ–è€…è¿‡ä¸ªå®¹å™¨æä¾›æœåŠ¡ æ•°æ®å·è®¾è®¡çš„ç›®çš„ï¼Œåœ¨äºæ•°æ®çš„æŒä¹…åŒ–ï¼Œä»–å®Œå…¨ç‹¬ç«‹äºå®¹å™¨çš„ç”Ÿå­˜å‘¨æœŸï¼Œå› æ­¤ï¼Œdocker ä¸ä¼šåœ¨å®¹å™¨åˆ é™¤æ—¶åˆ é™¤å…¶æŒ‚è½½çš„æ•°æ®å·ï¼Œä¹Ÿä¸ä¼šå­˜åœ¨ç±»ä¼¼çš„åƒåœ¾æ”¶é›†æœºåˆ¶ï¼Œå¯¹å®¹å™¨å¼•ç”¨çš„æ•°æ®å·è¿›è¡Œå¤„ç† ä»å›¾ç‰‡ä¸­ï¼š\næ•°æ®å·ç‹¬ç«‹äº docker å®¹å™¨å­˜åœ¨ï¼Œå®ƒå­˜åœ¨äº docker çš„å®¿ä¸»æœºä¸­ æ•°æ®å·å¯ä»¥æ˜¯ç›®å½•ï¼Œä¹Ÿå¯ä»¥æ˜¯æ–‡ä»¶ docker å®¹å™¨å¯ä»¥åˆ©ç”¨æ•°æ®å·ä¸å®¿ä¸»æœºå…±äº«æ–‡ä»¶ åŒä¸€ä¸ªæ•°æ®å·å¯ä»¥æ”¯æŒå¤šä¸ªå®¹å™¨çš„è®¿é—® 1 æ•°æ®å·çš„ç‰¹ç‚¹ æ•°æ®å·åœ¨å®¹å™¨å¯åŠ¨æ—¶åˆå§‹åŒ–ï¼Œå¦‚æœå®¹å™¨ä½¿ç”¨çš„é•œåƒåœ¨æŒ‚è½½ç‚¹åŒ…å«äº†æ•°æ®ï¼Œè¿™äº›æ•°æ®ä¼šæ‹·è´åˆ°æ–°åˆå§‹åŒ–çš„æ•°æ®å·ä¸­ æ•°æ®å·å¯ä»¥åœ¨å®¹å™¨ä¹‹é—´å…±äº«å’Œé‡ç”¨ å¯ä»¥å¯¹æ•°æ®å·é‡Œçš„å†…å®¹ç›´æ¥è¿›è¡Œä¿®æ”¹ æ•°æ®å·çš„å˜åŒ–ä¸ä¼šå½±å“é•œåƒçš„æ›´æ–° æ•°æ®å·ä¼šä¸€ç›´å­˜åœ¨ï¼Œå³ä½¿æŒ‚è½½æ•°æ®å·çš„å®¹å™¨å·²ç»è¢«åˆ é™¤ 2 æ•°æ®å·æ“ä½œ 2.1 æ·»åŠ æ•°æ®å· docker run -it -v HOST_DIRECTORY:CONTAINER_DIRETORY IMAGE [COMMADN] # HOST-DIRECTORYï¼šæŒ‡å®šä¸»æœºç›®å½•ï¼Œä¸å­˜åœ¨æ—¶å³åˆ›å»º # CONTAINERï¼šæŒ‡å®šå®¹å™¨ç›®å½•ï¼Œä¸å­˜åœ¨æ—¶å³åˆ›å»º ç¤ºä¾‹:\n[root@localhost ~]# docker run -it -v /docker/data_volume:/data_volume busybox /bin/sh / # touch /data_volume/test\t#åˆ›å»ºæµ‹è¯•æ–‡ä»¶ / # echo \u0026#34;lvbibir\u0026#34; \u0026gt; /data_volume/test / # cat /data_volume/test lvbibir [root@localhost ~]# cat /docker/data_volume/test\t#éªŒè¯æµ‹è¯•æ–‡ä»¶ lvbibir [root@localhost ~]# docker ps -l CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES be3fad8d789e busybox \u0026#34;/bin/sh\u0026#34; 6 minutes ago Up 6 minutes elastic_boyd [root@localhost ~]# docker inspect elastic_boyd 2.2 è®¿é—®æƒé™ docker run -it -v HOST_DIRECTORY:CONTAINER_DIRETORY:r/w IMAGE [COMMADN] æƒé™å¯ä»¥è®¾ç½®ä¸ºï¼š\nroï¼šonly-readï¼Œåªè¯» woï¼šonly-writeï¼Œåªå†™ rwï¼šwrite and readï¼Œè¯»å†™ ç¤ºä¾‹ï¼š\n[root@localhost ~]# docker run -itd -v /docker/data_volume:/data_volume:ro busybox /bin/sh 3ee3a2b7a97c0a10125d46ee1135bf59af1d97932572d49fdd5c0bb64bf775a5 [root@localhost ~]# docker ps -l CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 3ee3a2b7a97c busybox \u0026#34;/bin/sh\u0026#34; 4 seconds ago Up 3 seconds confident_hopper [root@localhost ~]# docker inspect confident_hopper 2.3 dockerfile dockerfile æŒ‡ä»¤ï¼š\nVOLUME [\u0026ldquo;HOST_DIRECTORY\u0026rdquo;]\ndockerfile ä¸­é…ç½®æ•°æ®å·æ— æ³•æŒ‡å®šæ˜ å°„åˆ°æœ¬åœ°çš„ç›®å½• æ„å»ºå¥½é•œåƒå¯åŠ¨å®¹å™¨æ—¶ï¼Œæ•°æ®å·ä¼šè¿›è¡Œåˆå§‹åŒ–ï¼Œdocker ä¼šåœ¨/var/lib/docker/volumes/ä¸‹ä¸ºæ•°æ®å·åˆ›å»ºæ–°çš„éšæœºåå­—çš„ç›®å½•ï¼ˆä¸åŒç‰ˆæœ¬è¯¥ç›®å½•ä½ç½®å¯èƒ½ä¸åŒï¼Œå…·ä½“ä»¥ inspect æŸ¥çœ‹åˆ°çš„ä¸ºå‡†ï¼‰ ä½¿ç”¨åŒä¸€ä¸ªé•œåƒæ„å»ºçš„å¤šä¸ªå®¹å™¨ï¼Œæ˜ å°„çš„æœ¬åœ°ç›®å½•ä¹Ÿä¸ä¸€æ · é€šè¿‡æ•°æ®å·å®¹å™¨æ¥è¿›è¡Œå®¹å™¨é—´çš„æ•°æ®å…±äº« ç¤ºä¾‹ï¼š\n[root@localhost ~]# cat Dockerfile #For test data_volume FROM busybox:latest VOLUME [\u0026#34;/data_volume1\u0026#34;,\u0026#34;/data_volume2\u0026#34;] CMD /bin/sh [root@localhost ~]# docker build -t test/data_volume . [root@localhost ~]# docker run -itd --name test_data_volume_1 test/data_volume /bin/sh ee8347a4bd3590e8cb65a28e1ebfc5d01e44f2ce70d33a2fa9bbc19782e34f21 [root@localhost ~]# docker exec test_data_volume_1 ls -l / | grep data_volume drwxr-xr-x 2 root root 6 Aug 14 15:20 data_volume1 drwxr-xr-x 2 root root 6 Aug 14 15:20 data_volume2 [root@localhost ~]# docker inspect test_data_volume_1 [root@localhost ~]# docker run -itd --name test_data_volume_2 test/data_volume /bin/sh b4f654706ea15e657cd61bb92d16fa6c6b8eb9129a68b1c9209ea21967175b24 [root@localhost ~]# docker exec test_data_volume_2 ls -l / | grep data_volume drwxr-xr-x 2 root root 6 Aug 14 15:24 data_volume1 drwxr-xr-x 2 root root 6 Aug 14 15:24 data_volume2 [root@localhost ~]# docker inspect test_data_volume_2 3 æ•°æ®å·å®¹å™¨ ä¸€ä¸ªå‘½åçš„å®¹å™¨æŒ‚è½½äº†æ•°æ®å·ï¼Œå…¶ä»–å®¹å™¨é€šè¿‡æŒ‚è½½è¿™ä¸ªå®¹å™¨å®ç°æ•°æ®å…±äº«ï¼ŒæŒ‚è½½æ•°æ®å·çš„å®¹å™¨ï¼Œå°±å«åšæ•°æ®å·å®¹å™¨ ä½¿ç”¨æ•°æ®å·å®¹å™¨è€Œä¸æ˜¯ç”¨æ•°æ®å·ç›´æ¥æŒ‚è½½ï¼Œå¯ä»¥ä¸æš´éœ²å®¿ä¸»æœºçš„å®é™…ç›®å½• åˆ é™¤æ•°æ®å·å®¹å™¨å¯¹äºå·²ç»æŒ‚è½½äº†è¯¥å®¹å™¨çš„å®¹å™¨æ²¡æœ‰å½±å“ï¼Œå› ä¸ºæ•°æ®å·å®¹å™¨åªæ˜¯ä¼ é€’äº†æŒ‚è½½ä¿¡æ¯ï¼Œä»»ä½•å¯¹äºç›®å½•çš„æ›´æ”¹éƒ½ä¸éœ€è¦é€šè¿‡æ•°æ®å·å®¹å™¨ ä»å›¾ç‰‡ä¸­ï¼š\næ•°æ®å·å®¹å™¨æŒ‚è½½äº†ä¸€ä¸ªæœ¬åœ°ç›®å½•ï¼Œå…¶ä»–å®¹å™¨é€šè¿‡è¿æ¥è¿™ä¸ªæ•°æ®å·å®¹å™¨æ¥å®ç°æ•°æ®çš„å…±äº« 3.1 æŒ‚è½½æ•°æ®å·å®¹å™¨ docker run -it --volumes-from [CONTAINER] IMAGE [COMMAND] CONTAINER å¿…é¡»æ˜¯å·²ç»æŒ‚è½½äº†å·ç»„çš„å®¹å™¨ï¼Œdockerfile å’Œ -v ä¸¤ä¸ªæ–¹å¼éƒ½å¯ä»¥ CONTAINER å¯ä»¥æœªè¿è¡Œï¼Œä½†å¿…é¡»å­˜åœ¨ ç¤ºä¾‹ï¼š\nåˆ›å»ºæ•°æ®å·å®¹å™¨\n[root@localhost ~]# cat Dockerfile #For test data_volume FROM busybox:latest VOLUME [\u0026#34;/data_volume1\u0026#34;,\u0026#34;/data_volume2\u0026#34;] CMD /bin/sh [root@localhost ~]# docker build -t test/data_volume . [root@localhost ~]# docker run -it --name data_volume_container test/data_volume /bin/sh / # touch /data_volume1/test1 / # touch /data_volume2/test2 / # exit åˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼ŒæŒ‚è½½æ•°æ®å·å®¹å™¨è¿›è¡ŒéªŒè¯\n[root@localhost ~]# docker run -itd --name test_dvc_1 --volumes-from data_volume_container busybox /bin/sh 6c4afa29df7ef226da7f1f0d394a356d53b92e3b20fa6c4632e7197ba393612c [root@localhost ~]# docker exec test_dvc_1 ls /data_volume1/ test1 [root@localhost ~]# docker exec test_dvc_1 ls /data_volume2/ test2 ä½¿ç”¨è¿™ä¸ªæ–°å®¹å™¨å¯¹æŒ‚è½½çš„ç›®å½•è¿›è¡Œæ›´æ”¹\n[root@localhost ~]# docker exec test_dvc touch /data_volume1/test2 [root@localhost ~]# docker exec test_dvc ls /data_volume1/ test1 test2 å†åˆ›å»ºä¸€ä¸ªæ–°å®¹å™¨éªŒè¯ä¸Šä¸€ä¸ªå®¹å™¨å¯¹æŒ‚è½½ç›®å½•çš„æ›´æ”¹æ˜¯å¦ç”Ÿæ•ˆ\n[root@localhost ~]# docker run -itd --name test_dvc_2 --volumes-from data_volume_container busybox /bin/sh 276c24ecd6ee62f35abf24855ffc5416b9abe987c1bb693ec57bf27d241383d2 [root@localhost ~]# docker exec test_dvc_2 ls /data_volume1 test1 test2 [root@localhost ~]# docker inspect --format=\u0026#34;{{.Mounts}}\u0026#34; test_dvc_1 [{volume 1aca4270e7c9ba34b3978638a6bf9e8259c294508207e89b3b9cbb529f4dd4be /var/lib/docker/volumes/1aca4270e7c9ba34b3978638a6bf9e8259c294508207e89b3b9cbb529f4dd4be/_data /data_volume1 local true } {volume d6ebda8735e2c76857d199bd1b96d11c9802d39557d2028bac60f0ec42efc764 /var/lib/docker/volumes/d6ebda8735e2c76857d199bd1b96d11c9802d39557d2028bac60f0ec42efc764/_data /data_volume2 local true }] [root@localhost ~]# docker inspect --format=\u0026#34;{{.Mounts}}\u0026#34; test_dvc_2 [{volume d6ebda8735e2c76857d199bd1b96d11c9802d39557d2028bac60f0ec42efc764 /var/lib/docker/volumes/d6ebda8735e2c76857d199bd1b96d11c9802d39557d2028bac60f0ec42efc764/_data /data_volume2 local true } {volume 1aca4270e7c9ba34b3978638a6bf9e8259c294508207e89b3b9cbb529f4dd4be /var/lib/docker/volumes/1aca4270e7c9ba34b3978638a6bf9e8259c294508207e89b3b9cbb529f4dd4be/_data /data_volume1 local true }] [root@localhost ~]# docker inspect test_dvc_1 [root@localhost ~]# docker inspect test_dvc_2 3.2 åˆ é™¤æ•°æ®å·å®¹å™¨ åˆ é™¤æ•°æ®å·å®¹å™¨åï¼Œå·²ç»æŒ‚è½½äº†è¿™ä¸ªæ•°æ®å·å®¹å™¨çš„å®¹å™¨ä¸å—ä»»ä½•å½±å“\næ•°æ®å·å®¹å™¨åªä¼ é€’é“¾æ¥ä¿¡æ¯ï¼ŒæŒ‚è½½çš„æ•°æ®å¹¶ä¸éœ€è¦é€šè¿‡æ•°æ®å·å®¹å™¨æ¥è¿›è¡Œä¼ è¾“\n4 æ•°æ®å·çš„å¤‡ä»½å’Œè¿˜åŸ 4.1 æ•°æ®å¤‡ä»½ å¤‡ä»½è¿™ä¸ªæ•°æ®å·å®¹å™¨æŒ‚è½½çš„æ‰€æœ‰ç›®å½•\ndocker run --volumes-from [container] -v $(pwd):/backup [image] tar cvf /backup/backup.tar [container data volume] -v $(pwd):/backupï¼šæŒ‚è½½ä¸€ä¸ªæ•°æ®å·ç”¨äºå­˜æ”¾å¤‡ä»½æ–‡ä»¶ tar å‘½ä»¤ï¼šå°†æ•°æ®å·å®¹å™¨æŒ‚è½½çš„ç›®å½•è¿›è¡Œå‹ç¼©ï¼Œå¤‡ä»½åˆ°/backup ç›®å½• 4.2 æ•°æ®è¿˜åŸ docker run --volumes-from [container] -v $(pwd):/backup [image] tar xvf /backup/backup.tar [container data volume] ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/docker-data-volume/","summary":"0 ä»€ä¹ˆæ˜¯æ•°æ®å· docker çš„ç†å¿µä¹‹ä¸€å°±æ˜¯å°†åº”ç”¨ä¸å…¶è¿è¡Œçš„ç¯å¢ƒæ‰“åŒ…ã€‚é€šå¸¸ docker å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸéƒ½æ˜¯ä¸åœ¨å®¹å™¨ä¸­è¿è¡Œçš„ç¨‹åºç›¸ä¸€è‡´çš„ï¼Œæˆ‘ä»¬å¯¹äºæ•°æ®çš„è¦æ±‚å°±æ˜¯æŒä¹…åŒ–ï¼›å¦ä¸€æ–¹é¢ docker å®¹å™¨ä¹‹é—´ä¹Ÿéœ€è¦ä¸€ä¸ªå…±äº«æ–‡ä»¶çš„æ¸ é“ã€‚ æ•°æ®å·æ˜¯ç»è¿‡ç‰¹æ®Šè®¾è®¡çš„ç›®å½•ï¼Œå¯ä»¥ç»•è¿‡è”åˆæ–‡ä»¶ç³»ç»Ÿï¼ˆUFSï¼‰ï¼Œä¸ºä¸€ä¸ªæˆ–è€…è¿‡ä¸ªå®¹å™¨æä¾›æœåŠ¡ æ•°æ®å·è®¾è®¡","title":"docker | æ•°æ®å· volume"},{"content":"1 docker ç®€ä»‹ Docker æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œè¯ç”Ÿäº 2013 å¹´åˆï¼Œæœ€åˆæ˜¯ dotCloud å…¬å¸å†…éƒ¨çš„ä¸€ä¸ªä¸šä½™é¡¹ç›®ã€‚å®ƒåŸºäº Google å…¬å¸æ¨å‡ºçš„ Go è¯­è¨€å®ç°ã€‚ é¡¹ç›®åæ¥åŠ å…¥äº† Linux åŸºé‡‘ä¼šï¼Œéµä»äº† Apache 2.0 åè®®ï¼Œé¡¹ç›®ä»£ç åœ¨ GitHub ä¸Šè¿›è¡Œç»´æŠ¤ã€‚\nDocker è‡ªå¼€æºåå—åˆ°å¹¿æ³›çš„å…³æ³¨å’Œè®¨è®ºï¼Œä»¥è‡³äº dotCloud å…¬å¸åæ¥éƒ½æ”¹åä¸º Docker Incã€‚Redhat å·²ç»åœ¨å…¶ RHEL6.5 ä¸­é›†ä¸­æ”¯æŒ Dockerï¼›Google ä¹Ÿåœ¨å…¶ PaaS äº§å“ä¸­å¹¿æ³›åº”ç”¨ã€‚\nDocker é¡¹ç›®çš„ç›®æ ‡æ˜¯å®ç°è½»é‡çº§çš„æ“ä½œç³»ç»Ÿè™šæ‹ŸåŒ–è§£å†³æ–¹æ¡ˆã€‚ Docker çš„åŸºç¡€æ˜¯ Linux å®¹ï¼ˆLXCï¼‰ç­‰æŠ€æœ¯ã€‚\nåœ¨ LXC çš„åŸºç¡€ä¸Š Docker è¿›è¡Œäº†è¿›ä¸€æ­¥çš„å°è£…ï¼Œè®©ç”¨æˆ·ä¸éœ€è¦å»å…³å¿ƒå®¹å™¨çš„ç®¡ç†ï¼Œä½¿å¾—æ“ä½œæ›´ä¸ºç®€ä¾¿ã€‚ç”¨æˆ·æ“ä½œ Docker çš„å®¹å™¨å°±åƒæ“ä½œä¸€ä¸ªå¿«é€Ÿè½»é‡çº§çš„è™šæ‹Ÿæœºä¸€æ ·ç®€å•ã€‚\nä¸‹é¢çš„å›¾ç‰‡æ¯”è¾ƒäº† Docker å’Œä¼ ç»Ÿè™šæ‹ŸåŒ–æ–¹å¼çš„ä¸åŒä¹‹å¤„ï¼Œå¯è§å®¹å™¨æ˜¯åœ¨æ“ä½œç³»ç»Ÿå±‚é¢ä¸Šå®ç°è™šæ‹ŸåŒ–ï¼Œç›´æ¥å¤ç”¨æœ¬åœ°ä¸»æœºçš„æ“ä½œç³»ç»Ÿï¼Œè€Œä¼ ç»Ÿæ–¹å¼åˆ™æ˜¯åœ¨ç¡¬ä»¶å±‚é¢å®ç°ã€‚\n1.1 ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ docker ä½œä¸ºä¸€ç§æ–°å…´çš„è™šæ‹ŸåŒ–æ–¹å¼ï¼ŒDocker è·Ÿä¼ ç»Ÿçš„è™šæ‹ŸåŒ–æ–¹å¼ç›¸æ¯”å…·æœ‰ä¼—å¤šçš„ä¼˜åŠ¿ã€‚\né¦–å…ˆï¼ŒDocker å®¹å™¨çš„å¯åŠ¨å¯ä»¥åœ¨ç§’çº§å®ç°ï¼Œè¿™ç›¸æ¯”ä¼ ç»Ÿçš„è™šæ‹Ÿæœºæ–¹å¼è¦å¿«å¾—å¤šã€‚ å…¶æ¬¡ï¼ŒDocker å¯¹ç³»ç»Ÿèµ„æºçš„åˆ©ç”¨ç‡å¾ˆé«˜ï¼Œä¸€å°ä¸»æœºä¸Šå¯ä»¥åŒæ—¶è¿è¡Œæ•°åƒä¸ª Docker å®¹å™¨ã€‚\nå®¹å™¨é™¤äº†è¿è¡Œå…¶ä¸­åº”ç”¨å¤–ï¼ŒåŸºæœ¬ä¸æ¶ˆè€—é¢å¤–çš„ç³»ç»Ÿèµ„æºï¼Œä½¿å¾—åº”ç”¨çš„æ€§èƒ½å¾ˆé«˜ï¼ŒåŒæ—¶ç³»ç»Ÿçš„å¼€é”€å°½é‡å°ã€‚ä¼ ç»Ÿè™šæ‹Ÿæœºæ–¹å¼è¿è¡Œ 10 ä¸ªä¸åŒçš„åº”ç”¨å°±è¦èµ· 10 ä¸ªè™šæ‹Ÿæœºï¼Œè€Œ Docker åªéœ€è¦å¯åŠ¨ 10 ä¸ªéš”ç¦»çš„åº”ç”¨å³å¯ã€‚\nå…·ä½“è¯´æ¥ï¼ŒDocker åœ¨å¦‚ä¸‹å‡ ä¸ªæ–¹é¢å…·æœ‰è¾ƒå¤§çš„ä¼˜åŠ¿ã€‚\næ›´å¿«é€Ÿçš„äº¤ä»˜å’Œéƒ¨ç½² å¯¹å¼€å‘å’Œè¿ç»´ï¼ˆdevopï¼‰äººå‘˜æ¥è¯´ï¼Œæœ€å¸Œæœ›çš„å°±æ˜¯ä¸€æ¬¡åˆ›å»ºæˆ–é…ç½®ï¼Œå¯ä»¥åœ¨ä»»æ„åœ°æ–¹æ­£å¸¸è¿è¡Œã€‚ å¼€å‘è€…å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ ‡å‡†çš„é•œåƒæ¥æ„å»ºä¸€å¥—å¼€å‘å®¹å™¨ï¼Œå¼€å‘å®Œæˆä¹‹åï¼Œè¿ç»´äººå‘˜å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªå®¹å™¨æ¥éƒ¨ç½²ä»£ç ã€‚ Docker å¯ä»¥å¿«é€Ÿåˆ›å»ºå®¹å™¨ï¼Œå¿«é€Ÿè¿­ä»£åº”ç”¨ç¨‹åºï¼Œå¹¶è®©æ•´ä¸ªè¿‡ç¨‹å…¨ç¨‹å¯è§ï¼Œä½¿å›¢é˜Ÿä¸­çš„å…¶ä»–æˆå‘˜æ›´å®¹æ˜“ç†è§£åº”ç”¨ç¨‹åºæ˜¯å¦‚ä½•åˆ›å»ºå’Œå·¥ä½œçš„ã€‚ Docker å®¹å™¨å¾ˆè½»å¾ˆå¿«ï¼å®¹å™¨çš„å¯åŠ¨æ—¶é—´æ˜¯ç§’çº§çš„ï¼Œå¤§é‡åœ°èŠ‚çº¦å¼€å‘ã€æµ‹è¯•ã€éƒ¨ç½²çš„æ—¶é—´ã€‚ æ›´é«˜æ•ˆçš„è™šæ‹ŸåŒ– Docker å®¹å™¨çš„è¿è¡Œä¸éœ€è¦é¢å¤–çš„ hypervisor æ”¯æŒï¼Œå®ƒæ˜¯å†…æ ¸çº§çš„è™šæ‹ŸåŒ–ï¼Œå› æ­¤å¯ä»¥å®ç°æ›´é«˜çš„æ€§èƒ½å’Œæ•ˆç‡ã€‚ æ›´è½»æ¾çš„è¿ç§»å’Œæ‰©å±• Docker å®¹å™¨å‡ ä¹å¯ä»¥åœ¨ä»»æ„çš„å¹³å°ä¸Šè¿è¡Œï¼ŒåŒ…æ‹¬ç‰©ç†æœºã€è™šæ‹Ÿæœºã€å…¬æœ‰äº‘ã€ç§æœ‰äº‘ã€ä¸ªäººç”µè„‘ã€æœåŠ¡å™¨ç­‰ã€‚ è¿™ç§å…¼å®¹æ€§å¯ä»¥è®©ç”¨æˆ·æŠŠä¸€ä¸ªåº”ç”¨ç¨‹åºä»ä¸€ä¸ªå¹³å°ç›´æ¥è¿ç§»åˆ°å¦å¤–ä¸€ä¸ªã€‚ æ›´ç®€å•çš„ç®¡ç† ä½¿ç”¨ Dockerï¼Œåªéœ€è¦å°å°çš„ä¿®æ”¹ï¼Œå°±å¯ä»¥æ›¿ä»£ä»¥å¾€å¤§é‡çš„æ›´æ–°å·¥ä½œã€‚æ‰€æœ‰çš„ä¿®æ”¹éƒ½ä»¥å¢é‡çš„æ–¹å¼è¢«åˆ†å‘å’Œæ›´æ–°ï¼Œä»è€Œå®ç°è‡ªåŠ¨åŒ–å¹¶ä¸”é«˜æ•ˆçš„ç®¡ç†ã€‚ 1.2 å¯¹æ¯”ä¼ ç»Ÿè™šæ‹Ÿæœº 1.3 åº”ç”¨åœºæ™¯ ç®€åŒ–é…ç½®: ä¸€æ¬¡æ„å»ºï¼Œå¤šå¤„è¿è¡Œ æå‡å¼€å‘æ•ˆç‡ åº”ç”¨éš”ç¦» å¤šç§Ÿæˆ·ç¯å¢ƒ: ä¸ºæ¯ä¸ªå®¹å™¨å¯ç”¨å¤šä¸ªä¸åŒçš„å®¹å™¨ å¿«é€Ÿçš„éƒ¨ç½² ä»£ç æµæ°´çº¿ç®¡ç† ä»£ç è°ƒè¯• 2 docker é•œåƒ docker é•œåƒæ˜¯ä¸€å¥—ä½¿ç”¨è”åˆåŠ è½½æŠ€æœ¯å®ç°çš„å±‚å çš„åªè¯»æ–‡ä»¶ç³»ç»Ÿï¼ŒåŒ…å«åŸºç¡€é•œåƒå’Œé™„åŠ é•œåƒå±‚\n2.1 ä¸ºä»€ä¹ˆ docker é•œåƒå¾ˆå° Linux æ“ä½œç³»ç»Ÿåˆ†åˆ«ç”±ä¸¤éƒ¨åˆ†ç»„æˆ\nå†…æ ¸ç©ºé—´ (kernel) ç”¨æˆ·ç©ºé—´ (rootfs) å†…æ ¸ç©ºé—´æ˜¯ kernel,Linux åˆšå¯åŠ¨æ—¶ä¼šåŠ è½½ bootfs æ–‡ä»¶ç³»ç»Ÿï¼Œä¹‹å bootf ä¼šè¢«å¸è½½æ‰ï¼Œç”¨æˆ·ç©ºé—´çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯ rootfs,åŒ…å«å¸¸è§çš„ç›®å½•ï¼Œå¦‚/devã€/procã€/binã€/etc ç­‰ç­‰\nä¸åŒçš„ Linux å‘è¡Œç‰ˆæœ¬ (çº¢å¸½ï¼Œcentosï¼Œubuntu ç­‰) ä¸»è¦çš„åŒºåˆ«æ˜¯ rootfs, å¤šä¸ª Linux å‘è¡Œç‰ˆæœ¬çš„ kernel å·®åˆ«ä¸å¤§ã€‚\næ¯ä¸ªä¸åŒ linux å‘è¡Œç‰ˆçš„ docker é•œåƒåªåŒ…å«å¯¹åº”çš„ rootfsï¼Œæ‰€ä»¥æ¯”å®Œæ•´çš„ç³»ç»Ÿé•œåƒè¦å°å¾—å¤š\n2.2 docker é•œåƒçš„å­˜å‚¨ä½ç½® /var/lib/docker(å¯ä»¥ä½¿ç”¨ docker info æ¥è¿›è¡ŒæŸ¥çœ‹)\n3 å†™æ—¶å¤åˆ¶ï¼ˆcopy on writeï¼‰ å½“ä¸€ä¸ªæ–°å®¹å™¨å¯åŠ¨æ—¶ï¼Œè¯»å†™å±‚æ˜¯æ²¡æœ‰ä»»ä½•æ•°æ®çš„ï¼Œå½“ç”¨æˆ·éœ€è¦è¯»å–ä¸€äº›æ–‡ä»¶æ—¶ï¼Œå¯ä»¥ç›´æ¥ä»åªè¯»å±‚è¿›è¡Œè¯»å–ï¼Œåªæœ‰å½“ç”¨æˆ·è¦ä¿®æ”¹åªè¯»å±‚ä¸€äº›æ–‡ä»¶æ—¶ï¼Œdocker æ‰ä¼šå°†è¯¥æ–‡ä»¶ä»åªè¯»å±‚å¤åˆ¶å‡ºæ¥æ”¾åœ¨è¯»å†™å±‚ä¾›ä½¿ç”¨è€…ä¿®æ”¹ï¼Œåªè¯»å±‚ä¸­çš„æ–‡ä»¶æ˜¯æ²¡æœ‰æ”¹å˜çš„\n4 repository ä¸ registry Repositoryï¼šæœ¬èº«æ˜¯ä¸€ä¸ªä»“åº“ï¼Œè¿™ä¸ªä»“åº“é‡Œé¢å¯ä»¥æ”¾å…·ä½“çš„é•œåƒï¼Œæ˜¯æŒ‡å…·ä½“çš„æŸä¸ªé•œåƒçš„ä»“åº“ï¼Œæ¯”å¦‚ Tomcat ä¸‹é¢æœ‰å¾ˆå¤šä¸ªç‰ˆæœ¬çš„é•œåƒï¼Œå®ƒä»¬å…±åŒç»„æˆäº† Tomcat çš„ Repositoryã€‚\nRegistryï¼šé•œåƒçš„ä»“åº“ï¼Œæ¯”å¦‚å®˜æ–¹çš„æ˜¯ Docker Hubï¼Œå®ƒæ˜¯å¼€æºçš„ï¼Œä¹Ÿå¯ä»¥è‡ªå·±éƒ¨ç½²ä¸€ä¸ªï¼ŒRegistry ä¸Šæœ‰å¾ˆå¤šçš„ Repositoryï¼ŒRedisã€Tomcatã€MySQL ç­‰ç­‰ Repository ç»„æˆäº† Registryã€‚\n5 docker çš„ C/S æ¨¡å¼ ç”¨æˆ·åœ¨ Docker Client ä¸­è¿è¡Œ Docker çš„å„ç§å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤ä¼šä¼ é€ç»™åœ¨ docker å®¿ä¸»æœºä¸Šè¿è¡Œçš„ docker å®ˆæŠ¤è¿›ç¨‹ï¼Œdocker çš„å®ˆæŠ¤è¿›ç¨‹æ¥å®ç° docker çš„å„ç§åŠŸèƒ½\nå¯åŠ¨ docker æœåŠ¡åï¼Œdocker çš„å®ˆæŠ¤è¿›ç¨‹ä¼šä¸€ç›´åœ¨åå°è¿è¡Œ\n5.1 Remote API docker å‘½ä»¤è¡Œæ¥å£æ˜¯ docker æœ€å¸¸ç”¨çš„ä¸å®ˆæŠ¤è¿›ç¨‹è¿›è¡Œé€šä¿¡çš„æ¥å£ï¼Œdocker çš„äºŒè¿›åˆ¶å‘½ä»¤æ–‡ä»¶ï¼ˆä¾‹å¦‚ docker runï¼‰æ­¤æ—¶å°±æ˜¯ docker çš„ Clientï¼Œdocker ä¹Ÿæä¾›äº†å…¶ä»–çš„æ¥å£ï¼šRemote API\nç”¨æˆ·å¯ä»¥é€šè¿‡ç¼–å†™ç¨‹åºè°ƒç”¨ Remote APIï¼Œä¸ docker å®ˆæŠ¤è¿›ç¨‹è¿›è¡Œé€šä¿¡ï¼Œå°†è‡ªå·±çš„ç¨‹åºä¸ docker è¿›è¡Œé›†æˆ\nRESTful é£æ ¼çš„ APIï¼šä¸å¤§å¤šæ•°ç¨‹åºçš„ API é£æ ¼ç±»ä¼¼ STDINã€STDOUTã€STDERRï¼šRemote API åœ¨æŸäº›å¤æ‚çš„æƒ…å†µä¸‹ï¼Œä¹Ÿæ”¯æŒè¿™ä¸‰ç§æ–¹å¼æ¥ä¸ docker å®ˆæŠ¤è¿›ç¨‹è¿›è¡Œé€šä¿¡ 5.2 Client ä¸å®ˆæŠ¤è¿›ç¨‹çš„è¿æ¥æ–¹å¼ unix:///var/run/docker.sock æ˜¯é»˜è®¤çš„è¿æ¥æ–¹å¼ï¼Œå¯ä»¥é€šè¿‡é…ç½®ä¿®æ”¹ä¸ºå…¶ä»–çš„ socket è¿æ¥æ–¹å¼\nunix:///var/run/docker.sock tcp://host:port fd://socketfd ç”¨æˆ·å¯ä»¥é€šè¿‡ dokcer çš„äºŒè¿›åˆ¶å‘½ä»¤æ¥å£æˆ–è€…è‡ªå®šä¹‰ç¨‹åºï¼Œè‡ªå®šä¹‰ç¨‹åºé€šè¿‡ Remote API æ¥è°ƒç”¨ docker å®ˆæŠ¤è¿›ç¨‹ï¼ŒClient ä¸ Server ä¹‹é—´é€šè¿‡ Socket æ¥è¿›è¡Œè¿æ¥ï¼Œè¿™ç§è¿æ¥æ„å‘³ç€ Client ä¸ Server æ—¢å¯ä»¥åœ¨åŒä¸€å°æœºå™¨ä¸Šè¿è¡Œï¼Œä¹Ÿå¯ä»¥åœ¨ä¸åŒæœºå™¨ä¸Šè¿è¡Œï¼ŒClient å¯ä»¥é€šè¿‡è¿œç¨‹çš„æ–¹å¼æ¥è¿æ¥ Server ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/docker-jian-jie/","summary":"1 docker ç®€ä»‹ Docker æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œè¯ç”Ÿäº 2013 å¹´åˆï¼Œæœ€åˆæ˜¯ dotCloud å…¬å¸å†…éƒ¨çš„ä¸€ä¸ªä¸šä½™é¡¹ç›®ã€‚å®ƒåŸºäº Google å…¬å¸æ¨å‡ºçš„ Go è¯­è¨€å®ç°ã€‚ é¡¹ç›®åæ¥åŠ å…¥äº† Linux åŸºé‡‘ä¼šï¼Œéµä»äº† Apache 2.0 åè®®ï¼Œé¡¹ç›®ä»£ç åœ¨ GitHub ä¸Šè¿›è¡Œç»´æŠ¤ã€‚ Docker è‡ªå¼€æºåå—åˆ°å¹¿æ³›çš„å…³æ³¨å’Œè®¨è®ºï¼Œä»¥è‡³äº dotCloud å…¬å¸åæ¥éƒ½æ”¹åä¸º Docker Incã€‚Redhat å·²ç»åœ¨å…¶ RHEL6.5 ä¸­é›†ä¸­æ”¯æŒ Dockerï¼›G","title":"docker | ç®€ä»‹ä»¥åŠåŸºç¡€æ¦‚å¿µ"},{"content":"1 ç½‘ç»œæ¦‚è¿° ç‹¬ç«‹å®¹å™¨ç½‘ç»œï¼šnone host none ç½‘ç»œæœ€ä¸ºå®‰å…¨ï¼Œåªæœ‰ localback æ¥å£ host ç½‘ç»œåªå’Œç‰©ç†æœºç›¸è¿ï¼Œä¿è¯è·Ÿç‰©ç†æœºç›¸è¿çš„ç½‘ç»œæ•ˆç‡\tè·Ÿç‰©ç†æœºå®Œå…¨ä¸€æ ·ï¼ˆç½‘ç»œåè®®æ ˆä¸ä¸»æœºåï¼‰ å®¹å™¨é—´çš„ç½‘ç»œï¼šbridge docker bridgeè¯¦è§£ docker å¯åŠ¨æ—¶é»˜è®¤ä¼šæœ‰ä¸€ä¸ª docker0 ç½‘æ¡¥ï¼Œè¯¥ç½‘æ¡¥å°±æ˜¯æ¡¥æ¥æ¨¡å¼çš„ä½“ç° ç”¨æˆ·ä¹Ÿå¯ä»¥è‡ªå»º bridge ç½‘ç»œï¼Œå»ºç«‹å dokcer ä¹Ÿä¼šåˆ›å»ºä¸€ä¸ªç½‘æ¡¥ è·¨ä¸»æœºçš„å®¹å™¨é—´çš„ç½‘ç»œï¼šmacvlan overlay ç¬¬ä¸‰æ–¹ç½‘ç»œï¼šflannel weave calic 2 docker0 å®‰è£…äº† docker çš„ç³»ç»Ÿï¼Œä½¿ç”¨ ifconfig å¯ä»¥æŸ¥çœ‹åˆ° docker0 è®¾å¤‡ï¼Œdocker å®ˆæŠ¤è¿›ç¨‹å°±æ˜¯é€šè¿‡ docker0 ä¸ºå®¹å™¨æä¾›ç½‘ç»œè¿æ¥çš„å„ç§æœåŠ¡\ndocker0 å®é™…ä¸Šæ˜¯ linux è™šæ‹Ÿç½‘æ¡¥ï¼ˆäº¤æ¢æœº)\nç½‘æ¡¥æ˜¯æ•°æ®é“¾è·¯å±‚çš„è®¾å¤‡ï¼Œå®ƒé€šè¿‡ mac åœ°å€æ¥å¯¹ç½‘ç»œè¿›è¡Œåˆ’åˆ†ï¼Œå¹¶ä¸”åœ¨ä¸åŒçš„ç½‘ç»œä¹‹é—´ä¼ é€’æ•°æ®\nlinux è™šæ‹Ÿç½‘æ¡¥çš„ç‰¹ç‚¹ï¼š\nå¯ä»¥è®¾ç½® ip åœ°å€ï¼ˆäºŒå±‚çš„ç½‘æ¡¥å¯ä»¥è®¾ç½®ä¸‰å±‚çš„ ip åœ°å€ï¼‰ ç›¸å½“äºæ‹¥æœ‰ä¸€ä¸ªéšè—çš„è™šæ‹Ÿç½‘å¡ docker0 çš„åœ°å€åˆ’åˆ†ï¼š\nIPï¼š172.17.0.1ï¼ˆå„ç‰ˆæœ¬å¯èƒ½ä¸åŒï¼‰ å­ç½‘æ©ç ï¼š255.255.0.0 MACï¼š02:42:00:00:00:00 åˆ° 02:42:ff:ff:ff:ffï¼ˆå„ç‰ˆæœ¬å¯èƒ½ä¸åŒï¼‰ æ€»å…±æä¾›äº† 65534 ä¸ªåœ°å€ æ¯å½“ä¸€ä¸ªå®¹å™¨å¯åŠ¨æ—¶ï¼Œdocker å®ˆæŠ¤è¿›ç¨‹ä¼šåˆ›å»ºç½‘ç»œè¿æ¥çš„ä¸¤ç«¯ï¼Œä¸€ç«¯åœ¨å®¹å™¨å†…åˆ›å»º eth0 ç½‘å¡ï¼Œå¦ä¸€ç«¯åœ¨ dokcer0 ç½‘æ¡¥ä¸­å¼€å¯ä¸€ä¸ªç«¯å£ veth*\næŸ¥çœ‹ç½‘æ¡¥è®¾å¤‡éœ€è¦é¢„å…ˆå®‰è£… bridge-utils è½¯ä»¶åŒ…\n[root@localhost ~]# yum install -y bridge-utils [root@localhost ~]# brctl show bridge name bridge id STP enabled interfaces docker0 8000.024247d799bf no virbr0 8000.525400b76fd4 yes virbr0-nic å¼€å¯ä¸€ä¸ªå®¹å™¨ï¼ŒæŸ¥çœ‹ç½‘ç»œè®¾ç½®ï¼š\n[root@localhost ~]# docker run -it --name nwt1 centos /bin/bash [root@0ef32e882bcf /]# ifconfig bash: ifconfig: command not found [root@0ef32e882bcf /]# yum install -y net-tools [root@0ef32e882bcf /]# ifconfig å†æŸ¥çœ‹ä¸€ä¸‹ç½‘æ¡¥\n[root@localhost ~]# brctl show [root@localhost ~]# ifconfig 2.1 è‡ªå®šä¹‰ docker0 å½“é»˜è®¤ docker0 çš„ ip æˆ–è€…ç½‘æ®µä¸ä¸»æœºç¯å¢ƒå‘ç”Ÿå†²çªæ—¶ï¼Œå¯ä»¥ä¿®æ”¹ docker0 çš„åœ°å€å’Œç½‘æ®µæ¥è¿›è¡Œè‡ªå®šä¹‰\n# ifconfig docker0 IP netmask NETMASK [root@localhost ~]# ifconfig docker0 192.168.200.1 netmask 255.255.255.0 [root@localhost ~]# ifconfig [root@localhost ~]# systemctl restart docker [root@localhost ~]# docker run -it centos /bin/bash [root@a5c6ebf79340 /]# yum install -y net-tools [root@a5c6ebf79340 /]# ifconfig 2.2 è‡ªå®šä¹‰è™šæ‹Ÿç½‘æ¡¥ æ·»åŠ è™šæ‹Ÿç½‘æ¡¥\n[root@localhost ~]# brctl addbr br0 [root@localhost ~]# ifconfig br0 192.168.100.1 netmask 255.255.255.0 [root@localhost ~]# ifconfig ä¿®æ”¹ docker å®ˆæŠ¤è¿›ç¨‹çš„é…ç½®\n[root@localhost ~]# vim /lib/systemd/system/docker.service ExecStart=/usr/bin/dockerd -b=br0 [root@localhost ~]# systemctl daemon-reload [root@localhost ~]# systemctl restart docker [root@localhost ~]# ps -ef | grep docker root 4156 1 1 14:06 ? 00:00:00 /usr/bin/dockerd -b=br0 root 4161 4156 0 14:06 ? 00:00:00 docker-containerd --config /var/run/docker/containerd/containerd.toml root 4263 1558 0 14:06 pts/0 00:00:00 grep --color=auto docker å¯åŠ¨ä¸€ä¸ªæµ‹è¯•å®¹å™¨\n[root@localhost ~]# docker run -it --name nwt3 centos /bin/bash [root@d70269c9557e /]# yum install -y net-tools [root@d70269c9557e /]# ifconfig 3 åŒä¸€å®¿ä¸»æœºé—´å®¹å™¨çš„è¿æ¥ å…è®¸å•å°ä¸»æœºå†…æ‰€æœ‰å®¹å™¨äº’è”ï¼ˆé»˜è®¤æƒ…å†µï¼‰ æ‹’ç»å®¹å™¨é—´è¿æ¥ å…è®¸ç‰¹å®šå®¹å™¨é—´çš„è¿æ¥ 3.1 å…è®¸å®¹å™¨äº’è” \u0026ndash;icc=true é»˜è®¤ä¸º trueï¼Œå³å…è®¸åŒä¸€å®¿ä¸»æœºä¸‹æ‰€æœ‰å®¹å™¨ä¹‹é—´ç½‘ç»œè¿é€š\n[root@localhost ~]# docker run -itd --name test1 busybox /bin/sh 7ec641b21b66b6472f4e92cfaa7f9c0674c4322a5265a05e272ae180b0d4687c [root@localhost ~]# docker exec test1 ifconfig eth0 eth0 Link encap:Ethernet HWaddr 02:42:AC:11:00:02 inet addr:172.17.0.2 Bcast:172.17.255.255 Mask:255.255.0.0 UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1 RX packets:8 errors:0 dropped:0 overruns:0 frame:0 TX packets:0 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:0 RX bytes:648 (648.0 B) TX bytes:0 (0.0 B) [root@localhost ~]# docker run -itd --name test2 busybox /bin/sh fee0ff3e7f82cd1fa06eea11d850251931dff4dff2f0c7ee3e5a9904532beeb6 [root@localhost ~]# docker exec test2 ping 172.17.0.2 -c 4 PING 172.17.0.2 (172.17.0.2): 56 data bytes 64 bytes from 172.17.0.2: seq=0 ttl=64 time=0.133 ms 64 bytes from 172.17.0.2: seq=1 ttl=64 time=0.136 ms 64 bytes from 172.17.0.2: seq=2 ttl=64 time=0.264 ms 64 bytes from 172.17.0.2: seq=3 ttl=64 time=0.163 ms --- 172.17.0.2 ping statistics --- 4 packets transmitted, 4 packets received, 0% packet loss round-trip min/avg/max = 0.133/0.174/0.264 ms å®¹å™¨çš„ ip æ˜¯ä¸å¯é çš„è¿æ¥\nå¯ä»¥ä½¿ç”¨ \u0026ndash;link é€‰é¡¹æ¥è¿æ¥ä¸¤ä¸ªå®¹å™¨\ndocker run --link=[CONTAINER_NAME]:[ALIAS] [IMAGE] [COMMAND] \u0026ndash;link åé¢çš„ test3 æŒ‡è¿æ¥åˆ° test3 å®¹å™¨ï¼Œnt æ˜¯ä¸º test3 åˆ›å»ºäº†ä¸€ä¸ªåˆ«å\næ–°å»ºä¸¤ä¸ªå®¹å™¨è¿›è¡Œæµ‹è¯•\n[root@localhost ~]# docker run -itd --name test3 busybox /bin/sh 1fd4e373dba17fdf1fa93121e08ea2f1f32d8f4116339c072a72a73574b0926f [root@localhost ~]# docker run -itd --name test4 --link=test3:nt busybox /bin/sh c04b9b759bd4cc9af54000a742df58c8369a7f1bfc8862a8325481f1d61db135 [root@localhost ~]# [root@localhost ~]# docker exec test4 ping nt -c 4 PING nt (172.17.0.4): 56 data bytes 64 bytes from 172.17.0.4: seq=0 ttl=64 time=0.256 ms 64 bytes from 172.17.0.4: seq=1 ttl=64 time=0.196 ms 64 bytes from 172.17.0.4: seq=2 ttl=64 time=0.164 ms 64 bytes from 172.17.0.4: seq=3 ttl=64 time=0.148 ms --- nt ping statistics --- 4 packets transmitted, 4 packets received, 0% packet loss round-trip min/avg/max = 0.148/0.191/0.256 ms \u0026ndash;link é€‰é¡¹å¯¹å®¹å™¨åšäº†å¦‚ä¸‹æ”¹å˜ï¼š\nä¿®æ”¹äº† env ç¯å¢ƒå˜é‡ ä¿®æ”¹äº† hosts æ–‡ä»¶ [root@localhost ~]# docker exec test4 env [root@localhost ~]# docker exec test4 cat /etc/hosts åˆ é™¤ä¹‹å‰ä½¿ç”¨çš„ test1 ä¸ test2 å®¹å™¨ï¼Œè¿™ä¸¤ä¸ªå®¹å™¨å ç”¨çš„ ip é‡Šæ”¾ï¼Œé‡å¯ test3 åï¼Œä½¿ç”¨æœ€æ–°çš„ ip åœ°å€\n[root@localhost ~]# docker rm -f test1 test1 [root@localhost ~]# docker rm -f test2 test2 [root@localhost ~]# docker restart test3 test3 [root@localhost ~]# docker exec test3 ifconfig eth0 eth0 Link encap:Ethernet HWaddr 02:42:AC:11:00:02 inet addr:172.17.0.2 Bcast:172.17.255.255 Mask:255.255.0.0 UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1 RX packets:8 errors:0 dropped:0 overruns:0 frame:0 TX packets:0 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:0 RX bytes:648 (648.0 B) TX bytes:0 (0.0 B) å¯ä»¥çœ‹åˆ°éšç€ test3 çš„ ip åœ°å€å‘ç”Ÿæ”¹å˜ï¼Œtest4 å®¹å™¨ä¸­çš„ hosts æ–‡ä»¶ä¹Ÿéšä¹‹æ”¹å˜\n[root@localhost ~]# docker exec test4 cat /etc/hosts 3.2 æ‹’ç»å®¹å™¨äº’è” ä¿®æ”¹å®ˆæŠ¤è¿›ç¨‹çš„å¯åŠ¨é€‰é¡¹ï¼š\u0026ndash;icc=false\n[root@localhost ~]# vim /lib/systemd/system/docker.service ExecStart=/usr/bin/dockerd --icc=false [root@localhost ~]# systemctl daemon-reload [root@localhost ~]# systemctl restart docker æ–°å»ºä¸¤ä¸ªå®¹å™¨è¿›è¡Œæµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ°æ— æ³• ping é€š\n[root@localhost ~]# docker run -itd --name test10 busybox /bin/sh 700f026459206531b0fda811a43bc12af2f0815dc695f317a1f52939bfada2a1 [root@localhost ~]# docker run -itd --name test11 busybox /bin/sh 792cc31481739e1b2537597bc54c76737333bf95412dac2209e050f35d276dd4 [root@localhost ~]# docker exec test10 ifconfig eth0 eth0 Link encap:Ethernet HWaddr 02:42:AC:11:00:06 inet addr:172.17.0.6 Bcast:172.17.255.255 Mask:255.255.0.0 UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1 RX packets:8 errors:0 dropped:0 overruns:0 frame:0 TX packets:0 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:0 RX bytes:648 (648.0 B) TX bytes:0 (0.0 B) [root@localhost ~]# docker exec test11 ping 172.16.0.6 ^C 3.3 å…è®¸ç‰¹å®šå®¹å™¨é—´çš„è¿æ¥ ä¿®æ”¹å®ˆæŠ¤è¿›ç¨‹é€‰é¡¹ï¼š\n\u0026ndash;icc=false \u0026ndash;iptables=true\t# å…è®¸ docker å®¹å™¨é…ç½®æ·»åŠ åˆ° linux çš„ iptables è®¾ç½®ä¸­ \u0026ndash;link åªæœ‰è®¾ç½®äº† \u0026ndash;link çš„ä¸¤ä¸ªå®¹å™¨é—´æ‰å¯ä»¥äº’é€š\n[root@localhost ~]# vim /lib/systemd/system/docker.service ExecStart=/usr/bin/dockerd --icc=false --iptables=true [root@localhost ~]# systemctl daemon-reload [root@localhost ~]# systemctl restart docker æ–°å»ºä¸¤ä¸ªå®¹å™¨è¿›è¡ŒéªŒè¯\n[root@localhost ~]# docker run -itd --name test21 busybox /bin/sh 77f56db227acaa590f729c12a4852d3131f1729851ea8c613a670effbfa512ad [root@localhost ~]# docker run -itd --name test22 --link=test21:nt busybox /bin/sh f4e346387588198cafcfd1d6a2c330a20375b746d05c08bf06e100f9af294a9e [root@localhost ~]# docker exec test22 ping nt -c 4 PING nt (172.17.0.2): 56 data bytes 64 bytes from 172.17.0.2: seq=0 ttl=64 time=0.201 ms 64 bytes from 172.17.0.2: seq=1 ttl=64 time=0.164 ms 64 bytes from 172.17.0.2: seq=2 ttl=64 time=0.195 ms 64 bytes from 172.17.0.2: seq=3 ttl=64 time=0.188 ms --- nt ping statistics --- 4 packets transmitted, 4 packets received, 0% packet loss round-trip min/avg/max = 0.164/0.187/0.201 ms [root@localhost ~]# docker exec test22 ifconfig eth0 eth0 Link encap:Ethernet HWaddr 02:42:AC:11:00:03 inet addr:172.17.0.3 Bcast:172.17.255.255 Mask:255.255.0.0 UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1 RX packets:14 errors:0 dropped:0 overruns:0 frame:0 TX packets:6 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:0 RX bytes:1124 (1.0 KiB) TX bytes:476 (476.0 B) [root@localhost ~]# docker exec test21 ping 172.17.0.3 -c 4 PING 172.17.0.3 (172.17.0.3): 56 data bytes 64 bytes from 172.17.0.3: seq=0 ttl=64 time=0.181 ms 64 bytes from 172.17.0.3: seq=1 ttl=64 time=0.168 ms 64 bytes from 172.17.0.3: seq=2 ttl=64 time=0.109 ms 64 bytes from 172.17.0.3: seq=3 ttl=64 time=0.226 ms --- 172.17.0.3 ping statistics --- 4 packets transmitted, 4 packets received, 0% packet loss round-trip min/avg/max = 0.109/0.171/0.226 ms ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/docker-network/","summary":"1 ç½‘ç»œæ¦‚è¿° ç‹¬ç«‹å®¹å™¨ç½‘ç»œï¼šnone host none ç½‘ç»œæœ€ä¸ºå®‰å…¨ï¼Œåªæœ‰ localback æ¥å£ host ç½‘ç»œåªå’Œç‰©ç†æœºç›¸è¿ï¼Œä¿è¯è·Ÿç‰©ç†æœºç›¸è¿çš„ç½‘ç»œæ•ˆç‡ è·Ÿç‰©ç†æœºå®Œå…¨ä¸€æ ·ï¼ˆç½‘ç»œåè®®æ ˆä¸ä¸»æœºåï¼‰ å®¹å™¨é—´çš„ç½‘ç»œï¼šbridge docker bridgeè¯¦è§£ docker å¯åŠ¨æ—¶é»˜è®¤ä¼šæœ‰ä¸€ä¸ª docker0 ç½‘æ¡¥ï¼Œè¯¥ç½‘æ¡¥å°±æ˜¯æ¡¥æ¥æ¨¡å¼çš„ä½“ç° ç”¨æˆ·ä¹Ÿå¯ä»¥è‡ªå»º bridge ç½‘ç»œï¼Œå»ºç«‹å dokcer ä¹Ÿä¼šåˆ›å»º","title":"docker | ç½‘ç»œç®€ä»‹"},{"content":"0 å‰è¨€ æŸ¥çœ‹ç¡¬ä»¶ä¿¡æ¯ï¼Œå¹¶å°†ä¿¡æ¯æ•´åˆæˆ json æ•°å€¼ï¼Œç„¶åä¼ ç»™å‰æ®µè¿›è¡Œåˆ†æï¼Œæœ€åå†è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚åœ¨è£…ç³»ç»Ÿçš„æ—¶å€™ï¼Œæˆ–æ˜¯è¿›è¡Œç›‘æ§æ—¶ï¼Œéƒ½æ˜¯ä¸€ä¸ªæ ‡å‡†çš„è‡ªåŠ¨åŒ–è¿ç»´æµç¨‹ã€‚ä½¿ç”¨ shell ç›´æ¥ç”Ÿæˆå¥½ json æ•°æ®å†è¿›è¡Œä¼ è¾“ï¼Œä¼šå˜å¾—éå¸¸æ–¹ä¾¿ã€‚\n1 ç¯å¢ƒ [root@sys-idc-pxe01 ~]# yum install jq lsscsi MegaCli 2 è„šæœ¬å†…å®¹ #!/bin/sh #description: get server hardware info #author: lvbibir #date: 20180122 #éœ€è¦å®‰è£…jqå·¥å…· yum install jq #ç”¨äºå­˜æ”¾è¯¥æœåŠ¡å™¨çš„æ‰€æœ‰ä¿¡æ¯ï¼Œä¸ªäººå–œæ¬¢æŠŠå…¨å±€å˜é‡å†™åˆ°å¤–é¢ #å†™åˆ°å‡½æ•°é‡Œé¢ï¼Œæ²¡æœ‰åŠ localçš„å˜é‡ä¹Ÿæ˜¯å…¨å±€å˜é‡ INFO=\u0026#34;{}\u0026#34; #å®šä¹‰ä¸€ä¸ªå·¥å…·å‡½æ•°ï¼Œç”¨äºç”Ÿæˆjsonæ•°å€¼ï¼Œåé¢å°†ä¼šé¢‘ç¹ç”¨åˆ° function create_json() { #utility function local key=$1 local value=\u0026#34;$2\u0026#34; local json=\u0026#34;\u0026#34; #if value is string if [ -z \u0026#34;$(echo \u0026#34;$value\u0026#34; |egrep \u0026#34;\\[|\\]|\\{|\\}\u0026#34;)\u0026#34; ] then json=$(jq -n {\u0026#34;$key\u0026#34;:\u0026#34;\\\u0026#34;$value\\\u0026#34;\u0026#34;}) #if value is json, object elif [ \u0026#34;$(echo \u0026#34;$value\u0026#34; |jq -r type)\u0026#34; == \u0026#34;object\u0026#34; ] then json=$(jq -n {\u0026#34;$key\u0026#34;:\u0026#34;$value\u0026#34;}) #if value is array elif [ \u0026#34;$(echo \u0026#34;$value\u0026#34; |jq -r type)\u0026#34; == \u0026#34;array\u0026#34; ] then json=$(jq -n \u0026#34;{$key:$value}\u0026#34;) else echo \u0026#34;value type error...\u0026#34; exit 1 return 0 fi echo $json return 0 } #è·å–CPUä¿¡æ¯ function get_cpu() { #è·å–cpuä¿¡æ¯ï¼Œå»æ‰ç©ºæ ¼å’Œåˆ¶è¡¨ç¬¦å’Œç©ºè¡Œï¼Œä»¥ä¾¿äºforå¾ªç¯ local cpu_model_1=$(dmidecode -s processor-version |grep \u0026#39;@\u0026#39; |tr -d \u0026#34; \u0026#34; |tr -s \u0026#34;\\n\u0026#34; |tr -d \u0026#34;\\t\u0026#34;) local cpu_info=\u0026#34;{}\u0026#34; local i=0 #å› ä¸ºå»æ‰äº†ç©ºæ ¼å’Œåˆ¶è¡¨ç¬¦ï¼Œä»¥ä¸‹é»˜è®¤ä½¿ç”¨æ¢è¡Œç¬¦åˆ†éš” for line in $(echo \u0026#34;$cpu_model_1\u0026#34;) do local cpu_model=\u0026#34;$line\u0026#34; local cpu1=$(create_json \u0026#34;cpu_model\u0026#34; \u0026#34;$cpu_model\u0026#34;) #è·å–æ¯å—cpuçš„ä¿¡æ¯ï¼Œè¿™é‡Œåªè®°å½•äº†å‹å· local cpu=$(create_json \u0026#34;cpu_$i\u0026#34; \u0026#34;$cpu1\u0026#34;) local cpu_info=$(jq -n \u0026#34;$cpu_info + $cpu\u0026#34;) i=$[ $i + 1] done #å°†cpuçš„ä¿¡æ¯æ•´åˆæˆä¸€ä¸ªjsonï¼Œkeyæ˜¯cpu local info=$(create_json \u0026#34;cpu\u0026#34; \u0026#34;$cpu_info\u0026#34;) #å°†ä¿¡æ¯åŠ å…¥åˆ°å…¨å±€å˜é‡ä¸­ INFO=$(jq -n \u0026#34;$INFO + $info\u0026#34;) return 0 } function get_mem() { #generate json {Locator:{sn:sn,size:size}} local mem_info=\u0026#34;{}\u0026#34; #è·å–æ¯ä¸ªå†…å­˜çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬Size:|Locator:|Serial Number: local mem_info_1=$(dmidecode -t memory |egrep \u0026#39;Size:|Locator:|Serial Number:\u0026#39; |grep -v \u0026#39;Bank Locator:\u0026#39; |awk \u0026#39; { if (NR%3==1 \u0026amp;\u0026amp; $NF==\u0026#34;MB\u0026#34;) { size=$2; getline (NR+1); locator=$2; getline (NR+2); sn=$NF; printf(\u0026#34;%s,%s,%s\\n\u0026#34;,locator,size,sn) } }\u0026#39;) #æ ¹æ®ä¸Šé¢çš„ä¿¡æ¯ï¼Œå°†ä¿¡æ¯è¿‡æ»¤å¹¶æ•´åˆæˆjson local i=0 for line in $(echo \u0026#34;$mem_info_1\u0026#34;) do local locator=$(echo $line |awk -F , \u0026#39;{print $1}\u0026#39;) local sn=$(echo $line |awk -F , \u0026#39;{print $3}\u0026#39;) local size=$(echo $line |awk -F , \u0026#39;{print $2}\u0026#39;) local mem1=$(create_json \u0026#34;locator\u0026#34; \u0026#34;$locator\u0026#34;) local mem2=$(create_json \u0026#34;sn\u0026#34; \u0026#34;$sn\u0026#34;) local mem3=$(create_json \u0026#34;size\u0026#34; \u0026#34;$size\u0026#34;) local mem4=$(jq -n \u0026#34;$mem1 + $mem2 + $mem3\u0026#34;) #æ¯æ¡å†…å­˜çš„ä¿¡æ¯ï¼Œkeyæ˜¯å†…å­˜ä»0å¼€å§‹çš„åºå· local mem=$(create_json \u0026#34;mem_$i\u0026#34; \u0026#34;$mem4\u0026#34;) #å°†è¿™äº›å†…å­˜çš„ä¿¡æ¯ç»„åˆåˆ°ä¸€ä¸ªjsonä¸­ mem_info=$(jq -n \u0026#34;$mem_info + $mem\u0026#34;) i=$[ $i + 1 ] done #ç»™è¿™äº›å†…å­˜çš„ä¿¡æ¯è®¾ç½®keyï¼Œmem local info=$(create_json \u0026#34;mem\u0026#34; \u0026#34;$mem_info\u0026#34;) INFO=$(jq -n \u0026#34;$INFO + $info\u0026#34;) return 0 } function get_megacli_disk() { #è®¾ç½®megacliå·¥å…·çš„è·¯å¾„ï¼Œæ­¤æ¡å¯ä»¥æ ¹æ®æƒ…å†µæ›´æ”¹ local raid_tool=\u0026#34;/opt/MegaRAID/MegaCli/MegaCli64\u0026#34; #å°†ç¡¬ç›˜ä¿¡æ¯è·å–ï¼Œä¿å­˜ä¸‹æ¥ï¼Œçœå»æ¯æ¬¡éƒ½æ‰§è¡Œçš„æ“ä½œ $raid_tool pdlist aall \u0026gt;/tmp/megacli_pdlist.txt local disk_info=\u0026#34;{}\u0026#34; #è·å–ç¡¬ç›˜çš„å¿…è¦ä¿¡æ¯ local disk_info_1=$(cat /tmp/megacli_pdlist.txt |egrep \u0026#39;Enclosure Device ID:|Slot Number:|PD Type:|Raw Size:|Inquiry Data:|Media Type:\u0026#39;|awk \u0026#39; { if(NR%6==1 \u0026amp;\u0026amp; $1$2==\u0026#34;EnclosureDevice\u0026#34;) { E=$NF; getline (NR+1); S=$NF; getline (NR+2); pdtype=$NF; getline (NR+3); size=$3$4; getline (NR+4); sn=$3$4$5$6; getline (NR+5); mediatype=$3$4$5$6; printf(\u0026#34;%s,%s,%s,%s,%s,%s\\n\u0026#34;,E,S,pdtype,size,sn,mediatype) } }\u0026#39;) #å°†è·å–åˆ°çš„ç¡¬ç›˜ä¿¡æ¯è¿›è¡Œæ•´åˆï¼Œç”Ÿæˆjson local i=0 for line in $(echo $disk_info_1) do #local key=$(echo $line |awk -F , \u0026#39;{printf(\u0026#34;ES%s_%s\\n\u0026#34;,$1,$2)}\u0026#39;) local E=$(echo $line |awk -F , \u0026#39;{print $1}\u0026#39;) local S=$(echo $line |awk -F , \u0026#39;{print $2}\u0026#39;) local pdtype=$(echo $line |awk -F , \u0026#39;{print $3}\u0026#39;) local size=$(echo $line |awk -F , \u0026#39;{print $4}\u0026#39;) local sn=$(echo $line |awk -F , \u0026#39;{print $5}\u0026#39;) local mediatype=$(echo $line |awk -F , \u0026#39;{print $6}\u0026#39;) local disk1=$(create_json \u0026#34;pdtype\u0026#34; \u0026#34;$pdtype\u0026#34;) local disk1_1=$(create_json \u0026#34;enclosure_id\u0026#34; \u0026#34;$E\u0026#34;) local disk1_2=$(create_json \u0026#34;slot_id\u0026#34; \u0026#34;$S\u0026#34;) local disk2=$(create_json \u0026#34;size\u0026#34; \u0026#34;$size\u0026#34;) local disk3=$(create_json \u0026#34;sn\u0026#34; \u0026#34;$sn\u0026#34;) local disk4=$(create_json \u0026#34;mediatype\u0026#34; \u0026#34;$mediatype\u0026#34;) local disk5=$(jq -n \u0026#34;$disk1 + $disk1_1 + $disk1_2 + $disk2 + $disk3 + $disk4\u0026#34;) local disk=$(create_json \u0026#34;disk_$i\u0026#34; \u0026#34;$disk5\u0026#34;) disk_info=$(jq -n \u0026#34;$disk_info + $disk\u0026#34;) i=$[ $i + 1 ] done #echo $disk_info local info=$(create_json \u0026#34;disk\u0026#34; \u0026#34;$disk_info\u0026#34;) INFO=$(jq -n \u0026#34;$INFO + $info\u0026#34;) return 0 } function get_hba_disk() { #å¯¹äºhbaå¡çš„ç¡¬ç›˜ï¼Œä½¿ç”¨smartctlè·å–ç¡¬ç›˜ä¿¡æ¯ local disk_tool=\u0026#34;smartctl\u0026#34; local disk_info=\u0026#34;{}\u0026#34; #lsscsi éœ€è¦ä½¿ç”¨yum install lsscsi å®‰è£… local disk_info_1=$(lsscsi -g |grep -v \u0026#39;enclosu\u0026#39; |awk \u0026#39;{printf(\u0026#34;%s,%s,%s,%s\\n\u0026#34;,$1,$2,$(NF-1),$NF)}\u0026#39;) local i=0 for line in $(echo $disk_info_1) do local E=$(echo $line |awk -F , \u0026#39;{print $1}\u0026#39; |awk -F \u0026#39;:\u0026#39; \u0026#39;{print $1}\u0026#39; |tr -d \u0026#39;\\[|\\]\u0026#39;) local S=$(echo $line |awk -F , \u0026#39;{print $NF}\u0026#39; |egrep -o [0-9]*) local sd=$(echo $line |awk -F , \u0026#39;{print $(NF-1)}\u0026#39;) $disk_tool -i $sd \u0026gt;/tmp/disk_info.txt local pdtype=\u0026#34;SATA\u0026#34; if [ \u0026#34;$(cat /tmp/disk_info.txt |grep \u0026#39;Transport protocol:\u0026#39; |awk \u0026#39;{print $NF}\u0026#39;)\u0026#34; == \u0026#34;SAS\u0026#34; ] then local pdtype=\u0026#34;SAS\u0026#34; fi local size=$(cat /tmp/disk_info.txt |grep \u0026#39;User Capacity:\u0026#39; |awk \u0026#39;{printf(\u0026#34;%s%s\\n\u0026#34;,$(NF-1),$NF)}\u0026#39; |tr -d \u0026#39;\\[|\\]\u0026#39;) local sn=$(cat /tmp/disk_info.txt |grep \u0026#39;Serial Number:\u0026#39; |awk \u0026#39;{print $NF}\u0026#39;) local mediatype=\u0026#34;disk\u0026#34; local disk1=$(create_json \u0026#34;pdtype\u0026#34; \u0026#34;$pdtype\u0026#34;) local disk1_1=$(create_json \u0026#34;enclosure_id\u0026#34; \u0026#34;$E\u0026#34;) local disk1_2=$(create_json \u0026#34;slot_id\u0026#34; \u0026#34;$S\u0026#34;) local disk2=$(create_json \u0026#34;size\u0026#34; \u0026#34;$size\u0026#34;) local disk3=$(create_json \u0026#34;sn\u0026#34; \u0026#34;$sn\u0026#34;) local disk4=$(create_json \u0026#34;mediatype\u0026#34; \u0026#34;$mediatype\u0026#34;) local disk5=$(jq -n \u0026#34;$disk1 + $disk1_1 + $disk1_2 + $disk2 + $disk3 + $disk4\u0026#34;) local disk=$(create_json \u0026#34;disk_$i\u0026#34; \u0026#34;$disk5\u0026#34;) disk_info=$(jq -n \u0026#34;$disk_info + $disk\u0026#34;) i=$[ $i + 1 ] done #echo $disk_info local info=$(create_json \u0026#34;disk\u0026#34; \u0026#34;$disk_info\u0026#34;) INFO=$(jq -n \u0026#34;$INFO + $info\u0026#34;) return 0 } function get_disk() { #æ ¹æ®è·å–åˆ°çš„ç¡¬ç›˜æ§åˆ¶å™¨ç±»å‹ï¼Œæ¥åˆ¤æ–­ä½¿ç”¨ä»€ä¹ˆå·¥å…·é‡‡é›†ç¡¬ç›˜ä¿¡æ¯ if [ \u0026#34;$(echo \u0026#34;$INFO\u0026#34; |jq -r .disk_ctrl.disk_ctrl_0.type)\u0026#34; == \u0026#34;raid\u0026#34; ] then get_megacli_disk elif [ \u0026#34;$(echo \u0026#34;$INFO\u0026#34; |jq -r .disk_ctrl.disk_ctrl_0.type)\u0026#34; == \u0026#34;hba\u0026#34; ] then get_hba_disk else local info=$(create_json \u0026#34;disk\u0026#34; \u0026#34;error\u0026#34;) INFO=$(jq -n \u0026#34;$INFO + $info\u0026#34;) fi #hpæœºå™¨æ¯”è¾ƒç‰¹æ®Šï¼Œè¿™é‡Œæˆ‘æ²¡æœ‰åšhpæœºå™¨ç¡¬ç›˜ä¿¡æ¯é‡‡é›†ï¼Œæœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥è‡ªè¡Œæ·»åŠ ä¸Š #if hp machine return 0 } function get_diskController() { local disk_ctrl=\u0026#34;{}\u0026#34; #if LSI Controller local disk_ctrl_1=\u0026#34;$(lspci -nn |grep LSI)\u0026#34; local i=0 #ä»¥æ¢è¡Œç¬¦åˆ†éš” IFS_OLD=$IFS \u0026amp;\u0026amp; IFS=$\u0026#39;\\n\u0026#39; for line in $(echo \u0026#34;$disk_ctrl_1\u0026#34;) do #echo $line local ctrl_id=$(echo \u0026#34;$line\u0026#34; |awk -F \u0026#39;]:\u0026#39; \u0026#39;{print $1}\u0026#39; |awk \u0026#39;{print $NF}\u0026#39; |tr -d \u0026#39;\\[|\\]\u0026#39;) case \u0026#34;$ctrl_id\u0026#34; in #æ ¹æ®æ§åˆ¶å™¨çš„idæˆ–è¿›è¡Œåˆ¤æ–­æ˜¯raidå¡è¿˜æ˜¯hbaå¡ï¼Œå› ä¸ºå“ç‰Œæ¯”è¾ƒå¤šï¼Œåç»­å¯ä»¥åœ¨æ­¤å¤„è¿›è¡Œæ‰©å±•æ·»åŠ  0104) # è·å–Logicä»¥åçš„å­—ç¬¦ä¸²ï¼Œå¹¶è¿›è¡Œæ‹¼æ¥ local ctrl_name=$(echo \u0026#34;${line##*\u0026#34;Logic\u0026#34;}\u0026#34; |awk \u0026#39;{printf(\u0026#34;%s_%s_%s\\n\u0026#34;,$1,$2,$3)}\u0026#39;) local ctrl1=$(create_json \u0026#34;id\u0026#34; \u0026#34;$ctrl_id\u0026#34;) local ctrl2=$(create_json \u0026#34;type\u0026#34; \u0026#34;raid\u0026#34;) local ctrl3=$(create_json \u0026#34;name\u0026#34; \u0026#34;$ctrl_name\u0026#34;) ;; 0100|0107) local ctrl_name=$(echo \u0026#34;${line##*\u0026#34;Logic\u0026#34;}\u0026#34; |awk \u0026#39;{printf(\u0026#34;%s_%s_%s\\n\u0026#34;,$1,$3,$4)}\u0026#39;) local ctrl1=$(create_json \u0026#34;id\u0026#34; \u0026#34;$ctrl_id\u0026#34;) local ctrl2=$(create_json \u0026#34;type\u0026#34; \u0026#34;hba\u0026#34;) local ctrl3=$(create_json \u0026#34;name\u0026#34; \u0026#34;$ctrl_name\u0026#34;) ;; *) local ctrl1=$(create_json \u0026#34;id\u0026#34; \u0026#34;----\u0026#34;) local ctrl2=$(create_json \u0026#34;type\u0026#34; \u0026#34;----\u0026#34;) local ctrl3=$(create_json \u0026#34;name\u0026#34; \u0026#34;----\u0026#34;) ;; esac local ctrl_tmp=$(jq -n \u0026#34;$ctrl1 + $ctrl2 + $ctrl3\u0026#34;) local ctrl=$(create_json \u0026#34;disk_ctrl_$i\u0026#34; \u0026#34;$ctrl_tmp\u0026#34;) disk_ctrl=$(jq -n \u0026#34;$disk_ctrl + $ctrl\u0026#34;) i=$[ $i + 1 ] done IFS=$IFS_OLD local info=$(create_json \u0026#34;disk_ctrl\u0026#34; \u0026#34;$disk_ctrl\u0026#34;) INFO=$(jq -n \u0026#34;$INFO + $info\u0026#34;) return 0 } function get_netcard() { local netcard_info=\u0026#34;{}\u0026#34; local netcard_info_1=\u0026#34;$(lspci -nn |grep Ether)\u0026#34; local i=0 #echo \u0026#34;$netcard_info_1\u0026#34; IFS_OLD=$IFS \u0026amp;\u0026amp; IFS=$\u0026#39;\\n\u0026#39; for line in $(echo \u0026#34;$netcard_info_1\u0026#34;) do local net_id=$(echo $line |egrep -o \u0026#39;[0-9a-z]{4}:[0-9a-z]{4}\u0026#39;) local net_id_1=$(echo $net_id |awk -F : \u0026#39;{print $1}\u0026#39;) case \u0026#34;$net_id_1\u0026#34; in 8086) local net_name=$(echo \u0026#34;${line##*\u0026#34;: \u0026#34;}\u0026#34; |awk \u0026#39;{printf(\u0026#34;%s_%s_%s_%s\\n\u0026#34;,$1,$3,$4,$5)}\u0026#39;) local type=$(echo $line |egrep -o SFP || echo \u0026#34;TP\u0026#34;) local net1=$(create_json \u0026#34;id\u0026#34; \u0026#34;$net_id\u0026#34;) local net2=$(create_json \u0026#34;name\u0026#34; \u0026#34;$net_name\u0026#34;) local net3=$(create_json \u0026#34;type\u0026#34; \u0026#34;$type\u0026#34;) ;; 14e4) local net_name=$(echo \u0026#34;${line##*\u0026#34;: \u0026#34;}\u0026#34; |awk \u0026#39;{printf(\u0026#34;%s_%s_%s_%s\\n\u0026#34;,$1,$3,$4,$5)}\u0026#39;) local type=$(echo $line |egrep -o SFP || echo \u0026#34;TP\u0026#34;) local net1=$(create_json \u0026#34;id\u0026#34; \u0026#34;$net_id\u0026#34;) local net2=$(create_json \u0026#34;name\u0026#34; \u0026#34;$net_name\u0026#34;) local net3=$(create_json \u0026#34;type\u0026#34; \u0026#34;$type\u0026#34;) ;; *) local net_name=$(echo \u0026#34;${line##*\u0026#34;: \u0026#34;}\u0026#34; |awk \u0026#39;{printf(\u0026#34;%s_%s_%s_%s\\n\u0026#34;,$1,$3,$4,$5)}\u0026#39;) local type=$(echo $line |egrep -o SFP || echo \u0026#34;TP\u0026#34;) local net1=$(create_json \u0026#34;id\u0026#34; \u0026#34;$net_id\u0026#34;) local net2=$(create_json \u0026#34;name\u0026#34; \u0026#34;$net_name\u0026#34;) local net3=$(create_json \u0026#34;type\u0026#34; \u0026#34;$type\u0026#34;) ;; esac local net1=$(jq -n \u0026#34;$net1 + $net2 + $net3\u0026#34;) #echo $net local net2=$(create_json \u0026#34;net_$i\u0026#34; \u0026#34;$net1\u0026#34;) netcard_info=$(jq -n \u0026#34;$netcard_info + $net2\u0026#34;) i=$[ $i + 1 ] done IFS=$IFS_OLD local info=$(create_json \u0026#34;net\u0026#34; \u0026#34;$netcard_info\u0026#34;) INFO=$(jq -n \u0026#34;$INFO + $info\u0026#34;) return 0 } function get_server() { local product=$(dmidecode -s system-product-name |grep -v \u0026#39;^#\u0026#39; |tr -d \u0026#39; \u0026#39; |head -n1) local manufacturer=$(dmidecode -s system-manufacturer |grep -v \u0026#39;^#\u0026#39; |tr -d \u0026#39; \u0026#39; |head -n1) local server1=$(create_json \u0026#34;manufacturer\u0026#34; \u0026#34;$manufacturer\u0026#34;) local server2=$(create_json \u0026#34;product\u0026#34; \u0026#34;$product\u0026#34;) local server3=$(jq -n \u0026#34;$server1 + $server2\u0026#34;) local info=$(create_json \u0026#34;basic_info\u0026#34; \u0026#34;$server3\u0026#34;) INFO=$(jq -n \u0026#34;$INFO + $info\u0026#34;) return 0 } ALL_INFO=\u0026#34;\u0026#34; function get_all() { #å› ä¸ºç¡¬ç›˜ä¿¡æ¯çš„è·å–ä¾èµ–ç¡¬ç›˜æ§åˆ¶å™¨çš„ä¿¡æ¯ï¼Œæ‰€ä»¥get_diskControllerè¦æ”¾åˆ°get_diskå‰é¢ get_server get_cpu get_mem get_diskController get_disk get_netcard local sn=$(dmidecode -s system-serial-number |grep -v \u0026#39;^#\u0026#39; |tr -d \u0026#39; \u0026#39; |head -n1) ALL_INFO=$(create_json \u0026#34;$sn\u0026#34; \u0026#34;$INFO\u0026#34;) return 0 } function main() { get_all echo $ALL_INFO return 0 } #------------------------------------------------- main ä»¥ä¸Š\n","permalink":"https://www.lvbibir.cn/posts/tech/shell-get-server-hardware-information/","summary":"0 å‰è¨€ æŸ¥çœ‹ç¡¬ä»¶ä¿¡æ¯ï¼Œå¹¶å°†ä¿¡æ¯æ•´åˆæˆ json æ•°å€¼ï¼Œç„¶åä¼ ç»™å‰æ®µè¿›è¡Œåˆ†æï¼Œæœ€åå†è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚åœ¨è£…ç³»ç»Ÿçš„æ—¶å€™ï¼Œæˆ–æ˜¯è¿›è¡Œç›‘æ§æ—¶ï¼Œéƒ½æ˜¯ä¸€ä¸ªæ ‡å‡†çš„è‡ªåŠ¨åŒ–è¿ç»´æµç¨‹ã€‚ä½¿ç”¨ shell ç›´æ¥ç”Ÿæˆå¥½ json æ•°æ®å†è¿›è¡Œä¼ è¾“ï¼Œä¼šå˜å¾—éå¸¸æ–¹ä¾¿ã€‚ 1 ç¯å¢ƒ [root@sys-idc-pxe01 ~]# yum install jq lsscsi MegaCli 2 è„šæœ¬å†…å®¹ #!/bin/sh #description: get server hardware info #author: lvbibir #date: 20180122 #éœ€è¦å®‰è£…jqå·¥å…· yum install jq #ç”¨äºå­˜","title":"shell | è·å–æœåŠ¡å™¨ç¡¬ä»¶ä¿¡æ¯æ•´åˆä¸º json æ ¼å¼ "}]