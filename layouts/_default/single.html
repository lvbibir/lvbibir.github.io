{{- define "main" }}
{{- /* Capture series and toc partials for conditional rendering */}}
{{- $seriesHTML := partial "series.html" . -}}
{{- $showToc := .Param "ShowToc" -}}
{{- $tocHTML := "" -}}
{{- if $showToc -}}
  {{- $tocHTML = partial "toc.html" . -}}
{{- end -}}

<div class="post-grid{{ if $seriesHTML }} has-series{{ end }}{{ if $tocHTML }} has-toc{{ end }}">
    {{- /* Left Sidebar: Series */}}
    {{- if $seriesHTML }}
    <aside class="post-grid__series">
        {{ $seriesHTML }}
    </aside>
    {{- end }}

    {{- /* Main Content */}}
    <article class="post-single post-grid__content">
        <div id="single-content">
            <header class="post-header">
                {{ partial "breadcrumbs.html" . }}
                <h1 class="post-title">
                    {{ .Title }}
                    {{- if .Draft }}<sup><span class="entry-isdraft">&nbsp;&nbsp;[draft]</span></sup>{{- end }}
                </h1>
                {{- if .Description }}
                <div class="post-description">
                    {{ .Description }}
                </div>
                {{- end }}
                {{- if not (.Param "hideMeta") }}
                <div class="post-meta">
                    {{- partial "post_meta.html" . -}}
                    <!--Ê†áÁ≠æÊòæÁ§∫Âú®Â§¥ÈÉ®-->
                    |&nbsp;Ê†áÁ≠æ:&nbsp;
                    {{- if .Params.tags }}
                    <ul class="post-tags-meta">
                        {{- range $index, $value := ($.GetTerms "tags") }}
                        {{- if eq $index 0}}
                        <a href="{{ .Permalink }}">{{ .LinkTitle }}</a>
                        {{- else }}
                        <a href="{{ .Permalink }}">„ÄÅ{{ .LinkTitle }}</a>
                        {{- end }}
                        {{- end }}
                    </ul>
                    {{- end }}

                    <span id="busuanzi_container_page_pv">
                        &nbsp;|&nbsp;ËÆøÈóÆ:&nbsp;<span id="busuanzi_page_pv"></span>
                    </span>

                    {{- partial "translation_list.html" . -}}
                    {{- partial "edit_post.html" . -}}
                    {{- partial "post_canonical.html" . -}}
                </div>
                {{- end }}
            </header>
            {{- $isHidden := .Params.cover.hidden | default .Site.Params.cover.hiddenInSingle | default
            .Site.Params.cover.hidden }}
            {{- partial "cover1.html" (dict "cxt" . "IsHome" false "isHidden" $isHidden) }}

            {{- if .Content }}
            <div class="post-content">
                {{- if and $showToc (not $seriesHTML) -}}
                {{- partial "toc_inline.html" . -}}
                {{- end -}}
                {{- if not (.Param "disableAnchoredHeadings") }}
                {{- partial "anchored_headings.html" .Content -}}
                {{- else }}{{ .Content }}{{ end }}
            </div>
            {{- end }}

            {{- if .Param "reward" }}
            <div class="post-reward">
                <div style="padding: 0 0 0 0; margin: 0 0 0 0; width: 100%; font-size:16px; text-align: center;">
                    <div id="QR" style="opacity: 0;">
                        <div id="wechat" style="display: inline-block">
                            <a class="fancybox" rel="group">
                                <img id="wechat_qr" src="{{ .Site.Params.WechatPay | absURL }}" alt="wechat_pay"></a>
                            <p>ÂæÆ‰ø°</p>
                        </div>
                        <div id="alipay" style="display: inline-block">
                            <a class="fancybox" rel="group">
                                <img id="alipay_qr" src="{{ .Site.Params.Alipay | absURL }}" alt="alipay"></a>
                            <p>ÊîØ‰ªòÂÆù</p>
                        </div>
                    </div>
                    <button id="rewardButton"
                            onclick="
                        var qr = document.getElementById('QR');
                        if (qr.style.opacity === '0') {
                            qr.style.opacity='1';
                        } else {
                            qr.style.opacity='0'
                        }"
                    >
                        <span>üßß ÈºìÂä±</span>
                    </button>
                </div>
            </div>
            {{- end }}

            <footer class="post-footer">
                {{- if (.Param "ShowPostNavLinks") }}
                {{- partial "post_nav_links.html" . }}
                {{- end }}
                {{- if (and .Site.Params.ShowShareButtons (ne .Params.disableShare true)) }}
                {{- partial "share_icons.html" . -}}
                {{- end }}
            </footer>
        </div>

        {{- if (.Param "comments") }}
        {{- partial "comments.html" . }}
        {{- end }}
    </article>

    {{- /* Right Sidebar: TOC */}}
    {{- if $tocHTML }}
    <aside class="post-grid__toc">
        {{ $tocHTML }}
    </aside>
    {{- end }}
</div>

<script>
    (function() {
        const grid = document.querySelector(".post-grid");
        if (!grid) return;

        const MODES = [
            "pg--series-popup",
            "pg--series-two",
            "pg--series-three",
            "pg--toc-one",
            "pg--toc-two",
        ];

        function toPx(value, fallback) {
            if (!value) return fallback;
            const n = Number.parseFloat(String(value).trim());
            return Number.isFinite(n) ? n : fallback;
        }

        function readVarPx(style, name, fallback) {
            return toPx(style.getPropertyValue(name), fallback);
        }

        function forceCloseSeriesPopup() {
            const seriesContainer = document.getElementById("series-container");
            const seriesToggleBtn = document.getElementById("series-toggle-btn");
            const seriesOverlay = document.getElementById("series-overlay");

            if (!seriesContainer || !seriesContainer.classList.contains("is-open")) return;

            seriesContainer.classList.remove("is-open");
            if (seriesOverlay) seriesOverlay.classList.remove("is-open");
            if (seriesToggleBtn) {
                seriesToggleBtn.classList.remove("is-open");
                seriesToggleBtn.setAttribute("aria-expanded", "false");
            }
            document.body.style.overflow = "";
        }

        function applyLayout() {
            const style = getComputedStyle(document.documentElement);
            const seriesWidth = readVarPx(style, "--series-width", 350);
            const articleWidth = readVarPx(style, "--article-width", 800);
            const tocWidth = readVarPx(style, "--toc-width", 250);
            const contentGap = readVarPx(style, "--content-gap", 20);

            const w = grid.clientWidth;
            const hasSeries = grid.classList.contains("has-series");
            const hasToc = grid.classList.contains("has-toc");

            let mode = "pg--toc-one";

            if (hasSeries) {
                const bp2 = seriesWidth + contentGap + articleWidth;
                const bp3 = seriesWidth + contentGap + articleWidth + contentGap + tocWidth;
                if (hasToc && w >= bp3) {
                    mode = "pg--series-three";
                } else if (w >= bp2) {
                    mode = "pg--series-two";
                } else {
                    mode = "pg--series-popup";
                }
            } else if (hasToc) {
                const bp = articleWidth + contentGap + tocWidth;
                mode = w >= bp ? "pg--toc-two" : "pg--toc-one";
            }

            grid.classList.remove(...MODES);
            grid.classList.add(mode);

            if (mode !== "pg--series-popup") {
                forceCloseSeriesPopup();
            }
        }

        let raf = 0;
        function schedule() {
            if (raf) return;
            raf = window.requestAnimationFrame(() => {
                raf = 0;
                applyLayout();
            });
        }

        window.addEventListener("resize", schedule, { passive: true });
        window.addEventListener("orientationchange", schedule, { passive: true });

        applyLayout();
    })();
</script>

{{- end }}{{/* end main */}}
