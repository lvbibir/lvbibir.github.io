<!-- {{- /* Comments area start */ -}}
{{- /* to add comments read => https://gohugo.io/content-management/comments/ */ -}}
{{- /* Comments area end */ -}}
 -->


<!-- Twikoo -->
<div id="comments" class="comments">
    <div class="pagination__title">
        <span class="pagination__title-h" style="font-size: 20px;">ðŸ’¬è¯„è®º</span>
        <hr />
    </div>

    <div class="comment-loader">
        <button id="tcomment-load" class="comment-load-btn" type="button">
            åŠ è½½è¯„è®º
        </button>
        <span id="tcomment-status" class="comment-load-status" aria-live="polite"></span>
    </div>

    <div id="tcomment"></div>

    <script>
        (function () {
            const commentsRoot = document.getElementById("comments");
            const commentEl = document.getElementById("tcomment");
            const loadBtn = document.getElementById("tcomment-load");
            const statusEl = document.getElementById("tcomment-status");

            if (!commentsRoot || !commentEl || !loadBtn) return;

            const scriptSrc = "/js/twikoo/{{ .Site.Params.twikoo.version }}/twikoo.min.js";
            const envId = "https://www.lvbibir.cn/twikoo/";

            let loading = false;
            let initialized = false;

            function setStatus(text) {
                if (!statusEl) return;
                statusEl.textContent = text || "";
            }

            function setButtonDisabled(disabled) {
                loadBtn.disabled = disabled;
                loadBtn.setAttribute("aria-disabled", disabled ? "true" : "false");
            }

            function fail(message) {
                loading = false;
                setButtonDisabled(false);
                setStatus(message || "è¯„è®ºåŠ è½½å¤±è´¥, è¯·åˆ·æ–°é‡è¯•");
            }

            function initTwikoo() {
                if (initialized) return;
                if (!window.twikoo || typeof window.twikoo.init !== "function") {
                    fail("è¯„è®ºåŠ è½½å¤±è´¥, è¯·åˆ·æ–°é‡è¯•");
                    return;
                }

                window.twikoo.init({
                    envId: envId,
                    el: "#tcomment",
                    lang: "zh-CN",
                    path: window.TWIKOO_MAGIC_PATH || window.location.pathname,
                });

                initialized = true;
                loading = false;
                setStatus("");
                loadBtn.remove();
            }

            function loadTwikoo() {
                if (initialized || loading) return;
                loading = true;
                setButtonDisabled(true);
                setStatus("æ­£åœ¨åŠ è½½è¯„è®º...");

                if (window.twikoo && typeof window.twikoo.init === "function") {
                    initTwikoo();
                    return;
                }

                const existing = document.querySelector(`script[src="${scriptSrc}"]`);
                if (existing) {
                    existing.addEventListener("load", initTwikoo, { once: true });
                    existing.addEventListener("error", () => fail(), { once: true });
                    return;
                }

                const script = document.createElement("script");
                script.src = scriptSrc;
                script.defer = true;
                script.onload = initTwikoo;
                script.onerror = () => fail();
                document.head.appendChild(script);
            }

            loadBtn.addEventListener("click", loadTwikoo);

            if ("IntersectionObserver" in window) {
                const observer = new IntersectionObserver(
                    (entries) => {
                        for (const entry of entries) {
                            if (!entry.isIntersecting) continue;
                            observer.disconnect();
                            loadTwikoo();
                            break;
                        }
                    },
                    { rootMargin: "200px 0px" }
                );
                observer.observe(commentsRoot);
            }
        })();
    </script>

</div>
