<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>docker | dockerfile æŒ‡ä»¤è¯¦è§£ | lvbibir's Blog</title><meta name=keywords content="docker,dockerfile"><meta name=description content="0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥ï¼š Dockerfile æŒ‡ä»¤è¯¦è§£ Dockerfile ç”¨äºæ„å»º docker é•œåƒ, å®é™…ä¸Šå°±æ˜¯æŠŠåœ¨ linux ä¸‹çš„å‘½ä»¤æ“ä½œå†™åˆ°äº† Dockerfile ä¸­, é€šè¿‡ Dockerfile å»æ‰§è¡Œè®¾ç½®å¥½çš„æ“ä½œå‘½ä»¤, ä¿è¯é€šè¿‡ Dockerfile çš„æ„å»ºé•œåƒæ˜¯ä¸€è‡´çš„. Dockerfile æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶, å…¶å†…åŒ…å«äº†ä¸€æ¡æ¡çš„æŒ‡ä»¤ (Instruction), æ¯ä¸€æ¡æŒ‡ä»¤æ„å»ºä¸€å±‚, å› æ­¤æ¯ä¸€æ¡æŒ‡ä»¤çš„å†…å®¹, å°±æ˜¯æè¿°è¯¥å±‚åº”å½“å¦‚ä½•æ„å»º. 1 FROM æŒ‡å®šåŸºç¡€é•œåƒ å‘½"><meta name=author content="ä½œè€…:&nbsp;lvbibir"><link rel=canonical href=https://www.lvbibir.cn/posts/tech/docker-dockerfile-instruction/><link crossorigin=anonymous href=/assets/css/stylesheet.4d3f7f8d80f014cb5a4ea899ab85a1981b231a25b1180077f21cd46aed7f0b6d.css integrity="sha256-TT9/jYDwFMtaTqiZq4WhmBsjGiWxGAB38hzUau1/C20=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://image.lvbibir.cn/blog/avatar.webp><link rel=icon type=image/png sizes=16x16 href=https://image.lvbibir.cn/blog/avatar.webp><link rel=icon type=image/png sizes=32x32 href=https://image.lvbibir.cn/blog/avatar.webp><link rel=apple-touch-icon href=https://image.lvbibir.cn/blog/avatar.webp><link rel=mask-icon href=https://image.lvbibir.cn/blog/avatar.webp><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://image.lvbibir.cn/fonts/JetBrainsLxgwNerdMono/all.css><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script>document.addEventListener('DOMContentLoaded',function(){const e=document.querySelectorAll('img.lazyload');if('IntersectionObserver'in window){const t=new IntersectionObserver(function(e){e.forEach(function(e){if(e.isIntersecting){const n=e.target;n.src=n.dataset.src,n.classList.remove('lazyload'),n.classList.add('lazyloaded'),t.unobserve(n)}})},{rootMargin:'50px 0px',threshold:.01});e.forEach(function(e){t.observe(e)})}else e.forEach(function(e){e.src=e.dataset.src})})</script><meta property="og:title" content="docker | dockerfile æŒ‡ä»¤è¯¦è§£"><meta property="og:description" content="0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥ï¼š Dockerfile æŒ‡ä»¤è¯¦è§£ Dockerfile ç”¨äºæ„å»º docker é•œåƒ, å®é™…ä¸Šå°±æ˜¯æŠŠåœ¨ linux ä¸‹çš„å‘½ä»¤æ“ä½œå†™åˆ°äº† Dockerfile ä¸­, é€šè¿‡ Dockerfile å»æ‰§è¡Œè®¾ç½®å¥½çš„æ“ä½œå‘½ä»¤, ä¿è¯é€šè¿‡ Dockerfile çš„æ„å»ºé•œåƒæ˜¯ä¸€è‡´çš„. Dockerfile æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶, å…¶å†…åŒ…å«äº†ä¸€æ¡æ¡çš„æŒ‡ä»¤ (Instruction), æ¯ä¸€æ¡æŒ‡ä»¤æ„å»ºä¸€å±‚, å› æ­¤æ¯ä¸€æ¡æŒ‡ä»¤çš„å†…å®¹, å°±æ˜¯æè¿°è¯¥å±‚åº”å½“å¦‚ä½•æ„å»º. 1 FROM æŒ‡å®šåŸºç¡€é•œåƒ å‘½"><meta property="og:type" content="article"><meta property="og:url" content="https://www.lvbibir.cn/posts/tech/docker-dockerfile-instruction/"><meta property="og:image" content="https://image.lvbibir.cn/blog/docker.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-09T00:00:00+00:00"><meta property="article:modified_time" content="2024-01-27T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://image.lvbibir.cn/blog/docker.png"><meta name=twitter:title content="docker | dockerfile æŒ‡ä»¤è¯¦è§£"><meta name=twitter:description content="0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥ï¼š Dockerfile æŒ‡ä»¤è¯¦è§£ Dockerfile ç”¨äºæ„å»º docker é•œåƒ, å®é™…ä¸Šå°±æ˜¯æŠŠåœ¨ linux ä¸‹çš„å‘½ä»¤æ“ä½œå†™åˆ°äº† Dockerfile ä¸­, é€šè¿‡ Dockerfile å»æ‰§è¡Œè®¾ç½®å¥½çš„æ“ä½œå‘½ä»¤, ä¿è¯é€šè¿‡ Dockerfile çš„æ„å»ºé•œåƒæ˜¯ä¸€è‡´çš„. Dockerfile æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶, å…¶å†…åŒ…å«äº†ä¸€æ¡æ¡çš„æŒ‡ä»¤ (Instruction), æ¯ä¸€æ¡æŒ‡ä»¤æ„å»ºä¸€å±‚, å› æ­¤æ¯ä¸€æ¡æŒ‡ä»¤çš„å†…å®¹, å°±æ˜¯æè¿°è¯¥å±‚åº”å½“å¦‚ä½•æ„å»º. 1 FROM æŒ‡å®šåŸºç¡€é•œåƒ å‘½"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"ğŸ“š æ–‡ç« ","item":"https://www.lvbibir.cn/posts/"},{"@type":"ListItem","position":3,"name":"ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯","item":"https://www.lvbibir.cn/posts/tech/"},{"@type":"ListItem","position":4,"name":"docker | dockerfile æŒ‡ä»¤è¯¦è§£","item":"https://www.lvbibir.cn/posts/tech/docker-dockerfile-instruction/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"docker | dockerfile æŒ‡ä»¤è¯¦è§£","name":"docker | dockerfile æŒ‡ä»¤è¯¦è§£","description":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥ï¼š Dockerfile æŒ‡ä»¤è¯¦è§£ Dockerfile ç”¨äºæ„å»º docker é•œåƒ, å®é™…ä¸Šå°±æ˜¯æŠŠåœ¨ linux ä¸‹çš„å‘½ä»¤æ“ä½œå†™åˆ°äº† Dockerfile ä¸­, é€šè¿‡ Dockerfile å»æ‰§è¡Œè®¾ç½®å¥½çš„æ“ä½œå‘½ä»¤, ä¿è¯é€šè¿‡ Dockerfile çš„æ„å»ºé•œåƒæ˜¯ä¸€è‡´çš„. Dockerfile æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶, å…¶å†…åŒ…å«äº†ä¸€æ¡æ¡çš„æŒ‡ä»¤ (Instruction), æ¯ä¸€æ¡æŒ‡ä»¤æ„å»ºä¸€å±‚, å› æ­¤æ¯ä¸€æ¡æŒ‡ä»¤çš„å†…å®¹, å°±æ˜¯æè¿°è¯¥å±‚åº”å½“å¦‚ä½•æ„å»º. 1 FROM æŒ‡å®šåŸºç¡€é•œåƒ å‘½","keywords":["docker","dockerfile"],"articleBody":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥ï¼š\nDockerfile æŒ‡ä»¤è¯¦è§£ Dockerfile ç”¨äºæ„å»º docker é•œåƒ, å®é™…ä¸Šå°±æ˜¯æŠŠåœ¨ linux ä¸‹çš„å‘½ä»¤æ“ä½œå†™åˆ°äº† Dockerfile ä¸­, é€šè¿‡ Dockerfile å»æ‰§è¡Œè®¾ç½®å¥½çš„æ“ä½œå‘½ä»¤, ä¿è¯é€šè¿‡ Dockerfile çš„æ„å»ºé•œåƒæ˜¯ä¸€è‡´çš„.\nDockerfile æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶, å…¶å†…åŒ…å«äº†ä¸€æ¡æ¡çš„æŒ‡ä»¤ (Instruction), æ¯ä¸€æ¡æŒ‡ä»¤æ„å»ºä¸€å±‚, å› æ­¤æ¯ä¸€æ¡æŒ‡ä»¤çš„å†…å®¹, å°±æ˜¯æè¿°è¯¥å±‚åº”å½“å¦‚ä½•æ„å»º.\n1 FROM æŒ‡å®šåŸºç¡€é•œåƒ å‘½ä»¤æ ¼å¼\nFROM IMAGE[:TAG][@DIGEST] æˆ‘ä»¬å¯ä»¥ç”¨ä»»æ„å·²å­˜åœ¨çš„é•œåƒä¸ºåŸºç¡€æ„å»ºæˆ‘ä»¬çš„è‡ªå®šä¹‰é•œåƒ\næ¯”å¦‚:\nç³»ç»Ÿé•œåƒ: centos, ubuntu, debian, alpine åº”ç”¨é•œåƒ: nginx, redis, mongo, mysql, httpd è¿è¡Œç¯å¢ƒé•œåƒ: php, java, golang å·¥å…·é•œåƒ: busybox ç¤ºä¾‹\n# tag é»˜è®¤ä½¿ç”¨ latest FROM alpine # æŒ‡å®š tag FROM alpine:3.17.3 # æŒ‡å®š digest FROM alpine@sha256:b6ca290b6b4cdcca5b3db3ffa338ee0285c11744b4a6abaa9627746ee3291d8d # åŒæ—¶æŒ‡å®š tag å’Œ digest FROM alpine:3.17.3@sha256:b6ca290b6b4cdcca5b3db3ffa338ee0285c11744b4a6abaa9627746ee3291d8d é™¤äº†é€‰æ‹©ç°æœ‰é•œåƒä¸ºåŸºç¡€é•œåƒå¤–, Docker è¿˜å­˜åœ¨ä¸€ä¸ªç‰¹æ®Šçš„é•œåƒ, åä¸º scratch. è¿™ä¸ªé•œåƒæ— æ³•ä»åˆ«å¤„æ‹‰å–, å¯ä»¥ç†è§£ä¸ºæ˜¯ Docker è‡ª 1.5.0 ç‰ˆæœ¬å¼€å§‹çš„è‡ªå¸¦é•œåƒ, å®ƒä»…åŒ…å«ä¸€ä¸ªç©ºçš„æ–‡ä»¶ç³»ç»Ÿ.\nscratch é•œåƒä¸€èˆ¬ç”¨äºæ„å»ºåŸºç¡€é•œåƒ, æ¯”å¦‚å®˜æ–¹é•œåƒ Ubuntu\n2 COPY å¤åˆ¶æ–‡ä»¶ æ ¼å¼:\nCOPY [--chown=:] \u003cæºè·¯å¾„1\u003e [æºè·¯å¾„2] â€¦ \u003cç›®æ ‡è·¯å¾„\u003e COPY [--chown=:] [\"\u003cæºè·¯å¾„1\u003e\", \"[æºè·¯å¾„2]\", â€¦, \"\u003cç›®æ ‡è·¯å¾„\u003e\"] COPY æŒ‡ä»¤å°†ä»æ„å»ºä¸Šä¸‹æ–‡ç›®å½•ä¸­ \u003cæºè·¯å¾„\u003e çš„æ–‡ä»¶/ç›®å½•å¤åˆ¶åˆ°æ–°çš„é•œåƒå±‚å†…çš„ \u003cç›®æ ‡è·¯å¾„\u003e ä½ç½®\n\u003cæºè·¯å¾„\u003e å¯ä»¥æ˜¯å¤šä¸ª, ç”šè‡³å¯ä»¥æ˜¯é€šé…ç¬¦, å…¶é€šé…ç¬¦è§„åˆ™è¦æ»¡è¶³ Go çš„ filepath.Match è§„åˆ™\nCOPY hom* /mydir/ COPY hom?.txt /mydir/ ç›®æ ‡è·¯å¾„ å¯ä»¥æ˜¯å®¹å™¨å†…çš„ç»å¯¹è·¯å¾„, ä¹Ÿå¯ä»¥æ˜¯ç›¸å¯¹äºå·¥ä½œç›®å½•çš„ç›¸å¯¹è·¯å¾„ (å·¥ä½œç›®å½•å¯ä»¥ç”¨ WORKDIR æŒ‡ä»¤æ¥æŒ‡å®š), ç›®æ ‡è·¯å¾„ä¸éœ€è¦äº‹å…ˆåˆ›å»º, å¦‚æœç›®å½•ä¸å­˜åœ¨ä¼šåœ¨å¤åˆ¶æ–‡ä»¶å‰å…ˆè¡Œåˆ›å»ºç¼ºå¤±ç›®å½•\næ­¤å¤–, è¿˜éœ€è¦æ³¨æ„ä¸€ç‚¹, ä½¿ç”¨ COPY æŒ‡ä»¤, æºæ–‡ä»¶çš„å„ç§å…ƒæ•°æ®éƒ½ä¼šä¿ç•™. æ¯”å¦‚è¯»ã€å†™ã€æ‰§è¡Œæƒé™ã€æ–‡ä»¶å˜æ›´æ—¶é—´ç­‰. è¿™ä¸ªç‰¹æ€§å¯¹äºé•œåƒå®šåˆ¶å¾ˆæœ‰ç”¨. ç‰¹åˆ«æ˜¯æ„å»ºç›¸å…³æ–‡ä»¶éƒ½åœ¨ä½¿ç”¨ Git è¿›è¡Œç®¡ç†çš„æ—¶å€™\nåœ¨ä½¿ç”¨è¯¥æŒ‡ä»¤çš„æ—¶å€™è¿˜å¯ä»¥åŠ ä¸Š --chown=: é€‰é¡¹æ¥æ”¹å˜æ–‡ä»¶çš„æ‰€å±ç”¨æˆ·åŠæ‰€å±ç»„.\nCOPY --chown=55:mygroup files* /mydir/ COPY --chown=bin files* /mydir/ COPY --chown=1 files* /mydir/ COPY --chown=10:11 files* /mydir/ 3 ADD æ›´é«˜çº§çš„å¤åˆ¶æ–‡ä»¶ ADD æŒ‡ä»¤å’Œ COPY çš„æ ¼å¼å’Œæ€§è´¨åŸºæœ¬ä¸€è‡´. åŒæ ·æ”¯æŒ --chown=: æŒ‡ä»¤ä¿®æ”¹å±ä¸»å’Œå±ç»„.\nä½†æ˜¯åœ¨ COPY åŸºç¡€ä¸Šå¢åŠ äº†ä¸€äº›åŠŸèƒ½:\n\u003cæºè·¯å¾„\u003e å¯ä»¥æ˜¯ä¸€ä¸ª URL, è¿™ç§æƒ…å†µä¸‹, Docker å¼•æ“ä¼šè¯•å›¾å»ä¸‹è½½è¿™ä¸ªé“¾æ¥çš„æ–‡ä»¶æ”¾åˆ° \u003cç›®æ ‡è·¯å¾„\u003e å». ä¸‹è½½åçš„æ–‡ä»¶æƒé™è‡ªåŠ¨è®¾ç½®ä¸º 600, å¦‚æœè¿™å¹¶ä¸æ˜¯æƒ³è¦çš„æƒé™, é‚£ä¹ˆè¿˜éœ€è¦å¢åŠ é¢å¤–çš„ä¸€å±‚ RUN è¿›è¡Œæƒé™è°ƒæ•´. å¦‚æœ \u003cæºè·¯å¾„\u003e ä¸ºä¸€ä¸ª tar å‹ç¼©æ–‡ä»¶çš„è¯, å‹ç¼©æ ¼å¼ä¸º gzip, bzip2 ä»¥åŠ xz çš„æƒ…å†µä¸‹, ADD æŒ‡ä»¤å°†ä¼šè‡ªåŠ¨è§£å‹ç¼©è¿™ä¸ªå‹ç¼©æ–‡ä»¶åˆ° \u003cç›®æ ‡è·¯å¾„\u003e å». Docker å®˜æ–¹è¦æ±‚å°½å¯èƒ½çš„ä½¿ç”¨ COPY, å› ä¸º COPY çš„è¯­ä¹‰å¾ˆæ˜ç¡®, å°±æ˜¯å¤åˆ¶æ–‡ä»¶è€Œå·², è€Œ ADD åˆ™åŒ…å«äº†æ›´å¤æ‚çš„åŠŸèƒ½, å…¶è¡Œä¸ºä¹Ÿä¸ä¸€å®šå¾ˆæ¸…æ™°. æœ€é€‚åˆä½¿ç”¨ ADD çš„åœºåˆ, å°±æ˜¯æ‰€æåŠçš„éœ€è¦è‡ªåŠ¨è§£å‹ç¼©çš„åœºåˆ.\nå¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯, ADD æŒ‡ä»¤ä¼šä»¤é•œåƒæ„å»ºç¼“å­˜å¤±æ•ˆ, ä»è€Œå¯èƒ½ä¼šä»¤é•œåƒæ„å»ºå˜å¾—æ¯”è¾ƒç¼“æ…¢.\n4 RUN æ‰§è¡Œå‘½ä»¤ æ ¼å¼:\nshell æ ¼å¼:RUN [command] â€¦, ç­‰ä»·äºåœ¨ linux ä¸­æ‰§è¡Œ /bin/sh -c \"command parameter1 parameter2 â€¦\"\nRUN ls -l exec æ ¼å¼:RUN [\"command\", \"parameter1\", \"parameter2\"â€¦], ä¸ä¼šé€šè¿‡ shell æ‰§è¡Œ, æ‰€ä»¥åƒ $HOME è¿™æ ·çš„å˜é‡å°±æ— æ³•è·å–.\nRUN [\"ls\", \"-l\"] RUN [\"/bin/sh\", \"-c\", \"ls -l\"] # å¯ä»¥è·å–ç¯å¢ƒå˜é‡ RUN æŒ‡ä»¤ç”¨äºæŒ‡å®šæ„å»ºé•œåƒæ—¶æ‰§è¡Œçš„å‘½ä»¤, Dockerfile å…è®¸å¤šä¸ª RUN æŒ‡ä»¤, å¹¶ä¸”æ¯ä¸ª RUN æŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªé•œåƒå±‚.\nRUN æŒ‡ä»¤ä¸€èˆ¬ç”¨äºå®‰è£…é…ç½®è½¯ä»¶åŒ…ç­‰æ“ä½œ, ä¸ºé¿å…é•œåƒå±‚æ•°è¿‡å¤š, ä¸€èˆ¬ RUN æŒ‡ä»¤ä½¿ç”¨ shell æ ¼å¼ä¸”ä½¿ç”¨æ¢è¡Œç¬¦æ¥æ‰§è¡Œå¤šä¸ªå‘½ä»¤, ä¸”å°½é‡å°† RUN æŒ‡ä»¤äº§ç”Ÿçš„é™„å±ç‰©åˆ é™¤ä»¥ç¼©å°é•œåƒå¤§å°\nå¦‚ä¸‹ç¤ºä¾‹\nFROM debian:stretch RUN set -x; buildDeps='gcc libc6-dev make wget' \\ \u0026\u0026 apt-get update \\ \u0026\u0026 apt-get install -y $buildDeps \\ \u0026\u0026 wget -O redis.tar.gz \"http://download.redis.io/releases/redis-5.0.3.tar.gz\" \\ \u0026\u0026 mkdir -p /usr/src/redis \\ \u0026\u0026 tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \\ \u0026\u0026 make -C /usr/src/redis \\ \u0026\u0026 make -C /usr/src/redis install \\ \u0026\u0026 rm -rf /var/lib/apt/lists/* \\ \u0026\u0026 rm redis.tar.gz \\ \u0026\u0026 rm -r /usr/src/redis \\ \u0026\u0026 apt-get purge -y --auto-remove $buildDeps 5 CMD å®¹å™¨å¯åŠ¨å‘½ä»¤ CMD æŒ‡ä»¤çš„æ ¼å¼å’Œ RUN ç›¸ä¼¼, ä¹Ÿæ˜¯ä¸¤ç§æ ¼å¼ï¼š\nshell æ ¼å¼ï¼šCMD [command] exec æ ¼å¼ï¼šCMD [\"command\", \"\", \"parameter2\", â€¦] å‚æ•°åˆ—è¡¨æ ¼å¼ï¼šCMD [\"å‚æ•°1\", \"å‚æ•°2\"â€¦]. åœ¨æŒ‡å®šäº† ENTRYPOINT æŒ‡ä»¤å, ç”¨ CMD æŒ‡å®šå…·ä½“çš„å‚æ•°. CMD æŒ‡ä»¤ç”¨äºè®¾ç½®å®¹å™¨å¯åŠ¨æ—¶ é»˜è®¤æ‰§è¡Œ çš„æŒ‡ä»¤, ä¸€èˆ¬ä¼šè®¾ç½®ä¸ºåº”ç”¨ç¨‹åºçš„å¯åŠ¨è„šæœ¬æˆ–è€…å·¥å…·é•œåƒçš„ bash, è®¾ç½®äº†å¤šæ¡ CMD æŒ‡ä»¤æ—¶, åªæœ‰æœ€åä¸€æ¡ CMD ä¼šè¢«æ‰§è¡Œ.\nåœ¨è¿è¡Œæ—¶å¯ä»¥æŒ‡å®šæ–°çš„å‘½ä»¤æ¥æ›¿ä»£é•œåƒè®¾ç½®ä¸­çš„è¿™ä¸ªé»˜è®¤å‘½ä»¤, æ¯”å¦‚, ubuntu é•œåƒé»˜è®¤çš„ CMD æ˜¯ /bin/bash, å¦‚æœæˆ‘ä»¬ç›´æ¥ docker run -it ubuntu çš„è¯, ä¼šç›´æ¥è¿›å…¥ bash. æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨è¿è¡Œæ—¶æŒ‡å®šè¿è¡Œåˆ«çš„å‘½ä»¤, å¦‚ docker run -it ubuntu cat /etc/os-release. è¿™å°±æ˜¯ç”¨ cat /etc/os-release å‘½ä»¤æ›¿æ¢äº†é»˜è®¤çš„ /bin/bash å‘½ä»¤äº†, ä¼šè¾“å‡ºç³»ç»Ÿç‰ˆæœ¬ä¿¡æ¯.\nåœ¨æŒ‡ä»¤æ ¼å¼ä¸Š, ä¸€èˆ¬æ¨èä½¿ç”¨ exec æ ¼å¼, è¿™ç±»æ ¼å¼åœ¨è§£ææ—¶ä¼šè¢«è§£æä¸º JSON æ•°ç»„, å› æ­¤ä¸€å®šè¦ä½¿ç”¨åŒå¼•å· \", è€Œä¸è¦ä½¿ç”¨å•å¼•å·.\nä¾‹å¦‚ä¸€èˆ¬ nginx å®¹å™¨çš„ CMD æŒ‡ä»¤:\nCMD [\"nginx\", \"-g\", \"daemon off;\"] 6 ENTRYPOINT å…¥å£ç‚¹ ENTRYPOINT çš„æ ¼å¼å’Œ RUN æŒ‡ä»¤æ ¼å¼ä¸€æ ·, åˆ†ä¸º exec æ ¼å¼å’Œ shell æ ¼å¼.\nshell æ ¼å¼ï¼šENTRYPOINT [command] exec æ ¼å¼ï¼šENTRYPOINT [\"command\", \"\", \"\", â€¦] ENTRYPOINT çš„ç›®çš„å’Œ CMD ä¸€æ ·, éƒ½æ˜¯åœ¨æŒ‡å®šå®¹å™¨å¯åŠ¨ç¨‹åºåŠå‚æ•°. ENTRYPOINT åœ¨è¿è¡Œæ—¶ä¹Ÿå¯ä»¥æ›¿ä»£, ä¸è¿‡æ¯” CMD è¦ç•¥æ˜¾ç¹ç, éœ€è¦é€šè¿‡ docker run çš„å‚æ•° --entrypoint æ¥æŒ‡å®š.\nå½“æŒ‡å®šäº† ENTRYPOINT ä¸”ä½¿ç”¨çš„æ˜¯ exec æ ¼å¼æ—¶, CMD çš„å«ä¹‰å°±å‘ç”Ÿäº†æ”¹å˜, ä¸å†æ˜¯ç›´æ¥çš„è¿è¡Œå…¶å‘½ä»¤, è€Œæ˜¯å°† CMD çš„å†…å®¹ä½œä¸ºå‚æ•°ä¼ ç»™ ENTRYPOINT æŒ‡ä»¤, æ¢å¥è¯è¯´å®é™…æ‰§è¡Œæ—¶, å°†å˜ä¸ºï¼š\nENTRYPOINT [\"command\", \"\", \"\", \"CMD\"] ä»¥ä¸‹ç¤ºä¾‹å°†å±•ç¤º CMD æŒ‡ä»¤ä½œä¸ºå‚æ•°ä¼ ç»™ ENTRYPOINT çš„åœºæ™¯\nåœºæ™¯ä¸€ï¼šæˆ‘ä»¬è‡ªå·±æ„å»ºäº†ä¸€ä¸ªç”¨äºæŸ¥çœ‹å¤–ç½‘ ip å’Œå½’å±åœ°çš„é•œåƒ\nFROM alpine RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories \\ \u0026\u0026 apk --update add curl CMD [ \"-s\" ] ENTRYPOINT [ \"curl\", \"http://myip.ipip.net\" ] æ„å»º\ndocker build -t busybox-curl . ä»¥ä¸¤ç§æ–¹å¼è¿è¡Œ\n# å®¹å™¨ä¸­å®é™…æ‰§è¡Œçš„æŒ‡ä»¤ä¸º curl http://myip.ipip.net -s [root@lvbibir learn]# docker run -it --rm busybox-curl å½“å‰ IPï¼š101.201.150.47 æ¥è‡ªäºï¼šä¸­å›½ åŒ—äº¬ åŒ—äº¬ é˜¿é‡Œäº‘ # å®¹å™¨ä¸­å®é™…æ‰§è¡Œçš„æŒ‡ä»¤ä¸º curl http://myip.ipip.net -i [root@lvbibir learn]# docker run -it --rm busybox-curl -i HTTP/1.1 200 OK Date: Mon, 10 Apr 2023 03:21:59 GMT Content-Type: text/plain; charset=utf-8 Content-Length: 72 Connection: keep-alive Node: ipip-myip5 X-Cache: BYPASS X-Request-Id: e309720b9197e8b94cec18b409c69d1d Server: WAF Connection: close Accept-Ranges: bytes å½“å‰ IPï¼š101.201.150.47 æ¥è‡ªäºï¼šä¸­å›½ åŒ—äº¬ åŒ—äº¬ é˜¿é‡Œäº‘ åœºæ™¯äºŒï¼šåº”ç”¨è¿è¡Œå‰çš„å‡†å¤‡å·¥ä½œ\nå¯åŠ¨å®¹å™¨å°±æ˜¯å¯åŠ¨ä¸»è¿›ç¨‹, ä½†æœ‰äº›æ—¶å€™, å¯åŠ¨ä¸»è¿›ç¨‹å‰, éœ€è¦ä¸€äº›å‡†å¤‡å·¥ä½œ.\næ¯”å¦‚ mysql ç±»çš„æ•°æ®åº“, å¯èƒ½éœ€è¦ä¸€äº›æ•°æ®åº“é…ç½®ã€åˆå§‹åŒ–çš„å·¥ä½œ, è¿™äº›å·¥ä½œè¦åœ¨æœ€ç»ˆçš„ mysql æœåŠ¡å™¨è¿è¡Œä¹‹å‰è§£å†³.\næ­¤å¤–, å¯èƒ½å¸Œæœ›é¿å…ä½¿ç”¨ root ç”¨æˆ·å»å¯åŠ¨æœåŠ¡, ä»è€Œæé«˜å®‰å…¨æ€§, è€Œåœ¨å¯åŠ¨æœåŠ¡å‰è¿˜éœ€è¦ä»¥ root èº«ä»½æ‰§è¡Œä¸€äº›å¿…è¦çš„å‡†å¤‡å·¥ä½œ, æœ€ååˆ‡æ¢åˆ°æœåŠ¡ç”¨æˆ·èº«ä»½å¯åŠ¨æœåŠ¡. æˆ–è€…é™¤äº†æœåŠ¡å¤–, å…¶å®ƒå‘½ä»¤ä¾æ—§å¯ä»¥ä½¿ç”¨ root èº«ä»½æ‰§è¡Œ, æ–¹ä¾¿è°ƒè¯•ç­‰.\nè¿™äº›å‡†å¤‡å·¥ä½œæ˜¯å’Œå®¹å™¨ CMD æ— å…³çš„, æ— è®º CMD ä¸ºä»€ä¹ˆ, éƒ½éœ€è¦äº‹å…ˆè¿›è¡Œä¸€ä¸ªé¢„å¤„ç†çš„å·¥ä½œ. è¿™ç§æƒ…å†µä¸‹, å¯ä»¥å†™ä¸€ä¸ªè„šæœ¬, ç„¶åæ”¾å…¥ ENTRYPOINT ä¸­å»æ‰§è¡Œ, è€Œè¿™ä¸ªè„šæœ¬ä¼šå°†æ¥åˆ°çš„å‚æ•°ï¼ˆä¹Ÿå°±æ˜¯ ï¼‰ä½œä¸ºå‘½ä»¤, åœ¨è„šæœ¬æœ€åæ‰§è¡Œ. æ¯”å¦‚å®˜æ–¹é•œåƒ redis ä¸­å°±æ˜¯è¿™ä¹ˆåšçš„ï¼š\nFROM alpine:3.4 ... RUN addgroup -S redis \u0026\u0026 adduser -S -G redis redis ... ENTRYPOINT [\"docker-entrypoint.sh\"] EXPOSE 6379 CMD [ \"redis-server\" ] å¯ä»¥çœ‹åˆ°å…¶ä¸­ä¸ºäº† redis æœåŠ¡åˆ›å»ºäº† redis ç”¨æˆ·, å¹¶åœ¨æœ€åæŒ‡å®šäº† ENTRYPOINT ä¸º docker-entrypoint.sh è„šæœ¬ï¼š\n#!/bin/sh ... # allow the container to be started with `--user` if [ \"$1\" = 'redis-server' -a \"$(id -u)\" = '0' ]; then find . \\! -user redis -exec chown redis '{}' + exec gosu redis \"$0\" \"$@\" fi exec \"$@\" è¯¥è„šæœ¬çš„å†…å®¹å°±æ˜¯æ ¹æ® CMD çš„å†…å®¹æ¥åˆ¤æ–­, å¦‚æœæ˜¯ redis-server çš„è¯, åˆ™åˆ‡æ¢åˆ° redis ç”¨æˆ·èº«ä»½å¯åŠ¨æœåŠ¡å™¨, å¦åˆ™ä¾æ—§ä½¿ç”¨ root èº«ä»½æ‰§è¡Œ. æ¯”å¦‚ï¼š\n[root@lvbibir learn]# docker run -it redis id uid=0(root) gid=0(root) groups=0(root) 7 ENV è®¾ç½®ç¯å¢ƒå˜é‡ æ ¼å¼æœ‰ä¸¤ç§ï¼š\nENV ENV = =â€¦ ENV ç”¨äºè®¾ç½®ç¯å¢ƒå˜é‡, æ—¢å¯ä»¥åœ¨ Dockerfile ä¸­è°ƒç”¨, ä¹Ÿå¯ä»¥åœ¨æ„å»ºå®Œçš„å®¹å™¨è¿è¡Œæ—¶ä¸­ä½¿ç”¨.\næ”¯æŒçš„æŒ‡ä»¤ï¼š ADDã€COPYã€ENVã€EXPOSEã€FROMã€LABELã€USERã€WORKDIRã€VOLUMEã€STOPSIGNALã€ONBUILDã€RUN\nä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­æ¼”ç¤ºäº†å¦‚ä½•æ¢è¡Œ, ä»¥åŠå¯¹å«æœ‰ç©ºæ ¼çš„å€¼ç”¨åŒå¼•å·æ‹¬èµ·æ¥çš„åŠæ³•, è¿™å’Œ Shell ä¸‹çš„è¡Œä¸ºæ˜¯ä¸€è‡´çš„.\nENV VERSION=1.0 DEBUG=on \\ NAME=\"Happy Feet\" ç¤ºä¾‹\nFROM alpine ENV VERSION=1.0 \\ DEBUG=on \\ NAME=\"Happy Feet\" RUN echo \"name: ${NAME}\" \u003e /test \\ \u0026\u0026 echo \"version: ${VERSION}\" \u003e\u003e /test æ„å»º\n[root@lvbibir learn]# docker build -t demo-env . æ„å»ºæ—¶è°ƒç”¨äº†ç¯å¢ƒå˜é‡\n[root@lvbibir learn]# docker run -it --rm demo-env cat /test name: Happy Feet version: 1.0 æ„å»ºåçš„å®¹å™¨è¿è¡Œæ—¶ä¸­è°ƒç”¨, è¿™é‡Œéœ€è¦ä½¿ç”¨ /bin/sh -c çš„æ–¹å¼, ä¸ç„¶æ— æ³•è¯»å–å˜é‡. ä¸”å¯¹ $ è¿›è¡Œè½¬ä¹‰, ä¸ç„¶è¯»å–çš„å°†ä¼šæ˜¯å®¿ä¸»æœºçš„å˜é‡\n[root@lvbibir learn]# docker run -it --rm demo-env /bin/sh -c \"echo \\${DEBUG}\" on 8 ARG æ„å»ºå‚æ•° æ„å»ºå‚æ•°å’Œ ENV çš„æ•ˆæœä¸€æ ·, éƒ½æ˜¯è®¾ç½®ç¯å¢ƒå˜é‡. æ‰€ä¸åŒçš„æ˜¯, ARG æ‰€è®¾ç½®çš„æ„å»ºç¯å¢ƒçš„ç¯å¢ƒå˜é‡, åœ¨å°†æ¥å®¹å™¨è¿è¡Œæ—¶æ˜¯ä¸ä¼šå­˜åœ¨è¿™äº›ç¯å¢ƒå˜é‡çš„. ä½†æ˜¯ä¸è¦å› æ­¤å°±ä½¿ç”¨ ARG ä¿å­˜å¯†ç ä¹‹ç±»çš„ä¿¡æ¯, å› ä¸º docker history è¿˜æ˜¯å¯ä»¥çœ‹åˆ°æ‰€æœ‰å€¼çš„.\nDockerfile ä¸­çš„ ARG æŒ‡ä»¤æ˜¯å®šä¹‰å‚æ•°åç§°, ä»¥åŠå®šä¹‰å…¶é»˜è®¤å€¼. è¯¥é»˜è®¤å€¼å¯ä»¥åœ¨æ„å»ºå‘½ä»¤ docker build ä¸­ç”¨ --build-arg \u003cå‚æ•°å\u003e=\u003cå€¼\u003e æ¥è¦†ç›–.\nçµæ´»çš„ä½¿ç”¨ ARG æŒ‡ä»¤, èƒ½å¤Ÿåœ¨ä¸ä¿®æ”¹ Dockerfile çš„æƒ…å†µä¸‹, æ„å»ºå‡ºä¸åŒçš„é•œåƒ.\nARG æŒ‡ä»¤æœ‰ç”Ÿæ•ˆèŒƒå›´, å¦‚æœåœ¨ FROM æŒ‡ä»¤ä¹‹å‰æŒ‡å®š, é‚£ä¹ˆåªèƒ½ç”¨äº FROM æŒ‡ä»¤ä¸­, FROM æŒ‡ä»¤å¯ä»¥æ˜¯å¤šä¸ª\nARG DOCKER_USERNAME=library FROM ${DOCKER_USERNAME}/alpine RUN set -x ; echo ${DOCKER_USERNAME} ä½¿ç”¨ä¸Šè¿° Dockerfile ä¼šå‘ç°æ— æ³•è¾“å‡º ${DOCKER_USERNAME} å˜é‡çš„å€¼, è¦æƒ³æ­£å¸¸è¾“å‡º, ä½ å¿…é¡»åœ¨ FROM ä¹‹åå†æ¬¡æŒ‡å®š ARG, å¦‚ä¸‹ç¤ºä¾‹\n# åªåœ¨ FROM ä¸­ç”Ÿæ•ˆ ARG DOCKER_USERNAME=library FROM ${DOCKER_USERNAME}/alpine # è¦æƒ³åœ¨ FROM ä¹‹åä½¿ç”¨, å¿…é¡»å†æ¬¡æŒ‡å®š ARG DOCKER_USERNAME=library RUN set -x ; echo ${DOCKER_USERNAME} å¦‚ä¸‹ç¤ºä¾‹, å˜é‡å°†ä¼šåœ¨æ¯ä¸ª FROM æŒ‡ä»¤ä¸­ç”Ÿæ•ˆ\n# è¿™ä¸ªå˜é‡åœ¨æ¯ä¸ª FROM ä¸­éƒ½ç”Ÿæ•ˆ ARG DOCKER_USERNAME=library FROM ${DOCKER_USERNAME}/alpine RUN set -x ; echo 1 FROM ${DOCKER_USERNAME}/alpine RUN set -x ; echo 2 å¦‚ä¸‹ç¤ºä¾‹, å¯¹äºåœ¨å„ä¸ªé˜¶æ®µä¸­ä½¿ç”¨çš„å˜é‡éƒ½å¿…é¡»åœ¨æ¯ä¸ªé˜¶æ®µåˆ†åˆ«æŒ‡å®š\nARG DOCKER_USERNAME=library FROM ${DOCKER_USERNAME}/alpine # åœ¨FROM ä¹‹åä½¿ç”¨å˜é‡, å¿…é¡»åœ¨æ¯ä¸ªé˜¶æ®µåˆ†åˆ«æŒ‡å®š ARG DOCKER_USERNAME=library RUN set -x ; echo ${DOCKER_USERNAME} FROM ${DOCKER_USERNAME}/alpine # åœ¨FROM ä¹‹åä½¿ç”¨å˜é‡, å¿…é¡»åœ¨æ¯ä¸ªé˜¶æ®µåˆ†åˆ«æŒ‡å®š ARG DOCKER_USERNAME=library RUN set -x ; echo ${DOCKER_USERNAME} 9 VOLUME å®šä¹‰åŒ¿åå· æ ¼å¼ä¸ºï¼š\nVOLUME [\"\u003cè·¯å¾„1\u003e\", \"\u003cè·¯å¾„2\u003e\"â€¦] VOLUME \u003cè·¯å¾„\u003e å®¹å™¨è¿è¡Œæ—¶åº”è¯¥å°½é‡ä¿æŒå®¹å™¨å­˜å‚¨å±‚ä¸å‘ç”Ÿå†™æ“ä½œ, å¯¹äºæ•°æ®åº“ç±»éœ€è¦ä¿å­˜åŠ¨æ€æ•°æ®çš„åº”ç”¨, å…¶æ•°æ®åº“æ–‡ä»¶åº”è¯¥ä¿å­˜äºå· (volume) ä¸­.\nä¸ºäº†é˜²æ­¢è¿è¡Œæ—¶ç”¨æˆ·å¿˜è®°å°†åŠ¨æ€æ–‡ä»¶æ‰€ä¿å­˜ç›®å½•æŒ‚è½½ä¸ºå·, åœ¨ Dockerfile ä¸­, æˆ‘ä»¬å¯ä»¥äº‹å…ˆæŒ‡å®šæŸäº›ç›®å½•æŒ‚è½½ä¸ºåŒ¿åå·, è¿™æ ·åœ¨è¿è¡Œæ—¶å¦‚æœç”¨æˆ·ä¸æŒ‡å®šæŒ‚è½½, å…¶åº”ç”¨ä¹Ÿå¯ä»¥æ­£å¸¸è¿è¡Œ, ä¸ä¼šå‘å®¹å™¨å­˜å‚¨å±‚å†™å…¥å¤§é‡æ•°æ®, ä»è€Œä¿è¯äº†å®¹å™¨å­˜å‚¨å±‚çš„æ— çŠ¶æ€åŒ–.\nVOLUME åˆ›å»ºçš„åŒ¿åå·ä¼šæŒ‚è½½åˆ°ç³»ç»Ÿ /var/lib/docker/volumes//\u003c_VOLUME\u003e ç›®å½•ä¸‹, ä¸”ä¸ä¼šéšç€å®¹å™¨åˆ é™¤è€Œåˆ é™¤, éœ€è¦æ‰‹åŠ¨åˆ é™¤\nå¦‚ä¸‹ç¤ºä¾‹\nFROM alpine VOLUME /data æ„å»ºè¿è¡Œ\n[root@lvbibir learn]# docker build -t demo-volume . [root@lvbibir learn]# docker run -itd --name=demo-volume demo-volume [root@lvbibir learn]# docker exec -it demo-volume ls -ld /data drwxr-xr-x 2 root root 4096 Apr 10 05:24 /data æŸ¥çœ‹æŒ‚è½½ç›®å½•\n[root@lvbibir learn]# docker inspect --format='{{json .Mounts}}' demo-volume | python -m json.tool [ { \"Destination\": \"/data\", \"Driver\": \"local\", \"Mode\": \"\", \"Name\": \"49cf915dd297292e3d0e4b2c7a66ead6875cfb0dbd010de15189040ab1158b3b\", \"Propagation\": \"\", \"RW\": true, \"Source\": \"/var/lib/docker/volumes/49cf915dd297292e3d0e4b2c7a66ead6875cfb0dbd010de15189040ab1158b3b/_data\", \"Type\": \"volume\" } ] å¦‚ä¸‹ç¤ºä¾‹, è¿è¡Œå®¹å™¨æ—¶, å¯ä»¥æŒ‡å®š -v å‚æ•°å°†ç›®å½•æŒ‚è½½åˆ°æŒ‡å®šä½ç½®\n[root@lvbibir learn]# docker run -itd -v /mydata:/data --name demo-volume-2 demo-volume [root@lvbibir learn]# docker inspect --format='{{json .Mounts}}' demo-volume-2 | python -m json.tool [ { \"Destination\": \"/data\", \"Mode\": \"\", \"Propagation\": \"rprivate\", \"RW\": true, \"Source\": \"/mydata\", \"Type\": \"bind\" } ] 10 EXPOSE æš´éœ²ç«¯å£ æ ¼å¼ä¸º EXPOSE \u003cç«¯å£1\u003e [ç«¯å£2] â€¦\nEXPOSE æŒ‡ä»¤æ˜¯å£°æ˜å®¹å™¨è¿è¡Œæ—¶æä¾›æœåŠ¡çš„ç«¯å£, è¿™åªæ˜¯ä¸€ä¸ªå£°æ˜, åœ¨å®¹å™¨è¿è¡Œæ—¶å¹¶ä¸ä¼šå› ä¸ºè¿™ä¸ªå£°æ˜åº”ç”¨å°±ä¼šå¼€å¯è¿™ä¸ªç«¯å£çš„æœåŠ¡\nåœ¨ Dockerfile ä¸­å†™å…¥è¿™æ ·çš„å£°æ˜æœ‰ä¸¤ä¸ªå¥½å¤„ï¼š\nä¸€ä¸ªæ˜¯å¸®åŠ©é•œåƒä½¿ç”¨è€…ç†è§£è¿™ä¸ªé•œåƒæœåŠ¡çš„å®ˆæŠ¤ç«¯å£, ä»¥æ–¹ä¾¿é…ç½®æ˜ å°„ï¼› å¦ä¸€ä¸ªç”¨å¤„åˆ™æ˜¯åœ¨è¿è¡Œæ—¶ä½¿ç”¨éšæœºç«¯å£æ˜ å°„æ—¶, ä¹Ÿå°±æ˜¯ docker run -P æ—¶, ä¼šè‡ªåŠ¨éšæœºæ˜ å°„ EXPOSE çš„ç«¯å£. è¦å°† EXPOSE å’Œåœ¨è¿è¡Œæ—¶ä½¿ç”¨ -p \u003cå®¿ä¸»ç«¯å£\u003e:\u003cå®¹å™¨ç«¯å£\u003e åŒºåˆ†å¼€æ¥. -p, æ˜¯æ˜ å°„å®¿ä¸»ç«¯å£å’Œå®¹å™¨ç«¯å£, æ¢å¥è¯è¯´, å°±æ˜¯å°†å®¹å™¨çš„å¯¹åº”ç«¯å£æœåŠ¡å…¬å¼€ç»™å¤–ç•Œè®¿é—®, è€Œ EXPOSE ä»…ä»…æ˜¯å£°æ˜å®¹å™¨æ‰“ç®—ä½¿ç”¨ä»€ä¹ˆç«¯å£è€Œå·², å¹¶ä¸ä¼šè‡ªåŠ¨åœ¨å®¿ä¸»è¿›è¡Œç«¯å£æ˜ å°„.\n11 WORKDIR æŒ‡å®šå·¥ä½œç›®å½• æ ¼å¼ä¸º WORKDIR \u003cè·¯å¾„\u003e\nä½¿ç”¨ WORKDIR æŒ‡ä»¤å¯ä»¥æ¥æŒ‡å®šå·¥ä½œç›®å½•ï¼ˆæˆ–è€…ç§°ä¸ºå½“å‰ç›®å½•ï¼‰, ä»¥åå„å±‚çš„å½“å‰ç›®å½•å°±è¢«æ”¹ä¸ºæŒ‡å®šçš„ç›®å½•, å¦‚è¯¥ç›®å½•ä¸å­˜åœ¨, WORKDIR ä¼šå¸®ä½ å»ºç«‹ç›®å½•\nå¦‚ä¸‹ç¤ºä¾‹, æ˜¯ä¸€ä¸ªå¸¸è§çš„é”™è¯¯, world.txt æœ€ç»ˆä¼šåœ¨ /app ç›®å½•ä¸‹, è€Œä¸æ˜¯æœŸæœ›çš„ /app/demo ç›®å½•\nWORKDIR /app RUN mkdir demo \u0026\u0026 cd demo RUN echo \"hello\" \u003e world.txt ä¸Šè¿°éœ€æ±‚å¯ä»¥è¿›è¡Œå¦‚ä¸‹ä¼˜åŒ–, æ¨èä½¿ç”¨ç¬¬äºŒç§å†™æ³•\nWORKDIR /app/demo RUN echo \"hello\" \u003e world.txt # æˆ–è€… WORKDIR /app RUN mkdir demo \\ \u0026\u0026 echo \"hello\" \u003e demo/world.txt # æˆ–è€… WORKDIR /app RUN mkdir demo \\ \u0026\u0026 cd demo \\ \u0026\u0026 echo \"hello\" \u003e demo/world.txt å¦‚æœä½ çš„ WORKDIR æŒ‡ä»¤ä½¿ç”¨çš„ç›¸å¯¹è·¯å¾„, é‚£ä¹ˆæ‰€åˆ‡æ¢çš„è·¯å¾„ä¸ä¹‹å‰çš„ WORKDIR æœ‰å…³\nå¦‚ä¸‹ç¤ºä¾‹, pwd çš„è¾“å‡ºå°†ä¼šæ˜¯ /a/b/c\nWORKDIR /a WORKDIR b WORKDIR c RUN pwd 12 USER æŒ‡å®šå½“å‰ç”¨æˆ· æ ¼å¼ï¼šUSER \u003cç”¨æˆ·å\u003e[:\u003cç”¨æˆ·ç»„\u003e]\nUSER æŒ‡ä»¤å’Œ WORKDIR ç›¸ä¼¼, éƒ½æ˜¯æ”¹å˜ç¯å¢ƒçŠ¶æ€å¹¶å½±å“ä»¥åçš„å±‚. WORKDIR æ˜¯æ”¹å˜å·¥ä½œç›®å½•, USER åˆ™æ˜¯æ”¹å˜ä¹‹åå±‚çš„æ‰§è¡Œ RUN, CMD ä»¥åŠ ENTRYPOINT è¿™ç±»å‘½ä»¤çš„èº«ä»½.\næ³¨æ„, USER åªæ˜¯å¸®åŠ©ä½ åˆ‡æ¢åˆ°æŒ‡å®šç”¨æˆ·è€Œå·², è¿™ä¸ªç”¨æˆ·å¿…é¡»æ˜¯äº‹å…ˆå»ºç«‹å¥½çš„, å¦åˆ™æ— æ³•åˆ‡æ¢.\nRUN groupadd -r redis \u0026\u0026 useradd -r -g redis redis USER redis RUN [ \"redis-server\" ] å¦‚æœä»¥ root æ‰§è¡Œçš„è„šæœ¬, åœ¨æ‰§è¡ŒæœŸé—´å¸Œæœ›æ”¹å˜èº«ä»½, æ¯”å¦‚å¸Œæœ›ä»¥æŸä¸ªå·²ç»å»ºç«‹å¥½çš„ç”¨æˆ·æ¥è¿è¡ŒæŸä¸ªæœåŠ¡è¿›ç¨‹, ä¸è¦ä½¿ç”¨ su æˆ–è€… sudo, è¿™äº›éƒ½éœ€è¦æ¯”è¾ƒéº»çƒ¦çš„é…ç½®, è€Œä¸”åœ¨ TTY ç¼ºå¤±çš„ç¯å¢ƒä¸‹ç»å¸¸å‡ºé”™. å»ºè®®ä½¿ç”¨ gosu\nä¸è¿‡æ›´æ¨èçš„è¿˜æ˜¯ ä¸Šæ–‡ ä¸­æåˆ°è¿‡çš„é€šè¿‡ ENTRYPOINT è„šæœ¬çš„æ–¹å¼\nä½¿ç”¨ gosu ç¤ºä¾‹\n# å»ºç«‹ redis ç”¨æˆ·, å¹¶ä½¿ç”¨ gosu æ¢å¦ä¸€ä¸ªç”¨æˆ·æ‰§è¡Œå‘½ä»¤ RUN groupadd -r redis \u0026\u0026 useradd -r -g redis redis # ä¸‹è½½ gosu RUN wget -O /usr/local/bin/gosu \"https://github.com/tianon/gosu/releases/download/1.12/gosu-amd64\" \\ \u0026\u0026 chmod +x /usr/local/bin/gosu \\ \u0026\u0026 gosu nobody true # è®¾ç½® CMD, å¹¶ä»¥å¦å¤–çš„ç”¨æˆ·æ‰§è¡Œ CMD [ \"exec\", \"gosu\", \"redis\", \"redis-server\" ] 13 HEALTHCHECK å¥åº·æ£€æŸ¥ æ ¼å¼ï¼š\nHEALTHCHECK [é€‰é¡¹] CMD \u003cå‘½ä»¤\u003eï¼šè®¾ç½®æ£€æŸ¥å®¹å™¨å¥åº·çŠ¶å†µçš„å‘½ä»¤ HEALTHCHECK NONEï¼šå¦‚æœåŸºç¡€é•œåƒæœ‰å¥åº·æ£€æŸ¥æŒ‡ä»¤, ä½¿ç”¨è¿™è¡Œå¯ä»¥å±è”½æ‰å…¶å¥åº·æ£€æŸ¥æŒ‡ä»¤ HEALTHCHECK æŒ‡ä»¤æ˜¯å‘Šè¯‰ Docker åº”è¯¥å¦‚ä½•è¿›è¡Œåˆ¤æ–­å®¹å™¨çš„çŠ¶æ€æ˜¯å¦æ­£å¸¸, è¿™æ˜¯ Docker 1.12 å¼•å…¥çš„æ–°æŒ‡ä»¤.\nåœ¨æ²¡æœ‰ HEALTHCHECK æŒ‡ä»¤å‰, Docker å¼•æ“åªå¯ä»¥é€šè¿‡å®¹å™¨å†…ä¸»è¿›ç¨‹æ˜¯å¦é€€å‡ºæ¥åˆ¤æ–­å®¹å™¨æ˜¯å¦çŠ¶æ€å¼‚å¸¸. å¾ˆå¤šæƒ…å†µä¸‹è¿™æ²¡é—®é¢˜, ä½†æ˜¯å¦‚æœç¨‹åºè¿›å…¥æ­»é”çŠ¶æ€, æˆ–è€…æ­»å¾ªç¯çŠ¶æ€, åº”ç”¨è¿›ç¨‹å¹¶ä¸é€€å‡º, ä½†æ˜¯è¯¥å®¹å™¨å·²ç»æ— æ³•æä¾›æœåŠ¡äº†. åœ¨ 1.12 ä»¥å‰, Docker ä¸ä¼šæ£€æµ‹åˆ°å®¹å™¨çš„è¿™ç§çŠ¶æ€, ä»è€Œä¸ä¼šé‡æ–°è°ƒåº¦, å¯¼è‡´å¯èƒ½ä¼šæœ‰éƒ¨åˆ†å®¹å™¨å·²ç»æ— æ³•æä¾›æœåŠ¡äº†å´è¿˜åœ¨æ¥å—ç”¨æˆ·è¯·æ±‚.\nHEALTHCHECK æ”¯æŒä¸‹åˆ—é€‰é¡¹ï¼š\n--interval=\u003cé—´éš”\u003eï¼šä¸¤æ¬¡å¥åº·æ£€æŸ¥çš„é—´éš”, é»˜è®¤ä¸º 30 ç§’ï¼› --timeout=\u003cæ—¶é•¿\u003eï¼šå¥åº·æ£€æŸ¥å‘½ä»¤è¿è¡Œè¶…æ—¶æ—¶é—´, å¦‚æœè¶…è¿‡è¿™ä¸ªæ—¶é—´, æœ¬æ¬¡å¥åº·æ£€æŸ¥å°±è¢«è§†ä¸ºå¤±è´¥, é»˜è®¤ 30 ç§’ï¼› --retries=\u003cæ¬¡æ•°\u003eï¼šå½“è¿ç»­å¤±è´¥æŒ‡å®šæ¬¡æ•°å, åˆ™å°†å®¹å™¨çŠ¶æ€è§†ä¸º unhealthy, é»˜è®¤ 3 æ¬¡. å’Œ CMD, ENTRYPOINT ä¸€æ ·, HEALTHCHECK åªå¯ä»¥å‡ºç°ä¸€æ¬¡, å¦‚æœå†™äº†å¤šä¸ª, åªæœ‰æœ€åä¸€ä¸ªç”Ÿæ•ˆ.\nåœ¨ HEALTHCHECK [é€‰é¡¹] CMD åé¢çš„å‘½ä»¤, æ ¼å¼å’Œ ENTRYPOINT ä¸€æ ·, åˆ†ä¸º shell æ ¼å¼, å’Œ exec æ ¼å¼. å‘½ä»¤çš„è¿”å›å€¼å†³å®šäº†è¯¥æ¬¡å¥åº·æ£€æŸ¥çš„æˆåŠŸä¸å¦ï¼š\n0ï¼šæˆåŠŸï¼› 1ï¼šå¤±è´¥ï¼› 2ï¼šä¿ç•™, ä¸è¦ä½¿ç”¨è¿™ä¸ªå€¼. å¦‚ä¸‹ç¤ºä¾‹, å‡è®¾æˆ‘ä»¬æœ‰ä¸ªé•œåƒæ˜¯ä¸ªæœ€ç®€å•çš„ Web æœåŠ¡, æˆ‘ä»¬å¸Œæœ›å¢åŠ å¥åº·æ£€æŸ¥æ¥åˆ¤æ–­å…¶ Web æœåŠ¡æ˜¯å¦åœ¨æ­£å¸¸å·¥ä½œ, æˆ‘ä»¬å¯ä»¥ç”¨ curl æ¥å¸®åŠ©åˆ¤æ–­\nFROM nginx HEALTHCHECK --interval=5s --timeout=3s --retries=3\\ CMD curl -fs http://localhost/ || exit 1 æ„å»ºè¿è¡Œ\n[root@lvbibir learn]# docker build -t myweb . [root@lvbibir learn]# docker run -d --name demo-myweb -p 800:80 myweb # æ­¤æ—¶æ˜¯ starting çŠ¶æ€ [root@lvbibir learn]# docker ps | grep myweb e6f585df60a6 myweb \"/docker-entrypoint.â€¦\" About a minute ago Up 2 seconds (health: starting) 0.0.0.0:800-\u003e80/tcp demo-myweb # ç­‰å¾…å‡ ç§’å˜ä¸º healthy çŠ¶æ€ [root@lvbibir learn]# docker ps | grep myweb e6f585df60a6 myweb \"/docker-entrypoint.â€¦\" 2 minutes ago Up About a minute (healthy) 0.0.0.0:800-\u003e80/tcp demo-myweb åˆ é™¤ index.html æ–‡ä»¶æ¨¡æ‹Ÿæ•…éšœ\n[root@lvbibir learn]# docker exec -it demo-myweb rm -f /usr/share/nginx/html/index.html # çŠ¶æ€å˜ä¸ºunhealthy [root@lvbibir learn]# docker ps | grep myweb e6f585df60a6 myweb \"/docker-entrypoint.â€¦\" 6 minutes ago Up 5 minutes (unhealthy) 0.0.0.0:800-\u003e80/tcp demo-myweb ä¸ºäº†å¸®åŠ©æ’éšœ, å¥åº·æ£€æŸ¥å‘½ä»¤çš„è¾“å‡ºï¼ˆåŒ…æ‹¬ stdout ä»¥åŠ stderrï¼‰éƒ½ä¼šè¢«å­˜å‚¨äºå¥åº·çŠ¶æ€é‡Œ, å¯ä»¥ç”¨ docker inspect æ¥æŸ¥çœ‹.\n[root@lvbibir learn]# docker inspect --format '{{json .State.Health}}' demo-myweb | python -m json.tool { \"FailingStreak\": 25, \"Log\": [ { \"End\": \"2023-04-10T14:41:51.393698555+08:00\", \"ExitCode\": 1, \"Output\": \"\", \"Start\": \"2023-04-10T14:41:51.285647058+08:00\" }, { \"End\": \"2023-04-10T14:41:56.504282619+08:00\", \"ExitCode\": 1, \"Output\": \"\", \"Start\": \"2023-04-10T14:41:56.401745529+08:00\" }, ........... ], \"Status\": \"unhealthy\" } æ¢å¤æ–‡ä»¶\n[root@lvbibir learn]# docker exec -it demo-myweb /bin/bash root@e6f585df60a6:/# echo test \u003e /usr/share/nginx/html/index.html root@e6f585df60a6:/# exit [root@lvbibir learn]# docker inspect --format '{{json .State.Health}}' demo-myweb | python -m json.tool { \"FailingStreak\": 0, \"Log\": [ { \"End\": \"2023-04-10T14:48:30.482498808+08:00\", \"ExitCode\": 0, \"Output\": \"test\\n\", \"Start\": \"2023-04-10T14:48:30.378197999+08:00\" }, { \"End\": \"2023-04-10T14:48:35.599150547+08:00\", \"ExitCode\": 0, \"Output\": \"test\\n\", \"Start\": \"2023-04-10T14:48:35.490433323+08:00\" }, ....... ], \"Status\": \"healthy\" } 14 ONBUILD ä¸ºä»–äººä½œå«è¡£è£³ æ ¼å¼ï¼šONBUILD \u003cå…¶å®ƒæŒ‡ä»¤\u003e.\nONBUILD æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æŒ‡ä»¤, å®ƒåé¢è·Ÿçš„æ˜¯å…¶å®ƒæŒ‡ä»¤, æ¯”å¦‚ RUN, COPY ç­‰, è€Œè¿™äº›æŒ‡ä»¤, åœ¨å½“å‰é•œåƒæ„å»ºæ—¶å¹¶ä¸ä¼šè¢«æ‰§è¡Œ. åªæœ‰å½“ä»¥å½“å‰é•œåƒä¸ºåŸºç¡€é•œåƒ, å»æ„å»ºä¸‹ä¸€çº§é•œåƒçš„æ—¶å€™æ‰ä¼šè¢«æ‰§è¡Œ.\nDockerfile ä¸­çš„å…¶å®ƒæŒ‡ä»¤éƒ½æ˜¯ä¸ºäº†å®šåˆ¶å½“å‰é•œåƒè€Œå‡†å¤‡çš„, å”¯æœ‰ ONBUILD æ˜¯ä¸ºäº†å¸®åŠ©åˆ«äººå®šåˆ¶è‡ªå·±è€Œå‡†å¤‡çš„.\nå‡è®¾æˆ‘ä»¬è¦åˆ¶ä½œ Node.js æ‰€å†™çš„åº”ç”¨çš„é•œåƒ. æˆ‘ä»¬éƒ½çŸ¥é“ Node.js ä½¿ç”¨ npm è¿›è¡ŒåŒ…ç®¡ç†, æ‰€æœ‰ä¾èµ–ã€é…ç½®ã€å¯åŠ¨ä¿¡æ¯ç­‰ä¼šæ”¾åˆ° package.json æ–‡ä»¶é‡Œ. åœ¨æ‹¿åˆ°ç¨‹åºä»£ç å, éœ€è¦å…ˆè¿›è¡Œ npm install æ‰å¯ä»¥è·å¾—æ‰€æœ‰éœ€è¦çš„ä¾èµ–. ç„¶åå°±å¯ä»¥é€šè¿‡ npm start æ¥å¯åŠ¨åº”ç”¨. å› æ­¤, ä¸€èˆ¬æ¥è¯´ä¼šè¿™æ ·å†™ Dockerfileï¼š\nFROM node:slim WORKDIR /app COPY ./package.json /app RUN [ \"npm\", \"install\" ] COPY . /app/ CMD [ \"npm\", \"start\" ] æŠŠè¿™ä¸ª Dockerfile æ”¾åˆ° Node.js é¡¹ç›®çš„æ ¹ç›®å½•, æ„å»ºå¥½é•œåƒå, å°±å¯ä»¥ç›´æ¥æ‹¿æ¥å¯åŠ¨å®¹å™¨è¿è¡Œ. ä½†æ˜¯å¦‚æœæˆ‘ä»¬è¿˜æœ‰ç¬¬äºŒä¸ª Node.js é¡¹ç›®ä¹Ÿå·®ä¸å¤šå‘¢ï¼Ÿå¥½å§, é‚£å°±å†æŠŠè¿™ä¸ª Dockerfile å¤åˆ¶åˆ°ç¬¬äºŒä¸ªé¡¹ç›®é‡Œ. é‚£å¦‚æœæœ‰ç¬¬ä¸‰ä¸ªé¡¹ç›®å‘¢ï¼Ÿå†å¤åˆ¶ä¹ˆï¼Ÿæ–‡ä»¶çš„å‰¯æœ¬è¶Šå¤š, ç‰ˆæœ¬æ§åˆ¶å°±è¶Šå›°éš¾, è®©æˆ‘ä»¬ç»§ç»­çœ‹è¿™æ ·çš„åœºæ™¯ç»´æŠ¤çš„é—®é¢˜.\nå¦‚æœç¬¬ä¸€ä¸ª Node.js é¡¹ç›®åœ¨å¼€å‘è¿‡ç¨‹ä¸­, å‘ç°è¿™ä¸ª Dockerfile é‡Œå­˜åœ¨é—®é¢˜, æ¯”å¦‚æ•²é”™å­—äº†ã€æˆ–è€…éœ€è¦å®‰è£…é¢å¤–çš„åŒ…, ç„¶åå¼€å‘äººå‘˜ä¿®å¤äº†è¿™ä¸ª Dockerfile, å†æ¬¡æ„å»º, é—®é¢˜è§£å†³. ç¬¬ä¸€ä¸ªé¡¹ç›®æ²¡é—®é¢˜äº†, ä½†æ˜¯ç¬¬äºŒä¸ªé¡¹ç›®å‘¢ï¼Ÿè™½ç„¶æœ€åˆ Dockerfile æ˜¯å¤åˆ¶ã€ç²˜è´´è‡ªç¬¬ä¸€ä¸ªé¡¹ç›®çš„, ä½†æ˜¯å¹¶ä¸ä¼šå› ä¸ºç¬¬ä¸€ä¸ªé¡¹ç›®ä¿®å¤äº†ä»–ä»¬çš„ Dockerfile, è€Œç¬¬äºŒä¸ªé¡¹ç›®çš„ Dockerfile å°±ä¼šè¢«è‡ªåŠ¨ä¿®å¤.\né‚£ä¹ˆæˆ‘ä»¬å¯ä¸å¯ä»¥åšä¸€ä¸ªåŸºç¡€é•œåƒ, ç„¶åå„ä¸ªé¡¹ç›®ä½¿ç”¨è¿™ä¸ªåŸºç¡€é•œåƒå‘¢ï¼Ÿè¿™æ ·åŸºç¡€é•œåƒæ›´æ–°, å„ä¸ªé¡¹ç›®ä¸ç”¨åŒæ­¥ Dockerfile çš„å˜åŒ–, é‡æ–°æ„å»ºåå°±ç»§æ‰¿äº†åŸºç¡€é•œåƒçš„æ›´æ–°ï¼Ÿå¥½å§, å¯ä»¥, è®©æˆ‘ä»¬çœ‹çœ‹è¿™æ ·çš„ç»“æœ.\nåŸºç¡€é•œåƒ (my-node) Dockerfile\nFROM node:slim WORKDIR /app CMD [ \"npm\", \"start\" ] åº”ç”¨é•œåƒ (my-app1) Dockerfile\nFROM my-node COPY ./package.json /app RUN [ \"npm\", \"install\" ] COPY . /app/ åŸºç¡€é•œåƒå˜åŒ–å, å„ä¸ªé¡¹ç›®éƒ½ç”¨è¿™ä¸ª Dockerfile é‡æ–°æ„å»ºé•œåƒ, ä¼šç»§æ‰¿åŸºç¡€é•œåƒçš„æ›´æ–°.\né‚£ä¹ˆ, é—®é¢˜è§£å†³äº†ä¹ˆï¼Ÿæ²¡æœ‰. å‡†ç¡®è¯´, åªè§£å†³äº†ä¸€åŠ. å¦‚æœè¿™ä¸ª Dockerfile é‡Œé¢æœ‰äº›ä¸œè¥¿éœ€è¦è°ƒæ•´å‘¢ï¼Ÿæ¯”å¦‚ npm install éƒ½éœ€è¦åŠ ä¸€äº›å‚æ•°, é‚£æ€ä¹ˆåŠï¼Ÿè¿™ä¸€è¡Œ RUN æ˜¯ä¸å¯èƒ½æ”¾å…¥åŸºç¡€é•œåƒçš„, å› ä¸ºæ¶‰åŠåˆ°äº†å½“å‰é¡¹ç›®çš„ ./package.json, éš¾é“åˆè¦ä¸€ä¸ªä¸ªä¿®æ”¹ä¹ˆï¼Ÿæ‰€ä»¥è¯´, è¿™æ ·åˆ¶ä½œåŸºç¡€é•œåƒ, åªè§£å†³äº†åŸæ¥çš„ Dockerfile çš„å‰ 4 æ¡æŒ‡ä»¤çš„å˜åŒ–é—®é¢˜, è€Œåé¢ä¸‰æ¡æŒ‡ä»¤çš„å˜åŒ–åˆ™å®Œå…¨æ²¡åŠæ³•å¤„ç†.\nONBUILD å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜. è®©æˆ‘ä»¬ç”¨ ONBUILD é‡æ–°å†™ä¸€ä¸‹åŸºç¡€é•œåƒçš„ Dockerfile:\nFROM node:slim WORKDIR /app ONBUILD COPY ./package.json /app ONBUILD RUN [ \"npm\", \"install\" ] ONBUILD COPY . /app/ CMD [ \"npm\", \"start\" ] åº”ç”¨é•œåƒ Dcokerfile\nFROM my-node æ˜¯çš„, åªæœ‰è¿™ä¹ˆä¸€è¡Œ. å½“åœ¨å„ä¸ªé¡¹ç›®ç›®å½•ä¸­, ç”¨è¿™ä¸ªåªæœ‰ä¸€è¡Œçš„ Dockerfile æ„å»ºé•œåƒæ—¶, ä¹‹å‰åŸºç¡€é•œåƒçš„é‚£ä¸‰è¡Œ ONBUILD å°±ä¼šå¼€å§‹æ‰§è¡Œ, æˆåŠŸçš„å°†å½“å‰é¡¹ç›®çš„ä»£ç å¤åˆ¶è¿›é•œåƒã€å¹¶ä¸”é’ˆå¯¹æœ¬é¡¹ç›®æ‰§è¡Œ npm install, ç”Ÿæˆåº”ç”¨é•œåƒ.\n15 LABEL ä¸ºé•œåƒæ·»åŠ å…ƒæ•°æ® LABEL æŒ‡ä»¤ç”¨æ¥ç»™é•œåƒä»¥é”®å€¼å¯¹çš„å½¢å¼æ·»åŠ ä¸€äº›å…ƒæ•°æ®ï¼ˆmetadataï¼‰.\nLABEL = = = ... æˆ‘ä»¬è¿˜å¯ä»¥ç”¨ä¸€äº›æ ‡ç­¾æ¥ç”³æ˜é•œåƒçš„ä½œè€…ã€æ–‡æ¡£åœ°å€ç­‰ï¼š\nLABEL org.opencontainers.image.authors=\"yeasy\" LABEL org.opencontainers.image.documentation=\"https://yeasy.gitbooks.io\" å…·ä½“å¯ä»¥å‚è€ƒ https://github.com/opencontainers/image-spec/blob/master/annotations.md\n16 SHELL æŒ‡å®š shell æ ¼å¼ï¼šSHELL [\"executable\", \"parameters\"]\nSHELL æŒ‡ä»¤å¯ä»¥æŒ‡å®š RUN ENTRYPOINT CMD æŒ‡ä»¤çš„ shell, Linux ä¸­é»˜è®¤ä¸º `[\"/bin/sh\", â€œ-câ€]\nå¦‚ä¸‹ç¤ºä¾‹, ä¸¤ä¸ª RUN è¿è¡ŒåŒä¸€å‘½ä»¤, ç¬¬äºŒä¸ª RUN è¿è¡Œçš„å‘½ä»¤ä¼šæ‰“å°å‡ºæ¯æ¡å‘½ä»¤å¹¶å½“é‡åˆ°é”™è¯¯æ—¶é€€å‡º.\nSHELL [\"/bin/sh\", \"-c\"] RUN lll ; ls SHELL [\"/bin/sh\", \"-cex\"] RUN lll ; ls å¦‚ä¸‹ç¤ºä¾‹, å½“ ENTRYPOINT CMD ä»¥ shell æ ¼å¼æŒ‡å®šæ—¶, SHELL æŒ‡ä»¤æ‰€æŒ‡å®šçš„ shell ä¹Ÿä¼šæˆä¸ºè¿™ä¸¤ä¸ªæŒ‡ä»¤çš„ shell\nSHELL [\"/bin/sh\", \"-cex\"] # /bin/sh -cex \"nginx\" ENTRYPOINT nginx # /bin/sh -cex \"nginx\" CMD nginx ä»¥ä¸Š\n","wordCount":"6968","inLanguage":"en","image":"https://image.lvbibir.cn/blog/docker.png","datePublished":"2023-04-09T00:00:00Z","dateModified":"2024-01-27T00:00:00Z","author":{"@type":"Person","name":"lvbibir"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.lvbibir.cn/posts/tech/docker-dockerfile-instruction/"},"publisher":{"@type":"Organization","name":"lvbibir's Blog","logo":{"@type":"ImageObject","url":"https://image.lvbibir.cn/blog/avatar.webp"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://www.lvbibir.cn accesskey=h title="lvbibir's Blog (Alt + H)"><img src=https://image.lvbibir.cn/blog/avatar.webp alt aria-label=logo height=35>lvbibir's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li class=menu-item><a href=https://www.lvbibir.cn/search title="ğŸ” æœç´¢ (Alt + /)" accesskey=/><span>ğŸ” æœç´¢</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/posts title="ğŸ“š æ–‡ç« "><span>ğŸ“š æ–‡ç« </span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/archives title="ğŸ“ˆ å½’æ¡£"><span>ğŸ“ˆ å½’æ¡£</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/talk title="ğŸ’¬ è¯´è¯´"><span>ğŸ’¬ è¯´è¯´</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/links title="ğŸ¤ å‹é“¾"><span>ğŸ¤ å‹é“¾</span></a></li></ul></nav></header><main class="main page"><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://www.lvbibir.cn>ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://www.lvbibir.cn/posts/>ğŸ“š æ–‡ç« </a>&nbsp;Â»&nbsp;<a href=https://www.lvbibir.cn/posts/tech/>ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a></div><h1 class=post-title>docker | dockerfile æŒ‡ä»¤è¯¦è§£</h1><div class=post-meta>åˆ›å»º:&nbsp;<span title='2023-04-09 00:00:00 +0000 UTC'>2023-04-09</span>&nbsp;|&nbsp;æ›´æ–°:&nbsp;2024-01-27&nbsp;|&nbsp;å­—æ•°:&nbsp;6968å­—&nbsp;|&nbsp;ä½œè€…:&nbsp;lvbibir
|&nbsp;æ ‡ç­¾:&nbsp;<ul class=post-tags-meta><a href=https://www.lvbibir.cn/tags/docker/>docker</a></ul><span id=busuanzi_container_page_pv>&nbsp;|&nbsp;è®¿é—®:&nbsp;<span id=busuanzi_page_pv></span></span></div></header><button id=toc-toggle-btn class=toc-toggle-btn aria-label="Toggle Table of Contents" title=æ–‡ç« ç›®å½•><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2zm0 4h14v-2H3v2zm0 4h14v-2H3v2zm16 0h2v-2h-2v2zm0-10v2h2V7h-2zm0 6h2v-2h-2v2z"/></svg></button><div id=toc-overlay class=toc-overlay></div><aside id=toc-container class="toc-container wide"><button id=toc-close-btn class=toc-close-btn aria-label="Close Table of Contents"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>æ–‡ç« ç›®å½•</span></summary><div class=inner><ul><li><a href=#0-%e5%89%8d%e8%a8%80 aria-label="0 å‰è¨€">0 å‰è¨€</a></li><li><a href=#1-from-%e6%8c%87%e5%ae%9a%e5%9f%ba%e7%a1%80%e9%95%9c%e5%83%8f aria-label="1 FROM æŒ‡å®šåŸºç¡€é•œåƒ">1 FROM æŒ‡å®šåŸºç¡€é•œåƒ</a></li><li><a href=#2-copy-%e5%a4%8d%e5%88%b6%e6%96%87%e4%bb%b6 aria-label="2 COPY å¤åˆ¶æ–‡ä»¶">2 COPY å¤åˆ¶æ–‡ä»¶</a></li><li><a href=#3-add-%e6%9b%b4%e9%ab%98%e7%ba%a7%e7%9a%84%e5%a4%8d%e5%88%b6%e6%96%87%e4%bb%b6 aria-label="3 ADD æ›´é«˜çº§çš„å¤åˆ¶æ–‡ä»¶">3 ADD æ›´é«˜çº§çš„å¤åˆ¶æ–‡ä»¶</a></li><li><a href=#4-run-%e6%89%a7%e8%a1%8c%e5%91%bd%e4%bb%a4 aria-label="4 RUN æ‰§è¡Œå‘½ä»¤">4 RUN æ‰§è¡Œå‘½ä»¤</a></li><li><a href=#5-cmd-%e5%ae%b9%e5%99%a8%e5%90%af%e5%8a%a8%e5%91%bd%e4%bb%a4 aria-label="5 CMD å®¹å™¨å¯åŠ¨å‘½ä»¤">5 CMD å®¹å™¨å¯åŠ¨å‘½ä»¤</a></li><li><a href=#6-entrypoint-%e5%85%a5%e5%8f%a3%e7%82%b9 aria-label="6 ENTRYPOINT å…¥å£ç‚¹">6 ENTRYPOINT å…¥å£ç‚¹</a></li><li><a href=#7-env-%e8%ae%be%e7%bd%ae%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f aria-label="7 ENV è®¾ç½®ç¯å¢ƒå˜é‡">7 ENV è®¾ç½®ç¯å¢ƒå˜é‡</a></li><li><a href=#8-arg-%e6%9e%84%e5%bb%ba%e5%8f%82%e6%95%b0 aria-label="8 ARG æ„å»ºå‚æ•°">8 ARG æ„å»ºå‚æ•°</a></li><li><a href=#9-volume-%e5%ae%9a%e4%b9%89%e5%8c%bf%e5%90%8d%e5%8d%b7 aria-label="9 VOLUME å®šä¹‰åŒ¿åå·">9 VOLUME å®šä¹‰åŒ¿åå·</a></li><li><a href=#10-expose-%e6%9a%b4%e9%9c%b2%e7%ab%af%e5%8f%a3 aria-label="10 EXPOSE æš´éœ²ç«¯å£">10 EXPOSE æš´éœ²ç«¯å£</a></li><li><a href=#11-workdir-%e6%8c%87%e5%ae%9a%e5%b7%a5%e4%bd%9c%e7%9b%ae%e5%bd%95 aria-label="11 WORKDIR æŒ‡å®šå·¥ä½œç›®å½•">11 WORKDIR æŒ‡å®šå·¥ä½œç›®å½•</a></li><li><a href=#12-user-%e6%8c%87%e5%ae%9a%e5%bd%93%e5%89%8d%e7%94%a8%e6%88%b7 aria-label="12 USER æŒ‡å®šå½“å‰ç”¨æˆ·">12 USER æŒ‡å®šå½“å‰ç”¨æˆ·</a></li><li><a href=#13-healthcheck-%e5%81%a5%e5%ba%b7%e6%a3%80%e6%9f%a5 aria-label="13 HEALTHCHECK å¥åº·æ£€æŸ¥">13 HEALTHCHECK å¥åº·æ£€æŸ¥</a></li><li><a href=#14-onbuild-%e4%b8%ba%e4%bb%96%e4%ba%ba%e4%bd%9c%e5%ab%81%e8%a1%a3%e8%a3%b3 aria-label="14 ONBUILD ä¸ºä»–äººä½œå«è¡£è£³">14 ONBUILD ä¸ºä»–äººä½œå«è¡£è£³</a></li><li><a href=#15-label-%e4%b8%ba%e9%95%9c%e5%83%8f%e6%b7%bb%e5%8a%a0%e5%85%83%e6%95%b0%e6%8d%ae aria-label="15 LABEL ä¸ºé•œåƒæ·»åŠ å…ƒæ•°æ®">15 LABEL ä¸ºé•œåƒæ·»åŠ å…ƒæ•°æ®</a></li><li><a href=#16-shell-%e6%8c%87%e5%ae%9a-shell aria-label="16 SHELL æŒ‡å®š shell">16 SHELL æŒ‡å®š shell</a></li></ul></div></details></div></aside><script>let activeElement,elements;const tocContainer=document.getElementById("toc-container"),tocToggleBtn=document.getElementById("toc-toggle-btn"),tocCloseBtn=document.getElementById("toc-close-btn"),tocOverlay=document.getElementById("toc-overlay");window.addEventListener('DOMContentLoaded',function(){if(checkTocPosition(),elements=document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]'),elements.length>0){activeElement=elements[0];const t=encodeURI(activeElement.getAttribute('id')).toLowerCase(),e=document.querySelector(`.inner ul li a[href="#${t}"]`);e&&e.classList.add('active')}},!1),window.addEventListener('resize',function(){checkTocPosition()},!1),window.addEventListener('scroll',()=>{if(!elements||elements.length===0)return;activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(t=>{const n=encodeURI(t.getAttribute('id')).toLowerCase(),e=document.querySelector(`.inner ul li a[href="#${n}"]`);e&&(t===activeElement?e.classList.add('active'):e.classList.remove('active'))})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue('--gap'),10);let isWideMode=!1,isTocVisible=!0;function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?(isWideMode=!0,isTocVisible?(tocContainer.classList.add("wide"),tocContainer.classList.remove("collapsed"),tocContainer.classList.remove("mobile-popup"),tocToggleBtn.classList.add("active")):(tocContainer.classList.remove("wide"),tocContainer.classList.add("collapsed"),tocContainer.classList.remove("mobile-popup"),tocToggleBtn.classList.remove("active")),closeTocPopup()):(isWideMode=!1,tocContainer.classList.remove("wide"),tocContainer.classList.contains("mobile-popup")||tocContainer.classList.add("collapsed"),tocContainer.classList.contains("active")?tocToggleBtn.classList.add("active"):tocToggleBtn.classList.remove("active"))}function openTocPopup(){tocContainer.classList.remove("collapsed"),tocContainer.classList.add("mobile-popup"),tocContainer.classList.add("active"),tocOverlay.classList.add("active"),tocToggleBtn.classList.add("active"),document.body.style.overflow="hidden"}function closeTocPopup(){tocContainer.classList.remove("active"),tocOverlay.classList.remove("active"),document.body.style.overflow="",setTimeout(()=>{tocContainer.classList.contains("active")||(tocContainer.classList.remove("mobile-popup"),(!isWideMode||!isTocVisible)&&tocContainer.classList.add("collapsed"))},300)}function toggleToc(){isWideMode?(isTocVisible=!isTocVisible,isTocVisible?(tocContainer.classList.add("wide"),tocContainer.classList.remove("collapsed"),tocToggleBtn.classList.add("active")):(tocContainer.classList.remove("wide"),tocContainer.classList.add("collapsed"),tocToggleBtn.classList.remove("active"))):tocContainer.classList.contains("active")?(closeTocPopup(),tocToggleBtn.classList.remove("active")):openTocPopup()}tocToggleBtn.addEventListener('click',function(){toggleToc()}),tocCloseBtn.addEventListener('click',function(){closeTocPopup(),tocToggleBtn.classList.remove("active")}),tocOverlay.addEventListener('click',function(){closeTocPopup(),tocToggleBtn.classList.remove("active")}),tocContainer.querySelectorAll('.inner a').forEach(function(e){e.addEventListener('click',function(){tocContainer.classList.contains("mobile-popup")&&(closeTocPopup(),tocToggleBtn.classList.remove("active"))})}),document.addEventListener('keydown',function(e){e.key==='Escape'&&tocContainer.classList.contains("active")&&(closeTocPopup(),tocToggleBtn.classList.remove("active"))});function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=0-å‰è¨€>0 å‰è¨€<a hidden class=anchor aria-hidden=true href=#0-å‰è¨€>#</a></h2><p>æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥ï¼š</p><ul><li><a href=https://yeasy.gitbook.io/docker_practice/image/dockerfile target=_blank rel=noopener style=color:#42b983 ;>Dockerfile æŒ‡ä»¤è¯¦è§£</a></li></ul><p>Dockerfile ç”¨äºæ„å»º docker é•œåƒ, å®é™…ä¸Šå°±æ˜¯æŠŠåœ¨ linux ä¸‹çš„å‘½ä»¤æ“ä½œå†™åˆ°äº† Dockerfile ä¸­, é€šè¿‡ Dockerfile å»æ‰§è¡Œè®¾ç½®å¥½çš„æ“ä½œå‘½ä»¤, ä¿è¯é€šè¿‡ Dockerfile çš„æ„å»ºé•œåƒæ˜¯ä¸€è‡´çš„.</p><p>Dockerfile æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶, å…¶å†…åŒ…å«äº†ä¸€æ¡æ¡çš„æŒ‡ä»¤ (<code>Instruction</code>), æ¯ä¸€æ¡æŒ‡ä»¤æ„å»ºä¸€å±‚, å› æ­¤æ¯ä¸€æ¡æŒ‡ä»¤çš„å†…å®¹, å°±æ˜¯æè¿°è¯¥å±‚åº”å½“å¦‚ä½•æ„å»º.</p><h2 id=1-from-æŒ‡å®šåŸºç¡€é•œåƒ>1 FROM æŒ‡å®šåŸºç¡€é•œåƒ<a hidden class=anchor aria-hidden=true href=#1-from-æŒ‡å®šåŸºç¡€é•œåƒ>#</a></h2><p>å‘½ä»¤æ ¼å¼</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>FROM</span><span style=color:#48b685> IMAGE[:TAG][@DIGEST]</span><span style=color:#ef6155>
</span></span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥ç”¨ä»»æ„å·²å­˜åœ¨çš„é•œåƒä¸ºåŸºç¡€æ„å»ºæˆ‘ä»¬çš„è‡ªå®šä¹‰é•œåƒ</p><p>æ¯”å¦‚:</p><ul><li>ç³»ç»Ÿé•œåƒ: <code>centos</code>, <code>ubuntu</code>, <code>debian</code>, <code>alpine</code></li><li>åº”ç”¨é•œåƒ: <code>nginx</code>, <code>redis</code>, <code>mongo</code>, <code>mysql</code>, <code>httpd</code></li><li>è¿è¡Œç¯å¢ƒé•œåƒ: <code>php</code>, <code>java</code>, <code>golang</code></li><li>å·¥å…·é•œåƒ: <code>busybox</code></li></ul><p>ç¤ºä¾‹</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#776e71># tag é»˜è®¤ä½¿ç”¨ latest </span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>FROM</span><span style=color:#48b685> alpine</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#776e71># æŒ‡å®š tag</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>FROM</span><span style=color:#48b685> alpine:3.17.3</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#776e71># æŒ‡å®š digest</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>FROM</span><span style=color:#48b685> alpine@sha256:b6ca290b6b4cdcca5b3db3ffa338ee0285c11744b4a6abaa9627746ee3291d8d</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#776e71># åŒæ—¶æŒ‡å®š tag å’Œ digest</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>FROM</span><span style=color:#48b685> alpine:3.17.3@sha256:b6ca290b6b4cdcca5b3db3ffa338ee0285c11744b4a6abaa9627746ee3291d8d</span><span style=color:#ef6155>
</span></span></span></code></pre></div><p>é™¤äº†é€‰æ‹©ç°æœ‰é•œåƒä¸ºåŸºç¡€é•œåƒå¤–, Docker è¿˜å­˜åœ¨ä¸€ä¸ªç‰¹æ®Šçš„é•œåƒ, åä¸º <code>scratch</code>. è¿™ä¸ªé•œåƒæ— æ³•ä»åˆ«å¤„æ‹‰å–, å¯ä»¥ç†è§£ä¸ºæ˜¯ Docker è‡ª <a href=https://github.com/moby/moby/pull/8827 target=_blank rel=noopener style=color:#42b983 ;>1.5.0</a> ç‰ˆæœ¬å¼€å§‹çš„è‡ªå¸¦é•œåƒ, å®ƒä»…åŒ…å«ä¸€ä¸ªç©ºçš„æ–‡ä»¶ç³»ç»Ÿ.</p><p>scratch é•œåƒä¸€èˆ¬ç”¨äºæ„å»ºåŸºç¡€é•œåƒ, æ¯”å¦‚å®˜æ–¹é•œåƒ <code>Ubuntu</code></p><h2 id=2-copy-å¤åˆ¶æ–‡ä»¶>2 COPY å¤åˆ¶æ–‡ä»¶<a hidden class=anchor aria-hidden=true href=#2-copy-å¤åˆ¶æ–‡ä»¶>#</a></h2><p>æ ¼å¼:</p><ul><li><code>COPY [--chown=&lt;user>:&lt;group>] &lt;æºè·¯å¾„1> [æºè·¯å¾„2] â€¦ &lt;ç›®æ ‡è·¯å¾„></code></li><li><code>COPY [--chown=&lt;user>:&lt;group>] ["&lt;æºè·¯å¾„1>", "[æºè·¯å¾„2]", â€¦, "&lt;ç›®æ ‡è·¯å¾„>"]</code></li></ul><p><code>COPY</code> æŒ‡ä»¤å°†ä»æ„å»ºä¸Šä¸‹æ–‡ç›®å½•ä¸­ <code>&lt;æºè·¯å¾„></code> çš„æ–‡ä»¶/ç›®å½•å¤åˆ¶åˆ°æ–°çš„é•œåƒå±‚å†…çš„ <code>&lt;ç›®æ ‡è·¯å¾„></code> ä½ç½®</p><p><code>&lt;æºè·¯å¾„></code> å¯ä»¥æ˜¯å¤šä¸ª, ç”šè‡³å¯ä»¥æ˜¯é€šé…ç¬¦, å…¶é€šé…ç¬¦è§„åˆ™è¦æ»¡è¶³ Go çš„ <a href=https://golang.org/pkg/path/filepath/#Match target=_blank rel=noopener style=color:#42b983 ;>filepath.Match</a> è§„åˆ™</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>COPY</span> hom* /mydir/<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>COPY</span> hom?.txt /mydir/<span style=color:#ef6155>
</span></span></span></code></pre></div><p><code>ç›®æ ‡è·¯å¾„</code> å¯ä»¥æ˜¯å®¹å™¨å†…çš„ç»å¯¹è·¯å¾„, ä¹Ÿå¯ä»¥æ˜¯ç›¸å¯¹äºå·¥ä½œç›®å½•çš„ç›¸å¯¹è·¯å¾„ (å·¥ä½œç›®å½•å¯ä»¥ç”¨ <code>WORKDIR</code> æŒ‡ä»¤æ¥æŒ‡å®š), ç›®æ ‡è·¯å¾„ä¸éœ€è¦äº‹å…ˆåˆ›å»º, å¦‚æœç›®å½•ä¸å­˜åœ¨ä¼šåœ¨å¤åˆ¶æ–‡ä»¶å‰å…ˆè¡Œåˆ›å»ºç¼ºå¤±ç›®å½•</p><p>æ­¤å¤–, è¿˜éœ€è¦æ³¨æ„ä¸€ç‚¹, ä½¿ç”¨ <code>COPY</code> æŒ‡ä»¤, æºæ–‡ä»¶çš„å„ç§å…ƒæ•°æ®éƒ½ä¼šä¿ç•™. æ¯”å¦‚è¯»ã€å†™ã€æ‰§è¡Œæƒé™ã€æ–‡ä»¶å˜æ›´æ—¶é—´ç­‰. è¿™ä¸ªç‰¹æ€§å¯¹äºé•œåƒå®šåˆ¶å¾ˆæœ‰ç”¨. ç‰¹åˆ«æ˜¯æ„å»ºç›¸å…³æ–‡ä»¶éƒ½åœ¨ä½¿ç”¨ Git è¿›è¡Œç®¡ç†çš„æ—¶å€™</p><p>åœ¨ä½¿ç”¨è¯¥æŒ‡ä»¤çš„æ—¶å€™è¿˜å¯ä»¥åŠ ä¸Š <code>--chown=&lt;user>:&lt;group></code> é€‰é¡¹æ¥æ”¹å˜æ–‡ä»¶çš„æ‰€å±ç”¨æˆ·åŠæ‰€å±ç»„.</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>COPY</span> --chown<span style=color:#5bc4bf>=</span>55:mygroup files* /mydir/<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>COPY</span> --chown<span style=color:#5bc4bf>=</span>bin files* /mydir/<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>COPY</span> --chown<span style=color:#5bc4bf>=</span><span style=color:#f99b15>1</span> files* /mydir/<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>COPY</span> --chown<span style=color:#5bc4bf>=</span>10:11 files* /mydir/<span style=color:#ef6155>
</span></span></span></code></pre></div><h2 id=3-add-æ›´é«˜çº§çš„å¤åˆ¶æ–‡ä»¶>3 ADD æ›´é«˜çº§çš„å¤åˆ¶æ–‡ä»¶<a hidden class=anchor aria-hidden=true href=#3-add-æ›´é«˜çº§çš„å¤åˆ¶æ–‡ä»¶>#</a></h2><p><code>ADD</code> æŒ‡ä»¤å’Œ <code>COPY</code> çš„æ ¼å¼å’Œæ€§è´¨åŸºæœ¬ä¸€è‡´. åŒæ ·æ”¯æŒ <code>--chown=&lt;user>:&lt;group></code> æŒ‡ä»¤ä¿®æ”¹å±ä¸»å’Œå±ç»„.</p><p>ä½†æ˜¯åœ¨ <code>COPY</code> åŸºç¡€ä¸Šå¢åŠ äº†ä¸€äº›åŠŸèƒ½:</p><ul><li><code>&lt;æºè·¯å¾„></code> å¯ä»¥æ˜¯ä¸€ä¸ª <code>URL</code>, è¿™ç§æƒ…å†µä¸‹, Docker å¼•æ“ä¼šè¯•å›¾å»ä¸‹è½½è¿™ä¸ªé“¾æ¥çš„æ–‡ä»¶æ”¾åˆ° <code>&lt;ç›®æ ‡è·¯å¾„></code> å». ä¸‹è½½åçš„æ–‡ä»¶æƒé™è‡ªåŠ¨è®¾ç½®ä¸º <code>600</code>, å¦‚æœè¿™å¹¶ä¸æ˜¯æƒ³è¦çš„æƒé™, é‚£ä¹ˆè¿˜éœ€è¦å¢åŠ é¢å¤–çš„ä¸€å±‚ <code>RUN</code> è¿›è¡Œæƒé™è°ƒæ•´.</li><li>å¦‚æœ <code>&lt;æºè·¯å¾„></code> ä¸ºä¸€ä¸ª <code>tar</code> å‹ç¼©æ–‡ä»¶çš„è¯, å‹ç¼©æ ¼å¼ä¸º <code>gzip</code>, <code>bzip2</code> ä»¥åŠ <code>xz</code> çš„æƒ…å†µä¸‹, <code>ADD</code> æŒ‡ä»¤å°†ä¼šè‡ªåŠ¨è§£å‹ç¼©è¿™ä¸ªå‹ç¼©æ–‡ä»¶åˆ° <code>&lt;ç›®æ ‡è·¯å¾„></code> å».</li></ul><p>Docker å®˜æ–¹è¦æ±‚å°½å¯èƒ½çš„ä½¿ç”¨ <code>COPY</code>, å› ä¸º <code>COPY</code> çš„è¯­ä¹‰å¾ˆæ˜ç¡®, å°±æ˜¯å¤åˆ¶æ–‡ä»¶è€Œå·², è€Œ <code>ADD</code> åˆ™åŒ…å«äº†æ›´å¤æ‚çš„åŠŸèƒ½, å…¶è¡Œä¸ºä¹Ÿä¸ä¸€å®šå¾ˆæ¸…æ™°. æœ€é€‚åˆä½¿ç”¨ <code>ADD</code> çš„åœºåˆ, å°±æ˜¯æ‰€æåŠçš„éœ€è¦è‡ªåŠ¨è§£å‹ç¼©çš„åœºåˆ.</p><p>å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯, <code>ADD</code> æŒ‡ä»¤ä¼šä»¤é•œåƒæ„å»ºç¼“å­˜å¤±æ•ˆ, ä»è€Œå¯èƒ½ä¼šä»¤é•œåƒæ„å»ºå˜å¾—æ¯”è¾ƒç¼“æ…¢.</p><h2 id=4-run-æ‰§è¡Œå‘½ä»¤>4 RUN æ‰§è¡Œå‘½ä»¤<a hidden class=anchor aria-hidden=true href=#4-run-æ‰§è¡Œå‘½ä»¤>#</a></h2><p>æ ¼å¼:</p><ul><li><p>shell æ ¼å¼:<code>RUN [command] &lt;parameter1> &lt;parameter2> â€¦</code>, ç­‰ä»·äºåœ¨ linux ä¸­æ‰§è¡Œ <code>/bin/sh -c "command parameter1 parameter2 â€¦"</code></p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>RUN</span> ls -l<span style=color:#ef6155>
</span></span></span></code></pre></div></li><li><p>exec æ ¼å¼:<code>RUN ["command", "parameter1", "parameter2"â€¦]</code>, ä¸ä¼šé€šè¿‡ shell æ‰§è¡Œ, æ‰€ä»¥åƒ <code>$HOME</code> è¿™æ ·çš„å˜é‡å°±æ— æ³•è·å–.</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>RUN</span> <span style=color:#5bc4bf>[</span><span style=color:#48b685>&#34;ls&#34;</span>,  <span style=color:#48b685>&#34;-l&#34;</span><span style=color:#5bc4bf>]</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>RUN</span> <span style=color:#5bc4bf>[</span><span style=color:#48b685>&#34;/bin/sh&#34;</span>,  <span style=color:#48b685>&#34;-c&#34;</span>,  <span style=color:#48b685>&#34;ls -l&#34;</span><span style=color:#5bc4bf>]</span> <span style=color:#776e71># å¯ä»¥è·å–ç¯å¢ƒå˜é‡</span><span style=color:#ef6155>
</span></span></span></code></pre></div></li></ul><p>RUN æŒ‡ä»¤ç”¨äºæŒ‡å®šæ„å»ºé•œåƒæ—¶æ‰§è¡Œçš„å‘½ä»¤, Dockerfile å…è®¸å¤šä¸ª RUN æŒ‡ä»¤, å¹¶ä¸”æ¯ä¸ª RUN æŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªé•œåƒå±‚.</p><p>RUN æŒ‡ä»¤ä¸€èˆ¬ç”¨äºå®‰è£…é…ç½®è½¯ä»¶åŒ…ç­‰æ“ä½œ, ä¸ºé¿å…é•œåƒå±‚æ•°è¿‡å¤š, ä¸€èˆ¬ RUN æŒ‡ä»¤ä½¿ç”¨ shell æ ¼å¼ä¸”ä½¿ç”¨æ¢è¡Œç¬¦æ¥æ‰§è¡Œå¤šä¸ªå‘½ä»¤, ä¸”å°½é‡å°† <code>RUN</code> æŒ‡ä»¤äº§ç”Ÿçš„é™„å±ç‰©åˆ é™¤ä»¥ç¼©å°é•œåƒå¤§å°</p><p>å¦‚ä¸‹ç¤ºä¾‹</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>FROM</span><span style=color:#48b685> debian:stretch</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>RUN</span> set -x; <span style=color:#ef6155>buildDeps</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#39;gcc libc6-dev make wget&#39;</span> <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>    <span style=color:#5bc4bf>&amp;&amp;</span> apt-get update <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>    <span style=color:#5bc4bf>&amp;&amp;</span> apt-get install -y <span style=color:#ef6155>$buildDeps</span> <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>    <span style=color:#5bc4bf>&amp;&amp;</span> wget -O redis.tar.gz <span style=color:#48b685>&#34;http://download.redis.io/releases/redis-5.0.3.tar.gz&#34;</span> <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>    <span style=color:#5bc4bf>&amp;&amp;</span> mkdir -p /usr/src/redis <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>    <span style=color:#5bc4bf>&amp;&amp;</span> tar -xzf redis.tar.gz -C /usr/src/redis --strip-components<span style=color:#5bc4bf>=</span><span style=color:#f99b15>1</span> <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>    <span style=color:#5bc4bf>&amp;&amp;</span> make -C /usr/src/redis <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>    <span style=color:#5bc4bf>&amp;&amp;</span> make -C /usr/src/redis install <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>    <span style=color:#5bc4bf>&amp;&amp;</span> rm -rf /var/lib/apt/lists/* <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>    <span style=color:#5bc4bf>&amp;&amp;</span> rm redis.tar.gz <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>    <span style=color:#5bc4bf>&amp;&amp;</span> rm -r /usr/src/redis <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>    <span style=color:#5bc4bf>&amp;&amp;</span> apt-get purge -y --auto-remove <span style=color:#ef6155>$buildDeps</span><span style=color:#ef6155>
</span></span></span></code></pre></div><h2 id=5-cmd-å®¹å™¨å¯åŠ¨å‘½ä»¤>5 CMD å®¹å™¨å¯åŠ¨å‘½ä»¤<a hidden class=anchor aria-hidden=true href=#5-cmd-å®¹å™¨å¯åŠ¨å‘½ä»¤>#</a></h2><p><code>CMD</code> æŒ‡ä»¤çš„æ ¼å¼å’Œ <code>RUN</code> ç›¸ä¼¼, ä¹Ÿæ˜¯ä¸¤ç§æ ¼å¼ï¼š</p><ul><li><code>shell</code> æ ¼å¼ï¼š<code>CMD [command] &lt;parameters></code></li><li><code>exec</code> æ ¼å¼ï¼š<code>CMD ["command", "&lt;parameter1>", "parameter2", â€¦]</code></li><li>å‚æ•°åˆ—è¡¨æ ¼å¼ï¼š<code>CMD ["å‚æ•°1", "å‚æ•°2"â€¦]</code>. åœ¨æŒ‡å®šäº† <code>ENTRYPOINT</code> æŒ‡ä»¤å, ç”¨ <code>CMD</code> æŒ‡å®šå…·ä½“çš„å‚æ•°.</li></ul><p><code>CMD</code> æŒ‡ä»¤ç”¨äºè®¾ç½®å®¹å™¨å¯åŠ¨æ—¶ <font color=red>é»˜è®¤æ‰§è¡Œ</font> çš„æŒ‡ä»¤, ä¸€èˆ¬ä¼šè®¾ç½®ä¸ºåº”ç”¨ç¨‹åºçš„å¯åŠ¨è„šæœ¬æˆ–è€…å·¥å…·é•œåƒçš„ <code>bash</code>, è®¾ç½®äº†å¤šæ¡ <code>CMD</code> æŒ‡ä»¤æ—¶, åªæœ‰æœ€åä¸€æ¡ <code>CMD</code> ä¼šè¢«æ‰§è¡Œ.</p><p>åœ¨è¿è¡Œæ—¶å¯ä»¥æŒ‡å®šæ–°çš„å‘½ä»¤æ¥æ›¿ä»£é•œåƒè®¾ç½®ä¸­çš„è¿™ä¸ªé»˜è®¤å‘½ä»¤, æ¯”å¦‚, <code>ubuntu</code> é•œåƒé»˜è®¤çš„ <code>CMD</code> æ˜¯ <code>/bin/bash</code>, å¦‚æœæˆ‘ä»¬ç›´æ¥ <code>docker run -it ubuntu</code> çš„è¯, ä¼šç›´æ¥è¿›å…¥ <code>bash</code>. æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨è¿è¡Œæ—¶æŒ‡å®šè¿è¡Œåˆ«çš„å‘½ä»¤, å¦‚ <code>docker run -it ubuntu cat /etc/os-release</code>. è¿™å°±æ˜¯ç”¨ <code>cat /etc/os-release</code> å‘½ä»¤æ›¿æ¢äº†é»˜è®¤çš„ <code>/bin/bash</code> å‘½ä»¤äº†, ä¼šè¾“å‡ºç³»ç»Ÿç‰ˆæœ¬ä¿¡æ¯.</p><p>åœ¨æŒ‡ä»¤æ ¼å¼ä¸Š, ä¸€èˆ¬æ¨èä½¿ç”¨ <code>exec</code> æ ¼å¼, è¿™ç±»æ ¼å¼åœ¨è§£ææ—¶ä¼šè¢«è§£æä¸º JSON æ•°ç»„, å› æ­¤ä¸€å®šè¦ä½¿ç”¨åŒå¼•å· <code>"</code>, è€Œä¸è¦ä½¿ç”¨å•å¼•å·.</p><p>ä¾‹å¦‚ä¸€èˆ¬ <code>nginx</code> å®¹å™¨çš„ <code>CMD</code> æŒ‡ä»¤:</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>CMD</span> [<span style=color:#48b685>&#34;nginx&#34;</span>,  <span style=color:#48b685>&#34;-g&#34;</span>,  <span style=color:#48b685>&#34;daemon off;&#34;</span>]<span style=color:#ef6155>
</span></span></span></code></pre></div><h2 id=6-entrypoint-å…¥å£ç‚¹>6 ENTRYPOINT å…¥å£ç‚¹<a hidden class=anchor aria-hidden=true href=#6-entrypoint-å…¥å£ç‚¹>#</a></h2><p><code>ENTRYPOINT</code> çš„æ ¼å¼å’Œ <code>RUN</code> æŒ‡ä»¤æ ¼å¼ä¸€æ ·, åˆ†ä¸º <code>exec</code> æ ¼å¼å’Œ <code>shell</code> æ ¼å¼.</p><ul><li><code>shell</code> æ ¼å¼ï¼š<code>ENTRYPOINT [command] &lt;parameters></code></li><li><code>exec</code> æ ¼å¼ï¼š<code>ENTRYPOINT ["command", "&lt;parameter1>", "&lt;parameter2>", â€¦]</code></li></ul><p><code>ENTRYPOINT</code> çš„ç›®çš„å’Œ <code>CMD</code> ä¸€æ ·, éƒ½æ˜¯åœ¨æŒ‡å®šå®¹å™¨å¯åŠ¨ç¨‹åºåŠå‚æ•°. <code>ENTRYPOINT</code> åœ¨è¿è¡Œæ—¶ä¹Ÿå¯ä»¥æ›¿ä»£, ä¸è¿‡æ¯” <code>CMD</code> è¦ç•¥æ˜¾ç¹ç, éœ€è¦é€šè¿‡ <code>docker run</code> çš„å‚æ•° <code>--entrypoint</code> æ¥æŒ‡å®š.</p><p>å½“æŒ‡å®šäº† <code>ENTRYPOINT</code> ä¸”ä½¿ç”¨çš„æ˜¯ <code>exec</code> æ ¼å¼æ—¶, <code>CMD</code> çš„å«ä¹‰å°±å‘ç”Ÿäº†æ”¹å˜, ä¸å†æ˜¯ç›´æ¥çš„è¿è¡Œå…¶å‘½ä»¤, è€Œæ˜¯å°† <code>CMD</code> çš„å†…å®¹ä½œä¸ºå‚æ•°ä¼ ç»™ <code>ENTRYPOINT</code> æŒ‡ä»¤, æ¢å¥è¯è¯´å®é™…æ‰§è¡Œæ—¶, å°†å˜ä¸ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>ENTRYPOINT</span> [<span style=color:#48b685>&#34;command&#34;</span>,  <span style=color:#48b685>&#34;&lt;parameter1&gt;&#34;</span>,  <span style=color:#48b685>&#34;&lt;parameter2&gt;&#34;</span>,  <span style=color:#48b685>&#34;CMD&#34;</span>]<span style=color:#ef6155>
</span></span></span></code></pre></div><p>ä»¥ä¸‹ç¤ºä¾‹å°†å±•ç¤º <code>CMD</code> æŒ‡ä»¤ä½œä¸ºå‚æ•°ä¼ ç»™ <code>ENTRYPOINT</code> çš„åœºæ™¯</p><p>åœºæ™¯ä¸€ï¼šæˆ‘ä»¬è‡ªå·±æ„å»ºäº†ä¸€ä¸ªç”¨äºæŸ¥çœ‹å¤–ç½‘ ip å’Œå½’å±åœ°çš„é•œåƒ</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>FROM</span><span style=color:#48b685> alpine</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>RUN</span> sed -i <span style=color:#48b685>&#39;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&#39;</span> /etc/apk/repositories <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>    <span style=color:#5bc4bf>&amp;&amp;</span> apk --update add curl<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>CMD</span> [ <span style=color:#48b685>&#34;-s&#34;</span> ]<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>ENTRYPOINT</span> [ <span style=color:#48b685>&#34;curl&#34;</span>,  <span style=color:#48b685>&#34;http://myip.ipip.net&#34;</span> ]<span style=color:#ef6155>
</span></span></span></code></pre></div><p>æ„å»º</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -t busybox-curl .
</span></span></code></pre></div><p>ä»¥ä¸¤ç§æ–¹å¼è¿è¡Œ</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#776e71># å®¹å™¨ä¸­å®é™…æ‰§è¡Œçš„æŒ‡ä»¤ä¸º curl http://myip.ipip.net -s</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@lvbibir learn<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker run -it --rm busybox-curl</span>
</span></span><span style=display:flex><span>å½“å‰ IPï¼š101.201.150.47  æ¥è‡ªäºï¼šä¸­å›½ åŒ—äº¬ åŒ—äº¬  é˜¿é‡Œäº‘
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># å®¹å™¨ä¸­å®é™…æ‰§è¡Œçš„æŒ‡ä»¤ä¸º curl http://myip.ipip.net -i</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@lvbibir learn<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker run -it --rm busybox-curl -i</span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#f99b15>200</span> OK
</span></span><span style=display:flex><span>Date: Mon,  <span style=color:#f99b15>10</span> Apr <span style=color:#f99b15>2023</span> 03:21:59 GMT
</span></span><span style=display:flex><span>Content-Type: text/plain; <span style=color:#ef6155>charset</span><span style=color:#5bc4bf>=</span>utf-8
</span></span><span style=display:flex><span>Content-Length: <span style=color:#f99b15>72</span>
</span></span><span style=display:flex><span>Connection: keep-alive
</span></span><span style=display:flex><span>Node: ipip-myip5
</span></span><span style=display:flex><span>X-Cache: BYPASS
</span></span><span style=display:flex><span>X-Request-Id: e309720b9197e8b94cec18b409c69d1d
</span></span><span style=display:flex><span>Server: WAF
</span></span><span style=display:flex><span>Connection: close
</span></span><span style=display:flex><span>Accept-Ranges: bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>å½“å‰ IPï¼š101.201.150.47  æ¥è‡ªäºï¼šä¸­å›½ åŒ—äº¬ åŒ—äº¬  é˜¿é‡Œäº‘
</span></span></code></pre></div><p>åœºæ™¯äºŒï¼šåº”ç”¨è¿è¡Œå‰çš„å‡†å¤‡å·¥ä½œ</p><p>å¯åŠ¨å®¹å™¨å°±æ˜¯å¯åŠ¨ä¸»è¿›ç¨‹, ä½†æœ‰äº›æ—¶å€™, å¯åŠ¨ä¸»è¿›ç¨‹å‰, éœ€è¦ä¸€äº›å‡†å¤‡å·¥ä½œ.</p><p>æ¯”å¦‚ <code>mysql</code> ç±»çš„æ•°æ®åº“, å¯èƒ½éœ€è¦ä¸€äº›æ•°æ®åº“é…ç½®ã€åˆå§‹åŒ–çš„å·¥ä½œ, è¿™äº›å·¥ä½œè¦åœ¨æœ€ç»ˆçš„ mysql æœåŠ¡å™¨è¿è¡Œä¹‹å‰è§£å†³.</p><p>æ­¤å¤–, å¯èƒ½å¸Œæœ›é¿å…ä½¿ç”¨ <code>root</code> ç”¨æˆ·å»å¯åŠ¨æœåŠ¡, ä»è€Œæé«˜å®‰å…¨æ€§, è€Œåœ¨å¯åŠ¨æœåŠ¡å‰è¿˜éœ€è¦ä»¥ <code>root</code> èº«ä»½æ‰§è¡Œä¸€äº›å¿…è¦çš„å‡†å¤‡å·¥ä½œ, æœ€ååˆ‡æ¢åˆ°æœåŠ¡ç”¨æˆ·èº«ä»½å¯åŠ¨æœåŠ¡. æˆ–è€…é™¤äº†æœåŠ¡å¤–, å…¶å®ƒå‘½ä»¤ä¾æ—§å¯ä»¥ä½¿ç”¨ <code>root</code> èº«ä»½æ‰§è¡Œ, æ–¹ä¾¿è°ƒè¯•ç­‰.</p><p>è¿™äº›å‡†å¤‡å·¥ä½œæ˜¯å’Œå®¹å™¨ <code>CMD</code> æ— å…³çš„, æ— è®º <code>CMD</code> ä¸ºä»€ä¹ˆ, éƒ½éœ€è¦äº‹å…ˆè¿›è¡Œä¸€ä¸ªé¢„å¤„ç†çš„å·¥ä½œ. è¿™ç§æƒ…å†µä¸‹, å¯ä»¥å†™ä¸€ä¸ªè„šæœ¬, ç„¶åæ”¾å…¥ <code>ENTRYPOINT</code> ä¸­å»æ‰§è¡Œ, è€Œè¿™ä¸ªè„šæœ¬ä¼šå°†æ¥åˆ°çš„å‚æ•°ï¼ˆä¹Ÿå°±æ˜¯ <code>&lt;CMD></code>ï¼‰ä½œä¸ºå‘½ä»¤, åœ¨è„šæœ¬æœ€åæ‰§è¡Œ. æ¯”å¦‚å®˜æ–¹é•œåƒ <code>redis</code> ä¸­å°±æ˜¯è¿™ä¹ˆåšçš„ï¼š</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>FROM</span><span style=color:#48b685> alpine:3.4</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span>...<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>RUN</span> addgroup -S redis <span style=color:#5bc4bf>&amp;&amp;</span> adduser -S -G redis redis<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span>...<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>ENTRYPOINT</span> [<span style=color:#48b685>&#34;docker-entrypoint.sh&#34;</span>]<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>EXPOSE</span><span style=color:#48b685> 6379</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>CMD</span> [ <span style=color:#48b685>&#34;redis-server&#34;</span> ]<span style=color:#ef6155>
</span></span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°å…¶ä¸­ä¸ºäº† redis æœåŠ¡åˆ›å»ºäº† redis ç”¨æˆ·, å¹¶åœ¨æœ€åæŒ‡å®šäº† <code>ENTRYPOINT</code> ä¸º <code>docker-entrypoint.sh</code> è„šæœ¬ï¼š</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#776e71>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>...
</span></span><span style=display:flex><span><span style=color:#776e71># allow the container to be started with `--user`</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[</span> <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$1</span><span style=color:#48b685>&#34;</span> <span style=color:#5bc4bf>=</span> <span style=color:#48b685>&#39;redis-server&#39;</span> -a <span style=color:#48b685>&#34;</span><span style=color:#815ba4>$(</span>id -u<span style=color:#815ba4>)</span><span style=color:#48b685>&#34;</span> <span style=color:#5bc4bf>=</span> <span style=color:#48b685>&#39;0&#39;</span> <span style=color:#5bc4bf>]</span>; <span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>	find . <span style=color:#f99b15>\!</span> -user redis -exec chown redis <span style=color:#48b685>&#39;{}&#39;</span> +
</span></span><span style=display:flex><span>	exec gosu redis <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$0</span><span style=color:#48b685>&#34;</span> <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$@</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exec <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$@</span><span style=color:#48b685>&#34;</span>
</span></span></code></pre></div><p>è¯¥è„šæœ¬çš„å†…å®¹å°±æ˜¯æ ¹æ® <code>CMD</code> çš„å†…å®¹æ¥åˆ¤æ–­, å¦‚æœæ˜¯ <code>redis-server</code> çš„è¯, åˆ™åˆ‡æ¢åˆ° <code>redis</code> ç”¨æˆ·èº«ä»½å¯åŠ¨æœåŠ¡å™¨, å¦åˆ™ä¾æ—§ä½¿ç”¨ <code>root</code> èº«ä»½æ‰§è¡Œ. æ¯”å¦‚ï¼š</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@lvbibir learn<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker run -it redis id</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>uid</span><span style=color:#5bc4bf>=</span>0<span style=color:#5bc4bf>(</span>root<span style=color:#5bc4bf>)</span> <span style=color:#ef6155>gid</span><span style=color:#5bc4bf>=</span>0<span style=color:#5bc4bf>(</span>root<span style=color:#5bc4bf>)</span> <span style=color:#ef6155>groups</span><span style=color:#5bc4bf>=</span>0<span style=color:#5bc4bf>(</span>root<span style=color:#5bc4bf>)</span>
</span></span></code></pre></div><h2 id=7-env-è®¾ç½®ç¯å¢ƒå˜é‡>7 ENV è®¾ç½®ç¯å¢ƒå˜é‡<a hidden class=anchor aria-hidden=true href=#7-env-è®¾ç½®ç¯å¢ƒå˜é‡>#</a></h2><p>æ ¼å¼æœ‰ä¸¤ç§ï¼š</p><ul><li><code>ENV &lt;key> &lt;value></code></li><li><code>ENV &lt;key1>=&lt;value1> &lt;key2>=&lt;value2>â€¦</code></li></ul><p><code>ENV</code> ç”¨äºè®¾ç½®ç¯å¢ƒå˜é‡, æ—¢å¯ä»¥åœ¨ Dockerfile ä¸­è°ƒç”¨, ä¹Ÿå¯ä»¥åœ¨æ„å»ºå®Œçš„å®¹å™¨è¿è¡Œæ—¶ä¸­ä½¿ç”¨.</p><p>æ”¯æŒçš„æŒ‡ä»¤ï¼š <code>ADD</code>ã€<code>COPY</code>ã€<code>ENV</code>ã€<code>EXPOSE</code>ã€<code>FROM</code>ã€<code>LABEL</code>ã€<code>USER</code>ã€<code>WORKDIR</code>ã€<code>VOLUME</code>ã€<code>STOPSIGNAL</code>ã€<code>ONBUILD</code>ã€<code>RUN</code></p><p>ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­æ¼”ç¤ºäº†å¦‚ä½•æ¢è¡Œ, ä»¥åŠå¯¹å«æœ‰ç©ºæ ¼çš„å€¼ç”¨åŒå¼•å·æ‹¬èµ·æ¥çš„åŠæ³•, è¿™å’Œ Shell ä¸‹çš„è¡Œä¸ºæ˜¯ä¸€è‡´çš„.</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>ENV</span> <span style=color:#ef6155>VERSION</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>1</span>.0 <span style=color:#ef6155>DEBUG</span><span style=color:#5bc4bf>=</span>on <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>    <span style=color:#ef6155>NAME</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;Happy Feet&#34;</span><span style=color:#ef6155>
</span></span></span></code></pre></div><p>ç¤ºä¾‹</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>FROM</span><span style=color:#48b685> alpine</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>ENV</span> <span style=color:#ef6155>VERSION</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>1</span>.0 <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>    <span style=color:#ef6155>DEBUG</span><span style=color:#5bc4bf>=</span>on <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>    <span style=color:#ef6155>NAME</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;Happy Feet&#34;</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>RUN</span> echo <span style=color:#48b685>&#34;name: </span><span style=color:#f99b15>${</span><span style=color:#ef6155>NAME</span><span style=color:#f99b15>}</span><span style=color:#48b685>&#34;</span> &gt; /test <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>    <span style=color:#5bc4bf>&amp;&amp;</span> echo <span style=color:#48b685>&#34;version: </span><span style=color:#f99b15>${</span><span style=color:#ef6155>VERSION</span><span style=color:#f99b15>}</span><span style=color:#48b685>&#34;</span> &gt;&gt; /test<span style=color:#ef6155>
</span></span></span></code></pre></div><p>æ„å»º</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@lvbibir learn<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker build -t demo-env .</span>
</span></span></code></pre></div><p>æ„å»ºæ—¶è°ƒç”¨äº†ç¯å¢ƒå˜é‡</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@lvbibir learn<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker run -it --rm demo-env cat /test</span>
</span></span><span style=display:flex><span>name: Happy Feet
</span></span><span style=display:flex><span>version: 1.0
</span></span></code></pre></div><p>æ„å»ºåçš„å®¹å™¨è¿è¡Œæ—¶ä¸­è°ƒç”¨, è¿™é‡Œéœ€è¦ä½¿ç”¨ <code>/bin/sh -c</code> çš„æ–¹å¼, ä¸ç„¶æ— æ³•è¯»å–å˜é‡. ä¸”å¯¹ <code>$</code> è¿›è¡Œè½¬ä¹‰, ä¸ç„¶è¯»å–çš„å°†ä¼šæ˜¯å®¿ä¸»æœºçš„å˜é‡</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@lvbibir learn<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker run -it --rm demo-env /bin/sh -c &#34;echo \${DEBUG}&#34;</span>
</span></span><span style=display:flex><span>on
</span></span></code></pre></div><h2 id=8-arg-æ„å»ºå‚æ•°>8 ARG æ„å»ºå‚æ•°<a hidden class=anchor aria-hidden=true href=#8-arg-æ„å»ºå‚æ•°>#</a></h2><p>æ„å»ºå‚æ•°å’Œ <code>ENV</code> çš„æ•ˆæœä¸€æ ·, éƒ½æ˜¯è®¾ç½®ç¯å¢ƒå˜é‡. æ‰€ä¸åŒçš„æ˜¯, <code>ARG</code> æ‰€è®¾ç½®çš„æ„å»ºç¯å¢ƒçš„ç¯å¢ƒå˜é‡, åœ¨å°†æ¥å®¹å™¨è¿è¡Œæ—¶æ˜¯ä¸ä¼šå­˜åœ¨è¿™äº›ç¯å¢ƒå˜é‡çš„. ä½†æ˜¯ä¸è¦å› æ­¤å°±ä½¿ç”¨ <code>ARG</code> ä¿å­˜å¯†ç ä¹‹ç±»çš„ä¿¡æ¯, å› ä¸º <code>docker history</code> è¿˜æ˜¯å¯ä»¥çœ‹åˆ°æ‰€æœ‰å€¼çš„.</p><p><code>Dockerfile</code> ä¸­çš„ <code>ARG</code> æŒ‡ä»¤æ˜¯å®šä¹‰å‚æ•°åç§°, ä»¥åŠå®šä¹‰å…¶é»˜è®¤å€¼. è¯¥é»˜è®¤å€¼å¯ä»¥åœ¨æ„å»ºå‘½ä»¤ <code>docker build</code> ä¸­ç”¨ <code>--build-arg &lt;å‚æ•°å>=&lt;å€¼></code> æ¥è¦†ç›–.</p><p>çµæ´»çš„ä½¿ç”¨ <code>ARG</code> æŒ‡ä»¤, èƒ½å¤Ÿåœ¨ä¸ä¿®æ”¹ Dockerfile çš„æƒ…å†µä¸‹, æ„å»ºå‡ºä¸åŒçš„é•œåƒ.</p><p>ARG æŒ‡ä»¤æœ‰ç”Ÿæ•ˆèŒƒå›´, å¦‚æœåœ¨ <code>FROM</code> æŒ‡ä»¤ä¹‹å‰æŒ‡å®š, é‚£ä¹ˆåªèƒ½ç”¨äº <code>FROM</code> æŒ‡ä»¤ä¸­, <code>FROM</code> æŒ‡ä»¤å¯ä»¥æ˜¯å¤šä¸ª</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>ARG</span> <span style=color:#ef6155>DOCKER_USERNAME</span><span style=color:#5bc4bf>=</span>library
</span></span><span style=display:flex><span><span style=color:#815ba4>FROM</span><span style=color:#48b685> ${DOCKER_USERNAME}/alpine</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>RUN</span> set -x ; echo <span style=color:#f99b15>${</span><span style=color:#ef6155>DOCKER_USERNAME</span><span style=color:#f99b15>}</span><span style=color:#ef6155>
</span></span></span></code></pre></div><p>ä½¿ç”¨ä¸Šè¿° Dockerfile ä¼šå‘ç°æ— æ³•è¾“å‡º <code>${DOCKER_USERNAME}</code> å˜é‡çš„å€¼, è¦æƒ³æ­£å¸¸è¾“å‡º, ä½ å¿…é¡»åœ¨ <code>FROM</code> ä¹‹åå†æ¬¡æŒ‡å®š <code>ARG</code>, å¦‚ä¸‹ç¤ºä¾‹</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#776e71># åªåœ¨ FROM ä¸­ç”Ÿæ•ˆ</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>ARG</span> <span style=color:#ef6155>DOCKER_USERNAME</span><span style=color:#5bc4bf>=</span>library
</span></span><span style=display:flex><span><span style=color:#815ba4>FROM</span><span style=color:#48b685> ${DOCKER_USERNAME}/alpine</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#776e71># è¦æƒ³åœ¨ FROM ä¹‹åä½¿ç”¨, å¿…é¡»å†æ¬¡æŒ‡å®š</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>ARG</span> <span style=color:#ef6155>DOCKER_USERNAME</span><span style=color:#5bc4bf>=</span>library
</span></span><span style=display:flex><span><span style=color:#815ba4>RUN</span> set -x ; echo <span style=color:#f99b15>${</span><span style=color:#ef6155>DOCKER_USERNAME</span><span style=color:#f99b15>}</span><span style=color:#ef6155>
</span></span></span></code></pre></div><p>å¦‚ä¸‹ç¤ºä¾‹, å˜é‡å°†ä¼šåœ¨æ¯ä¸ª <code>FROM</code> æŒ‡ä»¤ä¸­ç”Ÿæ•ˆ</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#776e71># è¿™ä¸ªå˜é‡åœ¨æ¯ä¸ª FROM ä¸­éƒ½ç”Ÿæ•ˆ</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>ARG</span> <span style=color:#ef6155>DOCKER_USERNAME</span><span style=color:#5bc4bf>=</span>library
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>FROM</span><span style=color:#48b685> ${DOCKER_USERNAME}/alpine</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>RUN</span> set -x ; echo <span style=color:#f99b15>1</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>FROM</span><span style=color:#48b685> ${DOCKER_USERNAME}/alpine</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>RUN</span> set -x ; echo <span style=color:#f99b15>2</span><span style=color:#ef6155>
</span></span></span></code></pre></div><p>å¦‚ä¸‹ç¤ºä¾‹, å¯¹äºåœ¨å„ä¸ªé˜¶æ®µä¸­ä½¿ç”¨çš„å˜é‡éƒ½å¿…é¡»åœ¨æ¯ä¸ªé˜¶æ®µåˆ†åˆ«æŒ‡å®š</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>ARG</span> <span style=color:#ef6155>DOCKER_USERNAME</span><span style=color:#5bc4bf>=</span>library
</span></span><span style=display:flex><span><span style=color:#815ba4>FROM</span><span style=color:#48b685> ${DOCKER_USERNAME}/alpine</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#776e71># åœ¨FROM ä¹‹åä½¿ç”¨å˜é‡, å¿…é¡»åœ¨æ¯ä¸ªé˜¶æ®µåˆ†åˆ«æŒ‡å®š</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>ARG</span> <span style=color:#ef6155>DOCKER_USERNAME</span><span style=color:#5bc4bf>=</span>library
</span></span><span style=display:flex><span><span style=color:#815ba4>RUN</span> set -x ; echo <span style=color:#f99b15>${</span><span style=color:#ef6155>DOCKER_USERNAME</span><span style=color:#f99b15>}</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>FROM</span><span style=color:#48b685> ${DOCKER_USERNAME}/alpine</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#776e71># åœ¨FROM ä¹‹åä½¿ç”¨å˜é‡, å¿…é¡»åœ¨æ¯ä¸ªé˜¶æ®µåˆ†åˆ«æŒ‡å®š</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>ARG</span> <span style=color:#ef6155>DOCKER_USERNAME</span><span style=color:#5bc4bf>=</span>library
</span></span><span style=display:flex><span><span style=color:#815ba4>RUN</span> set -x ; echo <span style=color:#f99b15>${</span><span style=color:#ef6155>DOCKER_USERNAME</span><span style=color:#f99b15>}</span><span style=color:#ef6155>
</span></span></span></code></pre></div><h2 id=9-volume-å®šä¹‰åŒ¿åå·>9 VOLUME å®šä¹‰åŒ¿åå·<a hidden class=anchor aria-hidden=true href=#9-volume-å®šä¹‰åŒ¿åå·>#</a></h2><p>æ ¼å¼ä¸ºï¼š</p><ul><li><code>VOLUME ["&lt;è·¯å¾„1>", "&lt;è·¯å¾„2>"â€¦]</code></li><li><code>VOLUME &lt;è·¯å¾„></code></li></ul><p>å®¹å™¨è¿è¡Œæ—¶åº”è¯¥å°½é‡ä¿æŒå®¹å™¨å­˜å‚¨å±‚ä¸å‘ç”Ÿå†™æ“ä½œ, å¯¹äºæ•°æ®åº“ç±»éœ€è¦ä¿å­˜åŠ¨æ€æ•°æ®çš„åº”ç”¨, å…¶æ•°æ®åº“æ–‡ä»¶åº”è¯¥ä¿å­˜äºå· (volume) ä¸­.</p><p>ä¸ºäº†é˜²æ­¢è¿è¡Œæ—¶ç”¨æˆ·å¿˜è®°å°†åŠ¨æ€æ–‡ä»¶æ‰€ä¿å­˜ç›®å½•æŒ‚è½½ä¸ºå·, åœ¨ <code>Dockerfile</code> ä¸­, æˆ‘ä»¬å¯ä»¥äº‹å…ˆæŒ‡å®šæŸäº›ç›®å½•æŒ‚è½½ä¸ºåŒ¿åå·, è¿™æ ·åœ¨è¿è¡Œæ—¶å¦‚æœç”¨æˆ·ä¸æŒ‡å®šæŒ‚è½½, å…¶åº”ç”¨ä¹Ÿå¯ä»¥æ­£å¸¸è¿è¡Œ, ä¸ä¼šå‘å®¹å™¨å­˜å‚¨å±‚å†™å…¥å¤§é‡æ•°æ®, ä»è€Œä¿è¯äº†å®¹å™¨å­˜å‚¨å±‚çš„æ— çŠ¶æ€åŒ–.</p><p><code>VOLUME</code> åˆ›å»ºçš„åŒ¿åå·ä¼šæŒ‚è½½åˆ°ç³»ç»Ÿ <code>/var/lib/docker/volumes/&lt;CONTAINER-ID>/&lt;_VOLUME></code> ç›®å½•ä¸‹, ä¸”ä¸ä¼šéšç€å®¹å™¨åˆ é™¤è€Œåˆ é™¤, éœ€è¦æ‰‹åŠ¨åˆ é™¤</p><p>å¦‚ä¸‹ç¤ºä¾‹</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>FROM</span><span style=color:#48b685> alpine</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>VOLUME</span><span style=color:#48b685> /data</span><span style=color:#ef6155>
</span></span></span></code></pre></div><p>æ„å»ºè¿è¡Œ</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@lvbibir learn<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker build -t demo-volume .</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@lvbibir learn<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker run -itd --name=demo-volume demo-volume </span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@lvbibir learn<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker exec -it demo-volume ls -ld /data</span>
</span></span><span style=display:flex><span>drwxr-xr-x    <span style=color:#f99b15>2</span> root     root          <span style=color:#f99b15>4096</span> Apr <span style=color:#f99b15>10</span> 05:24 /data
</span></span></code></pre></div><p>æŸ¥çœ‹æŒ‚è½½ç›®å½•</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@lvbibir learn<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker inspect --format=&#39;{{json .Mounts}}&#39; demo-volume | python -m json.tool</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#34;Destination&#34;</span>: <span style=color:#48b685>&#34;/data&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#34;Driver&#34;</span>: <span style=color:#48b685>&#34;local&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#34;Mode&#34;</span>: <span style=color:#48b685>&#34;&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#34;Name&#34;</span>: <span style=color:#48b685>&#34;49cf915dd297292e3d0e4b2c7a66ead6875cfb0dbd010de15189040ab1158b3b&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#34;Propagation&#34;</span>: <span style=color:#48b685>&#34;&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#34;RW&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#34;Source&#34;</span>: <span style=color:#48b685>&#34;/var/lib/docker/volumes/49cf915dd297292e3d0e4b2c7a66ead6875cfb0dbd010de15189040ab1158b3b/_data&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#34;Type&#34;</span>: <span style=color:#48b685>&#34;volume&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>]</span>
</span></span></code></pre></div><p>å¦‚ä¸‹ç¤ºä¾‹, è¿è¡Œå®¹å™¨æ—¶, å¯ä»¥æŒ‡å®š <code>-v</code> å‚æ•°å°†ç›®å½•æŒ‚è½½åˆ°æŒ‡å®šä½ç½®</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@lvbibir learn<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker run -itd -v /mydata:/data --name demo-volume-2 demo-volume</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@lvbibir learn<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker inspect --format=&#39;{{json .Mounts}}&#39; demo-volume-2 | python -m json.tool</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#34;Destination&#34;</span>: <span style=color:#48b685>&#34;/data&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#34;Mode&#34;</span>: <span style=color:#48b685>&#34;&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#34;Propagation&#34;</span>: <span style=color:#48b685>&#34;rprivate&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#34;RW&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#34;Source&#34;</span>: <span style=color:#48b685>&#34;/mydata&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#34;Type&#34;</span>: <span style=color:#48b685>&#34;bind&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>]</span>
</span></span></code></pre></div><h2 id=10-expose-æš´éœ²ç«¯å£>10 EXPOSE æš´éœ²ç«¯å£<a hidden class=anchor aria-hidden=true href=#10-expose-æš´éœ²ç«¯å£>#</a></h2><p>æ ¼å¼ä¸º <code>EXPOSE &lt;ç«¯å£1> [ç«¯å£2] â€¦</code></p><p><code>EXPOSE</code> æŒ‡ä»¤æ˜¯å£°æ˜å®¹å™¨è¿è¡Œæ—¶æä¾›æœåŠ¡çš„ç«¯å£, è¿™åªæ˜¯ä¸€ä¸ªå£°æ˜, åœ¨å®¹å™¨è¿è¡Œæ—¶å¹¶ä¸ä¼šå› ä¸ºè¿™ä¸ªå£°æ˜åº”ç”¨å°±ä¼šå¼€å¯è¿™ä¸ªç«¯å£çš„æœåŠ¡</p><p>åœ¨ Dockerfile ä¸­å†™å…¥è¿™æ ·çš„å£°æ˜æœ‰ä¸¤ä¸ªå¥½å¤„ï¼š</p><ul><li>ä¸€ä¸ªæ˜¯å¸®åŠ©é•œåƒä½¿ç”¨è€…ç†è§£è¿™ä¸ªé•œåƒæœåŠ¡çš„å®ˆæŠ¤ç«¯å£, ä»¥æ–¹ä¾¿é…ç½®æ˜ å°„ï¼›</li><li>å¦ä¸€ä¸ªç”¨å¤„åˆ™æ˜¯åœ¨è¿è¡Œæ—¶ä½¿ç”¨éšæœºç«¯å£æ˜ å°„æ—¶, ä¹Ÿå°±æ˜¯ <code>docker run -P</code> æ—¶, ä¼šè‡ªåŠ¨éšæœºæ˜ å°„ <code>EXPOSE</code> çš„ç«¯å£.</li></ul><p>è¦å°† <code>EXPOSE</code> å’Œåœ¨è¿è¡Œæ—¶ä½¿ç”¨ <code>-p &lt;å®¿ä¸»ç«¯å£>:&lt;å®¹å™¨ç«¯å£></code> åŒºåˆ†å¼€æ¥. <code>-p</code>, æ˜¯æ˜ å°„å®¿ä¸»ç«¯å£å’Œå®¹å™¨ç«¯å£, æ¢å¥è¯è¯´, å°±æ˜¯å°†å®¹å™¨çš„å¯¹åº”ç«¯å£æœåŠ¡å…¬å¼€ç»™å¤–ç•Œè®¿é—®, è€Œ <code>EXPOSE</code> ä»…ä»…æ˜¯å£°æ˜å®¹å™¨æ‰“ç®—ä½¿ç”¨ä»€ä¹ˆç«¯å£è€Œå·², å¹¶ä¸ä¼šè‡ªåŠ¨åœ¨å®¿ä¸»è¿›è¡Œç«¯å£æ˜ å°„.</p><h2 id=11-workdir-æŒ‡å®šå·¥ä½œç›®å½•>11 WORKDIR æŒ‡å®šå·¥ä½œç›®å½•<a hidden class=anchor aria-hidden=true href=#11-workdir-æŒ‡å®šå·¥ä½œç›®å½•>#</a></h2><p>æ ¼å¼ä¸º <code>WORKDIR &lt;è·¯å¾„></code></p><p>ä½¿ç”¨ <code>WORKDIR</code> æŒ‡ä»¤å¯ä»¥æ¥æŒ‡å®šå·¥ä½œç›®å½•ï¼ˆæˆ–è€…ç§°ä¸ºå½“å‰ç›®å½•ï¼‰, ä»¥åå„å±‚çš„å½“å‰ç›®å½•å°±è¢«æ”¹ä¸ºæŒ‡å®šçš„ç›®å½•, å¦‚è¯¥ç›®å½•ä¸å­˜åœ¨, <code>WORKDIR</code> ä¼šå¸®ä½ å»ºç«‹ç›®å½•</p><p>å¦‚ä¸‹ç¤ºä¾‹, æ˜¯ä¸€ä¸ªå¸¸è§çš„é”™è¯¯, <code>world.txt</code> æœ€ç»ˆä¼šåœ¨ <code>/app</code> ç›®å½•ä¸‹, è€Œä¸æ˜¯æœŸæœ›çš„ <code>/app/demo</code> ç›®å½•</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>WORKDIR</span><span style=color:#48b685> /app</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>RUN</span> mkdir demo <span style=color:#5bc4bf>&amp;&amp;</span> cd demo<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>RUN</span> echo <span style=color:#48b685>&#34;hello&#34;</span> &gt; world.txt<span style=color:#ef6155>
</span></span></span></code></pre></div><p>ä¸Šè¿°éœ€æ±‚å¯ä»¥è¿›è¡Œå¦‚ä¸‹ä¼˜åŒ–, æ¨èä½¿ç”¨ç¬¬äºŒç§å†™æ³•</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>WORKDIR</span><span style=color:#48b685> /app/demo</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>RUN</span> echo <span style=color:#48b685>&#34;hello&#34;</span> &gt; world.txt<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#776e71># æˆ–è€…</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>WORKDIR</span><span style=color:#48b685> /app</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>RUN</span> mkdir demo <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>    <span style=color:#5bc4bf>&amp;&amp;</span> echo <span style=color:#48b685>&#34;hello&#34;</span> &gt; demo/world.txt<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#776e71># æˆ–è€…</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>WORKDIR</span><span style=color:#48b685> /app</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>RUN</span> mkdir demo <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>    <span style=color:#5bc4bf>&amp;&amp;</span> cd demo <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>    <span style=color:#5bc4bf>&amp;&amp;</span> echo <span style=color:#48b685>&#34;hello&#34;</span> &gt; demo/world.txt<span style=color:#ef6155>
</span></span></span></code></pre></div><p>å¦‚æœä½ çš„ <code>WORKDIR</code> æŒ‡ä»¤ä½¿ç”¨çš„ç›¸å¯¹è·¯å¾„, é‚£ä¹ˆæ‰€åˆ‡æ¢çš„è·¯å¾„ä¸ä¹‹å‰çš„ <code>WORKDIR</code> æœ‰å…³</p><p>å¦‚ä¸‹ç¤ºä¾‹, <code>pwd</code> çš„è¾“å‡ºå°†ä¼šæ˜¯ <code>/a/b/c</code></p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>WORKDIR</span><span style=color:#48b685> /a</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>WORKDIR</span><span style=color:#48b685> b</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>WORKDIR</span><span style=color:#48b685> c</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>RUN</span> pwd<span style=color:#ef6155>
</span></span></span></code></pre></div><h2 id=12-user-æŒ‡å®šå½“å‰ç”¨æˆ·>12 USER æŒ‡å®šå½“å‰ç”¨æˆ·<a hidden class=anchor aria-hidden=true href=#12-user-æŒ‡å®šå½“å‰ç”¨æˆ·>#</a></h2><p>æ ¼å¼ï¼š<code>USER &lt;ç”¨æˆ·å>[:&lt;ç”¨æˆ·ç»„>]</code></p><p><code>USER</code> æŒ‡ä»¤å’Œ <code>WORKDIR</code> ç›¸ä¼¼, éƒ½æ˜¯æ”¹å˜ç¯å¢ƒçŠ¶æ€å¹¶å½±å“ä»¥åçš„å±‚. <code>WORKDIR</code> æ˜¯æ”¹å˜å·¥ä½œç›®å½•, <code>USER</code> åˆ™æ˜¯æ”¹å˜ä¹‹åå±‚çš„æ‰§è¡Œ <code>RUN</code>, <code>CMD</code> ä»¥åŠ <code>ENTRYPOINT</code> è¿™ç±»å‘½ä»¤çš„èº«ä»½.</p><p>æ³¨æ„, <code>USER</code> åªæ˜¯å¸®åŠ©ä½ åˆ‡æ¢åˆ°æŒ‡å®šç”¨æˆ·è€Œå·², è¿™ä¸ªç”¨æˆ·å¿…é¡»æ˜¯äº‹å…ˆå»ºç«‹å¥½çš„, å¦åˆ™æ— æ³•åˆ‡æ¢.</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>RUN</span> groupadd -r redis <span style=color:#5bc4bf>&amp;&amp;</span> useradd -r -g redis redis<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>USER</span><span style=color:#48b685> redis</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>RUN</span> <span style=color:#5bc4bf>[</span> <span style=color:#48b685>&#34;redis-server&#34;</span> <span style=color:#5bc4bf>]</span><span style=color:#ef6155>
</span></span></span></code></pre></div><p>å¦‚æœä»¥ <code>root</code> æ‰§è¡Œçš„è„šæœ¬, åœ¨æ‰§è¡ŒæœŸé—´å¸Œæœ›æ”¹å˜èº«ä»½, æ¯”å¦‚å¸Œæœ›ä»¥æŸä¸ªå·²ç»å»ºç«‹å¥½çš„ç”¨æˆ·æ¥è¿è¡ŒæŸä¸ªæœåŠ¡è¿›ç¨‹, ä¸è¦ä½¿ç”¨ <code>su</code> æˆ–è€… <code>sudo</code>, è¿™äº›éƒ½éœ€è¦æ¯”è¾ƒéº»çƒ¦çš„é…ç½®, è€Œä¸”åœ¨ TTY ç¼ºå¤±çš„ç¯å¢ƒä¸‹ç»å¸¸å‡ºé”™. å»ºè®®ä½¿ç”¨ <a href=https://github.com/tianon/gosu target=_blank rel=noopener style=color:#42b983 ;>gosu</a></p><p>ä¸è¿‡æ›´æ¨èçš„è¿˜æ˜¯ <a href=#6-entrypoint-%e5%85%a5%e5%8f%a3%e7%82%b9>ä¸Šæ–‡</a> ä¸­æåˆ°è¿‡çš„é€šè¿‡ <code>ENTRYPOINT</code> è„šæœ¬çš„æ–¹å¼</p><p>ä½¿ç”¨ <code>gosu</code> ç¤ºä¾‹</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#776e71># å»ºç«‹ redis ç”¨æˆ·, å¹¶ä½¿ç”¨ gosu æ¢å¦ä¸€ä¸ªç”¨æˆ·æ‰§è¡Œå‘½ä»¤</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>RUN</span> groupadd -r redis <span style=color:#5bc4bf>&amp;&amp;</span> useradd -r -g redis redis<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#776e71># ä¸‹è½½ gosu</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>RUN</span> wget -O /usr/local/bin/gosu <span style=color:#48b685>&#34;https://github.com/tianon/gosu/releases/download/1.12/gosu-amd64&#34;</span> <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>    <span style=color:#5bc4bf>&amp;&amp;</span> chmod +x /usr/local/bin/gosu <span style=color:#f99b15>\
</span></span></span><span style=display:flex><span><span style=color:#f99b15></span>    <span style=color:#5bc4bf>&amp;&amp;</span> gosu nobody true<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#776e71># è®¾ç½® CMD, å¹¶ä»¥å¦å¤–çš„ç”¨æˆ·æ‰§è¡Œ</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>CMD</span> [ <span style=color:#48b685>&#34;exec&#34;</span>,  <span style=color:#48b685>&#34;gosu&#34;</span>,  <span style=color:#48b685>&#34;redis&#34;</span>,  <span style=color:#48b685>&#34;redis-server&#34;</span> ]<span style=color:#ef6155>
</span></span></span></code></pre></div><h2 id=13-healthcheck-å¥åº·æ£€æŸ¥>13 HEALTHCHECK å¥åº·æ£€æŸ¥<a hidden class=anchor aria-hidden=true href=#13-healthcheck-å¥åº·æ£€æŸ¥>#</a></h2><p>æ ¼å¼ï¼š</p><ul><li><code>HEALTHCHECK [é€‰é¡¹] CMD &lt;å‘½ä»¤></code>ï¼šè®¾ç½®æ£€æŸ¥å®¹å™¨å¥åº·çŠ¶å†µçš„å‘½ä»¤</li><li><code>HEALTHCHECK NONE</code>ï¼šå¦‚æœåŸºç¡€é•œåƒæœ‰å¥åº·æ£€æŸ¥æŒ‡ä»¤, ä½¿ç”¨è¿™è¡Œå¯ä»¥å±è”½æ‰å…¶å¥åº·æ£€æŸ¥æŒ‡ä»¤</li></ul><p><code>HEALTHCHECK</code> æŒ‡ä»¤æ˜¯å‘Šè¯‰ Docker åº”è¯¥å¦‚ä½•è¿›è¡Œåˆ¤æ–­å®¹å™¨çš„çŠ¶æ€æ˜¯å¦æ­£å¸¸, è¿™æ˜¯ Docker 1.12 å¼•å…¥çš„æ–°æŒ‡ä»¤.</p><p>åœ¨æ²¡æœ‰ <code>HEALTHCHECK</code> æŒ‡ä»¤å‰, Docker å¼•æ“åªå¯ä»¥é€šè¿‡å®¹å™¨å†…ä¸»è¿›ç¨‹æ˜¯å¦é€€å‡ºæ¥åˆ¤æ–­å®¹å™¨æ˜¯å¦çŠ¶æ€å¼‚å¸¸. å¾ˆå¤šæƒ…å†µä¸‹è¿™æ²¡é—®é¢˜, ä½†æ˜¯å¦‚æœç¨‹åºè¿›å…¥æ­»é”çŠ¶æ€, æˆ–è€…æ­»å¾ªç¯çŠ¶æ€, åº”ç”¨è¿›ç¨‹å¹¶ä¸é€€å‡º, ä½†æ˜¯è¯¥å®¹å™¨å·²ç»æ— æ³•æä¾›æœåŠ¡äº†. åœ¨ 1.12 ä»¥å‰, Docker ä¸ä¼šæ£€æµ‹åˆ°å®¹å™¨çš„è¿™ç§çŠ¶æ€, ä»è€Œä¸ä¼šé‡æ–°è°ƒåº¦, å¯¼è‡´å¯èƒ½ä¼šæœ‰éƒ¨åˆ†å®¹å™¨å·²ç»æ— æ³•æä¾›æœåŠ¡äº†å´è¿˜åœ¨æ¥å—ç”¨æˆ·è¯·æ±‚.</p><p><code>HEALTHCHECK</code> æ”¯æŒä¸‹åˆ—é€‰é¡¹ï¼š</p><ul><li><code>--interval=&lt;é—´éš”></code>ï¼šä¸¤æ¬¡å¥åº·æ£€æŸ¥çš„é—´éš”, é»˜è®¤ä¸º 30 ç§’ï¼›</li><li><code>--timeout=&lt;æ—¶é•¿></code>ï¼šå¥åº·æ£€æŸ¥å‘½ä»¤è¿è¡Œè¶…æ—¶æ—¶é—´, å¦‚æœè¶…è¿‡è¿™ä¸ªæ—¶é—´, æœ¬æ¬¡å¥åº·æ£€æŸ¥å°±è¢«è§†ä¸ºå¤±è´¥, é»˜è®¤ 30 ç§’ï¼›</li><li><code>--retries=&lt;æ¬¡æ•°></code>ï¼šå½“è¿ç»­å¤±è´¥æŒ‡å®šæ¬¡æ•°å, åˆ™å°†å®¹å™¨çŠ¶æ€è§†ä¸º <code>unhealthy</code>, é»˜è®¤ 3 æ¬¡.</li></ul><p>å’Œ <code>CMD</code>, <code>ENTRYPOINT</code> ä¸€æ ·, <code>HEALTHCHECK</code> åªå¯ä»¥å‡ºç°ä¸€æ¬¡, å¦‚æœå†™äº†å¤šä¸ª, åªæœ‰æœ€åä¸€ä¸ªç”Ÿæ•ˆ.</p><p>åœ¨ <code>HEALTHCHECK [é€‰é¡¹] CMD</code> åé¢çš„å‘½ä»¤, æ ¼å¼å’Œ <code>ENTRYPOINT</code> ä¸€æ ·, åˆ†ä¸º <code>shell</code> æ ¼å¼, å’Œ <code>exec</code> æ ¼å¼. å‘½ä»¤çš„è¿”å›å€¼å†³å®šäº†è¯¥æ¬¡å¥åº·æ£€æŸ¥çš„æˆåŠŸä¸å¦ï¼š</p><ul><li><code>0</code>ï¼šæˆåŠŸï¼›</li><li><code>1</code>ï¼šå¤±è´¥ï¼›</li><li><code>2</code>ï¼šä¿ç•™, ä¸è¦ä½¿ç”¨è¿™ä¸ªå€¼.</li></ul><p>å¦‚ä¸‹ç¤ºä¾‹, å‡è®¾æˆ‘ä»¬æœ‰ä¸ªé•œåƒæ˜¯ä¸ªæœ€ç®€å•çš„ Web æœåŠ¡, æˆ‘ä»¬å¸Œæœ›å¢åŠ å¥åº·æ£€æŸ¥æ¥åˆ¤æ–­å…¶ Web æœåŠ¡æ˜¯å¦åœ¨æ­£å¸¸å·¥ä½œ, æˆ‘ä»¬å¯ä»¥ç”¨ <code>curl</code> æ¥å¸®åŠ©åˆ¤æ–­</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>FROM</span><span style=color:#48b685> nginx</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155>HEALTHCHECK --interval=5s --timeout=3s --retries=3\
</span></span></span><span style=display:flex><span><span style=color:#ef6155>  </span><span style=color:#815ba4>CMD</span> curl -fs http://localhost/ <span style=color:#5bc4bf>||</span> exit <span style=color:#f99b15>1</span><span style=color:#ef6155>
</span></span></span></code></pre></div><p>æ„å»ºè¿è¡Œ</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@lvbibir learn<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker build -t myweb .</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@lvbibir learn<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker run -d --name demo-myweb -p 800:80 myweb</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># æ­¤æ—¶æ˜¯ starting çŠ¶æ€</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@lvbibir learn<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker ps | grep myweb</span>
</span></span><span style=display:flex><span>e6f585df60a6   myweb  <span style=color:#48b685>&#34;/docker-entrypoint.â€¦&#34;</span>   About a minute ago   Up <span style=color:#f99b15>2</span> seconds <span style=color:#5bc4bf>(</span>health: starting<span style=color:#5bc4bf>)</span>   0.0.0.0:800-&gt;80/tcp  demo-myweb
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># ç­‰å¾…å‡ ç§’å˜ä¸º healthy çŠ¶æ€</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@lvbibir learn<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker ps | grep myweb</span>
</span></span><span style=display:flex><span>e6f585df60a6 myweb <span style=color:#48b685>&#34;/docker-entrypoint.â€¦&#34;</span>   <span style=color:#f99b15>2</span> minutes ago Up About a minute <span style=color:#5bc4bf>(</span>healthy<span style=color:#5bc4bf>)</span>  0.0.0.0:800-&gt;80/tcp  demo-myweb
</span></span></code></pre></div><p>åˆ é™¤ <code>index.html</code> æ–‡ä»¶æ¨¡æ‹Ÿæ•…éšœ</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@lvbibir learn<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker exec -it demo-myweb rm -f /usr/share/nginx/html/index.html</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># çŠ¶æ€å˜ä¸ºunhealthy</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@lvbibir learn<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker ps | grep myweb</span>
</span></span><span style=display:flex><span>e6f585df60a6  myweb  <span style=color:#48b685>&#34;/docker-entrypoint.â€¦&#34;</span>   <span style=color:#f99b15>6</span> minutes ago   Up <span style=color:#f99b15>5</span> minutes <span style=color:#5bc4bf>(</span>unhealthy<span style=color:#5bc4bf>)</span>  0.0.0.0:800-&gt;80/tcp   demo-myweb
</span></span></code></pre></div><p>ä¸ºäº†å¸®åŠ©æ’éšœ, å¥åº·æ£€æŸ¥å‘½ä»¤çš„è¾“å‡ºï¼ˆåŒ…æ‹¬ <code>stdout</code> ä»¥åŠ <code>stderr</code>ï¼‰éƒ½ä¼šè¢«å­˜å‚¨äºå¥åº·çŠ¶æ€é‡Œ, å¯ä»¥ç”¨ <code>docker inspect</code> æ¥æŸ¥çœ‹.</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@lvbibir learn<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker inspect --format &#39;{{json .State.Health}}&#39; demo-myweb | python -m json.tool</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#48b685>&#34;FailingStreak&#34;</span>: 25, 
</span></span><span style=display:flex><span>    <span style=color:#48b685>&#34;Log&#34;</span>: <span style=color:#5bc4bf>[</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>            <span style=color:#48b685>&#34;End&#34;</span>: <span style=color:#48b685>&#34;2023-04-10T14:41:51.393698555+08:00&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#48b685>&#34;ExitCode&#34;</span>: 1, 
</span></span><span style=display:flex><span>            <span style=color:#48b685>&#34;Output&#34;</span>: <span style=color:#48b685>&#34;&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#48b685>&#34;Start&#34;</span>: <span style=color:#48b685>&#34;2023-04-10T14:41:51.285647058+08:00&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>}</span>, 
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>            <span style=color:#48b685>&#34;End&#34;</span>: <span style=color:#48b685>&#34;2023-04-10T14:41:56.504282619+08:00&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#48b685>&#34;ExitCode&#34;</span>: 1, 
</span></span><span style=display:flex><span>            <span style=color:#48b685>&#34;Output&#34;</span>: <span style=color:#48b685>&#34;&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#48b685>&#34;Start&#34;</span>: <span style=color:#48b685>&#34;2023-04-10T14:41:56.401745529+08:00&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>}</span>, 
</span></span><span style=display:flex><span>...........
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>]</span>, 
</span></span><span style=display:flex><span>    <span style=color:#48b685>&#34;Status&#34;</span>: <span style=color:#48b685>&#34;unhealthy&#34;</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span></code></pre></div><p>æ¢å¤æ–‡ä»¶</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@lvbibir learn<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker exec -it demo-myweb /bin/bash</span>
</span></span><span style=display:flex><span>root@e6f585df60a6:/# echo test &gt; /usr/share/nginx/html/index.html
</span></span><span style=display:flex><span>root@e6f585df60a6:/#
</span></span><span style=display:flex><span>exit
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@lvbibir learn<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker inspect --format &#39;{{json .State.Health}}&#39; demo-myweb | python -m json.tool</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#48b685>&#34;FailingStreak&#34;</span>: 0, 
</span></span><span style=display:flex><span>    <span style=color:#48b685>&#34;Log&#34;</span>: <span style=color:#5bc4bf>[</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>            <span style=color:#48b685>&#34;End&#34;</span>: <span style=color:#48b685>&#34;2023-04-10T14:48:30.482498808+08:00&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#48b685>&#34;ExitCode&#34;</span>: 0, 
</span></span><span style=display:flex><span>            <span style=color:#48b685>&#34;Output&#34;</span>: <span style=color:#48b685>&#34;test\n&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#48b685>&#34;Start&#34;</span>: <span style=color:#48b685>&#34;2023-04-10T14:48:30.378197999+08:00&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>}</span>, 
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>            <span style=color:#48b685>&#34;End&#34;</span>: <span style=color:#48b685>&#34;2023-04-10T14:48:35.599150547+08:00&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#48b685>&#34;ExitCode&#34;</span>: 0, 
</span></span><span style=display:flex><span>            <span style=color:#48b685>&#34;Output&#34;</span>: <span style=color:#48b685>&#34;test\n&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#48b685>&#34;Start&#34;</span>: <span style=color:#48b685>&#34;2023-04-10T14:48:35.490433323+08:00&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>}</span>, 
</span></span><span style=display:flex><span>.......
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>]</span>, 
</span></span><span style=display:flex><span>    <span style=color:#48b685>&#34;Status&#34;</span>: <span style=color:#48b685>&#34;healthy&#34;</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span></code></pre></div><h2 id=14-onbuild-ä¸ºä»–äººä½œå«è¡£è£³>14 ONBUILD ä¸ºä»–äººä½œå«è¡£è£³<a hidden class=anchor aria-hidden=true href=#14-onbuild-ä¸ºä»–äººä½œå«è¡£è£³>#</a></h2><p>æ ¼å¼ï¼š<code>ONBUILD &lt;å…¶å®ƒæŒ‡ä»¤></code>.</p><p><code>ONBUILD</code> æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æŒ‡ä»¤, å®ƒåé¢è·Ÿçš„æ˜¯å…¶å®ƒæŒ‡ä»¤, æ¯”å¦‚ <code>RUN</code>, <code>COPY</code> ç­‰, è€Œè¿™äº›æŒ‡ä»¤, åœ¨å½“å‰é•œåƒæ„å»ºæ—¶å¹¶ä¸ä¼šè¢«æ‰§è¡Œ. åªæœ‰å½“ä»¥å½“å‰é•œåƒä¸ºåŸºç¡€é•œåƒ, å»æ„å»ºä¸‹ä¸€çº§é•œåƒçš„æ—¶å€™æ‰ä¼šè¢«æ‰§è¡Œ.</p><p><code>Dockerfile</code> ä¸­çš„å…¶å®ƒæŒ‡ä»¤éƒ½æ˜¯ä¸ºäº†å®šåˆ¶å½“å‰é•œåƒè€Œå‡†å¤‡çš„, å”¯æœ‰ <code>ONBUILD</code> æ˜¯ä¸ºäº†å¸®åŠ©åˆ«äººå®šåˆ¶è‡ªå·±è€Œå‡†å¤‡çš„.</p><p>å‡è®¾æˆ‘ä»¬è¦åˆ¶ä½œ Node.js æ‰€å†™çš„åº”ç”¨çš„é•œåƒ. æˆ‘ä»¬éƒ½çŸ¥é“ Node.js ä½¿ç”¨ <code>npm</code> è¿›è¡ŒåŒ…ç®¡ç†, æ‰€æœ‰ä¾èµ–ã€é…ç½®ã€å¯åŠ¨ä¿¡æ¯ç­‰ä¼šæ”¾åˆ° <code>package.json</code> æ–‡ä»¶é‡Œ. åœ¨æ‹¿åˆ°ç¨‹åºä»£ç å, éœ€è¦å…ˆè¿›è¡Œ <code>npm install</code> æ‰å¯ä»¥è·å¾—æ‰€æœ‰éœ€è¦çš„ä¾èµ–. ç„¶åå°±å¯ä»¥é€šè¿‡ <code>npm start</code> æ¥å¯åŠ¨åº”ç”¨. å› æ­¤, ä¸€èˆ¬æ¥è¯´ä¼šè¿™æ ·å†™ <code>Dockerfile</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>FROM</span><span style=color:#48b685> node:slim</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>WORKDIR</span><span style=color:#48b685> /app</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>COPY</span> ./package.json /app<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>RUN</span> <span style=color:#5bc4bf>[</span> <span style=color:#48b685>&#34;npm&#34;</span>,  <span style=color:#48b685>&#34;install&#34;</span> <span style=color:#5bc4bf>]</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>COPY</span> . /app/<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>CMD</span> [ <span style=color:#48b685>&#34;npm&#34;</span>,  <span style=color:#48b685>&#34;start&#34;</span> ]<span style=color:#ef6155>
</span></span></span></code></pre></div><p>æŠŠè¿™ä¸ª <code>Dockerfile</code> æ”¾åˆ° Node.js é¡¹ç›®çš„æ ¹ç›®å½•, æ„å»ºå¥½é•œåƒå, å°±å¯ä»¥ç›´æ¥æ‹¿æ¥å¯åŠ¨å®¹å™¨è¿è¡Œ. ä½†æ˜¯å¦‚æœæˆ‘ä»¬è¿˜æœ‰ç¬¬äºŒä¸ª Node.js é¡¹ç›®ä¹Ÿå·®ä¸å¤šå‘¢ï¼Ÿå¥½å§, é‚£å°±å†æŠŠè¿™ä¸ª <code>Dockerfile</code> å¤åˆ¶åˆ°ç¬¬äºŒä¸ªé¡¹ç›®é‡Œ. é‚£å¦‚æœæœ‰ç¬¬ä¸‰ä¸ªé¡¹ç›®å‘¢ï¼Ÿå†å¤åˆ¶ä¹ˆï¼Ÿæ–‡ä»¶çš„å‰¯æœ¬è¶Šå¤š, ç‰ˆæœ¬æ§åˆ¶å°±è¶Šå›°éš¾, è®©æˆ‘ä»¬ç»§ç»­çœ‹è¿™æ ·çš„åœºæ™¯ç»´æŠ¤çš„é—®é¢˜.</p><p>å¦‚æœç¬¬ä¸€ä¸ª Node.js é¡¹ç›®åœ¨å¼€å‘è¿‡ç¨‹ä¸­, å‘ç°è¿™ä¸ª <code>Dockerfile</code> é‡Œå­˜åœ¨é—®é¢˜, æ¯”å¦‚æ•²é”™å­—äº†ã€æˆ–è€…éœ€è¦å®‰è£…é¢å¤–çš„åŒ…, ç„¶åå¼€å‘äººå‘˜ä¿®å¤äº†è¿™ä¸ª <code>Dockerfile</code>, å†æ¬¡æ„å»º, é—®é¢˜è§£å†³. ç¬¬ä¸€ä¸ªé¡¹ç›®æ²¡é—®é¢˜äº†, ä½†æ˜¯ç¬¬äºŒä¸ªé¡¹ç›®å‘¢ï¼Ÿè™½ç„¶æœ€åˆ <code>Dockerfile</code> æ˜¯å¤åˆ¶ã€ç²˜è´´è‡ªç¬¬ä¸€ä¸ªé¡¹ç›®çš„, ä½†æ˜¯å¹¶ä¸ä¼šå› ä¸ºç¬¬ä¸€ä¸ªé¡¹ç›®ä¿®å¤äº†ä»–ä»¬çš„ <code>Dockerfile</code>, è€Œç¬¬äºŒä¸ªé¡¹ç›®çš„ <code>Dockerfile</code> å°±ä¼šè¢«è‡ªåŠ¨ä¿®å¤.</p><p>é‚£ä¹ˆæˆ‘ä»¬å¯ä¸å¯ä»¥åšä¸€ä¸ªåŸºç¡€é•œåƒ, ç„¶åå„ä¸ªé¡¹ç›®ä½¿ç”¨è¿™ä¸ªåŸºç¡€é•œåƒå‘¢ï¼Ÿè¿™æ ·åŸºç¡€é•œåƒæ›´æ–°, å„ä¸ªé¡¹ç›®ä¸ç”¨åŒæ­¥ <code>Dockerfile</code> çš„å˜åŒ–, é‡æ–°æ„å»ºåå°±ç»§æ‰¿äº†åŸºç¡€é•œåƒçš„æ›´æ–°ï¼Ÿå¥½å§, å¯ä»¥, è®©æˆ‘ä»¬çœ‹çœ‹è¿™æ ·çš„ç»“æœ.</p><p>åŸºç¡€é•œåƒ (my-node) <code>Dockerfile</code></p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>FROM</span><span style=color:#48b685> node:slim</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>WORKDIR</span><span style=color:#48b685> /app</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>CMD</span> [ <span style=color:#48b685>&#34;npm&#34;</span>,  <span style=color:#48b685>&#34;start&#34;</span> ]<span style=color:#ef6155>
</span></span></span></code></pre></div><p>åº”ç”¨é•œåƒ (my-app1) <code>Dockerfile</code></p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>FROM</span><span style=color:#48b685> my-node</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>COPY</span> ./package.json /app<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>RUN</span> <span style=color:#5bc4bf>[</span> <span style=color:#48b685>&#34;npm&#34;</span>,  <span style=color:#48b685>&#34;install&#34;</span> <span style=color:#5bc4bf>]</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>COPY</span> . /app/<span style=color:#ef6155>
</span></span></span></code></pre></div><p>åŸºç¡€é•œåƒå˜åŒ–å, å„ä¸ªé¡¹ç›®éƒ½ç”¨è¿™ä¸ª <code>Dockerfile</code> é‡æ–°æ„å»ºé•œåƒ, ä¼šç»§æ‰¿åŸºç¡€é•œåƒçš„æ›´æ–°.</p><p>é‚£ä¹ˆ, é—®é¢˜è§£å†³äº†ä¹ˆï¼Ÿæ²¡æœ‰. å‡†ç¡®è¯´, åªè§£å†³äº†ä¸€åŠ. å¦‚æœè¿™ä¸ª <code>Dockerfile</code> é‡Œé¢æœ‰äº›ä¸œè¥¿éœ€è¦è°ƒæ•´å‘¢ï¼Ÿæ¯”å¦‚ <code>npm install</code> éƒ½éœ€è¦åŠ ä¸€äº›å‚æ•°, é‚£æ€ä¹ˆåŠï¼Ÿè¿™ä¸€è¡Œ <code>RUN</code> æ˜¯ä¸å¯èƒ½æ”¾å…¥åŸºç¡€é•œåƒçš„, å› ä¸ºæ¶‰åŠåˆ°äº†å½“å‰é¡¹ç›®çš„ <code>./package.json</code>, éš¾é“åˆè¦ä¸€ä¸ªä¸ªä¿®æ”¹ä¹ˆï¼Ÿæ‰€ä»¥è¯´, è¿™æ ·åˆ¶ä½œåŸºç¡€é•œåƒ, åªè§£å†³äº†åŸæ¥çš„ <code>Dockerfile</code> çš„å‰ 4 æ¡æŒ‡ä»¤çš„å˜åŒ–é—®é¢˜, è€Œåé¢ä¸‰æ¡æŒ‡ä»¤çš„å˜åŒ–åˆ™å®Œå…¨æ²¡åŠæ³•å¤„ç†.</p><p><code>ONBUILD</code> å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜. è®©æˆ‘ä»¬ç”¨ <code>ONBUILD</code> é‡æ–°å†™ä¸€ä¸‹åŸºç¡€é•œåƒçš„ <code>Dockerfile</code>:</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>FROM</span><span style=color:#48b685> node:slim</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>WORKDIR</span><span style=color:#48b685> /app</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>ONBUILD</span> <span style=color:#815ba4>COPY</span> ./package.json /app<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>ONBUILD</span> <span style=color:#815ba4>RUN</span> <span style=color:#5bc4bf>[</span> <span style=color:#48b685>&#34;npm&#34;</span>,  <span style=color:#48b685>&#34;install&#34;</span> <span style=color:#5bc4bf>]</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>ONBUILD</span> <span style=color:#815ba4>COPY</span> . /app/<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>CMD</span> [ <span style=color:#48b685>&#34;npm&#34;</span>,  <span style=color:#48b685>&#34;start&#34;</span> ]<span style=color:#ef6155>
</span></span></span></code></pre></div><p>åº”ç”¨é•œåƒ <code>Dcokerfile</code></p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>FROM</span><span style=color:#48b685> my-node</span><span style=color:#ef6155>
</span></span></span></code></pre></div><p>æ˜¯çš„, åªæœ‰è¿™ä¹ˆä¸€è¡Œ. å½“åœ¨å„ä¸ªé¡¹ç›®ç›®å½•ä¸­, ç”¨è¿™ä¸ªåªæœ‰ä¸€è¡Œçš„ <code>Dockerfile</code> æ„å»ºé•œåƒæ—¶, ä¹‹å‰åŸºç¡€é•œåƒçš„é‚£ä¸‰è¡Œ <code>ONBUILD</code> å°±ä¼šå¼€å§‹æ‰§è¡Œ, æˆåŠŸçš„å°†å½“å‰é¡¹ç›®çš„ä»£ç å¤åˆ¶è¿›é•œåƒã€å¹¶ä¸”é’ˆå¯¹æœ¬é¡¹ç›®æ‰§è¡Œ <code>npm install</code>, ç”Ÿæˆåº”ç”¨é•œåƒ.</p><h2 id=15-label-ä¸ºé•œåƒæ·»åŠ å…ƒæ•°æ®>15 LABEL ä¸ºé•œåƒæ·»åŠ å…ƒæ•°æ®<a hidden class=anchor aria-hidden=true href=#15-label-ä¸ºé•œåƒæ·»åŠ å…ƒæ•°æ®>#</a></h2><p><code>LABEL</code> æŒ‡ä»¤ç”¨æ¥ç»™é•œåƒä»¥é”®å€¼å¯¹çš„å½¢å¼æ·»åŠ ä¸€äº›å…ƒæ•°æ®ï¼ˆmetadataï¼‰.</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>LABEL</span> &lt;key&gt;<span style=color:#5bc4bf>=</span>&lt;value&gt; &lt;key&gt;<span style=color:#5bc4bf>=</span>&lt;value&gt; &lt;key&gt;<span style=color:#5bc4bf>=</span>&lt;value&gt; ...<span style=color:#ef6155>
</span></span></span></code></pre></div><p>æˆ‘ä»¬è¿˜å¯ä»¥ç”¨ä¸€äº›æ ‡ç­¾æ¥ç”³æ˜é•œåƒçš„ä½œè€…ã€æ–‡æ¡£åœ°å€ç­‰ï¼š</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>LABEL</span> org.opencontainers.image.authors<span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;yeasy&#34;</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>LABEL</span> org.opencontainers.image.documentation<span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;https://yeasy.gitbooks.io&#34;</span><span style=color:#ef6155>
</span></span></span></code></pre></div><p>å…·ä½“å¯ä»¥å‚è€ƒ <a href=https://github.com/opencontainers/image-spec/blob/master/annotations.md target=_blank rel=noopener style=color:#42b983 ;>https://github.com/opencontainers/image-spec/blob/master/annotations.md</a></p><h2 id=16-shell-æŒ‡å®š-shell>16 SHELL æŒ‡å®š shell<a hidden class=anchor aria-hidden=true href=#16-shell-æŒ‡å®š-shell>#</a></h2><p>æ ¼å¼ï¼š<code>SHELL ["executable", "parameters"]</code></p><p><code>SHELL</code> æŒ‡ä»¤å¯ä»¥æŒ‡å®š <code>RUN</code> <code>ENTRYPOINT</code> <code>CMD</code> æŒ‡ä»¤çš„ shell, Linux ä¸­é»˜è®¤ä¸º `["/bin/sh", &ldquo;-c&rdquo;]</p><p>å¦‚ä¸‹ç¤ºä¾‹, ä¸¤ä¸ª <code>RUN</code> è¿è¡ŒåŒä¸€å‘½ä»¤, ç¬¬äºŒä¸ª <code>RUN</code> è¿è¡Œçš„å‘½ä»¤ä¼šæ‰“å°å‡ºæ¯æ¡å‘½ä»¤å¹¶å½“é‡åˆ°é”™è¯¯æ—¶é€€å‡º.</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>SHELL</span> [<span style=color:#48b685>&#34;/bin/sh&#34;</span>,  <span style=color:#48b685>&#34;-c&#34;</span>]<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>RUN</span> lll ; ls<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>SHELL</span> [<span style=color:#48b685>&#34;/bin/sh&#34;</span>,  <span style=color:#48b685>&#34;-cex&#34;</span>]<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>RUN</span> lll ; ls<span style=color:#ef6155>
</span></span></span></code></pre></div><p>å¦‚ä¸‹ç¤ºä¾‹, å½“ <code>ENTRYPOINT</code> <code>CMD</code> ä»¥ shell æ ¼å¼æŒ‡å®šæ—¶, <code>SHELL</code> æŒ‡ä»¤æ‰€æŒ‡å®šçš„ shell ä¹Ÿä¼šæˆä¸ºè¿™ä¸¤ä¸ªæŒ‡ä»¤çš„ shell</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#815ba4>SHELL</span> [<span style=color:#48b685>&#34;/bin/sh&#34;</span>,  <span style=color:#48b685>&#34;-cex&#34;</span>]<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#776e71># /bin/sh -cex &#34;nginx&#34;</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>ENTRYPOINT</span> nginx<span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#776e71># /bin/sh -cex &#34;nginx&#34;</span><span style=color:#ef6155>
</span></span></span><span style=display:flex><span><span style=color:#ef6155></span><span style=color:#815ba4>CMD</span> nginx<span style=color:#ef6155>
</span></span></span></code></pre></div><p>ä»¥ä¸Š</p></div><div class=post-reward><div style=padding:0;margin:0;width:100%;font-size:16px;text-align:center><div id=QR style=opacity:0><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=https://image.lvbibir.cn/blog/wechatpay.png alt=wechat_pay></a><p>å¾®ä¿¡</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=https://image.lvbibir.cn/blog/alipay.png alt=alipay></a><p>æ”¯ä»˜å®</p></div></div><button id=rewardButton onclick="var qr=document.getElementById('QR');qr.style.opacity==='0'?qr.style.opacity='1':qr.style.opacity='0'">
<span>ğŸ§§ é¼“åŠ±</span></button></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://www.lvbibir.cn/posts/tech/docker-dockerfile-optimization/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>docker | dockerfile æœ€ä½³å®è·µ</span></a>
<a class=next href=https://www.lvbibir.cn/posts/tech/linux-command-kill/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>linux | kill å‘½ä»¤è¯¦è§£ä»¥åŠ linux ä¸­çš„ä¿¡å·</span></a></nav></footer></div><div><div class=pagination__title><span class=pagination__title-h style=font-size:20px>ğŸ’¬è¯„è®º</span><hr></div><div id=tcomment></div><script src=https://image.lvbibir.cn/js/twikoo/1.6.44/twikoo.min.js></script><script>twikoo.init({envId:"https://www.lvbibir.cn/twikoo/",el:"#tcomment",lang:'zh-CN',path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><a href=https://gohugo.io/ target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/frame-hugo-blue.svg></a>
<a href=https://github.com/adityatelange/hugo-PaperMod target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/theme-papermod-lightgrey.svg></a>
<a href=https://cn.aliyun.com/ target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/å›¾åºŠ-é˜¿é‡Œäº‘-orange.svg></a><br><span id=runtime_span></span>
<script type=text/javascript>function show_runtime(){window.setTimeout("show_runtime()",1e3),X=new Date("7/13/2021 1:00:00"),Y=new Date,T=Y.getTime()-X.getTime(),M=24*60*60*1e3,a=T/M,A=Math.floor(a),b=(a-A)*24,B=Math.floor(b),c=(b-B)*60,C=Math.floor((b-B)*60),D=Math.floor((c-C)*60),runtime_span.innerHTML="ç½‘ç«™å·²è¿è¡Œ"+A+"å¤©"+B+"å°æ—¶"+C+"åˆ†"+D+"ç§’"}show_runtime()</script>|
<script defer src=https://www.lvbibir.cn/busuanzi/js></script>
<span id=busuanzi_container>æ€»è®¿å®¢æ•°: <span id=busuanzi_site_uv></span>
|
æ€»è®¿é—®é‡: <span id=busuanzi_site_pv></span></span><br><a href=https://beian.miit.gov.cn/ target=_blank style="border-bottom:1px solid">äº¬ICPå¤‡2021023168å·-1</a>&nbsp;
|
<span>Copyright
&copy;
2020-2026
<a href=https://www.lvbibir.cn style="border-bottom:1px solid">lvbibir's Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg><span id=read_progress></span></span></a>
<script>document.addEventListener('scroll',function(){const e=document.getElementById("read_progress"),t=document.documentElement.scrollHeight,n=document.documentElement.clientHeight,s=document.documentElement.scrollTop||document.body.scrollTop;e.innerText=((s/(t-n)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>400||document.documentElement.scrollTop>400?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script><script>document.querySelectorAll('pre > code').forEach(s=>{const n=s.parentNode.parentNode,e=document.createElement('button');e.classList.add('copy-code'),e.innerText='ğŸ“„å¤åˆ¶';function l(){e.innerText='ğŸ‘ŒğŸ»å·²å¤åˆ¶!',setTimeout(()=>{e.innerText='ğŸ“„å¤åˆ¶'},2e3)}e.addEventListener('click',n=>{const e=document.createRange();e.selectNodeContents(s);const t=window.getSelection();t.removeAllRanges(),t.addRange(e);try{document.execCommand('copy'),l()}catch(e){}t.removeRange(e)});let c=s.className.replaceAll("language-",""),t=document.createElement("div"),i=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div"),o=document.createElement("div");o.innerText=c,t.setAttribute('class','mac-tool'),i.setAttribute('class','mac bb1'),a.setAttribute('class','mac bb2'),r.setAttribute('class','mac bb3'),o.setAttribute('class','language-type'),t.appendChild(i),t.appendChild(a),t.appendChild(r),t.appendChild(o),n.classList.contains("highlight")?(n.appendChild(e),n.appendChild(t)):n.parentNode.firstChild===n||(s.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName==="TABLE"?(s.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e),n.appendChild(t)):(s.parentNode.appendChild(e),n.appendChild(t)))})</script></body></html>