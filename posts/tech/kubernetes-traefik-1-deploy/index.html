<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>traefik (一) 简介、部署和配置 | lvbibir's Blog</title><meta name=keywords content="kubernetes,traefik,ingress"><meta name=description content="kubernetes 中 Traefik ingress 的简介、部署及配置。"><meta name=author content="作者:&nbsp;lvbibir"><link rel=canonical href=https://www.lvbibir.cn/posts/tech/kubernetes-traefik-1-deploy/><link crossorigin=anonymous href=/assets/css/stylesheet.ea2d3aa74caabd1c227305342e99c488a04870896b2f729dec906b90f7870787.css integrity="sha256-6i06p0yqvRwicwU0LpnEiKBIcIlrL3Kd7JBrkPeHB4c=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.lvbibir.cn/img/avatar.gif><link rel=icon type=image/png sizes=16x16 href=https://www.lvbibir.cn/img/avatar.gif><link rel=icon type=image/png sizes=32x32 href=https://www.lvbibir.cn/img/avatar.gif><link rel=apple-touch-icon href=https://www.lvbibir.cn/img/avatar.gif><link rel=mask-icon href=https://www.lvbibir.cn/img/avatar.gif><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta property="og:title" content="traefik (一) 简介、部署和配置"><meta property="og:description" content="kubernetes 中 Traefik ingress 的简介、部署及配置。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.lvbibir.cn/posts/tech/kubernetes-traefik-1-deploy/"><meta property="og:image" content="https://image.lvbibir.cn/blog/traefik.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-17T00:00:00+00:00"><meta property="article:modified_time" content="2023-04-17T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://image.lvbibir.cn/blog/traefik.png"><meta name=twitter:title content="traefik (一) 简介、部署和配置"><meta name=twitter:description content="kubernetes 中 Traefik ingress 的简介、部署及配置。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"📚 文章","item":"https://www.lvbibir.cn/posts/"},{"@type":"ListItem","position":3,"name":"👨🏻‍💻 技术","item":"https://www.lvbibir.cn/posts/tech/"},{"@type":"ListItem","position":4,"name":"traefik (一) 简介、部署和配置","item":"https://www.lvbibir.cn/posts/tech/kubernetes-traefik-1-deploy/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"traefik (一) 简介、部署和配置","name":"traefik (一) 简介、部署和配置","description":"kubernetes 中 Traefik ingress 的简介、部署及配置。","keywords":["kubernetes","traefik","ingress"],"articleBody":"0. 前言 基于 centos7.9，docker-ce-20.10.18，kubelet-1.22.3-0， traefik-2.9.10\n参考：https://www.cuiliangblog.cn/detail/section/29427812\n1. 简介 1.1 Traefik 简介 Traefik 是一个为了让部署微服务更加便捷而诞生的现代HTTP反向代理、负载均衡工具。 它支持多种后台 (Docker, Swarm, Kubernetes, Marathon, Mesos, Consul, Etcd, Zookeeper, BoltDB, Rest API, file…) 来自动化、动态的应用它的配置文件设置。\n它是一个边缘路由器，它会拦截外部的请求并根据逻辑规则选择不同的操作方式，这些规则决定着这些请求到底该如何处理。Traefik 提供自动发现能力，会实时检测服务，并自动更新路由规则。\n1.2 Traefik 核心组件 从上图可知，当请求 Traefik 时，请求首先到 entrypoints，然后分析传入的请求，查看他们是否与定义的 Routers 匹配。如果匹配，则会通过一系列 middlewares 处理，再到 traefikServices 上做流量转发，最后请求到 kubernetes的services上 。\n这就涉及到以下几个重要的核心组件:\nProviders 是基础组件，Traefik 的配置发现是通过它来实现的，它可以是协调器，容器引擎，云提供商或者键值存储。Traefik 通过查询 Providers 的 API 来查询路由的相关信息，一旦检测到变化，就会动态的更新路由。 Entrypoints 是 Traefik 的网络入口，它定义接收请求的接口，以及是否监听TCP或者UDP。 Routers 主要用于分析请求，并负责将这些请求连接到对应的服务上去，在这个过程中，Routers还可以使用Middlewares来更新请求，比如在把请求发到服务之前添加一些Headers。 Services 负责配置如何到达最终将处理传入请求的实际服务。 Middlewares 用来修改请求或者根据请求来做出一些判断（authentication, rate limiting, headers, …），中间件被附件到路由上，是一种在请求发送到你的服务之前（或者在服务的响应发送到客户端之前）调整请求的一种方法。 1.3 Traefik CRD资源 参考文档：https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/\ntraefik通过自定义资源实现了对traefik资源的创建和管理，支持的crd资源类型如下所示：\nkind 功能 IngressRoute HTTP路由配置 Middleware HTTP中间件配置 TraefikService HTTP负载均衡/流量复制配置 IngressRouteTCP TCP路由配置 MiddlewareTCP TCP中间件配置 IngressRouteUDP UDP路由配置 TLSOptions TLS连接参数配置 TLSStores TLS存储配置 ServersTransport traefik与后端之间的传输配置 2. Traefik 部署 traefik 是支持 helm 部署的，但是查看 helm 包的 value.yaml 配置发现总共有 500 多行配置，当需要修改配置项或者对 traefik 做一下自定义配置时，并不灵活。如果只是使用 traefik 的基础功能，推荐使用 helm 部署。如果想深入研究使用 traefik 的话，推荐使用自定义方式部署。\n2.1 crd rbac serviceaccount crd\n[root@k8s-node1 ~]# mkdir /opt/traefik [root@k8s-node1 ~]# cd /opt/traefik [root@k8s-node1 traefik]# wget https://raw.githubusercontent.com/traefik/traefik/v2.9/docs/content/reference/dynamic-configuration/kubernetes-crd-definition-v1.yml [root@k8s-node1 traefik]# kubectl apply -f kubernetes-crd-definition-v1.yml rbac\n[root@k8s-node1 traefik]# wget https://raw.githubusercontent.com/traefik/traefik/v2.9/docs/content/reference/dynamic-configuration/kubernetes-crd-rbac.yml [root@k8s-node1 traefik]# kubectl apply -f kubernetes-crd-rbac.yml clusterrole.rbac.authorization.k8s.io/traefik-ingress-controller created clusterrolebinding.rbac.authorization.k8s.io/traefik-ingress-controller created serviceaccount.yml\napiVersion: v1 kind: Namespace metadata: name: traefik --- apiVersion: v1 kind: ServiceAccount metadata: namespace: traefik name: traefik-ingress-controller --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: traefik-ingress-controller roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: traefik-ingress-controller subjects: - kind: ServiceAccount name: traefik-ingress-controller namespace: traefik 2.2 configmap 在 Traefik 中有三种方式定义静态配置：在配置文件中、在命令行参数中、通过环境变量传递，由于 Traefik 配置很多，通过 CLI 定义不是很方便，一般时候选择将其配置选项放到配置文件中，然后存入 ConfigMap，将其挂入 traefik 中。参考文档：https://doc.traefik.io/traefik/getting-started/configuration-overview/\nconfigmap.yml 文件内容：\napiVersion: v1 kind: ConfigMap metadata: name: traefik-config namespace: traefik data: traefik.yaml: |- global: checkNewVersion: false # 周期性的检查是否有新版本发布 sendAnonymousUsage: false # 周期性的匿名发送使用统计信息 serversTransport: insecureSkipVerify: true # Traefik忽略验证代理服务的TLS证书 api: insecure: true # 允许HTTP 方式访问API dashboard: true # 启用Dashboard debug: false # 启用Debug调试模式 metrics: prometheus: # 配置Prometheus监控指标数据，并使用默认配置 addRoutersLabels: true # 添加routers metrics entryPoint: \"metrics\" # 指定metrics监听地址 entryPoints: web: address: \":80\" # 配置80端口，并设置入口名称为 web forwardedHeaders: insecure: true # 信任所有的forward headers websecure: address: \":443\" # 配置443端口，并设置入口名称为 websecure forwardedHeaders: insecure: true traefik: address: \":9000\" # 配置9000端口为 dashboard 的端口，不设置默认值为 8080 metrics: address: \":9100\" # 配置9100端口，作为metrics收集入口 tcpep: address: \":9200\" # 配置9200端口，作为tcp入口 udpep: address: \":9300/udp\" # 配置9300端口，作为udp入口 providers: kubernetesCRD: # 启用Kubernetes CRD方式来配置路由规则 ingressClass: \"\" # 指定traefik的ingressClass名称 allowCrossNamespace: true #允许跨namespace allowEmptyServices: true #允许空endpoints的service log: filePath: \"/etc/traefik/logs/traefik.log\" # 设置调试日志文件存储路径，如果为空则输出到控制台 level: \"DEBUG\" # 设置调试日志级别 format: \"json\" # 设置调试日志格式 accessLog: # filePath: \"/etc/traefik/logs/access.log\" # 设置访问日志文件存储路径，如果为空则输出到 stdout 和 stderr format: \"json\" # 设置访问调试日志格式 bufferingSize: 0 # 设置访问日志缓存行数 fields: # 设置访问日志中的字段是否保留（keep保留、drop不保留） defaultMode: keep # 设置默认保留访问日志字段 names: # 针对访问日志特别字段特别配置保留模式 ClientUsername: drop StartUTC: drop # 禁用日志timestamp使用UTC headers: # 设置Header中字段是否保留 defaultMode: keep # 设置默认保留Header中字段 names: # 针对Header中特别字段特别配置保留模式 # User-Agent: redact# 可以针对指定agent Authorization: drop Content-Type: keep 设置节点 label，用于控制在哪些节点部署 Traefik，这里我们使用 k8s-node1(master) 节点作为边缘节点部署\nkubectl label node k8s-node1 IngressProxy=true 2.3 deployment service 使用 DeamonSet 或者 Deployment 均可，此处使用 Deployment 方式部署 Traefik，调度至含有 IngressProxy=true 的边缘节点\n同时使用 podAntiAffinity 避免多个 traefik 实例运行在同一节点造成单点故障.\nkubectl apply -f deployment.yml\napiVersion: apps/v1 kind: Deployment metadata: name: traefik namespace: traefik labels: app: traefik spec: replicas: 1 selector: matchLabels: app: traefik template: metadata: name: traefik labels: app: traefik spec: affinity: podAntiAffinity: requiredDuringSchedulingIgnoredDuringExecution: - labelSelector: matchExpressions: - key: app operator: In values: - traefik topologyKey: \"kubernetes.io/hostname\" spec: serviceAccountName: traefik-ingress-controller terminationGracePeriodSeconds: 5 # 等待容器优雅退出的时长 tolerations: # 设置容忍所有污点，防止节点被设置污点 - operator: \"Exists\" nodeSelector: # 设置node筛选器，在特定label的节点上启动 IngressProxy: \"true\" # 调度至IngressProxy: \"true\"的节点 containers: - name: traefik image: traefik:v2.9 env: - name: KUBERNETES_SERVICE_HOST # 手动指定k8s api,避免网络组件不稳定。 value: \"1.1.1.1\" - name: KUBERNETES_SERVICE_PORT_HTTPS # API server端口 value: \"6443\" - name: KUBERNETES_SERVICE_PORT # API server端口 value: \"6443\" - name: TZ # 指定时区 value: \"Asia/Shanghai\" ports: - name: web containerPort: 80 - name: websecure containerPort: 443 - name: dashboard containerPort: 9000 # Traefik Dashboard 端口 - name: metrics containerPort: 9100 - name: tcpep containerPort: 9200 # tcp端口 - name: udpep containerPort: 9300 # udp端口 securityContext: # 只开放网络权限 capabilities: drop: - ALL add: - NET_BIND_SERVICE args: - --configfile=/etc/traefik/config/traefik.yaml volumeMounts: - mountPath: /etc/traefik/config name: config - mountPath: /etc/traefik/logs name: logdir - mountPath: /etc/localtime name: timezone readOnly: true resources: requests: memory: \"5Mi\" cpu: \"10m\" limits: memory: \"256Mi\" cpu: \"1000m\" volumes: - name: config # traefik配置文件 configMap: name: traefik-config - name: logdir # traefik日志目录 hostPath: path: /var/log/traefik type: \"DirectoryOrCreate\" - name: timezone # 挂载时区文件 hostPath: path: /etc/localtime type: File service kubectl apply -f service.yml\napiVersion: v1 kind: Service metadata: labels: app: traefik name: traefik # 实际提供服务的 service, 使用 NodePort 模式 namespace: traefik spec: type: NodePort selector: app: traefik ports: - name: web protocol: TCP port: 80 targetPort: 80 nodePort: 80 - name: websecure protocol: TCP port: 443 targetPort: 443 nodePort: 443 - name: dashboard protocol: TCP port: 9000 targetPort: 9000 nodePort: 9000 - name: tcpep protocol: TCP port: 9200 targetPort: 9200 nodePort: 9200 - name: udpep protocol: UDP port: 9300 targetPort: 9300 nodePort: 9300 --- apiVersion: v1 kind: Service metadata: labels: app: traefik-metrics name: traefik-metrics # metrics 用于给集群内的 prometheus 提供数据 namespace: traefik spec: selector: app: traefik ports: - name: metrics protocol: TCP port: 9100 targetPort: 9100 2.4 验证 [root@k8s-node1 traefik]# kubectl get pod,cm,sa,svc -n traefik |grep traefik pod/traefik-69bd67497f-v27qp 1/1 Running 0 12m configmap/traefik-config 1 7d5h serviceaccount/traefik-ingress-controller 1 7d5h service/traefik NodePort 10.101.142.158 80:80/TCP,443:443/TCP,9000:9000/TCP,9200:9200/TCP,9300:9300/UDP 11m service/traefik-metrics ClusterIP 10.98.89.13 9100/TCP 12m 可以直接通过 http://1.1.1.1:9000 访问到 dashboard\n2.5 其他配置 2.5.1 强制使用TLS v1.2+ 如今，TLS v1.0 和 v1.1 因为存在安全问题，现在已被弃用。为了保障系统安全，所有入口路由都应该强制使用TLS v1.2 或更高版本。\n参考文档：https://doc.traefik.io/traefik/user-guides/crd-acme/#force-tls-v12\n[root@k8s-node1 traefik]# tee traefik-tlsoption.yml \u003c\u003c-'EOF' apiVersion: traefik.containo.us/v1alpha1 kind: TLSOption metadata: name: default namespace: traefik spec: minVersion: VersionTLS12 cipherSuites: - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 # TLS 1.2 - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305 # TLS 1.2 - TLS_AES_256_GCM_SHA384 # TLS 1.3 - TLS_CHACHA20_POLY1305_SHA256 # TLS 1.3 curvePreferences: - CurveP521 - CurveP384 sniStrict: true EOF [root@k8s-node1 traefik]# kubectl apply -f traefik-tlsoption.yml tlsoption.traefik.containo.us/default created 2.5.2 日志切割 官方并没有日志轮换的功能，但是traefik收到USR1信号后会重建日志文件，因此可以通过logrotate实现日志轮换\n参考文档：https://doc.traefik.io/traefik/observability/logs/\nmkdir -p /etc/logrotate.d/traefik tee /etc/logrotate.d/traefik/config \u003c\u003c-'EOF' /var/log/traefik/*.log { daily rotate 15 missingok notifempty compress dateext dateyesterday dateformat .%Y-%m-%d create 0644 root root postrotate docker kill --signal=\"USR1\" $(docker ps | grep traefik |grep -v pause| awk '{print $1}') endscript } EOF 创建定时任务\ncrontab -e 0 0 * * * /usr/sbin/logrotate -f /etc/logrotate.d/traefik/config \u003e/dev/null 2\u003e\u00261 2.6 多控制器 有的业务场景下可能需要在一个集群中部署多个 traefik，例如：避免单个traefik配置规则过多导致加载处理缓慢。每个namespace部署一个traefik。或者traefik生产与测试环境区分等场景，需要不同的实例控制不同的 IngressRoute 资源对象，要实现该功能有两种方法\n2.6.1 annotations 注解筛选 参考文档：https://doc.traefik.io/traefik/providers/kubernetes-crd/#ingressclass\n首先在traefik配置文件中的providers下增加Ingressclass参数，指定具体的值\nproviders: kubernetesCRD: # 启用Kubernetes CRD方式来配置路由规则 ingressClass: \"traefik-v2.9\" # 指定traefik的ingressClass实例名称 allowCrossNamespace: true #允许跨namespace allowEmptyServices: true #允许空endpoints的service 接下来在 IngressRoute 资源对象中的 annotations 参数中添加 kubernetes.io/ingress.class: traefik-v2.9 即可\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: dashboard namespace: traefik annotations: kubernetes.io/ingress.class: traefik-v2.9 # 因为静态配置文件指定了ingressclass，所以这里的annotations 要指定，否则访问会404 spec: entryPoints: - web routes: - match: Host(`traefik.test.com`) kind: Rule services: - name: api@internal kind: TraefikService namespace: traefik 2.6.2 label 标签选择器筛选 参考文档：https://doc.traefik.io/traefik/providers/kubernetes-crd/#labelselector\n首先在traefik配置文件中的providers下增加labelSelector参数，指定具体的标签键值。\nproviders: kubernetesCRD: # 启用Kubernetes CRD方式来配置路由规则 # ingressClass: \"traefik-v2.9\" # 指定traefik的ingressClass名称 labelSelector: \"app=traefik-v2.9\" # 通过标签选择器指定traefik标签 allowCrossNamespace: true #允许跨namespace allowEmptyServices: true #允许空endpoints的service 然后在 IngressRoute 资源对象中添加labels标签选择器，选择 app: traefik-v2.9 这个标签即可\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: dashboard labels: # 通过标签选择器，该IngressRoute资源由配置了app=traefik-v2.9的traefik处理 app: traefik-v2.9 # annotations: # kubernetes.io/ingress.class: traefik-v2.9 spec: entryPoints: - web routes: - match: Host(`traefik.test.com`) kind: Rule services: - name: api@internal kind: TraefikService namespace: traefik ","wordCount":"3921","inLanguage":"en","image":"https://image.lvbibir.cn/blog/traefik.png","datePublished":"2023-04-17T00:00:00Z","dateModified":"2023-04-17T00:00:00Z","author":{"@type":"Person","name":"lvbibir"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.lvbibir.cn/posts/tech/kubernetes-traefik-1-deploy/"},"publisher":{"@type":"Organization","name":"lvbibir's Blog","logo":{"@type":"ImageObject","url":"https://www.lvbibir.cn/img/avatar.gif"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.lvbibir.cn accesskey=h title="lvbibir's Blog (Alt + H)"><img src=https://www.lvbibir.cn/img/avatar.gif alt aria-label=logo height=35>lvbibir's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li class=menu-item><a href=https://www.lvbibir.cn/search title="🔍 搜索 (Alt + /)" accesskey=/><span>🔍 搜索</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/posts title="📚 文章"><span>📚 文章</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/archives title="📈 归档"><span>📈 归档</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/talk title="💬 说说"><span>💬 说说</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/links title="🤝 友链"><span>🤝 友链</span></a></li></ul></nav></header><main class="main page"><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://www.lvbibir.cn>主页</a>&nbsp;»&nbsp;<a href=https://www.lvbibir.cn/posts/>📚 文章</a>&nbsp;»&nbsp;<a href=https://www.lvbibir.cn/posts/tech/>👨🏻‍💻 技术</a></div><h1 class=post-title>traefik (一) 简介、部署和配置</h1><div class=post-description>kubernetes 中 Traefik ingress 的简介、部署及配置。</div><div class=post-meta>创建:&nbsp;<span title='2023-04-17 00:00:00 +0000 UTC'>2023-04-17</span>&nbsp;|&nbsp;更新:&nbsp;2023-04-17&nbsp;|&nbsp;字数:&nbsp;3921字&nbsp;|&nbsp;作者:&nbsp;lvbibir
|&nbsp;标签:&nbsp;<ul class=post-tags-meta><a href=https://www.lvbibir.cn/tags/traefik/>traefik</a>
<a href=https://www.lvbibir.cn/tags/kubernetes/>、kubernetes</a></ul><span id=busuanzi_container_page_pv>&nbsp;|&nbsp;访问:&nbsp;<span id=busuanzi_value_page_pv></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>文章目录</span></summary><div class=inner><ul><li><a href=#0-%e5%89%8d%e8%a8%80 aria-label="0. 前言">0. 前言</a></li><li><a href=#1-%e7%ae%80%e4%bb%8b aria-label="1. 简介">1. 简介</a><ul><li><a href=#11-traefik-%e7%ae%80%e4%bb%8b aria-label="1.1 Traefik 简介">1.1 Traefik 简介</a></li><li><a href=#12-traefik-%e6%a0%b8%e5%bf%83%e7%bb%84%e4%bb%b6 aria-label="1.2 Traefik 核心组件">1.2 Traefik 核心组件</a></li><li><a href=#13-traefik-crd%e8%b5%84%e6%ba%90 aria-label="1.3 Traefik CRD资源">1.3 Traefik CRD资源</a></li></ul></li><li><a href=#2-traefik-%e9%83%a8%e7%bd%b2 aria-label="2. Traefik 部署">2. Traefik 部署</a><ul><li><a href=#21-crd-rbac-serviceaccount aria-label="2.1 crd rbac serviceaccount">2.1 crd rbac serviceaccount</a></li><li><a href=#22-configmap aria-label="2.2 configmap">2.2 configmap</a></li><li><a href=#23-deployment-service aria-label="2.3 deployment service">2.3 deployment service</a></li><li><a href=#24-%e9%aa%8c%e8%af%81 aria-label="2.4 验证">2.4 验证</a></li><li><a href=#25-%e5%85%b6%e4%bb%96%e9%85%8d%e7%bd%ae aria-label="2.5 其他配置">2.5 其他配置</a><ul><li><a href=#251-%e5%bc%ba%e5%88%b6%e4%bd%bf%e7%94%a8tls-v12 aria-label="2.5.1 强制使用TLS v1.2+">2.5.1 强制使用TLS v1.2+</a></li><li><a href=#252-%e6%97%a5%e5%bf%97%e5%88%87%e5%89%b2 aria-label="2.5.2 日志切割">2.5.2 日志切割</a></li></ul></li><li><a href=#26-%e5%a4%9a%e6%8e%a7%e5%88%b6%e5%99%a8 aria-label="2.6 多控制器">2.6 多控制器</a><ul><li><a href=#261-annotations-%e6%b3%a8%e8%a7%a3%e7%ad%9b%e9%80%89 aria-label="2.6.1 annotations 注解筛选">2.6.1 annotations 注解筛选</a></li><li><a href=#262-label-%e6%a0%87%e7%ad%be%e9%80%89%e6%8b%a9%e5%99%a8%e7%ad%9b%e9%80%89 aria-label="2.6.2 label 标签选择器筛选">2.6.2 label 标签选择器筛选</a></li></ul></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=0-前言>0. 前言<a hidden class=anchor aria-hidden=true href=#0-前言>#</a></h1><p>基于 <code>centos7.9</code>，<code>docker-ce-20.10.18</code>，<code>kubelet-1.22.3-0</code>， <code>traefik-2.9.10</code></p><p>参考：https://www.cuiliangblog.cn/detail/section/29427812</p><h1 id=1-简介>1. 简介<a hidden class=anchor aria-hidden=true href=#1-简介>#</a></h1><h2 id=11-traefik-简介>1.1 Traefik 简介<a hidden class=anchor aria-hidden=true href=#11-traefik-简介>#</a></h2><p>Traefik 是一个为了让部署微服务更加便捷而诞生的现代HTTP反向代理、负载均衡工具。 它支持多种后台 (<a href=https://www.docker.com/ target=_blank rel=noopener style=color:#42b983 ;>Docker</a>, <a href=https://docs.docker.com/swarm target=_blank rel=noopener style=color:#42b983 ;>Swarm</a>, <a href=http://kubernetes.io/ target=_blank rel=noopener style=color:#42b983 ;>Kubernetes</a>, <a href=https://mesosphere.github.io/marathon/ target=_blank rel=noopener style=color:#42b983 ;>Marathon</a>, <a href=https://github.com/apache/mesos target=_blank rel=noopener style=color:#42b983 ;>Mesos</a>, <a href=https://www.consul.io/ target=_blank rel=noopener style=color:#42b983 ;>Consul</a>, <a href=https://coreos.com/etcd/ target=_blank rel=noopener style=color:#42b983 ;>Etcd</a>, <a href=https://zookeeper.apache.org/ target=_blank rel=noopener style=color:#42b983 ;>Zookeeper</a>, <a href=https://github.com/boltdb/bolt target=_blank rel=noopener style=color:#42b983 ;>BoltDB</a>, Rest API, file…) 来自动化、动态的应用它的配置文件设置。</p><p>它是一个边缘路由器，它会拦截外部的请求并根据逻辑规则选择不同的操作方式，这些规则决定着这些请求到底该如何处理。Traefik 提供自动发现能力，会实时检测服务，并自动更新路由规则。</p><p><img loading=lazy src=https://image.lvbibir.cn/blog/traefik-architecture.png alt=traefik-architecture></p><h2 id=12-traefik-核心组件>1.2 Traefik 核心组件<a hidden class=anchor aria-hidden=true href=#12-traefik-核心组件>#</a></h2><p><img loading=lazy src=https://image.lvbibir.cn/blog/v2-b67cb6ed0ac457009296459fe974cef4_r.jpg alt=img></p><p>从上图可知，当请求 Traefik 时，请求首先到 <code>entrypoints</code>，然后分析传入的请求，查看他们是否与定义的 <code>Routers</code> 匹配。如果匹配，则会通过一系列 <code>middlewares</code> 处理，再到 <code>traefikServices</code> 上做流量转发，最后请求到 <code>kubernetes的services上</code> 。</p><p>这就涉及到以下几个重要的核心组件:</p><ul><li><strong><a href=https://doc.traefik.io/traefik/providers/overview/ target=_blank rel=noopener style=color:#42b983 ;>Providers</a></strong> 是基础组件，Traefik 的配置发现是通过它来实现的，它可以是协调器，容器引擎，云提供商或者键值存储。Traefik 通过查询 <code>Providers</code> 的 <code>API</code> 来查询路由的相关信息，一旦检测到变化，就会动态的更新路由。</li><li><strong><a href=https://doc.traefik.io/traefik/routing/entrypoints/ target=_blank rel=noopener style=color:#42b983 ;>Entrypoints</a></strong> 是 <code>Traefik</code> 的网络入口，它定义接收请求的接口，以及是否监听TCP或者UDP。</li><li><strong><a href=https://doc.traefik.io/traefik/routing/routers/ target=_blank rel=noopener style=color:#42b983 ;>Routers</a></strong> 主要用于分析请求，并负责将这些请求连接到对应的服务上去，在这个过程中，Routers还可以使用Middlewares来更新请求，比如在把请求发到服务之前添加一些Headers。</li><li><strong><a href=https://doc.traefik.io/traefik/routing/services/ target=_blank rel=noopener style=color:#42b983 ;>Services</a></strong> 负责配置如何到达最终将处理传入请求的实际服务。</li><li><strong><a href=https://doc.traefik.io/traefik/middlewares/overview/ target=_blank rel=noopener style=color:#42b983 ;>Middlewares</a></strong> 用来修改请求或者根据请求来做出一些判断（authentication, rate limiting, headers, &mldr;），中间件被附件到路由上，是一种在请求发送到你的<strong>服务</strong>之前（或者在服务的响应发送到客户端之前）调整请求的一种方法。</li></ul><h2 id=13-traefik-crd资源>1.3 Traefik CRD资源<a hidden class=anchor aria-hidden=true href=#13-traefik-crd资源>#</a></h2><blockquote><p>参考文档：https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/</p></blockquote><p>traefik通过自定义资源实现了对traefik资源的创建和管理，支持的crd资源类型如下所示：</p><table><thead><tr><th>kind</th><th>功能</th></tr></thead><tbody><tr><td><a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/#kind-ingressroute target=_blank rel=noopener style=color:#42b983 ;>IngressRoute</a></td><td>HTTP路由配置</td></tr><tr><td><a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/#kind-middleware target=_blank rel=noopener style=color:#42b983 ;>Middleware</a></td><td>HTTP中间件配置</td></tr><tr><td><a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/#kind-traefikservice target=_blank rel=noopener style=color:#42b983 ;>TraefikService</a></td><td>HTTP负载均衡/流量复制配置</td></tr><tr><td><a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/#kind-ingressroutetcp target=_blank rel=noopener style=color:#42b983 ;>IngressRouteTCP</a></td><td>TCP路由配置</td></tr><tr><td><a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/#kind-middlewaretcp target=_blank rel=noopener style=color:#42b983 ;>MiddlewareTCP</a></td><td>TCP中间件配置</td></tr><tr><td><a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/#kind-ingressrouteudp target=_blank rel=noopener style=color:#42b983 ;>IngressRouteUDP</a></td><td>UDP路由配置</td></tr><tr><td><a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/#kind-tlsoption target=_blank rel=noopener style=color:#42b983 ;>TLSOptions</a></td><td>TLS连接参数配置</td></tr><tr><td><a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/#kind-tlsstore target=_blank rel=noopener style=color:#42b983 ;>TLSStores</a></td><td>TLS存储配置</td></tr><tr><td><a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/#kind-serverstransport target=_blank rel=noopener style=color:#42b983 ;>ServersTransport</a></td><td>traefik与后端之间的传输配置</td></tr></tbody></table><h1 id=2-traefik-部署>2. Traefik 部署<a hidden class=anchor aria-hidden=true href=#2-traefik-部署>#</a></h1><p>traefik 是支持 helm 部署的，但是查看 helm 包的 value.yaml 配置发现总共有 500 多行配置，当需要修改配置项或者对 traefik 做一下自定义配置时，并不灵活。如果只是使用 traefik 的基础功能，推荐使用 helm 部署。如果想深入研究使用 traefik 的话，推荐使用自定义方式部署。</p><h2 id=21-crd-rbac-serviceaccount>2.1 crd rbac serviceaccount<a hidden class=anchor aria-hidden=true href=#21-crd-rbac-serviceaccount>#</a></h2><p>crd</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># mkdir /opt/traefik</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># cd /opt/traefik</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 traefik<span style=color:#5bc4bf>]</span><span style=color:#776e71># wget https://raw.githubusercontent.com/traefik/traefik/v2.9/docs/content/reference/dynamic-configuration/kubernetes-crd-definition-v1.yml</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 traefik<span style=color:#5bc4bf>]</span><span style=color:#776e71># kubectl apply -f kubernetes-crd-definition-v1.yml</span>
</span></span></code></pre></div><p>rbac</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 traefik<span style=color:#5bc4bf>]</span><span style=color:#776e71># wget https://raw.githubusercontent.com/traefik/traefik/v2.9/docs/content/reference/dynamic-configuration/kubernetes-crd-rbac.yml</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 traefik<span style=color:#5bc4bf>]</span><span style=color:#776e71># kubectl apply -f kubernetes-crd-rbac.yml</span>
</span></span><span style=display:flex><span>clusterrole.rbac.authorization.k8s.io/traefik-ingress-controller created
</span></span><span style=display:flex><span>clusterrolebinding.rbac.authorization.k8s.io/traefik-ingress-controller created
</span></span></code></pre></div><p>serviceaccount.yml</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#5bc4bf>apiVersion</span>: <span style=color:#f99b15>v1</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>Namespace</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span><span style=color:#fec418>---</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>apiVersion</span>: <span style=color:#f99b15>v1</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>ServiceAccount</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>namespace</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik-ingress-controller</span>
</span></span><span style=display:flex><span><span style=color:#fec418>---</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>apiVersion</span>: <span style=color:#f99b15>rbac.authorization.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>ClusterRoleBinding</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik-ingress-controller</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>roleRef</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>apiGroup</span>: <span style=color:#f99b15>rbac.authorization.k8s.io</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>ClusterRole</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik-ingress-controller</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>subjects</span>:
</span></span><span style=display:flex><span>  - <span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>ServiceAccount</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik-ingress-controller</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>namespace</span>: <span style=color:#f99b15>traefik</span>
</span></span></code></pre></div><h2 id=22-configmap>2.2 configmap<a hidden class=anchor aria-hidden=true href=#22-configmap>#</a></h2><blockquote><p>在 Traefik 中有三种方式定义静态配置：在配置文件中、在命令行参数中、通过环境变量传递，由于 Traefik 配置很多，通过 CLI 定义不是很方便，一般时候选择将其配置选项放到配置文件中，然后存入 ConfigMap，将其挂入 traefik 中。参考文档：https://doc.traefik.io/traefik/getting-started/configuration-overview/</p></blockquote><p><code>configmap.yml</code> 文件内容：</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#5bc4bf>apiVersion</span>: <span style=color:#f99b15>v1</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>ConfigMap</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik-config</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>namespace</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>traefik.yaml</span>: |-<span style=color:#776e71>
</span></span></span><span style=display:flex><span><span style=color:#776e71>    global:
</span></span></span><span style=display:flex><span><span style=color:#776e71>      checkNewVersion: false    # 周期性的检查是否有新版本发布
</span></span></span><span style=display:flex><span><span style=color:#776e71>      sendAnonymousUsage: false # 周期性的匿名发送使用统计信息
</span></span></span><span style=display:flex><span><span style=color:#776e71>    serversTransport:
</span></span></span><span style=display:flex><span><span style=color:#776e71>      insecureSkipVerify: true  # Traefik忽略验证代理服务的TLS证书
</span></span></span><span style=display:flex><span><span style=color:#776e71>    api:
</span></span></span><span style=display:flex><span><span style=color:#776e71>      insecure: true            # 允许HTTP 方式访问API
</span></span></span><span style=display:flex><span><span style=color:#776e71>      dashboard: true           # 启用Dashboard
</span></span></span><span style=display:flex><span><span style=color:#776e71>      debug: false              # 启用Debug调试模式
</span></span></span><span style=display:flex><span><span style=color:#776e71>    metrics:
</span></span></span><span style=display:flex><span><span style=color:#776e71>      prometheus:               # 配置Prometheus监控指标数据，并使用默认配置
</span></span></span><span style=display:flex><span><span style=color:#776e71>        addRoutersLabels: true  # 添加routers metrics
</span></span></span><span style=display:flex><span><span style=color:#776e71>        entryPoint: &#34;metrics&#34;   # 指定metrics监听地址
</span></span></span><span style=display:flex><span><span style=color:#776e71>    entryPoints:
</span></span></span><span style=display:flex><span><span style=color:#776e71>      web:
</span></span></span><span style=display:flex><span><span style=color:#776e71>        address: &#34;:80&#34;          # 配置80端口，并设置入口名称为 web
</span></span></span><span style=display:flex><span><span style=color:#776e71>        forwardedHeaders: 
</span></span></span><span style=display:flex><span><span style=color:#776e71>          insecure: true        # 信任所有的forward headers
</span></span></span><span style=display:flex><span><span style=color:#776e71>      websecure:
</span></span></span><span style=display:flex><span><span style=color:#776e71>        address: &#34;:443&#34;         # 配置443端口，并设置入口名称为 websecure
</span></span></span><span style=display:flex><span><span style=color:#776e71>        forwardedHeaders: 
</span></span></span><span style=display:flex><span><span style=color:#776e71>          insecure: true
</span></span></span><span style=display:flex><span><span style=color:#776e71>      traefik:
</span></span></span><span style=display:flex><span><span style=color:#776e71>        address: &#34;:9000&#34;        # 配置9000端口为 dashboard 的端口，不设置默认值为 8080
</span></span></span><span style=display:flex><span><span style=color:#776e71>      metrics:
</span></span></span><span style=display:flex><span><span style=color:#776e71>        address: &#34;:9100&#34;        # 配置9100端口，作为metrics收集入口
</span></span></span><span style=display:flex><span><span style=color:#776e71>      tcpep:
</span></span></span><span style=display:flex><span><span style=color:#776e71>        address: &#34;:9200&#34;        # 配置9200端口，作为tcp入口
</span></span></span><span style=display:flex><span><span style=color:#776e71>      udpep:
</span></span></span><span style=display:flex><span><span style=color:#776e71>        address: &#34;:9300/udp&#34;    # 配置9300端口，作为udp入口
</span></span></span><span style=display:flex><span><span style=color:#776e71>    providers:
</span></span></span><span style=display:flex><span><span style=color:#776e71>      kubernetesCRD:            # 启用Kubernetes CRD方式来配置路由规则
</span></span></span><span style=display:flex><span><span style=color:#776e71>        ingressClass: &#34;&#34;        # 指定traefik的ingressClass名称
</span></span></span><span style=display:flex><span><span style=color:#776e71>        allowCrossNamespace: true   #允许跨namespace
</span></span></span><span style=display:flex><span><span style=color:#776e71>        allowEmptyServices: true    #允许空endpoints的service
</span></span></span><span style=display:flex><span><span style=color:#776e71>    log:
</span></span></span><span style=display:flex><span><span style=color:#776e71>      filePath: &#34;/etc/traefik/logs/traefik.log&#34; # 设置调试日志文件存储路径，如果为空则输出到控制台
</span></span></span><span style=display:flex><span><span style=color:#776e71>      level: &#34;DEBUG&#34;            # 设置调试日志级别
</span></span></span><span style=display:flex><span><span style=color:#776e71>      format: &#34;json&#34;          # 设置调试日志格式
</span></span></span><span style=display:flex><span><span style=color:#776e71>    accessLog:
</span></span></span><span style=display:flex><span><span style=color:#776e71>      # filePath: &#34;/etc/traefik/logs/access.log&#34; # 设置访问日志文件存储路径，如果为空则输出到 stdout 和 stderr
</span></span></span><span style=display:flex><span><span style=color:#776e71>      format: &#34;json&#34;          # 设置访问调试日志格式
</span></span></span><span style=display:flex><span><span style=color:#776e71>      bufferingSize: 0          # 设置访问日志缓存行数
</span></span></span><span style=display:flex><span><span style=color:#776e71>      fields:                   # 设置访问日志中的字段是否保留（keep保留、drop不保留）
</span></span></span><span style=display:flex><span><span style=color:#776e71>        defaultMode: keep       # 设置默认保留访问日志字段
</span></span></span><span style=display:flex><span><span style=color:#776e71>        names:                  # 针对访问日志特别字段特别配置保留模式
</span></span></span><span style=display:flex><span><span style=color:#776e71>          ClientUsername: drop
</span></span></span><span style=display:flex><span><span style=color:#776e71>          StartUTC: drop        # 禁用日志timestamp使用UTC
</span></span></span><span style=display:flex><span><span style=color:#776e71>        headers:                # 设置Header中字段是否保留
</span></span></span><span style=display:flex><span><span style=color:#776e71>          defaultMode: keep     # 设置默认保留Header中字段
</span></span></span><span style=display:flex><span><span style=color:#776e71>          names:                # 针对Header中特别字段特别配置保留模式
</span></span></span><span style=display:flex><span><span style=color:#776e71>            # User-Agent: redact# 可以针对指定agent
</span></span></span><span style=display:flex><span><span style=color:#776e71>            Authorization: drop
</span></span></span><span style=display:flex><span><span style=color:#776e71>            Content-Type: keep</span>    
</span></span></code></pre></div><p>设置节点 label，用于控制在哪些节点部署 Traefik，这里我们使用 k8s-node1(master) 节点作为边缘节点部署</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl label node k8s-node1  <span style=color:#ef6155>IngressProxy</span><span style=color:#5bc4bf>=</span>true
</span></span></code></pre></div><h2 id=23-deployment-service>2.3 deployment service<a hidden class=anchor aria-hidden=true href=#23-deployment-service>#</a></h2><p>使用 DeamonSet 或者 Deployment 均可，此处使用 Deployment 方式部署 Traefik，调度至含有 IngressProxy=true 的边缘节点</p><p>同时使用 <code>podAntiAffinity</code> 避免多个 traefik 实例运行在同一节点造成单点故障.</p><p><code>kubectl apply -f deployment.yml</code></p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#5bc4bf>apiVersion</span>: <span style=color:#f99b15>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>namespace</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>app</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>replicas</span>: <span style=color:#f99b15>1</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>app</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>app</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>affinity</span>:
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>podAntiAffinity</span>:
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>requiredDuringSchedulingIgnoredDuringExecution</span>:
</span></span><span style=display:flex><span>          - <span style=color:#5bc4bf>labelSelector</span>:
</span></span><span style=display:flex><span>              <span style=color:#5bc4bf>matchExpressions</span>:
</span></span><span style=display:flex><span>              - <span style=color:#5bc4bf>key</span>: <span style=color:#f99b15>app</span>
</span></span><span style=display:flex><span>                <span style=color:#5bc4bf>operator</span>: <span style=color:#f99b15>In</span>
</span></span><span style=display:flex><span>                <span style=color:#5bc4bf>values</span>:
</span></span><span style=display:flex><span>                - <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>topologyKey</span>: <span style=color:#48b685>&#34;kubernetes.io/hostname&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>serviceAccountName</span>: <span style=color:#f99b15>traefik-ingress-controller</span>
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>terminationGracePeriodSeconds</span>: <span style=color:#f99b15>5</span>         <span style=color:#776e71># 等待容器优雅退出的时长</span>
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>tolerations</span>:                             <span style=color:#776e71># 设置容忍所有污点，防止节点被设置污点</span>
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>operator</span>: <span style=color:#48b685>&#34;Exists&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>nodeSelector</span>:                            <span style=color:#776e71># 设置node筛选器，在特定label的节点上启动</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>IngressProxy</span>: <span style=color:#48b685>&#34;true&#34;</span>                   <span style=color:#776e71># 调度至IngressProxy: &#34;true&#34;的节点</span>
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>image</span>: <span style=color:#f99b15>traefik:v2.9</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>env</span>:
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>KUBERNETES_SERVICE_HOST      </span> <span style=color:#776e71># 手动指定k8s api,避免网络组件不稳定。</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>value</span>: <span style=color:#48b685>&#34;1.1.1.1&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>KUBERNETES_SERVICE_PORT_HTTPS</span> <span style=color:#776e71># API server端口</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>value</span>: <span style=color:#48b685>&#34;6443&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>KUBERNETES_SERVICE_PORT      </span> <span style=color:#776e71># API server端口</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>value</span>: <span style=color:#48b685>&#34;6443&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>TZ                           </span> <span style=color:#776e71># 指定时区</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>value</span>: <span style=color:#48b685>&#34;Asia/Shanghai&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>ports</span>:
</span></span><span style=display:flex><span>          - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>web</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>containerPort</span>: <span style=color:#f99b15>80</span>
</span></span><span style=display:flex><span>          - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>websecure</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>containerPort</span>: <span style=color:#f99b15>443</span>
</span></span><span style=display:flex><span>          - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>dashboard</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>containerPort</span>: <span style=color:#f99b15>9000</span>               <span style=color:#776e71># Traefik Dashboard 端口</span>
</span></span><span style=display:flex><span>          - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>metrics</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>containerPort</span>: <span style=color:#f99b15>9100</span>
</span></span><span style=display:flex><span>          - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>tcpep</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>containerPort</span>: <span style=color:#f99b15>9200</span>               <span style=color:#776e71># tcp端口</span>
</span></span><span style=display:flex><span>          - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>udpep</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>containerPort</span>: <span style=color:#f99b15>9300</span>               <span style=color:#776e71># udp端口</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>securityContext</span>:                      <span style=color:#776e71># 只开放网络权限</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>capabilities</span>:
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>drop</span>:
</span></span><span style=display:flex><span>              - <span style=color:#f99b15>ALL</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>add</span>:
</span></span><span style=display:flex><span>              - <span style=color:#f99b15>NET_BIND_SERVICE</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>args</span>:
</span></span><span style=display:flex><span>          - --<span style=color:#f99b15>configfile=/etc/traefik/config/traefik.yaml</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>volumeMounts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>mountPath</span>: <span style=color:#f99b15>/etc/traefik/config</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>config</span>
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>mountPath</span>: <span style=color:#f99b15>/etc/traefik/logs</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>logdir</span>
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>mountPath</span>: <span style=color:#f99b15>/etc/localtime</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>timezone</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>readOnly</span>: <span style=color:#815ba4>true</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>resources</span>:
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>requests</span>:
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>memory</span>: <span style=color:#48b685>&#34;5Mi&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>cpu</span>: <span style=color:#48b685>&#34;10m&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>limits</span>:
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>memory</span>: <span style=color:#48b685>&#34;256Mi&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>cpu</span>: <span style=color:#48b685>&#34;1000m&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>volumes</span>:
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>config                        </span> <span style=color:#776e71># traefik配置文件</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>configMap</span>:
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik-config</span>
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>logdir                        </span> <span style=color:#776e71># traefik日志目录</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>hostPath</span>:
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>path</span>: <span style=color:#f99b15>/var/log/traefik</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>type</span>: <span style=color:#48b685>&#34;DirectoryOrCreate&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>timezone                      </span> <span style=color:#776e71># 挂载时区文件</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>hostPath</span>:
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>path</span>: <span style=color:#f99b15>/etc/localtime</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>type</span>: <span style=color:#f99b15>File</span>
</span></span></code></pre></div><p>service <code>kubectl apply -f service.yml</code></p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#5bc4bf>apiVersion</span>: <span style=color:#f99b15>v1</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>Service</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>app</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik            </span> <span style=color:#776e71># 实际提供服务的 service, 使用 NodePort 模式</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>namespace</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>type</span>: <span style=color:#f99b15>NodePort</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>app</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>web</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>protocol</span>: <span style=color:#f99b15>TCP</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>port</span>: <span style=color:#f99b15>80</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>targetPort</span>: <span style=color:#f99b15>80</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>nodePort</span>: <span style=color:#f99b15>80</span>
</span></span><span style=display:flex><span>  - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>websecure</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>protocol</span>: <span style=color:#f99b15>TCP</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>port</span>: <span style=color:#f99b15>443</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>targetPort</span>: <span style=color:#f99b15>443</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>nodePort</span>: <span style=color:#f99b15>443</span>
</span></span><span style=display:flex><span>  - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>dashboard</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>protocol</span>: <span style=color:#f99b15>TCP</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>port</span>: <span style=color:#f99b15>9000</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>targetPort</span>: <span style=color:#f99b15>9000</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>nodePort</span>: <span style=color:#f99b15>9000</span>
</span></span><span style=display:flex><span>  - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>tcpep</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>protocol</span>: <span style=color:#f99b15>TCP</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>port</span>: <span style=color:#f99b15>9200</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>targetPort</span>: <span style=color:#f99b15>9200</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>nodePort</span>: <span style=color:#f99b15>9200</span>
</span></span><span style=display:flex><span>  - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>udpep</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>protocol</span>: <span style=color:#f99b15>UDP</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>port</span>: <span style=color:#f99b15>9300</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>targetPort</span>: <span style=color:#f99b15>9300</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>nodePort</span>: <span style=color:#f99b15>9300</span>
</span></span><span style=display:flex><span><span style=color:#fec418>---</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>apiVersion</span>: <span style=color:#f99b15>v1</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>Service</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>app</span>: <span style=color:#f99b15>traefik-metrics</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik-metrics          </span> <span style=color:#776e71># metrics 用于给集群内的 prometheus 提供数据</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>namespace</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>app</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>metrics</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>protocol</span>: <span style=color:#f99b15>TCP</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>port</span>: <span style=color:#f99b15>9100</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>targetPort</span>: <span style=color:#f99b15>9100</span>
</span></span></code></pre></div><h2 id=24-验证>2.4 验证<a hidden class=anchor aria-hidden=true href=#24-验证>#</a></h2><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 traefik<span style=color:#5bc4bf>]</span><span style=color:#776e71># kubectl get pod,cm,sa,svc -n traefik |grep traefik</span>
</span></span><span style=display:flex><span>pod/traefik-69bd67497f-v27qp   1/1     Running   <span style=color:#f99b15>0</span>          12m
</span></span><span style=display:flex><span>configmap/traefik-config     <span style=color:#f99b15>1</span>      7d5h
</span></span><span style=display:flex><span>serviceaccount/traefik-ingress-controller   <span style=color:#f99b15>1</span>         7d5h
</span></span><span style=display:flex><span>service/traefik          NodePort    10.101.142.158   &lt;none&gt;        80:80/TCP,443:443/TCP,9000:9000/TCP,9200:9200/TCP,9300:9300/UDP   11m
</span></span><span style=display:flex><span>service/traefik-metrics   ClusterIP   10.98.89.13      &lt;none&gt;        9100/TCP                                                          12m
</span></span></code></pre></div><p>可以直接通过 http://1.1.1.1:9000 访问到 dashboard</p><p><img loading=lazy src=https://image.lvbibir.cn/blog/image-20230426155416528.png alt=image-20230426155416528></p><h2 id=25-其他配置>2.5 其他配置<a hidden class=anchor aria-hidden=true href=#25-其他配置>#</a></h2><h3 id=251-强制使用tls-v12>2.5.1 强制使用TLS v1.2+<a hidden class=anchor aria-hidden=true href=#251-强制使用tls-v12>#</a></h3><blockquote><p>如今，TLS v1.0 和 v1.1 因为存在安全问题，现在已被弃用。为了保障系统安全，所有入口路由都应该强制使用TLS v1.2 或更高版本。</p><p>参考文档：https://doc.traefik.io/traefik/user-guides/crd-acme/#force-tls-v12</p></blockquote><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 traefik<span style=color:#5bc4bf>]</span><span style=color:#776e71># tee traefik-tlsoption.yml &lt;&lt;-&#39;EOF&#39;</span>
</span></span><span style=display:flex><span>apiVersion: traefik.containo.us/v1alpha1
</span></span><span style=display:flex><span>kind: TLSOption
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: default
</span></span><span style=display:flex><span>  namespace: traefik
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  minVersion: VersionTLS12
</span></span><span style=display:flex><span>  cipherSuites:
</span></span><span style=display:flex><span>    - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384   <span style=color:#776e71># TLS 1.2</span>
</span></span><span style=display:flex><span>    - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305    <span style=color:#776e71># TLS 1.2</span>
</span></span><span style=display:flex><span>    - TLS_AES_256_GCM_SHA384                  <span style=color:#776e71># TLS 1.3</span>
</span></span><span style=display:flex><span>    - TLS_CHACHA20_POLY1305_SHA256            <span style=color:#776e71># TLS 1.3</span>
</span></span><span style=display:flex><span>  curvePreferences:
</span></span><span style=display:flex><span>    - CurveP521
</span></span><span style=display:flex><span>    - CurveP384
</span></span><span style=display:flex><span>  sniStrict: true
</span></span><span style=display:flex><span>EOF
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 traefik<span style=color:#5bc4bf>]</span><span style=color:#776e71># kubectl apply -f traefik-tlsoption.yml</span>
</span></span><span style=display:flex><span>tlsoption.traefik.containo.us/default created
</span></span></code></pre></div><h3 id=252-日志切割>2.5.2 日志切割<a hidden class=anchor aria-hidden=true href=#252-日志切割>#</a></h3><blockquote><p>官方并没有日志轮换的功能，但是traefik收到USR1信号后会重建日志文件，因此可以通过logrotate实现日志轮换</p><p>参考文档：https://doc.traefik.io/traefik/observability/logs/</p></blockquote><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /etc/logrotate.d/traefik
</span></span><span style=display:flex><span>tee /etc/logrotate.d/traefik/config <span style=color:#48b685>&lt;&lt;-&#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#48b685>/var/log/traefik/*.log {
</span></span></span><span style=display:flex><span><span style=color:#48b685>  daily
</span></span></span><span style=display:flex><span><span style=color:#48b685>  rotate 15
</span></span></span><span style=display:flex><span><span style=color:#48b685>  missingok
</span></span></span><span style=display:flex><span><span style=color:#48b685>  notifempty
</span></span></span><span style=display:flex><span><span style=color:#48b685>  compress
</span></span></span><span style=display:flex><span><span style=color:#48b685>  dateext
</span></span></span><span style=display:flex><span><span style=color:#48b685>  dateyesterday
</span></span></span><span style=display:flex><span><span style=color:#48b685>  dateformat .%Y-%m-%d
</span></span></span><span style=display:flex><span><span style=color:#48b685>  create 0644 root root
</span></span></span><span style=display:flex><span><span style=color:#48b685>  postrotate
</span></span></span><span style=display:flex><span><span style=color:#48b685>   docker kill --signal=&#34;USR1&#34; $(docker ps | grep traefik |grep -v pause| awk &#39;{print $1}&#39;)
</span></span></span><span style=display:flex><span><span style=color:#48b685>  endscript
</span></span></span><span style=display:flex><span><span style=color:#48b685> }
</span></span></span><span style=display:flex><span><span style=color:#48b685>EOF</span>
</span></span></code></pre></div><p>创建定时任务</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>crontab -e
</span></span><span style=display:flex><span><span style=color:#f99b15>0</span> <span style=color:#f99b15>0</span> * * * /usr/sbin/logrotate -f /etc/logrotate.d/traefik/config &gt;/dev/null 2&gt;&amp;<span style=color:#f99b15>1</span>
</span></span></code></pre></div><h2 id=26-多控制器>2.6 多控制器<a hidden class=anchor aria-hidden=true href=#26-多控制器>#</a></h2><p>有的业务场景下可能需要在一个集群中部署多个 traefik，例如：避免单个traefik配置规则过多导致加载处理缓慢。每个namespace部署一个traefik。或者traefik生产与测试环境区分等场景，需要不同的实例控制不同的 IngressRoute 资源对象，要实现该功能有两种方法</p><h3 id=261-annotations-注解筛选>2.6.1 annotations 注解筛选<a hidden class=anchor aria-hidden=true href=#261-annotations-注解筛选>#</a></h3><blockquote><p>参考文档：https://doc.traefik.io/traefik/providers/kubernetes-crd/#ingressclass</p></blockquote><p>首先在traefik配置文件中的providers下增加Ingressclass参数，指定具体的值</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>    <span style=color:#5bc4bf>providers</span>:
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>kubernetesCRD</span>:            <span style=color:#776e71># 启用Kubernetes CRD方式来配置路由规则</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>ingressClass</span>: <span style=color:#48b685>&#34;traefik-v2.9&#34;</span> <span style=color:#776e71># 指定traefik的ingressClass实例名称</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>allowCrossNamespace</span>: <span style=color:#815ba4>true</span>   <span style=color:#776e71>#允许跨namespace</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>allowEmptyServices</span>: <span style=color:#815ba4>true</span>    <span style=color:#776e71>#允许空endpoints的service</span>
</span></span></code></pre></div><p>接下来在 IngressRoute 资源对象中的 annotations 参数中添加 <code>kubernetes.io/ingress.class: traefik-v2.9</code> 即可</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#5bc4bf>apiVersion</span>: <span style=color:#f99b15>traefik.containo.us/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>IngressRoute</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>dashboard</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>namespace</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>kubernetes.io/ingress.class</span>: <span style=color:#f99b15>traefik-v2.9</span> <span style=color:#776e71>#  因为静态配置文件指定了ingressclass，所以这里的annotations 要指定，否则访问会404</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>entryPoints</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f99b15>web</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>routes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#5bc4bf>match</span>: <span style=color:#f99b15>Host(`traefik.test.com`)</span>
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>Rule</span>
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>services</span>:
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>api@internal</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>TraefikService</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>namespace</span>: <span style=color:#f99b15>traefik</span>
</span></span></code></pre></div><h3 id=262-label-标签选择器筛选>2.6.2 label 标签选择器筛选<a hidden class=anchor aria-hidden=true href=#262-label-标签选择器筛选>#</a></h3><blockquote><p>参考文档：https://doc.traefik.io/traefik/providers/kubernetes-crd/#labelselector</p></blockquote><p>首先在traefik配置文件中的providers下增加labelSelector参数，指定具体的标签键值。</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>    <span style=color:#5bc4bf>providers</span>:
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>kubernetesCRD</span>:            <span style=color:#776e71># 启用Kubernetes CRD方式来配置路由规则</span>
</span></span><span style=display:flex><span>        <span style=color:#776e71># ingressClass: &#34;traefik-v2.9&#34;    # 指定traefik的ingressClass名称</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>labelSelector</span>: <span style=color:#48b685>&#34;app=traefik-v2.9&#34;</span> <span style=color:#776e71># 通过标签选择器指定traefik标签 </span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>allowCrossNamespace</span>: <span style=color:#815ba4>true</span>   <span style=color:#776e71>#允许跨namespace</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>allowEmptyServices</span>: <span style=color:#815ba4>true</span>    <span style=color:#776e71>#允许空endpoints的service</span>
</span></span></code></pre></div><p>然后在 IngressRoute 资源对象中添加labels标签选择器，选择 <code>app: traefik-v2.9</code> 这个标签即可</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#5bc4bf>apiVersion</span>: <span style=color:#f99b15>traefik.containo.us/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>IngressRoute</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>dashboard</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>labels</span>:     <span style=color:#776e71># 通过标签选择器，该IngressRoute资源由配置了app=traefik-v2.9的traefik处理</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>app</span>: <span style=color:#f99b15>traefik-v2.9</span>
</span></span><span style=display:flex><span>  <span style=color:#776e71># annotations:</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71># kubernetes.io/ingress.class: traefik-v2.9</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>entryPoints</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f99b15>web</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>routes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#5bc4bf>match</span>: <span style=color:#f99b15>Host(`traefik.test.com`)</span>
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>Rule</span>
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>services</span>:
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>api@internal</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>TraefikService</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>namespace</span>: <span style=color:#f99b15>traefik</span>
</span></span></code></pre></div></div><div class=post-reward><div style=padding:0;margin:0;width:100%;font-size:16px;text-align:center><div id=QR style=opacity:0><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=https://www.lvbibir.cn/img/wechat_pay.png alt=wechat_pay></a><p>微信</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=https://www.lvbibir.cn/img/alipay.png alt=alipay></a><p>支付宝</p></div></div><button id=rewardButton onclick='var qr=document.getElementById("QR");qr.style.opacity==="0"?qr.style.opacity="1":qr.style.opacity="0"'>
<span>🧧 鼓励</span></button></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://www.lvbibir.cn/posts/tech/kubernetes-traefik-2-router/><span class=title>« 上一页</span><br><span>traefik (二) 路由(ingressRoute)</span></a>
<a class=next href=https://www.lvbibir.cn/posts/tech/kubernetes-gatewayapi/><span class=title>下一页 »</span><br><span>kubernetes | Gateway API 简介及部署</span></a></nav></footer></div><div><div class=pagination__title><span class=pagination__title-h style=font-size:20px>💬评论</span><hr></div><div id=tcomment></div><script src=https://cdn.staticfile.org/twikoo/1.6.15/twikoo.all.min.js></script><script>twikoo.init({envId:"https://twikoo.lvbibir.cn/",el:"#tcomment",lang:"zh-CN",path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><a href=https://gohugo.io/ target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/frame-hugo-blue.svg></a>
<a href=https://github.com/adityatelange/hugo-PaperMod target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/theme-papermod-lightgrey.svg></a>
<a href=https://cn.aliyun.com/ target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/图床-阿里云-orange.svg></a><br><span id=runtime_span></span>
<script type=text/javascript>function show_runtime(){window.setTimeout("show_runtime()",1e3),X=new Date("7/13/2021 1:00:00"),Y=new Date,T=Y.getTime()-X.getTime(),M=24*60*60*1e3,a=T/M,A=Math.floor(a),b=(a-A)*24,B=Math.floor(b),c=(b-B)*60,C=Math.floor((b-B)*60),D=Math.floor((c-C)*60),runtime_span.innerHTML="网站已运行"+A+"天"+B+"小时"+C+"分"+D+"秒"}show_runtime()</script>|
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span id=busuanzi_container>总访客数: <span id=busuanzi_value_site_uv></span>
|
总访问量: <span id=busuanzi_value_site_pv></span></span><br><a href=https://beian.miit.gov.cn/ target=_blank style="border-bottom:1px solid">京ICP备2021023168号-1</a>&nbsp;
|
<span>Copyright
&copy;
2020-2023
<a href=https://www.lvbibir.cn style="border-bottom:1px solid">lvbibir's Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg><span id=read_progress></span></span></a>
<script>document.addEventListener("scroll",function(){const t=document.getElementById("read_progress"),n=document.documentElement.scrollHeight,s=document.documentElement.clientHeight,o=document.documentElement.scrollTop||document.body.scrollTop;t.innerText=((o/(n-s)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>400||document.documentElement.scrollTop>400?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="📄复制";function c(){t.innerText="👌🏻已复制!",setTimeout(()=>{t.innerText="📄复制"},2e3)}t.addEventListener("click",t=>{const n=document.createRange();n.selectNodeContents(e);const s=window.getSelection();s.removeAllRanges(),s.addRange(n);try{document.execCommand("copy"),c()}catch{}s.removeRange(n)});let l=e.className.replaceAll("language-",""),n=document.createElement("div"),i=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div"),o=document.createElement("div");o.innerText=l,n.setAttribute("class","mac-tool"),i.setAttribute("class","mac bb1"),a.setAttribute("class","mac bb2"),r.setAttribute("class","mac bb3"),o.setAttribute("class","language-type"),n.appendChild(i),n.appendChild(a),n.appendChild(r),n.appendChild(o),s.classList.contains("highlight")?(s.appendChild(t),s.appendChild(n)):s.parentNode.firstChild===s||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName==="TABLE"?(e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t),s.appendChild(n)):(e.parentNode.appendChild(t),s.appendChild(n)))})</script><script src=https://code.jquery.com/jquery-1.12.4.min.js></script>
<script>$("code[class^=language] ").on("mouseover",function(){$(window).width()>768&&this.clientWidth<this.scrollWidth&&($(this).css("width","135%"),$(this).css("border-top-right-radius","var(--radius)"))}).on("mouseout",function(){$(this).css("width","100%"),$(this).css("border-top-right-radius","unset")})</script></body></html>