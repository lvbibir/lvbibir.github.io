<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>traefik (ä¸€) ç®€ä»‹ã€éƒ¨ç½²å’Œé…ç½® | lvbibir's Blog</title><meta name=keywords content="kubernetes,traefik,ingress"><meta name=description content="kubernetes ä¸­ Traefik ingress çš„ç®€ä»‹ã€éƒ¨ç½²åŠé…ç½®ã€‚"><meta name=author content="ä½œè€…:&nbsp;lvbibir"><link rel=canonical href=https://www.lvbibir.cn/posts/tech/kubernetes-traefik-1-deploy/><link crossorigin=anonymous href=/assets/css/stylesheet.6ae04185be267d218870ba8449572db8ef0ebb0e2863c2c015d6a0d5bce015cf.css integrity="sha256-auBBhb4mfSGIcLqESVctuO8Ouw4oY8LAFdag1bzgFc8=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://image.lvbibir.cn/blog/avatar.webp><link rel=icon type=image/png sizes=16x16 href=https://image.lvbibir.cn/blog/avatar.webp><link rel=icon type=image/png sizes=32x32 href=https://image.lvbibir.cn/blog/avatar.webp><link rel=apple-touch-icon href=https://image.lvbibir.cn/blog/avatar.webp><link rel=mask-icon href=https://image.lvbibir.cn/blog/avatar.webp><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://image.lvbibir.cn/fonts/JetBrainsLxgwNerdMono/all.css><script>document.addEventListener('DOMContentLoaded',function(){const e=document.querySelectorAll('img.lazyload');if('IntersectionObserver'in window){const t=new IntersectionObserver(function(e){e.forEach(function(e){if(e.isIntersecting){const n=e.target;n.src=n.dataset.src,n.classList.remove('lazyload'),n.classList.add('lazyloaded'),t.unobserve(n)}})},{rootMargin:'50px 0px',threshold:.01});e.forEach(function(e){t.observe(e)})}else e.forEach(function(e){e.src=e.dataset.src})})</script><meta property="og:title" content="traefik (ä¸€) ç®€ä»‹ã€éƒ¨ç½²å’Œé…ç½®"><meta property="og:description" content="kubernetes ä¸­ Traefik ingress çš„ç®€ä»‹ã€éƒ¨ç½²åŠé…ç½®ã€‚"><meta property="og:type" content="article"><meta property="og:url" content="https://www.lvbibir.cn/posts/tech/kubernetes-traefik-1-deploy/"><meta property="og:image" content="https://image.lvbibir.cn/blog/traefik.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-17T00:00:00+00:00"><meta property="article:modified_time" content="2024-01-28T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://image.lvbibir.cn/blog/traefik.png"><meta name=twitter:title content="traefik (ä¸€) ç®€ä»‹ã€éƒ¨ç½²å’Œé…ç½®"><meta name=twitter:description content="kubernetes ä¸­ Traefik ingress çš„ç®€ä»‹ã€éƒ¨ç½²åŠé…ç½®ã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"ğŸ“š æ–‡ç« ","item":"https://www.lvbibir.cn/posts/"},{"@type":"ListItem","position":3,"name":"ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯","item":"https://www.lvbibir.cn/posts/tech/"},{"@type":"ListItem","position":4,"name":"traefik (ä¸€) ç®€ä»‹ã€éƒ¨ç½²å’Œé…ç½®","item":"https://www.lvbibir.cn/posts/tech/kubernetes-traefik-1-deploy/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"traefik (ä¸€) ç®€ä»‹ã€éƒ¨ç½²å’Œé…ç½®","name":"traefik (ä¸€) ç®€ä»‹ã€éƒ¨ç½²å’Œé…ç½®","description":"kubernetes ä¸­ Traefik ingress çš„ç®€ä»‹ã€éƒ¨ç½²åŠé…ç½®ã€‚","keywords":["kubernetes","traefik","ingress"],"articleBody":"0 å‰è¨€ æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:\nhttps://www.cuiliangblog.cn/detail/section/29427812 åŸºäº centos7.9ï¼Œdocker-ce-20.10.18ï¼Œkubelet-1.22.3-0ï¼Œ traefik-2.9.10\n1 ç®€ä»‹ 1.1 Traefik ç®€ä»‹ Traefik æ˜¯ä¸€ä¸ªä¸ºäº†è®©éƒ¨ç½²å¾®æœåŠ¡æ›´åŠ ä¾¿æ·è€Œè¯ç”Ÿçš„ç°ä»£ HTTP åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡å·¥å…·ã€‚ å®ƒæ”¯æŒå¤šç§åå° (Docker, Swarm, Kubernetes, Marathon, Mesos, Consul, Etcd, Zookeeper, BoltDB, Rest API, fileâ€¦) æ¥è‡ªåŠ¨åŒ–ã€åŠ¨æ€çš„åº”ç”¨å®ƒçš„é…ç½®æ–‡ä»¶è®¾ç½®ã€‚\nå®ƒæ˜¯ä¸€ä¸ªè¾¹ç¼˜è·¯ç”±å™¨ï¼Œå®ƒä¼šæ‹¦æˆªå¤–éƒ¨çš„è¯·æ±‚å¹¶æ ¹æ®é€»è¾‘è§„åˆ™é€‰æ‹©ä¸åŒçš„æ“ä½œæ–¹å¼ï¼Œè¿™äº›è§„åˆ™å†³å®šç€è¿™äº›è¯·æ±‚åˆ°åº•è¯¥å¦‚ä½•å¤„ç†ã€‚Traefik æä¾›è‡ªåŠ¨å‘ç°èƒ½åŠ›ï¼Œä¼šå®æ—¶æ£€æµ‹æœåŠ¡ï¼Œå¹¶è‡ªåŠ¨æ›´æ–°è·¯ç”±è§„åˆ™ã€‚\n1.2 Traefik æ ¸å¿ƒç»„ä»¶ ä»ä¸Šå›¾å¯çŸ¥ï¼Œå½“è¯·æ±‚ Traefik æ—¶ï¼Œè¯·æ±‚é¦–å…ˆåˆ° entrypointsï¼Œç„¶ååˆ†æä¼ å…¥çš„è¯·æ±‚ï¼ŒæŸ¥çœ‹ä»–ä»¬æ˜¯å¦ä¸å®šä¹‰çš„ Routers åŒ¹é…ã€‚å¦‚æœåŒ¹é…ï¼Œåˆ™ä¼šé€šè¿‡ä¸€ç³»åˆ— middlewares å¤„ç†ï¼Œå†åˆ° traefikServices ä¸Šåšæµé‡è½¬å‘ï¼Œæœ€åè¯·æ±‚åˆ° kubernetesçš„servicesä¸Š ã€‚\nè¿™å°±æ¶‰åŠåˆ°ä»¥ä¸‹å‡ ä¸ªé‡è¦çš„æ ¸å¿ƒç»„ä»¶:\nProviders æ˜¯åŸºç¡€ç»„ä»¶ï¼ŒTraefik çš„é…ç½®å‘ç°æ˜¯é€šè¿‡å®ƒæ¥å®ç°çš„ï¼Œå®ƒå¯ä»¥æ˜¯åè°ƒå™¨ï¼Œå®¹å™¨å¼•æ“ï¼Œäº‘æä¾›å•†æˆ–è€…é”®å€¼å­˜å‚¨ã€‚Traefik é€šè¿‡æŸ¥è¯¢ Providers çš„ API æ¥æŸ¥è¯¢è·¯ç”±çš„ç›¸å…³ä¿¡æ¯ï¼Œä¸€æ—¦æ£€æµ‹åˆ°å˜åŒ–ï¼Œå°±ä¼šåŠ¨æ€çš„æ›´æ–°è·¯ç”±ã€‚ Entrypoints æ˜¯ Traefik çš„ç½‘ç»œå…¥å£ï¼Œå®ƒå®šä¹‰æ¥æ”¶è¯·æ±‚çš„æ¥å£ï¼Œä»¥åŠæ˜¯å¦ç›‘å¬ TCP æˆ–è€… UDPã€‚ Routers ä¸»è¦ç”¨äºåˆ†æè¯·æ±‚ï¼Œå¹¶è´Ÿè´£å°†è¿™äº›è¯·æ±‚è¿æ¥åˆ°å¯¹åº”çš„æœåŠ¡ä¸Šå»ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒRouters è¿˜å¯ä»¥ä½¿ç”¨ Middlewares æ¥æ›´æ–°è¯·æ±‚ï¼Œæ¯”å¦‚åœ¨æŠŠè¯·æ±‚å‘åˆ°æœåŠ¡ä¹‹å‰æ·»åŠ ä¸€äº› Headersã€‚ Services è´Ÿè´£é…ç½®å¦‚ä½•åˆ°è¾¾æœ€ç»ˆå°†å¤„ç†ä¼ å…¥è¯·æ±‚çš„å®é™…æœåŠ¡ã€‚ Middlewares ç”¨æ¥ä¿®æ”¹è¯·æ±‚æˆ–è€…æ ¹æ®è¯·æ±‚æ¥åšå‡ºä¸€äº›åˆ¤æ–­ï¼ˆauthentication, rate limiting, headers, â€¦ï¼‰ï¼Œä¸­é—´ä»¶è¢«é™„ä»¶åˆ°è·¯ç”±ä¸Šï¼Œæ˜¯ä¸€ç§åœ¨è¯·æ±‚å‘é€åˆ°ä½ çš„æœåŠ¡ä¹‹å‰ï¼ˆæˆ–è€…åœ¨æœåŠ¡çš„å“åº”å‘é€åˆ°å®¢æˆ·ç«¯ä¹‹å‰ï¼‰è°ƒæ•´è¯·æ±‚çš„ä¸€ç§æ–¹æ³•ã€‚ 1.3 Traefik CRD èµ„æº å®˜æ–¹æ–‡æ¡£\ntraefik é€šè¿‡è‡ªå®šä¹‰èµ„æºå®ç°äº†å¯¹ traefik èµ„æºçš„åˆ›å»ºå’Œç®¡ç†ï¼Œæ”¯æŒçš„ crd èµ„æºç±»å‹å¦‚ä¸‹æ‰€ç¤ºï¼š\nkind åŠŸèƒ½ IngressRoute HTTP è·¯ç”±é…ç½® Middleware HTTP ä¸­é—´ä»¶é…ç½® TraefikService HTTP è´Ÿè½½å‡è¡¡/æµé‡å¤åˆ¶é…ç½® IngressRouteTCP TCP è·¯ç”±é…ç½® MiddlewareTCP TCP ä¸­é—´ä»¶é…ç½® IngressRouteUDP UDP è·¯ç”±é…ç½® TLSOptions TLS è¿æ¥å‚æ•°é…ç½® TLSStores TLS å­˜å‚¨é…ç½® ServersTransport traefik ä¸åç«¯ä¹‹é—´çš„ä¼ è¾“é…ç½® 2 Traefik éƒ¨ç½² traefik æ˜¯æ”¯æŒ helm éƒ¨ç½²çš„ï¼Œä½†æ˜¯æŸ¥çœ‹ helm åŒ…çš„ value.yaml é…ç½®å‘ç°æ€»å…±æœ‰ 500 å¤šè¡Œé…ç½®ï¼Œå½“éœ€è¦ä¿®æ”¹é…ç½®é¡¹æˆ–è€…å¯¹ traefik åšä¸€ä¸‹è‡ªå®šä¹‰é…ç½®æ—¶ï¼Œå¹¶ä¸çµæ´»ã€‚å¦‚æœåªæ˜¯ä½¿ç”¨ traefik çš„åŸºç¡€åŠŸèƒ½ï¼Œæ¨èä½¿ç”¨ helm éƒ¨ç½²ã€‚å¦‚æœæƒ³æ·±å…¥ç ”ç©¶ä½¿ç”¨ traefik çš„è¯ï¼Œæ¨èä½¿ç”¨è‡ªå®šä¹‰æ–¹å¼éƒ¨ç½²ã€‚\n2.1 crd rbac serviceaccount crd\n[root@k8s-node1 ~]# mkdir /opt/traefik [root@k8s-node1 ~]# cd /opt/traefik [root@k8s-node1 traefik]# wget https://raw.githubusercontent.com/traefik/traefik/v2.9/docs/content/reference/dynamic-configuration/kubernetes-crd-definition-v1.yml [root@k8s-node1 traefik]# kubectl apply -f kubernetes-crd-definition-v1.yml rbac\n[root@k8s-node1 traefik]# wget https://raw.githubusercontent.com/traefik/traefik/v2.9/docs/content/reference/dynamic-configuration/kubernetes-crd-rbac.yml [root@k8s-node1 traefik]# kubectl apply -f kubernetes-crd-rbac.yml clusterrole.rbac.authorization.k8s.io/traefik-ingress-controller created clusterrolebinding.rbac.authorization.k8s.io/traefik-ingress-controller created serviceaccount.yml\napiVersion: v1 kind: Namespace metadata: name: traefik --- apiVersion: v1 kind: ServiceAccount metadata: namespace: traefik name: traefik-ingress-controller --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: traefik-ingress-controller roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: traefik-ingress-controller subjects: - kind: ServiceAccount name: traefik-ingress-controller namespace: traefik 2.2 configmap åœ¨ Traefik ä¸­æœ‰ä¸‰ç§æ–¹å¼å®šä¹‰é™æ€é…ç½®ï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­ã€åœ¨å‘½ä»¤è¡Œå‚æ•°ä¸­ã€é€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’ï¼Œç”±äº Traefik é…ç½®å¾ˆå¤šï¼Œé€šè¿‡ CLI å®šä¹‰ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œä¸€èˆ¬æ—¶å€™é€‰æ‹©å°†å…¶é…ç½®é€‰é¡¹æ”¾åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼Œç„¶åå­˜å…¥ ConfigMapï¼Œå°†å…¶æŒ‚å…¥ traefik ä¸­ã€‚\nconfigmap.yml æ–‡ä»¶å†…å®¹ï¼š\napiVersion: v1 kind: ConfigMap metadata: name: traefik-config namespace: traefik data: traefik.yaml: |- global: checkNewVersion: false # å‘¨æœŸæ€§çš„æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬å‘å¸ƒ sendAnonymousUsage: false # å‘¨æœŸæ€§çš„åŒ¿åå‘é€ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯ serversTransport: insecureSkipVerify: true # Traefikå¿½ç•¥éªŒè¯ä»£ç†æœåŠ¡çš„TLSè¯ä¹¦ api: insecure: true # å…è®¸HTTP æ–¹å¼è®¿é—®API dashboard: true # å¯ç”¨Dashboard debug: false # å¯ç”¨Debugè°ƒè¯•æ¨¡å¼ metrics: prometheus: # é…ç½®Prometheusç›‘æ§æŒ‡æ ‡æ•°æ®ï¼Œå¹¶ä½¿ç”¨é»˜è®¤é…ç½® addRoutersLabels: true # æ·»åŠ routers metrics entryPoint: \"metrics\" # æŒ‡å®šmetricsç›‘å¬åœ°å€ entryPoints: web: address: \":80\" # é…ç½®80ç«¯å£ï¼Œå¹¶è®¾ç½®å…¥å£åç§°ä¸º web forwardedHeaders: insecure: true # ä¿¡ä»»æ‰€æœ‰çš„forward headers websecure: address: \":443\" # é…ç½®443ç«¯å£ï¼Œå¹¶è®¾ç½®å…¥å£åç§°ä¸º websecure forwardedHeaders: insecure: true traefik: address: \":9000\" # é…ç½®9000ç«¯å£ä¸º dashboard çš„ç«¯å£ï¼Œä¸è®¾ç½®é»˜è®¤å€¼ä¸º 8080 metrics: address: \":9100\" # é…ç½®9100ç«¯å£ï¼Œä½œä¸ºmetricsæ”¶é›†å…¥å£ tcpep: address: \":9200\" # é…ç½®9200ç«¯å£ï¼Œä½œä¸ºtcpå…¥å£ udpep: address: \":9300/udp\" # é…ç½®9300ç«¯å£ï¼Œä½œä¸ºudpå…¥å£ providers: kubernetesIngress: \"\" # å¯ç”¨ Kubernetes Ingress æ–¹å¼æ¥é…ç½®è·¯ç”±è§„åˆ™ kubernetesGateway: \"\" # å¯ç”¨ Kubernetes Gateway API kubernetesCRD: # å¯ç”¨Kubernetes CRDæ–¹å¼æ¥é…ç½®è·¯ç”±è§„åˆ™ ingressClass: \"\" # æŒ‡å®štraefikçš„ingressClassåç§° allowCrossNamespace: true #å…è®¸è·¨namespace allowEmptyServices: true #å…è®¸ç©ºendpointsçš„service log: filePath: \"/etc/traefik/logs/traefik.log\" # è®¾ç½®è°ƒè¯•æ—¥å¿—æ–‡ä»¶å­˜å‚¨è·¯å¾„ï¼Œå¦‚æœä¸ºç©ºåˆ™è¾“å‡ºåˆ°æ§åˆ¶å° level: \"DEBUG\" # è®¾ç½®è°ƒè¯•æ—¥å¿—çº§åˆ« format: \"json\" # è®¾ç½®è°ƒè¯•æ—¥å¿—æ ¼å¼ accessLog: filePath: \"/etc/traefik/logs/access.log\" # è®¾ç½®è®¿é—®æ—¥å¿—æ–‡ä»¶å­˜å‚¨è·¯å¾„ï¼Œå¦‚æœä¸ºç©ºåˆ™è¾“å‡ºåˆ° stdout å’Œ stderr format: \"json\" # è®¾ç½®è®¿é—®è°ƒè¯•æ—¥å¿—æ ¼å¼ bufferingSize: 0 # è®¾ç½®è®¿é—®æ—¥å¿—ç¼“å­˜è¡Œæ•° fields: # è®¾ç½®è®¿é—®æ—¥å¿—ä¸­çš„å­—æ®µæ˜¯å¦ä¿ç•™ï¼ˆkeepä¿ç•™ã€dropä¸ä¿ç•™ï¼‰ defaultMode: keep # è®¾ç½®é»˜è®¤ä¿ç•™è®¿é—®æ—¥å¿—å­—æ®µ names: # é’ˆå¯¹è®¿é—®æ—¥å¿—ç‰¹åˆ«å­—æ®µç‰¹åˆ«é…ç½®ä¿ç•™æ¨¡å¼ ClientUsername: drop StartUTC: drop # ç¦ç”¨æ—¥å¿—timestampä½¿ç”¨UTC headers: # è®¾ç½®Headerä¸­å­—æ®µæ˜¯å¦ä¿ç•™ defaultMode: keep # è®¾ç½®é»˜è®¤ä¿ç•™Headerä¸­å­—æ®µ names: # é’ˆå¯¹Headerä¸­ç‰¹åˆ«å­—æ®µç‰¹åˆ«é…ç½®ä¿ç•™æ¨¡å¼ # User-Agent: redact# å¯ä»¥é’ˆå¯¹æŒ‡å®šagent Authorization: drop Content-Type: keep è®¾ç½®èŠ‚ç‚¹ labelï¼Œç”¨äºæ§åˆ¶åœ¨å“ªäº›èŠ‚ç‚¹éƒ¨ç½² Traefikï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ k8s-node1(master) èŠ‚ç‚¹ä½œä¸ºè¾¹ç¼˜èŠ‚ç‚¹éƒ¨ç½²\nkubectl label node k8s-node1 IngressProxy=true 2.3 deployment service ä½¿ç”¨ DeamonSet æˆ–è€… Deployment å‡å¯ï¼Œæ­¤å¤„ä½¿ç”¨ Deployment æ–¹å¼éƒ¨ç½² Traefikï¼Œè°ƒåº¦è‡³å«æœ‰ IngressProxy=true çš„è¾¹ç¼˜èŠ‚ç‚¹\nåŒæ—¶ä½¿ç”¨ podAntiAffinity é¿å…å¤šä¸ª traefik å®ä¾‹è¿è¡Œåœ¨åŒä¸€èŠ‚ç‚¹é€ æˆå•ç‚¹æ•…éšœ.\nkubectl apply -f deployment.yml\napiVersion: apps/v1 kind: Deployment metadata: name: traefik namespace: traefik labels: app: traefik spec: replicas: 1 selector: matchLabels: app: traefik template: metadata: name: traefik labels: app: traefik spec: affinity: podAntiAffinity: requiredDuringSchedulingIgnoredDuringExecution: - labelSelector: matchExpressions: - key: app operator: In values: - traefik topologyKey: \"kubernetes.io/hostname\" spec: serviceAccountName: traefik-ingress-controller terminationGracePeriodSeconds: 5 # ç­‰å¾…å®¹å™¨ä¼˜é›…é€€å‡ºçš„æ—¶é•¿ tolerations: # è®¾ç½®å®¹å¿æ‰€æœ‰æ±¡ç‚¹ï¼Œé˜²æ­¢èŠ‚ç‚¹è¢«è®¾ç½®æ±¡ç‚¹ - operator: \"Exists\" nodeSelector: # è®¾ç½®nodeç­›é€‰å™¨ï¼Œåœ¨ç‰¹å®šlabelçš„èŠ‚ç‚¹ä¸Šå¯åŠ¨ IngressProxy: \"true\" # è°ƒåº¦è‡³IngressProxy: \"true\"çš„èŠ‚ç‚¹ containers: - name: traefik image: traefik:v2.9 env: - name: KUBERNETES_SERVICE_HOST # æ‰‹åŠ¨æŒ‡å®šk8s api,é¿å…ç½‘ç»œç»„ä»¶ä¸ç¨³å®šã€‚ value: \"1.1.1.1\" - name: KUBERNETES_SERVICE_PORT_HTTPS # API serverç«¯å£ value: \"6443\" - name: KUBERNETES_SERVICE_PORT # API serverç«¯å£ value: \"6443\" - name: TZ # æŒ‡å®šæ—¶åŒº value: \"Asia/Shanghai\" ports: - name: web containerPort: 80 - name: websecure containerPort: 443 - name: dashboard containerPort: 9000 # Traefik Dashboard ç«¯å£ - name: metrics containerPort: 9100 - name: tcpep containerPort: 9200 # tcpç«¯å£ - name: udpep containerPort: 9300 # udpç«¯å£ securityContext: # åªå¼€æ”¾ç½‘ç»œæƒé™ capabilities: drop: - ALL add: - NET_BIND_SERVICE args: - --configfile=/etc/traefik/config/traefik.yaml volumeMounts: - mountPath: /etc/traefik/config name: config - mountPath: /etc/traefik/logs name: logdir - mountPath: /etc/localtime name: timezone readOnly: true resources: requests: memory: \"5Mi\" cpu: \"10m\" limits: memory: \"256Mi\" cpu: \"1000m\" volumes: - name: config # traefiké…ç½®æ–‡ä»¶ configMap: name: traefik-config - name: logdir # traefikæ—¥å¿—ç›®å½• hostPath: path: /var/log/traefik type: \"DirectoryOrCreate\" - name: timezone # æŒ‚è½½æ—¶åŒºæ–‡ä»¶ hostPath: path: /etc/localtime type: File service kubectl apply -f service.yml\napiVersion: v1 kind: Service metadata: labels: app: traefik name: traefik # å®é™…æä¾›æœåŠ¡çš„ service, ä½¿ç”¨ NodePort æ¨¡å¼ namespace: traefik spec: type: NodePort selector: app: traefik ports: - name: web protocol: TCP port: 80 targetPort: 80 nodePort: 80 - name: websecure protocol: TCP port: 443 targetPort: 443 nodePort: 443 - name: dashboard protocol: TCP port: 9000 targetPort: 9000 nodePort: 9000 - name: tcpep protocol: TCP port: 9200 targetPort: 9200 nodePort: 9200 - name: udpep protocol: UDP port: 9300 targetPort: 9300 nodePort: 9300 --- apiVersion: v1 kind: Service metadata: labels: app: traefik-metrics name: traefik-metrics # metrics ç”¨äºç»™é›†ç¾¤å†…çš„ prometheus æä¾›æ•°æ® namespace: traefik spec: selector: app: traefik ports: - name: metrics protocol: TCP port: 9100 targetPort: 9100 2.4 éªŒè¯ [root@k8s-node1 traefik]# kubectl get pod,cm,sa,svc -n traefik |grep traefik pod/traefik-69bd67497f-v27qp 1/1 Running 0 12m configmap/traefik-config 1 7d5h serviceaccount/traefik-ingress-controller 1 7d5h service/traefik NodePort 10.101.142.158 80:80/TCP,443:443/TCP,9000:9000/TCP,9200:9200/TCP,9300:9300/UDP 11m service/traefik-metrics ClusterIP 10.98.89.13 9100/TCP 12m å¯ä»¥ç›´æ¥é€šè¿‡ http://1.1.1.1:9000 è®¿é—®åˆ° dashboard\n2.5 å…¶ä»–é…ç½® 2.5.1 å¼ºåˆ¶ä½¿ç”¨ TLS v1.2+ å®˜æ–¹æ–‡æ¡£\nå¦‚ä»Šï¼ŒTLS v1.0 å’Œ v1.1 å› ä¸ºå­˜åœ¨å®‰å…¨é—®é¢˜ï¼Œç°åœ¨å·²è¢«å¼ƒç”¨ã€‚ä¸ºäº†ä¿éšœç³»ç»Ÿå®‰å…¨ï¼Œæ‰€æœ‰å…¥å£è·¯ç”±éƒ½åº”è¯¥å¼ºåˆ¶ä½¿ç”¨ TLS v1.2 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚\n[root@k8s-node1 traefik]# tee traefik-tlsoption.yml \u003c\u003c-'EOF' apiVersion: traefik.containo.us/v1alpha1 kind: TLSOption metadata: name: default namespace: traefik spec: minVersion: VersionTLS12 cipherSuites: - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 # TLS 1.2 - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305 # TLS 1.2 - TLS_AES_256_GCM_SHA384 # TLS 1.3 - TLS_CHACHA20_POLY1305_SHA256 # TLS 1.3 curvePreferences: - CurveP521 - CurveP384 sniStrict: true EOF [root@k8s-node1 traefik]# kubectl apply -f traefik-tlsoption.yml tlsoption.traefik.containo.us/default created 2.5.2 æ—¥å¿—åˆ‡å‰² å®˜æ–¹å¹¶æ²¡æœ‰æ—¥å¿—è½®æ¢çš„åŠŸèƒ½ï¼Œä½†æ˜¯ traefik æ”¶åˆ° USR1 ä¿¡å·åä¼šé‡å»ºæ—¥å¿—æ–‡ä»¶ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ logrotate å®ç°æ—¥å¿—è½®æ¢\nmkdir -p /etc/logrotate.d/traefik tee /etc/logrotate.d/traefik/config \u003c\u003c-'EOF' /var/log/traefik/*.log { daily rotate 15 missingok notifempty compress dateext dateyesterday dateformat .%Y-%m-%d create 0644 root root postrotate docker kill --signal=\"USR1\" $(docker ps | grep traefik |grep -v pause| awk '{print $1}') endscript } EOF åˆ›å»ºå®šæ—¶ä»»åŠ¡\ncrontab -e 0 0 * * * /usr/sbin/logrotate -f /etc/logrotate.d/traefik/config \u003e/dev/null 2\u003e\u00261 2.6 å¤šæ§åˆ¶å™¨ æœ‰çš„ä¸šåŠ¡åœºæ™¯ä¸‹å¯èƒ½éœ€è¦åœ¨ä¸€ä¸ªé›†ç¾¤ä¸­éƒ¨ç½²å¤šä¸ª traefikï¼Œä¾‹å¦‚ï¼šé¿å…å•ä¸ª traefik é…ç½®è§„åˆ™è¿‡å¤šå¯¼è‡´åŠ è½½å¤„ç†ç¼“æ…¢ã€‚æ¯ä¸ª namespace éƒ¨ç½²ä¸€ä¸ª traefikã€‚æˆ–è€… traefik ç”Ÿäº§ä¸æµ‹è¯•ç¯å¢ƒåŒºåˆ†ç­‰åœºæ™¯ï¼Œéœ€è¦ä¸åŒçš„å®ä¾‹æ§åˆ¶ä¸åŒçš„ IngressRoute èµ„æºå¯¹è±¡ï¼Œè¦å®ç°è¯¥åŠŸèƒ½æœ‰ä¸¤ç§æ–¹æ³•\n2.6.1 annotations æ³¨è§£ç­›é€‰ é¦–å…ˆåœ¨ traefik é…ç½®æ–‡ä»¶ä¸­çš„ providers ä¸‹å¢åŠ  Ingressclass å‚æ•°ï¼ŒæŒ‡å®šå…·ä½“çš„å€¼\nproviders: kubernetesCRD: # å¯ç”¨Kubernetes CRDæ–¹å¼æ¥é…ç½®è·¯ç”±è§„åˆ™ ingressClass: \"traefik-v2.9\" # æŒ‡å®štraefikçš„ingressClasså®ä¾‹åç§° allowCrossNamespace: true #å…è®¸è·¨namespace allowEmptyServices: true #å…è®¸ç©ºendpointsçš„service æ¥ä¸‹æ¥åœ¨ IngressRoute èµ„æºå¯¹è±¡ä¸­çš„ annotations å‚æ•°ä¸­æ·»åŠ  kubernetes.io/ingress.class: traefik-v2.9 å³å¯\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: dashboard namespace: traefik annotations: kubernetes.io/ingress.class: traefik-v2.9 # å› ä¸ºé™æ€é…ç½®æ–‡ä»¶æŒ‡å®šäº†ingressclassï¼Œæ‰€ä»¥è¿™é‡Œçš„annotations è¦æŒ‡å®šï¼Œå¦åˆ™è®¿é—®ä¼š404 spec: entryPoints: - web routes: - match: Host(`traefik.test.com`) kind: Rule services: - name: api@internal kind: TraefikService namespace: traefik 2.6.2 label æ ‡ç­¾é€‰æ‹©å™¨ç­›é€‰ é¦–å…ˆåœ¨ traefik é…ç½®æ–‡ä»¶ä¸­çš„ providers ä¸‹å¢åŠ  labelSelector å‚æ•°ï¼ŒæŒ‡å®šå…·ä½“çš„æ ‡ç­¾é”®å€¼ã€‚\nproviders: kubernetesCRD: # å¯ç”¨Kubernetes CRDæ–¹å¼æ¥é…ç½®è·¯ç”±è§„åˆ™ # ingressClass: \"traefik-v2.9\" # æŒ‡å®štraefikçš„ingressClassåç§° labelSelector: \"app=traefik-v2.9\" # é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨æŒ‡å®štraefikæ ‡ç­¾ allowCrossNamespace: true #å…è®¸è·¨namespace allowEmptyServices: true #å…è®¸ç©ºendpointsçš„service ç„¶ååœ¨ IngressRoute èµ„æºå¯¹è±¡ä¸­æ·»åŠ  labels æ ‡ç­¾é€‰æ‹©å™¨ï¼Œé€‰æ‹© app: traefik-v2.9 è¿™ä¸ªæ ‡ç­¾å³å¯\napiVersion: traefik.containo.us/v1alpha1 kind: IngressRoute metadata: name: dashboard labels: # é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨ï¼Œè¯¥IngressRouteèµ„æºç”±é…ç½®äº†app=traefik-v2.9çš„traefikå¤„ç† app: traefik-v2.9 # annotations: # kubernetes.io/ingress.class: traefik-v2.9 spec: entryPoints: - web routes: - match: Host(`traefik.test.com`) kind: Rule services: - name: api@internal kind: TraefikService namespace: traefik ä»¥ä¸Š\n","wordCount":"3331","inLanguage":"en","image":"https://image.lvbibir.cn/blog/traefik.png","datePublished":"2023-04-17T00:00:00Z","dateModified":"2024-01-28T00:00:00Z","author":{"@type":"Person","name":"lvbibir"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.lvbibir.cn/posts/tech/kubernetes-traefik-1-deploy/"},"publisher":{"@type":"Organization","name":"lvbibir's Blog","logo":{"@type":"ImageObject","url":"https://image.lvbibir.cn/blog/avatar.webp"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://www.lvbibir.cn accesskey=h title="lvbibir's Blog (Alt + H)"><img src=https://image.lvbibir.cn/blog/avatar.webp alt aria-label=logo height=35>lvbibir's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li class=menu-item><a href=https://www.lvbibir.cn/search title="ğŸ” æœç´¢ (Alt + /)" accesskey=/><span>ğŸ” æœç´¢</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/posts title="ğŸ“š æ–‡ç« "><span>ğŸ“š æ–‡ç« </span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/archives title="ğŸ“ˆ å½’æ¡£"><span>ğŸ“ˆ å½’æ¡£</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/talk title="ğŸ’¬ è¯´è¯´"><span>ğŸ’¬ è¯´è¯´</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/links title="ğŸ¤ å‹é“¾"><span>ğŸ¤ å‹é“¾</span></a></li></ul></nav></header><main class="main page"><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://www.lvbibir.cn>ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://www.lvbibir.cn/posts/>ğŸ“š æ–‡ç« </a>&nbsp;Â»&nbsp;<a href=https://www.lvbibir.cn/posts/tech/>ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a></div><h1 class=post-title>traefik (ä¸€) ç®€ä»‹ã€éƒ¨ç½²å’Œé…ç½®</h1><div class=post-description>kubernetes ä¸­ Traefik ingress çš„ç®€ä»‹ã€éƒ¨ç½²åŠé…ç½®ã€‚</div><div class=post-meta>åˆ›å»º:&nbsp;<span title='2023-04-17 00:00:00 +0000 UTC'>2023-04-17</span>&nbsp;|&nbsp;æ›´æ–°:&nbsp;2024-01-28&nbsp;|&nbsp;å­—æ•°:&nbsp;3331å­—&nbsp;|&nbsp;ä½œè€…:&nbsp;lvbibir
|&nbsp;æ ‡ç­¾:&nbsp;<ul class=post-tags-meta><a href=https://www.lvbibir.cn/tags/traefik/>traefik</a>
<a href=https://www.lvbibir.cn/tags/kubernetes/>ã€kubernetes</a></ul><span id=busuanzi_container_page_pv>&nbsp;|&nbsp;è®¿é—®:&nbsp;<span id=busuanzi_page_pv></span></span></div></header><button id=toc-toggle-btn class=toc-toggle-btn aria-label="Toggle Table of Contents" title=æ–‡ç« ç›®å½•><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2zm0 4h14v-2H3v2zm0 4h14v-2H3v2zm16 0h2v-2h-2v2zm0-10v2h2V7h-2zm0 6h2v-2h-2v2z"/></svg></button><div id=toc-overlay class=toc-overlay></div><aside id=toc-container class="toc-container wide"><button id=toc-close-btn class=toc-close-btn aria-label="Close Table of Contents"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>æ–‡ç« ç›®å½•</span></summary><div class=inner><ul><li><a href=#0-%e5%89%8d%e8%a8%80 aria-label="0 å‰è¨€">0 å‰è¨€</a></li><li><a href=#1-%e7%ae%80%e4%bb%8b aria-label="1 ç®€ä»‹">1 ç®€ä»‹</a><ul><li><a href=#11-traefik-%e7%ae%80%e4%bb%8b aria-label="1.1 Traefik ç®€ä»‹">1.1 Traefik ç®€ä»‹</a></li><li><a href=#12-traefik-%e6%a0%b8%e5%bf%83%e7%bb%84%e4%bb%b6 aria-label="1.2 Traefik æ ¸å¿ƒç»„ä»¶">1.2 Traefik æ ¸å¿ƒç»„ä»¶</a></li><li><a href=#13-traefik-crd-%e8%b5%84%e6%ba%90 aria-label="1.3 Traefik CRD èµ„æº">1.3 Traefik CRD èµ„æº</a></li></ul></li><li><a href=#2-traefik-%e9%83%a8%e7%bd%b2 aria-label="2 Traefik éƒ¨ç½²">2 Traefik éƒ¨ç½²</a><ul><li><a href=#21-crd-rbac-serviceaccount aria-label="2.1 crd rbac serviceaccount">2.1 crd rbac serviceaccount</a></li><li><a href=#22-configmap aria-label="2.2 configmap">2.2 configmap</a></li><li><a href=#23-deployment-service aria-label="2.3 deployment service">2.3 deployment service</a></li><li><a href=#24-%e9%aa%8c%e8%af%81 aria-label="2.4 éªŒè¯">2.4 éªŒè¯</a></li><li><a href=#25-%e5%85%b6%e4%bb%96%e9%85%8d%e7%bd%ae aria-label="2.5 å…¶ä»–é…ç½®">2.5 å…¶ä»–é…ç½®</a><ul><li><a href=#251-%e5%bc%ba%e5%88%b6%e4%bd%bf%e7%94%a8-tls-v12 aria-label="2.5.1 å¼ºåˆ¶ä½¿ç”¨ TLS v1.2+">2.5.1 å¼ºåˆ¶ä½¿ç”¨ TLS v1.2+</a></li><li><a href=#252-%e6%97%a5%e5%bf%97%e5%88%87%e5%89%b2 aria-label="2.5.2 æ—¥å¿—åˆ‡å‰²">2.5.2 æ—¥å¿—åˆ‡å‰²</a></li></ul></li><li><a href=#26-%e5%a4%9a%e6%8e%a7%e5%88%b6%e5%99%a8 aria-label="2.6 å¤šæ§åˆ¶å™¨">2.6 å¤šæ§åˆ¶å™¨</a><ul><li><a href=#261-annotations-%e6%b3%a8%e8%a7%a3%e7%ad%9b%e9%80%89 aria-label="2.6.1 annotations æ³¨è§£ç­›é€‰">2.6.1 annotations æ³¨è§£ç­›é€‰</a></li><li><a href=#262-label-%e6%a0%87%e7%ad%be%e9%80%89%e6%8b%a9%e5%99%a8%e7%ad%9b%e9%80%89 aria-label="2.6.2 label æ ‡ç­¾é€‰æ‹©å™¨ç­›é€‰">2.6.2 label æ ‡ç­¾é€‰æ‹©å™¨ç­›é€‰</a></li></ul></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;const tocContainer=document.getElementById("toc-container"),tocToggleBtn=document.getElementById("toc-toggle-btn"),tocCloseBtn=document.getElementById("toc-close-btn"),tocOverlay=document.getElementById("toc-overlay");window.addEventListener('DOMContentLoaded',function(){if(checkTocPosition(),elements=document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]'),elements.length>0){activeElement=elements[0];const t=encodeURI(activeElement.getAttribute('id')).toLowerCase(),e=document.querySelector(`.inner ul li a[href="#${t}"]`);e&&e.classList.add('active')}},!1),window.addEventListener('resize',function(){checkTocPosition()},!1),window.addEventListener('scroll',()=>{if(!elements||elements.length===0)return;activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(t=>{const n=encodeURI(t.getAttribute('id')).toLowerCase(),e=document.querySelector(`.inner ul li a[href="#${n}"]`);e&&(t===activeElement?e.classList.add('active'):e.classList.remove('active'))})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue('--gap'),10);let isWideMode=!1,isTocVisible=!0;function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?(isWideMode=!0,isTocVisible?(tocContainer.classList.add("wide"),tocContainer.classList.remove("collapsed"),tocContainer.classList.remove("mobile-popup"),tocToggleBtn.classList.add("active")):(tocContainer.classList.remove("wide"),tocContainer.classList.add("collapsed"),tocContainer.classList.remove("mobile-popup"),tocToggleBtn.classList.remove("active")),closeTocPopup()):(isWideMode=!1,tocContainer.classList.remove("wide"),tocContainer.classList.contains("mobile-popup")||tocContainer.classList.add("collapsed"),tocContainer.classList.contains("active")?tocToggleBtn.classList.add("active"):tocToggleBtn.classList.remove("active"))}function openTocPopup(){tocContainer.classList.remove("collapsed"),tocContainer.classList.add("mobile-popup"),tocContainer.classList.add("active"),tocOverlay.classList.add("active"),tocToggleBtn.classList.add("active"),document.body.style.overflow="hidden"}function closeTocPopup(){tocContainer.classList.remove("active"),tocOverlay.classList.remove("active"),document.body.style.overflow="",setTimeout(()=>{tocContainer.classList.contains("active")||(tocContainer.classList.remove("mobile-popup"),(!isWideMode||!isTocVisible)&&tocContainer.classList.add("collapsed"))},300)}function toggleToc(){isWideMode?(isTocVisible=!isTocVisible,isTocVisible?(tocContainer.classList.add("wide"),tocContainer.classList.remove("collapsed"),tocToggleBtn.classList.add("active")):(tocContainer.classList.remove("wide"),tocContainer.classList.add("collapsed"),tocToggleBtn.classList.remove("active"))):tocContainer.classList.contains("active")?(closeTocPopup(),tocToggleBtn.classList.remove("active")):openTocPopup()}tocToggleBtn.addEventListener('click',function(){toggleToc()}),tocCloseBtn.addEventListener('click',function(){closeTocPopup(),tocToggleBtn.classList.remove("active")}),tocOverlay.addEventListener('click',function(){closeTocPopup(),tocToggleBtn.classList.remove("active")}),tocContainer.querySelectorAll('.inner a').forEach(function(e){e.addEventListener('click',function(){tocContainer.classList.contains("mobile-popup")&&(closeTocPopup(),tocToggleBtn.classList.remove("active"))})}),document.addEventListener('keydown',function(e){e.key==='Escape'&&tocContainer.classList.contains("active")&&(closeTocPopup(),tocToggleBtn.classList.remove("active"))});function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=0-å‰è¨€>0 å‰è¨€<a hidden class=anchor aria-hidden=true href=#0-å‰è¨€>#</a></h1><p>æœ¬æ–‡å‚è€ƒä»¥ä¸‹é“¾æ¥:</p><ul><li><a href=https://www.cuiliangblog.cn/detail/section/29427812 target=_blank rel=noopener style=color:#42b983 ;>https://www.cuiliangblog.cn/detail/section/29427812</a></li></ul><p>åŸºäº <code>centos7.9</code>ï¼Œ<code>docker-ce-20.10.18</code>ï¼Œ<code>kubelet-1.22.3-0</code>ï¼Œ <code>traefik-2.9.10</code></p><h1 id=1-ç®€ä»‹>1 ç®€ä»‹<a hidden class=anchor aria-hidden=true href=#1-ç®€ä»‹>#</a></h1><h2 id=11-traefik-ç®€ä»‹>1.1 Traefik ç®€ä»‹<a hidden class=anchor aria-hidden=true href=#11-traefik-ç®€ä»‹>#</a></h2><p>Traefik æ˜¯ä¸€ä¸ªä¸ºäº†è®©éƒ¨ç½²å¾®æœåŠ¡æ›´åŠ ä¾¿æ·è€Œè¯ç”Ÿçš„ç°ä»£ HTTP åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡å·¥å…·ã€‚ å®ƒæ”¯æŒå¤šç§åå° (<a href=https://www.docker.com/ target=_blank rel=noopener style=color:#42b983 ;>Docker</a>, <a href=https://docs.docker.com/swarm target=_blank rel=noopener style=color:#42b983 ;>Swarm</a>, <a href=http://kubernetes.io/ target=_blank rel=noopener style=color:#42b983 ;>Kubernetes</a>, <a href=https://mesosphere.github.io/marathon/ target=_blank rel=noopener style=color:#42b983 ;>Marathon</a>, <a href=https://github.com/apache/mesos target=_blank rel=noopener style=color:#42b983 ;>Mesos</a>, <a href=https://www.consul.io/ target=_blank rel=noopener style=color:#42b983 ;>Consul</a>, <a href=https://coreos.com/etcd/ target=_blank rel=noopener style=color:#42b983 ;>Etcd</a>, <a href=https://zookeeper.apache.org/ target=_blank rel=noopener style=color:#42b983 ;>Zookeeper</a>, <a href=https://github.com/boltdb/bolt target=_blank rel=noopener style=color:#42b983 ;>BoltDB</a>, Rest API, fileâ€¦) æ¥è‡ªåŠ¨åŒ–ã€åŠ¨æ€çš„åº”ç”¨å®ƒçš„é…ç½®æ–‡ä»¶è®¾ç½®ã€‚</p><p>å®ƒæ˜¯ä¸€ä¸ªè¾¹ç¼˜è·¯ç”±å™¨ï¼Œå®ƒä¼šæ‹¦æˆªå¤–éƒ¨çš„è¯·æ±‚å¹¶æ ¹æ®é€»è¾‘è§„åˆ™é€‰æ‹©ä¸åŒçš„æ“ä½œæ–¹å¼ï¼Œè¿™äº›è§„åˆ™å†³å®šç€è¿™äº›è¯·æ±‚åˆ°åº•è¯¥å¦‚ä½•å¤„ç†ã€‚Traefik æä¾›è‡ªåŠ¨å‘ç°èƒ½åŠ›ï¼Œä¼šå®æ—¶æ£€æµ‹æœåŠ¡ï¼Œå¹¶è‡ªåŠ¨æ›´æ–°è·¯ç”±è§„åˆ™ã€‚</p><p><img class=lazyload src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-src=https://image.lvbibir.cn/blog/traefik-architecture.png alt=traefik-architecture decoding=async><noscript><img src=https://image.lvbibir.cn/blog/traefik-architecture.png alt=traefik-architecture></noscript></p><h2 id=12-traefik-æ ¸å¿ƒç»„ä»¶>1.2 Traefik æ ¸å¿ƒç»„ä»¶<a hidden class=anchor aria-hidden=true href=#12-traefik-æ ¸å¿ƒç»„ä»¶>#</a></h2><p><img class=lazyload src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-src=https://image.lvbibir.cn/blog/v2-b67cb6ed0ac457009296459fe974cef4_r.jpg alt=img decoding=async><noscript><img src=https://image.lvbibir.cn/blog/v2-b67cb6ed0ac457009296459fe974cef4_r.jpg alt=img></noscript></p><p>ä»ä¸Šå›¾å¯çŸ¥ï¼Œå½“è¯·æ±‚ Traefik æ—¶ï¼Œè¯·æ±‚é¦–å…ˆåˆ° <code>entrypoints</code>ï¼Œç„¶ååˆ†æä¼ å…¥çš„è¯·æ±‚ï¼ŒæŸ¥çœ‹ä»–ä»¬æ˜¯å¦ä¸å®šä¹‰çš„ <code>Routers</code> åŒ¹é…ã€‚å¦‚æœåŒ¹é…ï¼Œåˆ™ä¼šé€šè¿‡ä¸€ç³»åˆ— <code>middlewares</code> å¤„ç†ï¼Œå†åˆ° <code>traefikServices</code> ä¸Šåšæµé‡è½¬å‘ï¼Œæœ€åè¯·æ±‚åˆ° <code>kubernetesçš„servicesä¸Š</code> ã€‚</p><p>è¿™å°±æ¶‰åŠåˆ°ä»¥ä¸‹å‡ ä¸ªé‡è¦çš„æ ¸å¿ƒç»„ä»¶:</p><ul><li><strong><a href=https://doc.traefik.io/traefik/providers/overview/ target=_blank rel=noopener style=color:#42b983 ;>Providers</a></strong> æ˜¯åŸºç¡€ç»„ä»¶ï¼ŒTraefik çš„é…ç½®å‘ç°æ˜¯é€šè¿‡å®ƒæ¥å®ç°çš„ï¼Œå®ƒå¯ä»¥æ˜¯åè°ƒå™¨ï¼Œå®¹å™¨å¼•æ“ï¼Œäº‘æä¾›å•†æˆ–è€…é”®å€¼å­˜å‚¨ã€‚Traefik é€šè¿‡æŸ¥è¯¢ <code>Providers</code> çš„ <code>API</code> æ¥æŸ¥è¯¢è·¯ç”±çš„ç›¸å…³ä¿¡æ¯ï¼Œä¸€æ—¦æ£€æµ‹åˆ°å˜åŒ–ï¼Œå°±ä¼šåŠ¨æ€çš„æ›´æ–°è·¯ç”±ã€‚</li><li><strong><a href=https://doc.traefik.io/traefik/routing/entrypoints/ target=_blank rel=noopener style=color:#42b983 ;>Entrypoints</a></strong> æ˜¯ <code>Traefik</code> çš„ç½‘ç»œå…¥å£ï¼Œå®ƒå®šä¹‰æ¥æ”¶è¯·æ±‚çš„æ¥å£ï¼Œä»¥åŠæ˜¯å¦ç›‘å¬ TCP æˆ–è€… UDPã€‚</li><li><strong><a href=https://doc.traefik.io/traefik/routing/routers/ target=_blank rel=noopener style=color:#42b983 ;>Routers</a></strong> ä¸»è¦ç”¨äºåˆ†æè¯·æ±‚ï¼Œå¹¶è´Ÿè´£å°†è¿™äº›è¯·æ±‚è¿æ¥åˆ°å¯¹åº”çš„æœåŠ¡ä¸Šå»ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒRouters è¿˜å¯ä»¥ä½¿ç”¨ Middlewares æ¥æ›´æ–°è¯·æ±‚ï¼Œæ¯”å¦‚åœ¨æŠŠè¯·æ±‚å‘åˆ°æœåŠ¡ä¹‹å‰æ·»åŠ ä¸€äº› Headersã€‚</li><li><strong><a href=https://doc.traefik.io/traefik/routing/services/ target=_blank rel=noopener style=color:#42b983 ;>Services</a></strong> è´Ÿè´£é…ç½®å¦‚ä½•åˆ°è¾¾æœ€ç»ˆå°†å¤„ç†ä¼ å…¥è¯·æ±‚çš„å®é™…æœåŠ¡ã€‚</li><li><strong><a href=https://doc.traefik.io/traefik/middlewares/overview/ target=_blank rel=noopener style=color:#42b983 ;>Middlewares</a></strong> ç”¨æ¥ä¿®æ”¹è¯·æ±‚æˆ–è€…æ ¹æ®è¯·æ±‚æ¥åšå‡ºä¸€äº›åˆ¤æ–­ï¼ˆauthentication, rate limiting, headers, â€¦ï¼‰ï¼Œä¸­é—´ä»¶è¢«é™„ä»¶åˆ°è·¯ç”±ä¸Šï¼Œæ˜¯ä¸€ç§åœ¨è¯·æ±‚å‘é€åˆ°ä½ çš„<strong>æœåŠ¡</strong>ä¹‹å‰ï¼ˆæˆ–è€…åœ¨æœåŠ¡çš„å“åº”å‘é€åˆ°å®¢æˆ·ç«¯ä¹‹å‰ï¼‰è°ƒæ•´è¯·æ±‚çš„ä¸€ç§æ–¹æ³•ã€‚</li></ul><h2 id=13-traefik-crd-èµ„æº>1.3 Traefik CRD èµ„æº<a hidden class=anchor aria-hidden=true href=#13-traefik-crd-èµ„æº>#</a></h2><p><a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/ target=_blank rel=noopener style=color:#42b983 ;>å®˜æ–¹æ–‡æ¡£</a></p><p>traefik é€šè¿‡è‡ªå®šä¹‰èµ„æºå®ç°äº†å¯¹ traefik èµ„æºçš„åˆ›å»ºå’Œç®¡ç†ï¼Œæ”¯æŒçš„ crd èµ„æºç±»å‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><table><thead><tr><th>kind</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td><a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/#kind-ingressroute target=_blank rel=noopener style=color:#42b983 ;>IngressRoute</a></td><td>HTTP è·¯ç”±é…ç½®</td></tr><tr><td><a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/#kind-middleware target=_blank rel=noopener style=color:#42b983 ;>Middleware</a></td><td>HTTP ä¸­é—´ä»¶é…ç½®</td></tr><tr><td><a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/#kind-traefikservice target=_blank rel=noopener style=color:#42b983 ;>TraefikService</a></td><td>HTTP è´Ÿè½½å‡è¡¡/æµé‡å¤åˆ¶é…ç½®</td></tr><tr><td><a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/#kind-ingressroutetcp target=_blank rel=noopener style=color:#42b983 ;>IngressRouteTCP</a></td><td>TCP è·¯ç”±é…ç½®</td></tr><tr><td><a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/#kind-middlewaretcp target=_blank rel=noopener style=color:#42b983 ;>MiddlewareTCP</a></td><td>TCP ä¸­é—´ä»¶é…ç½®</td></tr><tr><td><a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/#kind-ingressrouteudp target=_blank rel=noopener style=color:#42b983 ;>IngressRouteUDP</a></td><td>UDP è·¯ç”±é…ç½®</td></tr><tr><td><a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/#kind-tlsoption target=_blank rel=noopener style=color:#42b983 ;>TLSOptions</a></td><td>TLS è¿æ¥å‚æ•°é…ç½®</td></tr><tr><td><a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/#kind-tlsstore target=_blank rel=noopener style=color:#42b983 ;>TLSStores</a></td><td>TLS å­˜å‚¨é…ç½®</td></tr><tr><td><a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/#kind-serverstransport target=_blank rel=noopener style=color:#42b983 ;>ServersTransport</a></td><td>traefik ä¸åç«¯ä¹‹é—´çš„ä¼ è¾“é…ç½®</td></tr></tbody></table><h1 id=2-traefik-éƒ¨ç½²>2 Traefik éƒ¨ç½²<a hidden class=anchor aria-hidden=true href=#2-traefik-éƒ¨ç½²>#</a></h1><p>traefik æ˜¯æ”¯æŒ helm éƒ¨ç½²çš„ï¼Œä½†æ˜¯æŸ¥çœ‹ helm åŒ…çš„ value.yaml é…ç½®å‘ç°æ€»å…±æœ‰ 500 å¤šè¡Œé…ç½®ï¼Œå½“éœ€è¦ä¿®æ”¹é…ç½®é¡¹æˆ–è€…å¯¹ traefik åšä¸€ä¸‹è‡ªå®šä¹‰é…ç½®æ—¶ï¼Œå¹¶ä¸çµæ´»ã€‚å¦‚æœåªæ˜¯ä½¿ç”¨ traefik çš„åŸºç¡€åŠŸèƒ½ï¼Œæ¨èä½¿ç”¨ helm éƒ¨ç½²ã€‚å¦‚æœæƒ³æ·±å…¥ç ”ç©¶ä½¿ç”¨ traefik çš„è¯ï¼Œæ¨èä½¿ç”¨è‡ªå®šä¹‰æ–¹å¼éƒ¨ç½²ã€‚</p><h2 id=21-crd-rbac-serviceaccount>2.1 crd rbac serviceaccount<a hidden class=anchor aria-hidden=true href=#21-crd-rbac-serviceaccount>#</a></h2><p>crd</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># mkdir /opt/traefik</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># cd /opt/traefik</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 traefik<span style=color:#5bc4bf>]</span><span style=color:#776e71># wget https://raw.githubusercontent.com/traefik/traefik/v2.9/docs/content/reference/dynamic-configuration/kubernetes-crd-definition-v1.yml</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 traefik<span style=color:#5bc4bf>]</span><span style=color:#776e71># kubectl apply -f kubernetes-crd-definition-v1.yml</span>
</span></span></code></pre></div><p>rbac</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 traefik<span style=color:#5bc4bf>]</span><span style=color:#776e71># wget https://raw.githubusercontent.com/traefik/traefik/v2.9/docs/content/reference/dynamic-configuration/kubernetes-crd-rbac.yml</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 traefik<span style=color:#5bc4bf>]</span><span style=color:#776e71># kubectl apply -f kubernetes-crd-rbac.yml</span>
</span></span><span style=display:flex><span>clusterrole.rbac.authorization.k8s.io/traefik-ingress-controller created
</span></span><span style=display:flex><span>clusterrolebinding.rbac.authorization.k8s.io/traefik-ingress-controller created
</span></span></code></pre></div><p>serviceaccount.yml</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#5bc4bf>apiVersion</span>: <span style=color:#f99b15>v1</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>Namespace</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span><span style=color:#fec418>---</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>apiVersion</span>: <span style=color:#f99b15>v1</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>ServiceAccount</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>namespace</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik-ingress-controller</span>
</span></span><span style=display:flex><span><span style=color:#fec418>---</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>apiVersion</span>: <span style=color:#f99b15>rbac.authorization.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>ClusterRoleBinding</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik-ingress-controller</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>roleRef</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>apiGroup</span>: <span style=color:#f99b15>rbac.authorization.k8s.io</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>ClusterRole</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik-ingress-controller</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>subjects</span>:
</span></span><span style=display:flex><span>  - <span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>ServiceAccount</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik-ingress-controller</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>namespace</span>: <span style=color:#f99b15>traefik</span>
</span></span></code></pre></div><h2 id=22-configmap>2.2 configmap<a hidden class=anchor aria-hidden=true href=#22-configmap>#</a></h2><p>åœ¨ Traefik ä¸­æœ‰ä¸‰ç§æ–¹å¼å®šä¹‰é™æ€é…ç½®ï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­ã€åœ¨å‘½ä»¤è¡Œå‚æ•°ä¸­ã€é€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’ï¼Œç”±äº Traefik é…ç½®å¾ˆå¤šï¼Œé€šè¿‡ CLI å®šä¹‰ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œä¸€èˆ¬æ—¶å€™é€‰æ‹©å°†å…¶é…ç½®é€‰é¡¹æ”¾åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼Œç„¶åå­˜å…¥ ConfigMapï¼Œå°†å…¶æŒ‚å…¥ traefik ä¸­ã€‚</p><p><code>configmap.yml</code> æ–‡ä»¶å†…å®¹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#5bc4bf>apiVersion</span>: <span style=color:#f99b15>v1</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>ConfigMap</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik-config</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>namespace</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>traefik.yaml</span>: |-<span style=color:#776e71>
</span></span></span><span style=display:flex><span><span style=color:#776e71>    global:
</span></span></span><span style=display:flex><span><span style=color:#776e71>      checkNewVersion: false    # å‘¨æœŸæ€§çš„æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬å‘å¸ƒ
</span></span></span><span style=display:flex><span><span style=color:#776e71>      sendAnonymousUsage: false # å‘¨æœŸæ€§çš„åŒ¿åå‘é€ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#776e71>    serversTransport:
</span></span></span><span style=display:flex><span><span style=color:#776e71>      insecureSkipVerify: true  # Traefikå¿½ç•¥éªŒè¯ä»£ç†æœåŠ¡çš„TLSè¯ä¹¦
</span></span></span><span style=display:flex><span><span style=color:#776e71>    api:
</span></span></span><span style=display:flex><span><span style=color:#776e71>      insecure: true            # å…è®¸HTTP æ–¹å¼è®¿é—®API
</span></span></span><span style=display:flex><span><span style=color:#776e71>      dashboard: true           # å¯ç”¨Dashboard
</span></span></span><span style=display:flex><span><span style=color:#776e71>      debug: false              # å¯ç”¨Debugè°ƒè¯•æ¨¡å¼
</span></span></span><span style=display:flex><span><span style=color:#776e71>    metrics:
</span></span></span><span style=display:flex><span><span style=color:#776e71>      prometheus:               # é…ç½®Prometheusç›‘æ§æŒ‡æ ‡æ•°æ®ï¼Œå¹¶ä½¿ç”¨é»˜è®¤é…ç½®
</span></span></span><span style=display:flex><span><span style=color:#776e71>        addRoutersLabels: true  # æ·»åŠ routers metrics
</span></span></span><span style=display:flex><span><span style=color:#776e71>        entryPoint: &#34;metrics&#34;   # æŒ‡å®šmetricsç›‘å¬åœ°å€
</span></span></span><span style=display:flex><span><span style=color:#776e71>    entryPoints:
</span></span></span><span style=display:flex><span><span style=color:#776e71>      web:
</span></span></span><span style=display:flex><span><span style=color:#776e71>        address: &#34;:80&#34;          # é…ç½®80ç«¯å£ï¼Œå¹¶è®¾ç½®å…¥å£åç§°ä¸º web
</span></span></span><span style=display:flex><span><span style=color:#776e71>        forwardedHeaders: 
</span></span></span><span style=display:flex><span><span style=color:#776e71>          insecure: true        # ä¿¡ä»»æ‰€æœ‰çš„forward headers
</span></span></span><span style=display:flex><span><span style=color:#776e71>      websecure:
</span></span></span><span style=display:flex><span><span style=color:#776e71>        address: &#34;:443&#34;         # é…ç½®443ç«¯å£ï¼Œå¹¶è®¾ç½®å…¥å£åç§°ä¸º websecure
</span></span></span><span style=display:flex><span><span style=color:#776e71>        forwardedHeaders: 
</span></span></span><span style=display:flex><span><span style=color:#776e71>          insecure: true
</span></span></span><span style=display:flex><span><span style=color:#776e71>      traefik:
</span></span></span><span style=display:flex><span><span style=color:#776e71>        address: &#34;:9000&#34;        # é…ç½®9000ç«¯å£ä¸º dashboard çš„ç«¯å£ï¼Œä¸è®¾ç½®é»˜è®¤å€¼ä¸º 8080
</span></span></span><span style=display:flex><span><span style=color:#776e71>      metrics:
</span></span></span><span style=display:flex><span><span style=color:#776e71>        address: &#34;:9100&#34;        # é…ç½®9100ç«¯å£ï¼Œä½œä¸ºmetricsæ”¶é›†å…¥å£
</span></span></span><span style=display:flex><span><span style=color:#776e71>      tcpep:
</span></span></span><span style=display:flex><span><span style=color:#776e71>        address: &#34;:9200&#34;        # é…ç½®9200ç«¯å£ï¼Œä½œä¸ºtcpå…¥å£
</span></span></span><span style=display:flex><span><span style=color:#776e71>      udpep:
</span></span></span><span style=display:flex><span><span style=color:#776e71>        address: &#34;:9300/udp&#34;    # é…ç½®9300ç«¯å£ï¼Œä½œä¸ºudpå…¥å£
</span></span></span><span style=display:flex><span><span style=color:#776e71>    providers:
</span></span></span><span style=display:flex><span><span style=color:#776e71>      kubernetesIngress: &#34;&#34;     # å¯ç”¨ Kubernetes Ingress æ–¹å¼æ¥é…ç½®è·¯ç”±è§„åˆ™
</span></span></span><span style=display:flex><span><span style=color:#776e71>      kubernetesGateway: &#34;&#34;     # å¯ç”¨ Kubernetes Gateway API
</span></span></span><span style=display:flex><span><span style=color:#776e71>      kubernetesCRD:            # å¯ç”¨Kubernetes CRDæ–¹å¼æ¥é…ç½®è·¯ç”±è§„åˆ™
</span></span></span><span style=display:flex><span><span style=color:#776e71>        ingressClass: &#34;&#34;        # æŒ‡å®štraefikçš„ingressClassåç§°
</span></span></span><span style=display:flex><span><span style=color:#776e71>        allowCrossNamespace: true   #å…è®¸è·¨namespace
</span></span></span><span style=display:flex><span><span style=color:#776e71>        allowEmptyServices: true    #å…è®¸ç©ºendpointsçš„service
</span></span></span><span style=display:flex><span><span style=color:#776e71>    log:
</span></span></span><span style=display:flex><span><span style=color:#776e71>      filePath: &#34;/etc/traefik/logs/traefik.log&#34; # è®¾ç½®è°ƒè¯•æ—¥å¿—æ–‡ä»¶å­˜å‚¨è·¯å¾„ï¼Œå¦‚æœä¸ºç©ºåˆ™è¾“å‡ºåˆ°æ§åˆ¶å°
</span></span></span><span style=display:flex><span><span style=color:#776e71>      level: &#34;DEBUG&#34;            # è®¾ç½®è°ƒè¯•æ—¥å¿—çº§åˆ«
</span></span></span><span style=display:flex><span><span style=color:#776e71>      format: &#34;json&#34;          # è®¾ç½®è°ƒè¯•æ—¥å¿—æ ¼å¼
</span></span></span><span style=display:flex><span><span style=color:#776e71>    accessLog:
</span></span></span><span style=display:flex><span><span style=color:#776e71>      filePath: &#34;/etc/traefik/logs/access.log&#34; # è®¾ç½®è®¿é—®æ—¥å¿—æ–‡ä»¶å­˜å‚¨è·¯å¾„ï¼Œå¦‚æœä¸ºç©ºåˆ™è¾“å‡ºåˆ° stdout å’Œ stderr
</span></span></span><span style=display:flex><span><span style=color:#776e71>      format: &#34;json&#34;          # è®¾ç½®è®¿é—®è°ƒè¯•æ—¥å¿—æ ¼å¼
</span></span></span><span style=display:flex><span><span style=color:#776e71>      bufferingSize: 0          # è®¾ç½®è®¿é—®æ—¥å¿—ç¼“å­˜è¡Œæ•°
</span></span></span><span style=display:flex><span><span style=color:#776e71>      fields:                   # è®¾ç½®è®¿é—®æ—¥å¿—ä¸­çš„å­—æ®µæ˜¯å¦ä¿ç•™ï¼ˆkeepä¿ç•™ã€dropä¸ä¿ç•™ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#776e71>        defaultMode: keep       # è®¾ç½®é»˜è®¤ä¿ç•™è®¿é—®æ—¥å¿—å­—æ®µ
</span></span></span><span style=display:flex><span><span style=color:#776e71>        names:                  # é’ˆå¯¹è®¿é—®æ—¥å¿—ç‰¹åˆ«å­—æ®µç‰¹åˆ«é…ç½®ä¿ç•™æ¨¡å¼
</span></span></span><span style=display:flex><span><span style=color:#776e71>          ClientUsername: drop
</span></span></span><span style=display:flex><span><span style=color:#776e71>          StartUTC: drop        # ç¦ç”¨æ—¥å¿—timestampä½¿ç”¨UTC
</span></span></span><span style=display:flex><span><span style=color:#776e71>        headers:                # è®¾ç½®Headerä¸­å­—æ®µæ˜¯å¦ä¿ç•™
</span></span></span><span style=display:flex><span><span style=color:#776e71>          defaultMode: keep     # è®¾ç½®é»˜è®¤ä¿ç•™Headerä¸­å­—æ®µ
</span></span></span><span style=display:flex><span><span style=color:#776e71>          names:                # é’ˆå¯¹Headerä¸­ç‰¹åˆ«å­—æ®µç‰¹åˆ«é…ç½®ä¿ç•™æ¨¡å¼
</span></span></span><span style=display:flex><span><span style=color:#776e71>            # User-Agent: redact# å¯ä»¥é’ˆå¯¹æŒ‡å®šagent
</span></span></span><span style=display:flex><span><span style=color:#776e71>            Authorization: drop
</span></span></span><span style=display:flex><span><span style=color:#776e71>            Content-Type: keep</span>    
</span></span></code></pre></div><p>è®¾ç½®èŠ‚ç‚¹ labelï¼Œç”¨äºæ§åˆ¶åœ¨å“ªäº›èŠ‚ç‚¹éƒ¨ç½² Traefikï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ k8s-node1(master) èŠ‚ç‚¹ä½œä¸ºè¾¹ç¼˜èŠ‚ç‚¹éƒ¨ç½²</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl label node k8s-node1  <span style=color:#ef6155>IngressProxy</span><span style=color:#5bc4bf>=</span>true
</span></span></code></pre></div><h2 id=23-deployment-service>2.3 deployment service<a hidden class=anchor aria-hidden=true href=#23-deployment-service>#</a></h2><p>ä½¿ç”¨ DeamonSet æˆ–è€… Deployment å‡å¯ï¼Œæ­¤å¤„ä½¿ç”¨ Deployment æ–¹å¼éƒ¨ç½² Traefikï¼Œè°ƒåº¦è‡³å«æœ‰ IngressProxy=true çš„è¾¹ç¼˜èŠ‚ç‚¹</p><p>åŒæ—¶ä½¿ç”¨ <code>podAntiAffinity</code> é¿å…å¤šä¸ª traefik å®ä¾‹è¿è¡Œåœ¨åŒä¸€èŠ‚ç‚¹é€ æˆå•ç‚¹æ•…éšœ.</p><p><code>kubectl apply -f deployment.yml</code></p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#5bc4bf>apiVersion</span>: <span style=color:#f99b15>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>namespace</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>app</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>replicas</span>: <span style=color:#f99b15>1</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>app</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>app</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>affinity</span>:
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>podAntiAffinity</span>:
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>requiredDuringSchedulingIgnoredDuringExecution</span>:
</span></span><span style=display:flex><span>          - <span style=color:#5bc4bf>labelSelector</span>:
</span></span><span style=display:flex><span>              <span style=color:#5bc4bf>matchExpressions</span>:
</span></span><span style=display:flex><span>              - <span style=color:#5bc4bf>key</span>: <span style=color:#f99b15>app</span>
</span></span><span style=display:flex><span>                <span style=color:#5bc4bf>operator</span>: <span style=color:#f99b15>In</span>
</span></span><span style=display:flex><span>                <span style=color:#5bc4bf>values</span>:
</span></span><span style=display:flex><span>                - <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>topologyKey</span>: <span style=color:#48b685>&#34;kubernetes.io/hostname&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>serviceAccountName</span>: <span style=color:#f99b15>traefik-ingress-controller</span>
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>terminationGracePeriodSeconds</span>: <span style=color:#f99b15>5</span>         <span style=color:#776e71># ç­‰å¾…å®¹å™¨ä¼˜é›…é€€å‡ºçš„æ—¶é•¿</span>
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>tolerations</span>:                             <span style=color:#776e71># è®¾ç½®å®¹å¿æ‰€æœ‰æ±¡ç‚¹ï¼Œé˜²æ­¢èŠ‚ç‚¹è¢«è®¾ç½®æ±¡ç‚¹</span>
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>operator</span>: <span style=color:#48b685>&#34;Exists&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>nodeSelector</span>:                            <span style=color:#776e71># è®¾ç½®nodeç­›é€‰å™¨ï¼Œåœ¨ç‰¹å®šlabelçš„èŠ‚ç‚¹ä¸Šå¯åŠ¨</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>IngressProxy</span>: <span style=color:#48b685>&#34;true&#34;</span>                   <span style=color:#776e71># è°ƒåº¦è‡³IngressProxy: &#34;true&#34;çš„èŠ‚ç‚¹</span>
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>image</span>: <span style=color:#f99b15>traefik:v2.9</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>env</span>:
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>KUBERNETES_SERVICE_HOST      </span> <span style=color:#776e71># æ‰‹åŠ¨æŒ‡å®šk8s api,é¿å…ç½‘ç»œç»„ä»¶ä¸ç¨³å®šã€‚</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>value</span>: <span style=color:#48b685>&#34;1.1.1.1&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>KUBERNETES_SERVICE_PORT_HTTPS</span> <span style=color:#776e71># API serverç«¯å£</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>value</span>: <span style=color:#48b685>&#34;6443&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>KUBERNETES_SERVICE_PORT      </span> <span style=color:#776e71># API serverç«¯å£</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>value</span>: <span style=color:#48b685>&#34;6443&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>TZ                           </span> <span style=color:#776e71># æŒ‡å®šæ—¶åŒº</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>value</span>: <span style=color:#48b685>&#34;Asia/Shanghai&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>ports</span>:
</span></span><span style=display:flex><span>          - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>web</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>containerPort</span>: <span style=color:#f99b15>80</span>
</span></span><span style=display:flex><span>          - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>websecure</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>containerPort</span>: <span style=color:#f99b15>443</span>
</span></span><span style=display:flex><span>          - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>dashboard</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>containerPort</span>: <span style=color:#f99b15>9000</span>               <span style=color:#776e71># Traefik Dashboard ç«¯å£</span>
</span></span><span style=display:flex><span>          - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>metrics</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>containerPort</span>: <span style=color:#f99b15>9100</span>
</span></span><span style=display:flex><span>          - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>tcpep</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>containerPort</span>: <span style=color:#f99b15>9200</span>               <span style=color:#776e71># tcpç«¯å£</span>
</span></span><span style=display:flex><span>          - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>udpep</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>containerPort</span>: <span style=color:#f99b15>9300</span>               <span style=color:#776e71># udpç«¯å£</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>securityContext</span>:                      <span style=color:#776e71># åªå¼€æ”¾ç½‘ç»œæƒé™</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>capabilities</span>:
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>drop</span>:
</span></span><span style=display:flex><span>              - <span style=color:#f99b15>ALL</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>add</span>:
</span></span><span style=display:flex><span>              - <span style=color:#f99b15>NET_BIND_SERVICE</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>args</span>:
</span></span><span style=display:flex><span>          - --<span style=color:#f99b15>configfile=/etc/traefik/config/traefik.yaml</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>volumeMounts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>mountPath</span>: <span style=color:#f99b15>/etc/traefik/config</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>config</span>
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>mountPath</span>: <span style=color:#f99b15>/etc/traefik/logs</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>logdir</span>
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>mountPath</span>: <span style=color:#f99b15>/etc/localtime</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>timezone</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>readOnly</span>: <span style=color:#815ba4>true</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>resources</span>:
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>requests</span>:
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>memory</span>: <span style=color:#48b685>&#34;5Mi&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>cpu</span>: <span style=color:#48b685>&#34;10m&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>limits</span>:
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>memory</span>: <span style=color:#48b685>&#34;256Mi&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>cpu</span>: <span style=color:#48b685>&#34;1000m&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>volumes</span>:
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>config                        </span> <span style=color:#776e71># traefiké…ç½®æ–‡ä»¶</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>configMap</span>:
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik-config</span>
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>logdir                        </span> <span style=color:#776e71># traefikæ—¥å¿—ç›®å½•</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>hostPath</span>:
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>path</span>: <span style=color:#f99b15>/var/log/traefik</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>type</span>: <span style=color:#48b685>&#34;DirectoryOrCreate&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>timezone                      </span> <span style=color:#776e71># æŒ‚è½½æ—¶åŒºæ–‡ä»¶</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>hostPath</span>:
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>path</span>: <span style=color:#f99b15>/etc/localtime</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>type</span>: <span style=color:#f99b15>File</span>
</span></span></code></pre></div><p>service <code>kubectl apply -f service.yml</code></p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#5bc4bf>apiVersion</span>: <span style=color:#f99b15>v1</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>Service</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>app</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik            </span> <span style=color:#776e71># å®é™…æä¾›æœåŠ¡çš„ service, ä½¿ç”¨ NodePort æ¨¡å¼</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>namespace</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>type</span>: <span style=color:#f99b15>NodePort</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>app</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>web</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>protocol</span>: <span style=color:#f99b15>TCP</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>port</span>: <span style=color:#f99b15>80</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>targetPort</span>: <span style=color:#f99b15>80</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>nodePort</span>: <span style=color:#f99b15>80</span>
</span></span><span style=display:flex><span>  - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>websecure</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>protocol</span>: <span style=color:#f99b15>TCP</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>port</span>: <span style=color:#f99b15>443</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>targetPort</span>: <span style=color:#f99b15>443</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>nodePort</span>: <span style=color:#f99b15>443</span>
</span></span><span style=display:flex><span>  - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>dashboard</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>protocol</span>: <span style=color:#f99b15>TCP</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>port</span>: <span style=color:#f99b15>9000</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>targetPort</span>: <span style=color:#f99b15>9000</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>nodePort</span>: <span style=color:#f99b15>9000</span>
</span></span><span style=display:flex><span>  - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>tcpep</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>protocol</span>: <span style=color:#f99b15>TCP</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>port</span>: <span style=color:#f99b15>9200</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>targetPort</span>: <span style=color:#f99b15>9200</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>nodePort</span>: <span style=color:#f99b15>9200</span>
</span></span><span style=display:flex><span>  - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>udpep</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>protocol</span>: <span style=color:#f99b15>UDP</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>port</span>: <span style=color:#f99b15>9300</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>targetPort</span>: <span style=color:#f99b15>9300</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>nodePort</span>: <span style=color:#f99b15>9300</span>
</span></span><span style=display:flex><span><span style=color:#fec418>---</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>apiVersion</span>: <span style=color:#f99b15>v1</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>Service</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>app</span>: <span style=color:#f99b15>traefik-metrics</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>traefik-metrics          </span> <span style=color:#776e71># metrics ç”¨äºç»™é›†ç¾¤å†…çš„ prometheus æä¾›æ•°æ®</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>namespace</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>app</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>metrics</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>protocol</span>: <span style=color:#f99b15>TCP</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>port</span>: <span style=color:#f99b15>9100</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>targetPort</span>: <span style=color:#f99b15>9100</span>
</span></span></code></pre></div><h2 id=24-éªŒè¯>2.4 éªŒè¯<a hidden class=anchor aria-hidden=true href=#24-éªŒè¯>#</a></h2><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 traefik<span style=color:#5bc4bf>]</span><span style=color:#776e71># kubectl get pod,cm,sa,svc -n traefik |grep traefik</span>
</span></span><span style=display:flex><span>pod/traefik-69bd67497f-v27qp   1/1     Running   <span style=color:#f99b15>0</span>          12m
</span></span><span style=display:flex><span>configmap/traefik-config     <span style=color:#f99b15>1</span>      7d5h
</span></span><span style=display:flex><span>serviceaccount/traefik-ingress-controller   <span style=color:#f99b15>1</span>         7d5h
</span></span><span style=display:flex><span>service/traefik          NodePort    10.101.142.158   &lt;none&gt;        80:80/TCP,443:443/TCP,9000:9000/TCP,9200:9200/TCP,9300:9300/UDP   11m
</span></span><span style=display:flex><span>service/traefik-metrics   ClusterIP   10.98.89.13      &lt;none&gt;        9100/TCP                                                          12m
</span></span></code></pre></div><p>å¯ä»¥ç›´æ¥é€šè¿‡ <a href=http://1.1.1.1:9000 target=_blank rel=noopener style=color:#42b983 ;>http://1.1.1.1:9000</a> è®¿é—®åˆ° dashboard</p><p><img class=lazyload src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-src=https://image.lvbibir.cn/blog/image-20230426155416528.png alt=image-20230426155416528 decoding=async><noscript><img src=https://image.lvbibir.cn/blog/image-20230426155416528.png alt=image-20230426155416528></noscript></p><h2 id=25-å…¶ä»–é…ç½®>2.5 å…¶ä»–é…ç½®<a hidden class=anchor aria-hidden=true href=#25-å…¶ä»–é…ç½®>#</a></h2><h3 id=251-å¼ºåˆ¶ä½¿ç”¨-tls-v12>2.5.1 å¼ºåˆ¶ä½¿ç”¨ TLS v1.2+<a hidden class=anchor aria-hidden=true href=#251-å¼ºåˆ¶ä½¿ç”¨-tls-v12>#</a></h3><p><a href=https://doc.traefik.io/traefik/user-guides/crd-acme/#force-tls-v12 target=_blank rel=noopener style=color:#42b983 ;>å®˜æ–¹æ–‡æ¡£</a></p><p>å¦‚ä»Šï¼ŒTLS v1.0 å’Œ v1.1 å› ä¸ºå­˜åœ¨å®‰å…¨é—®é¢˜ï¼Œç°åœ¨å·²è¢«å¼ƒç”¨ã€‚ä¸ºäº†ä¿éšœç³»ç»Ÿå®‰å…¨ï¼Œæ‰€æœ‰å…¥å£è·¯ç”±éƒ½åº”è¯¥å¼ºåˆ¶ä½¿ç”¨ TLS v1.2 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 traefik<span style=color:#5bc4bf>]</span><span style=color:#776e71># tee traefik-tlsoption.yml &lt;&lt;-&#39;EOF&#39;</span>
</span></span><span style=display:flex><span>apiVersion: traefik.containo.us/v1alpha1
</span></span><span style=display:flex><span>kind: TLSOption
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: default
</span></span><span style=display:flex><span>  namespace: traefik
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  minVersion: VersionTLS12
</span></span><span style=display:flex><span>  cipherSuites:
</span></span><span style=display:flex><span>    - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384   <span style=color:#776e71># TLS 1.2</span>
</span></span><span style=display:flex><span>    - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305    <span style=color:#776e71># TLS 1.2</span>
</span></span><span style=display:flex><span>    - TLS_AES_256_GCM_SHA384                  <span style=color:#776e71># TLS 1.3</span>
</span></span><span style=display:flex><span>    - TLS_CHACHA20_POLY1305_SHA256            <span style=color:#776e71># TLS 1.3</span>
</span></span><span style=display:flex><span>  curvePreferences:
</span></span><span style=display:flex><span>    - CurveP521
</span></span><span style=display:flex><span>    - CurveP384
</span></span><span style=display:flex><span>  sniStrict: true
</span></span><span style=display:flex><span>EOF
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@k8s-node1 traefik<span style=color:#5bc4bf>]</span><span style=color:#776e71># kubectl apply -f traefik-tlsoption.yml</span>
</span></span><span style=display:flex><span>tlsoption.traefik.containo.us/default created
</span></span></code></pre></div><h3 id=252-æ—¥å¿—åˆ‡å‰²>2.5.2 æ—¥å¿—åˆ‡å‰²<a hidden class=anchor aria-hidden=true href=#252-æ—¥å¿—åˆ‡å‰²>#</a></h3><p>å®˜æ–¹å¹¶æ²¡æœ‰æ—¥å¿—è½®æ¢çš„åŠŸèƒ½ï¼Œä½†æ˜¯ traefik æ”¶åˆ° <code>USR1</code> ä¿¡å·åä¼šé‡å»ºæ—¥å¿—æ–‡ä»¶ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ <code>logrotate</code> å®ç°æ—¥å¿—è½®æ¢</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /etc/logrotate.d/traefik
</span></span><span style=display:flex><span>tee /etc/logrotate.d/traefik/config <span style=color:#48b685>&lt;&lt;-&#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#48b685>/var/log/traefik/*.log {
</span></span></span><span style=display:flex><span><span style=color:#48b685>  daily
</span></span></span><span style=display:flex><span><span style=color:#48b685>  rotate 15
</span></span></span><span style=display:flex><span><span style=color:#48b685>  missingok
</span></span></span><span style=display:flex><span><span style=color:#48b685>  notifempty
</span></span></span><span style=display:flex><span><span style=color:#48b685>  compress
</span></span></span><span style=display:flex><span><span style=color:#48b685>  dateext
</span></span></span><span style=display:flex><span><span style=color:#48b685>  dateyesterday
</span></span></span><span style=display:flex><span><span style=color:#48b685>  dateformat .%Y-%m-%d
</span></span></span><span style=display:flex><span><span style=color:#48b685>  create 0644 root root
</span></span></span><span style=display:flex><span><span style=color:#48b685>  postrotate
</span></span></span><span style=display:flex><span><span style=color:#48b685>   docker kill --signal=&#34;USR1&#34; $(docker ps | grep traefik |grep -v pause| awk &#39;{print $1}&#39;)
</span></span></span><span style=display:flex><span><span style=color:#48b685>  endscript
</span></span></span><span style=display:flex><span><span style=color:#48b685> }
</span></span></span><span style=display:flex><span><span style=color:#48b685>EOF</span>
</span></span></code></pre></div><p>åˆ›å»ºå®šæ—¶ä»»åŠ¡</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>crontab -e
</span></span><span style=display:flex><span><span style=color:#f99b15>0</span> <span style=color:#f99b15>0</span> * * * /usr/sbin/logrotate -f /etc/logrotate.d/traefik/config &gt;/dev/null 2&gt;&amp;<span style=color:#f99b15>1</span>
</span></span></code></pre></div><h2 id=26-å¤šæ§åˆ¶å™¨>2.6 å¤šæ§åˆ¶å™¨<a hidden class=anchor aria-hidden=true href=#26-å¤šæ§åˆ¶å™¨>#</a></h2><p>æœ‰çš„ä¸šåŠ¡åœºæ™¯ä¸‹å¯èƒ½éœ€è¦åœ¨ä¸€ä¸ªé›†ç¾¤ä¸­éƒ¨ç½²å¤šä¸ª traefikï¼Œä¾‹å¦‚ï¼šé¿å…å•ä¸ª traefik é…ç½®è§„åˆ™è¿‡å¤šå¯¼è‡´åŠ è½½å¤„ç†ç¼“æ…¢ã€‚æ¯ä¸ª namespace éƒ¨ç½²ä¸€ä¸ª traefikã€‚æˆ–è€… traefik ç”Ÿäº§ä¸æµ‹è¯•ç¯å¢ƒåŒºåˆ†ç­‰åœºæ™¯ï¼Œéœ€è¦ä¸åŒçš„å®ä¾‹æ§åˆ¶ä¸åŒçš„ IngressRoute èµ„æºå¯¹è±¡ï¼Œè¦å®ç°è¯¥åŠŸèƒ½æœ‰ä¸¤ç§æ–¹æ³•</p><h3 id=261-annotations-æ³¨è§£ç­›é€‰>2.6.1 annotations æ³¨è§£ç­›é€‰<a hidden class=anchor aria-hidden=true href=#261-annotations-æ³¨è§£ç­›é€‰>#</a></h3><p>é¦–å…ˆåœ¨ traefik é…ç½®æ–‡ä»¶ä¸­çš„ providers ä¸‹å¢åŠ  Ingressclass å‚æ•°ï¼ŒæŒ‡å®šå…·ä½“çš„å€¼</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>    <span style=color:#5bc4bf>providers</span>:
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>kubernetesCRD</span>:            <span style=color:#776e71># å¯ç”¨Kubernetes CRDæ–¹å¼æ¥é…ç½®è·¯ç”±è§„åˆ™</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>ingressClass</span>: <span style=color:#48b685>&#34;traefik-v2.9&#34;</span> <span style=color:#776e71># æŒ‡å®štraefikçš„ingressClasså®ä¾‹åç§°</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>allowCrossNamespace</span>: <span style=color:#815ba4>true</span>   <span style=color:#776e71>#å…è®¸è·¨namespace</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>allowEmptyServices</span>: <span style=color:#815ba4>true</span>    <span style=color:#776e71>#å…è®¸ç©ºendpointsçš„service</span>
</span></span></code></pre></div><p>æ¥ä¸‹æ¥åœ¨ IngressRoute èµ„æºå¯¹è±¡ä¸­çš„ annotations å‚æ•°ä¸­æ·»åŠ  <code>kubernetes.io/ingress.class: traefik-v2.9</code> å³å¯</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#5bc4bf>apiVersion</span>: <span style=color:#f99b15>traefik.containo.us/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>IngressRoute</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>dashboard</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>namespace</span>: <span style=color:#f99b15>traefik</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>kubernetes.io/ingress.class</span>: <span style=color:#f99b15>traefik-v2.9</span> <span style=color:#776e71>#  å› ä¸ºé™æ€é…ç½®æ–‡ä»¶æŒ‡å®šäº†ingressclassï¼Œæ‰€ä»¥è¿™é‡Œçš„annotations è¦æŒ‡å®šï¼Œå¦åˆ™è®¿é—®ä¼š404</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>entryPoints</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f99b15>web</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>routes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#5bc4bf>match</span>: <span style=color:#f99b15>Host(`traefik.test.com`)</span>
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>Rule</span>
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>services</span>:
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>api@internal</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>TraefikService</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>namespace</span>: <span style=color:#f99b15>traefik</span>
</span></span></code></pre></div><h3 id=262-label-æ ‡ç­¾é€‰æ‹©å™¨ç­›é€‰>2.6.2 label æ ‡ç­¾é€‰æ‹©å™¨ç­›é€‰<a hidden class=anchor aria-hidden=true href=#262-label-æ ‡ç­¾é€‰æ‹©å™¨ç­›é€‰>#</a></h3><p>é¦–å…ˆåœ¨ traefik é…ç½®æ–‡ä»¶ä¸­çš„ providers ä¸‹å¢åŠ  labelSelector å‚æ•°ï¼ŒæŒ‡å®šå…·ä½“çš„æ ‡ç­¾é”®å€¼ã€‚</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>    <span style=color:#5bc4bf>providers</span>:
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>kubernetesCRD</span>:            <span style=color:#776e71># å¯ç”¨Kubernetes CRDæ–¹å¼æ¥é…ç½®è·¯ç”±è§„åˆ™</span>
</span></span><span style=display:flex><span>        <span style=color:#776e71># ingressClass: &#34;traefik-v2.9&#34;    # æŒ‡å®štraefikçš„ingressClassåç§°</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>labelSelector</span>: <span style=color:#48b685>&#34;app=traefik-v2.9&#34;</span> <span style=color:#776e71># é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨æŒ‡å®štraefikæ ‡ç­¾ </span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>allowCrossNamespace</span>: <span style=color:#815ba4>true</span>   <span style=color:#776e71>#å…è®¸è·¨namespace</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>allowEmptyServices</span>: <span style=color:#815ba4>true</span>    <span style=color:#776e71>#å…è®¸ç©ºendpointsçš„service</span>
</span></span></code></pre></div><p>ç„¶ååœ¨ IngressRoute èµ„æºå¯¹è±¡ä¸­æ·»åŠ  labels æ ‡ç­¾é€‰æ‹©å™¨ï¼Œé€‰æ‹© <code>app: traefik-v2.9</code> è¿™ä¸ªæ ‡ç­¾å³å¯</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#5bc4bf>apiVersion</span>: <span style=color:#f99b15>traefik.containo.us/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>IngressRoute</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>dashboard</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>labels</span>:     <span style=color:#776e71># é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨ï¼Œè¯¥IngressRouteèµ„æºç”±é…ç½®äº†app=traefik-v2.9çš„traefikå¤„ç†</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>app</span>: <span style=color:#f99b15>traefik-v2.9</span>
</span></span><span style=display:flex><span>  <span style=color:#776e71># annotations:</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71># kubernetes.io/ingress.class: traefik-v2.9</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>entryPoints</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f99b15>web</span>
</span></span><span style=display:flex><span>  <span style=color:#5bc4bf>routes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#5bc4bf>match</span>: <span style=color:#f99b15>Host(`traefik.test.com`)</span>
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>Rule</span>
</span></span><span style=display:flex><span>      <span style=color:#5bc4bf>services</span>:
</span></span><span style=display:flex><span>        - <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>api@internal</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>TraefikService</span>
</span></span><span style=display:flex><span>          <span style=color:#5bc4bf>namespace</span>: <span style=color:#f99b15>traefik</span>
</span></span></code></pre></div><p>ä»¥ä¸Š</p></div><div class=post-reward><div style=padding:0;margin:0;width:100%;font-size:16px;text-align:center><div id=QR style=opacity:0><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=https://image.lvbibir.cn/blog/wechatpay.png alt=wechat_pay></a><p>å¾®ä¿¡</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=https://image.lvbibir.cn/blog/alipay.png alt=alipay></a><p>æ”¯ä»˜å®</p></div></div><button id=rewardButton onclick="var qr=document.getElementById('QR');qr.style.opacity==='0'?qr.style.opacity='1':qr.style.opacity='0'">
<span>ğŸ§§ é¼“åŠ±</span></button></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://www.lvbibir.cn/posts/tech/kubernetes-traefik-2-router/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>traefik (äºŒ) ingressRoute è·¯ç”±</span></a>
<a class=next href=https://www.lvbibir.cn/posts/tech/kubernetes-gatewayapi/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>kubernetes | Gateway API ç®€ä»‹åŠéƒ¨ç½²</span></a></nav></footer></div><div><div class=pagination__title><span class=pagination__title-h style=font-size:20px>ğŸ’¬è¯„è®º</span><hr></div><div id=tcomment></div><script src=https://image.lvbibir.cn/js/twikoo/1.6.44/twikoo.min.js></script><script>twikoo.init({envId:"https://www.lvbibir.cn/twikoo/",el:"#tcomment",lang:'zh-CN',path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><a href=https://gohugo.io/ target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/frame-hugo-blue.svg></a>
<a href=https://github.com/adityatelange/hugo-PaperMod target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/theme-papermod-lightgrey.svg></a>
<a href=https://cn.aliyun.com/ target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/å›¾åºŠ-é˜¿é‡Œäº‘-orange.svg></a><br><span id=runtime_span></span>
<script type=text/javascript>function show_runtime(){window.setTimeout("show_runtime()",1e3);var a=new Date("7/13/2021 1:00:00"),r=new Date,c=r.getTime()-a.getTime(),l=24*60*60*1e3,o=c/l,i=Math.floor(o),e=(o-i)*24,t=Math.floor(e),n=(e-t)*60,s=Math.floor(n),d=Math.floor((n-s)*60);document.getElementById("runtime_span").innerHTML="ç½‘ç«™å·²è¿è¡Œ"+i+"å¤©"+t+"å°æ—¶"+s+"åˆ†"+d+"ç§’"}show_runtime()</script>|
<script defer src=https://www.lvbibir.cn/busuanzi/js></script>
<span id=busuanzi_container>æ€»è®¿å®¢æ•°: <span id=busuanzi_site_uv></span>
|
æ€»è®¿é—®é‡: <span id=busuanzi_site_pv></span></span><br><a href=https://beian.miit.gov.cn/ target=_blank style="border-bottom:1px solid">äº¬ICPå¤‡2021023168å·-1</a>&nbsp;
|
<span>Copyright &copy; 2020-2026
<a href=https://www.lvbibir.cn style="border-bottom:1px solid">lvbibir's Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg><span id=read_progress></span></span></a>
<script>document.addEventListener('scroll',function(){const e=document.getElementById("read_progress"),t=document.documentElement.scrollHeight,n=document.documentElement.clientHeight,s=document.documentElement.scrollTop||document.body.scrollTop;e.innerText=((s/(t-n)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>400||document.documentElement.scrollTop>400?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script><script>document.querySelectorAll('pre > code').forEach(s=>{const n=s.parentNode.parentNode,e=document.createElement('button');e.classList.add('copy-code'),e.innerText='ğŸ“„å¤åˆ¶';function l(){e.innerText='ğŸ‘ŒğŸ»å·²å¤åˆ¶!',setTimeout(()=>{e.innerText='ğŸ“„å¤åˆ¶'},2e3)}e.addEventListener('click',n=>{const e=document.createRange();e.selectNodeContents(s);const t=window.getSelection();t.removeAllRanges(),t.addRange(e);try{document.execCommand('copy'),l()}catch(e){}t.removeRange(e)});let c=s.className.replaceAll("language-",""),t=document.createElement("div"),i=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div"),o=document.createElement("div");o.innerText=c,t.setAttribute('class','mac-tool'),i.setAttribute('class','mac bb1'),a.setAttribute('class','mac bb2'),r.setAttribute('class','mac bb3'),o.setAttribute('class','language-type'),t.appendChild(i),t.appendChild(a),t.appendChild(r),t.appendChild(o),n.classList.contains("highlight")?(n.appendChild(e),n.appendChild(t)):n.parentNode.firstChild===n||(s.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName==="TABLE"?(s.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e),n.appendChild(t)):(s.parentNode.appendChild(e),n.appendChild(t)))})</script></body></html>