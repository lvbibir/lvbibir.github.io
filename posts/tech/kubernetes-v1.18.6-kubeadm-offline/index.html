<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>kubeadm 搭建 k8s 集群 [离线版] v1.18.6 | lvbibir's Blog</title><meta name=keywords content="linux,centos,kubernetes"><meta name=description content="环境规划 操作系统 IP CPU/MEM 主机名 角色 CentOS 7.7-x86_64 192.168.1.14 2/4G k8s-master Master CentOS 7.7-x86_64 192.168.1.15 2/4G k8s-node1 Work node CentOS 7.7-x86_64 192.168.1.16 2/4G k8s-node2 Work node 【软件包版本号】 name version Docker 3:19.03.13 kubeadm v1.18.6 kubernetes v1.18.6 安装前提条件 Centos 7.x 最小化安装 时钟同步 下载离线程序包 链接：https://pan.baidu.com/s/1Q3jbJcgq0rH8jK-LTpa6Vg 提取码：hhhh 部署Maste"><meta name=author content="
作者:&nbsp;lvbibir"><link rel=canonical href=https://www.lvbibir.cn/posts/tech/kubernetes-v1.18.6-kubeadm-offline/><link crossorigin=anonymous href=/assets/css/stylesheet.27ec2ab56d27168f4436b50fcf541dd26c35482c551d49559610d6fcbac73a35.css integrity="sha256-J+wqtW0nFo9ENrUPz1Qd0mw1SCxVHUlVlhDW/LrHOjU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.lvbibir.cn/img/avatar.gif><link rel=icon type=image/png sizes=16x16 href=https://www.lvbibir.cn/img/avatar.gif><link rel=icon type=image/png sizes=32x32 href=https://www.lvbibir.cn/img/avatar.gif><link rel=apple-touch-icon href=https://www.lvbibir.cn/img/avatar.gif><link rel=mask-icon href=https://www.lvbibir.cn/img/avatar.gif><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta property="og:title" content="kubeadm 搭建 k8s 集群 [离线版] v1.18.6"><meta property="og:description" content="环境规划 操作系统 IP CPU/MEM 主机名 角色 CentOS 7.7-x86_64 192.168.1.14 2/4G k8s-master Master CentOS 7.7-x86_64 192.168.1.15 2/4G k8s-node1 Work node CentOS 7.7-x86_64 192.168.1.16 2/4G k8s-node2 Work node 【软件包版本号】 name version Docker 3:19.03.13 kubeadm v1.18.6 kubernetes v1.18.6 安装前提条件 Centos 7.x 最小化安装 时钟同步 下载离线程序包 链接：https://pan.baidu.com/s/1Q3jbJcgq0rH8jK-LTpa6Vg 提取码：hhhh 部署Maste"><meta property="og:type" content="article"><meta property="og:url" content="https://www.lvbibir.cn/posts/tech/kubernetes-v1.18.6-kubeadm-offline/"><meta property="og:image" content="https://image.lvbibir.cn/blog/kubernetes.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-01T00:00:00+00:00"><meta property="article:modified_time" content="2021-10-01T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://image.lvbibir.cn/blog/kubernetes.png"><meta name=twitter:title content="kubeadm 搭建 k8s 集群 [离线版] v1.18.6"><meta name=twitter:description content="环境规划 操作系统 IP CPU/MEM 主机名 角色 CentOS 7.7-x86_64 192.168.1.14 2/4G k8s-master Master CentOS 7.7-x86_64 192.168.1.15 2/4G k8s-node1 Work node CentOS 7.7-x86_64 192.168.1.16 2/4G k8s-node2 Work node 【软件包版本号】 name version Docker 3:19.03.13 kubeadm v1.18.6 kubernetes v1.18.6 安装前提条件 Centos 7.x 最小化安装 时钟同步 下载离线程序包 链接：https://pan.baidu.com/s/1Q3jbJcgq0rH8jK-LTpa6Vg 提取码：hhhh 部署Maste"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"📚 文章","item":"https://www.lvbibir.cn/posts/"},{"@type":"ListItem","position":3,"name":"👨🏻‍💻 技术","item":"https://www.lvbibir.cn/posts/tech/"},{"@type":"ListItem","position":4,"name":"kubeadm 搭建 k8s 集群 [离线版] v1.18.6","item":"https://www.lvbibir.cn/posts/tech/kubernetes-v1.18.6-kubeadm-offline/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"kubeadm 搭建 k8s 集群 [离线版] v1.18.6","name":"kubeadm 搭建 k8s 集群 [离线版] v1.18.6","description":"环境规划 操作系统 IP CPU/MEM 主机名 角色 CentOS 7.7-x86_64 192.168.1.14 2/4G k8s-master Master CentOS 7.7-x86_64 192.168.1.15 2/4G k8s-node1 Work node CentOS 7.7-x86_64 192.168.1.16 2/4G k8s-node2 Work node 【软件包版本号】 name version Docker 3:19.03.13 kubeadm v1.18.6 kubernetes v1.18.6 安装前提条件 Centos 7.x 最小化安装 时钟同步 下载离线程序包 链接：https://pan.baidu.com/s/1Q3jbJcgq0rH8jK-LTpa6Vg 提取码：hhhh 部署Maste","keywords":["linux","centos","kubernetes"],"articleBody":"环境规划 操作系统 IP CPU/MEM 主机名 角色 CentOS 7.7-x86_64 192.168.1.14 2/4G k8s-master Master CentOS 7.7-x86_64 192.168.1.15 2/4G k8s-node1 Work node CentOS 7.7-x86_64 192.168.1.16 2/4G k8s-node2 Work node 【软件包版本号】\nname version Docker 3:19.03.13 kubeadm v1.18.6 kubernetes v1.18.6 安装前提条件\nCentos 7.x 最小化安装 时钟同步 下载离线程序包\n链接：https://pan.baidu.com/s/1Q3jbJcgq0rH8jK-LTpa6Vg 提取码：hhhh\n部署Master节点 执行自动安装脚本 将下载到的程序包拷贝到 k8s-master 节点解压，我这里的master节点是 192.168.1.14\n[root@localhost ~]# ip a | egrep global inet 192.168.1.14/24 brd 192.168.1.255 scope global noprefixroute eth0 [root@localhost ~]# ls anaconda-ks.cfg k8s-kubeadm.tar.gz [root@localhost ~]# tar xf k8s-kubeadm.tar.gz [root@localhost ~]# cd k8s-kubeadm [root@localhost k8s-kubeadm]# ls docker-ce-19.03.12.tar.gz flannel-v0.12.0-linux-amd64.tar.gz install.sh k8s-imagesV1.18.6.tar.gz k8s-V1.18.6.tar.gz kube-flannel.yml packages.tar.gz # 执行脚本 ./install.sh [主机名] [root@localhost k8s-kubeadm]# ./install.sh k8s-master 等待脚本执行自动安装。。。\n执行完毕后，会出现以下提示：\n因为内核进行了升级，请重启服务器。\n重启以后，内核版本更新为 5.8.13\n使用 kubeadm 初始化集群 kubeadm init --kubernetes-version=v1.18.6 --apiserver-advertise-address=192.168.1.14 --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12 等待集群初始化完成。。。\nkubeadm join 192.168.1.14:6443 --token utml0h.gj2nafii8xm1512e \\ --discovery-token-ca-cert-hash sha256:e91fb35667cf51c76b9afa288e4416a1314a1244158123ffbcee55b7ac4a70d4 上面命令记录下来，这是将 node 节点加入到 集群的执行操作命令。\n出现如上提示，集群初始化成功，执行提示命令：\n[root@k8s-master ~]# mkdir -p $HOME/.kube [root@k8s-master ~]# cp -i /etc/kubernetes/admin.conf $HOME/.kube/config [root@k8s-master ~]# chown $(id -u):$(id -g) $HOME/.kube/config 使用 kubectl 查看 nodes\n[root@k8s-master ~]# kubectl get nodes NAME STATUS ROLES AGE VERSION k8s-master NotReady master 74s v1.18.6 初始化网络插件 flannel # 进入压缩后的目录里 [root@k8s-master ~]# cd k8s-kubeadm/ # 开始进行 flannel 初始化安装 [root@k8s-master k8s-kubeadm]# kubectl apply -f kube-flannel.yml podsecuritypolicy.policy/psp.flannel.unprivileged created clusterrole.rbac.authorization.k8s.io/flannel created clusterrolebinding.rbac.authorization.k8s.io/flannel created serviceaccount/flannel created configmap/kube-flannel-cfg created daemonset.apps/kube-flannel-ds created flannel 初始化完成后，查看 nodes 状态：\n[root@k8s-master k8s-kubeadm]# kubectl get nodes NAME STATUS ROLES AGE VERSION k8s-master Ready master 3m58s v1.18.6 到此，通过 kubeadm 初始化安装 master 节点完毕。接下来是 node 节点就很简单。\n部署node节点 将下载的压缩包拷贝到 node 节点执行 [root@k8s-master ~]# scp k8s-kubeadm.tar.gz 192.168.1.15:/root/ ------以下node节点执行------ [root@localhost ~]# ls anaconda-ks.cfg k8s-kubeadm.tar.gz [root@localhost ~]# tar xf k8s-kubeadm.tar.gz [root@localhost ~]# cd k8s-kubeadm/ # ./install.sh 主机名 [root@localhost k8s-kubeadm]# ./install.sh k8s-node1 这里和上面 master 初始化一样，完成后重启主机。\n重启完成后，执行 join 命令加入集群 # 就是上面记录的命令 kubeadm join 192.168.1.14:6443 --token utml0h.gj2nafii8xm1512e \\ --discovery-token-ca-cert-hash sha256:e91fb35667cf51c76b9afa288e4416a1314a1244158123ffbcee55b7ac4a70d4 切换到 k8s-master 查看 k8s-node1 是否加入集群 k8s-node1 成功加入集群，剩下的 node 节点都是一样的操作。\n到此，通过 kubeadm 搭建 k8s 环境已经完成。\nk8s 集群简单测试 注意：本节测试需要网络拉取镜像，可以通过网络将 镜像拷贝到主机里 所需镜像： nginx:alpine / busybox\n这里做一个简单的小测试来证明集群是健康正常运行的。\n创建一个 nginx pod [root@k8s-master ~]# kubectl run nginx-deploy --image=nginx:alpine pod/nginx-deploy created [root@k8s-master ~]# kubectl get pods NAME READY STATUS RESTARTS AGE nginx-deploy 1/1 Running 0 11s [root@k8s-master ~]# kubectl get pods -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES nginx-deploy 1/1 Running 0 18s 10.244.1.2 k8s-node1 为 nginx pod 创建一个服务 [root@k8s-master ~]# kubectl expose pod nginx-deploy --name=nginx --port=80 --target-port=80 --protocol=TCP service/nginx exposed [root@k8s-master ~]# kubectl get service NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.96.0.1 443/TCP 21m nginx ClusterIP 10.106.14.253 80/TCP 9s [root@k8s-master ~]# curl 10.106.14.253 \u003c!DOCTYPE html\u003e Welcome to nginx! Welcome to nginx! If you see this page, the nginx web server is successfully installed and working. Further configuration is required.\nFor online documentation and support please refer to ","wordCount":"1109","inLanguage":"en","image":"https://image.lvbibir.cn/blog/kubernetes.png","datePublished":"2021-10-01T00:00:00Z","dateModified":"2021-10-01T00:00:00Z","author":{"@type":"Person","name":"lvbibir"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.lvbibir.cn/posts/tech/kubernetes-v1.18.6-kubeadm-offline/"},"publisher":{"@type":"Organization","name":"lvbibir's Blog","logo":{"@type":"ImageObject","url":"https://www.lvbibir.cn/img/avatar.gif"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.lvbibir.cn accesskey=h title="lvbibir's Blog (Alt + H)"><img src=https://www.lvbibir.cn/img/avatar.gif alt aria-label=logo height=35>lvbibir's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li class=menu-item><a href=https://www.lvbibir.cn/search title="🔍 搜索 (Alt + /)" accesskey=/><span>🔍 搜索</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/ title="🏡 主页"><span>🏡 主页</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/posts title="📚 文章"><span>📚 文章</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/tags title="🏷️ 标签"><span>🏷️ 标签</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/archives title="📈 归档"><span>📈 归档</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/links title="🤝 友链"><span>🤝 友链</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/talk title="💬 说说"><span>💬 说说</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/about title="🙋🏻‍♂️ 关于"><span>🙋🏻‍♂️ 关于</span></a></li></ul></nav></header><main class="main page"><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://www.lvbibir.cn>主页</a>&nbsp;»&nbsp;<a href=https://www.lvbibir.cn/posts/>📚 文章</a>&nbsp;»&nbsp;<a href=https://www.lvbibir.cn/posts/tech/>👨🏻‍💻 技术</a></div><h1 class=post-title>kubeadm 搭建 k8s 集群 [离线版] v1.18.6</h1><div class=post-meta>创建:&nbsp;<span title='2021-10-01 00:00:00 +0000 UTC'>2021-10-01</span>&nbsp;|&nbsp;更新:&nbsp;2021-10-01&nbsp;|&nbsp;字数:&nbsp;1109字&nbsp;|&nbsp;时长:&nbsp;3分钟&nbsp;|&nbsp;
作者:&nbsp;lvbibir
&nbsp;|&nbsp;标签: &nbsp;<ul class=post-tags-meta><a href=https://www.lvbibir.cn/tags/kubernetes/>kubernetes</a></ul><span id=busuanzi_container_page_pv>&nbsp;| 访问: <span id=busuanzi_value_page_pv></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>文章目录</span></summary><div class=inner><ul><li><a href=#%e7%8e%af%e5%a2%83%e8%a7%84%e5%88%92 aria-label=环境规划>环境规划</a></li><li><a href=#%e9%83%a8%e7%bd%b2master%e8%8a%82%e7%82%b9 aria-label=部署Master节点>部署Master节点</a></li><li><a href=#%e9%83%a8%e7%bd%b2node%e8%8a%82%e7%82%b9 aria-label=部署node节点>部署node节点</a></li><li><a href=#k8s-%e9%9b%86%e7%be%a4%e7%ae%80%e5%8d%95%e6%b5%8b%e8%af%95 aria-label="k8s 集群简单测试">k8s 集群简单测试</a></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考>参考</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=环境规划>环境规划<a hidden class=anchor aria-hidden=true href=#环境规划>#</a></h1><table><thead><tr><th>操作系统</th><th>IP</th><th>CPU/MEM</th><th>主机名</th><th>角色</th></tr></thead><tbody><tr><td>CentOS 7.7-x86_64</td><td>192.168.1.14</td><td>2/4G</td><td>k8s-master</td><td>Master</td></tr><tr><td>CentOS 7.7-x86_64</td><td>192.168.1.15</td><td>2/4G</td><td>k8s-node1</td><td>Work node</td></tr><tr><td>CentOS 7.7-x86_64</td><td>192.168.1.16</td><td>2/4G</td><td>k8s-node2</td><td>Work node</td></tr></tbody></table><p>【软件包版本号】</p><table><thead><tr><th>name</th><th>version</th></tr></thead><tbody><tr><td>Docker</td><td>3:19.03.13</td></tr><tr><td>kubeadm</td><td>v1.18.6</td></tr><tr><td>kubernetes</td><td>v1.18.6</td></tr></tbody></table><p>安装前提条件</p><ul><li>Centos 7.x 最小化安装</li><li>时钟同步</li></ul><p>下载离线程序包</p><blockquote><p>链接：https://pan.baidu.com/s/1Q3jbJcgq0rH8jK-LTpa6Vg
提取码：hhhh</p></blockquote><h1 id=部署master节点>部署Master节点<a hidden class=anchor aria-hidden=true href=#部署master节点>#</a></h1><ol><li><strong>执行自动安装脚本</strong></li></ol><p>将下载到的程序包拷贝到 k8s-master 节点解压，我这里的master节点是 192.168.1.14</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># ip a | egrep global</span>
</span></span><span style=display:flex><span>    inet 192.168.1.14/24 brd 192.168.1.255 scope global noprefixroute eth0
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># ls</span>
</span></span><span style=display:flex><span>anaconda-ks.cfg  k8s-kubeadm.tar.gz
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># tar xf k8s-kubeadm.tar.gz</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># cd k8s-kubeadm</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost k8s-kubeadm<span style=color:#f92672>]</span><span style=color:#75715e># ls</span>
</span></span><span style=display:flex><span>docker-ce-19.03.12.tar.gz  flannel-v0.12.0-linux-amd64.tar.gz  install.sh  k8s-imagesV1.18.6.tar.gz  k8s-V1.18.6.tar.gz  kube-flannel.yml packages.tar.gz
</span></span><span style=display:flex><span><span style=color:#75715e># 执行脚本 ./install.sh [主机名]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost k8s-kubeadm<span style=color:#f92672>]</span><span style=color:#75715e># ./install.sh k8s-master</span>
</span></span></code></pre></div><p>等待脚本执行自动安装。。。</p><p>执行完毕后，会出现以下提示：</p><p><a href=https://img2020.cnblogs.com/blog/828019/202010/828019-20201006171930922-2104593063.png target=_blank rel=noopener style=color:#42b983 ;><img loading=lazy src=https://img2020.cnblogs.com/blog/828019/202010/828019-20201006171930922-2104593063.png alt=img></a></p><p>因为内核进行了升级，请重启服务器。</p><p><a href=https://img2020.cnblogs.com/blog/828019/202010/828019-20201006171930656-34274130.png target=_blank rel=noopener style=color:#42b983 ;><img loading=lazy src=https://img2020.cnblogs.com/blog/828019/202010/828019-20201006171930656-34274130.png alt=img></a></p><p>重启以后，内核版本更新为 <code>5.8.13</code></p><ol><li><strong>使用 kubeadm 初始化集群</strong></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubeadm init --kubernetes-version<span style=color:#f92672>=</span>v1.18.6 --apiserver-advertise-address<span style=color:#f92672>=</span>192.168.1.14 --pod-network-cidr<span style=color:#f92672>=</span>10.244.0.0/16 --service-cidr<span style=color:#f92672>=</span>10.96.0.0/12
</span></span></code></pre></div><p>等待集群初始化完成。。。</p><p><a href=https://img2020.cnblogs.com/blog/828019/202010/828019-20201006171930352-470109468.png target=_blank rel=noopener style=color:#42b983 ;><img loading=lazy src=https://img2020.cnblogs.com/blog/828019/202010/828019-20201006171930352-470109468.png alt=img></a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubeadm join 192.168.1.14:6443 --token utml0h.gj2nafii8xm1512e <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --discovery-token-ca-cert-hash sha256:e91fb35667cf51c76b9afa288e4416a1314a1244158123ffbcee55b7ac4a70d4
</span></span></code></pre></div><p>上面命令记录下来，这是将 node 节点加入到 集群的执行操作命令。</p><p>出现如上提示，集群初始化成功，执行提示命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master ~<span style=color:#f92672>]</span><span style=color:#75715e># mkdir -p $HOME/.kube</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master ~<span style=color:#f92672>]</span><span style=color:#75715e># cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master ~<span style=color:#f92672>]</span><span style=color:#75715e># chown $(id -u):$(id -g) $HOME/.kube/config</span>
</span></span></code></pre></div><p>使用 kubectl 查看 nodes</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get nodes</span>
</span></span><span style=display:flex><span>NAME         STATUS     ROLES    AGE   VERSION
</span></span><span style=display:flex><span>k8s-master   NotReady   master   74s   v1.18.6
</span></span></code></pre></div><ol><li><strong>初始化网络插件 flannel</strong></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 进入压缩后的目录里</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master ~<span style=color:#f92672>]</span><span style=color:#75715e># cd k8s-kubeadm/</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 开始进行 flannel 初始化安装</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master k8s-kubeadm<span style=color:#f92672>]</span><span style=color:#75715e># kubectl apply -f kube-flannel.yml</span>
</span></span><span style=display:flex><span>podsecuritypolicy.policy/psp.flannel.unprivileged created
</span></span><span style=display:flex><span>clusterrole.rbac.authorization.k8s.io/flannel created
</span></span><span style=display:flex><span>clusterrolebinding.rbac.authorization.k8s.io/flannel created
</span></span><span style=display:flex><span>serviceaccount/flannel created
</span></span><span style=display:flex><span>configmap/kube-flannel-cfg created
</span></span><span style=display:flex><span>daemonset.apps/kube-flannel-ds created
</span></span></code></pre></div><p>flannel 初始化完成后，查看 nodes 状态：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master k8s-kubeadm<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get nodes</span>
</span></span><span style=display:flex><span>NAME         STATUS   ROLES    AGE     VERSION
</span></span><span style=display:flex><span>k8s-master   Ready    master   3m58s   v1.18.6
</span></span></code></pre></div><p>到此，通过 kubeadm 初始化安装 master 节点完毕。接下来是 node 节点就很简单。</p><h1 id=部署node节点>部署node节点<a hidden class=anchor aria-hidden=true href=#部署node节点>#</a></h1><ol><li>将下载的压缩包拷贝到 node 节点执行</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master ~<span style=color:#f92672>]</span><span style=color:#75715e># scp k8s-kubeadm.tar.gz 192.168.1.15:/root/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>------以下node节点执行------
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># ls</span>
</span></span><span style=display:flex><span>anaconda-ks.cfg  k8s-kubeadm.tar.gz
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># tar xf k8s-kubeadm.tar.gz</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># cd k8s-kubeadm/</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ./install.sh 主机名</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost k8s-kubeadm<span style=color:#f92672>]</span><span style=color:#75715e># ./install.sh k8s-node1</span>
</span></span></code></pre></div><p>这里和上面 master 初始化一样，完成后重启主机。</p><p><a href=https://img2020.cnblogs.com/blog/828019/202010/828019-20201006171930087-1054624258.png target=_blank rel=noopener style=color:#42b983 ;><img loading=lazy src=https://img2020.cnblogs.com/blog/828019/202010/828019-20201006171930087-1054624258.png alt=img></a></p><ol><li>重启完成后，执行 join 命令加入集群</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 就是上面记录的命令</span>
</span></span><span style=display:flex><span>kubeadm join 192.168.1.14:6443 --token utml0h.gj2nafii8xm1512e <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --discovery-token-ca-cert-hash sha256:e91fb35667cf51c76b9afa288e4416a1314a1244158123ffbcee55b7ac4a70d4
</span></span></code></pre></div><p><a href=https://img2020.cnblogs.com/blog/828019/202010/828019-20201006171929732-1855734873.png target=_blank rel=noopener style=color:#42b983 ;><img loading=lazy src=https://img2020.cnblogs.com/blog/828019/202010/828019-20201006171929732-1855734873.png alt=img></a></p><ol><li>切换到 k8s-master 查看 k8s-node1 是否加入集群</li></ol><p><a href=https://img2020.cnblogs.com/blog/828019/202010/828019-20201006171929194-630188569.png target=_blank rel=noopener style=color:#42b983 ;><img loading=lazy src=https://img2020.cnblogs.com/blog/828019/202010/828019-20201006171929194-630188569.png alt=img></a></p><p>k8s-node1 成功加入集群，剩下的 node 节点都是一样的操作。</p><p>到此，通过 kubeadm 搭建 k8s 环境已经完成。</p><h1 id=k8s-集群简单测试>k8s 集群简单测试<a hidden class=anchor aria-hidden=true href=#k8s-集群简单测试>#</a></h1><blockquote><p>注意：本节测试需要网络拉取镜像，可以通过网络将 镜像拷贝到主机里 所需镜像： nginx:alpine / busybox</p></blockquote><p>这里做一个简单的小测试来证明集群是健康正常运行的。</p><ol><li>创建一个 nginx pod</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl run nginx-deploy --image=nginx:alpine</span>
</span></span><span style=display:flex><span>pod/nginx-deploy created
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get pods</span>
</span></span><span style=display:flex><span>NAME           READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>nginx-deploy   1/1     Running   <span style=color:#ae81ff>0</span>          11s
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get pods -o wide</span>
</span></span><span style=display:flex><span>NAME           READY   STATUS    RESTARTS   AGE   IP           NODE        NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>nginx-deploy   1/1     Running   <span style=color:#ae81ff>0</span>          18s   10.244.1.2   k8s-node1   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><ol><li>为 nginx pod 创建一个服务</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl expose pod nginx-deploy --name=nginx --port=80 --target-port=80 --protocol=TCP</span>
</span></span><span style=display:flex><span>service/nginx exposed
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get service</span>
</span></span><span style=display:flex><span>NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>   AGE
</span></span><span style=display:flex><span>kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP   21m
</span></span><span style=display:flex><span>nginx        ClusterIP   10.106.14.253   &lt;none&gt;        80/TCP    9s
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master ~<span style=color:#f92672>]</span><span style=color:#75715e># curl 10.106.14.253</span>
</span></span><span style=display:flex><span>&lt;!DOCTYPE html&gt;
</span></span><span style=display:flex><span>&lt;html&gt;
</span></span><span style=display:flex><span>&lt;head&gt;
</span></span><span style=display:flex><span>&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span></span><span style=display:flex><span>&lt;style&gt;
</span></span><span style=display:flex><span>    body <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        width: 35em;
</span></span><span style=display:flex><span>        margin: <span style=color:#ae81ff>0</span> auto;
</span></span><span style=display:flex><span>        font-family: Tahoma, Verdana, Arial, sans-serif;
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>&lt;/style&gt;
</span></span><span style=display:flex><span>&lt;/head&gt;
</span></span><span style=display:flex><span>&lt;body&gt;
</span></span><span style=display:flex><span>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span></span><span style=display:flex><span>&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span style=display:flex><span>working. Further configuration is required.&lt;/p&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;p&gt;For online documentation and support please refer to
</span></span><span style=display:flex><span>&lt;a href<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span style=display:flex><span>Commercial support is available at
</span></span><span style=display:flex><span>&lt;a href<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;p&gt;&lt;em&gt;Thank you <span style=color:#66d9ef>for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span style=display:flex><span>&lt;/body&gt;
</span></span><span style=display:flex><span>&lt;/html&gt;
</span></span></code></pre></div><ol><li>创建一个 busybox pod 来通过 nginx 服务名访问</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl run client --image=busybox -it</span>
</span></span><span style=display:flex><span>If you don<span style=color:#960050;background-color:#1e0010>&#39;</span>t see a command prompt, try pressing enter.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>------ 通过服务名来访问 nginx 服务 ------ 
</span></span><span style=display:flex><span>/ <span style=color:#75715e># wget -O - -q nginx</span>
</span></span><span style=display:flex><span>&lt;!DOCTYPE html&gt;
</span></span><span style=display:flex><span>&lt;html&gt;
</span></span><span style=display:flex><span>&lt;head&gt;
</span></span><span style=display:flex><span>&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span></span><span style=display:flex><span>&lt;style&gt;
</span></span><span style=display:flex><span>    body <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        width: 35em;
</span></span><span style=display:flex><span>        margin: <span style=color:#ae81ff>0</span> auto;
</span></span><span style=display:flex><span>        font-family: Tahoma, Verdana, Arial, sans-serif;
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>&lt;/style&gt;
</span></span><span style=display:flex><span>&lt;/head&gt;
</span></span><span style=display:flex><span>&lt;body&gt;
</span></span><span style=display:flex><span>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span></span><span style=display:flex><span>&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span style=display:flex><span>working. Further configuration is required.&lt;/p&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;p&gt;For online documentation and support please refer to
</span></span><span style=display:flex><span>&lt;a href<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span style=display:flex><span>Commercial support is available at
</span></span><span style=display:flex><span>&lt;a href<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;p&gt;&lt;em&gt;Thank you <span style=color:#66d9ef>for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span style=display:flex><span>&lt;/body&gt;
</span></span><span style=display:flex><span>&lt;/html&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/ <span style=color:#75715e># cat /etc/resolv.conf</span>
</span></span><span style=display:flex><span>nameserver 10.96.0.10
</span></span><span style=display:flex><span>search default.svc.cluster.local svc.cluster.local cluster.local
</span></span><span style=display:flex><span>options ndots:5
</span></span></code></pre></div><p>测试通过，网络及dns服务正常。集群处于正常健康状态。</p><h1 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h1><p><a href=https://www.cnblogs.com/hukey/p/13773927.html target=_blank rel=noopener style=color:#42b983 ;>https://www.cnblogs.com/hukey/p/13773927.html</a></p></div><div class=post-reward><div style=padding:0;margin:0;width:100%;font-size:16px;text-align:center><div id=QR style=opacity:0><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=https://www.lvbibir.cn/img/wechat_pay.png alt=wechat_pay></a><p>微信</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=https://www.lvbibir.cn/img/alipay.png alt=alipay></a><p>支付宝</p></div></div><button id=rewardButton onclick='var qr=document.getElementById("QR");qr.style.opacity==="0"?qr.style.opacity="1":qr.style.opacity="0"'>
<span>🧧 鼓励</span></button></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://www.lvbibir.cn/posts/tech/openstack-kolla-ansible-allinone-train/><span class=title>« 上一页</span><br><span>kolla-ansible部署Train版openstack（all-in-one）</span></a>
<a class=next href=https://www.lvbibir.cn/posts/tech/kubernetes-v1.22.3-kubeadm/><span class=title>下一页 »</span><br><span>kubernetes | 简介 | kubeadm搭建K8s集群v1.22.3</span></a></nav></footer></div><div><div class=pagination__title><span class=pagination__title-h style=font-size:20px>💬评论</span><hr></div><div id=tcomment></div><script src=https://cdn.staticfile.org/twikoo/1.6.7/twikoo.all.min.js></script><script>twikoo.init({envId:"https://twikoo.lvbibir.cn/",el:"#tcomment",lang:"zh-CN",path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><a href=https://gohugo.io/ target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/frame-hugo-blue.svg></a>
<a href=https://github.com/adityatelange/hugo-PaperMod target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/theme-papermod-lightgrey.svg></a>
<a href=https://cn.aliyun.com/ target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/图床-阿里云-orange.svg></a><br><span id=runtime_span></span>
<script type=text/javascript>function show_runtime(){window.setTimeout("show_runtime()",1e3),X=new Date("7/13/2021 1:00:00"),Y=new Date,T=Y.getTime()-X.getTime(),M=24*60*60*1e3,a=T/M,A=Math.floor(a),b=(a-A)*24,B=Math.floor(b),c=(b-B)*60,C=Math.floor((b-B)*60),D=Math.floor((c-C)*60),runtime_span.innerHTML="网站已运行"+A+"天"+B+"小时"+C+"分"+D+"秒"}show_runtime()</script>|
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span id=busuanzi_container>总访客数: <span id=busuanzi_value_site_uv></span>
|
总访问量: <span id=busuanzi_value_site_pv></span></span><br><a href=https://beian.miit.gov.cn/ target=_blank style="border-bottom:1px solid">京ICP备2021023168号-1</a>&nbsp;
|
<span>Copyright
&copy;
2020-2023
<a href=https://www.lvbibir.cn style="border-bottom:1px solid">lvbibir's Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg><span id=read_progress></span></span></a>
<script>document.addEventListener("scroll",function(){const t=document.getElementById("read_progress"),n=document.documentElement.scrollHeight,s=document.documentElement.clientHeight,o=document.documentElement.scrollTop||document.body.scrollTop;t.innerText=((o/(n-s)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>400||document.documentElement.scrollTop>400?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="📄复制";function s(){t.innerText="👌🏻已复制!",setTimeout(()=>{t.innerText="📄复制"},2e3)}t.addEventListener("click",t=>{const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild===n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName==="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>