<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>docker | å®¹å™¨çš„è·¨ä¸»æœºè¿æ¥ | lvbibir's Blog</title><meta name=keywords content="linux,docker,network"><meta name=description content="ä»‹ç» docker å®¹å™¨åœ¨ä¸åŒå®¿ä¸»æœºä¸‹å®ç°é€šä¿¡çš„å‡ ç§æ–¹æ¡ˆ"><meta name=author content="ä½œè€…:&nbsp;lvbibir"><link rel=canonical href=https://www.lvbibir.cn/posts/tech/docker-rong-qi-kua-zhu-ji-lian-jie/><link crossorigin=anonymous href=/assets/css/stylesheet.6ae04185be267d218870ba8449572db8ef0ebb0e2863c2c015d6a0d5bce015cf.css integrity="sha256-auBBhb4mfSGIcLqESVctuO8Ouw4oY8LAFdag1bzgFc8=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.lvbibir.cn/images/avatar.webp><link rel=icon type=image/png sizes=16x16 href=https://www.lvbibir.cn/images/avatar.webp><link rel=icon type=image/png sizes=32x32 href=https://www.lvbibir.cn/images/avatar.webp><link rel=apple-touch-icon href=https://www.lvbibir.cn/images/avatar.webp><link rel=mask-icon href=https://www.lvbibir.cn/images/avatar.webp><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=/fonts/JetBrainsLxgwNerdMono/all.css><script>document.addEventListener('DOMContentLoaded',function(){const e=document.querySelectorAll('img.lazyload');if('IntersectionObserver'in window){const t=new IntersectionObserver(function(e){e.forEach(function(e){if(e.isIntersecting){const n=e.target;n.src=n.dataset.src,n.classList.remove('lazyload'),n.classList.add('lazyloaded'),t.unobserve(n)}})},{rootMargin:'50px 0px',threshold:.01});e.forEach(function(e){t.observe(e)})}else e.forEach(function(e){e.src=e.dataset.src})})</script><meta property="og:title" content="docker | å®¹å™¨çš„è·¨ä¸»æœºè¿æ¥"><meta property="og:description" content="ä»‹ç» docker å®¹å™¨åœ¨ä¸åŒå®¿ä¸»æœºä¸‹å®ç°é€šä¿¡çš„å‡ ç§æ–¹æ¡ˆ"><meta property="og:type" content="article"><meta property="og:url" content="https://www.lvbibir.cn/posts/tech/docker-rong-qi-kua-zhu-ji-lian-jie/"><meta property="og:image" content="https://www.lvbibir.cn/images/cover-docker.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-08-01T00:00:00+00:00"><meta property="article:modified_time" content="2024-01-28T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.lvbibir.cn/images/cover-docker.png"><meta name=twitter:title content="docker | å®¹å™¨çš„è·¨ä¸»æœºè¿æ¥"><meta name=twitter:description content="ä»‹ç» docker å®¹å™¨åœ¨ä¸åŒå®¿ä¸»æœºä¸‹å®ç°é€šä¿¡çš„å‡ ç§æ–¹æ¡ˆ"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"ğŸ“š æ–‡ç« ","item":"https://www.lvbibir.cn/posts/"},{"@type":"ListItem","position":3,"name":"ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯","item":"https://www.lvbibir.cn/posts/tech/"},{"@type":"ListItem","position":4,"name":"docker | å®¹å™¨çš„è·¨ä¸»æœºè¿æ¥","item":"https://www.lvbibir.cn/posts/tech/docker-rong-qi-kua-zhu-ji-lian-jie/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"docker | å®¹å™¨çš„è·¨ä¸»æœºè¿æ¥","name":"docker | å®¹å™¨çš„è·¨ä¸»æœºè¿æ¥","description":"ä»‹ç» docker å®¹å™¨åœ¨ä¸åŒå®¿ä¸»æœºä¸‹å®ç°é€šä¿¡çš„å‡ ç§æ–¹æ¡ˆ","keywords":["linux","docker","network"],"articleBody":"0 å‰è¨€ å®ç°è·¨ä¸»æœºçš„ docker å®¹å™¨ä¹‹é—´çš„é€šè®¯ï¼š\nä½¿ç”¨ç½‘æ¡¥å®ç°è·¨ä¸»æœºçš„è¿æ¥ docker åŸç”Ÿçš„ç½‘ç»œï¼šoverlayã€macvlan ç¬¬ä¸‰æ–¹ç½‘ç»œï¼šflaanelã€weaveã€calic 1 ç½‘æ¡¥ 2 open vswitch 3 weave 4 macvlan 4.1 ç®€ä»‹ macvlan æ˜¯ Linux æ“ä½œç³»ç»Ÿå†…æ ¸æä¾›çš„ç½‘ç»œè™šæ‹ŸåŒ–æ–¹æ¡ˆä¹‹ä¸€ï¼Œæ›´å‡†ç¡®çš„è¯´æ³•æ˜¯ç½‘å¡è™šæ‹ŸåŒ–æ–¹æ¡ˆã€‚å®ƒå¯ä»¥ä¸ºä¸€å¼ ç‰©ç†ç½‘å¡è®¾ç½®å¤šä¸ª mac åœ°å€ï¼Œç›¸å½“äºç‰©ç†ç½‘å¡æ–½å±•äº†å½±åˆ†èº«ä¹‹æœ¯ï¼Œç”±ä¸€ä¸ªå˜å¤šä¸ªï¼ŒåŒæ—¶è¦æ±‚ç‰©ç†ç½‘å¡æ‰“å¼€æ··æ‚æ¨¡å¼ã€‚é’ˆå¯¹æ¯ä¸ª mac åœ°å€ï¼Œéƒ½å¯ä»¥è®¾ç½® IP åœ°å€ï¼Œæœ¬æ¥æ˜¯ä¸€å—ç‰©ç†ç½‘å¡è¿æ¥åˆ°äº¤æ¢æœºï¼Œç°åœ¨æ˜¯å¤šå—è™šæ‹Ÿç½‘å¡è¿æ¥åˆ°äº¤æ¢æœºã€‚\nå½“å®¹å™¨éœ€è¦ç›´è¿å…¥ç‰©ç†ç½‘ç»œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ Macvlanã€‚Macvlan æœ¬èº«ä¸åˆ›å»ºç½‘ç»œï¼Œæœ¬è´¨ä¸Šé¦–å…ˆä½¿å®¿ä¸»æœºç‰©ç†ç½‘å¡å·¥ä½œåœ¨â€˜æ··æ‚æ¨¡å¼â€™ï¼Œè¿™æ ·ç‰©ç†ç½‘å¡çš„ MAC åœ°å€å°†ä¼šå¤±æ•ˆï¼Œæ‰€æœ‰äºŒå±‚ç½‘ç»œä¸­çš„æµé‡ç‰©ç†ç½‘å¡éƒ½èƒ½æ”¶åˆ°ã€‚æ¥ä¸‹æ¥å°±æ˜¯åœ¨è¿™å¼ ç‰©ç†ç½‘å¡ä¸Šåˆ›å»ºè™šæ‹Ÿç½‘å¡ï¼Œå¹¶ä¸ºè™šæ‹Ÿç½‘å¡æŒ‡å®š MAC åœ°å€ï¼Œå®ç°ä¸€å¡å¤šç”¨ï¼Œåœ¨ç‰©ç†ç½‘ç»œçœ‹æ¥ï¼Œæ¯å¼ è™šæ‹Ÿç½‘å¡éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„æ¥å£ã€‚ä½¿ç”¨ Macvlan æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š\nå®¹å™¨ç›´æ¥è¿æ¥ç‰©ç†ç½‘ç»œï¼Œç”±ç‰©ç†ç½‘ç»œè´Ÿè´£åˆ†é… IP åœ°å€ï¼Œå¯èƒ½çš„ç»“æœæ˜¯ç‰©ç†ç½‘ç»œ IP åœ°å€è¢«è€—å°½ï¼Œå¦ä¸€ä¸ªåæœæ˜¯ç½‘ç»œæ€§èƒ½é—®é¢˜ï¼Œç‰©ç†ç½‘ç»œä¸­æ¥å…¥çš„ä¸»æœºå˜å¤šï¼Œå¹¿æ’­åŒ…å æ¯”å¿«é€Ÿå‡é«˜è€Œå¼•èµ·çš„ç½‘ç»œæ€§èƒ½ä¸‹é™é—®é¢˜ã€‚ å‰è¾¹è¯´è¿‡äº†ï¼Œå®¿ä¸»æœºä¸Šçš„æŸå¼ ç½‘ä¸Šéœ€è¦å·¥ä½œåœ¨â€˜æ··ä¹±æ¨¡å¼â€™ä¸‹ã€‚ ä»é•¿è¿œæ¥çœ‹ bridge ç½‘ç»œä¸ overlay ç½‘ç»œæ˜¯æ›´å¥½çš„é€‰æ‹©ï¼ŒåŸå› å°±æ˜¯è™šæ‹Ÿç½‘ç»œåº”è¯¥ä¸ç‰©ç†ç½‘ç»œéš”ç¦»è€Œä¸æ˜¯å…±äº«ã€‚ ä¼˜ç¼ºç‚¹ï¼š\nä¼˜ç‚¹æ˜¯æ€§èƒ½éå¸¸å¥½ ç¼ºç‚¹æ˜¯åœ°å€éœ€è¦æ‰‹åŠ¨åˆ†é… Macvlan ç½‘ç»œæœ‰ä¸¤ç§æ¨¡å¼ï¼šbridge æ¨¡å¼ä¸ 802.1q trunk bridge æ¨¡å¼ã€‚\nbridge æ¨¡å¼ï¼ŒMacvlan ç½‘ç»œæµé‡ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºç‰©ç†ç½‘å¡ã€‚ 802.1q trunk bridge æ¨¡å¼ï¼ŒMacvlan ç½‘ç»œæµé‡ä½¿ç”¨ Docker åŠ¨æ€åˆ›å»ºçš„ 802.1q å­æ¥å£ï¼Œå¯¹äºè·¯ç”±ä¸è¿‡è™‘ï¼Œè¿™ç§æ¨¡å¼èƒ½å¤Ÿæä¾›æ›´ç»†ç²’åº¦çš„æ§åˆ¶ 4.2 éƒ¨ç½² ç¯å¢ƒå‡†å¤‡ï¼š\nä¸¤å° centos7 docker ç‰ˆæœ¬ï¼š18.03 ipï¼š192.168.0.53ï¼ˆnode-1ï¼‰ 192.168.0.54ï¼ˆnode-2ï¼‰ [root@node-1 ~]# ip link show ens33 [root@node-1 ~]# ip link set ens32 promisc on #å¼€å¯æ··æ‚æ¨¡å¼ï¼Œä¿è¯å¤šä¸ªipå¯ä»¥é€šè¿‡ [root@node-1 ~]# docker network create -d macvlan --subnet 10.0.0.0/24 --gateway=10.0.0.1 -o parent=ens33 mac_net1 [root@node-1 ~]# docker network ls node-1 docker run -itd --name bbox-1 --ip 10.0.0.11 --network mac_net1 busybox node-2 docker run -itd --name bbox-2 --ip 10.0.0.12 --network mac_net1 busybox node-1 [root@node-1 ~]# docker exec bbox-1 ping 10.0.0.12 [root@node-1 ~]# docker exec bbox-1 ping bbox-2 å¯ä»¥ ping é€š ipï¼Œä½†æ˜¯æ— æ³• ping é€šä¸»æœºåï¼Œå› ä¸ºå®ƒæ²¡æœ‰ dns è§£æ\n[root@node-1 ~]# brctl show å› ä¸º macvlan ä¸ä¾èµ–äº bridge ç½‘ç»œï¼Œæ‰€ä»¥æŸ¥çœ‹ä¸åˆ°æ–°çš„æ¡¥æ¥ç½‘ç»œ\n[root@node-1 ~]# docker exec bbox-1 ip link æŸ¥çœ‹åˆ° eth0 è¿æ¥åˆ°äº† if2\n[root@node-1 ~]# ip link show ens33 å¯ä»¥æŸ¥çœ‹åˆ° ens33 çš„ç¼–å·æ˜¯ 2ï¼Œå³ bbox-1 å®¹å™¨çš„ eth0 ç½‘å¡è¿æ¥åˆ°äº† ens33 ç‰©ç†ç½‘å¡\n[root@node-1 ~]# docker network create -d macvlan -o parent=ens33 mac_net2 Error response from daemon: network dm-b34ee1020a96 is already using parent interface ens33 å†åˆ›å»º macvlan ç½‘ç»œæ—¶å‘ç°å·²ç»æ— æ³•å†åˆ›å»ºï¼Œå³ä¸€å—ç½‘å¡åªèƒ½æ·»åŠ ä¸€ä¸ª macvlan çš„åœ°å€\n4.3 ä¸€å—ç½‘å¡ç»‘å®šå¤šä¸ª macvlan åœ°å€ [root@node-1 ~]# modinfo 8021q # æŸ¥çœ‹å†…æ ¸æ˜¯å¦æ”¯æŒ802.1qå°è£… [root@node-1 ~]# modprobe 8021q # å¦‚æœä¸Šæ¡å‘½ä»¤æ‰§è¡Œåæ²¡æœ‰ç»“æœï¼Œä½¿ç”¨è¯¥å‘½ä»¤åŠ è½½è¯¥æ¨¡å— node-1 [root@node-1 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33 BOOTPROTO=manual ä¿®æ”¹ä¸ºä¸éœ€è¦ ip çš„ manual æ¨¡å¼\nnode-2 [root@node-2 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens32 BOOTPROTO=manual node-1 æ·»åŠ ä¸¤å—è™šæ‹Ÿç½‘å¡ï¼Œæ³¨æ„ä¸å®é™…çš„ ens32 ç½‘å¡çš„ç½‘æ®µåŒºåˆ†å¼€\nens32 ä½¿ç”¨çš„æ˜¯ 192.168.0.0/24 ç½‘æ®µï¼Œè™šæ‹Ÿç½‘å¡ä½¿ç”¨çš„æ˜¯ 192.168.1.0/24 å’Œ 192.168.2.0/24\n[root@node-1 ~]# cp -p /etc/sysconfig/network-scripts/ifcfg-ens33 /etc/sysconfig/network-scripts/ifcfg-ens33.10 [root@node-1 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33.10 BOOTPROTO=none NAME=ens33.10 DEVICE=ens33.10 ONBOOT=yes IPADDR=192.168.1.10 PREFIX=24 NETWORK=192.168.1.0 VLAN=yes [root@node-1 ~]# cp -p /etc/sysconfig/network-scripts/ifcfg-ens33.10 /etc/sysconfig/network-scripts/ifcfg-ens33.20 [root@node-1 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33.20 BOOTPROTO=none NAME=ens33.20 DEVICE=ens33.20 ONBOOT=yes IPADDR=192.168.2.10 PREFIX=24 NETWORK=192.168.2.0 VLAN=yes [root@node-1 ~]# ifup ens33.10 [root@node-1 ~]# ifup ens33.20 [root@node-1 ~]# scp /etc/sysconfig/network-scripts/ifcfg-ens33.10 192.168.0.54:/etc/sysconfig/network-scripts/ifcfg-ens32.10 [root@node-1 ~]# scp /etc/sysconfig/network-scripts/ifcfg-ens33.20 192.168.0.54:/etc/sysconfig/network-scripts/ifcfg-ens32.20 node-2 [root@node-2 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens32.10 BOOTPROTO=none NAME=ens32.10 DEVICE=ens32.10 ONBOOT=yes IPADDR=192.168.1.20 PREFIX=24 NETWORK=192.168.1.0 VLAN=yes [root@node-2 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens32.20 BOOTPROTO=none NAME=ens32.20 DEVICE=ens32.20 ONBOOT=yes IPADDR=192.168.2.20 PREFIX=24 NETWORK=192.168.2.0 VLAN=yes [root@node-2 ~]# ifup ens32.10 [root@node-2 ~]# ifup ens32.20 node-1 [root@node-1 ~]# docker network create -d macvlan --subnet 172.16.11.0/24 --gateway 172.16.11.1 -o parent=ens33.10 mac_net11 [root@node-1 ~]# docker network create -d macvlan --subnet 172.16.12.0/24 --gateway 172.16.12.1 -o parent=ens33.20 mac_net12 node-2 [root@node-2 ~]# docker network create -d macvlan --subnet 172.16.11.0/24 --gateway 172.16.11.1 -o parent=ens32.10 mac_net11 [root@node-2 ~]# docker network create -d macvlan --subnet 172.16.12.0/24 --gateway 172.16.12.1 -o parent=ens32.20 mac_net12 node-1 [root@node-2 ~]# docker run -itd --name bbox-11 --ip=172.16.11.11 --network mac_net11 busybox [root@node-2 ~]# docker run -itd --name bbox-12 --ip=172.16.12.11 --network mac_net12 busybox node-2 [root@node-2 ~]# docker run -itd --name bbox-21 --ip=172.16.11.12 --network mac_net11 busybox [root@node-2 ~]# docker run -itd --name bbox-22 --ip=172.16.12.12 --network mac_net12 busybox node-1 [root@node-1 ~]# docker exec bbox-11 ping 172.16.11.12 PING 172.16.11.12 (172.16.11.12): 56 data bytes 64 bytes from 172.16.11.12: seq=0 ttl=64 time=0.867 ms 64 bytes from 172.16.11.12: seq=1 ttl=64 time=1.074 ms 64 bytes from 172.16.11.12: seq=2 ttl=64 time=1.145 ms 64 bytes from 172.16.11.12: seq=3 ttl=64 time=0.938 ms ^C [root@node-1 ~]# docker exec bbox-12 ping 172.16.12.12 PING 172.16.12.12 (172.16.12.12): 56 data bytes 64 bytes from 172.16.12.12: seq=0 ttl=64 time=0.858 ms 64 bytes from 172.16.12.12: seq=1 ttl=64 time=1.140 ms 64 bytes from 172.16.12.12: seq=2 ttl=64 time=0.818 ms 64 bytes from 172.16.12.12: seq=3 ttl=64 time=1.056 ms ^C åœ¨ä¸¤å°ç³»ç»Ÿè¿›è¡Œä¿®æ”¹ï¼Œæ·»åŠ ç½‘å…³ï¼Œä¿®æ”¹é˜²ç«å¢™ç­–ç•¥ node-1 ä¸­è®°å¾—å°† ens32 æ›´æ¢ä¸º ens33 ifconfig ens32.10 172.16.10.1 netmask 255.255.255.0 ifconfig ens32.20 172.16.20.1 netmask 255.255.255.0 iptables -t nat -A POSTROUTING -o ens32.10 -j MASQUERADE iptables -t nat -A POSTROUTING -o ens32 -j MASQUERADE iptables -A FORWARD -i ens32.10 -o ens32 -m state --state RELATE,ESTABLISHED -j ACCEPT iptables -A FORWARD -i ens32 -o ens32.10 -m state --state RELATE,ESTABLISHED -j ACCEPT iptables -A FORWARD -i ens32.10 -o ens32 -j ACCEPT iptables -A FORWARD -i ens32 -o ens32.10 -j ACCEPT 5 overlay 5.1 ç®€ä»‹ 5.2 å‡†å¤‡ overlay ç¯å¢ƒ ä¸ºæ”¯æŒå®¹å™¨çš„è·¨ä¸»æœºé€šä¿¡ï¼ŒDocker æä¾›äº† overlay driverã€‚Docker overlay ç½‘ç»œéœ€è¦ä¸€ä¸ª key-value æ•°æ®åº“ç”¨äºä¿å­˜ç½‘ç»œçŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬ Networkã€Endpointã€IP ç­‰ã€‚Consulã€Etcd å’Œ ZooKeeper éƒ½æ˜¯ Docker æ”¯æŒçš„ key-value è½¯ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Consul\nç¯å¢ƒæè¿° èŠ‚ç‚¹ ç³»ç»Ÿç‰ˆæœ¬ docker ç‰ˆæœ¬ è§’è‰² IP åœ°å€ node-1 centos7.4 docker-18.03.0 consul 192.168.0.101 node-2 centos7.4 docker-18.03.0 host 192.168.0.102 node-3 centos7.4 docker-18.03.0 host 192.168.0.103 åˆ›å»º consul node-1; [root@node-1 ~]# docker run -d -p 8500:8500 -h consul --name consul progrium/consul -server -bootstrap å®¹å™¨å¯åŠ¨åå¯ä»¥é€šè¿‡ 192.168.0.101:8500 è®¿é—®åˆ° consul\nä¿®æ”¹ docker é…ç½®æ–‡ä»¶ ä¿®æ”¹ node-2 å’Œ node-3 çš„ docker daemon çš„é…ç½®æ–‡ä»¶/etc/systemd/system/docker.service\n[root@node-2 ~]# vim /etc/systemd/system/docker.service ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock --cluster-store=consul://192.168.0.101:8500 --cluster-advertise=ens32:2376 [root@node-2 ~]# systemctl daemon-reload [root@node-2 ~]# systemctl restart docker -H ï¼štcpï¼šå…è®¸ tcp è¿æ¥ daemon -Hï¼šunixï¼šé»˜è®¤çš„ socket è¿æ¥æ–¹å¼ï¼Œæ”¯æŒè¿œç¨‹çš„åŒæ—¶ï¼Œæœ¬åœ°ä¹Ÿå¯ä»¥è¿æ¥ â€“cluster-store æŒ‡å®š consul çš„åœ°å€ â€“cluster-advertise å‘ŠçŸ¥ consul è‡ªå·±çš„è¿æ¥åœ°å€ node-2 å’Œ node-3 ä¼šè‡ªåŠ¨æ³¨å†Œåˆ° consul æ•°æ®åº“ä¸­ã€‚\n5.3 åˆ›å»º overlay ç½‘ç»œ åœ¨ node-2 ä¸­åˆ›å»ºç½‘ç»œ åœ¨ node-2 ä¸­åˆ›å»º overlay ç½‘ç»œ ov_net1\n[root@node-2 ~]# docker network create -d overlay ov_net1 -d overlayï¼šæŒ‡å®š driver ä¸º overlay [root@node-2 ~]# docker network ls node-3 æŸ¥çœ‹åˆ›å»ºçš„ç½‘ç»œ æ³¨æ„åˆ° ov_net1 çš„ SCOPE ä¸º globalï¼Œè€Œå…¶ä»–ç½‘ç»œä¸º local ã€‚åœ¨ node-3 ä¸ŠæŸ¥çœ‹å­˜åœ¨çš„ç½‘ç»œ:\n[root@node-3 ~]# docker network ls node-3 ä¸Šä¹Ÿèƒ½çœ‹åˆ° ov_net1ï¼Œåªæ˜¯å› ä¸ºåˆ›å»º ov_net1 æ—¶å°† overlay ç½‘ç»œä¿¡æ¯å­˜å…¥äº† consulï¼Œnode-3 ä» consul è¯»å–åˆ°äº†æ–°ç½‘ç»œæ•°æ®ã€‚ä¹‹å ov_net1 çš„ä»»ä½•å˜åŒ–éƒ½ä¼šåŒæ­¥åˆ° node-2 å’Œ node-3\næŸ¥çœ‹ ov_net1 è¯¦ç»†ä¿¡æ¯ [root@node-2 ~]# docker network inspect ov_net1 IPAM æ˜¯æŒ‡ IP Address Managementï¼Œdocker è‡ªåŠ¨ä¸º ov_net1 åˆ†é…çš„ IP ç©ºé—´ä¸º 10.0.0.0/24\n5.4 åœ¨ overlay ä¸­è¿è¡Œå®¹å™¨ åˆ›å»ºå®¹å™¨ bbox-1 åœ¨ node-2 ä¸Šè¿è¡Œä¸€ä¸ª busybox å®¹å™¨å¹¶è¿æ¥åˆ° ov_net1.\n[root@node-2 ~]# docker run -itd --name bbox-1 --network ov_net1 busybox æŸ¥çœ‹ bbox-1 ç½‘ç»œé…ç½® [root@node-2 ~]# docker exec bbox-1 ip r default via 172.18.0.1 dev eth1 10.0.0.0/24 dev eth0 scope link src 10.0.0.2 172.18.0.0/16 dev eth1 scope link src 172.18.0.2 bbox-1 æœ‰ä¸¤ä¸ªç½‘ç»œæ¥å£ï¼Œeth0 å’Œ eth1 eth0 IP ä¸º 10.0.0.2ï¼Œè¿æ¥çš„æ˜¯ overlay ç½‘ç»œ ov_net1 eth1 IP ä¸º 172.18.0.2 å®¹å™¨çš„é»˜è®¤è·¯ç”±æ˜¯èµ° eth1ï¼Œå…¶å®ï¼Œdocker ä¼šåˆ›å»ºä¸€ä¸ª bridge ç½‘ç»œ â€œdocker_gwbridgeâ€ï¼Œä¸ºæ‰€æœ‰è¿æ¥åˆ° overlay ç½‘ç»œçš„å®¹å™¨æä¾›è®¿é—®å¤–ç½‘çš„èƒ½åŠ› [root@node-2 ~]# docker network ls [root@node-2 ~]# docker network inspect docker_gwbridge ä» docker network inspect docker_gwbridge è¾“å‡ºå¯ç¡®è®¤ docker_gwbridge çš„ IP åœ°å€èŒƒå›´æ˜¯ 172.18.0.0/16ï¼Œå½“å‰è¿æ¥çš„å®¹å™¨å°±æ˜¯ bbox-1ï¼ˆ172.18.0.2ï¼‰\nè€Œä¸”æ­¤ç½‘ç»œçš„ç½‘å…³å°±æ˜¯ç½‘æ¡¥ docker_gwbridge çš„ IP 172.18.0.1\n[root@node-2 ~]# ifconfig docker_gwbridge docker_gwbridge: flags=4163 mtu 1500 inet 172.18.0.1 netmask 255.255.0.0 broadcast 172.18.255.255 inet6 fe80::42:c5ff:fe45:937 prefixlen 64 scopeid 0x20 ether 02:42:c5:45:09:37 txqueuelen 0 (Ethernet) RX packets 0 bytes 0 (0.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 0 bytes 0 (0.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 è¿™æ ·å®¹å™¨ bbox-1 å°±å¯ä»¥é€šè¿‡ docker_gwbridge è®¿é—®å¤–ç½‘\n[root@node-2 ~]# docker exec bbox-1 ping -c 4 www.baidu.com PING www.baidu.com (182.61.200.6): 56 data bytes 64 bytes from 182.61.200.6: seq=0 ttl=53 time=6.721 ms 64 bytes from 182.61.200.6: seq=1 ttl=53 time=7.954 ms 64 bytes from 182.61.200.6: seq=2 ttl=53 time=11.723 ms 64 bytes from 182.61.200.6: seq=3 ttl=53 time=15.105 ms --- www.baidu.com ping statistics --- 4 packets transmitted, 4 packets received, 0% packet loss round-trip min/avg/max = 6.721/10.375/15.105 ms 5.5 overlay ç½‘ç»œè¿é€šæ€§ node-3 ä¸­ è¿è¡Œ bbox-2 [root@node-3 ~]# docker run -itd --name bbox-2 --network ov_net1 busybox æŸ¥çœ‹ bbox-2 è·¯ç”±æƒ…å†µ [root@node-3 ~]# docker exec bbox-2 ip r default via 172.18.0.1 dev eth1 10.0.0.0/24 dev eth0 scope link src 10.0.0.3 172.18.0.0/16 dev eth1 scope link src 172.18.0.2 äº’é€šæµ‹è¯• [root@node-3 ~]# docker exec bbox-2 ping -c 4 10.0.0.2 PING 10.0.0.2 (10.0.0.2): 56 data bytes 64 bytes from 10.0.0.2: seq=0 ttl=64 time=2.628 ms 64 bytes from 10.0.0.2: seq=1 ttl=64 time=1.004 ms 64 bytes from 10.0.0.2: seq=2 ttl=64 time=1.277 ms 64 bytes from 10.0.0.2: seq=3 ttl=64 time=1.505 ms --- 10.0.0.2 ping statistics --- 4 packets transmitted, 4 packets received, 0% packet loss round-trip min/avg/max = 1.004/1.603/2.628 ms å¯è§ overlay ç½‘ç»œä¸­çš„å®¹å™¨å¯ä»¥ç›´æ¥é€šä¿¡ï¼ŒåŒæ—¶ docker ä¹Ÿå®ç°äº† DNS æœåŠ¡\nå®ç°åŸç† docker ä¼šä¸ºæ¯ä¸ª overlay ç½‘ç»œåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ network namespaceï¼Œå…¶ä¸­ä¼šæœ‰ä¸€ä¸ª linux bridge br0ï¼Œ veth pair ä¸€ç«¯è¿æ¥åˆ°å®¹å™¨ä¸­ï¼ˆå³ eth0ï¼‰ï¼Œå¦ä¸€ç«¯è¿æ¥åˆ° namespace çš„ br0 ä¸Šã€‚\nbr0 é™¤äº†è¿æ¥æ‰€æœ‰çš„ veth pairï¼Œè¿˜ä¼šè¿æ¥ä¸€ä¸ª vxlan è®¾å¤‡ï¼Œç”¨äºä¸å…¶ä»– host å»ºç«‹ vxlan tunnelã€‚å®¹å™¨ä¹‹é—´çš„æ•°æ®å°±æ˜¯é€šè¿‡è¿™ä¸ª tunnel é€šä¿¡çš„ã€‚é€»è¾‘ç½‘ç»œæ‹“æ‰‘ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼š\n[root@node-2 ~]# brctl show bridge name bridge id STP enabled interfaces docker0 8000.024217edc413 no docker_gwbridge 8000.0242c5450937 no vethc59120e virbr0 8000.525400b76fd4 yes virbr0-nic [root@node-3 ~]# brctl show bridge name bridge id STP enabled interfaces docker0 8000.0242ef3c7df7 no docker_gwbridge 8000.0242c81afaee no vethf4562a9 virbr0 8000.525400c28478 yes virbr0-nic è¦æŸ¥çœ‹ overlay ç½‘ç»œçš„ namespace å¯ä»¥åœ¨ node-2 å’Œ node-3 ä¸Šæ‰§è¡Œ ip netnsï¼ˆè¯·ç¡®ä¿åœ¨æ­¤ä¹‹å‰æ‰§è¡Œè¿‡ ln -s /var/run/docker/netns /var/run/netnsï¼‰ï¼Œå¯ä»¥çœ‹åˆ°ä¸¤ä¸ª node ä¸Šæœ‰ä¸€ä¸ªç›¸åŒçš„ namespace â€œ1-dd91de7599â€\n[root@node-2 ~]# ln -s /var/run/docker/netns /var/run/netns [root@node-2 ~]# ip netns 6889f61efc4b (id: 1) 1-dd91de7599 (id: 0) [root@node-3 ~]# ln -s /var/run/docker/netns /var/run/netns [root@node-3 ~]# ip netns 8e4722847745 (id: 1) 1-dd91de7599 (id: 0) â€œ1-dd91de7599â€ è¿™å°±æ˜¯ ov_net1 çš„ namespaceï¼ŒæŸ¥çœ‹ namespace ä¸­çš„ br0 ä¸Šçš„è®¾å¤‡\n[root@node-2 ~]# ip netns exec 1-dd91de7599 brctl show bridge name bridge id STP enabled interfaces br0 8000.0e7576c7c035 no veth0 vxlan0 5.6 overlay ç½‘ç»œéš”ç¦» ä¸åŒçš„ overlay ç½‘ç»œæ˜¯ç›¸äº’éš”ç¦»çš„ã€‚æˆ‘ä»¬åˆ›å»ºç¬¬äºŒä¸ª overlay ç½‘ç»œ ov_net2 å¹¶è¿è¡Œå®¹å™¨ bbox-3\nåˆ›å»ºç½‘ç»œ ov_net2 [root@node-2 ~]# docker network create -d overlay ov_net2 å¯åŠ¨å®¹å™¨ bbox-3 [root@node-2 ~]# docker run -itd --name bbox-3 --network ov_net2 busybox æŸ¥çœ‹ bbox-3 ç½‘ç»œ bbox-3 åˆ†é…åˆ°çš„ IP æ˜¯ 10.0.1.2ï¼Œå°è¯• ping bbox-1ï¼ˆ10.0.0.2ï¼‰\n[root@node-2 ~]# docker exec -it bbox-3 ip r default via 172.18.0.1 dev eth1 10.0.1.0/24 dev eth0 scope link src 10.0.1.2 172.18.0.0/16 dev eth1 scope link src 172.18.0.3 [root@node-2 ~]# docker exec -it bbox-3 ping -c 4 10.0.0.2 PING 10.0.0.2 (10.0.0.2): 56 data bytes --- 10.0.0.2 ping statistics --- 4 packets transmitted, 0 packets received, 100% packet loss [root@node-2 ~]# docker exec -it bbox-3 ping -c 4 172.18.0.2 PING 172.18.0.2 (172.18.0.2): 56 data bytes --- 172.18.0.2 ping statistics --- 4 packets transmitted, 0 packets received, 100% packet loss ping å¤±è´¥ï¼Œå¯è§ä¸åŒ overlay ç½‘ç»œä¹‹é—´æ˜¯éš”ç¦»çš„ï¼Œå³ä½¿é€šè¿‡ docker_gwbridge ä¹Ÿä¸èƒ½é€šä¿¡\nå¦‚æœè¦å®ç° bbox-3 å’Œ bbox-1 é€šä¿¡ï¼Œå¯ä»¥å°† bbox-3 ä¹Ÿè¿æ¥åˆ° ov_net1\nè¿™æ—¶ bbox-3 åŒæ—¶è¿æ¥åˆ°äº† ov_net1 å’Œ ov_net2 ä¸Š\n[root@node-2 ~]# docker network connect ov_net1 bbox-3 [root@node-2 ~]# docker exec bbox-3 ip r default via 172.18.0.1 dev eth1 10.0.0.0/24 dev eth2 scope link src 10.0.0.4 10.0.1.0/24 dev eth0 scope link src 10.0.1.2 172.18.0.0/16 dev eth1 scope link src 172.18.0.3 [root@node-2 ~]# docker exec bbox-3 ping -c 4 10.0.0.2 PING 10.0.0.2 (10.0.0.2): 56 data bytes 64 bytes from 10.0.0.2: seq=0 ttl=64 time=0.184 ms 64 bytes from 10.0.0.2: seq=1 ttl=64 time=0.158 ms 64 bytes from 10.0.0.2: seq=2 ttl=64 time=0.162 ms 64 bytes from 10.0.0.2: seq=3 ttl=64 time=0.093 ms --- 10.0.0.2 ping statistics --- 4 packets transmitted, 4 packets received, 0% packet loss round-trip min/avg/max = 0.093/0.149/0.184 ms docker é»˜è®¤ä¸º overlay ç½‘ç»œåˆ†é… 24 ä½æ©ç çš„å­ç½‘ï¼ˆ10.0.X.0/24ï¼‰ï¼Œæ‰€æœ‰ä¸»æœºå…±äº«è¿™ä¸ª subnetï¼Œå®¹å™¨å¯åŠ¨æ—¶ä¼šé¡ºåºä»æ­¤ç©ºé—´åˆ†é… IPã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ â€“subnet æŒ‡å®š IP ç©ºé—´ã€‚\ndocker network create -d overlay --subnet 10.22.1.0/24 ov_net ä»¥ä¸Š\n","wordCount":"3402","inLanguage":"en","image":"https://www.lvbibir.cn/images/cover-docker.png","datePublished":"2019-08-01T00:00:00Z","dateModified":"2024-01-28T00:00:00Z","author":{"@type":"Person","name":"lvbibir"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.lvbibir.cn/posts/tech/docker-rong-qi-kua-zhu-ji-lian-jie/"},"publisher":{"@type":"Organization","name":"lvbibir's Blog","logo":{"@type":"ImageObject","url":"https://www.lvbibir.cn/images/avatar.webp"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://www.lvbibir.cn accesskey=h title="lvbibir's Blog (Alt + H)"><img src=https://www.lvbibir.cn/images/avatar.webp alt aria-label=logo height=35>lvbibir's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li class=menu-item><a href=https://www.lvbibir.cn/search title="ğŸ” æœç´¢ (Alt + /)" accesskey=/><span>ğŸ” æœç´¢</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/posts title="ğŸ“š æ–‡ç« "><span>ğŸ“š æ–‡ç« </span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/archives title="ğŸ“ˆ å½’æ¡£"><span>ğŸ“ˆ å½’æ¡£</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/talk title="ğŸ’¬ è¯´è¯´"><span>ğŸ’¬ è¯´è¯´</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/links title="ğŸ¤ å‹é“¾"><span>ğŸ¤ å‹é“¾</span></a></li></ul></nav></header><main class="main page"><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://www.lvbibir.cn>ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://www.lvbibir.cn/posts/>ğŸ“š æ–‡ç« </a>&nbsp;Â»&nbsp;<a href=https://www.lvbibir.cn/posts/tech/>ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a></div><h1 class=post-title>docker | å®¹å™¨çš„è·¨ä¸»æœºè¿æ¥</h1><div class=post-description>ä»‹ç» docker å®¹å™¨åœ¨ä¸åŒå®¿ä¸»æœºä¸‹å®ç°é€šä¿¡çš„å‡ ç§æ–¹æ¡ˆ</div><div class=post-meta>åˆ›å»º:&nbsp;<span title='2019-08-01 00:00:00 +0000 UTC'>2019-08-01</span>&nbsp;|&nbsp;æ›´æ–°:&nbsp;2024-01-28&nbsp;|&nbsp;å­—æ•°:&nbsp;3402å­—&nbsp;|&nbsp;ä½œè€…:&nbsp;lvbibir
|&nbsp;æ ‡ç­¾:&nbsp;<ul class=post-tags-meta><a href=https://www.lvbibir.cn/tags/docker/>docker</a></ul><span id=busuanzi_container_page_pv>&nbsp;|&nbsp;è®¿é—®:&nbsp;<span id=busuanzi_page_pv></span></span></div></header><button id=toc-toggle-btn class=toc-toggle-btn aria-label="Toggle Table of Contents" title=æ–‡ç« ç›®å½•><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2zm0 4h14v-2H3v2zm0 4h14v-2H3v2zm16 0h2v-2h-2v2zm0-10v2h2V7h-2zm0 6h2v-2h-2v2z"/></svg></button><div id=toc-overlay class=toc-overlay></div><aside id=toc-container class="toc-container wide"><button id=toc-close-btn class=toc-close-btn aria-label="Close Table of Contents"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>æ–‡ç« ç›®å½•</span></summary><div class=inner><ul><li><a href=#0-%e5%89%8d%e8%a8%80 aria-label="0 å‰è¨€">0 å‰è¨€</a></li><li><a href=#1-%e7%bd%91%e6%a1%a5 aria-label="1 ç½‘æ¡¥">1 ç½‘æ¡¥</a></li><li><a href=#2-open-vswitch aria-label="2 open vswitch">2 open vswitch</a></li><li><a href=#3-weave aria-label="3 weave">3 weave</a></li><li><a href=#4-macvlan aria-label="4 macvlan">4 macvlan</a><ul><li><a href=#41-%e7%ae%80%e4%bb%8b aria-label="4.1 ç®€ä»‹">4.1 ç®€ä»‹</a></li><li><a href=#42-%e9%83%a8%e7%bd%b2 aria-label="4.2 éƒ¨ç½²">4.2 éƒ¨ç½²</a></li><li><a href=#43-%e4%b8%80%e5%9d%97%e7%bd%91%e5%8d%a1%e7%bb%91%e5%ae%9a%e5%a4%9a%e4%b8%aa-macvlan-%e5%9c%b0%e5%9d%80 aria-label="4.3 ä¸€å—ç½‘å¡ç»‘å®šå¤šä¸ª macvlan åœ°å€">4.3 ä¸€å—ç½‘å¡ç»‘å®šå¤šä¸ª macvlan åœ°å€</a></li></ul></li><li><a href=#5-overlay aria-label="5 overlay">5 overlay</a><ul><li><a href=#51-%e7%ae%80%e4%bb%8b aria-label="5.1 ç®€ä»‹">5.1 ç®€ä»‹</a></li><li><a href=#52-%e5%87%86%e5%a4%87-overlay-%e7%8e%af%e5%a2%83 aria-label="5.2 å‡†å¤‡ overlay ç¯å¢ƒ">5.2 å‡†å¤‡ overlay ç¯å¢ƒ</a></li><li><a href=#53-%e5%88%9b%e5%bb%ba-overlay-%e7%bd%91%e7%bb%9c aria-label="5.3 åˆ›å»º overlay ç½‘ç»œ">5.3 åˆ›å»º overlay ç½‘ç»œ</a></li><li><a href=#54-%e5%9c%a8-overlay-%e4%b8%ad%e8%bf%90%e8%a1%8c%e5%ae%b9%e5%99%a8 aria-label="5.4 åœ¨ overlay ä¸­è¿è¡Œå®¹å™¨">5.4 åœ¨ overlay ä¸­è¿è¡Œå®¹å™¨</a></li><li><a href=#55-overlay-%e7%bd%91%e7%bb%9c%e8%bf%9e%e9%80%9a%e6%80%a7 aria-label="5.5 overlay ç½‘ç»œè¿é€šæ€§">5.5 overlay ç½‘ç»œè¿é€šæ€§</a></li><li><a href=#56-overlay-%e7%bd%91%e7%bb%9c%e9%9a%94%e7%a6%bb aria-label="5.6 overlay ç½‘ç»œéš”ç¦»">5.6 overlay ç½‘ç»œéš”ç¦»</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;const tocContainer=document.getElementById("toc-container"),tocToggleBtn=document.getElementById("toc-toggle-btn"),tocCloseBtn=document.getElementById("toc-close-btn"),tocOverlay=document.getElementById("toc-overlay");window.addEventListener('DOMContentLoaded',function(){if(checkTocPosition(),elements=document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]'),elements.length>0){activeElement=elements[0];const t=encodeURI(activeElement.getAttribute('id')).toLowerCase(),e=document.querySelector(`.inner ul li a[href="#${t}"]`);e&&e.classList.add('active')}},!1),window.addEventListener('resize',function(){checkTocPosition()},!1),window.addEventListener('scroll',()=>{if(!elements||elements.length===0)return;activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(t=>{const n=encodeURI(t.getAttribute('id')).toLowerCase(),e=document.querySelector(`.inner ul li a[href="#${n}"]`);e&&(t===activeElement?e.classList.add('active'):e.classList.remove('active'))})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue('--gap'),10);let isWideMode=!1,isTocVisible=!0;function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?(isWideMode=!0,isTocVisible?(tocContainer.classList.add("wide"),tocContainer.classList.remove("collapsed"),tocContainer.classList.remove("mobile-popup"),tocToggleBtn.classList.add("active")):(tocContainer.classList.remove("wide"),tocContainer.classList.add("collapsed"),tocContainer.classList.remove("mobile-popup"),tocToggleBtn.classList.remove("active")),closeTocPopup()):(isWideMode=!1,tocContainer.classList.remove("wide"),tocContainer.classList.contains("mobile-popup")||tocContainer.classList.add("collapsed"),tocContainer.classList.contains("active")?tocToggleBtn.classList.add("active"):tocToggleBtn.classList.remove("active"))}function openTocPopup(){tocContainer.classList.remove("collapsed"),tocContainer.classList.add("mobile-popup"),tocContainer.classList.add("active"),tocOverlay.classList.add("active"),tocToggleBtn.classList.add("active"),document.body.style.overflow="hidden"}function closeTocPopup(){tocContainer.classList.remove("active"),tocOverlay.classList.remove("active"),document.body.style.overflow="",setTimeout(()=>{tocContainer.classList.contains("active")||(tocContainer.classList.remove("mobile-popup"),(!isWideMode||!isTocVisible)&&tocContainer.classList.add("collapsed"))},300)}function toggleToc(){isWideMode?(isTocVisible=!isTocVisible,isTocVisible?(tocContainer.classList.add("wide"),tocContainer.classList.remove("collapsed"),tocToggleBtn.classList.add("active")):(tocContainer.classList.remove("wide"),tocContainer.classList.add("collapsed"),tocToggleBtn.classList.remove("active"))):tocContainer.classList.contains("active")?(closeTocPopup(),tocToggleBtn.classList.remove("active")):openTocPopup()}tocToggleBtn.addEventListener('click',function(){toggleToc()}),tocCloseBtn.addEventListener('click',function(){closeTocPopup(),tocToggleBtn.classList.remove("active")}),tocOverlay.addEventListener('click',function(){closeTocPopup(),tocToggleBtn.classList.remove("active")}),tocContainer.querySelectorAll('.inner a').forEach(function(e){e.addEventListener('click',function(){tocContainer.classList.contains("mobile-popup")&&(closeTocPopup(),tocToggleBtn.classList.remove("active"))})}),document.addEventListener('keydown',function(e){e.key==='Escape'&&tocContainer.classList.contains("active")&&(closeTocPopup(),tocToggleBtn.classList.remove("active"))});function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=0-å‰è¨€>0 å‰è¨€<a hidden class=anchor aria-hidden=true href=#0-å‰è¨€>#</a></h1><p>å®ç°è·¨ä¸»æœºçš„ docker å®¹å™¨ä¹‹é—´çš„é€šè®¯ï¼š</p><ol><li>ä½¿ç”¨ç½‘æ¡¥å®ç°è·¨ä¸»æœºçš„è¿æ¥</li><li>docker åŸç”Ÿçš„ç½‘ç»œï¼šoverlayã€macvlan</li><li>ç¬¬ä¸‰æ–¹ç½‘ç»œï¼šflaanelã€weaveã€calic</li></ol><h1 id=1-ç½‘æ¡¥>1 ç½‘æ¡¥<a hidden class=anchor aria-hidden=true href=#1-ç½‘æ¡¥>#</a></h1><p><img class=lazyload src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-src=/images/image-20190815-125207.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿° decoding=async><noscript><img src=/images/image-20190815-125207.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></noscript></p><h1 id=2-open-vswitch>2 open vswitch<a hidden class=anchor aria-hidden=true href=#2-open-vswitch>#</a></h1><h1 id=3-weave>3 weave<a hidden class=anchor aria-hidden=true href=#3-weave>#</a></h1><h1 id=4-macvlan>4 macvlan<a hidden class=anchor aria-hidden=true href=#4-macvlan>#</a></h1><h2 id=41-ç®€ä»‹>4.1 ç®€ä»‹<a hidden class=anchor aria-hidden=true href=#41-ç®€ä»‹>#</a></h2><p>macvlan æ˜¯ Linux æ“ä½œç³»ç»Ÿå†…æ ¸æä¾›çš„ç½‘ç»œè™šæ‹ŸåŒ–æ–¹æ¡ˆä¹‹ä¸€ï¼Œæ›´å‡†ç¡®çš„è¯´æ³•æ˜¯ç½‘å¡è™šæ‹ŸåŒ–æ–¹æ¡ˆã€‚å®ƒå¯ä»¥ä¸ºä¸€å¼ ç‰©ç†ç½‘å¡è®¾ç½®å¤šä¸ª mac åœ°å€ï¼Œç›¸å½“äºç‰©ç†ç½‘å¡æ–½å±•äº†å½±åˆ†èº«ä¹‹æœ¯ï¼Œç”±ä¸€ä¸ªå˜å¤šä¸ªï¼ŒåŒæ—¶è¦æ±‚ç‰©ç†ç½‘å¡æ‰“å¼€æ··æ‚æ¨¡å¼ã€‚é’ˆå¯¹æ¯ä¸ª mac åœ°å€ï¼Œéƒ½å¯ä»¥è®¾ç½® IP åœ°å€ï¼Œæœ¬æ¥æ˜¯ä¸€å—ç‰©ç†ç½‘å¡è¿æ¥åˆ°äº¤æ¢æœºï¼Œç°åœ¨æ˜¯å¤šå—è™šæ‹Ÿç½‘å¡è¿æ¥åˆ°äº¤æ¢æœºã€‚</p><p>å½“å®¹å™¨éœ€è¦ç›´è¿å…¥ç‰©ç†ç½‘ç»œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ Macvlanã€‚Macvlan æœ¬èº«ä¸åˆ›å»ºç½‘ç»œï¼Œæœ¬è´¨ä¸Šé¦–å…ˆä½¿å®¿ä¸»æœºç‰©ç†ç½‘å¡å·¥ä½œåœ¨â€˜æ··æ‚æ¨¡å¼â€™ï¼Œè¿™æ ·ç‰©ç†ç½‘å¡çš„ MAC åœ°å€å°†ä¼šå¤±æ•ˆï¼Œæ‰€æœ‰äºŒå±‚ç½‘ç»œä¸­çš„æµé‡ç‰©ç†ç½‘å¡éƒ½èƒ½æ”¶åˆ°ã€‚æ¥ä¸‹æ¥å°±æ˜¯åœ¨è¿™å¼ ç‰©ç†ç½‘å¡ä¸Šåˆ›å»ºè™šæ‹Ÿç½‘å¡ï¼Œå¹¶ä¸ºè™šæ‹Ÿç½‘å¡æŒ‡å®š MAC åœ°å€ï¼Œå®ç°ä¸€å¡å¤šç”¨ï¼Œåœ¨ç‰©ç†ç½‘ç»œçœ‹æ¥ï¼Œæ¯å¼ è™šæ‹Ÿç½‘å¡éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„æ¥å£ã€‚ä½¿ç”¨ Macvlan æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š</p><ul><li>å®¹å™¨ç›´æ¥è¿æ¥ç‰©ç†ç½‘ç»œï¼Œç”±ç‰©ç†ç½‘ç»œè´Ÿè´£åˆ†é… IP åœ°å€ï¼Œå¯èƒ½çš„ç»“æœæ˜¯ç‰©ç†ç½‘ç»œ IP åœ°å€è¢«è€—å°½ï¼Œå¦ä¸€ä¸ªåæœæ˜¯ç½‘ç»œæ€§èƒ½é—®é¢˜ï¼Œç‰©ç†ç½‘ç»œä¸­æ¥å…¥çš„ä¸»æœºå˜å¤šï¼Œå¹¿æ’­åŒ…å æ¯”å¿«é€Ÿå‡é«˜è€Œå¼•èµ·çš„ç½‘ç»œæ€§èƒ½ä¸‹é™é—®é¢˜ã€‚</li><li>å‰è¾¹è¯´è¿‡äº†ï¼Œå®¿ä¸»æœºä¸Šçš„æŸå¼ ç½‘ä¸Šéœ€è¦å·¥ä½œåœ¨â€˜æ··ä¹±æ¨¡å¼â€™ä¸‹ã€‚</li><li>ä»é•¿è¿œæ¥çœ‹ bridge ç½‘ç»œä¸ overlay ç½‘ç»œæ˜¯æ›´å¥½çš„é€‰æ‹©ï¼ŒåŸå› å°±æ˜¯è™šæ‹Ÿç½‘ç»œåº”è¯¥ä¸ç‰©ç†ç½‘ç»œéš”ç¦»è€Œä¸æ˜¯å…±äº«ã€‚</li></ul><p>ä¼˜ç¼ºç‚¹ï¼š</p><ul><li>ä¼˜ç‚¹æ˜¯æ€§èƒ½éå¸¸å¥½</li><li>ç¼ºç‚¹æ˜¯åœ°å€éœ€è¦æ‰‹åŠ¨åˆ†é…</li></ul><p>Macvlan ç½‘ç»œæœ‰ä¸¤ç§æ¨¡å¼ï¼šbridge æ¨¡å¼ä¸ 802.1q trunk bridge æ¨¡å¼ã€‚</p><ul><li>bridge æ¨¡å¼ï¼ŒMacvlan ç½‘ç»œæµé‡ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºç‰©ç†ç½‘å¡ã€‚</li><li>802.1q trunk bridge æ¨¡å¼ï¼ŒMacvlan ç½‘ç»œæµé‡ä½¿ç”¨ Docker åŠ¨æ€åˆ›å»ºçš„ 802.1q å­æ¥å£ï¼Œå¯¹äºè·¯ç”±ä¸è¿‡è™‘ï¼Œè¿™ç§æ¨¡å¼èƒ½å¤Ÿæä¾›æ›´ç»†ç²’åº¦çš„æ§åˆ¶</li></ul><h2 id=42-éƒ¨ç½²>4.2 éƒ¨ç½²<a hidden class=anchor aria-hidden=true href=#42-éƒ¨ç½²>#</a></h2><p>ç¯å¢ƒå‡†å¤‡ï¼š</p><ol><li>ä¸¤å° centos7</li><li>docker ç‰ˆæœ¬ï¼š18.03</li><li>ipï¼š192.168.0.53ï¼ˆnode-1ï¼‰ 192.168.0.54ï¼ˆnode-2ï¼‰</li></ol><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># ip link show ens33</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># ip link set ens32 promisc on</span>
</span></span><span style=display:flex><span><span style=color:#776e71>#å¼€å¯æ··æ‚æ¨¡å¼ï¼Œä¿è¯å¤šä¸ªipå¯ä»¥é€šè¿‡</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker network create -d macvlan --subnet 10.0.0.0/24 --gateway=10.0.0.1 -o parent=ens33 mac_net1</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker network ls</span>
</span></span></code></pre></div><p><img class=lazyload src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-src=/images/image-20190818-182057.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿° decoding=async><noscript><img src=/images/image-20190818-182057.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></noscript></p><ul><li>node-1</li></ul><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -itd --name bbox-1 --ip 10.0.0.11 --network mac_net1 busybox
</span></span></code></pre></div><ul><li>node-2</li></ul><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -itd --name bbox-2 --ip 10.0.0.12 --network mac_net1 busybox
</span></span></code></pre></div><ul><li>node-1</li></ul><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker exec bbox-1 ping 10.0.0.12</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker exec bbox-1 ping bbox-2</span>
</span></span></code></pre></div><p>å¯ä»¥ ping é€š ipï¼Œä½†æ˜¯æ— æ³• ping é€šä¸»æœºåï¼Œå› ä¸ºå®ƒæ²¡æœ‰ dns è§£æ</p><p><img class=lazyload src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-src=/images/image-20190818-182937.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿° decoding=async><noscript><img src=/images/image-20190818-182937.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></noscript></p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># brctl show</span>
</span></span></code></pre></div><p>å› ä¸º macvlan ä¸ä¾èµ–äº bridge ç½‘ç»œï¼Œæ‰€ä»¥æŸ¥çœ‹ä¸åˆ°æ–°çš„æ¡¥æ¥ç½‘ç»œ</p><p><img class=lazyload src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-src=/images/image-20190818-183048.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿° decoding=async><noscript><img src=/images/image-20190818-183048.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></noscript></p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker exec bbox-1  ip link</span>
</span></span></code></pre></div><p>æŸ¥çœ‹åˆ° eth0 è¿æ¥åˆ°äº† if2</p><p><img class=lazyload src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-src=/images/image-20190818-183317.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿° decoding=async><noscript><img src=/images/image-20190818-183317.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></noscript></p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># ip link show ens33</span>
</span></span></code></pre></div><p>å¯ä»¥æŸ¥çœ‹åˆ° ens33 çš„ç¼–å·æ˜¯ 2ï¼Œå³ bbox-1 å®¹å™¨çš„ eth0 ç½‘å¡è¿æ¥åˆ°äº† ens33 ç‰©ç†ç½‘å¡</p><p><img class=lazyload src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-src=/images/image-20190818-183502.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿° decoding=async><noscript><img src=/images/image-20190818-183502.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></noscript></p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker network create  -d macvlan -o parent=ens33 mac_net2</span>
</span></span><span style=display:flex><span>Error response from daemon: network dm-b34ee1020a96 is already using parent interface ens33
</span></span></code></pre></div><p>å†åˆ›å»º macvlan ç½‘ç»œæ—¶å‘ç°å·²ç»æ— æ³•å†åˆ›å»ºï¼Œå³ä¸€å—ç½‘å¡åªèƒ½æ·»åŠ ä¸€ä¸ª macvlan çš„åœ°å€</p><h2 id=43-ä¸€å—ç½‘å¡ç»‘å®šå¤šä¸ª-macvlan-åœ°å€>4.3 ä¸€å—ç½‘å¡ç»‘å®šå¤šä¸ª macvlan åœ°å€<a hidden class=anchor aria-hidden=true href=#43-ä¸€å—ç½‘å¡ç»‘å®šå¤šä¸ª-macvlan-åœ°å€>#</a></h2><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># modinfo 8021q</span>
</span></span><span style=display:flex><span><span style=color:#776e71># æŸ¥çœ‹å†…æ ¸æ˜¯å¦æ”¯æŒ802.1qå°è£…</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># modprobe 8021q</span>
</span></span><span style=display:flex><span><span style=color:#776e71># å¦‚æœä¸Šæ¡å‘½ä»¤æ‰§è¡Œåæ²¡æœ‰ç»“æœï¼Œä½¿ç”¨è¯¥å‘½ä»¤åŠ è½½è¯¥æ¨¡å—</span>
</span></span></code></pre></div><ul><li>node-1</li></ul><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># vim /etc/sysconfig/network-scripts/ifcfg-ens33</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>BOOTPROTO</span><span style=color:#5bc4bf>=</span>manual
</span></span></code></pre></div><p>ä¿®æ”¹ä¸ºä¸éœ€è¦ ip çš„ manual æ¨¡å¼</p><ul><li>node-2</li></ul><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># vim /etc/sysconfig/network-scripts/ifcfg-ens32</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>BOOTPROTO</span><span style=color:#5bc4bf>=</span>manual
</span></span></code></pre></div><ul><li>node-1</li></ul><p>æ·»åŠ ä¸¤å—è™šæ‹Ÿç½‘å¡ï¼Œæ³¨æ„ä¸å®é™…çš„ ens32 ç½‘å¡çš„ç½‘æ®µåŒºåˆ†å¼€</p><p>ens32 ä½¿ç”¨çš„æ˜¯ 192.168.0.0/24 ç½‘æ®µï¼Œè™šæ‹Ÿç½‘å¡ä½¿ç”¨çš„æ˜¯ 192.168.1.0/24 å’Œ 192.168.2.0/24</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># cp -p /etc/sysconfig/network-scripts/ifcfg-ens33 /etc/sysconfig/network-scripts/ifcfg-ens33.10</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># vim /etc/sysconfig/network-scripts/ifcfg-ens33.10</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>BOOTPROTO</span><span style=color:#5bc4bf>=</span>none
</span></span><span style=display:flex><span><span style=color:#ef6155>NAME</span><span style=color:#5bc4bf>=</span>ens33.10
</span></span><span style=display:flex><span><span style=color:#ef6155>DEVICE</span><span style=color:#5bc4bf>=</span>ens33.10
</span></span><span style=display:flex><span><span style=color:#ef6155>ONBOOT</span><span style=color:#5bc4bf>=</span>yes
</span></span><span style=display:flex><span><span style=color:#ef6155>IPADDR</span><span style=color:#5bc4bf>=</span>192.168.1.10
</span></span><span style=display:flex><span><span style=color:#ef6155>PREFIX</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>24</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>NETWORK</span><span style=color:#5bc4bf>=</span>192.168.1.0
</span></span><span style=display:flex><span><span style=color:#ef6155>VLAN</span><span style=color:#5bc4bf>=</span>yes
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># cp -p /etc/sysconfig/network-scripts/ifcfg-ens33.10 /etc/sysconfig/network-scripts/ifcfg-ens33.20</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># vim /etc/sysconfig/network-scripts/ifcfg-ens33.20</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>BOOTPROTO</span><span style=color:#5bc4bf>=</span>none
</span></span><span style=display:flex><span><span style=color:#ef6155>NAME</span><span style=color:#5bc4bf>=</span>ens33.20
</span></span><span style=display:flex><span><span style=color:#ef6155>DEVICE</span><span style=color:#5bc4bf>=</span>ens33.20
</span></span><span style=display:flex><span><span style=color:#ef6155>ONBOOT</span><span style=color:#5bc4bf>=</span>yes
</span></span><span style=display:flex><span><span style=color:#ef6155>IPADDR</span><span style=color:#5bc4bf>=</span>192.168.2.10
</span></span><span style=display:flex><span><span style=color:#ef6155>PREFIX</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>24</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>NETWORK</span><span style=color:#5bc4bf>=</span>192.168.2.0
</span></span><span style=display:flex><span><span style=color:#ef6155>VLAN</span><span style=color:#5bc4bf>=</span>yes
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># ifup ens33.10</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># ifup ens33.20</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># scp /etc/sysconfig/network-scripts/ifcfg-ens33.10 192.168.0.54:/etc/sysconfig/network-scripts/ifcfg-ens32.10</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># scp /etc/sysconfig/network-scripts/ifcfg-ens33.20 192.168.0.54:/etc/sysconfig/network-scripts/ifcfg-ens32.20</span>
</span></span></code></pre></div><ul><li>node-2</li></ul><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># vim /etc/sysconfig/network-scripts/ifcfg-ens32.10</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>BOOTPROTO</span><span style=color:#5bc4bf>=</span>none
</span></span><span style=display:flex><span><span style=color:#ef6155>NAME</span><span style=color:#5bc4bf>=</span>ens32.10
</span></span><span style=display:flex><span><span style=color:#ef6155>DEVICE</span><span style=color:#5bc4bf>=</span>ens32.10
</span></span><span style=display:flex><span><span style=color:#ef6155>ONBOOT</span><span style=color:#5bc4bf>=</span>yes
</span></span><span style=display:flex><span><span style=color:#ef6155>IPADDR</span><span style=color:#5bc4bf>=</span>192.168.1.20
</span></span><span style=display:flex><span><span style=color:#ef6155>PREFIX</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>24</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>NETWORK</span><span style=color:#5bc4bf>=</span>192.168.1.0
</span></span><span style=display:flex><span><span style=color:#ef6155>VLAN</span><span style=color:#5bc4bf>=</span>yes
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># vim /etc/sysconfig/network-scripts/ifcfg-ens32.20</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>BOOTPROTO</span><span style=color:#5bc4bf>=</span>none
</span></span><span style=display:flex><span><span style=color:#ef6155>NAME</span><span style=color:#5bc4bf>=</span>ens32.20
</span></span><span style=display:flex><span><span style=color:#ef6155>DEVICE</span><span style=color:#5bc4bf>=</span>ens32.20
</span></span><span style=display:flex><span><span style=color:#ef6155>ONBOOT</span><span style=color:#5bc4bf>=</span>yes
</span></span><span style=display:flex><span><span style=color:#ef6155>IPADDR</span><span style=color:#5bc4bf>=</span>192.168.2.20
</span></span><span style=display:flex><span><span style=color:#ef6155>PREFIX</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>24</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>NETWORK</span><span style=color:#5bc4bf>=</span>192.168.2.0
</span></span><span style=display:flex><span><span style=color:#ef6155>VLAN</span><span style=color:#5bc4bf>=</span>yes
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># ifup ens32.10</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># ifup ens32.20</span>
</span></span></code></pre></div><ul><li>node-1</li></ul><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker network create -d macvlan --subnet 172.16.11.0/24 --gateway 172.16.11.1 -o parent=ens33.10 mac_net11</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker network create -d macvlan --subnet 172.16.12.0/24 --gateway 172.16.12.1 -o parent=ens33.20 mac_net12</span>
</span></span></code></pre></div><ul><li>node-2</li></ul><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker network create -d macvlan --subnet 172.16.11.0/24 --gateway 172.16.11.1 -o parent=ens32.10 mac_net11</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker network create -d macvlan --subnet 172.16.12.0/24 --gateway 172.16.12.1 -o parent=ens32.20 mac_net12</span>
</span></span></code></pre></div><ul><li>node-1</li></ul><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker run -itd --name bbox-11 --ip=172.16.11.11 --network mac_net11 busybox</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker run -itd --name bbox-12 --ip=172.16.12.11 --network mac_net12 busybox</span>
</span></span></code></pre></div><ul><li>node-2</li></ul><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker run -itd --name bbox-21 --ip=172.16.11.12 --network mac_net11 busybox</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker run -itd --name bbox-22 --ip=172.16.12.12 --network mac_net12 busybox</span>
</span></span></code></pre></div><ul><li>node-1</li></ul><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker exec bbox-11 ping 172.16.11.12</span>
</span></span><span style=display:flex><span>PING 172.16.11.12 <span style=color:#5bc4bf>(</span>172.16.11.12<span style=color:#5bc4bf>)</span>: <span style=color:#f99b15>56</span> data bytes
</span></span><span style=display:flex><span><span style=color:#f99b15>64</span> bytes from 172.16.11.12: <span style=color:#ef6155>seq</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>0</span> <span style=color:#ef6155>ttl</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>64</span> <span style=color:#ef6155>time</span><span style=color:#5bc4bf>=</span>0.867 ms
</span></span><span style=display:flex><span><span style=color:#f99b15>64</span> bytes from 172.16.11.12: <span style=color:#ef6155>seq</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>1</span> <span style=color:#ef6155>ttl</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>64</span> <span style=color:#ef6155>time</span><span style=color:#5bc4bf>=</span>1.074 ms
</span></span><span style=display:flex><span><span style=color:#f99b15>64</span> bytes from 172.16.11.12: <span style=color:#ef6155>seq</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>2</span> <span style=color:#ef6155>ttl</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>64</span> <span style=color:#ef6155>time</span><span style=color:#5bc4bf>=</span>1.145 ms
</span></span><span style=display:flex><span><span style=color:#f99b15>64</span> bytes from 172.16.11.12: <span style=color:#ef6155>seq</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>3</span> <span style=color:#ef6155>ttl</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>64</span> <span style=color:#ef6155>time</span><span style=color:#5bc4bf>=</span>0.938 ms
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker exec bbox-12 ping 172.16.12.12</span>
</span></span><span style=display:flex><span>PING 172.16.12.12 <span style=color:#5bc4bf>(</span>172.16.12.12<span style=color:#5bc4bf>)</span>: <span style=color:#f99b15>56</span> data bytes
</span></span><span style=display:flex><span><span style=color:#f99b15>64</span> bytes from 172.16.12.12: <span style=color:#ef6155>seq</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>0</span> <span style=color:#ef6155>ttl</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>64</span> <span style=color:#ef6155>time</span><span style=color:#5bc4bf>=</span>0.858 ms
</span></span><span style=display:flex><span><span style=color:#f99b15>64</span> bytes from 172.16.12.12: <span style=color:#ef6155>seq</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>1</span> <span style=color:#ef6155>ttl</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>64</span> <span style=color:#ef6155>time</span><span style=color:#5bc4bf>=</span>1.140 ms
</span></span><span style=display:flex><span><span style=color:#f99b15>64</span> bytes from 172.16.12.12: <span style=color:#ef6155>seq</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>2</span> <span style=color:#ef6155>ttl</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>64</span> <span style=color:#ef6155>time</span><span style=color:#5bc4bf>=</span>0.818 ms
</span></span><span style=display:flex><span><span style=color:#f99b15>64</span> bytes from 172.16.12.12: <span style=color:#ef6155>seq</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>3</span> <span style=color:#ef6155>ttl</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>64</span> <span style=color:#ef6155>time</span><span style=color:#5bc4bf>=</span>1.056 ms
</span></span><span style=display:flex><span>^C
</span></span></code></pre></div><ul><li>åœ¨ä¸¤å°ç³»ç»Ÿè¿›è¡Œä¿®æ”¹ï¼Œæ·»åŠ ç½‘å…³ï¼Œä¿®æ”¹é˜²ç«å¢™ç­–ç•¥</li><li>node-1 ä¸­è®°å¾—å°† ens32 æ›´æ¢ä¸º ens33</li></ul><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ifconfig ens32.10 172.16.10.1 netmask 255.255.255.0
</span></span><span style=display:flex><span>ifconfig ens32.20 172.16.20.1 netmask 255.255.255.0
</span></span><span style=display:flex><span>iptables -t nat -A POSTROUTING -o ens32.10 -j MASQUERADE
</span></span><span style=display:flex><span>iptables -t nat -A POSTROUTING -o ens32 -j MASQUERADE
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>iptables -A FORWARD -i ens32.10 -o ens32 -m state --state RELATE,ESTABLISHED -j ACCEPT
</span></span><span style=display:flex><span>iptables -A FORWARD -i ens32 -o ens32.10 -m state --state RELATE,ESTABLISHED -j ACCEPT
</span></span><span style=display:flex><span>iptables -A FORWARD -i ens32.10 -o ens32 -j ACCEPT
</span></span><span style=display:flex><span>iptables -A FORWARD -i ens32 -o ens32.10 -j ACCEPT
</span></span></code></pre></div><h1 id=5-overlay>5 overlay<a hidden class=anchor aria-hidden=true href=#5-overlay>#</a></h1><h2 id=51-ç®€ä»‹>5.1 ç®€ä»‹<a hidden class=anchor aria-hidden=true href=#51-ç®€ä»‹>#</a></h2><p><img class=lazyload src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-src=/images/image-20190819-130602.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿° decoding=async><noscript><img src=/images/image-20190819-130602.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></noscript></p><h2 id=52-å‡†å¤‡-overlay-ç¯å¢ƒ>5.2 å‡†å¤‡ overlay ç¯å¢ƒ<a hidden class=anchor aria-hidden=true href=#52-å‡†å¤‡-overlay-ç¯å¢ƒ>#</a></h2><p>ä¸ºæ”¯æŒå®¹å™¨çš„è·¨ä¸»æœºé€šä¿¡ï¼ŒDocker æä¾›äº† overlay driverã€‚Docker overlay ç½‘ç»œéœ€è¦ä¸€ä¸ª key-value æ•°æ®åº“ç”¨äºä¿å­˜ç½‘ç»œçŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬ Networkã€Endpointã€IP ç­‰ã€‚Consulã€Etcd å’Œ ZooKeeper éƒ½æ˜¯ Docker æ”¯æŒçš„ key-value è½¯ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Consul</p><ol><li>ç¯å¢ƒæè¿°</li></ol><table><thead><tr><th>èŠ‚ç‚¹</th><th>ç³»ç»Ÿç‰ˆæœ¬</th><th>docker ç‰ˆæœ¬</th><th>è§’è‰²</th><th>IP åœ°å€</th></tr></thead><tbody><tr><td>node-1</td><td>centos7.4</td><td>docker-18.03.0</td><td>consul</td><td>192.168.0.101</td></tr><tr><td>node-2</td><td>centos7.4</td><td>docker-18.03.0</td><td>host</td><td>192.168.0.102</td></tr><tr><td>node-3</td><td>centos7.4</td><td>docker-18.03.0</td><td>host</td><td>192.168.0.103</td></tr></tbody></table><ol><li>åˆ›å»º consul</li></ol><ul><li>node-1;</li></ul><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-1 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker run -d -p 8500:8500 -h consul --name consul progrium/consul -server -bootstrap</span>
</span></span></code></pre></div><p>å®¹å™¨å¯åŠ¨åå¯ä»¥é€šè¿‡ 192.168.0.101:8500 è®¿é—®åˆ° consul</p><p><img class=lazyload src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-src=/images/image-20190819-224043.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿° decoding=async><noscript><img src=/images/image-20190819-224043.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></noscript></p><ol><li>ä¿®æ”¹ docker é…ç½®æ–‡ä»¶</li></ol><p>ä¿®æ”¹ node-2 å’Œ node-3 çš„ docker daemon çš„é…ç½®æ–‡ä»¶/etc/systemd/system/docker.service</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># vim  /etc/systemd/system/docker.service</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>ExecStart</span><span style=color:#5bc4bf>=</span>/usr/bin/dockerd  -H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock --cluster-store<span style=color:#5bc4bf>=</span>consul://192.168.0.101:8500 --cluster-advertise<span style=color:#5bc4bf>=</span>ens32:2376
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># systemctl daemon-reload</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># systemctl restart docker</span>
</span></span></code></pre></div><ul><li>-H ï¼štcpï¼šå…è®¸ tcp è¿æ¥ daemon
-Hï¼šunixï¼šé»˜è®¤çš„ socket è¿æ¥æ–¹å¼ï¼Œæ”¯æŒè¿œç¨‹çš„åŒæ—¶ï¼Œæœ¬åœ°ä¹Ÿå¯ä»¥è¿æ¥</li><li>&ndash;cluster-store æŒ‡å®š consul çš„åœ°å€</li><li>&ndash;cluster-advertise å‘ŠçŸ¥ consul è‡ªå·±çš„è¿æ¥åœ°å€</li></ul><p>node-2 å’Œ node-3 ä¼šè‡ªåŠ¨æ³¨å†Œåˆ° consul æ•°æ®åº“ä¸­ã€‚</p><p><img class=lazyload src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-src=/images/image-20190819-225334.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿° decoding=async><noscript><img src=/images/image-20190819-225334.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></noscript></p><h2 id=53-åˆ›å»º-overlay-ç½‘ç»œ>5.3 åˆ›å»º overlay ç½‘ç»œ<a hidden class=anchor aria-hidden=true href=#53-åˆ›å»º-overlay-ç½‘ç»œ>#</a></h2><ol><li>åœ¨ node-2 ä¸­åˆ›å»ºç½‘ç»œ</li></ol><p>åœ¨ node-2 ä¸­åˆ›å»º overlay ç½‘ç»œ ov_net1</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker network create -d overlay ov_net1</span>
</span></span></code></pre></div><ul><li>-d overlayï¼šæŒ‡å®š driver ä¸º overlay</li></ul><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker network ls</span>
</span></span></code></pre></div><p><img class=lazyload src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-src=/images/image-20190819-225928.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿° decoding=async><noscript><img src=/images/image-20190819-225928.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></noscript></p><ol><li>node-3 æŸ¥çœ‹åˆ›å»ºçš„ç½‘ç»œ</li></ol><p>æ³¨æ„åˆ° ov_net1 çš„ SCOPE ä¸º globalï¼Œè€Œå…¶ä»–ç½‘ç»œä¸º local ã€‚åœ¨ node-3 ä¸ŠæŸ¥çœ‹å­˜åœ¨çš„ç½‘ç»œ:</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-3 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker network ls</span>
</span></span></code></pre></div><p><img class=lazyload src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-src=/images/image-20190819-230148.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿° decoding=async><noscript><img src=/images/image-20190819-230148.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></noscript></p><p>node-3 ä¸Šä¹Ÿèƒ½çœ‹åˆ° ov_net1ï¼Œåªæ˜¯å› ä¸ºåˆ›å»º ov_net1 æ—¶å°† overlay ç½‘ç»œä¿¡æ¯å­˜å…¥äº† consulï¼Œnode-3 ä» consul è¯»å–åˆ°äº†æ–°ç½‘ç»œæ•°æ®ã€‚ä¹‹å ov_net1 çš„ä»»ä½•å˜åŒ–éƒ½ä¼šåŒæ­¥åˆ° node-2 å’Œ node-3</p><ol><li>æŸ¥çœ‹ ov_net1 è¯¦ç»†ä¿¡æ¯</li></ol><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker network inspect ov_net1</span>
</span></span></code></pre></div><p><img class=lazyload src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-src=/images/image-20190819-230439.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿° decoding=async><noscript><img src=/images/image-20190819-230439.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></noscript></p><p>IPAM æ˜¯æŒ‡ IP Address Managementï¼Œdocker è‡ªåŠ¨ä¸º ov_net1 åˆ†é…çš„ IP ç©ºé—´ä¸º 10.0.0.0/24</p><h2 id=54-åœ¨-overlay-ä¸­è¿è¡Œå®¹å™¨>5.4 åœ¨ overlay ä¸­è¿è¡Œå®¹å™¨<a hidden class=anchor aria-hidden=true href=#54-åœ¨-overlay-ä¸­è¿è¡Œå®¹å™¨>#</a></h2><ol><li>åˆ›å»ºå®¹å™¨ bbox-1</li></ol><p>åœ¨ node-2 ä¸Šè¿è¡Œä¸€ä¸ª busybox å®¹å™¨å¹¶è¿æ¥åˆ° ov_net1.</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker run -itd --name bbox-1 --network ov_net1 busybox</span>
</span></span></code></pre></div><ol><li>æŸ¥çœ‹ bbox-1 ç½‘ç»œé…ç½®</li></ol><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker exec bbox-1 ip r</span>
</span></span><span style=display:flex><span>default via 172.18.0.1 dev eth1
</span></span><span style=display:flex><span>10.0.0.0/24 dev eth0 scope link  src 10.0.0.2
</span></span><span style=display:flex><span>172.18.0.0/16 dev eth1 scope link  src 172.18.0.2
</span></span></code></pre></div><ul><li>bbox-1 æœ‰ä¸¤ä¸ªç½‘ç»œæ¥å£ï¼Œeth0 å’Œ eth1</li><li>eth0 IP ä¸º 10.0.0.2ï¼Œè¿æ¥çš„æ˜¯ overlay ç½‘ç»œ ov_net1</li><li>eth1 IP ä¸º 172.18.0.2</li><li>å®¹å™¨çš„é»˜è®¤è·¯ç”±æ˜¯èµ° eth1ï¼Œå…¶å®ï¼Œdocker ä¼šåˆ›å»ºä¸€ä¸ª bridge ç½‘ç»œ â€œdocker_gwbridgeâ€ï¼Œä¸ºæ‰€æœ‰è¿æ¥åˆ° overlay ç½‘ç»œçš„å®¹å™¨æä¾›è®¿é—®å¤–ç½‘çš„èƒ½åŠ›</li></ul><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker network ls</span>
</span></span></code></pre></div><p><img class=lazyload src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-src=/images/image-20190819-231543.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿° decoding=async><noscript><img src=/images/image-20190819-231543.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></noscript></p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker network inspect docker_gwbridge</span>
</span></span></code></pre></div><p><img class=lazyload src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-src=/images/image-20190819-232009.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿° decoding=async><noscript><img src=/images/image-20190819-232009.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></noscript></p><p>ä» docker network inspect docker_gwbridge è¾“å‡ºå¯ç¡®è®¤ docker_gwbridge çš„ IP åœ°å€èŒƒå›´æ˜¯ 172.18.0.0/16ï¼Œå½“å‰è¿æ¥çš„å®¹å™¨å°±æ˜¯ bbox-1ï¼ˆ172.18.0.2ï¼‰</p><p>è€Œä¸”æ­¤ç½‘ç»œçš„ç½‘å…³å°±æ˜¯ç½‘æ¡¥ docker_gwbridge çš„ IP 172.18.0.1</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># ifconfig docker_gwbridge</span>
</span></span><span style=display:flex><span>docker_gwbridge: <span style=color:#ef6155>flags</span><span style=color:#5bc4bf>=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span style=color:#f99b15>1500</span>
</span></span><span style=display:flex><span>        inet 172.18.0.1  netmask 255.255.0.0  broadcast 172.18.255.255
</span></span><span style=display:flex><span>        inet6 fe80::42:c5ff:fe45:937  prefixlen <span style=color:#f99b15>64</span>  scopeid 0x20&lt;link&gt;
</span></span><span style=display:flex><span>        ether 02:42:c5:45:09:37  txqueuelen <span style=color:#f99b15>0</span>  <span style=color:#5bc4bf>(</span>Ethernet<span style=color:#5bc4bf>)</span>
</span></span><span style=display:flex><span>        RX packets <span style=color:#f99b15>0</span>  bytes <span style=color:#f99b15>0</span> <span style=color:#5bc4bf>(</span>0.0 B<span style=color:#5bc4bf>)</span>
</span></span><span style=display:flex><span>        RX errors <span style=color:#f99b15>0</span>  dropped <span style=color:#f99b15>0</span>  overruns <span style=color:#f99b15>0</span>  frame <span style=color:#f99b15>0</span>
</span></span><span style=display:flex><span>        TX packets <span style=color:#f99b15>0</span>  bytes <span style=color:#f99b15>0</span> <span style=color:#5bc4bf>(</span>0.0 B<span style=color:#5bc4bf>)</span>
</span></span><span style=display:flex><span>        TX errors <span style=color:#f99b15>0</span>  dropped <span style=color:#f99b15>0</span> overruns <span style=color:#f99b15>0</span>  carrier <span style=color:#f99b15>0</span>  collisions <span style=color:#f99b15>0</span>
</span></span></code></pre></div><p>è¿™æ ·å®¹å™¨ bbox-1 å°±å¯ä»¥é€šè¿‡ docker_gwbridge è®¿é—®å¤–ç½‘</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker exec bbox-1 ping -c 4 www.baidu.com</span>
</span></span><span style=display:flex><span>PING www.baidu.com <span style=color:#5bc4bf>(</span>182.61.200.6<span style=color:#5bc4bf>)</span>: <span style=color:#f99b15>56</span> data bytes
</span></span><span style=display:flex><span><span style=color:#f99b15>64</span> bytes from 182.61.200.6: <span style=color:#ef6155>seq</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>0</span> <span style=color:#ef6155>ttl</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>53</span> <span style=color:#ef6155>time</span><span style=color:#5bc4bf>=</span>6.721 ms
</span></span><span style=display:flex><span><span style=color:#f99b15>64</span> bytes from 182.61.200.6: <span style=color:#ef6155>seq</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>1</span> <span style=color:#ef6155>ttl</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>53</span> <span style=color:#ef6155>time</span><span style=color:#5bc4bf>=</span>7.954 ms
</span></span><span style=display:flex><span><span style=color:#f99b15>64</span> bytes from 182.61.200.6: <span style=color:#ef6155>seq</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>2</span> <span style=color:#ef6155>ttl</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>53</span> <span style=color:#ef6155>time</span><span style=color:#5bc4bf>=</span>11.723 ms
</span></span><span style=display:flex><span><span style=color:#f99b15>64</span> bytes from 182.61.200.6: <span style=color:#ef6155>seq</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>3</span> <span style=color:#ef6155>ttl</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>53</span> <span style=color:#ef6155>time</span><span style=color:#5bc4bf>=</span>15.105 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- www.baidu.com ping statistics ---
</span></span><span style=display:flex><span><span style=color:#f99b15>4</span> packets transmitted, <span style=color:#f99b15>4</span> packets received, 0% packet loss
</span></span><span style=display:flex><span>round-trip min/avg/max <span style=color:#5bc4bf>=</span> 6.721/10.375/15.105 ms
</span></span></code></pre></div><h2 id=55-overlay-ç½‘ç»œè¿é€šæ€§>5.5 overlay ç½‘ç»œè¿é€šæ€§<a hidden class=anchor aria-hidden=true href=#55-overlay-ç½‘ç»œè¿é€šæ€§>#</a></h2><ol><li>node-3 ä¸­ è¿è¡Œ bbox-2</li></ol><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-3 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker run -itd --name bbox-2 --network ov_net1 busybox</span>
</span></span></code></pre></div><ol><li>æŸ¥çœ‹ bbox-2 è·¯ç”±æƒ…å†µ</li></ol><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-3 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker exec bbox-2 ip r</span>
</span></span><span style=display:flex><span>default via 172.18.0.1 dev eth1
</span></span><span style=display:flex><span>10.0.0.0/24 dev eth0 scope link  src 10.0.0.3
</span></span><span style=display:flex><span>172.18.0.0/16 dev eth1 scope link  src 172.18.0.2
</span></span></code></pre></div><ol><li>äº’é€šæµ‹è¯•</li></ol><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-3 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker exec bbox-2 ping -c 4 10.0.0.2</span>
</span></span><span style=display:flex><span>PING 10.0.0.2 <span style=color:#5bc4bf>(</span>10.0.0.2<span style=color:#5bc4bf>)</span>: <span style=color:#f99b15>56</span> data bytes
</span></span><span style=display:flex><span><span style=color:#f99b15>64</span> bytes from 10.0.0.2: <span style=color:#ef6155>seq</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>0</span> <span style=color:#ef6155>ttl</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>64</span> <span style=color:#ef6155>time</span><span style=color:#5bc4bf>=</span>2.628 ms
</span></span><span style=display:flex><span><span style=color:#f99b15>64</span> bytes from 10.0.0.2: <span style=color:#ef6155>seq</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>1</span> <span style=color:#ef6155>ttl</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>64</span> <span style=color:#ef6155>time</span><span style=color:#5bc4bf>=</span>1.004 ms
</span></span><span style=display:flex><span><span style=color:#f99b15>64</span> bytes from 10.0.0.2: <span style=color:#ef6155>seq</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>2</span> <span style=color:#ef6155>ttl</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>64</span> <span style=color:#ef6155>time</span><span style=color:#5bc4bf>=</span>1.277 ms
</span></span><span style=display:flex><span><span style=color:#f99b15>64</span> bytes from 10.0.0.2: <span style=color:#ef6155>seq</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>3</span> <span style=color:#ef6155>ttl</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>64</span> <span style=color:#ef6155>time</span><span style=color:#5bc4bf>=</span>1.505 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 10.0.0.2 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#f99b15>4</span> packets transmitted, <span style=color:#f99b15>4</span> packets received, 0% packet loss
</span></span><span style=display:flex><span>round-trip min/avg/max <span style=color:#5bc4bf>=</span> 1.004/1.603/2.628 ms
</span></span></code></pre></div><p>å¯è§ overlay ç½‘ç»œä¸­çš„å®¹å™¨å¯ä»¥ç›´æ¥é€šä¿¡ï¼ŒåŒæ—¶ docker ä¹Ÿå®ç°äº† DNS æœåŠ¡</p><ol><li>å®ç°åŸç†</li></ol><p>docker ä¼šä¸ºæ¯ä¸ª overlay ç½‘ç»œåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ network namespaceï¼Œå…¶ä¸­ä¼šæœ‰ä¸€ä¸ª linux bridge br0ï¼Œ veth pair ä¸€ç«¯è¿æ¥åˆ°å®¹å™¨ä¸­ï¼ˆå³ eth0ï¼‰ï¼Œå¦ä¸€ç«¯è¿æ¥åˆ° namespace çš„ br0 ä¸Šã€‚</p><p>br0 é™¤äº†è¿æ¥æ‰€æœ‰çš„ veth pairï¼Œè¿˜ä¼šè¿æ¥ä¸€ä¸ª vxlan è®¾å¤‡ï¼Œç”¨äºä¸å…¶ä»– host å»ºç«‹ vxlan tunnelã€‚å®¹å™¨ä¹‹é—´çš„æ•°æ®å°±æ˜¯é€šè¿‡è¿™ä¸ª tunnel é€šä¿¡çš„ã€‚é€»è¾‘ç½‘ç»œæ‹“æ‰‘ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼š</p><p><img class=lazyload src=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 data-src=/images/image-20190819-233352.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿° decoding=async><noscript><img src=/images/image-20190819-233352.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></noscript></p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># brctl show</span>
</span></span><span style=display:flex><span>bridge name     bridge id               STP enabled     interfaces
</span></span><span style=display:flex><span>docker0         8000.024217edc413       no
</span></span><span style=display:flex><span>docker_gwbridge         8000.0242c5450937       no              vethc59120e
</span></span><span style=display:flex><span>virbr0          8000.525400b76fd4       yes             virbr0-nic
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-3 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># brctl show</span>
</span></span><span style=display:flex><span>bridge name     bridge id               STP enabled     interfaces
</span></span><span style=display:flex><span>docker0         8000.0242ef3c7df7       no
</span></span><span style=display:flex><span>docker_gwbridge         8000.0242c81afaee       no              vethf4562a9
</span></span><span style=display:flex><span>virbr0          8000.525400c28478       yes             virbr0-nic
</span></span></code></pre></div><p>è¦æŸ¥çœ‹ overlay ç½‘ç»œçš„ namespace å¯ä»¥åœ¨ node-2 å’Œ node-3 ä¸Šæ‰§è¡Œ ip netnsï¼ˆè¯·ç¡®ä¿åœ¨æ­¤ä¹‹å‰æ‰§è¡Œè¿‡ ln -s /var/run/docker/netns /var/run/netnsï¼‰ï¼Œå¯ä»¥çœ‹åˆ°ä¸¤ä¸ª node ä¸Šæœ‰ä¸€ä¸ªç›¸åŒçš„ namespace &ldquo;1-dd91de7599&rdquo;</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># ln -s /var/run/docker/netns /var/run/netns</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># ip netns</span>
</span></span><span style=display:flex><span>6889f61efc4b <span style=color:#5bc4bf>(</span>id: 1<span style=color:#5bc4bf>)</span>
</span></span><span style=display:flex><span>1-dd91de7599 <span style=color:#5bc4bf>(</span>id: 0<span style=color:#5bc4bf>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-3 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># ln -s /var/run/docker/netns /var/run/netns</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-3 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># ip netns</span>
</span></span><span style=display:flex><span>8e4722847745 <span style=color:#5bc4bf>(</span>id: 1<span style=color:#5bc4bf>)</span>
</span></span><span style=display:flex><span>1-dd91de7599 <span style=color:#5bc4bf>(</span>id: 0<span style=color:#5bc4bf>)</span>
</span></span></code></pre></div><p>&ldquo;1-dd91de7599&rdquo; è¿™å°±æ˜¯ ov_net1 çš„ namespaceï¼ŒæŸ¥çœ‹ namespace ä¸­çš„ br0 ä¸Šçš„è®¾å¤‡</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># ip netns exec 1-dd91de7599 brctl show</span>
</span></span><span style=display:flex><span>bridge name     bridge id               STP enabled     interfaces
</span></span><span style=display:flex><span>br0             8000.0e7576c7c035       no              veth0
</span></span><span style=display:flex><span>                                                        vxlan0
</span></span></code></pre></div><h2 id=56-overlay-ç½‘ç»œéš”ç¦»>5.6 overlay ç½‘ç»œéš”ç¦»<a hidden class=anchor aria-hidden=true href=#56-overlay-ç½‘ç»œéš”ç¦»>#</a></h2><p>ä¸åŒçš„ overlay ç½‘ç»œæ˜¯ç›¸äº’éš”ç¦»çš„ã€‚æˆ‘ä»¬åˆ›å»ºç¬¬äºŒä¸ª overlay ç½‘ç»œ ov_net2 å¹¶è¿è¡Œå®¹å™¨ bbox-3</p><ol><li>åˆ›å»ºç½‘ç»œ ov_net2</li></ol><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker network create -d overlay ov_net2</span>
</span></span></code></pre></div><ol><li>å¯åŠ¨å®¹å™¨ bbox-3</li></ol><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker run -itd --name bbox-3 --network ov_net2 busybox</span>
</span></span></code></pre></div><ol><li>æŸ¥çœ‹ bbox-3 ç½‘ç»œ</li></ol><p>bbox-3 åˆ†é…åˆ°çš„ IP æ˜¯ 10.0.1.2ï¼Œå°è¯• ping bbox-1ï¼ˆ10.0.0.2ï¼‰</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker exec -it bbox-3 ip r</span>
</span></span><span style=display:flex><span>default via 172.18.0.1 dev eth1
</span></span><span style=display:flex><span>10.0.1.0/24 dev eth0 scope link  src 10.0.1.2
</span></span><span style=display:flex><span>172.18.0.0/16 dev eth1 scope link  src 172.18.0.3
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker exec -it bbox-3 ping -c 4 10.0.0.2</span>
</span></span><span style=display:flex><span>PING 10.0.0.2 <span style=color:#5bc4bf>(</span>10.0.0.2<span style=color:#5bc4bf>)</span>: <span style=color:#f99b15>56</span> data bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 10.0.0.2 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#f99b15>4</span> packets transmitted, <span style=color:#f99b15>0</span> packets received, 100% packet loss
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker exec -it bbox-3 ping -c 4 172.18.0.2</span>
</span></span><span style=display:flex><span>PING 172.18.0.2 <span style=color:#5bc4bf>(</span>172.18.0.2<span style=color:#5bc4bf>)</span>: <span style=color:#f99b15>56</span> data bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 172.18.0.2 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#f99b15>4</span> packets transmitted, <span style=color:#f99b15>0</span> packets received, 100% packet loss
</span></span></code></pre></div><p>ping å¤±è´¥ï¼Œå¯è§ä¸åŒ overlay ç½‘ç»œä¹‹é—´æ˜¯éš”ç¦»çš„ï¼Œå³ä½¿é€šè¿‡ docker_gwbridge ä¹Ÿä¸èƒ½é€šä¿¡</p><p>å¦‚æœè¦å®ç° bbox-3 å’Œ bbox-1 é€šä¿¡ï¼Œå¯ä»¥å°† bbox-3 ä¹Ÿè¿æ¥åˆ° ov_net1</p><p>è¿™æ—¶ bbox-3 åŒæ—¶è¿æ¥åˆ°äº† ov_net1 å’Œ ov_net2 ä¸Š</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker network connect ov_net1 bbox-3</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker exec bbox-3 ip r</span>
</span></span><span style=display:flex><span>default via 172.18.0.1 dev eth1
</span></span><span style=display:flex><span>10.0.0.0/24 dev eth2 scope link  src 10.0.0.4
</span></span><span style=display:flex><span>10.0.1.0/24 dev eth0 scope link  src 10.0.1.2
</span></span><span style=display:flex><span>172.18.0.0/16 dev eth1 scope link  src 172.18.0.3
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span>root@node-2 ~<span style=color:#5bc4bf>]</span><span style=color:#776e71># docker exec bbox-3 ping -c 4 10.0.0.2</span>
</span></span><span style=display:flex><span>PING 10.0.0.2 <span style=color:#5bc4bf>(</span>10.0.0.2<span style=color:#5bc4bf>)</span>: <span style=color:#f99b15>56</span> data bytes
</span></span><span style=display:flex><span><span style=color:#f99b15>64</span> bytes from 10.0.0.2: <span style=color:#ef6155>seq</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>0</span> <span style=color:#ef6155>ttl</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>64</span> <span style=color:#ef6155>time</span><span style=color:#5bc4bf>=</span>0.184 ms
</span></span><span style=display:flex><span><span style=color:#f99b15>64</span> bytes from 10.0.0.2: <span style=color:#ef6155>seq</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>1</span> <span style=color:#ef6155>ttl</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>64</span> <span style=color:#ef6155>time</span><span style=color:#5bc4bf>=</span>0.158 ms
</span></span><span style=display:flex><span><span style=color:#f99b15>64</span> bytes from 10.0.0.2: <span style=color:#ef6155>seq</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>2</span> <span style=color:#ef6155>ttl</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>64</span> <span style=color:#ef6155>time</span><span style=color:#5bc4bf>=</span>0.162 ms
</span></span><span style=display:flex><span><span style=color:#f99b15>64</span> bytes from 10.0.0.2: <span style=color:#ef6155>seq</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>3</span> <span style=color:#ef6155>ttl</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>64</span> <span style=color:#ef6155>time</span><span style=color:#5bc4bf>=</span>0.093 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 10.0.0.2 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#f99b15>4</span> packets transmitted, <span style=color:#f99b15>4</span> packets received, 0% packet loss
</span></span><span style=display:flex><span>round-trip min/avg/max <span style=color:#5bc4bf>=</span> 0.093/0.149/0.184 ms
</span></span></code></pre></div><p>docker é»˜è®¤ä¸º overlay ç½‘ç»œåˆ†é… 24 ä½æ©ç çš„å­ç½‘ï¼ˆ10.0.X.0/24ï¼‰ï¼Œæ‰€æœ‰ä¸»æœºå…±äº«è¿™ä¸ª subnetï¼Œå®¹å™¨å¯åŠ¨æ—¶ä¼šé¡ºåºä»æ­¤ç©ºé—´åˆ†é… IPã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ &ndash;subnet æŒ‡å®š IP ç©ºé—´ã€‚</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker network create -d overlay --subnet 10.22.1.0/24 ov_net
</span></span></code></pre></div><p>ä»¥ä¸Š</p></div><div class=post-reward><div style=padding:0;margin:0;width:100%;font-size:16px;text-align:center><div id=QR style=opacity:0><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=https://www.lvbibir.cn/images/blog-wechatpay.png alt=wechat_pay></a><p>å¾®ä¿¡</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=https://www.lvbibir.cn/images/blog-alipay.png alt=alipay></a><p>æ”¯ä»˜å®</p></div></div><button id=rewardButton onclick="var qr=document.getElementById('QR');qr.style.opacity==='0'?qr.style.opacity='1':qr.style.opacity='0'">
<span>ğŸ§§ é¼“åŠ±</span></button></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://www.lvbibir.cn/posts/tech/docker-remote-call-daemon/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>docker | å®ˆæŠ¤è¿›ç¨‹çš„è¿œç¨‹è°ƒç”¨</span></a>
<a class=next href=https://www.lvbibir.cn/posts/tech/docker-commands/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>docker | å¸¸è§å‘½ä»¤</span></a></nav></footer></div><div><div class=pagination__title><span class=pagination__title-h style=font-size:20px>ğŸ’¬è¯„è®º</span><hr></div><div id=tcomment></div><script src=/js/twikoo/1.6.44/twikoo.min.js></script><script>twikoo.init({envId:"https://www.lvbibir.cn/twikoo/",el:"#tcomment",lang:'zh-CN',path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><a href=https://gohugo.io/ target=_blank><img style=display:unset src=/images/blog-hugo.svg></a>
<a href=https://github.com/adityatelange/hugo-PaperMod target=_blank><img style=display:unset src=/images/blog-papermod.svg></a>
<a href=https://cn.aliyun.com/ target=_blank><img style=display:unset src=/images/blog-aliyun.svg></a><br><span id=runtime_span></span>
<script type=text/javascript>function show_runtime(){window.setTimeout("show_runtime()",1e3);var a=new Date("7/13/2021 1:00:00"),r=new Date,c=r.getTime()-a.getTime(),l=24*60*60*1e3,o=c/l,i=Math.floor(o),e=(o-i)*24,t=Math.floor(e),n=(e-t)*60,s=Math.floor(n),d=Math.floor((n-s)*60);document.getElementById("runtime_span").innerHTML="ç½‘ç«™å·²è¿è¡Œ"+i+"å¤©"+t+"å°æ—¶"+s+"åˆ†"+d+"ç§’"}show_runtime()</script>|
<script defer src=https://www.lvbibir.cn/busuanzi/js></script>
<span id=busuanzi_container>æ€»è®¿å®¢æ•°: <span id=busuanzi_site_uv></span>
|
æ€»è®¿é—®é‡: <span id=busuanzi_site_pv></span></span><br><a href=https://beian.miit.gov.cn/ target=_blank style="border-bottom:1px solid">äº¬ICPå¤‡2021023168å·-1</a>&nbsp;
|
<span>Copyright &copy; 2020-2026
<a href=https://www.lvbibir.cn style="border-bottom:1px solid">lvbibir's Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg><span id=read_progress></span></span></a>
<script>document.addEventListener('scroll',function(){const e=document.getElementById("read_progress"),t=document.documentElement.scrollHeight,n=document.documentElement.clientHeight,s=document.documentElement.scrollTop||document.body.scrollTop;e.innerText=((s/(t-n)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>400||document.documentElement.scrollTop>400?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script><script>document.querySelectorAll('pre > code').forEach(s=>{const n=s.parentNode.parentNode,e=document.createElement('button');e.classList.add('copy-code'),e.innerText='ğŸ“„å¤åˆ¶';function l(){e.innerText='ğŸ‘ŒğŸ»å·²å¤åˆ¶!',setTimeout(()=>{e.innerText='ğŸ“„å¤åˆ¶'},2e3)}e.addEventListener('click',n=>{const e=document.createRange();e.selectNodeContents(s);const t=window.getSelection();t.removeAllRanges(),t.addRange(e);try{document.execCommand('copy'),l()}catch(e){}t.removeRange(e)});let c=s.className.replaceAll("language-",""),t=document.createElement("div"),i=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div"),o=document.createElement("div");o.innerText=c,t.setAttribute('class','mac-tool'),i.setAttribute('class','mac bb1'),a.setAttribute('class','mac bb2'),r.setAttribute('class','mac bb3'),o.setAttribute('class','language-type'),t.appendChild(i),t.appendChild(a),t.appendChild(r),t.appendChild(o),n.classList.contains("highlight")?(n.appendChild(e),n.appendChild(t)):n.parentNode.firstChild===n||(s.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName==="TABLE"?(s.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e),n.appendChild(t)):(s.parentNode.appendChild(e),n.appendChild(t)))})</script></body></html>