<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>docker | å®¹å™¨çš„è·¨ä¸»æœºè¿æ¥ | lvbibir's Blog</title><meta name=keywords content="linux,docker,network"><meta name=description content="ä»‹ç»dockerå®¹å™¨åœ¨ä¸åŒå®¿ä¸»æœºä¸‹å®ç°é€šä¿¡çš„å‡ ç§æ–¹æ¡ˆ"><meta name=author content="
ä½œè€…:&nbsp;lvbibir"><link rel=canonical href=https://www.lvbibir.cn/posts/tech/docker-rong-qi-kua-zhu-ji-lian-jie/><link crossorigin=anonymous href=/assets/css/stylesheet.27ec2ab56d27168f4436b50fcf541dd26c35482c551d49559610d6fcbac73a35.css integrity="sha256-J+wqtW0nFo9ENrUPz1Qd0mw1SCxVHUlVlhDW/LrHOjU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.lvbibir.cn/img/avatar.gif><link rel=icon type=image/png sizes=16x16 href=https://www.lvbibir.cn/img/avatar.gif><link rel=icon type=image/png sizes=32x32 href=https://www.lvbibir.cn/img/avatar.gif><link rel=apple-touch-icon href=https://www.lvbibir.cn/img/avatar.gif><link rel=mask-icon href=https://www.lvbibir.cn/img/avatar.gif><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta property="og:title" content="docker | å®¹å™¨çš„è·¨ä¸»æœºè¿æ¥"><meta property="og:description" content="ä»‹ç»dockerå®¹å™¨åœ¨ä¸åŒå®¿ä¸»æœºä¸‹å®ç°é€šä¿¡çš„å‡ ç§æ–¹æ¡ˆ"><meta property="og:type" content="article"><meta property="og:url" content="https://www.lvbibir.cn/posts/tech/docker-rong-qi-kua-zhu-ji-lian-jie/"><meta property="og:image" content="https://image.lvbibir.cn/blog/docker.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-08-01T00:00:00+00:00"><meta property="article:modified_time" content="2019-08-01T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://image.lvbibir.cn/blog/docker.png"><meta name=twitter:title content="docker | å®¹å™¨çš„è·¨ä¸»æœºè¿æ¥"><meta name=twitter:description content="ä»‹ç»dockerå®¹å™¨åœ¨ä¸åŒå®¿ä¸»æœºä¸‹å®ç°é€šä¿¡çš„å‡ ç§æ–¹æ¡ˆ"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"ğŸ“š æ–‡ç« ","item":"https://www.lvbibir.cn/posts/"},{"@type":"ListItem","position":3,"name":"ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯","item":"https://www.lvbibir.cn/posts/tech/"},{"@type":"ListItem","position":4,"name":"docker | å®¹å™¨çš„è·¨ä¸»æœºè¿æ¥","item":"https://www.lvbibir.cn/posts/tech/docker-rong-qi-kua-zhu-ji-lian-jie/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"docker | å®¹å™¨çš„è·¨ä¸»æœºè¿æ¥","name":"docker | å®¹å™¨çš„è·¨ä¸»æœºè¿æ¥","description":"ä»‹ç»dockerå®¹å™¨åœ¨ä¸åŒå®¿ä¸»æœºä¸‹å®ç°é€šä¿¡çš„å‡ ç§æ–¹æ¡ˆ","keywords":["linux","docker","network"],"articleBody":"å®ç°è·¨ä¸»æœºçš„dockerå®¹å™¨ä¹‹é—´çš„é€šè®¯ï¼š\nä½¿ç”¨ç½‘æ¡¥å®ç°è·¨ä¸»æœºçš„è¿æ¥ dockeråŸç”Ÿçš„ç½‘ç»œï¼šoverlayã€macvlan ç¬¬ä¸‰æ–¹ç½‘ç»œï¼šflaanelã€weaveã€calic ç½‘æ¡¥ open vswitch weave macvlan macvlanæ˜¯Linuxæ“ä½œç³»ç»Ÿå†…æ ¸æä¾›çš„ç½‘ç»œè™šæ‹ŸåŒ–æ–¹æ¡ˆä¹‹ä¸€ï¼Œæ›´å‡†ç¡®çš„è¯´æ³•æ˜¯ç½‘å¡è™šæ‹ŸåŒ–æ–¹æ¡ˆã€‚å®ƒå¯ä»¥ä¸ºä¸€å¼ ç‰©ç†ç½‘å¡è®¾ç½®å¤šä¸ªmacåœ°å€ï¼Œç›¸å½“äºç‰©ç†ç½‘å¡æ–½å±•äº†å½±åˆ†èº«ä¹‹æœ¯ï¼Œç”±ä¸€ä¸ªå˜å¤šä¸ªï¼ŒåŒæ—¶è¦æ±‚ç‰©ç†ç½‘å¡æ‰“å¼€æ··æ‚æ¨¡å¼ã€‚é’ˆå¯¹æ¯ä¸ªmacåœ°å€ï¼Œéƒ½å¯ä»¥è®¾ç½®IPåœ°å€ï¼Œæœ¬æ¥æ˜¯ä¸€å—ç‰©ç†ç½‘å¡è¿æ¥åˆ°äº¤æ¢æœºï¼Œç°åœ¨æ˜¯å¤šå—è™šæ‹Ÿç½‘å¡è¿æ¥åˆ°äº¤æ¢æœºã€‚\nå½“å®¹å™¨éœ€è¦ç›´è¿å…¥ç‰©ç†ç½‘ç»œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨Macvlanã€‚Macvlanæœ¬èº«ä¸åˆ›å»ºç½‘ç»œï¼Œæœ¬è´¨ä¸Šé¦–å…ˆä½¿å®¿ä¸»æœºç‰©ç†ç½‘å¡å·¥ä½œåœ¨â€˜æ··æ‚æ¨¡å¼â€™ï¼Œè¿™æ ·ç‰©ç†ç½‘å¡çš„MACåœ°å€å°†ä¼šå¤±æ•ˆï¼Œæ‰€æœ‰äºŒå±‚ç½‘ç»œä¸­çš„æµé‡ç‰©ç†ç½‘å¡éƒ½èƒ½æ”¶åˆ°ã€‚æ¥ä¸‹æ¥å°±æ˜¯åœ¨è¿™å¼ ç‰©ç†ç½‘å¡ä¸Šåˆ›å»ºè™šæ‹Ÿç½‘å¡ï¼Œå¹¶ä¸ºè™šæ‹Ÿç½‘å¡æŒ‡å®šMACåœ°å€ï¼Œå®ç°ä¸€å¡å¤šç”¨ï¼Œåœ¨ç‰©ç†ç½‘ç»œçœ‹æ¥ï¼Œæ¯å¼ è™šæ‹Ÿç½‘å¡éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„æ¥å£ã€‚ä½¿ç”¨Macvlanæœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š\nå®¹å™¨ç›´æ¥è¿æ¥ç‰©ç†ç½‘ç»œï¼Œç”±ç‰©ç†ç½‘ç»œè´Ÿè´£åˆ†é…IPåœ°å€ï¼Œå¯èƒ½çš„ç»“æœæ˜¯ç‰©ç†ç½‘ç»œIPåœ°å€è¢«è€—å°½ï¼Œå¦ä¸€ä¸ªåæœæ˜¯ç½‘ç»œæ€§èƒ½é—®é¢˜ï¼Œç‰©ç†ç½‘ç»œä¸­æ¥å…¥çš„ä¸»æœºå˜å¤šï¼Œå¹¿æ’­åŒ…å æ¯”å¿«é€Ÿå‡é«˜è€Œå¼•èµ·çš„ç½‘ç»œæ€§èƒ½ä¸‹é™é—®é¢˜ã€‚ å‰è¾¹è¯´è¿‡äº†ï¼Œå®¿ä¸»æœºä¸Šçš„æŸå¼ ç½‘ä¸Šéœ€è¦å·¥ä½œåœ¨â€˜æ··ä¹±æ¨¡å¼â€™ä¸‹ã€‚ ä»é•¿è¿œæ¥çœ‹bridgeç½‘ç»œä¸overlayç½‘ç»œæ˜¯æ›´å¥½çš„é€‰æ‹©ï¼ŒåŸå› å°±æ˜¯è™šæ‹Ÿç½‘ç»œåº”è¯¥ä¸ç‰©ç†ç½‘ç»œéš”ç¦»è€Œä¸æ˜¯å…±äº«ã€‚ ä¼˜ç¼ºç‚¹ï¼š\nä¼˜ç‚¹æ˜¯æ€§èƒ½éå¸¸å¥½ ç¼ºç‚¹æ˜¯åœ°å€éœ€è¦æ‰‹åŠ¨åˆ†é… Macvlanç½‘ç»œæœ‰ä¸¤ç§æ¨¡å¼ï¼šbridgeæ¨¡å¼ä¸802.1q trunk bridgeæ¨¡å¼ã€‚\nbridgeæ¨¡å¼ï¼ŒMacvlanç½‘ç»œæµé‡ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºç‰©ç†ç½‘å¡ã€‚ 802.1q trunk bridgeæ¨¡å¼ï¼ŒMacvlanç½‘ç»œæµé‡ä½¿ç”¨DockeråŠ¨æ€åˆ›å»ºçš„802.1qå­æ¥å£ï¼Œå¯¹äºè·¯ç”±ä¸è¿‡è™‘ï¼Œè¿™ç§æ¨¡å¼èƒ½å¤Ÿæä¾›æ›´ç»†ç²’åº¦çš„æ§åˆ¶ ç¯å¢ƒå‡†å¤‡ï¼š\nä¸¤å°centos7 dockerç‰ˆæœ¬ï¼š18.03 ipï¼š192.168.0.53ï¼ˆnode-1ï¼‰ 192.168.0.54ï¼ˆnode-2ï¼‰ node-1 node-2 æ³¨æ„ï¼šnode-1ä½¿ç”¨çš„ç‰©ç†ç½‘å¡æ˜¯ens33ï¼Œnode-2ä½¿ç”¨çš„æ˜¯ens32 [root@node-1 ~]# ip link show ens33 [root@node-1 ~]# ip link set ens32 promisc on #å¼€å¯æ··æ‚æ¨¡å¼ï¼Œä¿è¯å¤šä¸ªipå¯ä»¥é€šè¿‡ [root@node-1 ~]# docker network create -d macvlan --subnet 10.0.0.0/24 --gateway=10.0.0.1 -o parent=ens33 mac_net1 [root@node-1 ~]# docker network ls node-1 docker run -itd --name bbox-1 --ip 10.0.0.11 --network mac_net1 busybox node-2 docker run -itd --name bbox-2 --ip 10.0.0.12 --network mac_net1 busybox node-1 [root@node-1 ~]# docker exec bbox-1 ping 10.0.0.12 [root@node-1 ~]# docker exec bbox-1 ping bbox-2 å¯ä»¥pingé€šipï¼Œä½†æ˜¯æ— æ³•pingé€šä¸»æœºåï¼Œå› ä¸ºå®ƒæ²¡æœ‰dnsè§£æ [root@node-1 ~]# brctl show å› ä¸ºmacvlanä¸ä¾èµ–äºbridgeç½‘ç»œï¼Œæ‰€ä»¥æŸ¥çœ‹ä¸åˆ°æ–°çš„æ¡¥æ¥ç½‘ç»œ [root@node-1 ~]# docker exec bbox-1 ip link æŸ¥çœ‹åˆ°eth0è¿æ¥åˆ°äº†if2 [root@node-1 ~]# ip link show ens33 å¯ä»¥æŸ¥çœ‹åˆ°ens33çš„ç¼–å·æ˜¯2ï¼Œå³bbox-1å®¹å™¨çš„eth0ç½‘å¡è¿æ¥åˆ°äº†ens33ç‰©ç†ç½‘å¡ [root@node-1 ~]# docker network create -d macvlan -o parent=ens33 mac_net2 Error response from daemon: network dm-b34ee1020a96 is already using parent interface ens33 å†åˆ›å»ºmacvlanç½‘ç»œæ—¶å‘ç°å·²ç»æ— æ³•å†åˆ›å»ºï¼Œå³ä¸€å—ç½‘å¡åªèƒ½æ·»åŠ ä¸€ä¸ªmacvlançš„åœ°å€\nä¸€å—ç½‘å¡ç»‘å®šå¤šä¸ªmacvlanåœ°å€ [root@node-1 ~]# modinfo 8021q # æŸ¥çœ‹å†…æ ¸æ˜¯å¦æ”¯æŒ802.1qå°è£… [root@node-1 ~]# modprobe 8021q # å¦‚æœä¸Šæ¡å‘½ä»¤æ‰§è¡Œåæ²¡æœ‰ç»“æœï¼Œä½¿ç”¨è¯¥å‘½ä»¤åŠ è½½è¯¥æ¨¡å— node-1 [root@node-1 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33 BOOTPROTO=manual ä¿®æ”¹ä¸ºä¸éœ€è¦ipçš„manualæ¨¡å¼\nnode-2 [root@node-2 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens32 BOOTPROTO=manual node-1 æ·»åŠ ä¸¤å—è™šæ‹Ÿç½‘å¡ï¼Œæ³¨æ„ä¸å®é™…çš„ens32ç½‘å¡çš„ç½‘æ®µåŒºåˆ†å¼€ ens32ä½¿ç”¨çš„æ˜¯192.168.0.0/24ç½‘æ®µï¼Œè™šæ‹Ÿç½‘å¡ä½¿ç”¨çš„æ˜¯192.168.1.0/24å’Œ192.168.2.0/24\n[root@node-1 ~]# cp -p /etc/sysconfig/network-scripts/ifcfg-ens33 /etc/sysconfig/network-scripts/ifcfg-ens33.10 [root@node-1 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33.10 BOOTPROTO=none NAME=ens33.10 DEVICE=ens33.10 ONBOOT=yes IPADDR=192.168.1.10 PREFIX=24 NETWORK=192.168.1.0 VLAN=yes [root@node-1 ~]# cp -p /etc/sysconfig/network-scripts/ifcfg-ens33.10 /etc/sysconfig/network-scripts/ifcfg-ens33.20 [root@node-1 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33.20 BOOTPROTO=none NAME=ens33.20 DEVICE=ens33.20 ONBOOT=yes IPADDR=192.168.2.10 PREFIX=24 NETWORK=192.168.2.0 VLAN=yes [root@node-1 ~]# ifup ens33.10 [root@node-1 ~]# ifup ens33.20 [root@node-1 ~]# scp /etc/sysconfig/network-scripts/ifcfg-ens33.10 192.168.0.54:/etc/sysconfig/network-scripts/ifcfg-ens32.10 [root@node-1 ~]# scp /etc/sysconfig/network-scripts/ifcfg-ens33.20 192.168.0.54:/etc/sysconfig/network-scripts/ifcfg-ens32.20 node-2 [root@node-2 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens32.10 BOOTPROTO=none NAME=ens32.10 DEVICE=ens32.10 ONBOOT=yes IPADDR=192.168.1.20 PREFIX=24 NETWORK=192.168.1.0 VLAN=yes [root@node-2 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens32.20 BOOTPROTO=none NAME=ens32.20 DEVICE=ens32.20 ONBOOT=yes IPADDR=192.168.2.20 PREFIX=24 NETWORK=192.168.2.0 VLAN=yes [root@node-2 ~]# ifup ens32.10 [root@node-2 ~]# ifup ens32.20 node-1 [root@node-1 ~]# docker network create -d macvlan --subnet 172.16.11.0/24 --gateway 172.16.11.1 -o parent=ens33.10 mac_net11 [root@node-1 ~]# docker network create -d macvlan --subnet 172.16.12.0/24 --gateway 172.16.12.1 -o parent=ens33.20 mac_net12 node-2 [root@node-2 ~]# docker network create -d macvlan --subnet 172.16.11.0/24 --gateway 172.16.11.1 -o parent=ens32.10 mac_net11 [root@node-2 ~]# docker network create -d macvlan --subnet 172.16.12.0/24 --gateway 172.16.12.1 -o parent=ens32.20 mac_net12 node-1 [root@node-2 ~]# docker run -itd --name bbox-11 --ip=172.16.11.11 --network mac_net11 busybox [root@node-2 ~]# docker run -itd --name bbox-12 --ip=172.16.12.11 --network mac_net12 busybox node-2 [root@node-2 ~]# docker run -itd --name bbox-21 --ip=172.16.11.12 --network mac_net11 busybox [root@node-2 ~]# docker run -itd --name bbox-22 --ip=172.16.12.12 --network mac_net12 busybox node-1 [root@node-1 ~]# docker exec bbox-11 ping 172.16.11.12 PING 172.16.11.12 (172.16.11.12): 56 data bytes 64 bytes from 172.16.11.12: seq=0 ttl=64 time=0.867 ms 64 bytes from 172.16.11.12: seq=1 ttl=64 time=1.074 ms 64 bytes from 172.16.11.12: seq=2 ttl=64 time=1.145 ms 64 bytes from 172.16.11.12: seq=3 ttl=64 time=0.938 ms ^C [root@node-1 ~]# docker exec bbox-12 ping 172.16.12.12 PING 172.16.12.12 (172.16.12.12): 56 data bytes 64 bytes from 172.16.12.12: seq=0 ttl=64 time=0.858 ms 64 bytes from 172.16.12.12: seq=1 ttl=64 time=1.140 ms 64 bytes from 172.16.12.12: seq=2 ttl=64 time=0.818 ms 64 bytes from 172.16.12.12: seq=3 ttl=64 time=1.056 ms ^C åœ¨ä¸¤å°ç³»ç»Ÿè¿›è¡Œä¿®æ”¹ï¼Œæ·»åŠ ç½‘å…³ï¼Œä¿®æ”¹é˜²ç«å¢™ç­–ç•¥\nnode-1ä¸­è®°å¾—å°†ens32æ›´æ¢ä¸ºens33\nifconfig ens32.10 172.16.10.1 netmask 255.255.255.0 ifconfig ens32.20 172.16.20.1 netmask 255.255.255.0 iptables -t nat -A POSTROUTING -o ens32.10 -j MASQUERADE iptables -t nat -A POSTROUTING -o ens32 -j MASQUERADE iptables -A FORWARD -i ens32.10 -o ens32 -m state --state RELATE,ESTABLISHED -j ACCEPT iptables -A FORWARD -i ens32 -o ens32.10 -m state --state RELATE,ESTABLISHED -j ACCEPT iptables -A FORWARD -i ens32.10 -o ens32 -j ACCEPT iptables -A FORWARD -i ens32 -o ens32.10 -j ACCEPT overlay ä¸€ã€è·¨ä¸»æœºç½‘ç»œæ¦‚è¿° äºŒã€å‡†å¤‡overlayç¯å¢ƒ ä¸ºæ”¯æŒå®¹å™¨çš„è·¨ä¸»æœºé€šä¿¡ï¼ŒDockeræä¾›äº†overlay driverã€‚Docker overlayç½‘ç»œéœ€è¦ä¸€ä¸ªkey-valueæ•°æ®åº“ç”¨äºä¿å­˜ç½‘ç»œçŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬Networkã€Endpointã€IPç­‰ã€‚Consulã€Etcdå’ŒZooKeeperéƒ½æ˜¯Dockeræ”¯æŒçš„key-valueè½¯ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨Consul\n1. ç¯å¢ƒæè¿°\nèŠ‚ç‚¹ ç³»ç»Ÿç‰ˆæœ¬ dockerç‰ˆæœ¬ è§’è‰² IPåœ°å€ node-1 centos7.4 docker-18.03.0 consul 192.168.0.101 node-2 centos7.4 docker-18.03.0 host 192.168.0.102 node-3 centos7.4 docker-18.03.0 host 192.168.0.103 2. åˆ›å»ºconsul\nnode-1; [root@node-1 ~]# docker run -d -p 8500:8500 -h consul --name consul progrium/consul -server -bootstrap å®¹å™¨å¯åŠ¨åå¯ä»¥é€šè¿‡192.168.0.101:8500è®¿é—®åˆ°consul 3. ä¿®æ”¹dockeré…ç½®æ–‡ä»¶ ä¿®æ”¹node-2å’Œnode-3çš„docker daemonçš„é…ç½®æ–‡ä»¶/etc/systemd/system/docker.service\n[root@node-2 ~]# vim /etc/systemd/system/docker.service ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock --cluster-store=consul://192.168.0.101:8500 --cluster-advertise=ens32:2376 [root@node-2 ~]# systemctl daemon-reload [root@node-2 ~]# systemctl restart docker -H ï¼štcpï¼šå…è®¸tcpè¿æ¥daemon -Hï¼šunixï¼šé»˜è®¤çš„socketè¿æ¥æ–¹å¼ï¼Œæ”¯æŒè¿œç¨‹çš„åŒæ—¶ï¼Œæœ¬åœ°ä¹Ÿå¯ä»¥è¿æ¥ â€“cluster-store æŒ‡å®šconsulçš„åœ°å€ â€“cluster-advertise å‘ŠçŸ¥consulè‡ªå·±çš„è¿æ¥åœ°å€ node-2å’Œnode-3ä¼šè‡ªåŠ¨æ³¨å†Œåˆ°consulæ•°æ®åº“ä¸­ã€‚ ä¸‰ã€åˆ›å»ºoverlayç½‘ç»œ 1ã€åœ¨node-2ä¸­åˆ›å»ºç½‘ç»œ åœ¨node-2ä¸­åˆ›å»ºoverlayç½‘ç»œov_net1\n[root@node-2 ~]# docker network create -d overlay ov_net1 -d overlayï¼šæŒ‡å®šdriverä¸ºoverlay [root@node-2 ~]# docker network ls 2ã€node-3æŸ¥çœ‹åˆ›å»ºçš„ç½‘ç»œ æ³¨æ„åˆ°ov_net1çš„ SCOPE ä¸º globalï¼Œè€Œå…¶ä»–ç½‘ç»œä¸º local ã€‚åœ¨node-3ä¸ŠæŸ¥çœ‹å­˜åœ¨çš„ç½‘ç»œ:\n[root@node-3 ~]# docker network ls node-3ä¸Šä¹Ÿèƒ½çœ‹åˆ°ov_net1ï¼Œåªæ˜¯å› ä¸ºåˆ›å»ºov_net1æ—¶å°†overlayç½‘ç»œä¿¡æ¯å­˜å…¥äº†consulï¼Œnode-3ä»consulè¯»å–åˆ°äº†æ–°ç½‘ç»œæ•°æ®ã€‚ä¹‹åov_net1çš„ä»»ä½•å˜åŒ–éƒ½ä¼šåŒæ­¥åˆ°node-2å’Œnode-3. 3ã€æŸ¥çœ‹ov_net1è¯¦ç»†ä¿¡æ¯\n[root@node-2 ~]# docker network inspect ov_net1 IPAM æ˜¯æŒ‡ IP Address Managementï¼Œdockerè‡ªåŠ¨ä¸º ov_net1 åˆ†é…çš„ IP ç©ºé—´ä¸º 10.0.0.0/24 å››ã€åœ¨overlayä¸­è¿è¡Œå®¹å™¨ 1ã€åˆ›å»ºå®¹å™¨ bbox-1 åœ¨ node-2 ä¸Šè¿è¡Œä¸€ä¸ª busybox å®¹å™¨å¹¶è¿æ¥åˆ° ov_net1.\n[root@node-2 ~]# docker run -itd --name bbox-1 --network ov_net1 busybox 2ã€æŸ¥çœ‹ bbox-1 ç½‘ç»œé…ç½®\n[root@node-2 ~]# docker exec bbox-1 ip r default via 172.18.0.1 dev eth1 10.0.0.0/24 dev eth0 scope link src 10.0.0.2 172.18.0.0/16 dev eth1 scope link src 172.18.0.2 bbox-1 æœ‰ä¸¤ä¸ªç½‘ç»œæ¥å£ï¼Œeth0 å’Œ eth1 eth0 IP ä¸º 10.0.0.2ï¼Œè¿æ¥çš„æ˜¯overlayç½‘ç»œ ov_net1 eth1 IP ä¸º 172.18.0.2 å®¹å™¨çš„é»˜è®¤è·¯ç”±æ˜¯èµ° eth1ï¼Œå…¶å®ï¼Œdocker ä¼šåˆ›å»ºä¸€ä¸ª bridge ç½‘ç»œ â€œdocker_gwbridgeâ€ï¼Œä¸ºæ‰€æœ‰è¿æ¥åˆ° overlay ç½‘ç»œçš„å®¹å™¨æä¾›è®¿é—®å¤–ç½‘çš„èƒ½åŠ› [root@node-2 ~]# docker network ls [root@node-2 ~]# docker network inspect docker_gwbridge ä» docker network inspect docker_gwbridge è¾“å‡ºå¯ç¡®è®¤ docker_gwbridge çš„ IP åœ°å€èŒƒå›´æ˜¯ 172.18.0.0/16ï¼Œå½“å‰è¿æ¥çš„å®¹å™¨å°±æ˜¯ bbox-1ï¼ˆ172.18.0.2ï¼‰ è€Œä¸”æ­¤ç½‘ç»œçš„ç½‘å…³å°±æ˜¯ç½‘æ¡¥ docker_gwbridge çš„ IP 172.18.0.1\n[root@node-2 ~]# ifconfig docker_gwbridge docker_gwbridge: flags=4163 mtu 1500 inet 172.18.0.1 netmask 255.255.0.0 broadcast 172.18.255.255 inet6 fe80::42:c5ff:fe45:937 prefixlen 64 scopeid 0x20 ether 02:42:c5:45:09:37 txqueuelen 0 (Ethernet) RX packets 0 bytes 0 (0.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 0 bytes 0 (0.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 è¿™æ ·å®¹å™¨ bbox-1 å°±å¯ä»¥é€šè¿‡docker_gwbridge è®¿é—®å¤–ç½‘\n[root@node-2 ~]# docker exec bbox-1 ping -c 4 www.baidu.com PING www.baidu.com (182.61.200.6): 56 data bytes 64 bytes from 182.61.200.6: seq=0 ttl=53 time=6.721 ms 64 bytes from 182.61.200.6: seq=1 ttl=53 time=7.954 ms 64 bytes from 182.61.200.6: seq=2 ttl=53 time=11.723 ms 64 bytes from 182.61.200.6: seq=3 ttl=53 time=15.105 ms --- www.baidu.com ping statistics --- 4 packets transmitted, 4 packets received, 0% packet loss round-trip min/avg/max = 6.721/10.375/15.105 ms äº”ã€overlayç½‘ç»œè¿é€šæ€§ 1ã€node-3 ä¸­ è¿è¡Œ bbox-2\n[root@node-3 ~]# docker run -itd --name bbox-2 --network ov_net1 busybox 2ã€æŸ¥çœ‹ bbox-2 è·¯ç”±æƒ…å†µ\n[root@node-3 ~]# docker exec bbox-2 ip r default via 172.18.0.1 dev eth1 10.0.0.0/24 dev eth0 scope link src 10.0.0.3 172.18.0.0/16 dev eth1 scope link src 172.18.0.2 3ã€äº’é€šæµ‹è¯•\n[root@node-3 ~]# docker exec bbox-2 ping -c 4 10.0.0.2 PING 10.0.0.2 (10.0.0.2): 56 data bytes 64 bytes from 10.0.0.2: seq=0 ttl=64 time=2.628 ms 64 bytes from 10.0.0.2: seq=1 ttl=64 time=1.004 ms 64 bytes from 10.0.0.2: seq=2 ttl=64 time=1.277 ms 64 bytes from 10.0.0.2: seq=3 ttl=64 time=1.505 ms --- 10.0.0.2 ping statistics --- 4 packets transmitted, 4 packets received, 0% packet loss round-trip min/avg/max = 1.004/1.603/2.628 ms å¯è§ overlay ç½‘ç»œä¸­çš„å®¹å™¨å¯ä»¥ç›´æ¥é€šä¿¡ï¼ŒåŒæ—¶dockerä¹Ÿå®ç°äº†DNSæœåŠ¡ 4ã€å®ç°åŸç† docker ä¼šä¸ºæ¯ä¸ª overlay ç½‘ç»œåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ network namespaceï¼Œå…¶ä¸­ä¼šæœ‰ä¸€ä¸ª linux bridge br0ï¼Œ veth pair ä¸€ç«¯è¿æ¥åˆ°å®¹å™¨ä¸­ï¼ˆå³ eth0ï¼‰ï¼Œå¦ä¸€ç«¯è¿æ¥åˆ° namespace çš„ br0 ä¸Šã€‚ br0 é™¤äº†è¿æ¥æ‰€æœ‰çš„ veth pairï¼Œè¿˜ä¼šè¿æ¥ä¸€ä¸ª vxlan è®¾å¤‡ï¼Œç”¨äºä¸å…¶ä»– host å»ºç«‹ vxlan tunnelã€‚å®¹å™¨ä¹‹é—´çš„æ•°æ®å°±æ˜¯é€šè¿‡è¿™ä¸ª tunnel é€šä¿¡çš„ã€‚é€»è¾‘ç½‘ç»œæ‹“æ‰‘ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼š [root@node-2 ~]# brctl show bridge name bridge id STP enabled interfaces docker0 8000.024217edc413 no docker_gwbridge 8000.0242c5450937 no vethc59120e virbr0 8000.525400b76fd4 yes virbr0-nic [root@node-3 ~]# brctl show bridge name bridge id STP enabled interfaces docker0 8000.0242ef3c7df7 no docker_gwbridge 8000.0242c81afaee no vethf4562a9 virbr0 8000.525400c28478 yes virbr0-nic è¦æŸ¥çœ‹ overlay ç½‘ç»œçš„ namespace å¯ä»¥åœ¨ node-2 å’Œ node-3 ä¸Šæ‰§è¡Œ ip netnsï¼ˆè¯·ç¡®ä¿åœ¨æ­¤ä¹‹å‰æ‰§è¡Œè¿‡ ln -s /var/run/docker/netns /var/run/netnsï¼‰ï¼Œå¯ä»¥çœ‹åˆ°ä¸¤ä¸ª node ä¸Šæœ‰ä¸€ä¸ªç›¸åŒçš„ namespace â€œ1-dd91de7599â€\n[root@node-2 ~]# ln -s /var/run/docker/netns /var/run/netns [root@node-2 ~]# ip netns 6889f61efc4b (id: 1) 1-dd91de7599 (id: 0) [root@node-3 ~]# ln -s /var/run/docker/netns /var/run/netns [root@node-3 ~]# ip netns 8e4722847745 (id: 1) 1-dd91de7599 (id: 0) â€œ1-dd91de7599â€ è¿™å°±æ˜¯ ov_net1 çš„ namespaceï¼ŒæŸ¥çœ‹ namespace ä¸­çš„ br0 ä¸Šçš„è®¾å¤‡\n[root@node-2 ~]# ip netns exec 1-dd91de7599 brctl show bridge name bridge id STP enabled interfaces br0 8000.0e7576c7c035 no veth0 vxlan0 å…­ã€overlayç½‘ç»œéš”ç¦» ä¸åŒçš„ overlay ç½‘ç»œæ˜¯ç›¸äº’éš”ç¦»çš„ã€‚æˆ‘ä»¬åˆ›å»ºç¬¬äºŒä¸ª overlay ç½‘ç»œ ov_net2 å¹¶è¿è¡Œå®¹å™¨ bbox-3 1ã€åˆ›å»ºç½‘ç»œ ov_net2\n[root@node-2 ~]# docker network create -d overlay ov_net2 2ã€å¯åŠ¨å®¹å™¨ bbox-3\n[root@node-2 ~]# docker run -itd --name bbox-3 --network ov_net2 busybox 3ã€æŸ¥çœ‹ bbox-3 ç½‘ç»œ bbox-3 åˆ†é…åˆ°çš„ IP æ˜¯ 10.0.1.2ï¼Œå°è¯• ping bbox-1ï¼ˆ10.0.0.2ï¼‰\n[root@node-2 ~]# docker exec -it bbox-3 ip r default via 172.18.0.1 dev eth1 10.0.1.0/24 dev eth0 scope link src 10.0.1.2 172.18.0.0/16 dev eth1 scope link src 172.18.0.3 [root@node-2 ~]# docker exec -it bbox-3 ping -c 4 10.0.0.2 PING 10.0.0.2 (10.0.0.2): 56 data bytes --- 10.0.0.2 ping statistics --- 4 packets transmitted, 0 packets received, 100% packet loss [root@node-2 ~]# docker exec -it bbox-3 ping -c 4 172.18.0.2 PING 172.18.0.2 (172.18.0.2): 56 data bytes --- 172.18.0.2 ping statistics --- 4 packets transmitted, 0 packets received, 100% packet loss ping å¤±è´¥ï¼Œå¯è§ä¸åŒ overlay ç½‘ç»œä¹‹é—´æ˜¯éš”ç¦»çš„ï¼Œå³ä½¿é€šè¿‡ docker_gwbridge ä¹Ÿä¸èƒ½é€šä¿¡ å¦‚æœè¦å®ç° bbox-3 å’Œ bbox-1 é€šä¿¡ï¼Œå¯ä»¥å°† bbox-3 ä¹Ÿè¿æ¥åˆ° ov_net1 è¿™æ—¶ bbox-3 åŒæ—¶è¿æ¥åˆ°äº† ov_net1 å’Œ ov_net2 ä¸Š\n[root@node-2 ~]# docker network connect ov_net1 bbox-3 [root@node-2 ~]# docker exec bbox-3 ip r default via 172.18.0.1 dev eth1 10.0.0.0/24 dev eth2 scope link src 10.0.0.4 10.0.1.0/24 dev eth0 scope link src 10.0.1.2 172.18.0.0/16 dev eth1 scope link src 172.18.0.3 [root@node-2 ~]# docker exec bbox-3 ping -c 4 10.0.0.2 PING 10.0.0.2 (10.0.0.2): 56 data bytes 64 bytes from 10.0.0.2: seq=0 ttl=64 time=0.184 ms 64 bytes from 10.0.0.2: seq=1 ttl=64 time=0.158 ms 64 bytes from 10.0.0.2: seq=2 ttl=64 time=0.162 ms 64 bytes from 10.0.0.2: seq=3 ttl=64 time=0.093 ms --- 10.0.0.2 ping statistics --- 4 packets transmitted, 4 packets received, 0% packet loss round-trip min/avg/max = 0.093/0.149/0.184 ms docker é»˜è®¤ä¸º overlay ç½‘ç»œåˆ†é… 24 ä½æ©ç çš„å­ç½‘ï¼ˆ10.0.X.0/24ï¼‰ï¼Œæ‰€æœ‰ä¸»æœºå…±äº«è¿™ä¸ª subnetï¼Œå®¹å™¨å¯åŠ¨æ—¶ä¼šé¡ºåºä»æ­¤ç©ºé—´åˆ†é… IPã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ â€“subnet æŒ‡å®š IP ç©ºé—´ã€‚\ndocker network create -d overlay --subnet 10.22.1.0/24 ov_net ","wordCount":"3979","inLanguage":"en","image":"https://image.lvbibir.cn/blog/docker.png","datePublished":"2019-08-01T00:00:00Z","dateModified":"2019-08-01T00:00:00Z","author":{"@type":"Person","name":"lvbibir"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.lvbibir.cn/posts/tech/docker-rong-qi-kua-zhu-ji-lian-jie/"},"publisher":{"@type":"Organization","name":"lvbibir's Blog","logo":{"@type":"ImageObject","url":"https://www.lvbibir.cn/img/avatar.gif"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.lvbibir.cn accesskey=h title="lvbibir's Blog (Alt + H)"><img src=https://www.lvbibir.cn/img/avatar.gif alt aria-label=logo height=35>lvbibir's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li class=menu-item><a href=https://www.lvbibir.cn/search title="ğŸ” æœç´¢ (Alt + /)" accesskey=/><span>ğŸ” æœç´¢</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/ title="ğŸ¡ ä¸»é¡µ"><span>ğŸ¡ ä¸»é¡µ</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/posts title="ğŸ“š æ–‡ç« "><span>ğŸ“š æ–‡ç« </span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/tags title="ğŸ·ï¸ æ ‡ç­¾"><span>ğŸ·ï¸ æ ‡ç­¾</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/archives title="ğŸ“ˆ å½’æ¡£"><span>ğŸ“ˆ å½’æ¡£</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/links title="ğŸ¤ å‹é“¾"><span>ğŸ¤ å‹é“¾</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/about title="ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº"><span>ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº</span></a></li></ul></nav></header><main class="main page"><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://www.lvbibir.cn>ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://www.lvbibir.cn/posts/>ğŸ“š æ–‡ç« </a>&nbsp;Â»&nbsp;<a href=https://www.lvbibir.cn/posts/tech/>ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a></div><h1 class=post-title>docker | å®¹å™¨çš„è·¨ä¸»æœºè¿æ¥</h1><div class=post-description>ä»‹ç»dockerå®¹å™¨åœ¨ä¸åŒå®¿ä¸»æœºä¸‹å®ç°é€šä¿¡çš„å‡ ç§æ–¹æ¡ˆ</div><div class=post-meta>åˆ›å»º:&nbsp;<span title='2019-08-01 00:00:00 +0000 UTC'>2019-08-01</span>&nbsp;|&nbsp;æ›´æ–°:&nbsp;2019-08-01&nbsp;|&nbsp;å­—æ•°:&nbsp;3979å­—&nbsp;|&nbsp;æ—¶é•¿:&nbsp;8åˆ†é’Ÿ&nbsp;|&nbsp;
ä½œè€…:&nbsp;lvbibir
&nbsp;|&nbsp;æ ‡ç­¾: &nbsp;<ul class=post-tags-meta><a href=https://www.lvbibir.cn/tags/docker/>docker</a></ul><span id=busuanzi_container_page_pv>&nbsp;| è®¿é—®: <span id=busuanzi_value_page_pv></span></span></div></header><figure class=entry-cover1><img loading=lazy src=https://image.lvbibir.cn/blog/docker.png alt></figure><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>æ–‡ç« ç›®å½•</span></summary><div class=inner><ul><li><a href=#%e7%bd%91%e6%a1%a5 aria-label=ç½‘æ¡¥>ç½‘æ¡¥</a></li><li><a href=#open-vswitch aria-label="open vswitch">open vswitch</a></li><li><a href=#weave aria-label=weave>weave</a></li><li><a href=#macvlan aria-label=macvlan>macvlan</a><ul><li><a href=#%e4%b8%80%e5%9d%97%e7%bd%91%e5%8d%a1%e7%bb%91%e5%ae%9a%e5%a4%9a%e4%b8%aamacvlan%e5%9c%b0%e5%9d%80 aria-label=ä¸€å—ç½‘å¡ç»‘å®šå¤šä¸ªmacvlanåœ°å€>ä¸€å—ç½‘å¡ç»‘å®šå¤šä¸ªmacvlanåœ°å€</a></li></ul></li><li><a href=#overlay aria-label=overlay>overlay</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>å®ç°è·¨ä¸»æœºçš„dockerå®¹å™¨ä¹‹é—´çš„é€šè®¯ï¼š</p><ol><li>ä½¿ç”¨ç½‘æ¡¥å®ç°è·¨ä¸»æœºçš„è¿æ¥</li><li>dockeråŸç”Ÿçš„ç½‘ç»œï¼šoverlayã€macvlan</li><li>ç¬¬ä¸‰æ–¹ç½‘ç»œï¼šflaanelã€weaveã€calic</li></ol><h1 id=ç½‘æ¡¥>ç½‘æ¡¥<a hidden class=anchor aria-hidden=true href=#ç½‘æ¡¥>#</a></h1><p><img loading=lazy src=https://image.lvbibir.cn/blog/20190815125207352.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></p><h1 id=open-vswitch>open vswitch<a hidden class=anchor aria-hidden=true href=#open-vswitch>#</a></h1><h1 id=weave>weave<a hidden class=anchor aria-hidden=true href=#weave>#</a></h1><h1 id=macvlan>macvlan<a hidden class=anchor aria-hidden=true href=#macvlan>#</a></h1><p>macvlanæ˜¯Linuxæ“ä½œç³»ç»Ÿå†…æ ¸æä¾›çš„ç½‘ç»œè™šæ‹ŸåŒ–æ–¹æ¡ˆä¹‹ä¸€ï¼Œæ›´å‡†ç¡®çš„è¯´æ³•æ˜¯ç½‘å¡è™šæ‹ŸåŒ–æ–¹æ¡ˆã€‚å®ƒå¯ä»¥ä¸ºä¸€å¼ ç‰©ç†ç½‘å¡è®¾ç½®å¤šä¸ªmacåœ°å€ï¼Œç›¸å½“äºç‰©ç†ç½‘å¡æ–½å±•äº†å½±åˆ†èº«ä¹‹æœ¯ï¼Œç”±ä¸€ä¸ªå˜å¤šä¸ªï¼ŒåŒæ—¶è¦æ±‚ç‰©ç†ç½‘å¡æ‰“å¼€æ··æ‚æ¨¡å¼ã€‚é’ˆå¯¹æ¯ä¸ªmacåœ°å€ï¼Œéƒ½å¯ä»¥è®¾ç½®IPåœ°å€ï¼Œæœ¬æ¥æ˜¯ä¸€å—ç‰©ç†ç½‘å¡è¿æ¥åˆ°äº¤æ¢æœºï¼Œç°åœ¨æ˜¯å¤šå—è™šæ‹Ÿç½‘å¡è¿æ¥åˆ°äº¤æ¢æœºã€‚</p><p>å½“å®¹å™¨éœ€è¦ç›´è¿å…¥ç‰©ç†ç½‘ç»œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨Macvlanã€‚Macvlanæœ¬èº«ä¸åˆ›å»ºç½‘ç»œï¼Œæœ¬è´¨ä¸Šé¦–å…ˆä½¿å®¿ä¸»æœºç‰©ç†ç½‘å¡å·¥ä½œåœ¨â€˜æ··æ‚æ¨¡å¼â€™ï¼Œè¿™æ ·ç‰©ç†ç½‘å¡çš„MACåœ°å€å°†ä¼šå¤±æ•ˆï¼Œæ‰€æœ‰äºŒå±‚ç½‘ç»œä¸­çš„æµé‡ç‰©ç†ç½‘å¡éƒ½èƒ½æ”¶åˆ°ã€‚æ¥ä¸‹æ¥å°±æ˜¯åœ¨è¿™å¼ ç‰©ç†ç½‘å¡ä¸Šåˆ›å»ºè™šæ‹Ÿç½‘å¡ï¼Œå¹¶ä¸ºè™šæ‹Ÿç½‘å¡æŒ‡å®šMACåœ°å€ï¼Œå®ç°ä¸€å¡å¤šç”¨ï¼Œåœ¨ç‰©ç†ç½‘ç»œçœ‹æ¥ï¼Œæ¯å¼ è™šæ‹Ÿç½‘å¡éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„æ¥å£ã€‚ä½¿ç”¨Macvlanæœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š</p><ul><li>å®¹å™¨ç›´æ¥è¿æ¥ç‰©ç†ç½‘ç»œï¼Œç”±ç‰©ç†ç½‘ç»œè´Ÿè´£åˆ†é…IPåœ°å€ï¼Œå¯èƒ½çš„ç»“æœæ˜¯ç‰©ç†ç½‘ç»œIPåœ°å€è¢«è€—å°½ï¼Œå¦ä¸€ä¸ªåæœæ˜¯ç½‘ç»œæ€§èƒ½é—®é¢˜ï¼Œç‰©ç†ç½‘ç»œä¸­æ¥å…¥çš„ä¸»æœºå˜å¤šï¼Œå¹¿æ’­åŒ…å æ¯”å¿«é€Ÿå‡é«˜è€Œå¼•èµ·çš„ç½‘ç»œæ€§èƒ½ä¸‹é™é—®é¢˜ã€‚</li><li>å‰è¾¹è¯´è¿‡äº†ï¼Œå®¿ä¸»æœºä¸Šçš„æŸå¼ ç½‘ä¸Šéœ€è¦å·¥ä½œåœ¨â€˜æ··ä¹±æ¨¡å¼â€™ä¸‹ã€‚</li><li>ä»é•¿è¿œæ¥çœ‹bridgeç½‘ç»œä¸overlayç½‘ç»œæ˜¯æ›´å¥½çš„é€‰æ‹©ï¼ŒåŸå› å°±æ˜¯è™šæ‹Ÿç½‘ç»œåº”è¯¥ä¸ç‰©ç†ç½‘ç»œéš”ç¦»è€Œä¸æ˜¯å…±äº«ã€‚</li></ul><p>ä¼˜ç¼ºç‚¹ï¼š</p><ul><li>ä¼˜ç‚¹æ˜¯æ€§èƒ½éå¸¸å¥½</li><li>ç¼ºç‚¹æ˜¯åœ°å€éœ€è¦æ‰‹åŠ¨åˆ†é…</li></ul><p>Macvlanç½‘ç»œæœ‰ä¸¤ç§æ¨¡å¼ï¼šbridgeæ¨¡å¼ä¸802.1q trunk bridgeæ¨¡å¼ã€‚</p><ul><li>bridgeæ¨¡å¼ï¼ŒMacvlanç½‘ç»œæµé‡ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºç‰©ç†ç½‘å¡ã€‚</li><li>802.1q trunk bridgeæ¨¡å¼ï¼ŒMacvlanç½‘ç»œæµé‡ä½¿ç”¨DockeråŠ¨æ€åˆ›å»ºçš„802.1qå­æ¥å£ï¼Œå¯¹äºè·¯ç”±ä¸è¿‡è™‘ï¼Œè¿™ç§æ¨¡å¼èƒ½å¤Ÿæä¾›æ›´ç»†ç²’åº¦çš„æ§åˆ¶</li></ul><hr><p>ç¯å¢ƒå‡†å¤‡ï¼š</p><ol><li>ä¸¤å°centos7</li><li>dockerç‰ˆæœ¬ï¼š18.03</li><li>ipï¼š192.168.0.53ï¼ˆnode-1ï¼‰ 192.168.0.54ï¼ˆnode-2ï¼‰</li></ol><ul><li>node-1 node-2</li><li>æ³¨æ„ï¼šnode-1ä½¿ç”¨çš„ç‰©ç†ç½‘å¡æ˜¯ens33ï¼Œnode-2ä½¿ç”¨çš„æ˜¯ens32</li></ul><pre tabindex=0><code>[root@node-1 ~]# ip link show ens33
[root@node-1 ~]# ip link set ens32 promisc on
#å¼€å¯æ··æ‚æ¨¡å¼ï¼Œä¿è¯å¤šä¸ªipå¯ä»¥é€šè¿‡
[root@node-1 ~]# docker network create -d macvlan --subnet 10.0.0.0/24 --gateway=10.0.0.1 -o parent=ens33 mac_net1
[root@node-1 ~]# docker network ls
</code></pre><p><img loading=lazy src=https://image.lvbibir.cn/blog/20190818182057577.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></p><ul><li>node-1</li></ul><pre tabindex=0><code>docker run -itd --name bbox-1 --ip 10.0.0.11 --network mac_net1 busybox
</code></pre><ul><li>node-2</li></ul><pre tabindex=0><code>docker run -itd --name bbox-2 --ip 10.0.0.12 --network mac_net1 busybox
</code></pre><ul><li>node-1</li></ul><pre tabindex=0><code>[root@node-1 ~]# docker exec bbox-1 ping 10.0.0.12
[root@node-1 ~]# docker exec bbox-1 ping bbox-2
</code></pre><p>å¯ä»¥pingé€šipï¼Œä½†æ˜¯æ— æ³•pingé€šä¸»æœºåï¼Œå› ä¸ºå®ƒæ²¡æœ‰dnsè§£æ
<img loading=lazy src=https://image.lvbibir.cn/blog/20190818182937702.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></p><pre tabindex=0><code>[root@node-1 ~]# brctl show
</code></pre><p>å› ä¸ºmacvlanä¸ä¾èµ–äºbridgeç½‘ç»œï¼Œæ‰€ä»¥æŸ¥çœ‹ä¸åˆ°æ–°çš„æ¡¥æ¥ç½‘ç»œ
<img loading=lazy src=https://image.lvbibir.cn/blog/20190818183048914.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></p><pre><code>[root@node-1 ~]# docker exec bbox-1  ip link
</code></pre><p>æŸ¥çœ‹åˆ°eth0è¿æ¥åˆ°äº†if2
<img loading=lazy src=https://image.lvbibir.cn/blog/20190818183317728.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></p><pre><code>[root@node-1 ~]# ip link show ens33
</code></pre><p>å¯ä»¥æŸ¥çœ‹åˆ°ens33çš„ç¼–å·æ˜¯2ï¼Œå³bbox-1å®¹å™¨çš„eth0ç½‘å¡è¿æ¥åˆ°äº†ens33ç‰©ç†ç½‘å¡
<img loading=lazy src=https://image.lvbibir.cn/blog/20190818183502889.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></p><pre tabindex=0><code>[root@node-1 ~]# docker network create  -d macvlan -o parent=ens33 mac_net2
Error response from daemon: network dm-b34ee1020a96 is already using parent interface ens33
</code></pre><p>å†åˆ›å»ºmacvlanç½‘ç»œæ—¶å‘ç°å·²ç»æ— æ³•å†åˆ›å»ºï¼Œå³ä¸€å—ç½‘å¡åªèƒ½æ·»åŠ ä¸€ä¸ªmacvlançš„åœ°å€</p><h2 id=ä¸€å—ç½‘å¡ç»‘å®šå¤šä¸ªmacvlanåœ°å€>ä¸€å—ç½‘å¡ç»‘å®šå¤šä¸ªmacvlanåœ°å€<a hidden class=anchor aria-hidden=true href=#ä¸€å—ç½‘å¡ç»‘å®šå¤šä¸ªmacvlanåœ°å€>#</a></h2><pre tabindex=0><code>[root@node-1 ~]# modinfo 8021q
# æŸ¥çœ‹å†…æ ¸æ˜¯å¦æ”¯æŒ802.1qå°è£…
[root@node-1 ~]# modprobe 8021q
# å¦‚æœä¸Šæ¡å‘½ä»¤æ‰§è¡Œåæ²¡æœ‰ç»“æœï¼Œä½¿ç”¨è¯¥å‘½ä»¤åŠ è½½è¯¥æ¨¡å—
</code></pre><ul><li>node-1</li></ul><pre tabindex=0><code>[root@node-1 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33
BOOTPROTO=manual
</code></pre><p>ä¿®æ”¹ä¸ºä¸éœ€è¦ipçš„manualæ¨¡å¼</p><ul><li>node-2</li></ul><pre tabindex=0><code>[root@node-2 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens32
BOOTPROTO=manual
</code></pre><ul><li>node-1</li></ul><p>æ·»åŠ ä¸¤å—è™šæ‹Ÿç½‘å¡ï¼Œæ³¨æ„ä¸å®é™…çš„ens32ç½‘å¡çš„ç½‘æ®µåŒºåˆ†å¼€
ens32ä½¿ç”¨çš„æ˜¯192.168.0.0/24ç½‘æ®µï¼Œè™šæ‹Ÿç½‘å¡ä½¿ç”¨çš„æ˜¯192.168.1.0/24å’Œ192.168.2.0/24</p><pre tabindex=0><code>[root@node-1 ~]# cp -p /etc/sysconfig/network-scripts/ifcfg-ens33 /etc/sysconfig/network-scripts/ifcfg-ens33.10
[root@node-1 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33.10
BOOTPROTO=none
NAME=ens33.10
DEVICE=ens33.10
ONBOOT=yes
IPADDR=192.168.1.10
PREFIX=24
NETWORK=192.168.1.0
VLAN=yes
[root@node-1 ~]# cp -p /etc/sysconfig/network-scripts/ifcfg-ens33.10 /etc/sysconfig/network-scripts/ifcfg-ens33.20
[root@node-1 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33.20
BOOTPROTO=none
NAME=ens33.20
DEVICE=ens33.20
ONBOOT=yes
IPADDR=192.168.2.10
PREFIX=24
NETWORK=192.168.2.0
VLAN=yes
[root@node-1 ~]# ifup ens33.10
[root@node-1 ~]# ifup ens33.20
[root@node-1 ~]# scp /etc/sysconfig/network-scripts/ifcfg-ens33.10 192.168.0.54:/etc/sysconfig/network-scripts/ifcfg-ens32.10
[root@node-1 ~]# scp /etc/sysconfig/network-scripts/ifcfg-ens33.20 192.168.0.54:/etc/sysconfig/network-scripts/ifcfg-ens32.20
</code></pre><ul><li>node-2</li></ul><pre tabindex=0><code>[root@node-2 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens32.10
BOOTPROTO=none
NAME=ens32.10
DEVICE=ens32.10
ONBOOT=yes
IPADDR=192.168.1.20
PREFIX=24
NETWORK=192.168.1.0
VLAN=yes
[root@node-2 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens32.20
BOOTPROTO=none
NAME=ens32.20
DEVICE=ens32.20
ONBOOT=yes
IPADDR=192.168.2.20
PREFIX=24
NETWORK=192.168.2.0
VLAN=yes
[root@node-2 ~]# ifup ens32.10
[root@node-2 ~]# ifup ens32.20
</code></pre><ul><li>node-1</li></ul><pre tabindex=0><code>[root@node-1 ~]# docker network create -d macvlan --subnet 172.16.11.0/24 --gateway 172.16.11.1 -o parent=ens33.10 mac_net11
[root@node-1 ~]# docker network create -d macvlan --subnet 172.16.12.0/24 --gateway 172.16.12.1 -o parent=ens33.20 mac_net12
</code></pre><ul><li>node-2</li></ul><pre tabindex=0><code>[root@node-2 ~]# docker network create -d macvlan --subnet 172.16.11.0/24 --gateway 172.16.11.1 -o parent=ens32.10 mac_net11
[root@node-2 ~]# docker network create -d macvlan --subnet 172.16.12.0/24 --gateway 172.16.12.1 -o parent=ens32.20 mac_net12
</code></pre><ul><li>node-1</li></ul><pre tabindex=0><code>[root@node-2 ~]# docker run -itd --name bbox-11 --ip=172.16.11.11 --network mac_net11 busybox
[root@node-2 ~]# docker run -itd --name bbox-12 --ip=172.16.12.11 --network mac_net12 busybox
</code></pre><ul><li>node-2</li></ul><pre tabindex=0><code>[root@node-2 ~]# docker run -itd --name bbox-21 --ip=172.16.11.12 --network mac_net11 busybox
[root@node-2 ~]# docker run -itd --name bbox-22 --ip=172.16.12.12 --network mac_net12 busybox
</code></pre><ul><li>node-1</li></ul><pre tabindex=0><code>[root@node-1 ~]# docker exec bbox-11 ping 172.16.11.12
PING 172.16.11.12 (172.16.11.12): 56 data bytes
64 bytes from 172.16.11.12: seq=0 ttl=64 time=0.867 ms
64 bytes from 172.16.11.12: seq=1 ttl=64 time=1.074 ms
64 bytes from 172.16.11.12: seq=2 ttl=64 time=1.145 ms
64 bytes from 172.16.11.12: seq=3 ttl=64 time=0.938 ms
^C
[root@node-1 ~]# docker exec bbox-12 ping 172.16.12.12
PING 172.16.12.12 (172.16.12.12): 56 data bytes
64 bytes from 172.16.12.12: seq=0 ttl=64 time=0.858 ms
64 bytes from 172.16.12.12: seq=1 ttl=64 time=1.140 ms
64 bytes from 172.16.12.12: seq=2 ttl=64 time=0.818 ms
64 bytes from 172.16.12.12: seq=3 ttl=64 time=1.056 ms
^C
</code></pre><ul><li><p>åœ¨ä¸¤å°ç³»ç»Ÿè¿›è¡Œä¿®æ”¹ï¼Œæ·»åŠ ç½‘å…³ï¼Œä¿®æ”¹é˜²ç«å¢™ç­–ç•¥</p></li><li><p>node-1ä¸­è®°å¾—å°†ens32æ›´æ¢ä¸ºens33</p><pre><code> ifconfig ens32.10 172.16.10.1 netmask 255.255.255.0
  ifconfig ens32.20 172.16.20.1 netmask 255.255.255.0
  iptables -t nat -A POSTROUTING -o ens32.10 -j MASQUERADE
  iptables -t nat -A POSTROUTING -o ens32 -j MASQUERADE

  iptables -A FORWARD -i ens32.10 -o ens32 -m state --state RELATE,ESTABLISHED -j ACCEPT
  iptables -A FORWARD -i ens32 -o ens32.10 -m state --state RELATE,ESTABLISHED -j ACCEPT
  iptables -A FORWARD -i ens32.10 -o ens32 -j ACCEPT
  iptables -A FORWARD -i ens32 -o ens32.10 -j ACCEPT
</code></pre></li></ul><h1 id=overlay>overlay<a hidden class=anchor aria-hidden=true href=#overlay>#</a></h1><p><strong>ä¸€ã€è·¨ä¸»æœºç½‘ç»œæ¦‚è¿°</strong>
<img loading=lazy src=https://image.lvbibir.cn/blog/20190819130602900.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°>
<strong>äºŒã€å‡†å¤‡overlayç¯å¢ƒ</strong>
ä¸ºæ”¯æŒå®¹å™¨çš„è·¨ä¸»æœºé€šä¿¡ï¼ŒDockeræä¾›äº†overlay driverã€‚Docker overlayç½‘ç»œéœ€è¦ä¸€ä¸ªkey-valueæ•°æ®åº“ç”¨äºä¿å­˜ç½‘ç»œçŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬Networkã€Endpointã€IPç­‰ã€‚Consulã€Etcdå’ŒZooKeeperéƒ½æ˜¯Dockeræ”¯æŒçš„key-valueè½¯ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨Consul</p><p><strong>1. ç¯å¢ƒæè¿°</strong></p><table><thead><tr><th>èŠ‚ç‚¹</th><th>ç³»ç»Ÿç‰ˆæœ¬</th><th>dockerç‰ˆæœ¬</th><th>è§’è‰²</th><th>IPåœ°å€</th></tr></thead><tbody><tr><td>node-1</td><td>centos7.4</td><td>docker-18.03.0</td><td>consul</td><td>192.168.0.101</td></tr><tr><td>node-2</td><td>centos7.4</td><td>docker-18.03.0</td><td>host</td><td>192.168.0.102</td></tr><tr><td>node-3</td><td>centos7.4</td><td>docker-18.03.0</td><td>host</td><td>192.168.0.103</td></tr></tbody></table><p><strong>2. åˆ›å»ºconsul</strong></p><ul><li>node-1;</li></ul><pre tabindex=0><code>[root@node-1 ~]# docker run -d -p 8500:8500 -h consul --name consul progrium/consul -server -bootstrap
</code></pre><p>å®¹å™¨å¯åŠ¨åå¯ä»¥é€šè¿‡192.168.0.101:8500è®¿é—®åˆ°consul
<img loading=lazy src=https://image.lvbibir.cn/blog/20190819224043952.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°>
<strong>3. ä¿®æ”¹dockeré…ç½®æ–‡ä»¶</strong>
ä¿®æ”¹node-2å’Œnode-3çš„docker daemonçš„é…ç½®æ–‡ä»¶/etc/systemd/system/docker.service</p><pre tabindex=0><code>[root@node-2 ~]# vim  /etc/systemd/system/docker.service
ExecStart=/usr/bin/dockerd  -H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock --cluster-store=consul://192.168.0.101:8500 --cluster-advertise=ens32:2376
[root@node-2 ~]# systemctl daemon-reload
[root@node-2 ~]# systemctl restart docker
</code></pre><ul><li>-H ï¼štcpï¼šå…è®¸tcpè¿æ¥daemon
-Hï¼šunixï¼šé»˜è®¤çš„socketè¿æ¥æ–¹å¼ï¼Œæ”¯æŒè¿œç¨‹çš„åŒæ—¶ï¼Œæœ¬åœ°ä¹Ÿå¯ä»¥è¿æ¥</li><li>&ndash;cluster-store æŒ‡å®šconsulçš„åœ°å€</li><li>&ndash;cluster-advertise å‘ŠçŸ¥consulè‡ªå·±çš„è¿æ¥åœ°å€</li></ul><p>node-2å’Œnode-3ä¼šè‡ªåŠ¨æ³¨å†Œåˆ°consulæ•°æ®åº“ä¸­ã€‚
<img loading=lazy src=https://image.lvbibir.cn/blog/20190819225334857.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></p><p><strong>ä¸‰ã€åˆ›å»ºoverlayç½‘ç»œ
1ã€åœ¨node-2ä¸­åˆ›å»ºç½‘ç»œ</strong>
åœ¨node-2ä¸­åˆ›å»ºoverlayç½‘ç»œov_net1</p><pre tabindex=0><code>[root@node-2 ~]# docker network create -d overlay ov_net1
</code></pre><ul><li>-d overlayï¼šæŒ‡å®šdriverä¸ºoverlay</li></ul><pre tabindex=0><code>[root@node-2 ~]# docker network ls
</code></pre><p><img loading=lazy src=https://image.lvbibir.cn/blog/20190819225928983.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></p><p><strong>2ã€node-3æŸ¥çœ‹åˆ›å»ºçš„ç½‘ç»œ</strong>
æ³¨æ„åˆ°ov_net1çš„ SCOPE ä¸º globalï¼Œè€Œå…¶ä»–ç½‘ç»œä¸º local ã€‚åœ¨node-3ä¸ŠæŸ¥çœ‹å­˜åœ¨çš„ç½‘ç»œ:</p><pre tabindex=0><code>[root@node-3 ~]# docker network ls
</code></pre><p><img loading=lazy src=https://image.lvbibir.cn/blog/20190819230148207.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°>
node-3ä¸Šä¹Ÿèƒ½çœ‹åˆ°ov_net1ï¼Œåªæ˜¯å› ä¸ºåˆ›å»ºov_net1æ—¶å°†overlayç½‘ç»œä¿¡æ¯å­˜å…¥äº†consulï¼Œnode-3ä»consulè¯»å–åˆ°äº†æ–°ç½‘ç»œæ•°æ®ã€‚ä¹‹åov_net1çš„ä»»ä½•å˜åŒ–éƒ½ä¼šåŒæ­¥åˆ°node-2å’Œnode-3.
<strong>3ã€æŸ¥çœ‹ov_net1è¯¦ç»†ä¿¡æ¯</strong></p><pre tabindex=0><code>[root@node-2 ~]# docker network inspect ov_net1
</code></pre><p><img loading=lazy src=https://image.lvbibir.cn/blog/20190819230439425.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°>
IPAM æ˜¯æŒ‡ IP Address Managementï¼Œdockerè‡ªåŠ¨ä¸º ov_net1 åˆ†é…çš„ IP ç©ºé—´ä¸º 10.0.0.0/24
<strong>å››ã€åœ¨overlayä¸­è¿è¡Œå®¹å™¨</strong>
<strong>1ã€åˆ›å»ºå®¹å™¨ bbox-1</strong>
åœ¨ node-2 ä¸Šè¿è¡Œä¸€ä¸ª busybox å®¹å™¨å¹¶è¿æ¥åˆ° ov_net1.</p><pre tabindex=0><code>[root@node-2 ~]# docker run -itd --name bbox-1 --network ov_net1 busybox
</code></pre><p><strong>2ã€æŸ¥çœ‹ bbox-1 ç½‘ç»œé…ç½®</strong></p><pre tabindex=0><code>[root@node-2 ~]# docker exec bbox-1 ip r
default via 172.18.0.1 dev eth1
10.0.0.0/24 dev eth0 scope link  src 10.0.0.2
172.18.0.0/16 dev eth1 scope link  src 172.18.0.2
</code></pre><ul><li>bbox-1 æœ‰ä¸¤ä¸ªç½‘ç»œæ¥å£ï¼Œeth0 å’Œ eth1</li><li>eth0 IP ä¸º 10.0.0.2ï¼Œè¿æ¥çš„æ˜¯overlayç½‘ç»œ ov_net1</li><li>eth1 IP ä¸º 172.18.0.2</li><li>å®¹å™¨çš„é»˜è®¤è·¯ç”±æ˜¯èµ° eth1ï¼Œå…¶å®ï¼Œdocker ä¼šåˆ›å»ºä¸€ä¸ª bridge ç½‘ç»œ â€œdocker_gwbridgeâ€ï¼Œä¸ºæ‰€æœ‰è¿æ¥åˆ° overlay ç½‘ç»œçš„å®¹å™¨æä¾›è®¿é—®å¤–ç½‘çš„èƒ½åŠ›</li></ul><pre tabindex=0><code>[root@node-2 ~]# docker network ls
</code></pre><p><img loading=lazy src=https://image.lvbibir.cn/blog/20190819231543466.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></p><pre tabindex=0><code>[root@node-2 ~]# docker network inspect docker_gwbridge
</code></pre><p><img loading=lazy src=https://image.lvbibir.cn/blog/20190819232009799.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°>
ä» docker network inspect docker_gwbridge è¾“å‡ºå¯ç¡®è®¤ docker_gwbridge çš„ IP åœ°å€èŒƒå›´æ˜¯ 172.18.0.0/16ï¼Œå½“å‰è¿æ¥çš„å®¹å™¨å°±æ˜¯ bbox-1ï¼ˆ172.18.0.2ï¼‰
è€Œä¸”æ­¤ç½‘ç»œçš„ç½‘å…³å°±æ˜¯ç½‘æ¡¥ docker_gwbridge çš„ IP 172.18.0.1</p><pre tabindex=0><code>[root@node-2 ~]# ifconfig docker_gwbridge
docker_gwbridge: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 172.18.0.1  netmask 255.255.0.0  broadcast 172.18.255.255
        inet6 fe80::42:c5ff:fe45:937  prefixlen 64  scopeid 0x20&lt;link&gt;
        ether 02:42:c5:45:09:37  txqueuelen 0  (Ethernet)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</code></pre><p>è¿™æ ·å®¹å™¨ bbox-1 å°±å¯ä»¥é€šè¿‡docker_gwbridge è®¿é—®å¤–ç½‘</p><pre tabindex=0><code>[root@node-2 ~]# docker exec bbox-1 ping -c 4 www.baidu.com
PING www.baidu.com (182.61.200.6): 56 data bytes
64 bytes from 182.61.200.6: seq=0 ttl=53 time=6.721 ms
64 bytes from 182.61.200.6: seq=1 ttl=53 time=7.954 ms
64 bytes from 182.61.200.6: seq=2 ttl=53 time=11.723 ms
64 bytes from 182.61.200.6: seq=3 ttl=53 time=15.105 ms

--- www.baidu.com ping statistics ---
4 packets transmitted, 4 packets received, 0% packet loss
round-trip min/avg/max = 6.721/10.375/15.105 ms
</code></pre><p><strong>äº”ã€overlayç½‘ç»œè¿é€šæ€§</strong>
<strong>1ã€node-3 ä¸­ è¿è¡Œ bbox-2</strong></p><pre tabindex=0><code>[root@node-3 ~]# docker run -itd --name bbox-2 --network ov_net1 busybox
</code></pre><p><strong>2ã€æŸ¥çœ‹ bbox-2 è·¯ç”±æƒ…å†µ</strong></p><pre tabindex=0><code>[root@node-3 ~]# docker exec bbox-2 ip r
default via 172.18.0.1 dev eth1
10.0.0.0/24 dev eth0 scope link  src 10.0.0.3
172.18.0.0/16 dev eth1 scope link  src 172.18.0.2
</code></pre><p><strong>3ã€äº’é€šæµ‹è¯•</strong></p><pre tabindex=0><code>[root@node-3 ~]# docker exec bbox-2 ping -c 4 10.0.0.2
PING 10.0.0.2 (10.0.0.2): 56 data bytes
64 bytes from 10.0.0.2: seq=0 ttl=64 time=2.628 ms
64 bytes from 10.0.0.2: seq=1 ttl=64 time=1.004 ms
64 bytes from 10.0.0.2: seq=2 ttl=64 time=1.277 ms
64 bytes from 10.0.0.2: seq=3 ttl=64 time=1.505 ms

--- 10.0.0.2 ping statistics ---
4 packets transmitted, 4 packets received, 0% packet loss
round-trip min/avg/max = 1.004/1.603/2.628 ms
</code></pre><p>å¯è§ overlay ç½‘ç»œä¸­çš„å®¹å™¨å¯ä»¥ç›´æ¥é€šä¿¡ï¼ŒåŒæ—¶dockerä¹Ÿå®ç°äº†DNSæœåŠ¡
<strong>4ã€å®ç°åŸç†</strong>
docker ä¼šä¸ºæ¯ä¸ª overlay ç½‘ç»œåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ network namespaceï¼Œå…¶ä¸­ä¼šæœ‰ä¸€ä¸ª linux bridge br0ï¼Œ veth pair ä¸€ç«¯è¿æ¥åˆ°å®¹å™¨ä¸­ï¼ˆå³ eth0ï¼‰ï¼Œå¦ä¸€ç«¯è¿æ¥åˆ° namespace çš„ br0 ä¸Šã€‚
br0 é™¤äº†è¿æ¥æ‰€æœ‰çš„ veth pairï¼Œè¿˜ä¼šè¿æ¥ä¸€ä¸ª vxlan è®¾å¤‡ï¼Œç”¨äºä¸å…¶ä»– host å»ºç«‹ vxlan tunnelã€‚å®¹å™¨ä¹‹é—´çš„æ•°æ®å°±æ˜¯é€šè¿‡è¿™ä¸ª tunnel é€šä¿¡çš„ã€‚é€»è¾‘ç½‘ç»œæ‹“æ‰‘ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼š
<img loading=lazy src=https://image.lvbibir.cn/blog/20190819233352547.png alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></p><pre tabindex=0><code>[root@node-2 ~]# brctl show
bridge name     bridge id               STP enabled     interfaces
docker0         8000.024217edc413       no
docker_gwbridge         8000.0242c5450937       no              vethc59120e
virbr0          8000.525400b76fd4       yes             virbr0-nic
[root@node-3 ~]# brctl show
bridge name     bridge id               STP enabled     interfaces
docker0         8000.0242ef3c7df7       no
docker_gwbridge         8000.0242c81afaee       no              vethf4562a9
virbr0          8000.525400c28478       yes             virbr0-nic
</code></pre><p>è¦æŸ¥çœ‹ overlay ç½‘ç»œçš„ namespace å¯ä»¥åœ¨ node-2 å’Œ node-3 ä¸Šæ‰§è¡Œ ip netnsï¼ˆè¯·ç¡®ä¿åœ¨æ­¤ä¹‹å‰æ‰§è¡Œè¿‡ ln -s /var/run/docker/netns /var/run/netnsï¼‰ï¼Œå¯ä»¥çœ‹åˆ°ä¸¤ä¸ª node ä¸Šæœ‰ä¸€ä¸ªç›¸åŒçš„ namespace &ldquo;1-dd91de7599&rdquo;</p><pre tabindex=0><code>[root@node-2 ~]# ln -s /var/run/docker/netns /var/run/netns
[root@node-2 ~]# ip netns
6889f61efc4b (id: 1)
1-dd91de7599 (id: 0)
</code></pre><pre tabindex=0><code>[root@node-3 ~]# ln -s /var/run/docker/netns /var/run/netns
[root@node-3 ~]# ip netns
8e4722847745 (id: 1)
1-dd91de7599 (id: 0)
</code></pre><p>&ldquo;1-dd91de7599&rdquo; è¿™å°±æ˜¯ ov_net1 çš„ namespaceï¼ŒæŸ¥çœ‹ namespace ä¸­çš„ br0 ä¸Šçš„è®¾å¤‡</p><pre tabindex=0><code>[root@node-2 ~]# ip netns exec 1-dd91de7599 brctl show
bridge name     bridge id               STP enabled     interfaces
br0             8000.0e7576c7c035       no              veth0
                                                        vxlan0
</code></pre><p><strong>å…­ã€overlayç½‘ç»œéš”ç¦»</strong>
ä¸åŒçš„ overlay ç½‘ç»œæ˜¯ç›¸äº’éš”ç¦»çš„ã€‚æˆ‘ä»¬åˆ›å»ºç¬¬äºŒä¸ª overlay ç½‘ç»œ ov_net2 å¹¶è¿è¡Œå®¹å™¨ bbox-3
<strong>1ã€åˆ›å»ºç½‘ç»œ ov_net2</strong></p><pre tabindex=0><code>[root@node-2 ~]# docker network create -d overlay ov_net2
</code></pre><p><strong>2ã€å¯åŠ¨å®¹å™¨ bbox-3</strong></p><pre tabindex=0><code>[root@node-2 ~]# docker run -itd --name bbox-3 --network ov_net2 busybox
</code></pre><p><strong>3ã€æŸ¥çœ‹ bbox-3 ç½‘ç»œ</strong>
bbox-3 åˆ†é…åˆ°çš„ IP æ˜¯ 10.0.1.2ï¼Œå°è¯• ping bbox-1ï¼ˆ10.0.0.2ï¼‰</p><pre tabindex=0><code>[root@node-2 ~]# docker exec -it bbox-3 ip r
default via 172.18.0.1 dev eth1
10.0.1.0/24 dev eth0 scope link  src 10.0.1.2
172.18.0.0/16 dev eth1 scope link  src 172.18.0.3
</code></pre><pre tabindex=0><code>[root@node-2 ~]# docker exec -it bbox-3 ping -c 4 10.0.0.2
PING 10.0.0.2 (10.0.0.2): 56 data bytes

--- 10.0.0.2 ping statistics ---
4 packets transmitted, 0 packets received, 100% packet loss
[root@node-2 ~]# docker exec -it bbox-3 ping -c 4 172.18.0.2
PING 172.18.0.2 (172.18.0.2): 56 data bytes

--- 172.18.0.2 ping statistics ---
4 packets transmitted, 0 packets received, 100% packet loss
</code></pre><p>ping å¤±è´¥ï¼Œå¯è§ä¸åŒ overlay ç½‘ç»œä¹‹é—´æ˜¯éš”ç¦»çš„ï¼Œå³ä½¿é€šè¿‡ docker_gwbridge ä¹Ÿä¸èƒ½é€šä¿¡
å¦‚æœè¦å®ç° bbox-3 å’Œ bbox-1 é€šä¿¡ï¼Œå¯ä»¥å°† bbox-3 ä¹Ÿè¿æ¥åˆ° ov_net1
è¿™æ—¶ bbox-3 åŒæ—¶è¿æ¥åˆ°äº† ov_net1 å’Œ ov_net2 ä¸Š</p><pre tabindex=0><code>[root@node-2 ~]# docker network connect ov_net1 bbox-3
[root@node-2 ~]# docker exec bbox-3 ip r
default via 172.18.0.1 dev eth1
10.0.0.0/24 dev eth2 scope link  src 10.0.0.4
10.0.1.0/24 dev eth0 scope link  src 10.0.1.2
172.18.0.0/16 dev eth1 scope link  src 172.18.0.3
[root@node-2 ~]# docker exec bbox-3 ping -c 4 10.0.0.2
PING 10.0.0.2 (10.0.0.2): 56 data bytes
64 bytes from 10.0.0.2: seq=0 ttl=64 time=0.184 ms
64 bytes from 10.0.0.2: seq=1 ttl=64 time=0.158 ms
64 bytes from 10.0.0.2: seq=2 ttl=64 time=0.162 ms
64 bytes from 10.0.0.2: seq=3 ttl=64 time=0.093 ms

--- 10.0.0.2 ping statistics ---
4 packets transmitted, 4 packets received, 0% packet loss
round-trip min/avg/max = 0.093/0.149/0.184 ms
</code></pre><p>docker é»˜è®¤ä¸º overlay ç½‘ç»œåˆ†é… 24 ä½æ©ç çš„å­ç½‘ï¼ˆ10.0.X.0/24ï¼‰ï¼Œæ‰€æœ‰ä¸»æœºå…±äº«è¿™ä¸ª subnetï¼Œå®¹å™¨å¯åŠ¨æ—¶ä¼šé¡ºåºä»æ­¤ç©ºé—´åˆ†é… IPã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ &ndash;subnet æŒ‡å®š IP ç©ºé—´ã€‚</p><pre tabindex=0><code>docker network create -d overlay --subnet 10.22.1.0/24 ov_net
</code></pre></div><div class=post-reward><div style=padding:0;margin:0;width:100%;font-size:16px;text-align:center><div id=QR style=opacity:0><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=https://www.lvbibir.cn/img/wechat_pay.png alt=wechat_pay></a><p>å¾®ä¿¡</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=https://www.lvbibir.cn/img/alipay.png alt=alipay></a><p>æ”¯ä»˜å®</p></div></div><button id=rewardButton onclick='var qr=document.getElementById("QR");qr.style.opacity==="0"?qr.style.opacity="1":qr.style.opacity="0"'>
<span>ğŸ§§ é¼“åŠ±</span></button></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://www.lvbibir.cn/posts/tech/docker-command/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>docker | å‘½ä»¤å¤§å…¨</span></a>
<a class=next href=https://www.lvbibir.cn/posts/tech/docker-data-volume/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>docker | æ•°æ®å·ï¼ˆdata volumeï¼‰</span></a></nav></footer></div><div><div class=pagination__title><span class=pagination__title-h style=font-size:20px>ğŸ’¬è¯„è®º</span><hr></div><div id=tcomment></div><script src=https://cdn.staticfile.org/twikoo/1.6.7/twikoo.all.min.js></script><script>twikoo.init({envId:"https://twikoo.lvbibir.cn/",el:"#tcomment",lang:"zh-CN",path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><a href=https://gohugo.io/ target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/frame-hugo-blue.svg></a>
<a href=https://github.com/adityatelange/hugo-PaperMod target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/theme-papermod-lightgrey.svg></a>
<a href=https://cn.aliyun.com/ target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/å›¾åºŠ-é˜¿é‡Œäº‘-orange.svg></a><br><span id=runtime_span></span>
<script type=text/javascript>function show_runtime(){window.setTimeout("show_runtime()",1e3),X=new Date("7/13/2021 1:00:00"),Y=new Date,T=Y.getTime()-X.getTime(),M=24*60*60*1e3,a=T/M,A=Math.floor(a),b=(a-A)*24,B=Math.floor(b),c=(b-B)*60,C=Math.floor((b-B)*60),D=Math.floor((c-C)*60),runtime_span.innerHTML="ç½‘ç«™å·²è¿è¡Œ"+A+"å¤©"+B+"å°æ—¶"+C+"åˆ†"+D+"ç§’"}show_runtime()</script>|
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span id=busuanzi_container>æ€»è®¿å®¢æ•°: <span id=busuanzi_value_site_uv></span>
|
æ€»è®¿é—®é‡: <span id=busuanzi_value_site_pv></span></span><br><a href=https://beian.miit.gov.cn/ target=_blank style="border-bottom:1px solid">äº¬ICPå¤‡2021023168å·-1</a>&nbsp;
|
<span>Copyright
&copy;
2020-2022
<a href=https://www.lvbibir.cn style="border-bottom:1px solid">lvbibir's Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg><span id=read_progress></span></span></a>
<script>document.addEventListener("scroll",function(){const t=document.getElementById("read_progress"),n=document.documentElement.scrollHeight,s=document.documentElement.clientHeight,o=document.documentElement.scrollTop||document.body.scrollTop;t.innerText=((o/(n-s)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>400||document.documentElement.scrollTop>400?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="ğŸ“„å¤åˆ¶";function s(){t.innerText="ğŸ‘ŒğŸ»å·²å¤åˆ¶!",setTimeout(()=>{t.innerText="ğŸ“„å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild===n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName==="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>