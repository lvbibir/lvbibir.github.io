<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>shell | 服务器巡检脚本 | lvbibir's Blog</title><meta name=keywords content="shell,linux"><meta name=description content="代码如下 #!/bin/bash #参数定义 date=`date +&#34;%Y-%m-%d-%H:%M:%S&#34;` centosVersion=$(awk '{print $(NF-1)}' /etc/redhat-release) VERSION=`date +%F` #日志相关 LOGPATH=&#34;/tmp/awr&#34; [ -e $LOGPATH ] || mkdir -p $LOGPATH RESULTFILE=&#34;$LOGPATH/HostCheck-`hostname`-`date +%Y%m%d`.txt&#34; #调用函数库 [ -f /etc/init.d/functions ] && source /etc/init.d/functions export PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin source /etc/profile #root用户执行脚本 [ $(id -u) -gt 0 ] && echo &#34;请用root用户执行此脚本！&#34; && exit 1 function version(){ echo &#34;&#34; echo &#34;&#34; echo &#34;[${date}] >>> `hostname -s` 主机巡检&#34; } function getSystemStatus(){ echo &#34;&#34; echo -e &#34;\033[33m***"><meta name=author content="作者:&nbsp;lvbibir"><link rel=canonical href=https://www.lvbibir.cn/posts/tech/shell-server-inspection/><link crossorigin=anonymous href=/assets/css/stylesheet.df4f046f519e6200f872e2e9056de28613000538a089d8d0563e86856f24ec70.css integrity="sha256-308Eb1GeYgD4cuLpBW3ihhMABTigidjQVj6GhW8k7HA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.lvbibir.cn/img/avatar.gif><link rel=icon type=image/png sizes=16x16 href=https://www.lvbibir.cn/img/avatar.gif><link rel=icon type=image/png sizes=32x32 href=https://www.lvbibir.cn/img/avatar.gif><link rel=apple-touch-icon href=https://www.lvbibir.cn/img/avatar.gif><link rel=mask-icon href=https://www.lvbibir.cn/img/avatar.gif><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta property="og:title" content="shell | 服务器巡检脚本"><meta property="og:description" content="代码如下 #!/bin/bash #参数定义 date=`date +&#34;%Y-%m-%d-%H:%M:%S&#34;` centosVersion=$(awk '{print $(NF-1)}' /etc/redhat-release) VERSION=`date +%F` #日志相关 LOGPATH=&#34;/tmp/awr&#34; [ -e $LOGPATH ] || mkdir -p $LOGPATH RESULTFILE=&#34;$LOGPATH/HostCheck-`hostname`-`date +%Y%m%d`.txt&#34; #调用函数库 [ -f /etc/init.d/functions ] && source /etc/init.d/functions export PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin source /etc/profile #root用户执行脚本 [ $(id -u) -gt 0 ] && echo &#34;请用root用户执行此脚本！&#34; && exit 1 function version(){ echo &#34;&#34; echo &#34;&#34; echo &#34;[${date}] >>> `hostname -s` 主机巡检&#34; } function getSystemStatus(){ echo &#34;&#34; echo -e &#34;\033[33m***"><meta property="og:type" content="article"><meta property="og:url" content="https://www.lvbibir.cn/posts/tech/shell-server-inspection/"><meta property="og:image" content="https://image.lvbibir.cn/blog/shell.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-01T00:00:00+00:00"><meta property="article:modified_time" content="2021-09-01T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://image.lvbibir.cn/blog/shell.png"><meta name=twitter:title content="shell | 服务器巡检脚本"><meta name=twitter:description content="代码如下 #!/bin/bash #参数定义 date=`date +&#34;%Y-%m-%d-%H:%M:%S&#34;` centosVersion=$(awk '{print $(NF-1)}' /etc/redhat-release) VERSION=`date +%F` #日志相关 LOGPATH=&#34;/tmp/awr&#34; [ -e $LOGPATH ] || mkdir -p $LOGPATH RESULTFILE=&#34;$LOGPATH/HostCheck-`hostname`-`date +%Y%m%d`.txt&#34; #调用函数库 [ -f /etc/init.d/functions ] && source /etc/init.d/functions export PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin source /etc/profile #root用户执行脚本 [ $(id -u) -gt 0 ] && echo &#34;请用root用户执行此脚本！&#34; && exit 1 function version(){ echo &#34;&#34; echo &#34;&#34; echo &#34;[${date}] >>> `hostname -s` 主机巡检&#34; } function getSystemStatus(){ echo &#34;&#34; echo -e &#34;\033[33m***"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"📚 文章","item":"https://www.lvbibir.cn/posts/"},{"@type":"ListItem","position":3,"name":"👨🏻‍💻 技术","item":"https://www.lvbibir.cn/posts/tech/"},{"@type":"ListItem","position":4,"name":"shell | 服务器巡检脚本","item":"https://www.lvbibir.cn/posts/tech/shell-server-inspection/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"shell | 服务器巡检脚本","name":"shell | 服务器巡检脚本","description":"代码如下 #!/bin/bash #参数定义 date=`date +\u0026#34;%Y-%m-%d-%H:%M:%S\u0026#34;` centosVersion=$(awk \u0026#39;{print $(NF-1)}\u0026#39; /etc/redhat-release) VERSION=`date +%F` #日志相关 LOGPATH=\u0026#34;/tmp/awr\u0026#34; [ -e $LOGPATH ] || mkdir -p $LOGPATH RESULTFILE=\u0026#34;$LOGPATH/HostCheck-`hostname`-`date +%Y%m%d`.txt\u0026#34; #调用函数库 [ -f /etc/init.d/functions ] \u0026amp;\u0026amp; source /etc/init.d/functions export PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin source /etc/profile #root用户执行脚本 [ $(id -u) -gt 0 ] \u0026amp;\u0026amp; echo \u0026#34;请用root用户执行此脚本！\u0026#34; \u0026amp;\u0026amp; exit 1 function version(){ echo \u0026#34;\u0026#34; echo \u0026#34;\u0026#34; echo \u0026#34;[${date}] \u0026gt;\u0026gt;\u0026gt; `hostname -s` 主机巡检\u0026#34; } function getSystemStatus(){ echo \u0026#34;\u0026#34; echo -e \u0026#34;\\033[33m***","keywords":["shell","linux"],"articleBody":"代码如下\n#!/bin/bash #参数定义 date=`date +\"%Y-%m-%d-%H:%M:%S\"` centosVersion=$(awk '{print $(NF-1)}' /etc/redhat-release) VERSION=`date +%F` #日志相关 LOGPATH=\"/tmp/awr\" [ -e $LOGPATH ] || mkdir -p $LOGPATH RESULTFILE=\"$LOGPATH/HostCheck-`hostname`-`date +%Y%m%d`.txt\" #调用函数库 [ -f /etc/init.d/functions ] \u0026\u0026 source /etc/init.d/functions export PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin source /etc/profile #root用户执行脚本 [ $(id -u) -gt 0 ] \u0026\u0026 echo \"请用root用户执行此脚本！\" \u0026\u0026 exit 1 function version(){ echo \"\" echo \"\" echo \"[${date}] \u003e\u003e\u003e `hostname -s` 主机巡检\" } function getSystemStatus(){ echo \"\" echo -e \"\\033[33m****************************************************系统检查****************************************************\\033[0m\" if [ -e /etc/sysconfig/i18n ];then default_LANG=\"$(grep \"LANG=\" /etc/sysconfig/i18n | grep -v \"^#\" | awk -F '\"' '{print $2}')\" else default_LANG=$LANG fi export LANG=\"en_US.UTF-8\" Release=$(cat /etc/redhat-release 2\u003e/dev/null) Kernel=$(uname -r) OS=$(uname -o) Hostname=$(uname -n) SELinux=$(/usr/sbin/sestatus | grep \"SELinux status: \" | awk '{print $3}') LastReboot=$(who -b | awk '{print $3,$4}') uptime=$(uptime | sed 's/.*up \\([^,]*\\), .*/\\1/') echo \" 系统：$OS\" echo \" 发行版本：$Release\" echo \" 内核：$Kernel\" echo \" 主机名：$Hostname\" echo \" SELinux：$SELinux\" echo \"语言/编码：$default_LANG\" echo \" 当前时间：$(date +'%F %T')\" echo \" 最后启动：$LastReboot\" echo \" 运行时间：$uptime\" export LANG=\"$default_LANG\" } function getCpuStatus(){ echo \"\" echo -e \"\\033[33m****************************************************CPU检查*****************************************************\\033[0m\" Physical_CPUs=$(grep \"physical id\" /proc/cpuinfo| sort | uniq | wc -l) Virt_CPUs=$(grep \"processor\" /proc/cpuinfo | wc -l) CPU_Kernels=$(grep \"cores\" /proc/cpuinfo|uniq| awk -F ': ' '{print $2}') CPU_Type=$(grep \"model name\" /proc/cpuinfo | awk -F ': ' '{print $2}' | sort | uniq) CPU_Arch=$(uname -m) echo \"物理CPU个数:$Physical_CPUs\" echo \"逻辑CPU个数:$Virt_CPUs\" echo \"每CPU核心数:$CPU_Kernels\" echo \" CPU型号:$CPU_Type\" echo \" CPU架构:$CPU_Arch\" } function getMemStatus(){ echo \"\" echo -e \"\\033[33m**************************************************内存检查*****************************************************\\033[0m\" if [[ $centosVersion \u003c 7 ]];then free -mo else free -h fi #报表信息 MemTotal=$(grep MemTotal /proc/meminfo| awk '{print $2}') #KB MemFree=$(grep MemFree /proc/meminfo| awk '{print $2}') #KB let MemUsed=MemTotal-MemFree MemPercent=$(awk \"BEGIN {if($MemTotal==0){printf 100}else{printf \\\"%.2f\\\",$MemUsed*100/$MemTotal}}\") } function getDiskStatus(){ echo \"\" echo -e \"\\033[33m**************************************************磁盘检查******************************************************\\033[0m\" df -hiP | sed 's/Mounted on/Mounted/'\u003e /tmp/inode df -hTP | sed 's/Mounted on/Mounted/'\u003e /tmp/disk join /tmp/disk /tmp/inode | awk '{print $1,$2,\"|\",$3,$4,$5,$6,\"|\",$8,$9,$10,$11,\"|\",$12}'| column -t #报表信息 diskdata=$(df -TP | sed '1d' | awk '$2!=\"tmpfs\"{print}') #KB disktotal=$(echo \"$diskdata\" | awk '{total+=$3}END{print total}') #KB diskused=$(echo \"$diskdata\" | awk '{total+=$4}END{print total}') #KB diskfree=$((disktotal-diskused)) #KB diskusedpercent=$(echo $disktotal $diskused | awk '{if($1==0){printf 100}else{printf \"%.2f\",$2*100/$1}}') inodedata=$(df -iTP | sed '1d' | awk '$2!=\"tmpfs\"{print}') inodetotal=$(echo \"$inodedata\" | awk '{total+=$3}END{print total}') inodeused=$(echo \"$inodedata\" | awk '{total+=$4}END{print total}') inodefree=$((inodetotal-inodeused)) inodeusedpercent=$(echo $inodetotal $inodeused | awk '{if($1==0){printf 100}else{printf \"%.2f\",$2*100/$1}}') } function get_resource(){ echo \"\" echo -e \"\\033[33m**************************************************资源消耗统计**************************************************\\033[0m\" echo -e \"\\033[36m*************带宽资源消耗统计*************\\033[0m\" #用数组存放网卡名 nic=(`ifconfig | grep ^[a-z] | grep -vE 'lo|docker0'| awk -F: '{print $1}'`) time=`date \"+%Y-%m-%d %k:%M\"` num=0 for ((i=0;i\u003c${#nic[@]};i++)) do #循环五次，避免看到的是偶然的数据 while (( $num\u003c5 )) do rx_before=$(cat /proc/net/dev | grep '${nic[$i]}' | tr : \" \" | awk '{print $2}') tx_before=$(cat /proc/net/dev | grep '${nic[$i]}' | tr : \" \" | awk '{print $10}') sleep 2 #用sed先获取第7列,再用awk获取第2列，再cut切割,从第7个到最后，即只切割网卡流量数字部分 rx_after=$(cat /proc/net/dev | grep '${nic[$i]}' | tr : \" \" | awk '{print $2}') tx_after=$(cat /proc/net/dev | grep '${nic[$i]}' | tr : \" \" | awk '{print $10}') #注意下面截取的相差2秒的两个时刻的累计和发送的bytes(即累计传送和接收的位) rx_result=$[(rx_after-rx_before)/1024/1024/2*8] tx_result=$[(tx_after-tx_before)/1024/1024/2*8] echo \"$time Now_In_Speed: $rx_result Mbps Now_OUt_Speed: $tx_result Mbps\" \u003e\u003e /tmp/network.txt let \"num++\" done #注意下面grep后面的$time变量要用双引号括起来 rx_result=$(cat /tmp/network.txt|grep \"$time\"|awk '{In+=$4}END{print In}') tx_result=$(cat /tmp/network.txt|grep \"$time\"|awk '{Out+=$7}END{print Out}') In_Speed=$(echo \"scale=2;$rx_result/5\"|bc) Out_Speed=$(echo \"scale=2;$tx_result/5\"|bc) echo -e \"\\033[32m In_Speed_average: $In_Speed Mbps Out_Speed_average: $Out_Speed Mbps! \\033[0m\" done echo -e \"\\033[36m*************CPU资源消耗统计*************\\033[0m\" #使用vmstat 1 5命令统计5秒内的使用情况，再计算每秒使用情况 total=`vmstat 1 5|awk '{x+=$13;y+=$14}END{print x+y}'` cpu_average=$(echo \"scale=2;$total/5\"|bc) #判断CPU使用率（浮点数与整数比较） if [ `echo \"${cpu_average} \u003e 70\" | bc` -eq 1 ];then echo -e \"\\033[31m Total CPU is already use: ${cpu_average}%,请及时处理！\\033[0m\" else echo -e \"\\033[32m Total CPU is already use: ${cpu_average}%! \\033[0m\" fi echo -e \"\\033[36m*************磁盘资源消耗统计*************\\033[0m\" #磁盘使用情况(注意：需要用sed先进行格式化才能进行累加处理) disk_used=$(df -m | sed '1d;/ /!N;s/\\n//;s/ \\+/ /;' | awk '{used+=$3} END{print used}') disk_totalSpace=$(df -m | sed '1d;/ /!N;s/\\n//;s/ \\+/ /;' | awk '{totalSpace+=$2} END{print totalSpace}') disk_all=$(echo \"scale=4;$disk_used/$disk_totalSpace\" | bc) disk_percent1=$(echo $disk_all | cut -c 2-3) disk_percent2=$(echo $disk_all | cut -c 4-5) disk_warning=`df -m | sed '1d;/ /!N;s/\\n//;s/ \\+/ /;' | awk '{if ($5\u003e85) print $6 \"目录使用率：\" $5;} '` echo -e \"\\033[32m Total disk has used: $disk_percent1.$disk_percent2% \\033[0m\" #echo -e \"\\t\\t..\" 表示换行 if [ -n \"$disk_warning\" ];then echo -e \"\\033[31m${disk_warning} \\n [Error]以上目录使用率超过85%，请及时处理！\\033[0m\" fi echo -e \"\\033[36m*************内存资源消耗统计*************\\033[0m\" #获得系统总内存 memery_all=$(free -m | awk 'NR==2' | awk '{print $2}') #获得占用内存（操作系统 角度） system_memery_used=$(free -m | awk 'NR==2' | awk '{print $3}') #获得buffer、cache占用内存，当内存不够时会及时回收，所以这两部分可用于可用内存的计算 buffer_used=$(free -m | awk 'NR==2' | awk '{print $6}') cache_used=$(free -m | awk 'NR==2' | awk '{print $7}') #获得被使用内存，所以这部分可用于可用内存的计算，注意计算方法 actual_used_all=$[memery_all-(free+buffer_used+cache_used)] #获得实际占用的内存 actual_used_all=`expr $memery_all - $free + $buffer_used + $cache_used ` memery_percent=$(echo \"scale=4;$system_memery_used / $memery_all\" | bc) memery_percent2=$(echo \"scale=4; $actual_used_all / $memery_all\" | bc) percent_part1=$(echo $memery_percent | cut -c 2-3) percent_part2=$(echo $memery_percent | cut -c 4-5) percent_part11=$(echo $memery_percent2 | cut -c 2-3) percent_part22=$(echo $memery_percent2 | cut -c 4-5) #获得占用内存（操作系统角度） echo -e \"\\033[32m system memery is already use: $percent_part1.$percent_part2% \\033[0m\" #获得实际内存占用率 echo -e \"\\033[32m actual memery is already use: $percent_part11.$percent_part22% \\033[0m\" echo -e \"\\033[32m buffer is already used : $buffer_used M \\033[0m\" echo -e \"\\033[32m cache is already used : $cache_used M \\033[0m\" } function getServiceStatus(){ echo \"\" echo -e \"\\033[33m*************************************************服务检查*******************************************************\\033[0m\" echo \"\" if [[ $centosVersion \u003e 7 ]];then conf=$(systemctl list-unit-files --type=service --state=enabled --no-pager | grep \"enabled\") process=$(systemctl list-units --type=service --state=running --no-pager | grep \".service\") else conf=$(/sbin/chkconfig | grep -E \":on|:启用\") process=$(/sbin/service --status-all 2\u003e/dev/null | grep -E \"is running|正在运行\") fi echo -e \"\\033[36m******************服务配置******************\\033[0m\" echo \"$conf\" | column -t echo \"\" echo -e \"\\033[36m**************正在运行的服务****************\\033[0m\" echo \"$process\" } function getAutoStartStatus(){ echo \"\" echo -e \"\\033[33m***********************************************自启动检查*******************************************************\\033[0m\" echo -e \"\\033[36m****************自启动命令*****************\\033[0m\" conf=$(grep -v \"^#\" /etc/rc.d/rc.local| sed '/^$/d') echo \"$conf\" } function getLoginStatus(){ echo \"\" echo -e \"\\033[33m************************************************登录检查********************************************************\\033[0m\" last | head } function getNetworkStatus(){ echo \"\" echo -e \"\\033[33m************************************************网络检查********************************************************\\033[0m\" if [[ $centosVersion \u003c 7 ]];then /sbin/ifconfig -a | grep -v packets | grep -v collisions | grep -v i net6 else #ip a for i in $(ip link | grep BROADCAST | awk -F: '{print $2}');do ip add show $i | grep -E \"BROADCAST|global\"| awk '{print $2}' | tr '\\n' ' ' ;echo \"\" ;done fi GATEWAY=$(ip route | grep default | awk '{print $3}') DNS=$(grep nameserver /etc/resolv.conf| grep -v \"#\" | awk '{print $2}' | tr '\\n' ',' | sed 's/,$//') echo \"\" echo \"网关：$GATEWAY \" echo \"DNS：$DNS\" #报表信息 IP=$(ip -f inet addr | grep -v 127.0.0.1 | grep inet | awk '{print $NF,$2}' | tr '\\n' ',' | sed 's/,$//') MAC=$(ip link | grep -v \"LOOPBACK\\|loopback\" | awk '{print $2}' | sed 'N;s/\\n//' | tr '\\n' ',' | sed 's/,$//') echo \"\" ping -c 4 www.baidu.com \u003e/dev/null 2\u003e\u00261 if [ $? -eq 0 ];then echo \"\" echo -e \"\\033[32m网络连接：正常！\\033[0m\" else echo \"\" echo -e \"\\033[31m网络连接：异常！\\033[0m\" fi } function getListenStatus(){ echo \"\" echo -e \"\\033[33m***********************************************监听检查********************************************************\\033[0m\" TCPListen=$(ss -ntul | column -t) echo \"$TCPListen\" } function getCronStatus(){ echo \"\" echo -e \"\\033[33m**********************************************计划任务检查******************************************************\\033[0m\" Crontab=0 for shell in $(grep -v \"/sbin/nologin\" /etc/shells);do for user in $(grep \"$shell\" /etc/passwd| awk -F: '{print $1}');do crontab -l -u $user \u003e/dev/null 2\u003e\u00261 status=$? if [ $status -eq 0 ];then echo -e \"\\033[36m************$user用户的定时任务**************\\033[0m\" crontab -l -u $user let Crontab=Crontab+$(crontab -l -u $user | wc -l) echo \"\" fi done done #计划任务 #find /etc/cron* -type f | xargs -i ls -l {} | column -t #let Crontab=Crontab+$(find /etc/cron* -type f | wc -l) } function getHowLongAgo(){ # 计算一个时间戳离现在有多久了 datetime=\"$*\" [ -z \"$datetime\" ] \u0026\u0026 echo `stat /etc/passwd|awk \"NR==6\"` Timestamp=$(date +%s -d \"$datetime\") Now_Timestamp=$(date +%s) Difference_Timestamp=$(($Now_Timestamp-$Timestamp)) days=0;hours=0;minutes=0; sec_in_day=$((60*60*24)); sec_in_hour=$((60*60)); sec_in_minute=60 while (( $(($Difference_Timestamp-$sec_in_day)) \u003e 1 )) do let Difference_Timestamp=Difference_Timestamp-sec_in_day let days++ done while (( $(($Difference_Timestamp-$sec_in_hour)) \u003e 1 )) do let Difference_Timestamp=Difference_Timestamp-sec_in_hour let hours++ done echo \"$days 天 $hours 小时前\" } function getUserLastLogin(){ # 获取用户最近一次登录的时间，含年份 # 很遗憾last命令不支持显示年份，只有\"last -t YYYYMMDDHHMMSS\"表示某个时间之间的登录，我 # 们只能用最笨的方法了，对比今天之前和今年元旦之前（或者去年之前和前年之前……）某个用户 # 登录次数，如果登录统计次数有变化，则说明最近一次登录是今年。 username=$1 : ${username:=\"`whoami`\"} thisYear=$(date +%Y) oldesYear=$(last | tail -n1 | awk '{print $NF}') while(( $thisYear \u003e= $oldesYear));do loginBeforeToday=$(last $username | grep $username | wc -l) loginBeforeNewYearsDayOfThisYear=$(last $username -t $thisYear\"0101000000\" | grep $username | wc -l) if [ $loginBeforeToday -eq 0 ];then echo \"从未登录过\" break elif [ $loginBeforeToday -gt $loginBeforeNewYearsDayOfThisYear ];then lastDateTime=$(last -i $username | head -n1 | awk '{for(i=4;i\u003c(NF-2);i++)printf\"%s \",$i}')\" $thisYear\" lastDateTime=$(date \"+%Y-%m-%d %H:%M:%S\" -d \"$lastDateTime\") echo \"$lastDateTime\" break else thisYear=$((thisYear-1)) fi done } function getUserStatus(){ echo \"\" echo -e \"\\033[33m*************************************************用户检查*******************************************************\\033[0m\" #/etc/passwd 最后修改时间 pwdfile=\"$(cat /etc/passwd)\" Modify=$(stat /etc/passwd | grep Modify | tr '.' ' ' | awk '{print $2,$3}') echo \"/etc/passwd: $Modify ($(getHowLongAgo $Modify))\" echo \"\" echo -e \"\\033[36m******************特权用户******************\\033[0m\" RootUser=\"\" for user in $(echo \"$pwdfile\" | awk -F: '{print $1}');do if [ $(id -u $user) -eq 0 ];then echo \"$user\" RootUser=\"$RootUser,$user\" fi done echo \"\" echo -e \"\\033[36m******************用户列表******************\\033[0m\" USERs=0 echo \"$( echo \"用户名 UID GID HOME SHELL 最后一次登录\" for shell in $(grep -v \"/sbin/nologin\" /etc/shells);do for username in $(grep \"$shell\" /etc/passwd| awk -F: '{print $1}');do userLastLogin=\"$(getUserLastLogin $username)\" echo \"$pwdfile\" | grep -w \"$username\" |grep -w \"$shell\"| awk -F: -v lastlogin=\"$(echo \"$userLastLogin\" | tr ' ' '_')\" '{print $1,$3,$4,$6,$7,lastlogin}' done let USERs=USERs+$(echo \"$pwdfile\" | grep \"$shell\"| wc -l) done )\" | column -t echo \"\" echo -e \"\\033[36m******************空密码用户****************\\033[0m\" USEREmptyPassword=\"\" for shell in $(grep -v \"/sbin/nologin\" /etc/shells);do for user in $(echo \"$pwdfile\" | grep \"$shell\" | cut -d: -f1);do r=$(awk -F: '$2==\"!!\"{print $1}' /etc/shadow | grep -w $user) if [ ! -z $r ];then echo $r USEREmptyPassword=\"$USEREmptyPassword,\"$r fi done done echo \"\" echo -e \"\\033[36m*****************相同ID用户*****************\\033[0m\" USERTheSameUID=\"\" UIDs=$(cut -d: -f3 /etc/passwd | sort | uniq -c | awk '$1\u003e1{print $2}') for uid in $UIDs;do echo -n \"$uid\"; USERTheSameUID=\"$uid\" r=$(awk -F: 'ORS=\"\";$3=='\"$uid\"'{print \":\",$1}' /etc/passwd) echo \"$r\" echo \"\" USERTheSameUID=\"$USERTheSameUID $r,\" done } function getPasswordStatus { echo \"\" echo -e \"\\033[33m*************************************************密码检查*******************************************************\\033[0m\" pwdfile=\"$(cat /etc/passwd)\" echo \"\" echo -e \"\\033[36m****************密码过期检查****************\\033[0m\" result=\"\" for shell in $(grep -v \"/sbin/nologin\" /etc/shells);do for user in $(echo \"$pwdfile\" | grep \"$shell\" | cut -d: -f1);do get_expiry_date=$(/usr/bin/chage -l $user | grep 'Password expires' | cut -d: -f2) if [[ $get_expiry_date = ' never' || $get_expiry_date = 'never' ]];then printf \"%-15s 永不过期\\n\" $user result=\"$result,$user:never\" else password_expiry_date=$(date -d \"$get_expiry_date\" \"+%s\") current_date=$(date \"+%s\") diff=$(($password_expiry_date-$current_date)) let DAYS=$(($diff/(60*60*24))) printf \"%-15s %s天后过期\\n\" $user $DAYS result=\"$result,$user:$DAYS days\" fi done done report_PasswordExpiry=$(echo $result | sed 's/^,//') echo \"\" echo -e \"\\033[36m****************密码策略检查****************\\033[0m\" grep -v \"#\" /etc/login.defs | grep -E \"PASS_MAX_DAYS|PASS_MIN_DAYS|PASS_MIN_LEN|PASS_WARN_AGE\" } function getSudoersStatus(){ echo \"\" echo -e \"\\033[33m**********************************************Sudoers检查*******************************************************\\033[0m\" conf=$(grep -v \"^#\" /etc/sudoers| grep -v \"^Defaults\" | sed '/^$/d') echo \"$conf\" echo \"\" } function getInstalledStatus(){ echo \"\" echo -e \"\\033[33m*************************************************软件检查*******************************************************\\033[0m\" rpm -qa --last | head | column -t } function getProcessStatus(){ echo \"\" echo -e \"\\033[33m*************************************************进程检查*******************************************************\\033[0m\" if [ $(ps -ef | grep defunct | grep -v grep | wc -l) -ge 1 ];then echo \"\" echo -e \"\\033[36m***************僵尸进程***************\\033[0m\" ps -ef | head -n1 ps -ef | grep defunct | grep -v grep fi echo \"\" echo -e \"\\033[36m************CPU占用TOP 10进程*************\\033[0m\" echo -e \"用户 进程ID %CPU 命令 $(ps aux | awk '{print $1, $2, $3, $11}' | sort -k3rn | head -n 10 )\"| column -t echo \"\" echo -e \"\\033[36m************内存占用TOP 10进程*************\\033[0m\" echo -e \"用户 进程ID %MEM 虚拟内存 常驻内存 命令 $(ps aux | awk '{print $1, $2, $4, $5, $6, $11}' | sort -k3rn | head -n 10 )\"| column -t #echo \"\" #echo -e \"\\033[36m************SWAP占用TOP 10进程*************\\033[0m\" #awk: fatal: cannot open file `/proc/18713/smaps' for reading (No such file or directory) #for i in `cd /proc;ls |grep \"^[0-9]\"|awk ' $0 \u003e100'`;do awk '{if (-f /proc/$i/smaps) print \"$i file is not exist\"; else print \"$i\"}';done # for i in `cd /proc;ls |grep \"^[0-9]\"|awk ' $0 \u003e100'` ;do awk '/Swap:/{a=a+$2}END{print '\"$i\"',a/1024\"M\"}' /proc/$i/smaps ;done |sort -k2nr \u003e /tmp/swap.txt #echo -e \"进程ID SWAP使用 $(cat /tmp/swap.txt|grep -v awk | head -n 10)\"| column -t } function getSyslogStatus(){ echo \"\" echo -e \"\\033[33m***********************************************syslog检查*******************************************************\\033[0m\" echo \"SYSLOG服务状态：$(getState rsyslog)\" echo \"\" echo -e \"\\033[36m***************rsyslog配置******************\\033[0m\" cat /etc/rsyslog.conf 2\u003e/dev/null | grep -v \"^#\" | grep -v \"^\\\\$\" | sed '/^$/d' | column -t } function getFirewallStatus(){ echo \"\" echo -e \"\\033[33m***********************************************防火墙检查*******************************************************\\033[0m\" echo -e \"\\033[36m****************防火墙状态******************\\033[0m\" if [[ $centosVersion = 7 ]];then systemctl status firewalld \u003e/dev/null 2\u003e\u00261 status=$? if [ $status -eq 0 ];then s=\"active\" elif [ $status -eq 3 ];then s=\"inactive\" elif [ $status -eq 4 ];then s=\"permission denied\" else s=\"unknown\" fi else s=\"$(getState iptables)\" fi echo \"firewalld: $s\" echo \"\" echo -e \"\\033[36m****************防火墙配置******************\\033[0m\" cat /etc/sysconfig/firewalld 2\u003e/dev/null } function getSNMPStatus(){ #SNMP服务状态，配置等 echo \"\" echo -e \"\\033[33m***********************************************SNMP检查*********************************************************\\033[0m\" status=\"$(getState snmpd)\" echo \"SNMP服务状态：$status\" echo \"\" if [ -e /etc/snmp/snmpd.conf ];then echo \"/etc/snmp/snmpd.conf\" echo \"--------------------\" cat /etc/snmp/snmpd.conf 2\u003e/dev/null | grep -v \"^#\" | sed '/^$/d' fi } function getState(){ if [[ $centosVersion \u003c 7 ]];then if [ -e \"/etc/init.d/$1\" ];then if [ `/etc/init.d/$1 status 2\u003e/dev/null | grep -E \"is running|正在运行\" | wc -l` -ge 1 ];then r=\"active\" else r=\"inactive\" fi else r=\"unknown\" fi else #CentOS 7+ r=\"$(systemctl is-active $1 2\u003e\u00261)\" fi echo \"$r\" } function getSSHStatus(){ #SSHD服务状态，配置,受信任主机等 echo \"\" echo -e \"\\033[33m************************************************SSH检查*********************************************************\\033[0m\" #检查受信任主机 pwdfile=\"$(cat /etc/passwd)\" echo \"SSH服务状态：$(getState sshd)\" Protocol_Version=$(cat /etc/ssh/sshd_config | grep Protocol | awk '{print $2}') echo \"SSH协议版本：$Protocol_Version\" echo \"\" echo -e \"\\033[36m****************信任主机******************\\033[0m\" authorized=0 for user in $(echo \"$pwdfile\" | grep /bin/bash | awk -F: '{print $1}');do authorize_file=$(echo \"$pwdfile\" | grep -w $user | awk -F: '{printf $6\"/.ssh/authorized_keys\"}') authorized_host=$(cat $authorize_file 2\u003e/dev/null | awk '{print $3}' | tr '\\n' ',' | sed 's/,$//') if [ ! -z $authorized_host ];then echo \"$user 授权 \\\"$authorized_host\\\" 无密码访问\" fi let authorized=authorized+$(cat $authorize_file 2\u003e/dev/null | awk '{print $3}'|wc -l) done echo \"\" echo -e \"\\033[36m*******是否允许ROOT远程登录***************\\033[0m\" config=$(cat /etc/ssh/sshd_config | grep PermitRootLogin) firstChar=${config:0:1} if [ $firstChar == \"#\" ];then PermitRootLogin=\"yes\" else PermitRootLogin=$(echo $config | awk '{print $2}') fi echo \"PermitRootLogin $PermitRootLogin\" echo \"\" echo -e \"\\033[36m*************ssh服务配置******************\\033[0m\" cat /etc/ssh/sshd_config | grep -v \"^#\" | sed '/^$/d' } function getNTPStatus(){ #NTP服务状态，当前时间，配置等 echo \"\" echo -e \"\\033[33m***********************************************NTP检查**********************************************************\\033[0m\" if [ -e /etc/ntp.conf ];then echo \"NTP服务状态：$(getState ntpd)\" echo \"\" echo -e \"\\033[36m*************NTP服务配置******************\\033[0m\" cat /etc/ntp.conf 2\u003e/dev/null | grep -v \"^#\" | sed '/^$/d' fi } function check(){ version getSystemStatus get_resource getCpuStatus getMemStatus getDiskStatus getNetworkStatus getListenStatus getProcessStatus getServiceStatus getAutoStartStatus getLoginStatus getCronStatus getUserStatus getPasswordStatus getSudoersStatus getFirewallStatus getSSHStatus getSyslogStatus getSNMPStatus getNTPStatus getInstalledStatus } #执行检查并保存检查结果 check \u003e $RESULTFILE echo -e \"\\033[44;37m 主机巡检结果存放在：$RESULTFILE \\033[0m\" #上传检查结果的文件 #curl -F \"filename=@$RESULTFILE\" \"$uploadHostDailyCheckApi\" 2\u003e/dev/null cat $RESULTFILE ","wordCount":"7918","inLanguage":"en","image":"https://image.lvbibir.cn/blog/shell.png","datePublished":"2021-09-01T00:00:00Z","dateModified":"2021-09-01T00:00:00Z","author":{"@type":"Person","name":"lvbibir"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.lvbibir.cn/posts/tech/shell-server-inspection/"},"publisher":{"@type":"Organization","name":"lvbibir's Blog","logo":{"@type":"ImageObject","url":"https://www.lvbibir.cn/img/avatar.gif"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.lvbibir.cn accesskey=h title="lvbibir's Blog (Alt + H)"><img src=https://www.lvbibir.cn/img/avatar.gif alt aria-label=logo height=35>lvbibir's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li class=menu-item><a href=https://www.lvbibir.cn/search title="🔍 搜索 (Alt + /)" accesskey=/><span>🔍 搜索</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/posts title="📚 文章"><span>📚 文章</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/archives title="📈 归档"><span>📈 归档</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/talk title="💬 说说"><span>💬 说说</span></a></li><li class=menu-item><a href=https://www.lvbibir.cn/links title="🤝 友链"><span>🤝 友链</span></a></li></ul></nav></header><main class="main page"><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://www.lvbibir.cn>主页</a>&nbsp;»&nbsp;<a href=https://www.lvbibir.cn/posts/>📚 文章</a>&nbsp;»&nbsp;<a href=https://www.lvbibir.cn/posts/tech/>👨🏻‍💻 技术</a></div><h1 class=post-title>shell | 服务器巡检脚本</h1><div class=post-meta>创建:&nbsp;<span title='2021-09-01 00:00:00 +0000 UTC'>2021-09-01</span>&nbsp;|&nbsp;更新:&nbsp;2021-09-01&nbsp;|&nbsp;字数:&nbsp;7918字&nbsp;|&nbsp;作者:&nbsp;lvbibir
|&nbsp;标签:&nbsp;<ul class=post-tags-meta><a href=https://www.lvbibir.cn/tags/shell/>shell</a>
<a href=https://www.lvbibir.cn/tags/linux/>、linux</a></ul><span id=busuanzi_container_page_pv>&nbsp;|&nbsp;访问:&nbsp;<span id=busuanzi_value_page_pv></span></span></div></header><figure class=entry-cover1><img loading=lazy src=https://image.lvbibir.cn/blog/shell.png alt></figure><div class=post-content><p>代码如下</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#776e71>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#776e71></span><span style=color:#776e71>#参数定义</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>date</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>`</span>date +<span style=color:#48b685>&#34;%Y-%m-%d-%H:%M:%S&#34;</span><span style=color:#48b685>`</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>centosVersion</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>awk <span style=color:#48b685>&#39;{print $(NF-1)}&#39;</span> /etc/redhat-release<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>VERSION</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>`</span>date +%F<span style=color:#48b685>`</span>
</span></span><span style=display:flex><span><span style=color:#776e71>#日志相关</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>LOGPATH</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;/tmp/awr&#34;</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span> -e <span style=color:#ef6155>$LOGPATH</span> <span style=color:#5bc4bf>]</span> <span style=color:#5bc4bf>||</span> mkdir -p <span style=color:#ef6155>$LOGPATH</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>RESULTFILE</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$LOGPATH</span><span style=color:#48b685>/HostCheck-`hostname`-`date +%Y%m%d`.txt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71>#调用函数库</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span> -f /etc/init.d/functions <span style=color:#5bc4bf>]</span> <span style=color:#5bc4bf>&amp;&amp;</span> source /etc/init.d/functions
</span></span><span style=display:flex><span>export <span style=color:#ef6155>PATH</span><span style=color:#5bc4bf>=</span>/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin
</span></span><span style=display:flex><span>source /etc/profile
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71>#root用户执行脚本</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>[</span> <span style=color:#815ba4>$(</span>id -u<span style=color:#815ba4>)</span> -gt <span style=color:#f99b15>0</span> <span style=color:#5bc4bf>]</span> <span style=color:#5bc4bf>&amp;&amp;</span> echo <span style=color:#48b685>&#34;请用root用户执行此脚本！&#34;</span> <span style=color:#5bc4bf>&amp;&amp;</span> exit <span style=color:#f99b15>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> version<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;[</span><span style=color:#f99b15>${</span><span style=color:#ef6155>date</span><span style=color:#f99b15>}</span><span style=color:#48b685>] &gt;&gt;&gt; `hostname -s` 主机巡检&#34;</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getSystemStatus<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[33m****************************************************系统检查****************************************************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[</span> -e /etc/sysconfig/i18n <span style=color:#5bc4bf>]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>        <span style=color:#ef6155>default_LANG</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;</span><span style=color:#815ba4>$(</span>grep <span style=color:#48b685>&#34;LANG=&#34;</span> /etc/sysconfig/i18n | grep -v <span style=color:#48b685>&#34;^#&#34;</span> | awk -F <span style=color:#48b685>&#39;&#34;&#39;</span> <span style=color:#48b685>&#39;{print $2}&#39;</span><span style=color:#815ba4>)</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>else</span>
</span></span><span style=display:flex><span>        <span style=color:#ef6155>default_LANG</span><span style=color:#5bc4bf>=</span><span style=color:#ef6155>$LANG</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>fi</span>
</span></span><span style=display:flex><span>    export <span style=color:#ef6155>LANG</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;en_US.UTF-8&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>Release</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>cat /etc/redhat-release 2&gt;/dev/null<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>Kernel</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>uname -r<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>OS</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>uname -o<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>Hostname</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>uname -n<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>SELinux</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>/usr/sbin/sestatus | grep <span style=color:#48b685>&#34;SELinux status: &#34;</span> | awk <span style=color:#48b685>&#39;{print $3}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>LastReboot</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>who -b | awk <span style=color:#48b685>&#39;{print $3,$4}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>uptime</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>uptime | sed <span style=color:#48b685>&#39;s/.*up \([^,]*\), .*/\1/&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;     系统：</span><span style=color:#ef6155>$OS</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34; 发行版本：</span><span style=color:#ef6155>$Release</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;     内核：</span><span style=color:#ef6155>$Kernel</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;   主机名：</span><span style=color:#ef6155>$Hostname</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;  SELinux：</span><span style=color:#ef6155>$SELinux</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;语言/编码：</span><span style=color:#ef6155>$default_LANG</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34; 当前时间：</span><span style=color:#815ba4>$(</span>date +<span style=color:#48b685>&#39;%F %T&#39;</span><span style=color:#815ba4>)</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34; 最后启动：</span><span style=color:#ef6155>$LastReboot</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34; 运行时间：</span><span style=color:#ef6155>$uptime</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    export <span style=color:#ef6155>LANG</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$default_LANG</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getCpuStatus<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[33m****************************************************CPU检查*****************************************************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>Physical_CPUs</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>grep <span style=color:#48b685>&#34;physical id&#34;</span> /proc/cpuinfo| sort | uniq | wc -l<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>Virt_CPUs</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>grep <span style=color:#48b685>&#34;processor&#34;</span> /proc/cpuinfo | wc -l<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>CPU_Kernels</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>grep <span style=color:#48b685>&#34;cores&#34;</span> /proc/cpuinfo|uniq| awk -F <span style=color:#48b685>&#39;: &#39;</span> <span style=color:#48b685>&#39;{print $2}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>CPU_Type</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>grep <span style=color:#48b685>&#34;model name&#34;</span> /proc/cpuinfo | awk -F <span style=color:#48b685>&#39;: &#39;</span> <span style=color:#48b685>&#39;{print $2}&#39;</span> | sort | uniq<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>CPU_Arch</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>uname -m<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;物理CPU个数:</span><span style=color:#ef6155>$Physical_CPUs</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;逻辑CPU个数:</span><span style=color:#ef6155>$Virt_CPUs</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;每CPU核心数:</span><span style=color:#ef6155>$CPU_Kernels</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;    CPU型号:</span><span style=color:#ef6155>$CPU_Type</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;    CPU架构:</span><span style=color:#ef6155>$CPU_Arch</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getMemStatus<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo  -e <span style=color:#48b685>&#34;\033[33m**************************************************内存检查*****************************************************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[[</span> <span style=color:#ef6155>$centosVersion</span> &lt; <span style=color:#f99b15>7</span> <span style=color:#5bc4bf>]]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>        free -mo
</span></span><span style=display:flex><span>    <span style=color:#815ba4>else</span>
</span></span><span style=display:flex><span>        free -h
</span></span><span style=display:flex><span>    <span style=color:#815ba4>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>#报表信息</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>MemTotal</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>grep MemTotal /proc/meminfo| awk <span style=color:#48b685>&#39;{print $2}&#39;</span><span style=color:#815ba4>)</span>  <span style=color:#776e71>#KB</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>MemFree</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>grep MemFree /proc/meminfo| awk <span style=color:#48b685>&#39;{print $2}&#39;</span><span style=color:#815ba4>)</span>    <span style=color:#776e71>#KB</span>
</span></span><span style=display:flex><span>    let <span style=color:#ef6155>MemUsed</span><span style=color:#5bc4bf>=</span>MemTotal-MemFree
</span></span><span style=display:flex><span>    <span style=color:#ef6155>MemPercent</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>awk <span style=color:#48b685>&#34;BEGIN {if(</span><span style=color:#ef6155>$MemTotal</span><span style=color:#48b685>==0){printf 100}else{printf \&#34;%.2f\&#34;,</span><span style=color:#ef6155>$MemUsed</span><span style=color:#48b685>*100/</span><span style=color:#ef6155>$MemTotal</span><span style=color:#48b685>}}&#34;</span><span style=color:#815ba4>)</span> 
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getDiskStatus<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[33m**************************************************磁盘检查******************************************************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    df -hiP | sed <span style=color:#48b685>&#39;s/Mounted on/Mounted/&#39;</span>&gt; /tmp/inode
</span></span><span style=display:flex><span>    df -hTP | sed <span style=color:#48b685>&#39;s/Mounted on/Mounted/&#39;</span>&gt; /tmp/disk 
</span></span><span style=display:flex><span>    join /tmp/disk /tmp/inode | awk <span style=color:#48b685>&#39;{print $1,$2,&#34;|&#34;,$3,$4,$5,$6,&#34;|&#34;,$8,$9,$10,$11,&#34;|&#34;,$12}&#39;</span>| column -t
</span></span><span style=display:flex><span>    <span style=color:#776e71>#报表信息</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>diskdata</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>df -TP | sed <span style=color:#48b685>&#39;1d&#39;</span> | awk <span style=color:#48b685>&#39;$2!=&#34;tmpfs&#34;{print}&#39;</span><span style=color:#815ba4>)</span> <span style=color:#776e71>#KB</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>disktotal</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$diskdata</span><span style=color:#48b685>&#34;</span> | awk <span style=color:#48b685>&#39;{total+=$3}END{print total}&#39;</span><span style=color:#815ba4>)</span> <span style=color:#776e71>#KB</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>diskused</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$diskdata</span><span style=color:#48b685>&#34;</span> | awk <span style=color:#48b685>&#39;{total+=$4}END{print total}&#39;</span><span style=color:#815ba4>)</span>  <span style=color:#776e71>#KB</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>diskfree</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$((</span>disktotal-diskused<span style=color:#815ba4>))</span> <span style=color:#776e71>#KB</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>diskusedpercent</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>echo <span style=color:#ef6155>$disktotal</span> <span style=color:#ef6155>$diskused</span> | awk <span style=color:#48b685>&#39;{if($1==0){printf 100}else{printf &#34;%.2f&#34;,$2*100/$1}}&#39;</span><span style=color:#815ba4>)</span> 
</span></span><span style=display:flex><span>    <span style=color:#ef6155>inodedata</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>df -iTP | sed <span style=color:#48b685>&#39;1d&#39;</span> | awk <span style=color:#48b685>&#39;$2!=&#34;tmpfs&#34;{print}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>inodetotal</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$inodedata</span><span style=color:#48b685>&#34;</span> | awk <span style=color:#48b685>&#39;{total+=$3}END{print total}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>inodeused</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$inodedata</span><span style=color:#48b685>&#34;</span> | awk <span style=color:#48b685>&#39;{total+=$4}END{print total}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>inodefree</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$((</span>inodetotal-inodeused<span style=color:#815ba4>))</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>inodeusedpercent</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>echo <span style=color:#ef6155>$inodetotal</span> <span style=color:#ef6155>$inodeused</span> | awk <span style=color:#48b685>&#39;{if($1==0){printf 100}else{printf &#34;%.2f&#34;,$2*100/$1}}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> get_resource<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[33m**************************************************资源消耗统计**************************************************\033[0m&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[36m*************带宽资源消耗统计*************\033[0m&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#776e71>#用数组存放网卡名</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>nic</span><span style=color:#5bc4bf>=(</span><span style=color:#48b685>`</span>ifconfig | grep ^<span style=color:#5bc4bf>[</span>a-z<span style=color:#5bc4bf>]</span> | grep -vE <span style=color:#48b685>&#39;lo|docker0&#39;</span>| awk -F: <span style=color:#48b685>&#39;{print $1}&#39;</span><span style=color:#48b685>`</span><span style=color:#5bc4bf>)</span>
</span></span><span style=display:flex><span>	<span style=color:#ef6155>time</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>`</span>date <span style=color:#48b685>&#34;+%Y-%m-%d %k:%M&#34;</span><span style=color:#48b685>`</span>
</span></span><span style=display:flex><span>	<span style=color:#ef6155>num</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>0</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>    <span style=color:#815ba4>for</span> <span style=color:#5bc4bf>((</span><span style=color:#ef6155>i</span><span style=color:#5bc4bf>=</span>0;i&lt;<span style=color:#f99b15>${#</span><span style=color:#ef6155>nic</span>[@]<span style=color:#f99b15>}</span>;i++<span style=color:#5bc4bf>))</span>
</span></span><span style=display:flex><span>	<span style=color:#815ba4>do</span>
</span></span><span style=display:flex><span>	   <span style=color:#776e71>#循环五次，避免看到的是偶然的数据</span>
</span></span><span style=display:flex><span>       <span style=color:#815ba4>while</span> <span style=color:#5bc4bf>((</span> <span style=color:#ef6155>$num</span>&lt;<span style=color:#f99b15>5</span> <span style=color:#5bc4bf>))</span>
</span></span><span style=display:flex><span>	   <span style=color:#815ba4>do</span>
</span></span><span style=display:flex><span>	     <span style=color:#ef6155>rx_before</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>cat /proc/net/dev | grep <span style=color:#48b685>&#39;${nic[$i]}&#39;</span> | tr : <span style=color:#48b685>&#34; &#34;</span> | awk <span style=color:#48b685>&#39;{print $2}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>         <span style=color:#ef6155>tx_before</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>cat /proc/net/dev | grep <span style=color:#48b685>&#39;${nic[$i]}&#39;</span> | tr : <span style=color:#48b685>&#34; &#34;</span> | awk <span style=color:#48b685>&#39;{print $10}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>		 sleep <span style=color:#f99b15>2</span>
</span></span><span style=display:flex><span>		 <span style=color:#776e71>#用sed先获取第7列,再用awk获取第2列，再cut切割,从第7个到最后，即只切割网卡流量数字部分</span>
</span></span><span style=display:flex><span>         <span style=color:#ef6155>rx_after</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>cat /proc/net/dev | grep <span style=color:#48b685>&#39;${nic[$i]}&#39;</span> | tr : <span style=color:#48b685>&#34; &#34;</span> | awk <span style=color:#48b685>&#39;{print $2}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>         <span style=color:#ef6155>tx_after</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>cat /proc/net/dev | grep <span style=color:#48b685>&#39;${nic[$i]}&#39;</span> | tr : <span style=color:#48b685>&#34; &#34;</span> | awk <span style=color:#48b685>&#39;{print $10}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>		 <span style=color:#776e71>#注意下面截取的相差2秒的两个时刻的累计和发送的bytes(即累计传送和接收的位)</span>
</span></span><span style=display:flex><span>         <span style=color:#ef6155>rx_result</span><span style=color:#5bc4bf>=</span>$<span style=color:#5bc4bf>[(</span>rx_after-rx_before<span style=color:#5bc4bf>)</span>/1024/1024/2*8<span style=color:#5bc4bf>]</span>
</span></span><span style=display:flex><span>         <span style=color:#ef6155>tx_result</span><span style=color:#5bc4bf>=</span>$<span style=color:#5bc4bf>[(</span>tx_after-tx_before<span style=color:#5bc4bf>)</span>/1024/1024/2*8<span style=color:#5bc4bf>]</span>
</span></span><span style=display:flex><span>		 echo  <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$time</span><span style=color:#48b685> Now_In_Speed: </span><span style=color:#ef6155>$rx_result</span><span style=color:#48b685> Mbps  Now_OUt_Speed: </span><span style=color:#ef6155>$tx_result</span><span style=color:#48b685> Mbps&#34;</span> &gt;&gt; /tmp/network.txt
</span></span><span style=display:flex><span>		 let <span style=color:#48b685>&#34;num++&#34;</span>
</span></span><span style=display:flex><span>	   <span style=color:#815ba4>done</span>
</span></span><span style=display:flex><span>	   <span style=color:#776e71>#注意下面grep后面的$time变量要用双引号括起来</span>
</span></span><span style=display:flex><span>       <span style=color:#ef6155>rx_result</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>cat /tmp/network.txt|grep <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$time</span><span style=color:#48b685>&#34;</span>|awk <span style=color:#48b685>&#39;{In+=$4}END{print In}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>       <span style=color:#ef6155>tx_result</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>cat /tmp/network.txt|grep <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$time</span><span style=color:#48b685>&#34;</span>|awk <span style=color:#48b685>&#39;{Out+=$7}END{print Out}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>       <span style=color:#ef6155>In_Speed</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>echo <span style=color:#48b685>&#34;scale=2;</span><span style=color:#ef6155>$rx_result</span><span style=color:#48b685>/5&#34;</span>|bc<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>       <span style=color:#ef6155>Out_Speed</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>echo <span style=color:#48b685>&#34;scale=2;</span><span style=color:#ef6155>$tx_result</span><span style=color:#48b685>/5&#34;</span>|bc<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>       echo -e  <span style=color:#48b685>&#34;\033[32m In_Speed_average: </span><span style=color:#ef6155>$In_Speed</span><span style=color:#48b685> Mbps Out_Speed_average: </span><span style=color:#ef6155>$Out_Speed</span><span style=color:#48b685> Mbps! \033[0m&#34;</span> 
</span></span><span style=display:flex><span>	<span style=color:#815ba4>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[36m*************CPU资源消耗统计*************\033[0m&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>#使用vmstat 1 5命令统计5秒内的使用情况，再计算每秒使用情况</span>
</span></span><span style=display:flex><span>	<span style=color:#ef6155>total</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>`</span>vmstat <span style=color:#f99b15>1</span> 5|awk <span style=color:#48b685>&#39;{x+=$13;y+=$14}END{print x+y}&#39;</span><span style=color:#48b685>`</span>
</span></span><span style=display:flex><span>	<span style=color:#ef6155>cpu_average</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>echo <span style=color:#48b685>&#34;scale=2;</span><span style=color:#ef6155>$total</span><span style=color:#48b685>/5&#34;</span>|bc<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#776e71>#判断CPU使用率（浮点数与整数比较）</span>
</span></span><span style=display:flex><span>	<span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[</span> <span style=color:#48b685>`</span>echo <span style=color:#48b685>&#34;</span><span style=color:#f99b15>${</span><span style=color:#ef6155>cpu_average</span><span style=color:#f99b15>}</span><span style=color:#48b685> &gt; 70&#34;</span> | bc<span style=color:#48b685>`</span> -eq <span style=color:#f99b15>1</span> <span style=color:#5bc4bf>]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>	    echo -e  <span style=color:#48b685>&#34;\033[31m Total CPU is already use: </span><span style=color:#f99b15>${</span><span style=color:#ef6155>cpu_average</span><span style=color:#f99b15>}</span><span style=color:#48b685>%,请及时处理！\033[0m&#34;</span> 
</span></span><span style=display:flex><span>    <span style=color:#815ba4>else</span> 
</span></span><span style=display:flex><span>	    echo -e  <span style=color:#48b685>&#34;\033[32m Total CPU is already use: </span><span style=color:#f99b15>${</span><span style=color:#ef6155>cpu_average</span><span style=color:#f99b15>}</span><span style=color:#48b685>%! \033[0m&#34;</span> 
</span></span><span style=display:flex><span>    <span style=color:#815ba4>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[36m*************磁盘资源消耗统计*************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>#磁盘使用情况(注意：需要用sed先进行格式化才能进行累加处理)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>disk_used</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>df -m | sed <span style=color:#48b685>&#39;1d;/ /!N;s/\n//;s/ \+/ /;&#39;</span> | awk <span style=color:#48b685>&#39;{used+=$3} END{print used}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>disk_totalSpace</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>df -m | sed <span style=color:#48b685>&#39;1d;/ /!N;s/\n//;s/ \+/ /;&#39;</span> | awk <span style=color:#48b685>&#39;{totalSpace+=$2} END{print totalSpace}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>disk_all</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>echo <span style=color:#48b685>&#34;scale=4;</span><span style=color:#ef6155>$disk_used</span><span style=color:#48b685>/</span><span style=color:#ef6155>$disk_totalSpace</span><span style=color:#48b685>&#34;</span> | bc<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>disk_percent1</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>echo <span style=color:#ef6155>$disk_all</span> | cut -c 2-3<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>disk_percent2</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>echo <span style=color:#ef6155>$disk_all</span> | cut -c 4-5<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>disk_warning</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>`</span>df -m | sed <span style=color:#48b685>&#39;1d;/ /!N;s/\n//;s/ \+/ /;&#39;</span> | awk <span style=color:#48b685>&#39;{if ($5&gt;85) print $6 &#34;目录使用率：&#34; $5;} &#39;</span><span style=color:#48b685>`</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>	echo -e  <span style=color:#48b685>&#34;\033[32m Total disk has used: </span><span style=color:#ef6155>$disk_percent1</span><span style=color:#48b685>.</span><span style=color:#ef6155>$disk_percent2</span><span style=color:#48b685>% \033[0m&#34;</span> 
</span></span><span style=display:flex><span>    <span style=color:#776e71>#echo -e &#34;\t\t..&#34; 表示换行</span>
</span></span><span style=display:flex><span>	<span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[</span> -n  <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$disk_warning</span><span style=color:#48b685>&#34;</span> <span style=color:#5bc4bf>]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>	    echo -e <span style=color:#48b685>&#34;\033[31m</span><span style=color:#f99b15>${</span><span style=color:#ef6155>disk_warning</span><span style=color:#f99b15>}</span><span style=color:#48b685> \n [Error]以上目录使用率超过85%，请及时处理！\033[0m&#34;</span> 
</span></span><span style=display:flex><span>	<span style=color:#815ba4>fi</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[36m*************内存资源消耗统计*************\033[0m&#34;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>    <span style=color:#776e71>#获得系统总内存</span>
</span></span><span style=display:flex><span>	<span style=color:#ef6155>memery_all</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>free -m | awk <span style=color:#48b685>&#39;NR==2&#39;</span> | awk <span style=color:#48b685>&#39;{print $2}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>	<span style=color:#776e71>#获得占用内存（操作系统 角度）</span>
</span></span><span style=display:flex><span>	<span style=color:#ef6155>system_memery_used</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>free -m | awk <span style=color:#48b685>&#39;NR==2&#39;</span> | awk <span style=color:#48b685>&#39;{print $3}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>	<span style=color:#776e71>#获得buffer、cache占用内存，当内存不够时会及时回收，所以这两部分可用于可用内存的计算</span>
</span></span><span style=display:flex><span>	<span style=color:#ef6155>buffer_used</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>free -m | awk <span style=color:#48b685>&#39;NR==2&#39;</span> | awk <span style=color:#48b685>&#39;{print $6}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>	<span style=color:#ef6155>cache_used</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>free -m | awk <span style=color:#48b685>&#39;NR==2&#39;</span> | awk <span style=color:#48b685>&#39;{print $7}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>	<span style=color:#776e71>#获得被使用内存，所以这部分可用于可用内存的计算，注意计算方法</span>
</span></span><span style=display:flex><span>	<span style=color:#ef6155>actual_used_all</span><span style=color:#5bc4bf>=</span>$<span style=color:#5bc4bf>[</span>memery_all-<span style=color:#5bc4bf>(</span>free+buffer_used+cache_used<span style=color:#5bc4bf>)]</span>
</span></span><span style=display:flex><span>	<span style=color:#776e71>#获得实际占用的内存</span>
</span></span><span style=display:flex><span>	<span style=color:#ef6155>actual_used_all</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>`</span>expr <span style=color:#ef6155>$memery_all</span> - <span style=color:#ef6155>$free</span> + <span style=color:#ef6155>$buffer_used</span> + <span style=color:#ef6155>$cache_used</span> <span style=color:#48b685>`</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>memery_percent</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>echo <span style=color:#48b685>&#34;scale=4;</span><span style=color:#ef6155>$system_memery_used</span><span style=color:#48b685> / </span><span style=color:#ef6155>$memery_all</span><span style=color:#48b685>&#34;</span> | bc<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>memery_percent2</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>echo <span style=color:#48b685>&#34;scale=4; </span><span style=color:#ef6155>$actual_used_all</span><span style=color:#48b685> / </span><span style=color:#ef6155>$memery_all</span><span style=color:#48b685>&#34;</span> | bc<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>percent_part1</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>echo <span style=color:#ef6155>$memery_percent</span> | cut -c 2-3<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>percent_part2</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>echo <span style=color:#ef6155>$memery_percent</span> | cut -c 4-5<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>percent_part11</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>echo <span style=color:#ef6155>$memery_percent2</span> | cut -c 2-3<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>percent_part22</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>echo <span style=color:#ef6155>$memery_percent2</span> | cut -c 4-5<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>	<span style=color:#776e71>#获得占用内存（操作系统角度）</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[32m system memery is already use: </span><span style=color:#ef6155>$percent_part1</span><span style=color:#48b685>.</span><span style=color:#ef6155>$percent_part2</span><span style=color:#48b685>% \033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>#获得实际内存占用率</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[32m actual memery is already use: </span><span style=color:#ef6155>$percent_part11</span><span style=color:#48b685>.</span><span style=color:#ef6155>$percent_part22</span><span style=color:#48b685>% \033[0m&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[32m buffer is already used : </span><span style=color:#ef6155>$buffer_used</span><span style=color:#48b685> M \033[0m&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[32m cache is already used : </span><span style=color:#ef6155>$cache_used</span><span style=color:#48b685> M \033[0m&#34;</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getServiceStatus<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[33m*************************************************服务检查*******************************************************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[[</span> <span style=color:#ef6155>$centosVersion</span> &gt; <span style=color:#f99b15>7</span> <span style=color:#5bc4bf>]]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>        <span style=color:#ef6155>conf</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>systemctl list-unit-files --type<span style=color:#5bc4bf>=</span>service --state<span style=color:#5bc4bf>=</span>enabled --no-pager | grep <span style=color:#48b685>&#34;enabled&#34;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ef6155>process</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>systemctl list-units --type<span style=color:#5bc4bf>=</span>service --state<span style=color:#5bc4bf>=</span>running --no-pager | grep <span style=color:#48b685>&#34;.service&#34;</span><span style=color:#815ba4>)</span>      
</span></span><span style=display:flex><span>    <span style=color:#815ba4>else</span>
</span></span><span style=display:flex><span>        <span style=color:#ef6155>conf</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>/sbin/chkconfig | grep -E <span style=color:#48b685>&#34;:on|:启用&#34;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ef6155>process</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>/sbin/service --status-all 2&gt;/dev/null | grep -E <span style=color:#48b685>&#34;is running|正在运行&#34;</span><span style=color:#815ba4>)</span>        
</span></span><span style=display:flex><span>    <span style=color:#815ba4>fi</span>
</span></span><span style=display:flex><span>	echo -e <span style=color:#48b685>&#34;\033[36m******************服务配置******************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$conf</span><span style=color:#48b685>&#34;</span>  | column -t
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>	echo -e <span style=color:#48b685>&#34;\033[36m**************正在运行的服务****************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$process</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getAutoStartStatus<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[33m***********************************************自启动检查*******************************************************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[36m****************自启动命令*****************\033[0m&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#ef6155>conf</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>grep -v <span style=color:#48b685>&#34;^#&#34;</span> /etc/rc.d/rc.local| sed <span style=color:#48b685>&#39;/^$/d&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$conf</span><span style=color:#48b685>&#34;</span>  
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getLoginStatus<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[33m************************************************登录检查********************************************************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    last | head 
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getNetworkStatus<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[33m************************************************网络检查********************************************************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[[</span> <span style=color:#ef6155>$centosVersion</span> &lt; <span style=color:#f99b15>7</span> <span style=color:#5bc4bf>]]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>        /sbin/ifconfig -a | grep -v packets | grep -v collisions | grep -v i
</span></span><span style=display:flex><span>		net6
</span></span><span style=display:flex><span>    <span style=color:#815ba4>else</span>
</span></span><span style=display:flex><span>        <span style=color:#776e71>#ip a</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>for</span> i in <span style=color:#815ba4>$(</span>ip link | grep BROADCAST | awk -F: <span style=color:#48b685>&#39;{print $2}&#39;</span><span style=color:#815ba4>)</span>;<span style=color:#815ba4>do</span> ip add show <span style=color:#ef6155>$i</span> | grep -E <span style=color:#48b685>&#34;BROADCAST|global&#34;</span>| awk <span style=color:#48b685>&#39;{print $2}&#39;</span> | tr <span style=color:#48b685>&#39;\n&#39;</span> <span style=color:#48b685>&#39; &#39;</span> ;echo <span style=color:#48b685>&#34;&#34;</span> ;<span style=color:#815ba4>done</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>GATEWAY</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>ip route | grep default | awk <span style=color:#48b685>&#39;{print $3}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>DNS</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>grep nameserver /etc/resolv.conf| grep -v <span style=color:#48b685>&#34;#&#34;</span> | awk <span style=color:#48b685>&#39;{print $2}&#39;</span> | tr <span style=color:#48b685>&#39;\n&#39;</span> <span style=color:#48b685>&#39;,&#39;</span> | sed <span style=color:#48b685>&#39;s/,$//&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;网关：</span><span style=color:#ef6155>$GATEWAY</span><span style=color:#48b685> &#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;DNS：</span><span style=color:#ef6155>$DNS</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>#报表信息</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>IP</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>ip -f inet addr | grep -v 127.0.0.1 |  grep inet | awk <span style=color:#48b685>&#39;{print $NF,$2}&#39;</span> | tr <span style=color:#48b685>&#39;\n&#39;</span> <span style=color:#48b685>&#39;,&#39;</span> | sed <span style=color:#48b685>&#39;s/,$//&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>MAC</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>ip link | grep -v <span style=color:#48b685>&#34;LOOPBACK\|loopback&#34;</span> | awk <span style=color:#48b685>&#39;{print $2}&#39;</span> | sed <span style=color:#48b685>&#39;N;s/\n//&#39;</span> | tr <span style=color:#48b685>&#39;\n&#39;</span> <span style=color:#48b685>&#39;,&#39;</span> | sed <span style=color:#48b685>&#39;s/,$//&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>ping -c <span style=color:#f99b15>4</span> www.baidu.com &gt;/dev/null 2&gt;&amp;<span style=color:#f99b15>1</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[</span> <span style=color:#ef6155>$?</span> -eq <span style=color:#f99b15>0</span> <span style=color:#5bc4bf>]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>   echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>   echo -e <span style=color:#48b685>&#34;\033[32m网络连接：正常！\033[0m&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#815ba4>else</span>
</span></span><span style=display:flex><span>   echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>   echo -e <span style=color:#48b685>&#34;\033[31m网络连接：异常！\033[0m&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#815ba4>fi</span> 
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getListenStatus<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo  -e <span style=color:#48b685>&#34;\033[33m***********************************************监听检查********************************************************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>TCPListen</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>ss -ntul | column -t<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$TCPListen</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getCronStatus<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[33m**********************************************计划任务检查******************************************************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>Crontab</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>0</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>for</span> shell in <span style=color:#815ba4>$(</span>grep -v <span style=color:#48b685>&#34;/sbin/nologin&#34;</span> /etc/shells<span style=color:#815ba4>)</span>;<span style=color:#815ba4>do</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>for</span> user in <span style=color:#815ba4>$(</span>grep <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$shell</span><span style=color:#48b685>&#34;</span> /etc/passwd| awk -F: <span style=color:#48b685>&#39;{print $1}&#39;</span><span style=color:#815ba4>)</span>;<span style=color:#815ba4>do</span>
</span></span><span style=display:flex><span>            crontab -l -u <span style=color:#ef6155>$user</span> &gt;/dev/null 2&gt;&amp;<span style=color:#f99b15>1</span>
</span></span><span style=display:flex><span>            <span style=color:#ef6155>status</span><span style=color:#5bc4bf>=</span><span style=color:#ef6155>$?</span>
</span></span><span style=display:flex><span>            <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[</span> <span style=color:#ef6155>$status</span> -eq <span style=color:#f99b15>0</span> <span style=color:#5bc4bf>]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>                echo -e <span style=color:#48b685>&#34;\033[36m************</span><span style=color:#ef6155>$user</span><span style=color:#48b685>用户的定时任务**************\033[0m&#34;</span>
</span></span><span style=display:flex><span>                crontab -l -u <span style=color:#ef6155>$user</span>
</span></span><span style=display:flex><span>                let <span style=color:#ef6155>Crontab</span><span style=color:#5bc4bf>=</span>Crontab+<span style=color:#815ba4>$(</span>crontab -l -u <span style=color:#ef6155>$user</span> | wc -l<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>                echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#815ba4>fi</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>done</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>done</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>#计划任务</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>#find /etc/cron* -type f | xargs -i ls -l {} | column  -t</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>#let Crontab=Crontab+$(find /etc/cron* -type f | wc -l) </span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getHowLongAgo<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71># 计算一个时间戳离现在有多久了</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>datetime</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$*</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>[</span> -z <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$datetime</span><span style=color:#48b685>&#34;</span> <span style=color:#5bc4bf>]</span> <span style=color:#5bc4bf>&amp;&amp;</span> echo <span style=color:#48b685>`</span>stat /etc/passwd|awk <span style=color:#48b685>&#34;NR==6&#34;</span><span style=color:#48b685>`</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>Timestamp</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>date +%s -d <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$datetime</span><span style=color:#48b685>&#34;</span><span style=color:#815ba4>)</span>  
</span></span><span style=display:flex><span>    <span style=color:#ef6155>Now_Timestamp</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>date +%s<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>Difference_Timestamp</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$((</span><span style=color:#ef6155>$Now_Timestamp</span><span style=color:#5bc4bf>-</span><span style=color:#ef6155>$Timestamp</span><span style=color:#815ba4>))</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>days</span><span style=color:#5bc4bf>=</span>0;<span style=color:#ef6155>hours</span><span style=color:#5bc4bf>=</span>0;<span style=color:#ef6155>minutes</span><span style=color:#5bc4bf>=</span>0;
</span></span><span style=display:flex><span>    <span style=color:#ef6155>sec_in_day</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$((</span><span style=color:#f99b15>60</span><span style=color:#5bc4bf>*</span><span style=color:#f99b15>60</span><span style=color:#5bc4bf>*</span><span style=color:#f99b15>24</span><span style=color:#815ba4>))</span>;
</span></span><span style=display:flex><span>    <span style=color:#ef6155>sec_in_hour</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$((</span><span style=color:#f99b15>60</span><span style=color:#5bc4bf>*</span><span style=color:#f99b15>60</span><span style=color:#815ba4>))</span>;
</span></span><span style=display:flex><span>    <span style=color:#ef6155>sec_in_minute</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>60</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>while</span> <span style=color:#5bc4bf>((</span> <span style=color:#815ba4>$((</span><span style=color:#ef6155>$Difference_Timestamp</span><span style=color:#5bc4bf>-</span><span style=color:#ef6155>$sec_in_day</span><span style=color:#815ba4>))</span> &gt; <span style=color:#f99b15>1</span> <span style=color:#5bc4bf>))</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>do</span>
</span></span><span style=display:flex><span>        let <span style=color:#ef6155>Difference_Timestamp</span><span style=color:#5bc4bf>=</span>Difference_Timestamp-sec_in_day
</span></span><span style=display:flex><span>        let days++
</span></span><span style=display:flex><span>    <span style=color:#815ba4>done</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>while</span> <span style=color:#5bc4bf>((</span> <span style=color:#815ba4>$((</span><span style=color:#ef6155>$Difference_Timestamp</span><span style=color:#5bc4bf>-</span><span style=color:#ef6155>$sec_in_hour</span><span style=color:#815ba4>))</span> &gt; <span style=color:#f99b15>1</span> <span style=color:#5bc4bf>))</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>do</span>
</span></span><span style=display:flex><span>        let <span style=color:#ef6155>Difference_Timestamp</span><span style=color:#5bc4bf>=</span>Difference_Timestamp-sec_in_hour
</span></span><span style=display:flex><span>        let hours++
</span></span><span style=display:flex><span>    <span style=color:#815ba4>done</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$days</span><span style=color:#48b685> 天 </span><span style=color:#ef6155>$hours</span><span style=color:#48b685> 小时前&#34;</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getUserLastLogin<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71># 获取用户最近一次登录的时间，含年份</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71># 很遗憾last命令不支持显示年份，只有&#34;last -t YYYYMMDDHHMMSS&#34;表示某个时间之间的登录，我</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71># 们只能用最笨的方法了，对比今天之前和今年元旦之前（或者去年之前和前年之前……）某个用户</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71># 登录次数，如果登录统计次数有变化，则说明最近一次登录是今年。</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>username</span><span style=color:#5bc4bf>=</span><span style=color:#ef6155>$1</span>
</span></span><span style=display:flex><span>    : <span style=color:#f99b15>${</span><span style=color:#ef6155>username</span>:=<span style=color:#48b685>&#34;`whoami`&#34;</span><span style=color:#f99b15>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>thisYear</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>date +%Y<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>oldesYear</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>last | tail -n1 | awk <span style=color:#48b685>&#39;{print $NF}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>while</span><span style=color:#5bc4bf>((</span> <span style=color:#ef6155>$thisYear</span> &gt;<span style=color:#5bc4bf>=</span> <span style=color:#ef6155>$oldesYear</span><span style=color:#5bc4bf>))</span>;<span style=color:#815ba4>do</span>
</span></span><span style=display:flex><span>        <span style=color:#ef6155>loginBeforeToday</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>last <span style=color:#ef6155>$username</span> | grep <span style=color:#ef6155>$username</span> | wc -l<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ef6155>loginBeforeNewYearsDayOfThisYear</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>last <span style=color:#ef6155>$username</span> -t <span style=color:#ef6155>$thisYear</span><span style=color:#48b685>&#34;0101000000&#34;</span> | grep <span style=color:#ef6155>$username</span> | wc -l<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[</span> <span style=color:#ef6155>$loginBeforeToday</span> -eq <span style=color:#f99b15>0</span> <span style=color:#5bc4bf>]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>            echo <span style=color:#48b685>&#34;从未登录过&#34;</span>
</span></span><span style=display:flex><span>            break
</span></span><span style=display:flex><span>        <span style=color:#815ba4>elif</span> <span style=color:#5bc4bf>[</span> <span style=color:#ef6155>$loginBeforeToday</span> -gt <span style=color:#ef6155>$loginBeforeNewYearsDayOfThisYear</span> <span style=color:#5bc4bf>]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>            <span style=color:#ef6155>lastDateTime</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>last -i <span style=color:#ef6155>$username</span> | head -n1 | awk <span style=color:#48b685>&#39;{for(i=4;i&lt;(NF-2);i++)printf&#34;%s &#34;,$i}&#39;</span><span style=color:#815ba4>)</span><span style=color:#48b685>&#34; </span><span style=color:#ef6155>$thisYear</span><span style=color:#48b685>&#34;</span> 
</span></span><span style=display:flex><span>            <span style=color:#ef6155>lastDateTime</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>date <span style=color:#48b685>&#34;+%Y-%m-%d %H:%M:%S&#34;</span> -d <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$lastDateTime</span><span style=color:#48b685>&#34;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>            echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$lastDateTime</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>            break
</span></span><span style=display:flex><span>        <span style=color:#815ba4>else</span>
</span></span><span style=display:flex><span>            <span style=color:#ef6155>thisYear</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$((</span>thisYear-1<span style=color:#815ba4>))</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>done</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getUserStatus<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[33m*************************************************用户检查*******************************************************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>#/etc/passwd 最后修改时间</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>pwdfile</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;</span><span style=color:#815ba4>$(</span>cat /etc/passwd<span style=color:#815ba4>)</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>Modify</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>stat /etc/passwd | grep Modify | tr <span style=color:#48b685>&#39;.&#39;</span> <span style=color:#48b685>&#39; &#39;</span> | awk <span style=color:#48b685>&#39;{print $2,$3}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;/etc/passwd: </span><span style=color:#ef6155>$Modify</span><span style=color:#48b685> (</span><span style=color:#815ba4>$(</span>getHowLongAgo <span style=color:#ef6155>$Modify</span><span style=color:#815ba4>)</span><span style=color:#48b685>)&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[36m******************特权用户******************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>RootUser</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>for</span> user in <span style=color:#815ba4>$(</span>echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$pwdfile</span><span style=color:#48b685>&#34;</span> | awk -F: <span style=color:#48b685>&#39;{print $1}&#39;</span><span style=color:#815ba4>)</span>;<span style=color:#815ba4>do</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[</span> <span style=color:#815ba4>$(</span>id -u <span style=color:#ef6155>$user</span><span style=color:#815ba4>)</span> -eq <span style=color:#f99b15>0</span> <span style=color:#5bc4bf>]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>            echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$user</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#ef6155>RootUser</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$RootUser</span><span style=color:#48b685>,</span><span style=color:#ef6155>$user</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>done</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>	echo -e <span style=color:#48b685>&#34;\033[36m******************用户列表******************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>USERs</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>0</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;</span><span style=color:#815ba4>$(</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;用户名 UID GID HOME SHELL 最后一次登录&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>for</span> shell in <span style=color:#815ba4>$(</span>grep -v <span style=color:#48b685>&#34;/sbin/nologin&#34;</span> /etc/shells<span style=color:#815ba4>)</span>;<span style=color:#815ba4>do</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>for</span> username in <span style=color:#815ba4>$(</span>grep <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$shell</span><span style=color:#48b685>&#34;</span> /etc/passwd| awk -F: <span style=color:#48b685>&#39;{print $1}&#39;</span><span style=color:#815ba4>)</span>;<span style=color:#815ba4>do</span>
</span></span><span style=display:flex><span>            <span style=color:#ef6155>userLastLogin</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;</span><span style=color:#815ba4>$(</span>getUserLastLogin <span style=color:#ef6155>$username</span><span style=color:#815ba4>)</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>            echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$pwdfile</span><span style=color:#48b685>&#34;</span> | grep -w <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$username</span><span style=color:#48b685>&#34;</span> |grep -w <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$shell</span><span style=color:#48b685>&#34;</span>| awk -F: -v <span style=color:#ef6155>lastlogin</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;</span><span style=color:#815ba4>$(</span>echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$userLastLogin</span><span style=color:#48b685>&#34;</span> | tr <span style=color:#48b685>&#39; &#39;</span> <span style=color:#48b685>&#39;_&#39;</span><span style=color:#815ba4>)</span><span style=color:#48b685>&#34;</span> <span style=color:#48b685>&#39;{print $1,$3,$4,$6,$7,lastlogin}&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>done</span>
</span></span><span style=display:flex><span>        let <span style=color:#ef6155>USERs</span><span style=color:#5bc4bf>=</span>USERs+<span style=color:#815ba4>$(</span>echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$pwdfile</span><span style=color:#48b685>&#34;</span> | grep <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$shell</span><span style=color:#48b685>&#34;</span>| wc -l<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>done</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>)</span><span style=color:#48b685>&#34;</span> | column -t
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>	echo -e <span style=color:#48b685>&#34;\033[36m******************空密码用户****************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>USEREmptyPassword</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>for</span> shell in <span style=color:#815ba4>$(</span>grep -v <span style=color:#48b685>&#34;/sbin/nologin&#34;</span> /etc/shells<span style=color:#815ba4>)</span>;<span style=color:#815ba4>do</span>
</span></span><span style=display:flex><span>            <span style=color:#815ba4>for</span> user in <span style=color:#815ba4>$(</span>echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$pwdfile</span><span style=color:#48b685>&#34;</span> | grep <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$shell</span><span style=color:#48b685>&#34;</span> | cut -d: -f1<span style=color:#815ba4>)</span>;<span style=color:#815ba4>do</span>
</span></span><span style=display:flex><span>            <span style=color:#ef6155>r</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>awk -F: <span style=color:#48b685>&#39;$2==&#34;!!&#34;{print $1}&#39;</span> /etc/shadow | grep -w <span style=color:#ef6155>$user</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>            <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[</span> ! -z <span style=color:#ef6155>$r</span> <span style=color:#5bc4bf>]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>                echo <span style=color:#ef6155>$r</span>
</span></span><span style=display:flex><span>                <span style=color:#ef6155>USEREmptyPassword</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$USEREmptyPassword</span><span style=color:#48b685>,&#34;</span><span style=color:#ef6155>$r</span>
</span></span><span style=display:flex><span>            <span style=color:#815ba4>fi</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>done</span>    
</span></span><span style=display:flex><span>    <span style=color:#815ba4>done</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>	echo -e <span style=color:#48b685>&#34;\033[36m*****************相同ID用户*****************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>USERTheSameUID</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>UIDs</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>cut -d: -f3 /etc/passwd | sort | uniq -c | awk <span style=color:#48b685>&#39;$1&gt;1{print $2}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>for</span> uid in <span style=color:#ef6155>$UIDs</span>;<span style=color:#815ba4>do</span>
</span></span><span style=display:flex><span>        echo -n <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$uid</span><span style=color:#48b685>&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#ef6155>USERTheSameUID</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$uid</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ef6155>r</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>awk -F: <span style=color:#48b685>&#39;ORS=&#34;&#34;;$3==&#39;</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$uid</span><span style=color:#48b685>&#34;</span><span style=color:#48b685>&#39;{print &#34;:&#34;,$1}&#39;</span> /etc/passwd<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>        echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$r</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ef6155>USERTheSameUID</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$USERTheSameUID</span><span style=color:#48b685> </span><span style=color:#ef6155>$r</span><span style=color:#48b685>,&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>done</span> 
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getPasswordStatus <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[33m*************************************************密码检查*******************************************************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>pwdfile</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;</span><span style=color:#815ba4>$(</span>cat /etc/passwd<span style=color:#815ba4>)</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[36m****************密码过期检查****************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>result</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>for</span> shell in <span style=color:#815ba4>$(</span>grep -v <span style=color:#48b685>&#34;/sbin/nologin&#34;</span> /etc/shells<span style=color:#815ba4>)</span>;<span style=color:#815ba4>do</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>for</span> user in <span style=color:#815ba4>$(</span>echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$pwdfile</span><span style=color:#48b685>&#34;</span> | grep <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$shell</span><span style=color:#48b685>&#34;</span> | cut -d: -f1<span style=color:#815ba4>)</span>;<span style=color:#815ba4>do</span>
</span></span><span style=display:flex><span>            <span style=color:#ef6155>get_expiry_date</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>/usr/bin/chage -l <span style=color:#ef6155>$user</span> | grep <span style=color:#48b685>&#39;Password expires&#39;</span> | cut -d: -f2<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>            <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[[</span> <span style=color:#ef6155>$get_expiry_date</span> <span style=color:#5bc4bf>=</span> <span style=color:#48b685>&#39; never&#39;</span> <span style=color:#5bc4bf>||</span> <span style=color:#ef6155>$get_expiry_date</span> <span style=color:#5bc4bf>=</span> <span style=color:#48b685>&#39;never&#39;</span> <span style=color:#5bc4bf>]]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>                printf <span style=color:#48b685>&#34;%-15s 永不过期\n&#34;</span> <span style=color:#ef6155>$user</span>
</span></span><span style=display:flex><span>                <span style=color:#ef6155>result</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$result</span><span style=color:#48b685>,</span><span style=color:#ef6155>$user</span><span style=color:#48b685>:never&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#815ba4>else</span>
</span></span><span style=display:flex><span>                <span style=color:#ef6155>password_expiry_date</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>date -d <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$get_expiry_date</span><span style=color:#48b685>&#34;</span> <span style=color:#48b685>&#34;+%s&#34;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>                <span style=color:#ef6155>current_date</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>date <span style=color:#48b685>&#34;+%s&#34;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>                <span style=color:#ef6155>diff</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$((</span><span style=color:#ef6155>$password_expiry_date</span><span style=color:#5bc4bf>-</span><span style=color:#ef6155>$current_date</span><span style=color:#815ba4>))</span>
</span></span><span style=display:flex><span>                let <span style=color:#ef6155>DAYS</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$((</span><span style=color:#ef6155>$diff</span><span style=color:#5bc4bf>/(</span><span style=color:#f99b15>60</span><span style=color:#5bc4bf>*</span><span style=color:#f99b15>60</span><span style=color:#5bc4bf>*</span><span style=color:#f99b15>24</span><span style=color:#815ba4>))</span><span style=color:#5bc4bf>)</span>
</span></span><span style=display:flex><span>                printf <span style=color:#48b685>&#34;%-15s %s天后过期\n&#34;</span> <span style=color:#ef6155>$user</span> <span style=color:#ef6155>$DAYS</span>
</span></span><span style=display:flex><span>                <span style=color:#ef6155>result</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$result</span><span style=color:#48b685>,</span><span style=color:#ef6155>$user</span><span style=color:#48b685>:</span><span style=color:#ef6155>$DAYS</span><span style=color:#48b685> days&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#815ba4>fi</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>done</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>done</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>report_PasswordExpiry</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>echo <span style=color:#ef6155>$result</span> | sed <span style=color:#48b685>&#39;s/^,//&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>	echo -e <span style=color:#48b685>&#34;\033[36m****************密码策略检查****************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    grep -v <span style=color:#48b685>&#34;#&#34;</span> /etc/login.defs | grep -E <span style=color:#48b685>&#34;PASS_MAX_DAYS|PASS_MIN_DAYS|PASS_MIN_LEN|PASS_WARN_AGE&#34;</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getSudoersStatus<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[33m**********************************************Sudoers检查*******************************************************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>conf</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>grep -v <span style=color:#48b685>&#34;^#&#34;</span> /etc/sudoers| grep -v <span style=color:#48b685>&#34;^Defaults&#34;</span> | sed <span style=color:#48b685>&#39;/^$/d&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$conf</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getInstalledStatus<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[33m*************************************************软件检查*******************************************************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    rpm -qa --last | head | column -t 
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getProcessStatus<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[33m*************************************************进程检查*******************************************************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[</span> <span style=color:#815ba4>$(</span>ps -ef | grep defunct | grep -v grep | wc -l<span style=color:#815ba4>)</span> -ge <span style=color:#f99b15>1</span> <span style=color:#5bc4bf>]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>        echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>        echo -e <span style=color:#48b685>&#34;\033[36m***************僵尸进程***************\033[0m&#34;</span>
</span></span><span style=display:flex><span>        ps -ef | head -n1
</span></span><span style=display:flex><span>        ps -ef | grep defunct | grep -v grep
</span></span><span style=display:flex><span>    <span style=color:#815ba4>fi</span>
</span></span><span style=display:flex><span>	echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[36m************CPU占用TOP 10进程*************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;用户 进程ID %CPU 命令 
</span></span></span><span style=display:flex><span><span style=color:#48b685>	</span><span style=color:#815ba4>$(</span>ps aux | awk <span style=color:#48b685>&#39;{print $1, $2, $3, $11}&#39;</span> | sort -k3rn | head -n <span style=color:#f99b15>10</span> <span style=color:#815ba4>)</span><span style=color:#48b685>&#34;</span>| column -t 
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[36m************内存占用TOP 10进程*************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;用户 进程ID %MEM 虚拟内存  常驻内存 命令 
</span></span></span><span style=display:flex><span><span style=color:#48b685>	</span><span style=color:#815ba4>$(</span>ps aux | awk <span style=color:#48b685>&#39;{print $1, $2, $4, $5, $6, $11}&#39;</span> | sort -k3rn | head -n <span style=color:#f99b15>10</span> <span style=color:#815ba4>)</span><span style=color:#48b685>&#34;</span>| column -t 
</span></span><span style=display:flex><span>	<span style=color:#776e71>#echo &#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>#echo -e &#34;\033[36m************SWAP占用TOP 10进程*************\033[0m&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#776e71>#awk: fatal: cannot open file `/proc/18713/smaps&#39; for reading (No such file or directory)</span>
</span></span><span style=display:flex><span>	<span style=color:#776e71>#for i in `cd /proc;ls |grep &#34;^[0-9]&#34;|awk &#39; $0 &gt;100&#39;`;do awk &#39;{if (-f /proc/$i/smaps) print &#34;$i file is not exist&#34;; else print &#34;$i&#34;}&#39;;done</span>
</span></span><span style=display:flex><span>	<span style=color:#776e71>#    for i in `cd /proc;ls |grep &#34;^[0-9]&#34;|awk &#39; $0 &gt;100&#39;` ;do awk &#39;/Swap:/{a=a+$2}END{print &#39;&#34;$i&#34;&#39;,a/1024&#34;M&#34;}&#39; /proc/$i/smaps ;done |sort -k2nr &gt; /tmp/swap.txt</span>
</span></span><span style=display:flex><span>	<span style=color:#776e71>#echo -e &#34;进程ID SWAP使用 $(cat /tmp/swap.txt|grep -v awk | head -n 10)&#34;| column -t</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getSyslogStatus<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[33m***********************************************syslog检查*******************************************************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;SYSLOG服务状态：</span><span style=color:#815ba4>$(</span>getState rsyslog<span style=color:#815ba4>)</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[36m***************rsyslog配置******************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    cat /etc/rsyslog.conf 2&gt;/dev/null | grep -v <span style=color:#48b685>&#34;^#&#34;</span> | grep -v <span style=color:#48b685>&#34;^\\</span>$<span style=color:#48b685>&#34;</span> | sed <span style=color:#48b685>&#39;/^$/d&#39;</span>  | column -t
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getFirewallStatus<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[33m***********************************************防火墙检查*******************************************************\033[0m&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[36m****************防火墙状态******************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[[</span> <span style=color:#ef6155>$centosVersion</span> <span style=color:#5bc4bf>=</span> <span style=color:#f99b15>7</span> <span style=color:#5bc4bf>]]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>        systemctl status firewalld &gt;/dev/null  2&gt;&amp;<span style=color:#f99b15>1</span>
</span></span><span style=display:flex><span>        <span style=color:#ef6155>status</span><span style=color:#5bc4bf>=</span><span style=color:#ef6155>$?</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[</span> <span style=color:#ef6155>$status</span> -eq <span style=color:#f99b15>0</span> <span style=color:#5bc4bf>]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>                <span style=color:#ef6155>s</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;active&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>elif</span> <span style=color:#5bc4bf>[</span> <span style=color:#ef6155>$status</span> -eq <span style=color:#f99b15>3</span> <span style=color:#5bc4bf>]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>                <span style=color:#ef6155>s</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;inactive&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>elif</span> <span style=color:#5bc4bf>[</span> <span style=color:#ef6155>$status</span> -eq <span style=color:#f99b15>4</span> <span style=color:#5bc4bf>]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>                <span style=color:#ef6155>s</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;permission denied&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>else</span>
</span></span><span style=display:flex><span>                <span style=color:#ef6155>s</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;unknown&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>else</span>
</span></span><span style=display:flex><span>        <span style=color:#ef6155>s</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;</span><span style=color:#815ba4>$(</span>getState iptables<span style=color:#815ba4>)</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>fi</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;firewalld: </span><span style=color:#ef6155>$s</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[36m****************防火墙配置******************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    cat /etc/sysconfig/firewalld 2&gt;/dev/null
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getSNMPStatus<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>#SNMP服务状态，配置等</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[33m***********************************************SNMP检查*********************************************************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>status</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;</span><span style=color:#815ba4>$(</span>getState snmpd<span style=color:#815ba4>)</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;SNMP服务状态：</span><span style=color:#ef6155>$status</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[</span> -e /etc/snmp/snmpd.conf <span style=color:#5bc4bf>]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>        echo <span style=color:#48b685>&#34;/etc/snmp/snmpd.conf&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#48b685>&#34;--------------------&#34;</span>
</span></span><span style=display:flex><span>        cat /etc/snmp/snmpd.conf 2&gt;/dev/null | grep -v <span style=color:#48b685>&#34;^#&#34;</span> | sed <span style=color:#48b685>&#39;/^$/d&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>fi</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getState<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[[</span> <span style=color:#ef6155>$centosVersion</span> &lt; <span style=color:#f99b15>7</span> <span style=color:#5bc4bf>]]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[</span> -e <span style=color:#48b685>&#34;/etc/init.d/</span><span style=color:#ef6155>$1</span><span style=color:#48b685>&#34;</span> <span style=color:#5bc4bf>]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>            <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[</span> <span style=color:#48b685>`</span>/etc/init.d/<span style=color:#ef6155>$1</span> status 2&gt;/dev/null | grep -E <span style=color:#48b685>&#34;is running|正在运行&#34;</span> | wc -l<span style=color:#48b685>`</span> -ge <span style=color:#f99b15>1</span> <span style=color:#5bc4bf>]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>                <span style=color:#ef6155>r</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;active&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#815ba4>else</span>
</span></span><span style=display:flex><span>                <span style=color:#ef6155>r</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;inactive&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#815ba4>fi</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>else</span>
</span></span><span style=display:flex><span>            <span style=color:#ef6155>r</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;unknown&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>else</span>
</span></span><span style=display:flex><span>        <span style=color:#776e71>#CentOS 7+</span>
</span></span><span style=display:flex><span>        <span style=color:#ef6155>r</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;</span><span style=color:#815ba4>$(</span>systemctl is-active <span style=color:#ef6155>$1</span> 2&gt;&amp;1<span style=color:#815ba4>)</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>fi</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$r</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getSSHStatus<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>#SSHD服务状态，配置,受信任主机等</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[33m************************************************SSH检查*********************************************************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>#检查受信任主机</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>pwdfile</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;</span><span style=color:#815ba4>$(</span>cat /etc/passwd<span style=color:#815ba4>)</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;SSH服务状态：</span><span style=color:#815ba4>$(</span>getState sshd<span style=color:#815ba4>)</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>Protocol_Version</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>cat /etc/ssh/sshd_config | grep Protocol | awk <span style=color:#48b685>&#39;{print $2}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;SSH协议版本：</span><span style=color:#ef6155>$Protocol_Version</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[36m****************信任主机******************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>authorized</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>0</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>for</span> user in <span style=color:#815ba4>$(</span>echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$pwdfile</span><span style=color:#48b685>&#34;</span> | grep /bin/bash | awk -F: <span style=color:#48b685>&#39;{print $1}&#39;</span><span style=color:#815ba4>)</span>;<span style=color:#815ba4>do</span>
</span></span><span style=display:flex><span>        <span style=color:#ef6155>authorize_file</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$pwdfile</span><span style=color:#48b685>&#34;</span> | grep -w <span style=color:#ef6155>$user</span> | awk -F: <span style=color:#48b685>&#39;{printf $6&#34;/.ssh/authorized_keys&#34;}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ef6155>authorized_host</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>cat <span style=color:#ef6155>$authorize_file</span> 2&gt;/dev/null | awk <span style=color:#48b685>&#39;{print $3}&#39;</span> | tr <span style=color:#48b685>&#39;\n&#39;</span> <span style=color:#48b685>&#39;,&#39;</span> | sed <span style=color:#48b685>&#39;s/,$//&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[</span> ! -z <span style=color:#ef6155>$authorized_host</span> <span style=color:#5bc4bf>]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>            echo <span style=color:#48b685>&#34;</span><span style=color:#ef6155>$user</span><span style=color:#48b685> 授权 \&#34;</span><span style=color:#ef6155>$authorized_host</span><span style=color:#48b685>\&#34; 无密码访问&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>fi</span>
</span></span><span style=display:flex><span>        let <span style=color:#ef6155>authorized</span><span style=color:#5bc4bf>=</span>authorized+<span style=color:#815ba4>$(</span>cat <span style=color:#ef6155>$authorize_file</span> 2&gt;/dev/null | awk <span style=color:#48b685>&#39;{print $3}&#39;</span>|wc -l<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>done</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[36m*******是否允许ROOT远程登录***************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>config</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>cat /etc/ssh/sshd_config | grep PermitRootLogin<span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ef6155>firstChar</span><span style=color:#5bc4bf>=</span><span style=color:#f99b15>${</span><span style=color:#ef6155>config</span>:<span style=color:#ef6155>0</span>:<span style=color:#ef6155>1</span><span style=color:#f99b15>}</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[</span> <span style=color:#ef6155>$firstChar</span> <span style=color:#5bc4bf>==</span> <span style=color:#48b685>&#34;#&#34;</span> <span style=color:#5bc4bf>]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>        <span style=color:#ef6155>PermitRootLogin</span><span style=color:#5bc4bf>=</span><span style=color:#48b685>&#34;yes&#34;</span> 
</span></span><span style=display:flex><span>    <span style=color:#815ba4>else</span>
</span></span><span style=display:flex><span>        <span style=color:#ef6155>PermitRootLogin</span><span style=color:#5bc4bf>=</span><span style=color:#815ba4>$(</span>echo <span style=color:#ef6155>$config</span> | awk <span style=color:#48b685>&#39;{print $2}&#39;</span><span style=color:#815ba4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>fi</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;PermitRootLogin </span><span style=color:#ef6155>$PermitRootLogin</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[36m*************ssh服务配置******************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    cat /etc/ssh/sshd_config | grep -v <span style=color:#48b685>&#34;^#&#34;</span> | sed <span style=color:#48b685>&#39;/^$/d&#39;</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> getNTPStatus<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>#NTP服务状态，当前时间，配置等</span>
</span></span><span style=display:flex><span>    echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>    echo -e <span style=color:#48b685>&#34;\033[33m***********************************************NTP检查**********************************************************\033[0m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>[</span> -e /etc/ntp.conf <span style=color:#5bc4bf>]</span>;<span style=color:#815ba4>then</span>
</span></span><span style=display:flex><span>        echo <span style=color:#48b685>&#34;NTP服务状态：</span><span style=color:#815ba4>$(</span>getState ntpd<span style=color:#815ba4>)</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>        echo -e <span style=color:#48b685>&#34;\033[36m*************NTP服务配置******************\033[0m&#34;</span>
</span></span><span style=display:flex><span>        cat /etc/ntp.conf 2&gt;/dev/null | grep -v <span style=color:#48b685>&#34;^#&#34;</span> | sed <span style=color:#48b685>&#39;/^$/d&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>fi</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>function</span> check<span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>    version
</span></span><span style=display:flex><span>    getSystemStatus
</span></span><span style=display:flex><span>	get_resource
</span></span><span style=display:flex><span>    getCpuStatus
</span></span><span style=display:flex><span>    getMemStatus
</span></span><span style=display:flex><span>    getDiskStatus
</span></span><span style=display:flex><span>    getNetworkStatus
</span></span><span style=display:flex><span>    getListenStatus
</span></span><span style=display:flex><span>    getProcessStatus
</span></span><span style=display:flex><span>    getServiceStatus
</span></span><span style=display:flex><span>    getAutoStartStatus
</span></span><span style=display:flex><span>    getLoginStatus
</span></span><span style=display:flex><span>    getCronStatus
</span></span><span style=display:flex><span>    getUserStatus
</span></span><span style=display:flex><span>    getPasswordStatus
</span></span><span style=display:flex><span>    getSudoersStatus
</span></span><span style=display:flex><span>    getFirewallStatus
</span></span><span style=display:flex><span>    getSSHStatus
</span></span><span style=display:flex><span>    getSyslogStatus
</span></span><span style=display:flex><span>    getSNMPStatus
</span></span><span style=display:flex><span>    getNTPStatus
</span></span><span style=display:flex><span>    getInstalledStatus
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span><span style=color:#776e71>#执行检查并保存检查结果</span>
</span></span><span style=display:flex><span>check &gt; <span style=color:#ef6155>$RESULTFILE</span>
</span></span><span style=display:flex><span>echo -e <span style=color:#48b685>&#34;\033[44;37m 主机巡检结果存放在：</span><span style=color:#ef6155>$RESULTFILE</span><span style=color:#48b685>   \033[0m&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71>#上传检查结果的文件</span>
</span></span><span style=display:flex><span><span style=color:#776e71>#curl -F &#34;filename=@$RESULTFILE&#34; &#34;$uploadHostDailyCheckApi&#34; 2&gt;/dev/null</span>
</span></span><span style=display:flex><span>cat <span style=color:#ef6155>$RESULTFILE</span>
</span></span></code></pre></div></div><div class=post-reward><div style=padding:0;margin:0;width:100%;font-size:16px;text-align:center><div id=QR style=opacity:0><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=https://www.lvbibir.cn/img/wechat_pay.png alt=wechat_pay></a><p>微信</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=https://www.lvbibir.cn/img/alipay.png alt=alipay></a><p>支付宝</p></div></div><button id=rewardButton onclick='var qr=document.getElementById("QR");qr.style.opacity==="0"?qr.style.opacity="1":qr.style.opacity="0"'>
<span>🧧 鼓励</span></button></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://www.lvbibir.cn/posts/tech/rpm-build-openssh/><span class=title>« 上一页</span><br><span>openssh源码打包编译成rpm包</span></a>
<a class=next href=https://www.lvbibir.cn/posts/tech/record-of-program-test/><span class=title>下一页 »</span><br><span>记一次程序测试</span></a></nav></footer></div><div><div class=pagination__title><span class=pagination__title-h style=font-size:20px>💬评论</span><hr></div><div id=tcomment></div><script src=https://cdn.staticfile.org/twikoo/1.6.15/twikoo.all.min.js></script><script>twikoo.init({envId:"https://twikoo.lvbibir.cn/",el:"#tcomment",lang:"zh-CN",path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><a href=https://gohugo.io/ target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/frame-hugo-blue.svg></a>
<a href=https://github.com/adityatelange/hugo-PaperMod target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/theme-papermod-lightgrey.svg></a>
<a href=https://cn.aliyun.com/ target=_blank><img style=display:unset src=https://image.lvbibir.cn/blog/图床-阿里云-orange.svg></a><br><span id=runtime_span></span>
<script type=text/javascript>function show_runtime(){window.setTimeout("show_runtime()",1e3),X=new Date("7/13/2021 1:00:00"),Y=new Date,T=Y.getTime()-X.getTime(),M=24*60*60*1e3,a=T/M,A=Math.floor(a),b=(a-A)*24,B=Math.floor(b),c=(b-B)*60,C=Math.floor((b-B)*60),D=Math.floor((c-C)*60),runtime_span.innerHTML="网站已运行"+A+"天"+B+"小时"+C+"分"+D+"秒"}show_runtime()</script>|
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span id=busuanzi_container>总访客数: <span id=busuanzi_value_site_uv></span>
|
总访问量: <span id=busuanzi_value_site_pv></span></span><br><a href=https://beian.miit.gov.cn/ target=_blank style="border-bottom:1px solid">京ICP备2021023168号-1</a>&nbsp;
|
<span>Copyright
&copy;
2020-2023
<a href=https://www.lvbibir.cn style="border-bottom:1px solid">lvbibir's Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg><span id=read_progress></span></span></a>
<script>document.addEventListener("scroll",function(){const t=document.getElementById("read_progress"),n=document.documentElement.scrollHeight,s=document.documentElement.clientHeight,o=document.documentElement.scrollTop||document.body.scrollTop;t.innerText=((o/(n-s)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>400||document.documentElement.scrollTop>400?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="📄复制";function s(){t.innerText="👌🏻已复制!",setTimeout(()=>{t.innerText="📄复制"},2e3)}t.addEventListener("click",t=>{const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild===n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName==="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>